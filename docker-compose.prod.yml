# üîí PRODUCTION Docker Compose Configuration - Self-Contained (embedded MariaDB)
# ‚ö†Ô∏è WICHTIG: Vor Produktion-Deployment:
# 1. √Ñndern Sie MYSQL_PASSWORD via Environment Variable (oder leer lassen f√ºr auto-generiert)
# 2. Verwenden Sie HTTPS mit Reverse Proxy (Nginx/Traefik)
# 3. Deaktivieren Sie Debug-Mode
# 4. Beschr√§nken Sie Port-Zugriff mit Firewall

services:
  # Little ISMS Helper Application (Self-Contained with embedded MariaDB)
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      platforms:
        - linux/amd64
        - linux/arm64
    container_name: isms-app-prod
    restart: always
    # ‚úÖ Security: Nur App-Ports √∂ffentlich (HTTP & HTTPS)
    # Defaults: Port 80 und 443 - kann via APP_PORT/APP_PORT_HTTPS √ºberschrieben werden
    ports:
      - "${APP_PORT:-80}:80"
      - "${APP_PORT_HTTPS:-443}:443"
    volumes:
      # ‚úÖ REQUIRED: Persistente Daten (inkl. embedded MariaDB)
      # Ohne dieses Volume gehen alle Daten bei Container-Neustart verloren!
      - isms_data:/var/www/html/var
    environment:
      # ‚ö†Ô∏è WICHTIG: Diese m√ºssen in .env.docker.local gesetzt werden!
      APP_ENV: prod
      APP_DEBUG: 0
      # MySQL Credentials (leer lassen f√ºr auto-generiertes Passwort)
      MYSQL_DATABASE: ${MYSQL_DATABASE:-isms}
      MYSQL_USER: ${MYSQL_USER:-isms}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-}
      # MAILER_DSN muss f√ºr echte SMTP konfiguriert werden
      MAILER_DSN: ${MAILER_DSN:-}
      # Docker-Flag (f√ºr Setup-Wizard Detection)
      DOCKER_CONTAINER: "1"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Security: Resource Limits
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=application,environment=production"

volumes:
  # ‚úÖ Production Volumes - persistent und performant
  # REQUIRED: Enth√§lt App-Daten UND embedded MariaDB!
  isms_data:
    driver: local
