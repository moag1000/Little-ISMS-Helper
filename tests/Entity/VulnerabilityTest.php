<?php

namespace App\Tests\Entity;

use App\Entity\Vulnerability;
use App\Entity\Asset;
use App\Entity\Patch;
use PHPUnit\Framework\TestCase;

class VulnerabilityTest extends TestCase
{
    public function testNewVulnerabilityHasDefaultValues(): void
    {
        $vulnerability = new Vulnerability();

        $this->assertNull($vulnerability->getId());
        $this->assertNull($vulnerability->getCveId());
        $this->assertNull($vulnerability->getTitle());
        $this->assertNull($vulnerability->getDescription());
        $this->assertNull($vulnerability->getSeverity());
        $this->assertNull($vulnerability->getCvssScore());
        $this->assertNull($vulnerability->getCvssVector());
        $this->assertEquals('nist', $vulnerability->getSource());
        $this->assertCount(0, $vulnerability->getAffectedAssets());
        $this->assertEquals('open', $vulnerability->getStatus());
        $this->assertInstanceOf(\DateTimeImmutable::class, $vulnerability->getDiscoveredDate());
        $this->assertNull($vulnerability->getPublishedDate());
        $this->assertNull($vulnerability->getRemediationDeadline());
        $this->assertNull($vulnerability->getRemediatedDate());
        $this->assertNull($vulnerability->getResponsiblePerson());
        $this->assertNull($vulnerability->getRemediationNotes());
        $this->assertEquals('none', $vulnerability->getExploitAvailability());
        $this->assertFalse($vulnerability->isActivelyExploited());
        $this->assertEquals([], $vulnerability->getReferences());
        $this->assertCount(0, $vulnerability->getPatches());
        $this->assertEquals([], $vulnerability->getCweIds());
        $this->assertEquals([], $vulnerability->getAffectedProducts());
        $this->assertInstanceOf(\DateTimeImmutable::class, $vulnerability->getCreatedAt());
        $this->assertNull($vulnerability->getUpdatedAt());
    }

    public function testSetAndGetCveId(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setCveId('CVE-2024-1234');

        $this->assertEquals('CVE-2024-1234', $vulnerability->getCveId());
    }

    public function testSetAndGetTitle(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setTitle('Remote Code Execution in Apache Log4j');

        $this->assertEquals('Remote Code Execution in Apache Log4j', $vulnerability->getTitle());
    }

    public function testSetAndGetDescription(): void
    {
        $vulnerability = new Vulnerability();
        $description = 'Apache Log4j2 <=2.14.1 JNDI features used in configuration do not protect against attacker controlled LDAP';

        $vulnerability->setDescription($description);

        $this->assertEquals($description, $vulnerability->getDescription());
    }

    public function testSetCvssScoreAutoCalculatesSeverityCritical(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setCvssScore('10.0');

        $this->assertEquals('10.0', $vulnerability->getCvssScore());
        $this->assertEquals('critical', $vulnerability->getSeverity());
    }

    public function testSetCvssScoreAutoCalculatesSeverityHigh(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setCvssScore('8.5');

        $this->assertEquals('8.5', $vulnerability->getCvssScore());
        $this->assertEquals('high', $vulnerability->getSeverity());
    }

    public function testSetCvssScoreAutoCalculatesSeverityMedium(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setCvssScore('5.0');

        $this->assertEquals('5.0', $vulnerability->getCvssScore());
        $this->assertEquals('medium', $vulnerability->getSeverity());
    }

    public function testSetCvssScoreAutoCalculatesSeverityLow(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setCvssScore('2.5');

        $this->assertEquals('2.5', $vulnerability->getCvssScore());
        $this->assertEquals('low', $vulnerability->getSeverity());
    }

    public function testSetCvssScoreAutoCalculatesSeverityNone(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setCvssScore('0.0');

        $this->assertEquals('0.0', $vulnerability->getCvssScore());
        $this->assertEquals('none', $vulnerability->getSeverity());
    }

    public function testSetAndGetCvssVector(): void
    {
        $vulnerability = new Vulnerability();
        $vector = 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H';

        $vulnerability->setCvssVector($vector);

        $this->assertEquals($vector, $vulnerability->getCvssVector());
    }

    public function testSetAndGetSource(): void
    {
        $vulnerability = new Vulnerability();

        $vulnerability->setSource('internal');
        $this->assertEquals('internal', $vulnerability->getSource());

        $vulnerability->setSource('pentest');
        $this->assertEquals('pentest', $vulnerability->getSource());
    }

    public function testAddAndRemoveAffectedAsset(): void
    {
        $vulnerability = new Vulnerability();
        $asset = new Asset();
        $asset->setName('Web Server');

        $vulnerability->addAffectedAsset($asset);
        $this->assertCount(1, $vulnerability->getAffectedAssets());
        $this->assertTrue($vulnerability->getAffectedAssets()->contains($asset));

        $vulnerability->removeAffectedAsset($asset);
        $this->assertCount(0, $vulnerability->getAffectedAssets());
    }

    public function testAddAffectedAssetDoesNotDuplicate(): void
    {
        $vulnerability = new Vulnerability();
        $asset = new Asset();
        $asset->setName('Application Server');

        $vulnerability->addAffectedAsset($asset);
        $vulnerability->addAffectedAsset($asset);

        $this->assertCount(1, $vulnerability->getAffectedAssets());
    }

    public function testSetAndGetStatus(): void
    {
        $vulnerability = new Vulnerability();

        $vulnerability->setStatus('patched');
        $this->assertEquals('patched', $vulnerability->getStatus());

        $vulnerability->setStatus('mitigated');
        $this->assertEquals('mitigated', $vulnerability->getStatus());

        $vulnerability->setStatus('closed');
        $this->assertEquals('closed', $vulnerability->getStatus());
    }

    public function testSetAndGetDates(): void
    {
        $vulnerability = new Vulnerability();
        $discovered = new \DateTimeImmutable('2024-01-15');
        $published = new \DateTimeImmutable('2024-01-20');
        $deadline = new \DateTimeImmutable('2024-01-23');
        $remediated = new \DateTimeImmutable('2024-01-22');

        $vulnerability->setDiscoveredDate($discovered);
        $vulnerability->setPublishedDate($published);
        $vulnerability->setRemediationDeadline($deadline);
        $vulnerability->setRemediatedDate($remediated);

        $this->assertEquals($discovered, $vulnerability->getDiscoveredDate());
        $this->assertEquals($published, $vulnerability->getPublishedDate());
        $this->assertEquals($deadline, $vulnerability->getRemediationDeadline());
        $this->assertEquals($remediated, $vulnerability->getRemediatedDate());
    }

    public function testSetAndGetResponsiblePerson(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setResponsiblePerson('Security Team Lead');

        $this->assertEquals('Security Team Lead', $vulnerability->getResponsiblePerson());
    }

    public function testSetAndGetExploitAvailability(): void
    {
        $vulnerability = new Vulnerability();

        $vulnerability->setExploitAvailability('poc');
        $this->assertEquals('poc', $vulnerability->getExploitAvailability());

        $vulnerability->setExploitAvailability('weaponized');
        $this->assertEquals('weaponized', $vulnerability->getExploitAvailability());
    }

    public function testSetAndGetActivelyExploited(): void
    {
        $vulnerability = new Vulnerability();

        $vulnerability->setActivelyExploited(true);
        $this->assertTrue($vulnerability->isActivelyExploited());

        $vulnerability->setActivelyExploited(false);
        $this->assertFalse($vulnerability->isActivelyExploited());
    }

    public function testSetAndGetReferences(): void
    {
        $vulnerability = new Vulnerability();
        $references = [
            'https://nvd.nist.gov/vuln/detail/CVE-2024-1234',
            'https://security.apache.org/advisories'
        ];

        $vulnerability->setReferences($references);

        $this->assertEquals($references, $vulnerability->getReferences());
    }

    public function testAddReferenceDoesNotDuplicate(): void
    {
        $vulnerability = new Vulnerability();
        $ref = 'https://nvd.nist.gov/vuln/detail/CVE-2024-1234';

        $vulnerability->addReference($ref);
        $vulnerability->addReference($ref);

        $this->assertCount(1, $vulnerability->getReferences());
    }

    public function testAddAndRemovePatch(): void
    {
        $vulnerability = new Vulnerability();
        $patch = new Patch();

        $vulnerability->addPatch($patch);
        $this->assertCount(1, $vulnerability->getPatches());
        $this->assertSame($vulnerability, $patch->getVulnerability());

        $vulnerability->removePatch($patch);
        $this->assertCount(0, $vulnerability->getPatches());
    }

    public function testSetAndGetCweIds(): void
    {
        $vulnerability = new Vulnerability();
        $cweIds = ['CWE-502', 'CWE-20'];

        $vulnerability->setCweIds($cweIds);

        $this->assertEquals($cweIds, $vulnerability->getCweIds());
    }

    public function testSetAndGetAffectedProducts(): void
    {
        $vulnerability = new Vulnerability();
        $products = ['Apache Log4j 2.0-2.14.1', 'Apache Log4j 2.15.0'];

        $vulnerability->setAffectedProducts($products);

        $this->assertEquals($products, $vulnerability->getAffectedProducts());
    }

    public function testIsOverdueReturnsFalseWhenNoDeadline(): void
    {
        $vulnerability = new Vulnerability();

        $this->assertFalse($vulnerability->isOverdue());
    }

    public function testIsOverdueReturnsFalseWhenClosed(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setRemediationDeadline(new \DateTimeImmutable('-1 day'));
        $vulnerability->setStatus('closed');

        $this->assertFalse($vulnerability->isOverdue());
    }

    public function testIsOverdueReturnsTrueWhenPastDeadline(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setRemediationDeadline(new \DateTimeImmutable('-1 day'));
        $vulnerability->setStatus('open');

        $this->assertTrue($vulnerability->isOverdue());
    }

    public function testIsOverdueReturnsFalseWhenDeadlineInFuture(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setRemediationDeadline(new \DateTimeImmutable('+7 days'));
        $vulnerability->setStatus('open');

        $this->assertFalse($vulnerability->isOverdue());
    }

    public function testGetSeverityBadgeClassReturnsCorrectClasses(): void
    {
        $vulnerability = new Vulnerability();

        $vulnerability->setCvssScore('10.0'); // critical
        $this->assertEquals('danger', $vulnerability->getSeverityBadgeClass());

        $vulnerability->setCvssScore('8.0'); // high
        $this->assertEquals('warning', $vulnerability->getSeverityBadgeClass());

        $vulnerability->setCvssScore('5.0'); // medium
        $this->assertEquals('info', $vulnerability->getSeverityBadgeClass());

        $vulnerability->setCvssScore('2.0'); // low
        $this->assertEquals('secondary', $vulnerability->getSeverityBadgeClass());
    }

    public function testCalculateRemediationDeadlineForCritical(): void
    {
        $vulnerability = new Vulnerability();
        $discovered = new \DateTimeImmutable('2024-01-01');
        $vulnerability->setDiscoveredDate($discovered);
        $vulnerability->setCvssScore('10.0'); // critical

        $deadline = $vulnerability->calculateRemediationDeadline();

        $this->assertEquals('2024-01-04', $deadline->format('Y-m-d')); // +3 days
    }

    public function testCalculateRemediationDeadlineForHigh(): void
    {
        $vulnerability = new Vulnerability();
        $discovered = new \DateTimeImmutable('2024-01-01');
        $vulnerability->setDiscoveredDate($discovered);
        $vulnerability->setCvssScore('8.0'); // high

        $deadline = $vulnerability->calculateRemediationDeadline();

        $this->assertEquals('2024-01-08', $deadline->format('Y-m-d')); // +7 days
    }

    public function testCalculateRemediationDeadlineForMedium(): void
    {
        $vulnerability = new Vulnerability();
        $discovered = new \DateTimeImmutable('2024-01-01');
        $vulnerability->setDiscoveredDate($discovered);
        $vulnerability->setCvssScore('5.0'); // medium

        $deadline = $vulnerability->calculateRemediationDeadline();

        $this->assertEquals('2024-01-31', $deadline->format('Y-m-d')); // +30 days
    }

    public function testCalculateRemediationDeadlineForLow(): void
    {
        $vulnerability = new Vulnerability();
        $discovered = new \DateTimeImmutable('2024-01-01');
        $vulnerability->setDiscoveredDate($discovered);
        $vulnerability->setCvssScore('2.0'); // low

        $deadline = $vulnerability->calculateRemediationDeadline();

        $this->assertEquals('2024-04-01', $deadline->format('Y-m-d')); // +90 days
    }

    public function testGetDaysUntilDeadlineReturnsNullWhenNoDeadline(): void
    {
        $vulnerability = new Vulnerability();

        $this->assertNull($vulnerability->getDaysUntilDeadline());
    }

    public function testGetDaysUntilDeadlineReturnsPositiveWhenInFuture(): void
    {
        $vulnerability = new Vulnerability();
        $deadline = new \DateTimeImmutable('+7 days');
        $vulnerability->setRemediationDeadline($deadline);

        $days = $vulnerability->getDaysUntilDeadline();

        $this->assertGreaterThanOrEqual(6, $days);
        $this->assertLessThanOrEqual(7, $days);
    }

    public function testGetDaysUntilDeadlineReturnsNegativeWhenPastDue(): void
    {
        $vulnerability = new Vulnerability();
        $deadline = new \DateTimeImmutable('-5 days');
        $vulnerability->setRemediationDeadline($deadline);

        $days = $vulnerability->getDaysUntilDeadline();

        $this->assertLessThanOrEqual(-4, $days);
        $this->assertGreaterThanOrEqual(-5, $days);
    }
}
