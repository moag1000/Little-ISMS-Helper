{# Form Field Component - Bootstrap 5.3 Floating Labels with WCAG 2.1 AA compliance #}

{% set field_id = field.vars.id %}
{% set field_name = field.vars.full_name %}
{% set has_errors = field.vars.errors|length > 0 %}
{% set is_required = required|default(field.vars.required) %}
{% set field_type = field.vars.block_prefixes[1]|default('text') %}

{# Support both new (label_key) and old (label) parameters for backward compatibility #}
{% set trans_domain = translation_domain|default('messages') %}
{% set label_text = label_key is defined ? (label_key|trans({}, trans_domain)) : (label|default('')) %}
{% set help_text = help_key is defined ? (help_key|trans({}, trans_domain)) : (help|default(null)) %}

{# Floating labels work for: text, email, password, number, textarea, select #}
{% set supports_floating = field_type in ['text', 'email', 'password', 'number', 'tel', 'url', 'search', 'textarea', 'choice'] %}

<div class="mb-3">
    {% if supports_floating %}
        {# Bootstrap Floating Label wrapper #}
        <div class="form-floating">
            {# Input MUST come before label for floating effect #}
            {# Use label_text (translated) as placeholder, override any existing placeholder #}
            {% set placeholder_text = label_text %}
            {% set merged_attrs = field.vars.attr|merge({
                'class': (field.vars.attr.class|default('') ~ (has_errors ? ' is-invalid' : ''))|trim,
                'placeholder': placeholder_text,
                'aria-invalid': has_errors ? 'true' : 'false',
                'aria-describedby': [
                    help_text ? field_id ~ '_help',
                    has_errors ? field_id ~ '_error'
                ]|filter(v => v)|join(' ')|default(null),
                'aria-required': is_required ? 'true' : 'false'
            }) %}
            {{ form_widget(field, {
                'attr': merged_attrs
            }) }}

            {# Label comes AFTER input for floating labels #}
            <label for="{{ field_id }}">
                {{ label_text }}
                {% if is_required %}
                    <span class="required" aria-label="{{ 'form.required'|trans({}, 'messages') }}">*</span>
                {% endif %}
            </label>
        </div>
    {% else %}
        {# Fallback for non-floating fields (checkbox, radio, file, hidden) #}
        <label for="{{ field_id }}" class="form-label">
            {{ label_text }}
            {% if is_required %}
                <span class="required" aria-label="{{ 'form.required'|trans({}, 'messages') }}">*</span>
            {% endif %}
        </label>

        {{ form_widget(field, {
            'attr': {
                'class': (field.vars.attr.class|default('') ~ (has_errors ? ' is-invalid' : ''))|trim,
                'aria-invalid': has_errors ? 'true' : 'false',
                'aria-describedby': [
                    help is defined and help ? field_id ~ '_help',
                    has_errors ? field_id ~ '_error'
                ]|filter(v => v)|join(' ')|default(null),
                'aria-required': is_required ? 'true' : 'false'
            }
        }) }}
    {% endif %}

    {# Help text (positioned below input) #}
    {% if help_text %}
        <div id="{{ field_id }}_help" class="form-text">
            <i class="bi bi-info-circle" aria-hidden="true"></i>
            {{ help_text }}
        </div>
    {% endif %}

    {# Error messages with ARIA live region #}
    {% if has_errors %}
        <div id="{{ field_id }}_error" class="invalid-feedback d-block" role="alert" aria-live="assertive">
            <i class="bi bi-exclamation-circle-fill" aria-hidden="true"></i>
            {% for error in field.vars.errors %}
                {{ error.message }}{% if not loop.last %}<br>{% endif %}
            {% endfor %}
        </div>
    {% endif %}
</div>
