{#
    Accessible Form Field Component with Bootstrap Floating Labels

    This component provides WCAG 2.1 AA compliant form field rendering with:
    - Bootstrap 5.3 Floating Labels (modern UX)
    - Proper ARIA attributes (aria-invalid, aria-describedby, aria-required)
    - Error message association
    - Help text association
    - Clear visual and programmatic error states

    Usage:
        {% include '_components/_form_field.html.twig' with {
            'field': form.fieldName,
            'label': 'form.label.fieldName'|trans({}, 'messages'),
            'help': 'form.help.fieldName'|trans({}, 'messages'),
            'required': true
        } %}

    IMPORTANT: When using with field.vars.label, DO NOT translate again:
        {% include '_components/_form_field.html.twig' with {
            'field': form.fieldName,
            'label': form.fieldName.vars.label,  {# Already translated by Symfony #}
            'required': form.fieldName.vars.required
        } %}

    @param field               FormView  The form field to render
    @param label_key           string    Translation key for the label (e.g., 'supplier.field.name')
    @param help_key            string    Optional translation key for help text
    @param translation_domain  string    Translation domain (default: 'messages')
    @param required            boolean   Whether the field is required
    @param type                string    Input type override (default: from field)

    BACKWARD COMPATIBILITY:
    @param label               string    Deprecated: Use label_key instead
    @param help                string    Deprecated: Use help_key instead
#}

{% set field_id = field.vars.id %}
{% set field_name = field.vars.full_name %}
{% set has_errors = field.vars.errors|length > 0 %}
{% set is_required = required|default(field.vars.required) %}
{% set field_type = field.vars.block_prefixes[1]|default('text') %}

{# Support both new (label_key) and old (label) parameters for backward compatibility #}
{% set trans_domain = translation_domain|default('messages') %}
{% set label_text = label_key is defined ? (label_key|trans({}, trans_domain)) : (label|default('')) %}
{% set help_text = help_key is defined ? (help_key|trans({}, trans_domain)) : (help|default(null)) %}

{# Floating labels work for: text, email, password, number, textarea, select #}
{% set supports_floating = field_type in ['text', 'email', 'password', 'number', 'tel', 'url', 'search', 'textarea', 'choice'] %}

<div class="mb-3">
    {% if supports_floating %}
        {# Bootstrap Floating Label wrapper #}
        <div class="form-floating">
            {# Input MUST come before label for floating effect #}
            {% set placeholder_text = label_text %}
            {{ form_widget(field, {
                'attr': {
                    'class': (field.vars.attr.class|default('') ~ (has_errors ? ' is-invalid' : ''))|trim,
                    'placeholder': placeholder_text,
                    'aria-invalid': has_errors ? 'true' : 'false',
                    'aria-describedby': [
                        help_text ? field_id ~ '_help',
                        has_errors ? field_id ~ '_error'
                    ]|filter(v => v)|join(' ')|default(null),
                    'aria-required': is_required ? 'true' : 'false'
                }
            }) }}

            {# Label comes AFTER input for floating labels #}
            <label for="{{ field_id }}">
                {{ label_text }}
                {% if is_required %}
                    <span class="required" aria-label="{{ 'form.required'|trans({}, 'messages') }}">*</span>
                {% endif %}
            </label>
        </div>
    {% else %}
        {# Fallback for non-floating fields (checkbox, radio, file, hidden) #}
        <label for="{{ field_id }}" class="form-label">
            {{ label_text }}
            {% if is_required %}
                <span class="required" aria-label="{{ 'form.required'|trans({}, 'messages') }}">*</span>
            {% endif %}
        </label>

        {{ form_widget(field, {
            'attr': {
                'class': (field.vars.attr.class|default('') ~ (has_errors ? ' is-invalid' : ''))|trim,
                'aria-invalid': has_errors ? 'true' : 'false',
                'aria-describedby': [
                    help is defined and help ? field_id ~ '_help',
                    has_errors ? field_id ~ '_error'
                ]|filter(v => v)|join(' ')|default(null),
                'aria-required': is_required ? 'true' : 'false'
            }
        }) }}
    {% endif %}

    {# Help text (positioned below input) #}
    {% if help_text %}
        <div id="{{ field_id }}_help" class="form-text">
            <i class="bi bi-info-circle" aria-hidden="true"></i>
            {{ help_text }}
        </div>
    {% endif %}

    {# Error messages with ARIA live region #}
    {% if has_errors %}
        <div id="{{ field_id }}_error" class="invalid-feedback d-block" role="alert" aria-live="assertive">
            <i class="bi bi-exclamation-circle-fill" aria-hidden="true"></i>
            {% for error in field.vars.errors %}
                {{ error.message }}{% if not loop.last %}<br>{% endif %}
            {% endfor %}
        </div>
    {% endif %}
</div>

{#
    Accessibility Features Implemented:

    1. Bootstrap Floating Labels: Modern UX with animated labels
    2. aria-invalid: Indicates validation state to screen readers
    3. aria-describedby: Links help text and error messages to input
    4. aria-required: Announces required fields to screen readers
    5. role="alert": Error messages are announced immediately
    6. aria-live="assertive": Ensures errors interrupt screen reader flow
    7. aria-label: Required indicator has semantic meaning
    8. Visual indicators: Icons are marked aria-hidden (decorative)
    9. Unique IDs: All helper elements have unique IDs for association
    10. Placeholder: Required for floating labels, matches label text

    WCAG 2.1 Criteria Met:
    - 1.3.1 Info and Relationships (Level A)
    - 3.3.1 Error Identification (Level A)
    - 3.3.2 Labels or Instructions (Level A)
    - 3.3.3 Error Suggestion (Level AA)
    - 4.1.3 Status Messages (Level AA)

    Bootstrap Floating Labels Documentation:
    https://getbootstrap.com/docs/5.3/forms/floating-labels/
#}
