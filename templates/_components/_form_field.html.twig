{# Form Field Component - Bootstrap 5.3 Floating Labels with WCAG 2.1 AA compliance #}

{% set field_id = field.vars.id %}
{% set field_name = field.vars.full_name %}
{% set has_errors = field.vars.errors|length > 0 %}
{% set is_required = required|default(field.vars.required) %}
{% set field_type = field.vars.block_prefixes[1]|default('text') %}

{# Support both new (label_key) and old (label) parameters for backward compatibility #}
{% set trans_domain = translation_domain|default('messages') %}
{% set label_text = label_key is defined ? (label_key|trans({}, trans_domain)) : (label|default('')) %}
{% set help_text = help_key is defined ? (help_key|trans({}, trans_domain)) : (help|default(null)) %}
{% set explicit_tooltip = tooltip_key is defined ? (tooltip_key|trans({}, trans_domain)) : (tooltip|default(null)) %}
{# Use explicit tooltip if defined, otherwise fall back to help text as tooltip #}
{% set tooltip_text = explicit_tooltip ? explicit_tooltip : help_text %}

{# Floating labels work for: text, email, password, number, textarea, select #}
{# BUT NOT for expanded choice fields (radio/checkbox) #}
{% set is_expanded = field.vars.expanded|default(false) %}
{% set supports_floating = field_type in ['text', 'email', 'password', 'number', 'tel', 'url', 'search', 'textarea', 'choice'] and not is_expanded %}

<div class="mb-3">
    {% if supports_floating %}
        {# Bootstrap Floating Label wrapper with tooltip outside #}
        <div class="d-flex align-items-start gap-2">
            <div class="form-floating flex-grow-1">
                {# Input MUST come before label for floating effect #}
                {# Use label_text (translated) as placeholder, override any existing placeholder #}
                {% set placeholder_text = label_text %}
                {% set merged_attrs = field.vars.attr|merge({
                    'class': (field.vars.attr.class|default('') ~ (has_errors ? ' is-invalid' : ''))|trim,
                    'placeholder': placeholder_text,
                    'aria-invalid': has_errors ? 'true' : 'false',
                    'aria-describedby': has_errors ? field_id ~ '_error' : null,
                    'aria-required': is_required ? 'true' : 'false'
                }) %}
                {{ form_widget(field, {
                    'attr': merged_attrs
                }) }}

                {# Label comes AFTER input for floating labels #}
                <label for="{{ field_id }}">
                    {{ label_text }}
                    {% if is_required %}
                        <span class="required" aria-label="{{ 'form.required'|trans({}, 'messages') }}">*</span>
                    {% endif %}
                </label>
            </div>
            {# Tooltip icon OUTSIDE floating label for better accessibility #}
            {% if tooltip_text %}
                <i class="bi bi-question-circle-fill text-primary mt-3"
                   data-bs-toggle="tooltip"
                   data-bs-placement="right"
                   data-bs-html="true"
                   data-bs-title="{{ tooltip_text }}"
                   role="button"
                   tabindex="0"
                   aria-label="{{ 'common.help'|trans({}, 'messages') }}"
                   style="cursor: help; font-size: 1.1em;"></i>
            {% endif %}
        </div>
    {% else %}
        {# Fallback for non-floating fields (checkbox, radio, file, hidden) #}
        <label for="{{ field_id }}" class="form-label">
            {{ label_text }}
            {% if is_required %}
                <span class="required" aria-label="{{ 'form.required'|trans({}, 'messages') }}">*</span>
            {% endif %}
            {% if tooltip_text %}
                <i class="bi bi-question-circle-fill text-muted ms-1"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   data-bs-html="true"
                   data-bs-title="{{ tooltip_text }}"
                   role="button"
                   tabindex="0"
                   aria-label="{{ 'common.help'|trans({}, 'messages') }}"
                   style="cursor: help; font-size: 0.85em;"></i>
            {% endif %}
        </label>

        {{ form_widget(field, {
            'attr': {
                'class': (field.vars.attr.class|default('') ~ (has_errors ? ' is-invalid' : ''))|trim,
                'aria-invalid': has_errors ? 'true' : 'false',
                'aria-describedby': has_errors ? field_id ~ '_error' : null,
                'aria-required': is_required ? 'true' : 'false'
            }
        }) }}
    {% endif %}

    {# Error messages with ARIA live region #}
    {% if has_errors %}
        <div id="{{ field_id }}_error" class="invalid-feedback d-block" role="alert" aria-live="assertive">
            <i class="bi bi-exclamation-circle-fill" aria-hidden="true"></i>
            {% for error in field.vars.errors %}
                {{ error.message }}{% if not loop.last %}<br>{% endif %}
            {% endfor %}
        </div>
    {% endif %}
</div>
