{#
 # Risk Slider Component
 #
 # Visual risk scoring with interactive sliders and risk matrix.
 # ISO 27005 compliant risk levels: Low (1-4), Medium (5-9), High (10-14), Critical (15-25)
 #
 # Parameters:
 # - probability: Current probability value (1-5), default 1
 # - impact: Current impact value (1-5), default 1
 # - probability_field: Form field name for probability (e.g., 'risk[probability]')
 # - impact_field: Form field name for impact (e.g., 'risk[impact]')
 # - show_matrix: Show interactive risk matrix (default true)
 # - show_presets: Show quick preset buttons (default true)
 # - compact: Use compact layout (default false)
 # - prefix: Field prefix for residual risk (e.g., 'residual_')
 #
 # Example:
 # {% include '_components/_risk_slider.html.twig' with {
 #     probability: risk.probability,
 #     impact: risk.impact,
 #     probability_field: 'risk[probability]',
 #     impact_field: 'risk[impact]'
 # } %}
 #}

{% set probability = probability|default(1) %}
{% set impact = impact|default(1) %}
{% set show_matrix = show_matrix|default(true) %}
{% set show_presets = show_presets|default(true) %}
{% set compact = compact|default(false) %}
{% set prefix = prefix|default('') %}
{% set score = probability * impact %}

<div class="risk-slider-component"
     data-controller="risk-slider"
     data-risk-slider-probability-value="{{ probability }}"
     data-risk-slider-impact-value="{{ impact }}">

    <div class="row g-3">
        {# Probability Slider #}
        <div class="{% if compact %}col-6{% else %}col-md-6{% endif %}">
            <label class="form-label fw-bold">
                <i class="bi bi-percent text-info" aria-hidden="true"></i>
                {{ 'risk.field.probability'|trans({}, 'risk') }}
            </label>

            <div class="d-flex align-items-center gap-3">
                <input type="range"
                       class="form-range flex-grow-1"
                       min="1" max="5" step="1"
                       value="{{ probability }}"
                       data-risk-slider-target="probability"
                       data-action="input->risk-slider#calculate"
                       aria-label="{{ 'risk.field.probability'|trans({}, 'risk') }}">
                <div class="text-center" style="min-width: 100px;">
                    <span class="badge bg-info fs-5" data-risk-slider-target="probabilityValue">{{ probability }}</span>
                    <div class="small text-muted mt-1" data-risk-slider-target="probabilityLabel">
                        {% set probability_labels = {
                            1: 'risk.probability.rare'|trans({}, 'risk'),
                            2: 'risk.probability.unlikely'|trans({}, 'risk'),
                            3: 'risk.probability.possible'|trans({}, 'risk'),
                            4: 'risk.probability.likely'|trans({}, 'risk'),
                            5: 'risk.probability.almost_certain'|trans({}, 'risk')
                        } %}
                        {{ probability_labels[probability]|default('') }}
                    </div>
                </div>
            </div>

            {# Hidden field for form submission #}
            {% if probability_field is defined %}
                <input type="hidden"
                       name="{{ probability_field }}"
                       value="{{ probability }}"
                       data-risk-slider-target="hiddenProbability">
            {% endif %}
        </div>

        {# Impact Slider #}
        <div class="{% if compact %}col-6{% else %}col-md-6{% endif %}">
            <label class="form-label fw-bold">
                <i class="bi bi-lightning text-warning" aria-hidden="true"></i>
                {{ 'risk.field.impact'|trans({}, 'risk') }}
            </label>

            <div class="d-flex align-items-center gap-3">
                <input type="range"
                       class="form-range flex-grow-1"
                       min="1" max="5" step="1"
                       value="{{ impact }}"
                       data-risk-slider-target="impact"
                       data-action="input->risk-slider#calculate"
                       aria-label="{{ 'risk.field.impact'|trans({}, 'risk') }}">
                <div class="text-center" style="min-width: 100px;">
                    <span class="badge bg-warning fs-5" data-risk-slider-target="impactValue">{{ impact }}</span>
                    <div class="small text-muted mt-1" data-risk-slider-target="impactLabel">
                        {% set impact_labels = {
                            1: 'risk.impact.negligible'|trans({}, 'risk'),
                            2: 'risk.impact.minor'|trans({}, 'risk'),
                            3: 'risk.impact.moderate'|trans({}, 'risk'),
                            4: 'risk.impact.major'|trans({}, 'risk'),
                            5: 'risk.impact.severe'|trans({}, 'risk')
                        } %}
                        {{ impact_labels[impact]|default('') }}
                    </div>
                </div>
            </div>

            {# Hidden field for form submission #}
            {% if impact_field is defined %}
                <input type="hidden"
                       name="{{ impact_field }}"
                       value="{{ impact }}"
                       data-risk-slider-target="hiddenImpact">
            {% endif %}
        </div>
    </div>

    {# Risk Score Display #}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card {% if score >= 15 %}border-danger{% elseif score >= 10 %}border-warning{% elseif score >= 5 %}border-info{% else %}border-success{% endif %}">
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="text-center">
                                <div class="small text-muted mb-1">{{ 'risk.field.score'|trans({}, 'risk') }}</div>
                                <span class="display-4 fw-bold" data-risk-slider-target="score"
                                      style="color: {% if score >= 15 %}#dc3545{% elseif score >= 10 %}#fd7e14{% elseif score >= 5 %}#ffc107{% else %}#28a745{% endif %}">
                                    {{ score }}
                                </span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="small text-muted mb-1">{{ 'risk.field.level'|trans({}, 'risk') }}</div>
                            <span data-risk-slider-target="level"
                                  class="badge fs-6"
                                  style="background-color: {% if score >= 15 %}#f8d7da{% elseif score >= 10 %}#ffe5d0{% elseif score >= 5 %}#fff3cd{% else %}#d4edda{% endif %};
                                         color: {% if score >= 15 %}#dc3545{% elseif score >= 10 %}#fd7e14{% elseif score >= 5 %}#856404{% else %}#28a745{% endif %}">
                                {% if score >= 15 %}
                                    {{ 'risk.level.critical'|trans({}, 'risk') }}
                                {% elseif score >= 10 %}
                                    {{ 'risk.level.high'|trans({}, 'risk') }}
                                {% elseif score >= 5 %}
                                    {{ 'risk.level.medium'|trans({}, 'risk') }}
                                {% else %}
                                    {{ 'risk.level.low'|trans({}, 'risk') }}
                                {% endif %}
                            </span>
                        </div>

                        {% if show_presets %}
                        <div class="col-auto">
                            <div class="btn-group btn-group-sm" role="group" aria-label="{{ 'risk.presets'|trans({}, 'risk') }}">
                                <button type="button" class="btn btn-outline-success" data-action="click->risk-slider#setLow"
                                        title="{{ 'risk.preset.low'|trans({}, 'risk') }}">
                                    L
                                </button>
                                <button type="button" class="btn btn-outline-warning" data-action="click->risk-slider#setMedium"
                                        title="{{ 'risk.preset.medium'|trans({}, 'risk') }}">
                                    M
                                </button>
                                <button type="button" class="btn btn-outline-warning" data-action="click->risk-slider#setHigh"
                                        title="{{ 'risk.preset.high'|trans({}, 'risk') }}">
                                    H
                                </button>
                                <button type="button" class="btn btn-outline-danger" data-action="click->risk-slider#setCritical"
                                        title="{{ 'risk.preset.critical'|trans({}, 'risk') }}">
                                    C
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Interactive Risk Matrix #}
    {% if show_matrix %}
    <div class="row mt-4">
        <div class="col-12">
            <details class="mb-3">
                <summary class="text-muted cursor-pointer">
                    <i class="bi bi-grid-3x3" aria-hidden="true"></i>
                    {{ 'risk.show_matrix'|trans({}, 'risk') }}
                </summary>
                <div class="mt-3" data-risk-slider-target="matrix">
                    {# Matrix is rendered by JavaScript #}
                </div>
                <div class="small text-muted mt-2">
                    <i class="bi bi-info-circle" aria-hidden="true"></i>
                    {{ 'risk.matrix_help'|trans({}, 'risk') }}
                </div>
            </details>
        </div>
    </div>
    {% endif %}

</div>
