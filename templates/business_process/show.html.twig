{% extends 'base.html.twig' %}

{% block title %}{{ business_process.name }}{% endblock %}

{% block body %}
<div class="container-fluid">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('app_home') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ path('app_business_process_index') }}">BCM</a></li>
            <li class="breadcrumb-item active">{{ business_process.name }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ business_process.name }}</h1>
        <div>
            <a href="{{ path('app_business_process_bia', {'id': business_process.id}) }}" class="btn btn-info">
                <i class="bi bi-graph-up" aria-hidden="true"></i> {{ 'business_process.action.bia_view'|trans({}, 'bcm') }}
            </a>
            <a href="{{ path('app_business_process_edit', {'id': business_process.id}) }}" class="btn btn-primary">
                <i class="bi bi-pencil" aria-hidden="true"></i> {{ 'common.edit'|trans({}, 'messages') }}
            </a>
            <form method="post" action="{{ path('app_business_process_delete', {'id': business_process.id}) }}" class="d-inline-block"
                  data-controller="ui-actions"
                  data-action="submit->ui-actions#confirm"
                  data-ui-actions-message-param="{{ 'business_process.confirm.delete'|trans({}, 'bcm') }}">
                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ business_process.id) }}">
                <button class="btn btn-danger">
                    <i class="bi bi-trash" aria-hidden="true"></i> {{ 'common.delete'|trans({}, 'messages') }}
                </button>
            </form>
        </div>
    </div>

    {# KPI Cards with Data Reuse #}
    <div class="row mb-4">
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="h6 mb-2 text-muted">Kritikalität</div>
                    <p class="h3">
                        {% set criticality_badge = {
                            'critical': 'danger',
                            'high': 'warning',
                            'medium': 'info',
                            'low': 'success'
                        } %}
                        {% include '_components/_badge.html.twig' with { variant: criticality_badge[business_process.criticality] ?? 'secondary', content: business_process.criticality|capitalize } %}
                    </p>
                {% endblock %}
            {% endembed %}
        </div>
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="h6 mb-2 text-muted">Business Impact Score</div>
                    <p class="h3">{{ metrics.business_impact_score }}/5</p>
                    <small class="text-muted">Automatisch berechnet</small>
                {% endblock %}
            {% endembed %}
        </div>
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="h6 mb-2 text-muted">Prozess-Risikolevel</div>
                    <p class="h3">
                        {% set risk_badge = {
                            'critical': 'danger',
                            'high': 'warning',
                            'medium': 'info',
                            'low': 'success',
                            'unknown': 'secondary'
                        } %}
                        {% include '_components/_badge.html.twig' with { variant: risk_badge[metrics.process_risk_level] ?? 'secondary', content: metrics.process_risk_level|capitalize } %}
                    </p>
                    <small class="text-muted">{{ metrics.active_risks }} aktive Risiken</small>
                {% endblock %}
            {% endembed %}
        </div>
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' with {borderColor: (not metrics.criticality_aligned) ? 'warning' : ''} %}
                {% block card_body %}
                    <div class="h6 mb-2 text-muted">Alignment-Status</div>
                    <p class="h3">
                        {% if metrics.criticality_aligned %}
                            <i class="bi bi-check-circle text-success" aria-hidden="true"></i>
                        {% else %}
                            <i class="bi bi-exclamation-triangle text-warning" aria-hidden="true"></i>
                        {% endif %}
                    </p>
                    <small class="text-muted">
                        {% if metrics.criticality_aligned %}
                            BIA ↔ Risiko aligned
                        {% else %}
                            Überprüfung erforderlich
                        {% endif %}
                    </small>
                {% endblock %}
            {% endembed %}
        </div>
    </div>

    {# Main Content in Tabs with Turbo Frame #}
    {% embed '_components/_card.html.twig' %}
        {% block card_header %}
        <div class="card-header" data-controller="toggle">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-action="click->toggle#switchTab" data-tab="general" href="#">Allgemein</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-action="click->toggle#switchTab" data-tab="bia" href="#">BIA Daten</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-action="click->toggle#switchTab" data-tab="assets" href="#">Assets</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-action="click->toggle#switchTab" data-tab="risks" href="#">Risiken</a>
                </li>
            </ul>
        </div>
        {% endblock %}
        {% block card_body %}
            {# General Tab #}
            <div class="tab-content active" data-tab-content="general">
                {% embed '_components/_table.html.twig' with {
                    'noMargin': true
                } %}
                    {% block table_body %}
                        <tr>
                            <th scope="row" class="w-200px">Prozessverantwortlicher</th>
                            <td>{{ business_process.processOwner }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Beschreibung</th>
                            <td>{{ business_process.description ?? '-' }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Upstream-Abhängigkeiten</th>
                            <td>{{ business_process.dependenciesUpstream ?? '-' }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Downstream-Abhängigkeiten</th>
                            <td>{{ business_process.dependenciesDownstream ?? '-' }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Wiederherstellungsstrategie</th>
                            <td>{{ business_process.recoveryStrategy ?? '-' }}</td>
                        </tr>
                    {% endblock %}
                {% endembed %}
            </div>

            {# BIA Tab #}
            <div class="tab-content d-none" data-tab-content="bia">
                <div class="row">
                    <div class="col-md-6">
                        <h2>Recovery-Ziele</h2>
                        {% embed '_components/_table.html.twig' with {
                            'noMargin': true
                        } %}
                            {% block table_body %}
                                <tr>
                                    <th scope="row">RTO (Recovery Time Objective)</th>
                                    <td>{{ business_process.rto }} Stunden</td>
                                </tr>
                                <tr>
                                    <th scope="row">RPO (Recovery Point Objective)</th>
                                    <td>{{ business_process.rpo }} Stunden</td>
                                </tr>
                                <tr>
                                    <th scope="row">MTPD (Maximum Tolerable Period)</th>
                                    <td>{{ business_process.mtpd }} Stunden</td>
                                </tr>
                                <tr>
                                    <th scope="row">Empfohlenes RTO (basierend auf Risiken)</th>
                                    <td>
                                        {{ metrics.suggested_rto }} Stunden
                                        {% if metrics.suggested_rto != business_process.rto %}
                                            {% include '_components/_badge.html.twig' with { variant: 'warning', content: 'Abweichung' } %}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endblock %}
                        {% endembed %}
                    </div>
                    <div class="col-md-6">
                        <h2>Impact-Bewertung</h2>
                        {% embed '_components/_table.html.twig' with {
                            'noMargin': true
                        } %}
                            {% block table_body %}
                                <tr>
                                    <th scope="row">Reputationsschaden</th>
                                    <td>{{ business_process.reputationalImpact }}/5</td>
                                </tr>
                                <tr>
                                    <th scope="row">Regulatorischer Impact</th>
                                    <td>{{ business_process.regulatoryImpact }}/5</td>
                                </tr>
                                <tr>
                                    <th scope="row">Operationaler Impact</th>
                                    <td>{{ business_process.operationalImpact }}/5</td>
                                </tr>
                                <tr>
                                    <th scope="row">Finanzieller Schaden/Stunde</th>
                                    <td>{{ business_process.financialImpactPerHour ? (business_process.financialImpactPerHour|number_format(2, ',', '.') ~ ' €') : '-' }}</td>
                                </tr>
                                <tr>
                                    <th scope="row">Finanzieller Schaden/Tag</th>
                                    <td>{{ business_process.financialImpactPerDay ? (business_process.financialImpactPerDay|number_format(2, ',', '.') ~ ' €') : '-' }}</td>
                                </tr>
                            {% endblock %}
                        {% endembed %}
                    </div>
                </div>

                {% if metrics.unmitigated_high_risks %}
                    <div class="alert alert-danger mt-3">
                        <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                        <strong>Warnung:</strong> Dieser Prozess hat unbehandelte Hochrisiken!
                    </div>
                {% endif %}
            </div>

            {# Assets Tab #}
            <turbo-frame id="process-assets" data-tab-content="assets" class="d-none">
                {% if business_process.supportingAssets|length > 0 %}
                    {% embed '_components/_table.html.twig' with {
                        'noMargin': true
                    } %}
                        {% block table_head %}
                            <tr>
                                <th scope="col">Asset</th>
                                <th scope="col">Typ</th>
                                <th scope="col">CIA-Bewertung</th>
                                <th scope="col">Status</th>
                            </tr>
                        {% endblock %}
                        {% block table_body %}
                            {% for asset in business_process.supportingAssets %}
                                <tr>
                                    <td>{{ asset.name }}</td>
                                    <td>{{ asset.assetType }}</td>
                                    <td>
                                        C: {{ asset.confidentialityValue }},
                                        I: {{ asset.integrityValue }},
                                        A: {{ asset.availabilityValue }}
                                    </td>
                                    <td>{{ asset.status }}</td>
                                </tr>
                            {% endfor %}
                        {% endblock %}
                    {% endembed %}
                {% else %}
                    <div class="alert alert-info">
                        Keine unterstützenden Assets verknüpft.
                    </div>
                {% endif %}
            </turbo-frame>

            {# Risks Tab #}
            <turbo-frame id="process-risks" data-tab-content="risks" class="d-none">
                {% if business_process.identifiedRisks|length > 0 %}
                    {% embed '_components/_table.html.twig' with {
                        'noMargin': true
                    } %}
                        {% block table_head %}
                            <tr>
                                <th scope="col">Risiko</th>
                                <th scope="col">Status</th>
                                <th scope="col">Inherent Risk</th>
                                <th scope="col">Residual Risk</th>
                                <th scope="col">Behandlung</th>
                            </tr>
                        {% endblock %}
                        {% block table_body %}
                            {% for risk in business_process.identifiedRisks %}
                                <tr>
                                    <td>{{ risk.title }}</td>
                                    <td>
                                        <span class="{{ badge_status(risk.status) }}">
                                            {{ risk.status }}
                                        </span>
                                    </td>
                                    <td>{{ risk.inherentRiskLevel }}</td>
                                    <td>{{ risk.residualRiskLevel }}</td>
                                    <td>{{ risk.treatmentStrategy }}</td>
                                </tr>
                            {% endfor %}
                        {% endblock %}
                    {% endembed %}
                {% else %}
                    <div class="alert alert-info">
                        Keine Risiken verknüpft.
                    </div>
                {% endif %}
            </turbo-frame>
        {% endblock %}
    {% endembed %}
</div>

<style>
.tab-content.active {
    display: block !important;
}
</style>
{% endblock %}
