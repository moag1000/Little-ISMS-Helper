{% extends 'base.html.twig' %}
{% trans_default_domain 'bcm' %}
{% import '_macros/cards.html.twig' as cards %}

{% block title %}{{ 'bcm.title.asset_insights'|trans({}, 'bcm') }}: {{ asset.name }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'nav.assets'|trans({}, 'nav'), url: path('app_asset_index') },
            { label: asset.name, url: path('app_asset_show', {id: asset.id}) },
            { label: 'bcm.title.bcm_insights'|trans({}, 'bcm') }
        ]
    } %}

    <div class="page-header">
        <div>
            <h1><i class="bi bi-graph-up" aria-hidden="true"></i> {{ 'bcm.title.asset_insights'|trans({}, 'bcm') }}</h1>
            <p class="text-muted">{{ asset.name }}</p>
        </div>
        <div class="button-group">
            <a href="{{ path('app_asset_show', {id: asset.id}) }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'common.back'|trans({}, 'messages') }}
            </a>
            {% if canEdit %}
            <a href="{{ path('app_asset_edit', {id: asset.id}) }}" class="btn btn-primary">
                <i class="bi bi-pencil" aria-hidden="true"></i> {{ 'common.edit'|trans({}, 'messages') }}
            </a>
            {% endif %}
        </div>
    </div>

    {# Protection Requirement Analysis #}
    {% if analysis %}
    {% embed '_components/_card.html.twig' with {class: 'mb-4'} %}
        {% block card_header %}
            <div class="card-header">
                <h2 class="mb-0">{{ 'bcm.section.protection_analysis'|trans({}, 'bcm') }}</h2>
            </div>
        {% endblock %}
        {% block card_body %}
            <div class="row">
                {% if analysis.confidentiality is defined %}
                <div class="col-md-4 mb-3">
                    {% embed '_components/_card.html.twig' with {class: 'h-100'} %}
                        {% block card_body %}
                            <div class="text-center">
                                <div class="fw-bold fs-6 mb-2">{{ 'bcm.field.confidentiality'|trans({}, 'bcm') }}</div>
                                {% set confLevel = analysis.confidentiality.level|default('normal') %}
                                {% set levelColors = {'very_high': 'danger', 'high': 'warning', 'normal': 'info', 'low': 'secondary'} %}
                                {% include '_components/_badge.html.twig' with { variant: levelColors[confLevel]|default('secondary'), class: 'fs-5', content: ('bcm.level.' ~ confLevel)|trans({}, 'bcm') } %}
                            </div>
                        {% endblock %}
                    {% endembed %}
                </div>
                {% endif %}

                {% if analysis.integrity is defined %}
                <div class="col-md-4 mb-3">
                    {% embed '_components/_card.html.twig' with {class: 'h-100'} %}
                        {% block card_body %}
                            <div class="text-center">
                                <div class="fw-bold fs-6 mb-2">{{ 'bcm.field.integrity'|trans({}, 'bcm') }}</div>
                                {% set intLevel = analysis.integrity.level|default('normal') %}
                                {% include '_components/_badge.html.twig' with { variant: levelColors[intLevel]|default('secondary'), class: 'fs-5', content: ('bcm.level.' ~ intLevel)|trans({}, 'bcm') } %}
                            </div>
                        {% endblock %}
                    {% endembed %}
                </div>
                {% endif %}

                {% if analysis.availability is defined %}
                <div class="col-md-4 mb-3">
                    {% embed '_components/_card.html.twig' with {class: 'h-100'} %}
                        {% block card_body %}
                            <div class="text-center">
                                <div class="fw-bold fs-6 mb-2">{{ 'bcm.field.availability'|trans({}, 'bcm') }}</div>
                                {% set availLevel = analysis.availability.level|default('normal') %}
                                {% include '_components/_badge.html.twig' with { variant: levelColors[availLevel]|default('secondary'), class: 'fs-5', content: ('bcm.level.' ~ availLevel)|trans({}, 'bcm') } %}
                            </div>
                        {% endblock %}
                    {% endembed %}
                </div>
                {% endif %}
            </div>

            {% if analysis.overallLevel is defined %}
            <div class="alert alert-info mt-3">
                <strong>{{ 'bcm.field.overall_protection_level'|trans({}, 'bcm') }}:</strong>
                {{ ('bcm.level.' ~ analysis.overallLevel)|trans({}, 'bcm') }}
            </div>
            {% endif %}
        {% endblock %}
    {% endembed %}
    {% endif %}

    {# Associated Business Processes #}
    {% embed '_components/_card.html.twig' with {class: 'mb-4'} %}
        {% block card_header %}
            <div class="card-header">
                <h2 class="mb-0">{{ 'bcm.section.business_processes'|trans({}, 'bcm') }}</h2>
            </div>
        {% endblock %}
        {% block card_body %}
            {% if processes|length > 0 %}
            <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>{{ 'bcm.field.process_name'|trans({}, 'bcm') }}</th>
                        <th>{{ 'bcm.field.criticality'|trans({}, 'bcm') }}</th>
                        <th>{{ 'bcm.field.rto'|trans({}, 'bcm') }}</th>
                        <th>{{ 'bcm.field.rpo'|trans({}, 'bcm') }}</th>
                        <th class="text-center">{{ 'common.actions'|trans({}, 'messages') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for process in processes %}
                    <tr>
                        <td>
                            <strong>{{ process.name }}</strong>
                            {% if process.description %}
                            <br><small class="text-muted">{{ process.description|slice(0, 100) }}{% if process.description|length > 100 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% set critColors = {'critical': 'danger', 'high': 'warning', 'medium': 'info', 'low': 'secondary'} %}
                            {% include '_components/_badge.html.twig' with { variant: critColors[process.criticality]|default('secondary'), content: ('bcm.criticality.' ~ process.criticality)|trans({}, 'bcm') } %}
                        </td>
                        <td>{{ process.rto|default('-') }}h</td>
                        <td>{{ process.rpo|default('-') }}h</td>
                        <td class="text-center">
                            <a href="{{ path('app_business_process_show', {id: process.id}) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye" aria-hidden="true"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-diagram-3 fs-1 d-block mb-2" aria-hidden="true"></i>
                <p>{{ 'bcm.message.no_processes'|trans({}, 'bcm') }}</p>
                <a href="{{ path('app_business_process_new') }}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-lg" aria-hidden="true"></i> {{ 'bcm.action.add_process'|trans({}, 'bcm') }}
                </a>
            </div>
            {% endif %}
        {% endblock %}
    {% endembed %}

    {# Asset Details #}
    {% embed '_components/_card.html.twig' %}
        {% block card_header %}
            <div class="card-header">
                <h2 class="mb-0">{{ 'bcm.section.asset_details'|trans({}, 'bcm') }}</h2>
            </div>
        {% endblock %}
        {% block card_body %}
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">{{ 'asset.field.type'|trans({}, 'asset') }}</dt>
                        <dd class="col-sm-8">{{ asset.assetType|default('-') }}</dd>

                        <dt class="col-sm-4">{{ 'asset.field.status'|trans({}, 'asset') }}</dt>
                        <dd class="col-sm-8">{{ asset.status|default('-') }}</dd>

                        <dt class="col-sm-4">{{ 'asset.field.owner'|trans({}, 'asset') }}</dt>
                        <dd class="col-sm-8">{{ asset.owner|default('-') }}</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">{{ 'asset.field.location'|trans({}, 'asset') }}</dt>
                        <dd class="col-sm-8">{{ asset.physicalLocation ? asset.physicalLocation.name : (asset.location|default('-')) }}</dd>

                        <dt class="col-sm-4">{{ 'asset.field.availability'|trans({}, 'asset') }}</dt>
                        <dd class="col-sm-8">
                            {% if asset.availabilityValue %}
                                {% set availColors = {1: 'secondary', 2: 'success', 3: 'info', 4: 'warning', 5: 'danger'} %}
                                {% include '_components/_badge.html.twig' with { variant: availColors[asset.availabilityValue]|default('secondary'), content: asset.availabilityValue ~ '/5' } %}
                            {% else %}
                                -
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>

            {% if isInherited %}
            <div class="alert alert-info mt-3">
                <i class="bi bi-info-circle" aria-hidden="true"></i>
                {{ 'asset.message.inherited_asset'|trans({}, 'asset') }}
            </div>
            {% endif %}
        {% endblock %}
    {% endembed %}
</div>
{% endblock %}
