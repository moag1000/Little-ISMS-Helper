{% extends 'base.html.twig' %}
{% trans_default_domain 'assets' %}

{% block title %}{{ 'assets.modern.header.title'|trans({}, 'assets') }} - {{ 'app.title'|trans({}, 'messages') }}{% endblock %}

{% block body %}
{# Breadcrumb Navigation #}
{% include '_components/_breadcrumb.html.twig' with {
    breadcrumbs: [
        { label: 'assets.modern.breadcrumb'|trans({}, 'assets') }
    ]
} %}

{# Page Header with Actions #}
{% include '_components/_page_header.html.twig' with {
    title: 'assets.modern.header.title'|trans({}, 'assets'),
    subtitle: 'assets.modern.header.subtitle'|trans({}, 'assets'),
    icon: 'bi-server',
    actions: [
        { label: 'assets.modern.header.action.new'|trans({}, 'assets'), url: path('app_asset_new'), variant: 'primary', icon: 'bi-plus-circle' },
        { label: 'assets.modern.header.action.export'|trans({}, 'assets'), url: path('app_asset_export'), variant: 'secondary', icon: 'bi-download', turbo: false }
    ]
} %}

{# KPI Cards Grid #}
<div class="kpi-grid d-grid grid-responsive-250 gap-4 my-2rem">
    {% include '_components/_kpi_card.html.twig' with {
        icon: 'bi-server',
        label: 'assets.modern.kpi.total'|trans({}, 'assets'),
        value: detailedStats.total,
        detail: currentTenant ? ('corporate.stats.breakdown'|trans({'%own%': detailedStats.own, '%inherited%': detailedStats.inherited, '%subsidiaries%': detailedStats.subsidiaries}, 'tenant')) : null,
        variant: 'primary',
        link: '#all-assets'
    } %}

    {% set criticalAssets = assets|filter(a => a.confidentiality >= 4 or a.integrity >= 4 or a.availability >= 4)|length %}
    {% include '_components/_kpi_card.html.twig' with {
        icon: 'bi-shield-exclamation',
        label: 'assets.modern.kpi.critical'|trans({}, 'assets'),
        value: criticalAssets,
        variant: 'danger',
        link: '#filter-critical'
    } %}

    {% set avgCIA = (assets|reduce((carry, asset) => carry + asset.confidentiality + asset.integrity + asset.availability, 0) / (assets|length * 3))|round(1) %}
    {% include '_components/_kpi_card.html.twig' with {
        icon: 'bi-bar-chart',
        label: 'assets.modern.kpi.avg_cia'|trans({}, 'assets'),
        value: avgCIA,
        unit: 'assets.modern.kpi.unit.out_of_5'|trans({}, 'assets'),
        variant: 'info'
    } %}

    {% set assetsWithRisks = assets|filter(a => a.risks|length > 0)|length %}
    {% include '_components/_kpi_card.html.twig' with {
        icon: 'bi-exclamation-triangle',
        label: 'assets.modern.kpi.with_risks'|trans({}, 'assets'),
        value: assetsWithRisks,
        unit: '/ ' ~ assets|length,
        variant: 'warning'
    } %}
</div>

{# Type Distribution Chart #}
{% if typeStats|length > 0 %}
<div class="card mb-4">
    <div class="card-header">
        <h3><i class="bi bi-pie-chart" aria-hidden="true"></i> {{ 'assets.modern.chart.type_distribution'|trans({}, 'assets') }}</h3>
    </div>
    <div class="card-body">
        <div class="row">
            {% for stat in typeStats %}
            <div class="col-md-3 mb-3">
                <div class="stat-item">
                    <strong>{{ stat.assetType }}</strong>
                    <div class="progress mt-2 progress-h-8">
                        <div class="progress-bar"
                             style="width: {{ (stat.count / assets|length * 100)|round }}%"
                             title="{{ stat.count }} Assets">
                        </div>
                    </div>
                    <small class="text-muted">{{ stat.count }} Assets ({{ (stat.count / assets|length * 100)|round }}%)</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{# Assets Table or Empty State #}
{% if assets|length == 0 %}
    {% include '_components/_empty_state.html.twig' with {
        icon: 'bi-server',
        title: 'assets.modern.empty.title'|trans({}, 'assets'),
        description: 'assets.modern.empty.description'|trans({}, 'assets'),
        action: { label: 'assets.modern.empty.action_create_first'|trans({}, 'assets'), url: path('app_asset_new'), icon: 'bi-plus-circle' }
    } %}
{% else %}
<div class="card" data-controller="bulk-actions" data-bulk-actions-endpoint-value="/asset" data-bulk-actions-entity-label="{{ 'assets.modern.breadcrumb'|trans({}, 'assets') }}">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="mb-0"><i class="bi bi-list" aria-hidden="true"></i> {{ 'assets.modern.table.title_all'|trans({}, 'assets') }} ({{ assets|length }})</h3>
        <div>
            <label for="asset-search" class="visually-hidden">{{ 'assets.modern.breadcrumb'|trans({}, 'assets') }} durchsuchen</label>
            <input type="search"
                   class="form-control form-control-sm w-200px"
                   placeholder="{{ 'assets.modern.table.search_placeholder'|trans({}, 'assets') }}"
                   id="asset-search"
                   aria-label="{{ 'assets.modern.breadcrumb'|trans({}, 'assets') }} durchsuchen">
        </div>
    </div>
    {% embed '_components/_table.html.twig' with {
        'class': 'table-hover mb-0',
        'caption': 'assets.modern.table.caption'|trans({}, 'assets'),
        'noMargin': true,
        'responsive': true
    } %}
        {% block table_head %}
            <tr>
                <th scope="col" class="w-40px">
                    <input type="checkbox"
                           class="form-check-input"
                           data-action="bulk-actions#selectAll"
                           data-bulk-actions-target="selectAllCheckbox"
                           aria-label="{{ 'assets.modern.table.title_all'|trans({}, 'assets') }} auswählen">
                </th>
                <th scope="col">{{ 'assets.modern.table.head.name'|trans({}, 'assets') }}</th>
                <th scope="col">{{ 'assets.modern.table.head.type'|trans({}, 'assets') }}</th>
                <th scope="col" class="text-center">{{ 'assets.modern.table.head.confidentiality'|trans({}, 'assets') }}</th>
                <th scope="col" class="text-center">{{ 'assets.modern.table.head.integrity'|trans({}, 'assets') }}</th>
                <th scope="col" class="text-center">{{ 'assets.modern.table.head.availability'|trans({}, 'assets') }}</th>
                <th scope="col" class="text-center">{{ 'assets.modern.table.head.risks'|trans({}, 'assets') }}</th>
                <th scope="col" class="text-center">{{ 'assets.modern.table.head.controls'|trans({}, 'assets') }}</th>
                <th scope="col" class="text-center">{{ 'assets.modern.table.head.actions'|trans({}, 'assets') }}</th>
            </tr>
        {% endblock %}
        {% block table_body %}
            {% for asset in assets %}
            <tr data-asset-id="{{ asset.id }}">
                <td>
                    <input type="checkbox"
                           class="form-check-input"
                           data-bulk-actions-target="item"
                           data-action="bulk-actions#selectItem"
                           value="{{ asset.id }}"
                           aria-label="Asset {{ asset.name }} auswählen">
                </td>
                <td>
                    <strong>{{ asset.name }}</strong>
                    {% if asset.description %}
                    <br><small class="text-muted">{{ asset.description|length > 50 ? asset.description|slice(0, 50) ~ '...' : asset.description }}</small>
                    {% endif %}
                </td>
                <td>
                    <span class="badge bg-secondary">{{ asset.assetType }}</span>
                </td>
                <td class="text-center">
                    <span class="{{ badge_score(asset.confidentiality) }}">
                        {{ asset.confidentiality }}/5
                    </span>
                </td>
                <td class="text-center">
                    <span class="{{ badge_score(asset.integrity) }}">
                        {{ asset.integrity }}/5
                    </span>
                </td>
                <td class="text-center">
                    <span class="{{ badge_score(asset.availability) }}">
                        {{ asset.availability }}/5
                    </span>
                </td>
                <td class="text-center">
                    {% if asset.risks|length > 0 %}
                        <a href="{{ path('app_asset_risks', {id: asset.id}) }}"
                           class="badge bg-warning text-dark"
                           aria-label="{{ asset.risks|length }} Risiken für Asset {{ asset.name }}">
                            {{ asset.risks|length }}
                        </a>
                    {% else %}
                        <span class="text-muted">0</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if asset.protectingControls|length > 0 %}
                        <a href="{{ path('app_asset_controls', {id: asset.id}) }}"
                           class="badge bg-success"
                           aria-label="{{ asset.protectingControls|length }} Controls für Asset {{ asset.name }}">
                            {{ asset.protectingControls|length }}
                        </a>
                    {% else %}
                        <span class="text-muted">0</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group" aria-label="{{ 'assets.modern.table.head.actions'|trans({}, 'assets') }} für Asset {{ asset.name }}">
                        <a href="{{ path('app_asset_show', {id: asset.id}) }}"
                           class="btn btn-outline-primary"
                           data-turbo-action="advance"
                           aria-label="Asset {{ asset.name }} anzeigen">
                            <i class="bi bi-eye" aria-hidden="true"></i>
                        </a>
                        {% if is_granted('ROLE_USER') %}
                        <a href="{{ path('app_asset_edit', {id: asset.id}) }}"
                           class="btn btn-outline-secondary"
                           data-turbo-action="advance"
                           aria-label="Asset {{ asset.name }} bearbeiten">
                            <i class="bi bi-pencil" aria-hidden="true"></i>
                        </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        {% endblock %}
    {% endembed %}

    {# Bulk Action Bar #}
    {% include '_components/_bulk_action_bar.html.twig' with {
        actions: ['export', 'assign', 'delete']
    } %}
</div>
{% endif %}

{# Search functionality #}
<script>
document.getElementById('asset-search')?.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr[data-asset-id]');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });
});
</script>

{% endblock %}
