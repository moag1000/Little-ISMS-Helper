{% extends 'base.html.twig' %}

{% block title %}{{ training.title }} - {{ parent() }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ path('app_training_index') }}" data-turbo-action="advance">
                    <i class="bi bi-mortarboard" aria-hidden="true"></i> {{ 'training.title'|trans }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ training.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            {# Main Training Information #}
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-mortarboard" aria-hidden="true"></i> {{ training.title }}
                    </h4>
                    {% set statusClass = {
                        'planned': 'info',
                        'confirmed': 'primary',
                        'completed': 'success',
                        'cancelled': 'danger',
                        'postponed': 'warning'
                    } %}
                    <span class="badge bg-{{ statusClass[training.status] ?? 'secondary' }} fs-6">
                        {{ ('training.status.' ~ training.status)|trans }}
                    </span>
                </div>
                <div class="card-body">
                    {# Mandatory Warning Banner #}
                    {% if training.mandatory %}
                    <div class="alert alert-warning mb-4" role="alert">
                        <h5 class="alert-heading">
                            <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i> {{ 'training.mandatory_training'|trans }}
                        </h5>
                        <p class="mb-0">{{ 'training.mandatory_info'|trans }}</p>
                    </div>
                    {% endif %}

                    {# Description #}
                    {% if training.description %}
                    <div class="mb-4">
                        <h5><i class="bi bi-file-text" aria-hidden="true"></i> {{ 'training.description'|trans }}</h5>
                        <p class="text-muted">{{ training.description|nl2br }}</p>
                    </div>
                    <hr>
                    {% endif %}

                    {# Training Details #}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">{{ 'training.type'|trans }}</h6>
                            <p>
                                <span class="badge bg-secondary fs-6">
                                    {{ ('training.type.' ~ training.trainingType)|trans }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">{{ 'training.delivery_method'|trans }}</h6>
                            <p>
                                <span class="badge bg-info fs-6">
                                    {{ ('training.delivery.' ~ training.deliveryMethod)|trans }}
                                </span>
                            </p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-calendar-event" aria-hidden="true"></i> {{ 'training.scheduled_date'|trans }}
                            </h6>
                            <p class="fs-5">{{ training.scheduledDate|date('d.m.Y H:i') }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-hourglass" aria-hidden="true"></i> {{ 'training.duration'|trans }}
                            </h6>
                            <p class="fs-5">{{ training.duration }} {{ 'training.minutes'|trans }}</p>
                        </div>
                    </div>

                    {% if training.location %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">
                            <i class="bi bi-geo-alt" aria-hidden="true"></i> {{ 'training.location'|trans }}
                        </h6>
                        <p>{{ training.location }}</p>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <h6 class="text-muted mb-2">
                            <i class="bi bi-bullseye" aria-hidden="true"></i> {{ 'training.target_audience'|trans }}
                        </h6>
                        <p>
                            <span class="badge bg-light text-dark border">
                                {{ ('training.audience.' ~ training.targetAudience)|trans }}
                            </span>
                        </p>
                    </div>

                    {% if training.trainer %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">
                            <i class="bi bi-person-badge" aria-hidden="true"></i> {{ 'training.trainer'|trans }}
                        </h6>
                        <p>{{ training.trainer.firstName }} {{ training.trainer.lastName }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# Participants Section #}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="bi bi-people" aria-hidden="true"></i> {{ 'training.participants'|trans }}
                        <span class="badge bg-primary">{{ training.participants|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if training.participants|length > 0 %}
                    {% embed '_components/_table.html.twig' with {
                        'class': 'table-sm table-hover',
                        'responsive': true,
                        'noMargin': true
                    } %}
                        {% block table_head %}
                            <tr>
                                <th scope="col">{{ 'user.name'|trans }}</th>
                                <th scope="col">{{ 'user.email'|trans }}</th>
                                <th scope="col">{{ 'user.department'|trans }}</th>
                            </tr>
                        {% endblock %}
                        {% block table_body %}
                            {% for participant in training.participants %}
                            <tr>
                                <td>{{ participant.firstName }} {{ participant.lastName }}</td>
                                <td>{{ participant.email }}</td>
                                <td>{{ participant.department ?? '-' }}</td>
                            </tr>
                            {% endfor %}
                        {% endblock %}
                    {% endembed %}
                    {% else %}
                    <p class="text-muted mb-0">
                        <i class="bi bi-info-circle" aria-hidden="true"></i> {{ 'training.no_participants'|trans }}
                    </p>
                    {% endif %}
                </div>
            </div>

            {# Materials Section #}
            {% if training.materials %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="bi bi-file-earmark-text" aria-hidden="true"></i> {{ 'training.materials'|trans }}
                    </h5>
                </div>
                <div class="card-body">
                    <p>{{ training.materials|nl2br }}</p>
                </div>
            </div>
            {% endif %}

            {# Feedback Section #}
            {% if training.feedback %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="bi bi-chat-left-text" aria-hidden="true"></i> {{ 'training.feedback'|trans }}
                    </h5>
                </div>
                <div class="card-body">
                    <p>{{ training.feedback|nl2br }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            {# Action Buttons #}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0"><i class="bi bi-tools" aria-hidden="true"></i> {{ 'common.actions'|trans }}</h3>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if is_granted('ROLE_USER') %}
                        <a href="{{ path('app_training_edit', {id: training.id}) }}"
                           class="btn btn-primary"
                           data-turbo-action="advance">
                            <i class="bi bi-pencil" aria-hidden="true"></i> {{ 'common.edit'|trans }}
                        </a>
                        {% endif %}

                        <a href="{{ path('app_training_index') }}"
                           class="btn btn-outline-secondary"
                           data-turbo-action="advance">
                            <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'common.back_to_list'|trans }}
                        </a>

                        {% if is_granted('ROLE_ADMIN') %}
                        <hr>
                        <button type="button"
                                class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal">
                            <i class="bi bi-trash" aria-hidden="true"></i> {{ 'common.delete'|trans }}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Data Reuse: Covered Controls #}
            {% if training.coveredControls is defined and training.coveredControls|length > 0 %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="bi bi-shield-check" aria-hidden="true"></i> {{ 'training.covered_controls'|trans }}
                        <span class="badge bg-primary">{{ training.coveredControls|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for control in training.coveredControls %}
                        <div class="list-group-item px-0">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <div>
                                    <h4 class="mb-1">{{ control.controlId }}</h4>
                                    <p class="mb-1 small text-muted">{{ control.name }}</p>
                                </div>
                                <span class="badge bg-{{ control.implementationStatus == 'implemented' ? 'success' : (control.implementationStatus == 'in_progress' ? 'warning' : 'secondary') }} rounded-pill">
                                    {{ control.implementationStatus|upper }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {# Data Reuse: Compliance Coverage #}
            {% if training.complianceRequirements is defined and training.complianceRequirements|length > 0 %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="bi bi-clipboard-check" aria-hidden="true"></i> Compliance Coverage
                        <span class="badge bg-success">{{ training.complianceRequirements|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">Dieses Training erf√ºllt folgende Compliance-Anforderungen:</p>
                    <div class="d-flex flex-wrap gap-2">
                        {% for requirement in training.complianceRequirements %}
                            <span class="badge bg-info">
                                {{ requirement.framework ? requirement.framework.name : 'N/A' }}
                                {{ requirement.requirementId }}
                            </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {# Data Reuse: Training Statistics #}
            {% if training.status == 'completed' %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="bi bi-graph-up" aria-hidden="true"></i> Training Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small text-muted">Completion Rate</span>
                            <span class="small fw-bold">
                                {% if training.participants|length > 0 %}
                                    100%
                                {% else %}
                                    0%
                                {% endif %}
                            </span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {% if training.participants|length > 0 %}100{% else %}0{% endif %}%"></div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span class="text-muted">Participants:</span>
                        <span class="fw-bold">{{ training.participants|length }}</span>
                    </div>
                    {% if training.completionDate %}
                    <div class="d-flex justify-content-between small mt-2">
                        <span class="text-muted">Completed:</span>
                        <span class="fw-bold">{{ training.completionDate|date('d.m.Y') }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Metadata #}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0"><i class="bi bi-info-circle" aria-hidden="true"></i> {{ 'common.metadata'|trans }}</h3>
                </div>
                <div class="card-body">
                    <dl class="row mb-0 small">
                        <dt class="col-sm-5 text-muted">{{ 'common.created_at'|trans }}</dt>
                        <dd class="col-sm-7">{{ training.createdAt|date('d.m.Y H:i') }}</dd>

                        <dt class="col-sm-5 text-muted">{{ 'common.updated_at'|trans }}</dt>
                        <dd class="col-sm-7">{{ training.updatedAt|date('d.m.Y H:i') }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

{# Delete Confirmation Modal #}
{% if is_granted('ROLE_ADMIN') %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> {{ 'training.confirm_delete'|trans }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{{ 'training.delete_warning'|trans({'%title%': training.title}) }}</p>
                <p class="text-muted"><small>{{ 'common.action_irreversible'|trans }}</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {{ 'common.cancel'|trans }}
                </button>
                <form method="post" action="{{ path('app_training_delete', {id: training.id}) }}" style="display: inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ training.id) }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash" aria-hidden="true"></i> {{ 'common.delete'|trans }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
