{% extends 'base.html.twig' %}
{% trans_default_domain 'admin' %}

{% block title %}{{ 'admin.data_export.title'|trans({}, 'admin') }} - {{ 'admin.data_management.title'|trans({}, 'admin') }}{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-box-arrow-up" aria-hidden="true"></i> Data Export</h1>
    </div>

    {# Info Box #}
    <div class="alert alert-info mb-4">
        <h2><i class="bi bi-info-circle" aria-hidden="true"></i> About Data Export</h2>
        <p class="mb-0">
            Export your data in JSON or CSV format. You can select specific entities to export or export all data.
            <strong>Note:</strong> Large datasets may take some time to export.
        </p>
    </div>

    {# Export Form #}
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                <i class="bi bi-file-earmark-arrow-up" aria-hidden="true"></i> Configure Export
            </h3>
        </div>
        <div class="card-body">
            <form method="post" action="{{ path('data_export_execute') }}">
                <input type="hidden" name="_token" value="{{ csrf_token('data_export') }}">

                {# Export Format #}
                <div class="mb-4">
                    <div class="form-label"><strong>{{ 'admin.data_export.format'|trans({}, 'admin') }}:</strong></div>
                    <div class="btn-group" role="group" aria-label="{{ 'admin.data_export.format_selection'|trans({}, 'admin') }}">
                        <input type="radio" class="btn-check" name="format" id="format_json" value="json" checked>
                        <label class="btn btn-outline-primary" for="format_json">
                            <i class="bi bi-filetype-json" aria-hidden="true"></i> JSON
                        </label>

                        <input type="radio" class="btn-check" name="format" id="format_csv" value="csv">
                        <label class="btn btn-outline-primary" for="format_csv">
                            <i class="bi bi-filetype-csv" aria-hidden="true"></i> CSV
                        </label>
                    </div>
                    <div class="form-text">
                        JSON format preserves data types and is recommended for re-import. CSV is better for spreadsheet applications.
                    </div>
                </div>

                {# Entity Selection #}
                <div class="mb-4">
                    <label class="form-label" id="entity-selection-label"><strong>Select Entities to Export:</strong></label>

                    <div class="mb-2" role="group" aria-labelledby="entity-selection-label" data-controller="ui-actions">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="ui-actions#selectAll" data-ui-actions-container-param=".row">
                            <i class="bi bi-check-all" aria-hidden="true"></i> Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="ui-actions#deselectAll" data-ui-actions-container-param=".row">
                            <i class="bi bi-x" aria-hidden="true"></i> Deselect All
                        </button>
                    </div>

                    <div class="row">
                        {% for entity in entities %}
                            <div class="col-md-4 col-lg-3 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input entity-checkbox"
                                           type="checkbox"
                                           name="entities[]"
                                           value="{{ entity.class }}"
                                           id="entity_{{ loop.index }}">
                                    <label class="form-check-label" for="entity_{{ loop.index }}">
                                        {{ entity.name }}
                                        <small class="text-muted">({{ entity.table }})</small>
                                    </label>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                {# Submit Button #}
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-download" aria-hidden="true"></i> Export Selected Entities
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# Warning Box #}
    <div class="alert alert-warning mt-4">
        <h5><i class="bi bi-exclamation-triangle" aria-hidden="true"></i> Important Notes</h5>
        <ul class="mb-0">
            <li>{{ 'data_management.export.includes_all_records'|trans({}, 'messages')}}</li>
            <li>{{ 'data_management.export.sensitive_data_warning'|trans({}, 'messages')}}</li>
            <li>{{ 'data_management.export.large_exports_warning'|trans({}, 'messages')}}</li>
            <li>{{ 'data_management.export.relationships_warning'|trans({}, 'messages')}}</li>
            <li>For complete system backup, use the <a href="{{ path('data_backup_index') }}" class="alert-link">Database Backup</a> function</li>
        </ul>
    </div>
</div>

<script>
function selectAllEntities() {
    document.querySelectorAll('.entity-checkbox').forEach(cb => cb.checked = true);
}

function deselectAllEntities() {
    document.querySelectorAll('.entity-checkbox').forEach(cb => cb.checked = false);
}
</script>
{% endblock %}
