{% extends 'base.html.twig' %}
{% trans_default_domain 'suppliers' %}
{% import '_macros/inheritance_badge.html.twig' as inheritance %}
{% import '_macros/cards.html.twig' as cards %}

{% block title %}{{ 'supplier.title'|trans({}, 'suppliers') }}{% endblock %}

{% block body %}
<div class="container">
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'nav.suppliers'|trans({}, 'nav') }
        ]
    } %}

    <div class="page-header">
        <h1>{{ 'supplier.page.title'|trans({}, 'suppliers') }}</h1>
        <a href="{{ path('app_supplier_new') }}" class="btn btn-primary">{{ 'supplier.action.add_new'|trans({}, 'suppliers') }}</a>
    </div>

    {% if currentTenant %}
    <div class="card mb-3">
        <div class="card-body py-2">
            <form method="get" action="{{ path('app_supplier_index') }}" class="d-flex align-items-center gap-2">
                <label for="view-filter" class="mb-0 fw-bold">
                    <i class="bi bi-eye" aria-hidden="true"></i> {{ 'common.view'|trans({}, 'messages') }}:
                </label>
                <select class="form-select form-select-sm" style="width: auto;" id="view-filter" name="view" data-controller="ui-actions" data-action="change->ui-actions#autoSubmit">
                    <option value="own" {{ inheritanceInfo.currentView == 'own' ? 'selected' : '' }}>
                        {{ 'corporate.view.own_only'|trans({}, 'messages') }}
                    </option>
                    {% if inheritanceInfo.hasParent %}
                    <option value="inherited" {{ inheritanceInfo.currentView == 'inherited' ? 'selected' : '' }}>
                        {{ 'corporate.view.including_inherited'|trans({}, 'messages') }}
                    </option>
                    {% endif %}
                    {% if inheritanceInfo.hasSubsidiaries %}
                    <option value="subsidiaries" {{ inheritanceInfo.currentView == 'subsidiaries' ? 'selected' : '' }}>
                        {{ 'corporate.view.including_subsidiaries'|trans({}, 'messages') }}
                    </option>
                    {% endif %}
                </select>
                <noscript>
                    <button type="submit" class="btn btn-sm btn-secondary">{{ 'common.apply'|trans({}, 'messages') }}</button>
                </noscript>
            </form>
        </div>
    </div>
    {% endif %}

    {% if statistics %}
    <div class="row mb-4">
        <div class="col-md-3">
            {% if currentTenant %}
                {% set subtitle = 'corporate.stats.breakdown'|trans({'%own%': detailedStats.own, '%inherited%': detailedStats.inherited, '%subsidiaries%': detailedStats.subsidiaries}, 'tenant') %}
                {{ cards.kpi_card('supplier.statistics.total'|trans({}, 'suppliers'), detailedStats.total, subtitle, null, 'primary', null) }}
            {% else %}
                {{ cards.kpi_card('supplier.statistics.total'|trans({}, 'suppliers'), detailedStats.total, null, null, 'primary', null) }}
            {% endif %}
        </div>
        <div class="col-md-3">
            {{ cards.kpi_card('supplier.statistics.critical'|trans({}, 'suppliers'), statistics.critical, null, null, 'danger', null) }}
        </div>
        <div class="col-md-3">
            {{ cards.kpi_card('supplier.statistics.overdue_assessments'|trans({}, 'suppliers'), statistics.overdue_assessments, null, null, 'warning', null) }}
        </div>
        <div class="col-md-3">
            {{ cards.kpi_card('supplier.statistics.non_compliant'|trans({}, 'suppliers'), statistics.non_compliant, null, null, 'danger', null) }}
        </div>
    </div>
    {% endif %}

    {% if overdueAssessments|length > 0 %}
    <div class="alert alert-warning">
        <div class="fw-bold mb-2"><i class="bi bi-exclamation-triangle text-warning" aria-hidden="true"></i> {{ 'supplier.alert.overdue_assessments'|trans({}, 'suppliers') }}</div>
        <ul>
            {% for supplier in overdueAssessments %}
            <li>
                <a href="{{ path('app_supplier_show', {id: supplier.id}) }}">{{ supplier.name }}</a>
                - {{ 'supplier.next_assessment'|trans({}, 'suppliers') }}: {{ supplier.nextAssessmentDate ? supplier.nextAssessmentDate|date('Y-m-d') : ('supplier.not_scheduled'|trans({}, 'suppliers')) }}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if nonCompliant|length > 0 %}
    <div class="alert alert-danger">
        <div class="fw-bold mb-2">ðŸš¨ {{ 'supplier.alert.non_compliant'|trans({}, 'suppliers') }}</div>
        <ul>
            {% for supplier in nonCompliant %}
            <li>
                <a href="{{ path('app_supplier_show', {id: supplier.id}) }}">{{ supplier.name }}</a>
                - {{ 'supplier.risk_score'|trans({}, 'suppliers') }}: {{ supplier.calculateRiskScore() }}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="card" data-controller="bulk-actions" data-bulk-actions-endpoint-value="/supplier">
        <div class="card-header">
            {%- set supplierCount = suppliers|length -%}
            <h2>{{ 'supplier.list.title'|trans({'count': supplierCount}, 'suppliers') }}</h2>
        </div>
        <div class="card-body">
            {% if suppliers|length > 0 %}
            {% embed '_components/_table.html.twig' with {
                'wrapperClass': 'card-body',
                'noMargin': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col" class="w-40px">
                            <input type="checkbox"
                                   class="form-check-input"
                                   data-action="bulk-actions#selectAll"
                                   data-bulk-actions-target="selectAllCheckbox"
                                   aria-label="{{ 'common.select_all'|trans({}, 'messages') }}">
                        </th>
                        <th scope="col">{{ 'supplier.table.name'|trans({}, 'suppliers') }}</th>
                        <th scope="col">{{ 'supplier.table.service_provided'|trans({}, 'suppliers') }}</th>
                        <th scope="col">{{ 'supplier.table.criticality'|trans({}, 'suppliers') }}</th>
                        <th scope="col">{{ 'supplier.table.status'|trans({}, 'suppliers') }}</th>
                        <th scope="col">{{ 'supplier.table.risk_score'|trans({}, 'suppliers') }}</th>
                        <th scope="col">{{ 'supplier.table.iso27001'|trans({}, 'suppliers') }}</th>
                        <th scope="col">{{ 'supplier.table.actions'|trans({}, 'suppliers') }}</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% import '_macros/inheritance_badge.html.twig' as inheritance %}
                    {% for supplier in suppliers %}
                    <tr data-supplier-id="{{ supplier.id }}">
                        <td>
                            <input type="checkbox"
                                   class="form-check-input"
                                   data-bulk-actions-target="item"
                                   data-action="bulk-actions#selectItem"
                                   value="{{ supplier.id }}"
                                   aria-label="{{ 'common.select'|trans({}, 'messages') }} {{ supplier.name }}">
                        </td>
                        <td>
                            <a href="{{ path('app_supplier_show', {id: supplier.id}) }}">{{ supplier.name }}</a>
                            {{ inheritance.small_badge(supplier, currentTenant) }}
                        </td>
                        <td>{{ supplier.serviceProvided|slice(0, 50) }}...</td>
                        <td>{% include '_components/_badge.html.twig' with { variant: supplier.criticality == 'critical' ? 'danger' : (supplier.criticality == 'high' ? 'warning' : (supplier.criticality == 'medium' ? 'info' : 'secondary')), content: supplier.criticality|upper } %}</td>
                        <td><span class="{{ badge_status(supplier.status) }}">{{ supplier.status }}</span></td>
                        <td>
                            {% set riskScore = supplier.calculateRiskScore() %}
                            {% include '_components/_badge.html.twig' with { variant: riskScore > 70 ? 'danger' : (riskScore > 50 ? 'warning' : (riskScore > 30 ? 'info' : 'secondary')), content: riskScore } %}
                        </td>
                        <td>{{ supplier.hasISO27001 ? 'âœ“' : 'âœ—' }}</td>
                        <td>
                            <a href="{{ path('app_supplier_show', {id: supplier.id}) }}" class="btn btn-sm btn-secondary">{{ 'supplier.action.view'|trans({}, 'suppliers') }}</a>
                            <a href="{{ path('app_supplier_edit', {id: supplier.id}) }}" class="btn btn-sm btn-primary">{{ 'supplier.action.edit'|trans({}, 'suppliers') }}</a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
            {% else %}
            <p>{{ 'supplier.empty.message'|trans({}, 'suppliers') }} <a href="{{ path('app_supplier_new') }}">{{ 'supplier.empty.add_first'|trans({}, 'suppliers') }}</a>.</p>
            {% endif %}
        </div>

        {# Bulk Action Bar #}
        {% if suppliers|length > 0 %}
        {% include '_components/_bulk_action_bar.html.twig' with {
            actions: ['export', 'delete']
        } %}
        {% endif %}
    </div>
</div>

<style>
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
.stat-item { display: flex; flex-direction: column; padding: 1rem; background: var(--bs-tertiary-bg); border-radius: 4px; }
.stat-label { font-size: 0.875rem; color: var(--bs-secondary-color); }
.stat-value { font-size: 1.5rem; font-weight: bold; color: var(--bs-body-color); }
.stat-value.critical { color: #dc2626; }
.stat-value.warning { color: #f59e0b; }
.stat-value.danger { color: #dc2626; }
</style>
{% endblock %}
