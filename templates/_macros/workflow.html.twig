{#
 # Workflow-related Twig macros for SLA timelines and workflow components
 #}

{#
 # SLA Visual Timeline Macro
 #
 # Displays a visual progress bar showing time elapsed and urgency level
 # for workflow SLA deadlines with color-coded indicators.
 #
 # @param deadline DateTime The deadline/due date for the SLA
 # @param label string The label for the timeline (optional)
 # @param slaHours int The total SLA hours allocated (optional, used for calculation)
 # @param startTime DateTime The start time for SLA calculation (optional, defaults to 'now')
 # @param compact bool Whether to use compact mode (for widgets/tables)
 #}
{% macro sla_timeline(deadline, label = null, slaHours = null, startTime = null, compact = false) %}
    {% if deadline %}
        {# Calculate time remaining #}
        {% set now = date() %}
        {% set totalSeconds = deadline.timestamp - now.timestamp %}
        {% set totalMinutes = (totalSeconds / 60)|round %}
        {% set totalHours = (totalSeconds / 3600)|round(1) %}
        {% set isOverdue = totalSeconds < 0 %}

        {# Calculate percentage elapsed #}
        {% if slaHours and startTime %}
            {% set slaSeconds = slaHours * 3600 %}
            {% set elapsedSeconds = now.timestamp - startTime.timestamp %}
            {% set percentElapsed = ((elapsedSeconds / slaSeconds) * 100)|round %}
        {% else %}
            {# Estimate based on deadline if no start time provided #}
            {% if totalHours > 168 %}
                {# More than 7 days - assume low urgency #}
                {% set percentElapsed = 25 %}
            {% elseif totalHours > 48 %}
                {# 2-7 days - moderate progress #}
                {% set percentElapsed = 50 %}
            {% elseif totalHours > 24 %}
                {# 1-2 days - high progress #}
                {% set percentElapsed = 70 %}
            {% elseif totalHours > 2 %}
                {# 2-24 hours - very high progress #}
                {% set percentElapsed = 85 %}
            {% elseif not isOverdue %}
                {# Less than 2 hours - critical #}
                {% set percentElapsed = 95 %}
            {% else %}
                {# Overdue #}
                {% set percentElapsed = 100 %}
            {% endif %}
        {% endif %}

        {# Clamp percentage to 0-100 range #}
        {% set percentElapsed = percentElapsed < 0 ? 0 : (percentElapsed > 100 ? 100 : percentElapsed) %}

        {# Determine color class and status based on percentage elapsed #}
        {% if isOverdue %}
            {% set colorClass = 'sla-overdue' %}
            {% set statusText = 'sla.overdue'|trans({}, 'workflows') %}
            {% set statusIcon = 'bi-exclamation-triangle-fill' %}
        {% elseif percentElapsed >= 80 %}
            {% set colorClass = 'sla-critical' %}
            {% set statusText = 'sla.critical'|trans({}, 'workflows') %}
            {% set statusIcon = 'bi-clock-fill' %}
        {% elseif percentElapsed >= 50 %}
            {% set colorClass = 'sla-at-risk' %}
            {% set statusText = 'sla.at_risk'|trans({}, 'workflows') %}
            {% set statusIcon = 'bi-hourglass-split' %}
        {% else %}
            {% set colorClass = 'sla-on-track' %}
            {% set statusText = 'sla.on_track'|trans({}, 'workflows') %}
            {% set statusIcon = 'bi-check-circle' %}
        {% endif %}

        {# Format time remaining display #}
        {% if isOverdue %}
            {% set absHours = (totalHours * -1) %}
            {% if absHours < 24 %}
                {% set timeDisplay = absHours|round(1) ~ 'sla.hours_short'|trans({}, 'workflows') ~ ' ' ~ 'sla.overdue'|trans({}, 'workflows') %}
            {% else %}
                {% set days = (absHours / 24)|round(1) %}
                {% set timeDisplay = days ~ 'sla.days_short'|trans({}, 'workflows') ~ ' ' ~ 'sla.overdue'|trans({}, 'workflows') %}
            {% endif %}
        {% else %}
            {% if totalHours < 1 %}
                {% set timeDisplay = totalMinutes ~ 'sla.minutes_short'|trans({}, 'workflows') %}
            {% elseif totalHours < 24 %}
                {% set hours = totalHours|round(1) %}
                {% set timeDisplay = hours ~ 'sla.hours_short'|trans({}, 'workflows') %}
            {% else %}
                {% set days = (totalHours / 24)|round(1) %}
                {% set timeDisplay = days ~ 'sla.days_short'|trans({}, 'workflows') %}
            {% endif %}
        {% endif %}

        {% if compact %}
            {# Compact mode for widgets and tables #}
            <div class="sla-timeline-compact {{ colorClass }}"
                 role="status"
                 aria-label="{{ label ?? 'sla.progress_label'|trans({}, 'workflows') }}: {{ percentElapsed }}% {{ 'sla.elapsed'|trans({}, 'workflows') }}, {{ timeDisplay }} {{ 'sla.remaining'|trans({}, 'workflows') }}"
                 title="{{ deadline|date('d.m.Y H:i') }}">
                <div class="sla-progress-mini">
                    <div class="sla-progress-bar-mini {{ colorClass }}" style="width: {{ percentElapsed }}%"></div>
                </div>
                <div class="sla-info-mini">
                    <i class="bi {{ statusIcon }}" aria-hidden="true"></i>
                    <span class="sla-time-mini">{{ timeDisplay }}</span>
                </div>
            </div>
        {% else %}
            {# Full mode for detail pages #}
            <div class="sla-timeline {{ colorClass }}"
                 role="region"
                 aria-label="{{ label ?? 'sla.progress_label'|trans({}, 'workflows') }}">
                {% if label %}
                    <div class="sla-label">
                        {{ label }}
                        <span class="badge bg-{{ colorClass }} ms-2">
                            <i class="bi {{ statusIcon }}" aria-hidden="true"></i>
                            {{ statusText }}
                        </span>
                    </div>
                {% endif %}

                <div class="sla-progress-container">
                    <div class="sla-progress-track">
                        <div class="sla-progress-bar {{ colorClass }}"
                             style="width: {{ percentElapsed }}%"
                             role="progressbar"
                             aria-valuenow="{{ percentElapsed }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                        </div>
                    </div>
                    <div class="sla-progress-label">
                        <span class="sla-percentage">{{ percentElapsed }}% {{ 'sla.elapsed'|trans({}, 'workflows') }}</span>
                    </div>
                </div>

                <div class="sla-footer">
                    <div class="sla-time-remaining">
                        <i class="bi bi-clock" aria-hidden="true"></i>
                        <strong>{{ timeDisplay }}</strong> {{ 'sla.time_remaining'|trans({}, 'workflows') }}
                    </div>
                    <div class="sla-deadline" title="{{ 'workflow.field.due_date'|trans({}, 'workflows') }}">
                        <i class="bi bi-calendar-event" aria-hidden="true"></i>
                        <span>{{ deadline|date('d.m.Y H:i') }}</span>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}
{% endmacro %}

{#
 # Workflow Inline Actions Macro
 #
 # Displays workflow status with quick action buttons (Approve/Reject) directly
 # in entity show pages, avoiding the need to navigate to the workflow page.
 #
 # @param workflowInstance WorkflowInstance The workflow instance
 # @param entity object The parent entity (Incident, Document, etc.)
 # @param canApprove bool Whether current user can approve this workflow
 # @param compact bool Whether to use compact mode (default: false)
 #}
{% macro inline_actions(workflowInstance, entity, canApprove = false, compact = false) %}
    {% if workflowInstance %}
        {% set currentStep = workflowInstance.currentStep %}
        {% set dueDate = workflowInstance.dueDate %}
        {% set isOverdue = workflowInstance.isOverdue %}

        <div class="workflow-inline-actions {% if not compact %}p-3 bg-light rounded border{% else %}p-2{% endif %}">
            <div class="d-flex justify-content-between align-items-start {% if compact %}flex-column flex-md-row{% endif %} gap-2">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <i class="bi bi-diagram-3" aria-hidden="true"></i>
                        <strong>{{ workflowInstance.workflow.name }}</strong>

                        {% set statusColors = {
                            'pending': 'warning',
                            'in_progress': 'info',
                            'approved': 'success',
                            'rejected': 'danger',
                            'cancelled': 'secondary'
                        } %}
                        <span class="badge bg-{{ statusColors[workflowInstance.status] ?? 'secondary' }}">
                            {{ ('workflow.status.' ~ workflowInstance.status)|trans({}, 'workflows') }}
                        </span>

                        {% if isOverdue %}
                            <span class="badge bg-danger">
                                <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                                {{ 'workflow.badge.overdue'|trans({}, 'workflows') }}
                            </span>
                        {% endif %}
                    </div>

                    {% if currentStep %}
                        <div class="small text-muted mb-1">
                            <i class="bi bi-arrow-right" aria-hidden="true"></i>
                            {{ 'workflow.field.current_step'|trans({}, 'workflows') }}: {{ currentStep.name }}
                        </div>
                    {% endif %}

                    {% if dueDate and not compact %}
                        <div class="mt-2">
                            {{ _self.sla_timeline(dueDate, null, null, workflowInstance.startedAt, true) }}
                        </div>
                    {% endif %}
                </div>

                <div class="btn-group" role="group">
                    {% if canApprove and workflowInstance.status in ['pending', 'in_progress'] %}
                        <button type="button"
                                class="btn btn-sm btn-success"
                                data-bs-toggle="modal"
                                data-bs-target="#approveWorkflow{{ workflowInstance.id }}"
                                title="{{ 'workflow.widget.action.approve'|trans({}, 'workflows') }}">
                            <i class="bi bi-check-lg" aria-hidden="true"></i>
                            {% if not compact %}{{ 'workflow.widget.action.approve'|trans({}, 'workflows') }}{% endif %}
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#rejectWorkflow{{ workflowInstance.id }}"
                                title="{{ 'workflow.widget.action.reject'|trans({}, 'workflows') }}">
                            <i class="bi bi-x-lg" aria-hidden="true"></i>
                            {% if not compact %}{{ 'workflow.widget.action.reject'|trans({}, 'workflows') }}{% endif %}
                        </button>
                    {% endif %}

                    <a href="{{ path('app_workflow_instance_show', {id: workflowInstance.id}) }}"
                       class="btn btn-sm btn-outline-primary"
                       title="{{ 'workflow.action.view_full_workflow'|trans({}, 'workflows') }}">
                        <i class="bi bi-diagram-3" aria-hidden="true"></i>
                        {% if not compact %}{{ 'workflow.action.view_full_workflow'|trans({}, 'workflows') }}{% endif %}
                    </a>
                </div>
            </div>
        </div>

        {# Approve Modal #}
        {% if canApprove and workflowInstance.status in ['pending', 'in_progress'] %}
            <div class="modal fade" id="approveWorkflow{{ workflowInstance.id }}" tabindex="-1" aria-labelledby="approveWorkflowLabel{{ workflowInstance.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <form method="post" action="{{ path('app_workflow_instance_approve', {id: workflowInstance.id}) }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('approve' ~ workflowInstance.id) }}">

                            <div class="modal-header">
                                <h5 class="modal-title" id="approveWorkflowLabel{{ workflowInstance.id }}">
                                    <i class="bi bi-check-circle" aria-hidden="true"></i>
                                    {{ 'workflow.widget.action.approve'|trans({}, 'workflows') }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>

                            <div class="modal-body">
                                <p class="mb-3">
                                    {{ 'workflow.widget.confirm.approve'|trans({workflow: workflowInstance.workflow.name}, 'workflows') }}
                                </p>

                                {% if entity is defined %}
                                    <div class="alert alert-info mb-3">
                                        <strong>{{ 'workflow.field.related_entity'|trans({}, 'workflows') }}:</strong>
                                        {{ entity.title ?? entity.name ?? entity.referenceNumber ?? 'N/A' }}
                                    </div>
                                {% endif %}

                                <div class="mb-3">
                                    <label for="approveComments{{ workflowInstance.id }}" class="form-label">
                                        {{ 'workflow.widget.field.comments'|trans({}, 'workflows') }}
                                        <span class="text-muted">({{ 'common.optional'|trans({}, 'messages') }})</span>
                                    </label>
                                    <textarea class="form-control"
                                              id="approveComments{{ workflowInstance.id }}"
                                              name="comments"
                                              rows="3"
                                              placeholder="{{ 'workflow.widget.placeholder.approval_comments'|trans({}, 'workflows') }}"></textarea>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    {{ 'workflow.action.cancel'|trans({}, 'workflows') }}
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-lg" aria-hidden="true"></i>
                                    {{ 'workflow.widget.action.approve'|trans({}, 'workflows') }}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            {# Reject Modal #}
            <div class="modal fade" id="rejectWorkflow{{ workflowInstance.id }}" tabindex="-1" aria-labelledby="rejectWorkflowLabel{{ workflowInstance.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <form method="post" action="{{ path('app_workflow_instance_reject', {id: workflowInstance.id}) }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('reject' ~ workflowInstance.id) }}">

                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title" id="rejectWorkflowLabel{{ workflowInstance.id }}">
                                    <i class="bi bi-x-circle" aria-hidden="true"></i>
                                    {{ 'workflow.widget.action.reject'|trans({}, 'workflows') }}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>

                            <div class="modal-body">
                                <p class="mb-3">
                                    {{ 'workflow.widget.confirm.reject'|trans({workflow: workflowInstance.workflow.name}, 'workflows') }}
                                </p>

                                {% if entity is defined %}
                                    <div class="alert alert-warning mb-3">
                                        <strong>{{ 'workflow.field.related_entity'|trans({}, 'workflows') }}:</strong>
                                        {{ entity.title ?? entity.name ?? entity.referenceNumber ?? 'N/A' }}
                                    </div>
                                {% endif %}

                                <div class="mb-3">
                                    <label for="rejectComments{{ workflowInstance.id }}" class="form-label">
                                        {{ 'workflow.widget.field.reason'|trans({}, 'workflows') }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control"
                                              id="rejectComments{{ workflowInstance.id }}"
                                              name="comments"
                                              rows="4"
                                              required
                                              placeholder="{{ 'workflow.widget.placeholder.rejection_reason'|trans({}, 'workflows') }}"></textarea>
                                    <div class="form-text">
                                        {{ 'workflow.widget.help.rejection_reason'|trans({}, 'workflows') }}
                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    {{ 'workflow.action.cancel'|trans({}, 'workflows') }}
                                </button>
                                <button type="submit" class="btn btn-danger">
                                    <i class="bi bi-x-lg" aria-hidden="true"></i>
                                    {{ 'workflow.widget.action.reject'|trans({}, 'workflows') }}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}
{% endmacro %}
