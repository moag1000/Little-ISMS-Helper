{% extends 'base.html.twig' %}
{% trans_default_domain 'audit' %}

{% block title %}{{ audit.title }} - {{ parent() }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ path('app_audit_index') }}" data-turbo-action="advance">
                    <i class="bi bi-clipboard-check" aria-hidden="true"></i> {{ 'audit_management.title'|trans({}, 'audit') }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ audit.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            {# Main Audit Information #}
            <div class="card mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-check" aria-hidden="true"></i> {{ audit.title }}
                    </h5>
                    <span class="{{ badge_status(audit.status) }} fs-6">
                        {{ ('audit.status.' ~ audit.status)|trans({}, 'audit') }}
                    </span>
                </div>
                <div class="card-body">
                    {# Audit Number #}
                    <div class="mb-3">
                        <span class="badge bg-dark fs-6">{{ audit.auditNumber }}</span>
                    </div>

                    {# Scope #}
                    <div class="mb-4">
                        <h5><i class="bi bi-bullseye" aria-hidden="true"></i> {{ 'audit.scope'|trans({}, 'audit') }}</h5>
                        <p class="text-muted">{{ audit.scope ? audit.scope|nl2br : '-' }}</p>
                        <div class="mt-2">
                            <span class="badge bg-secondary">
                                {{ ('audit.scope_type.' ~ audit.scopeType)|trans({}, 'audit') }}
                            </span>
                        </div>

                        {# Corporate Audit Subsidiaries #}
                        {% if audit.auditedSubsidiaries|length > 0 %}
                        <div class="mt-3 p-3 border border-primary rounded bg-light">
                            <h6 class="text-primary mb-2">
                                <i class="bi bi-building" aria-hidden="true"></i> {{ 'audit.field.audited_subsidiaries'|trans({}, 'audit') }}
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for subsidiary in audit.auditedSubsidiaries %}
                                <span class="badge bg-primary">
                                    {{ subsidiary.name }}
                                </span>
                                {% endfor %}
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle" aria-hidden="true"></i>
                                {{ 'audit.message.corporate_subsidiaries_info'|trans({'%count%': audit.auditedSubsidiaries|length}, 'audit') }}
                            </small>
                        </div>
                        {% endif %}

                        {# Scoped Assets #}
                        {% if audit.scopedAssets|length > 0 %}
                        <div class="mt-3 p-3 border border-info rounded bg-light">
                            <h6 class="text-info mb-2">
                                <i class="bi bi-hdd-stack" aria-hidden="true"></i> {{ 'audit.field.scoped_assets'|trans({}, 'audit') }}
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for asset in audit.scopedAssets %}
                                <span class="badge bg-info">
                                    {{ asset.name }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <hr>

                    {# Framework & Objectives #}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-shield-check" aria-hidden="true"></i> {{ 'audit.field.scoped_framework'|trans({}, 'audit') }}
                            </h6>
                            <p>
                                {% if audit.scopedFramework %}
                                    <span class="badge bg-primary fs-6">
                                        {{ audit.scopedFramework.name }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">{{ 'audit.field.audited_departments'|trans({}, 'audit') }}</h6>
                            <p>{{ audit.auditedDepartments ?? '-' }}</p>
                        </div>
                    </div>

                    {# Dates #}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-calendar-event" aria-hidden="true"></i> {{ 'audit.planned_date'|trans({}, 'audit') }}
                            </h6>
                            <p class="fs-5">{{ audit.plannedDate|date('d.m.Y') }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-calendar-check" aria-hidden="true"></i> {{ 'audit.actual_date'|trans({}, 'audit') }}
                            </h6>
                            <p class="fs-5">{{ audit.actualDate ? audit.actualDate|date('d.m.Y') : '-' }}</p>
                        </div>
                    </div>

                    {# Team #}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-person-badge" aria-hidden="true"></i> {{ 'audit.lead_auditor'|trans({}, 'audit') }}
                            </h6>
                            <p>{{ audit.leadAuditor ?? '-' }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-people" aria-hidden="true"></i> {{ 'audit.audit_team'|trans({}, 'audit') }}
                            </h6>
                            <p>{{ audit.auditTeam ? audit.auditTeam|nl2br : '-' }}</p>
                        </div>
                    </div>

                    {# Objectives #}
                    {% if audit.objectives %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-2">
                            <i class="bi bi-bullseye" aria-hidden="true"></i> {{ 'audit.field.objectives'|trans({}, 'audit') }}
                        </h6>
                        <p>{{ audit.objectives|nl2br }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# Findings Section #}
            {% if audit.findings or audit.nonConformities or audit.observations %}
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning">
                    <h3 class="mb-0">
                        <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> {{ 'audit.section.findings'|trans({}, 'audit') }}
                    </h3>
                </div>
                <div class="card-body">
                    {% if audit.findings %}
                    <div class="mb-3">
                        <h6 class="text-muted">{{ 'audit.findings'|trans({}, 'audit') }}</h6>
                        <p>{{ audit.findings|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.nonConformities %}
                    <div class="mb-3 alert alert-danger">
                        <h6 class="alert-heading">{{ 'audit.nonconformities'|trans({}, 'audit') }}</h6>
                        <p class="mb-0">{{ audit.nonConformities|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.observations %}
                    <div class="mb-0 alert alert-info">
                        <h6 class="alert-heading">{{ 'audit.observations'|trans({}, 'audit') }}</h6>
                        <p class="mb-0">{{ audit.observations|nl2br }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Recommendations & Conclusion #}
            {% if audit.recommendations or audit.conclusion %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0">
                        <i class="bi bi-lightbulb" aria-hidden="true"></i> {{ 'audit.section.recommendations'|trans({}, 'audit') }}
                    </h3>
                </div>
                <div class="card-body">
                    {% if audit.recommendations %}
                    <div class="mb-3">
                        <h6 class="text-muted">{{ 'audit.recommendations'|trans({}, 'audit') }}</h6>
                        <p>{{ audit.recommendations|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.conclusion %}
                    <div class="mb-0">
                        <h6 class="text-muted">{{ 'audit.conclusion'|trans({}, 'audit') }}</h6>
                        <p>{{ audit.conclusion|nl2br }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            {# Action Buttons #}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0"><i class="bi bi-tools" aria-hidden="true"></i> {{ 'common.actions'|trans({}, 'messages') }}</h3>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if is_granted('ROLE_USER') %}
                        <a href="{{ path('app_audit_edit', {id: audit.id}) }}"
                           class="btn btn-primary"
                           data-turbo-action="advance">
                            <i class="bi bi-pencil" aria-hidden="true"></i> {{ 'common.edit'|trans({}, 'messages') }}
                        </a>
                        {% endif %}

                        <a href="{{ path('app_audit_export_pdf', {id: audit.id}) }}"
                           class="btn btn-outline-danger"
                           data-turbo="false">
                            <i class="bi bi-file-pdf" aria-hidden="true"></i> {{ 'audit.export_pdf'|trans({}, 'audit') }}
                        </a>

                        <a href="{{ path('app_audit_index') }}"
                           class="btn btn-outline-secondary"
                           data-turbo-action="advance">
                            <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'common.back_to_list'|trans({}, 'messages') }}
                        </a>

                        {% if is_granted('ROLE_ADMIN') %}
                        <hr>
                        <button type="button"
                                class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal">
                            <i class="bi bi-trash" aria-hidden="true"></i> {{ 'common.delete'|trans({}, 'messages') }}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Quick Stats #}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0"><i class="bi bi-bar-chart" aria-hidden="true"></i> {{ 'audit.quick_stats'|trans({}, 'audit') }}</h3>
                </div>
                <div class="card-body">
                    <dl class="row mb-0 small">
                        <dt class="col-sm-6 text-muted">{{ 'audit.field.scoped_framework'|trans({}, 'audit') }}</dt>
                        <dd class="col-sm-6 text-end">
                            {% if audit.scopedFramework %}
                                <span class="badge bg-primary">{{ audit.scopedFramework.name }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-6 text-muted">{{ 'audit.scope_type'|trans({}, 'audit') }}</dt>
                        <dd class="col-sm-6 text-end">
                            <span class="badge bg-secondary">{{ ('audit.scope_type.' ~ audit.scopeType)|trans({}, 'audit') }}</span>
                        </dd>

                        {% if audit.reportDate %}
                        <dt class="col-sm-6 text-muted">{{ 'audit.report_date'|trans({}, 'audit') }}</dt>
                        <dd class="col-sm-6 text-end">{{ audit.reportDate|date('d.m.Y') }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            {# Metadata #}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h3 class="mb-0"><i class="bi bi-info-circle" aria-hidden="true"></i> {{ 'common.metadata'|trans({}, 'messages') }}</h3>
                </div>
                <div class="card-body">
                    <dl class="row mb-0 small">
                        <dt class="col-sm-5 text-muted">{{ 'common.created_at'|trans({}, 'messages') }}</dt>
                        <dd class="col-sm-7">{{ audit.createdAt|date('d.m.Y H:i') }}</dd>

                        {% if audit.updatedAt %}
                        <dt class="col-sm-5 text-muted">{{ 'common.updated_at'|trans({}, 'messages') }}</dt>
                        <dd class="col-sm-7">{{ audit.updatedAt|date('d.m.Y H:i') }}</dd>
                        {% endif %}

                        <dt class="col-sm-5 text-muted">{{ 'common.id'|trans({}, 'messages') }}</dt>
                        <dd class="col-sm-7"><code>{{ audit.id }}</code></dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

{# Audit Log History #}
{% if auditLogs is defined and auditLogs|length > 0 %}
<div class="container-fluid py-4">
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h3 class="mb-0">
                <i class="bi bi-clock-history" aria-hidden="true"></i> {{ 'audit.section.history'|trans({}, 'audit') }}
                ({{ totalAuditLogs }} {{ 'audit_log.entries'|trans({}, 'audit_log') }})
            </h3>
        </div>
        <div class="card-body">
            <div class="audit-log-list">
                {% for log in auditLogs %}
                <div class="audit-log-entry">
                    <div class="audit-log-header">
                        <span class="{{ badge_action(log.action) }}">
                            {{ log.action|upper }}
                        </span>
                        <span class="text-muted">
                            {{ log.userName }}
                            &bull; {{ log.createdAt|date('Y-m-d H:i:s') }}
                        </span>
                    </div>
                    {% if log.action == 'update' %}
                        {% set oldValues = log.oldValuesArray %}
                        {% set newValues = log.newValuesArray %}
                        {% if oldValues and newValues %}
                            <div class="audit-log-changes">
                                {% for field, newValue in newValues %}
                                    {% if oldValues[field] is defined and oldValues[field] != newValue %}
                                        <div class="change-item">
                                            <strong>{{ field }}:</strong>
                                            <span class="text-danger">
                                                {{ oldValues[field]|length > 100 ? oldValues[field]|slice(0, 100) ~ '...' : oldValues[field] }}
                                            </span>
                                            &rarr;
                                            <span class="text-success">
                                                {{ newValue|length > 100 ? newValue|slice(0, 100) ~ '...' : newValue }}
                                            </span>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% if totalAuditLogs > 10 %}
            <div class="text-center mt-3">
                <small class="text-muted">
                    {{ 'audit_log.showing_recent'|trans({'%count%': 10, '%total%': totalAuditLogs}, 'audit') }}
                </small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.audit-log-entry {
    border-left: 3px solid var(--color-border);
    padding-left: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.audit-log-header {
    margin-bottom: var(--spacing-xs);
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
}

.audit-log-changes {
    font-size: 0.875rem;
    margin-top: var(--spacing-xs);
}

.change-item {
    margin-bottom: var(--spacing-xs);
}
</style>
{% endif %}

{# Delete Confirmation Modal #}
{% if is_granted('ROLE_ADMIN') %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> {{ 'audit.confirm_delete'|trans({}, 'audit') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{{ 'audit.delete_warning'|trans({'%title%': audit.title}, 'audit') }}</p>
                <p class="text-muted"><small>{{ 'common.action_irreversible'|trans({}, 'messages') }}</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {{ 'common.cancel'|trans({}, 'messages') }}
                </button>
                <form method="post" action="{{ path('app_audit_delete', {id: audit.id}) }}" style="display: inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ audit.id) }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash" aria-hidden="true"></i> {{ 'common.delete'|trans({}, 'messages') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
