{% extends 'base.html.twig' %}

{% block title %}{{ audit.title }} - {{ parent() }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ path('app_audit_index') }}" data-turbo-action="advance">
                    <i class="bi bi-clipboard-check"></i> {{ 'audit.title'|trans }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ audit.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            {# Main Audit Information #}
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-clipboard-check"></i> {{ audit.title }}
                    </h4>
                    {% set statusClass = {
                        'planned': 'info',
                        'in_progress': 'warning',
                        'completed': 'success',
                        'cancelled': 'danger'
                    } %}
                    <span class="badge bg-{{ statusClass[audit.status] ?? 'secondary' }} fs-6">
                        {{ ('audit.status.' ~ audit.status)|trans }}
                    </span>
                </div>
                <div class="card-body">
                    {# Scope #}
                    <div class="mb-4">
                        <h5><i class="bi bi-bullseye"></i> {{ 'audit.scope'|trans }}</h5>
                        <p class="text-muted">{{ audit.scope|nl2br }}</p>
                        <div class="mt-2">
                            <span class="badge bg-secondary me-2">
                                {{ ('audit.scope_type.' ~ audit.scopeType)|trans }}
                            </span>
                            <span class="badge bg-info">
                                {{ ('audit.type.' ~ audit.auditType)|trans }}
                            </span>
                        </div>

                        {# Corporate Audit Subsidiaries #}
                        {% if audit.auditedSubsidiaries|length > 0 %}
                        <div class="mt-3 p-3 border border-primary rounded bg-light">
                            <h6 class="text-primary mb-2">
                                <i class="bi bi-building"></i> {{ 'audit.field.audited_subsidiaries'|trans }}
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for subsidiary in audit.auditedSubsidiaries %}
                                <span class="badge bg-primary">
                                    {{ subsidiary.name }}
                                </span>
                                {% endfor %}
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle"></i>
                                Dieses Konzernaudit umfasst {{ audit.auditedSubsidiaries|length }} Tochtergesellschaft(en)
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    <hr>

                    {# Framework & Standard #}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-shield-check"></i> {{ 'audit.framework'|trans }}
                            </h6>
                            <p>
                                <span class="badge bg-primary fs-6">
                                    {{ audit.framework|upper }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">{{ 'audit.standard'|trans }}</h6>
                            <p>{{ audit.standard ?? '-' }}</p>
                        </div>
                    </div>

                    {# Dates #}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-calendar-event"></i> {{ 'audit.planned_date'|trans }}
                            </h6>
                            <p class="fs-5">{{ audit.plannedDate|date('d.m.Y') }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-calendar-check"></i> {{ 'audit.actual_date'|trans }}
                            </h6>
                            <p class="fs-5">{{ audit.actualDate ? audit.actualDate|date('d.m.Y') : '-' }}</p>
                        </div>
                    </div>

                    {# Team #}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-person-badge"></i> {{ 'audit.lead_auditor'|trans }}
                            </h6>
                            <p>
                                {% if audit.leadAuditor %}
                                {{ audit.leadAuditor.firstName }} {{ audit.leadAuditor.lastName }}
                                {% else %}
                                -
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">{{ 'audit.department'|trans }}</h6>
                            <p>{{ audit.department ?? '-' }}</p>
                        </div>
                    </div>

                    {# Auditee & Team #}
                    {% if audit.auditee %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-2">{{ 'audit.auditee'|trans }}</h6>
                        <p>{{ audit.auditee }}</p>
                    </div>
                    {% endif %}

                    {% if audit.auditTeam|length > 0 %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-2">
                            <i class="bi bi-people"></i> {{ 'audit.audit_team'|trans }}
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for member in audit.auditTeam %}
                            <span class="badge bg-light text-dark border">
                                {{ member.firstName }} {{ member.lastName }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {# Overall Result #}
                    {% if audit.overallResult %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-2">{{ 'audit.overall_result'|trans }}</h6>
                        <p>
                            {% set resultClass = {
                                'passed': 'success',
                                'passed_with_observations': 'info',
                                'failed': 'danger',
                                'not_applicable': 'secondary'
                            } %}
                            <span class="badge bg-{{ resultClass[audit.overallResult] ?? 'secondary' }} fs-6">
                                {{ ('audit.result.' ~ audit.overallResult)|trans }}
                            </span>
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# Objectives & Criteria #}
            {% if audit.objectives or audit.auditCriteria or audit.methodology %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-bullseye"></i> {{ 'audit.section.objectives'|trans }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if audit.objectives %}
                    <div class="mb-3">
                        <h6 class="text-muted">{{ 'audit.objectives'|trans }}</h6>
                        <p>{{ audit.objectives|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.auditCriteria %}
                    <div class="mb-3">
                        <h6 class="text-muted">{{ 'audit.audit_criteria'|trans }}</h6>
                        <p>{{ audit.auditCriteria|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.methodology %}
                    <div class="mb-0">
                        <h6 class="text-muted">{{ 'audit.methodology'|trans }}</h6>
                        <p>{{ audit.methodology|nl2br }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Findings #}
            {% if audit.findings or audit.nonconformities or audit.observations %}
            <div class="card shadow mb-4 border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i> {{ 'audit.section.findings'|trans }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if audit.findings %}
                    <div class="mb-3">
                        <h6 class="text-muted">{{ 'audit.findings'|trans }}</h6>
                        <p>{{ audit.findings|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.nonconformities %}
                    <div class="mb-3 alert alert-danger">
                        <h6 class="alert-heading">{{ 'audit.nonconformities'|trans }}</h6>
                        <p class="mb-0">{{ audit.nonconformities|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.observations %}
                    <div class="mb-0 alert alert-info">
                        <h6 class="alert-heading">{{ 'audit.observations'|trans }}</h6>
                        <p class="mb-0">{{ audit.observations|nl2br }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Recommendations & Actions #}
            {% if audit.recommendations or audit.correctiveActions or audit.followUpActions %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-lightbulb"></i> {{ 'audit.section.recommendations'|trans }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if audit.recommendations %}
                    <div class="mb-3">
                        <h6 class="text-muted">{{ 'audit.recommendations'|trans }}</h6>
                        <p>{{ audit.recommendations|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.correctiveActions %}
                    <div class="mb-3">
                        <h6 class="text-muted">{{ 'audit.corrective_actions'|trans }}</h6>
                        <p>{{ audit.correctiveActions|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.followUpActions %}
                    <div class="mb-0">
                        <h6 class="text-muted">{{ 'audit.follow_up_actions'|trans }}</h6>
                        <p>{{ audit.followUpActions|nl2br }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Documentation #}
            {% if audit.evidenceCollected or audit.summary or audit.notes %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-text"></i> {{ 'audit.section.documentation'|trans }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if audit.evidenceCollected %}
                    <div class="mb-3">
                        <h6 class="text-muted">{{ 'audit.evidence_collected'|trans }}</h6>
                        <p>{{ audit.evidenceCollected|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.summary %}
                    <div class="mb-3">
                        <h6 class="text-muted">{{ 'audit.summary'|trans }}</h6>
                        <p>{{ audit.summary|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if audit.notes %}
                    <div class="mb-0">
                        <h6 class="text-muted">{{ 'audit.notes'|trans }}</h6>
                        <p>{{ audit.notes|nl2br }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            {# Action Buttons #}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-tools"></i> {{ 'common.actions'|trans }}</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if is_granted('ROLE_USER') %}
                        <a href="{{ path('app_audit_edit', {id: audit.id}) }}"
                           class="btn btn-primary"
                           data-turbo-action="advance">
                            <i class="bi bi-pencil"></i> {{ 'common.edit'|trans }}
                        </a>
                        {% endif %}

                        <a href="{{ path('app_audit_export_pdf', {id: audit.id}) }}"
                           class="btn btn-outline-danger"
                           data-turbo="false">
                            <i class="bi bi-file-pdf"></i> {{ 'audit.export_pdf'|trans }}
                        </a>

                        <a href="{{ path('app_audit_index') }}"
                           class="btn btn-outline-secondary"
                           data-turbo-action="advance">
                            <i class="bi bi-arrow-left"></i> {{ 'common.back_to_list'|trans }}
                        </a>

                        {% if is_granted('ROLE_ADMIN') %}
                        <hr>
                        <button type="button"
                                class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal">
                            <i class="bi bi-trash"></i> {{ 'common.delete'|trans }}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Quick Stats #}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> {{ 'audit.quick_stats'|trans }}</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0 small">
                        <dt class="col-sm-6 text-muted">{{ 'audit.framework'|trans }}</dt>
                        <dd class="col-sm-6 text-end">
                            <span class="badge bg-primary">{{ audit.framework|upper }}</span>
                        </dd>

                        <dt class="col-sm-6 text-muted">{{ 'audit.type'|trans }}</dt>
                        <dd class="col-sm-6 text-end">
                            <span class="badge bg-info">{{ ('audit.type.' ~ audit.auditType)|trans }}</span>
                        </dd>

                        <dt class="col-sm-6 text-muted">{{ 'audit.team_size'|trans }}</dt>
                        <dd class="col-sm-6 text-end">{{ audit.auditTeam|length + 1 }}</dd>

                        {% if audit.overallResult %}
                        <dt class="col-sm-6 text-muted">{{ 'audit.result'|trans }}</dt>
                        <dd class="col-sm-6 text-end">
                            {% set resultClass = {
                                'passed': 'success',
                                'passed_with_observations': 'info',
                                'failed': 'danger',
                                'not_applicable': 'secondary'
                            } %}
                            <span class="badge bg-{{ resultClass[audit.overallResult] ?? 'secondary' }}">
                                {{ ('audit.result.' ~ audit.overallResult)|trans }}
                            </span>
                        </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            {# Metadata #}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> {{ 'common.metadata'|trans }}</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0 small">
                        <dt class="col-sm-5 text-muted">{{ 'common.created_at'|trans }}</dt>
                        <dd class="col-sm-7">{{ audit.createdAt|date('d.m.Y H:i') }}</dd>

                        <dt class="col-sm-5 text-muted">{{ 'common.updated_at'|trans }}</dt>
                        <dd class="col-sm-7">{{ audit.updatedAt|date('d.m.Y H:i') }}</dd>

                        <dt class="col-sm-5 text-muted">{{ 'common.id'|trans }}</dt>
                        <dd class="col-sm-7"><code>{{ audit.id }}</code></dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

{# Audit Log History #}
{% if auditLogs is defined and auditLogs|length > 0 %}
<div class="container-fluid py-4">
    <div class="card shadow mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-clock-history"></i> {{ 'audit.section.history'|trans }}
                ({{ totalAuditLogs }} {{ 'audit_log.entries'|trans }})
            </h5>
        </div>
        <div class="card-body">
            <div class="audit-log-list">
                {% for log in auditLogs %}
                <div class="audit-log-entry">
                    <div class="audit-log-header">
                        <span class="badge bg-{{ log.action == 'create' ? 'success' : (log.action == 'update' ? 'info' : 'danger') }}">
                            {{ log.action|upper }}
                        </span>
                        <span class="text-muted">
                            {{ log.userName }}
                            &bull; {{ log.createdAt|date('Y-m-d H:i:s') }}
                        </span>
                    </div>
                    {% if log.action == 'update' %}
                        {% set oldValues = log.oldValuesArray %}
                        {% set newValues = log.newValuesArray %}
                        {% if oldValues and newValues %}
                            <div class="audit-log-changes">
                                {% for field, newValue in newValues %}
                                    {% if oldValues[field] is defined and oldValues[field] != newValue %}
                                        <div class="change-item">
                                            <strong>{{ field }}:</strong>
                                            <span class="text-danger">
                                                {{ oldValues[field]|length > 100 ? oldValues[field]|slice(0, 100) ~ '...' : oldValues[field] }}
                                            </span>
                                            &rarr;
                                            <span class="text-success">
                                                {{ newValue|length > 100 ? newValue|slice(0, 100) ~ '...' : newValue }}
                                            </span>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% if totalAuditLogs > 10 %}
            <div class="text-center mt-3">
                <small class="text-muted">
                    {{ 'audit_log.showing_recent'|trans({'%count%': 10, '%total%': totalAuditLogs}) }}
                </small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.audit-log-entry {
    border-left: 3px solid var(--color-border);
    padding-left: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.audit-log-header {
    margin-bottom: var(--spacing-xs);
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
}

.audit-log-changes {
    font-size: 0.875rem;
    margin-top: var(--spacing-xs);
}

.change-item {
    margin-bottom: var(--spacing-xs);
}
</style>
{% endif %}

{# Delete Confirmation Modal #}
{% if is_granted('ROLE_ADMIN') %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> {{ 'audit.confirm_delete'|trans }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{{ 'audit.delete_warning'|trans({'%title%': audit.title}) }}</p>
                <p class="text-muted"><small>{{ 'common.action_irreversible'|trans }}</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {{ 'common.cancel'|trans }}
                </button>
                <form method="post" action="{{ path('app_audit_delete', {id: audit.id}) }}" style="display: inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ audit.id) }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> {{ 'common.delete'|trans }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
