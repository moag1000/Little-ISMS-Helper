{#
    Audit Form Partial (Accessible)
    Used by both new.html.twig and edit.html.twig
    WCAG 2.1 AA Compliant
#}

{# ISO 27001 Information Banner #}
<div class="alert alert-info mb-4" role="status">
    <h6 class="alert-heading">
        <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
        {{ 'audit.iso_27001_requirement' }}
    </h5>
    <p class="mb-0 small">
        {{ 'audit.iso_27001_clause_info' }}
    </p>
</div>

{# Basic Information #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-info-square" aria-hidden="true"></i>
            {{ 'audit.section.basic_info' }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.title,
                    'label_key': 'audit.field.title',
                    'help_key': 'audit.help.title',
                    'translation_domain': 'audits',
                    'required': true
                } %}
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.scope,
                    'label_key': 'audit.field.scope',
                    'help_key': 'audit.help.scope',
                    'translation_domain': 'audits',
                    'required': true
                } %}
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.scopeType,
                    'label_key': 'audit.field.scope_type',
                    'help_key': 'audit.help.scope_type',
                    'translation_domain': 'audits'
                } %}
            </div>

            {% if form.scopedFramework is defined %}
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.scopedFramework,
                    'label_key': 'audit.field.scoped_framework',
                    'help_key': 'audit.help.scoped_framework',
                    'translation_domain': 'audits'
                } %}
            </div>
            {% endif %}

            {% if form.auditType is defined %}
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.auditType,
                    'label_key': 'audit.field.audit_type',
                    'help_key': 'audit.help.audit_type'
                } %}
            </div>
            {% endif %}
        </div>

        {# Corporate Subsidiaries (conditional) #}
        {% if form.auditedSubsidiaries is defined %}
        <div id="subsidiaries-container" style="display: none;">
            <div class="alert alert-info" role="status">
                <i class="bi bi-info-circle" aria-hidden="true"></i>
                <strong>{{ 'audit.corporate_audit_note_title' }}:</strong>
                {{ 'audit.corporate_audit_note' }}
            </div>
            {% include '_components/_form_field.html.twig' with {
                'field': form.auditedSubsidiaries,
                'label': 'audit.field.audited_subsidiaries',
                'help_key': 'audit.help.audited_subsidiaries'
            } %}
        </div>
        {% endif %}
    </div>
</fieldset>

{# Framework & Standards (Edit mode only) #}
{% if is_edit_mode|default(false) and form.framework is defined %}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-shield-check" aria-hidden="true"></i>
            {{ 'audit.section.frameworks' }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.framework,
                    'label_key': 'audit.field.framework',
                    'help_key': 'audit.help.framework'
                } %}
            </div>

            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.standard,
                    'label_key': 'audit.field.standard',
                    'help_key': 'audit.help.standard'
                } %}
            </div>
        </div>
    </div>
</fieldset>
{% endif %}

{# Schedule #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-calendar-event" aria-hidden="true"></i>
            {{ 'audit.section.schedule' }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.plannedDate,
                    'label_key': 'audit.field.planned_date',
                    'help_key': 'audit.help.planned_date'
                } %}
            </div>

            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.actualDate,
                    'label_key': 'audit.field.actual_date',
                    'help_key': 'audit.help.actual_date'
                } %}
            </div>
        </div>
    </div>
</fieldset>

{# Team & Responsibilities #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-people" aria-hidden="true"></i>
            {{ 'audit.section.team' }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.leadAuditor,
                    'label_key': 'audit.field.lead_auditor',
                    'help_key': 'audit.help.lead_auditor'
                } %}
            </div>

            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.auditTeam,
                    'label_key': 'audit.field.audit_team',
                    'help_key': 'audit.help.audit_team'
                } %}
            </div>

            {% if form.auditee is defined %}
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.auditee,
                    'label_key': 'audit.field.auditee',
                    'help_key': 'audit.help.auditee'
                } %}
            </div>
            {% endif %}

            {% if form.department is defined %}
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.department,
                    'label_key': 'audit.field.department',
                    'help_key': 'audit.help.department'
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>

{# Status & Results (if in form) #}
{% if form.status is defined %}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-flag" aria-hidden="true"></i>
            {{ 'audit.section.status' }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.status,
                    'label_key': 'audit.field.status',
                    'help_key': 'audit.help.status'
                } %}
            </div>

            {% if form.overallResult is defined %}
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.overallResult,
                    'label_key': 'audit.field.overall_result',
                    'help_key': 'audit.help.overall_result'
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>
{% endif %}

{# Objectives & Criteria #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-bullseye" aria-hidden="true"></i>
            {{ 'audit.section.objectives' }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.objectives,
                    'label_key': 'audit.field.objectives',
                    'help_key': 'audit.help.objectives'
                } %}
            </div>

            {% if form.auditCriteria is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.auditCriteria,
                    'label_key': 'audit.field.audit_criteria',
                    'help_key': 'audit.help.audit_criteria'
                } %}
            </div>
            {% endif %}

            {% if form.methodology is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.methodology,
                    'label_key': 'audit.field.methodology',
                    'help_key': 'audit.help.methodology'
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>

{# Findings #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
            {{ 'audit.section.findings' }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.findings,
                    'label_key': 'audit.field.findings',
                    'help_key': 'audit.help.findings'
                } %}
            </div>

            {% if form.nonconformities is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.nonconformities,
                    'label_key': 'audit.field.nonconformities',
                    'help_key': 'audit.help.nonconformities'
                } %}
            </div>
            {% endif %}

            {% if form.observations is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.observations,
                    'label_key': 'audit.field.observations',
                    'help_key': 'audit.help.observations'
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>

{# Recommendations & Follow-up #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-lightbulb" aria-hidden="true"></i>
            {{ 'audit.section.recommendations' }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.recommendations,
                    'label_key': 'audit.field.recommendations',
                    'help_key': 'audit.help.recommendations'
                } %}
            </div>

            {% if form.correctiveActions is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.correctiveActions,
                    'label_key': 'audit.field.corrective_actions',
                    'help_key': 'audit.help.corrective_actions'
                } %}
            </div>
            {% endif %}

            {% if form.followUpActions is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.followUpActions,
                    'label_key': 'audit.field.follow_up_actions',
                    'help_key': 'audit.help.follow_up_actions'
                } %}
            </div>
            {% endif %}

            {% if form.conclusion is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.conclusion,
                    'label_key': 'audit.field.conclusion',
                    'help_key': 'audit.help.conclusion'
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>

{# Documentation (Edit mode only) #}
{% if is_edit_mode|default(false) and form.evidenceCollected is defined %}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-file-earmark-text" aria-hidden="true"></i>
            {{ 'audit.section.documentation' }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.evidenceCollected,
                    'label_key': 'audit.field.evidence_collected',
                    'help_key': 'audit.help.evidence_collected'
                } %}
            </div>

            {% if form.summary is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.summary,
                    'label_key': 'audit.field.summary',
                    'help_key': 'audit.help.summary'
                } %}
            </div>
            {% endif %}

            {% if form.notes is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.notes,
                    'label_key': 'audit.field.notes',
                    'help_key': 'audit.help.notes'
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>
{% endif %}

{# Form Actions #}
<div class="form-actions d-flex gap-2 {% if is_edit_mode|default(false) %}justify-content-between{% else %}justify-content-end{% endif %} pt-3 border-top">
    {% if is_edit_mode|default(false) %}
    <div>
        <a href="{{ path('app_audit_show', {id: audit.id}) }}"
           class="btn btn-outline-secondary"
           data-turbo-action="advance">
            <i class="bi bi-arrow-left" aria-hidden="true"></i>
            {{ 'common.back'|trans({}, 'messages') }}
        </a>
        <a href="{{ path('app_audit_index') }}"
           class="btn btn-outline-secondary"
           data-turbo-action="advance">
            <i class="bi bi-list" aria-hidden="true"></i>
            {{ 'common.to_list'|trans({}, 'messages') }}
        </a>
    </div>
    {% else %}
    <a href="{{ path('app_audit_index') }}"
       class="btn btn-outline-secondary"
       data-turbo-action="advance">
        <i class="bi bi-arrow-left" aria-hidden="true"></i>
        {{ 'common.back'|trans({}, 'messages') }}
    </a>
    {% endif %}

    <button type="submit" class="btn btn-primary btn-lg">
        <i class="{{ button_icon|default('bi-save') }}" aria-hidden="true"></i>
        {{ button_label|default('common.save'|trans({}, 'messages')) }}
    </button>
</div>

{# JavaScript for conditional subsidiaries field #}
{% if form.auditedSubsidiaries is defined %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scopeTypeSelect = document.querySelector('[data-corporate-scope]');
    const subsidiariesContainer = document.getElementById('subsidiaries-container');
    const subsidiariesSelect = document.querySelector('[data-corporate-subsidiaries]');

    if (!scopeTypeSelect || !subsidiariesContainer) {
        return; // Elements not found, exit
    }

    function toggleSubsidiariesField() {
        const selectedScope = scopeTypeSelect.value;
        const isCorporateScope = selectedScope === 'corporate_wide' || selectedScope === 'corporate_subsidiaries';

        if (isCorporateScope) {
            subsidiariesContainer.style.display = 'block';

            // Auto-select all for corporate_wide
            if (selectedScope === 'corporate_wide' && subsidiariesSelect) {
                for (let option of subsidiariesSelect.options) {
                    option.selected = true;
                }
            }
        } else {
            subsidiariesContainer.style.display = 'none';

            // Deselect all when hiding
            if (subsidiariesSelect) {
                for (let option of subsidiariesSelect.options) {
                    option.selected = false;
                }
            }
        }
    }

    // Initial check
    toggleSubsidiariesField();

    // Listen for changes
    scopeTypeSelect.addEventListener('change', toggleSubsidiariesField);
});
</script>
{% endif %}
