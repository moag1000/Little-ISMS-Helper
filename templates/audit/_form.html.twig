{#
    Audit Form Partial (Accessible)
    Used by both new.html.twig and edit.html.twig
    WCAG 2.1 AA Compliant
#}

{# ISO 27001 Information Banner #}
<div class="alert alert-info mb-4" role="status">
    <h6 class="alert-heading">
        <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
        {{ 'audit.iso_27001_requirement'|trans({}, 'audits')|default('ISO 27001 Anforderung') }}
    </h6>
    <p class="mb-0 small">
        {{ 'audit.iso_27001_clause_info'|trans({}, 'audits')|default('Gemäß ISO 27001:2022 Klausel 9.2 müssen interne Audits in geplanten Abständen durchgeführt werden') }}
    </p>
</div>

{# Basic Information #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-info-square" aria-hidden="true"></i>
            {{ 'audit.section.basic_info'|trans({}, 'audits')|default('Grundinformationen') }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.title,
                    'label': 'audit.field.title'|trans({}, 'audits')|default('Audit-Titel'),
                    'help': 'audit.help.title'|trans({}, 'audits')|default('Kurzer, prägnanter Titel des Audits'),
                    'required': true
                } %}
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.scope,
                    'label': 'audit.field.scope'|trans({}, 'audits')|default('Geltungsbereich'),
                    'help': 'audit.help.scope'|trans({}, 'audits')|default('Definieren Sie den Umfang des Audits'),
                    'required': true
                } %}
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.scopeType,
                    'label': 'audit.field.scope_type'|trans({}, 'audits')|default('Geltungsbereich-Typ'),
                    'help': 'audit.help.scope_type'|trans({}, 'audits')|default('Art des Audit-Geltungsbereichs')
                } %}
            </div>

            {% if form.scopedFramework is defined %}
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.scopedFramework,
                    'label': 'audit.field.scoped_framework'|trans({}, 'audits')|default('Framework'),
                    'help': 'audit.help.scoped_framework'|trans({}, 'audits')|default('Verwendetes Audit-Framework')
                } %}
            </div>
            {% endif %}

            {% if form.auditType is defined %}
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.auditType,
                    'label': 'audit.field.audit_type'|trans({}, 'audits')|default('Audit-Typ'),
                    'help': 'audit.help.audit_type'|trans({}, 'audits')|default('Art des Audits')
                } %}
            </div>
            {% endif %}
        </div>

        {# Corporate Subsidiaries (conditional) #}
        {% if form.auditedSubsidiaries is defined %}
        <div id="subsidiaries-container" style="display: none;">
            <div class="alert alert-info" role="status">
                <i class="bi bi-info-circle" aria-hidden="true"></i>
                <strong>{{ 'audit.corporate_audit_note_title'|trans({}, 'audits')|default('Konzernaudit') }}:</strong>
                {{ 'audit.corporate_audit_note'|trans({}, 'audits')|default('Wählen Sie die Tochtergesellschaften aus, die in dieses Audit einbezogen werden sollen. Bei "Konzernweites Audit" sollten alle relevanten Tochtergesellschaften ausgewählt werden.') }}
            </div>
            {% include '_components/_form_field.html.twig' with {
                'field': form.auditedSubsidiaries,
                'label': 'audit.field.audited_subsidiaries'|trans({}, 'audits')|default('Auditierte Tochtergesellschaften'),
                'help': 'audit.help.audited_subsidiaries'|trans({}, 'audits')|default('Tochtergesellschaften, die in dieses Audit einbezogen werden')
            } %}
        </div>
        {% endif %}
    </div>
</fieldset>

{# Framework & Standards (Edit mode only) #}
{% if is_edit_mode|default(false) and form.framework is defined %}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-shield-check" aria-hidden="true"></i>
            {{ 'audit.section.frameworks'|trans({}, 'audits')|default('Frameworks & Standards') }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.framework,
                    'label': 'audit.field.framework'|trans({}, 'audits')|default('Framework'),
                    'help': 'audit.help.framework'|trans({}, 'audits')|default('Verwendetes Compliance-Framework')
                } %}
            </div>

            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.standard,
                    'label': 'audit.field.standard'|trans({}, 'audits')|default('Standard'),
                    'help': 'audit.help.standard'|trans({}, 'audits')|default('Anwendbarer Standard')
                } %}
            </div>
        </div>
    </div>
</fieldset>
{% endif %}

{# Schedule #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-calendar-event" aria-hidden="true"></i>
            {{ 'audit.section.schedule'|trans({}, 'audits')|default('Zeitplan') }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.plannedDate,
                    'label': 'audit.field.planned_date'|trans({}, 'audits')|default('Geplantes Datum'),
                    'help': 'audit.help.planned_date'|trans({}, 'audits')|default('Geplantes Datum für das Audit')
                } %}
            </div>

            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.actualDate,
                    'label': 'audit.field.actual_date'|trans({}, 'audits')|default('Tatsächliches Datum'),
                    'help': 'audit.help.actual_date'|trans({}, 'audits')|default('Tatsächliches Durchführungsdatum')
                } %}
            </div>
        </div>
    </div>
</fieldset>

{# Team & Responsibilities #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-people" aria-hidden="true"></i>
            {{ 'audit.section.team'|trans({}, 'audits')|default('Team & Verantwortlichkeiten') }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.leadAuditor,
                    'label': 'audit.field.lead_auditor'|trans({}, 'audits')|default('Leitender Auditor'),
                    'help': 'audit.help.lead_auditor'|trans({}, 'audits')|default('Verantwortlicher Hauptauditor')
                } %}
            </div>

            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.auditTeam,
                    'label': 'audit.field.audit_team'|trans({}, 'audits')|default('Audit-Team'),
                    'help': 'audit.help.audit_team'|trans({}, 'audits')|default('Mitglieder des Audit-Teams')
                } %}
            </div>

            {% if form.auditee is defined %}
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.auditee,
                    'label': 'audit.field.auditee'|trans({}, 'audits')|default('Auditierter'),
                    'help': 'audit.help.auditee'|trans({}, 'audits')|default('Person oder Abteilung, die auditiert wird')
                } %}
            </div>
            {% endif %}

            {% if form.department is defined %}
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.department,
                    'label': 'audit.field.department'|trans({}, 'audits')|default('Abteilung'),
                    'help': 'audit.help.department'|trans({}, 'audits')|default('Betroffene Abteilung')
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>

{# Status & Results (if in form) #}
{% if form.status is defined %}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-flag" aria-hidden="true"></i>
            {{ 'audit.section.status'|trans({}, 'audits')|default('Status & Ergebnisse') }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.status,
                    'label': 'audit.field.status'|trans({}, 'audits')|default('Status'),
                    'help': 'audit.help.status'|trans({}, 'audits')|default('Aktueller Status des Audits')
                } %}
            </div>

            {% if form.overallResult is defined %}
            <div class="col-md-6">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.overallResult,
                    'label': 'audit.field.overall_result'|trans({}, 'audits')|default('Gesamtergebnis'),
                    'help': 'audit.help.overall_result'|trans({}, 'audits')|default('Zusammenfassendes Audit-Ergebnis')
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>
{% endif %}

{# Objectives & Criteria #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-bullseye" aria-hidden="true"></i>
            {{ 'audit.section.objectives'|trans({}, 'audits')|default('Ziele & Kriterien') }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.objectives,
                    'label': 'audit.field.objectives'|trans({}, 'audits')|default('Audit-Ziele'),
                    'help': 'audit.help.objectives'|trans({}, 'audits')|default('Definierte Ziele und Zweck des Audits')
                } %}
            </div>

            {% if form.auditCriteria is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.auditCriteria,
                    'label': 'audit.field.audit_criteria'|trans({}, 'audits')|default('Audit-Kriterien'),
                    'help': 'audit.help.audit_criteria'|trans({}, 'audits')|default('Kriterien für die Audit-Bewertung')
                } %}
            </div>
            {% endif %}

            {% if form.methodology is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.methodology,
                    'label': 'audit.field.methodology'|trans({}, 'audits')|default('Methodik'),
                    'help': 'audit.help.methodology'|trans({}, 'audits')|default('Angewandte Audit-Methodik')
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>

{# Findings #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
            {{ 'audit.section.findings'|trans({}, 'audits')|default('Feststellungen') }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.findings,
                    'label': 'audit.field.findings'|trans({}, 'audits')|default('Feststellungen'),
                    'help': 'audit.help.findings'|trans({}, 'audits')|default('Identifizierte Feststellungen und Probleme')
                } %}
            </div>

            {% if form.nonconformities is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.nonconformities,
                    'label': 'audit.field.nonconformities'|trans({}, 'audits')|default('Nichtkonformitäten'),
                    'help': 'audit.help.nonconformities'|trans({}, 'audits')|default('Identifizierte Nichtkonformitäten')
                } %}
            </div>
            {% endif %}

            {% if form.observations is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.observations,
                    'label': 'audit.field.observations'|trans({}, 'audits')|default('Beobachtungen'),
                    'help': 'audit.help.observations'|trans({}, 'audits')|default('Weitere Beobachtungen')
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>

{# Recommendations & Follow-up #}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-lightbulb" aria-hidden="true"></i>
            {{ 'audit.section.recommendations'|trans({}, 'audits')|default('Empfehlungen & Nachverfolgung') }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.recommendations,
                    'label': 'audit.field.recommendations'|trans({}, 'audits')|default('Empfehlungen'),
                    'help': 'audit.help.recommendations'|trans({}, 'audits')|default('Empfohlene Maßnahmen')
                } %}
            </div>

            {% if form.correctiveActions is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.correctiveActions,
                    'label': 'audit.field.corrective_actions'|trans({}, 'audits')|default('Korrekturmaßnahmen'),
                    'help': 'audit.help.corrective_actions'|trans({}, 'audits')|default('Geplante Korrekturmaßnahmen')
                } %}
            </div>
            {% endif %}

            {% if form.followUpActions is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.followUpActions,
                    'label': 'audit.field.follow_up_actions'|trans({}, 'audits')|default('Nachverfolgungsmaßnahmen'),
                    'help': 'audit.help.follow_up_actions'|trans({}, 'audits')|default('Geplante Nachverfolgungsaktivitäten')
                } %}
            </div>
            {% endif %}

            {% if form.conclusion is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.conclusion,
                    'label': 'audit.field.conclusion'|trans({}, 'audits')|default('Schlussfolgerung'),
                    'help': 'audit.help.conclusion'|trans({}, 'audits')|default('Gesamtschlussfolgerung des Audits')
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>

{# Documentation (Edit mode only) #}
{% if is_edit_mode|default(false) and form.evidenceCollected is defined %}
<fieldset class="card mb-4">
    <div class="card-header bg-light">
        <legend class="h5 mb-0">
            <i class="bi bi-file-earmark-text" aria-hidden="true"></i>
            {{ 'audit.section.documentation'|trans({}, 'audits')|default('Dokumentation') }}
        </legend>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.evidenceCollected,
                    'label': 'audit.field.evidence_collected'|trans({}, 'audits')|default('Gesammelte Nachweise'),
                    'help': 'audit.help.evidence_collected'|trans({}, 'audits')|default('Während des Audits gesammelte Nachweise')
                } %}
            </div>

            {% if form.summary is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.summary,
                    'label': 'audit.field.summary'|trans({}, 'audits')|default('Zusammenfassung'),
                    'help': 'audit.help.summary'|trans({}, 'audits')|default('Zusammenfassung des Audits')
                } %}
            </div>
            {% endif %}

            {% if form.notes is defined %}
            <div class="col-12">
                {% include '_components/_form_field.html.twig' with {
                    'field': form.notes,
                    'label': 'audit.field.notes'|trans({}, 'audits')|default('Notizen'),
                    'help': 'audit.help.notes'|trans({}, 'audits')|default('Zusätzliche Notizen')
                } %}
            </div>
            {% endif %}
        </div>
    </div>
</fieldset>
{% endif %}

{# Form Actions #}
<div class="form-actions d-flex gap-2 {% if is_edit_mode|default(false) %}justify-content-between{% else %}justify-content-end{% endif %} pt-3 border-top">
    {% if is_edit_mode|default(false) %}
    <div>
        <a href="{{ path('app_audit_show', {id: audit.id}) }}"
           class="btn btn-outline-secondary"
           data-turbo-action="advance">
            <i class="bi bi-arrow-left" aria-hidden="true"></i>
            {{ 'common.back'|trans({}, 'messages') }}
        </a>
        <a href="{{ path('app_audit_index') }}"
           class="btn btn-outline-secondary"
           data-turbo-action="advance">
            <i class="bi bi-list" aria-hidden="true"></i>
            {{ 'common.to_list'|trans({}, 'messages') }}
        </a>
    </div>
    {% else %}
    <a href="{{ path('app_audit_index') }}"
       class="btn btn-outline-secondary"
       data-turbo-action="advance">
        <i class="bi bi-arrow-left" aria-hidden="true"></i>
        {{ 'common.back'|trans({}, 'messages') }}
    </a>
    {% endif %}

    <button type="submit" class="btn btn-primary btn-lg">
        <i class="{{ button_icon|default('bi-save') }}" aria-hidden="true"></i>
        {{ button_label|default('common.save'|trans({}, 'messages')) }}
    </button>
</div>

{# JavaScript for conditional subsidiaries field #}
{% if form.auditedSubsidiaries is defined %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scopeTypeSelect = document.querySelector('[data-corporate-scope]');
    const subsidiariesContainer = document.getElementById('subsidiaries-container');
    const subsidiariesSelect = document.querySelector('[data-corporate-subsidiaries]');

    if (!scopeTypeSelect || !subsidiariesContainer) {
        return; // Elements not found, exit
    }

    function toggleSubsidiariesField() {
        const selectedScope = scopeTypeSelect.value;
        const isCorporateScope = selectedScope === 'corporate_wide' || selectedScope === 'corporate_subsidiaries';

        if (isCorporateScope) {
            subsidiariesContainer.style.display = 'block';

            // Auto-select all for corporate_wide
            if (selectedScope === 'corporate_wide' && subsidiariesSelect) {
                for (let option of subsidiariesSelect.options) {
                    option.selected = true;
                }
            }
        } else {
            subsidiariesContainer.style.display = 'none';

            // Deselect all when hiding
            if (subsidiariesSelect) {
                for (let option of subsidiariesSelect.options) {
                    option.selected = false;
                }
            }
        }
    }

    // Initial check
    toggleSubsidiariesField();

    // Listen for changes
    scopeTypeSelect.addEventListener('change', toggleSubsidiariesField);
});
</script>
{% endif %}
