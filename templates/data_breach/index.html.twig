{% extends 'base.html.twig' %}
{% trans_default_domain 'privacy' %}

{% block title %}{{ 'privacy.data_breach.management'|trans }}{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'privacy.breadcrumb.privacy'|trans, icon: 'bi-shield-lock' },
            { label: 'privacy.breadcrumb.data_breaches'|trans }
        ]
    } %}

    {% include '_components/_page_header.html.twig' with {
        title: 'privacy.data_breach.management'|trans,
        subtitle: 'privacy.data_breach.subtitle'|trans,
        icon: 'bi-exclamation-triangle-fill',
        actions: [
            { label: 'privacy.data_breach.actions.dashboard'|trans, url: path('app_data_breach_dashboard'), variant: 'primary', icon: 'bi-speedometer2' },
            { label: 'privacy.data_breach.actions.new'|trans, url: path('app_data_breach_new'), variant: 'danger', icon: 'bi-plus-lg' }
        ]
    } %}

    {# CRITICAL: Overdue Notifications Alert #}
    {% if compliance_score.overdue_notifications > 0 %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> {{ 'privacy.data_breach.alert.overdue_title'|trans }}</h5>
            <p>{{ 'privacy.data_breach.alert.overdue_text'|trans({'%count%': compliance_score.overdue_notifications})|raw }}</p>
            <hr>
            <p class="mb-0">
                <a href="{{ path('app_data_breach_index', {filter: 'overdue'}) }}" class="alert-link">
                    {{ 'privacy.data_breach.alert.view_overdue'|trans }}
                </a>
            </p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endif %}

    {# Overall Compliance Score #}
    <div class="card mb-4 text-center">
        <div class="card-body">
            <h6 class="text-muted mb-2">{{ 'privacy.data_breach.score.heading'|trans }}</h6>
            {% set score = compliance_score.overall_score %}
            <h1 class="display-1 mb-0
                {% if score >= 80 %}text-success
                {% elseif score >= 60 %}text-warning
                {% else %}text-danger{% endif %}">
                {{ score }}%
            </h1>
            <div class="row mt-4">
                <div class="col-md-4">
                    <small class="text-muted">{{ 'privacy.data_breach.score.notification_compliance'|trans }}</small>
                    <h4>{{ compliance_score.notification_compliance }}%</h4>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">{{ 'privacy.data_breach.score.timeliness'|trans }}</small>
                    <h4 class="{% if compliance_score.timeliness_score < 80 %}text-danger{% else %}text-success{% endif %}">
                        {{ compliance_score.timeliness_score }}%
                    </h4>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">{{ 'privacy.data_breach.score.completeness'|trans }}</small>
                    <h4>{{ compliance_score.completeness_score }}%</h4>
                </div>
            </div>
            <p class="text-muted mt-3">
                {{ 'privacy.data_breach.score.summary'|trans({'%total%': statistics.total, '%subjects%': compliance_score.total_affected_subjects}) }}
            </p>
        </div>
    </div>

    {# Key Metrics #}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">{{ 'privacy.data_breach.kpi.total_breaches'|trans }}</h6>
                    <h2>{{ statistics.total }}</h2>
                    <div class="mt-2">
                        <small class="text-danger"><i class="bi bi-exclamation-triangle"></i> {{ statistics.high_risk + statistics.critical_risk }} {{ 'privacy.data_breach.kpi.high_critical_risk'|trans }}</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="text-muted">{{ 'privacy.data_breach.kpi.pending_authority'|trans }}</h6>
                    <h2 class="text-warning">{{ statistics.requires_authority_notification - statistics.authority_notified }}</h2>
                    <div class="mt-2">
                        <small class="text-muted"><i class="bi bi-clock"></i> {{ 'privacy.data_breach.kpi.deadline_72h'|trans }}</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">{{ 'privacy.data_breach.kpi.special_categories'|trans }}</h6>
                    <h2 class="text-info">{{ statistics.special_categories_affected }}</h2>
                    <div class="mt-2">
                        <small class="text-muted"><i class="bi bi-shield-lock"></i> {{ 'privacy.data_breach.kpi.art9_data'|trans }}</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Affected Subjects</h6>
                    <h2>{{ compliance_score.total_affected_subjects }}</h2>
                    <div class="mt-2">
                        <small class="text-muted"><i class="bi bi-people"></i> Total count</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Filters #}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-filter"></i> Filter Data Breaches</h5>
        </div>
        <div class="card-body">
            <div class="btn-group flex-wrap" role="group">
                <a href="{{ path('app_data_breach_index') }}"
                   class="btn btn-outline-primary {{ current_filter == 'all' ? 'active' : '' }}">
                    All ({{ statistics.total }})
                </a>
                <a href="{{ path('app_data_breach_index', {filter: 'overdue'}) }}"
                   class="btn btn-outline-danger {{ current_filter == 'overdue' ? 'active' : '' }}">
                    OVERDUE ({{ compliance_score.overdue_notifications }})
                </a>
                <a href="{{ path('app_data_breach_index', {filter: 'pending_authority'}) }}"
                   class="btn btn-outline-warning {{ current_filter == 'pending_authority' ? 'active' : '' }}">
                    Pending Authority
                </a>
                <a href="{{ path('app_data_breach_index', {filter: 'pending_subjects'}) }}"
                   class="btn btn-outline-warning {{ current_filter == 'pending_subjects' ? 'active' : '' }}">
                    Pending Subjects
                </a>
                <a href="{{ path('app_data_breach_index', {filter: 'draft'}) }}"
                   class="btn btn-outline-secondary {{ current_filter == 'draft' ? 'active' : '' }}">
                    Draft ({{ statistics.draft }})
                </a>
                <a href="{{ path('app_data_breach_index', {filter: 'under_assessment'}) }}"
                   class="btn btn-outline-info {{ current_filter == 'under_assessment' ? 'active' : '' }}">
                    Under Assessment ({{ statistics.under_assessment }})
                </a>
                <a href="{{ path('app_data_breach_index', {filter: 'authority_notified'}) }}"
                   class="btn btn-outline-success {{ current_filter == 'authority_notified' ? 'active' : '' }}">
                    Authority Notified ({{ statistics.authority_notified }})
                </a>
                <a href="{{ path('app_data_breach_index', {filter: 'closed'}) }}"
                   class="btn btn-outline-dark {{ current_filter == 'closed' ? 'active' : '' }}">
                    Closed ({{ statistics.closed }})
                </a>
            </div>
        </div>
    </div>

    {# Breaches Table #}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list-check"></i> Data Breaches ({{ breaches|length }})</h5>
        </div>
        <div class="card-body p-0">
            {% if breaches|length > 0 %}
                {% embed '_components/_table.html.twig' with {
                    'noMargin': true
                } %}
                    {% block table_head %}
                        <tr>
                            <th scope="col">Reference</th>
                            <th scope="col">Title</th>
                            <th scope="col">Status</th>
                            <th scope="col">Risk</th>
                            <th scope="col">Affected Subjects</th>
                            <th scope="col">72h Deadline</th>
                            <th scope="col">Authority</th>
                            <th scope="col">Subjects</th>
                            <th scope="col">Actions</th>
                        </tr>
                    {% endblock %}
                    {% block table_body %}
                        {% for breach in breaches %}
                            <tr class="{% if breach.isAuthorityNotificationOverdue %}table-danger{% endif %}">
                                <td>
                                    <a href="{{ path('app_data_breach_show', {id: breach.id}) }}">
                                        {{ breach.referenceNumber }}
                                    </a>
                                </td>
                                <td>{{ breach.title }}</td>
                                <td>
                                    {% set status_class = {
                                        'draft': 'secondary',
                                        'under_assessment': 'info',
                                        'authority_notified': 'success',
                                        'subjects_notified': 'success',
                                        'closed': 'dark'
                                    }[breach.status] %}
                                    <span class="badge bg-{{ status_class }}">
                                        {{ breach.status|replace({'_': ' '})|upper }}
                                    </span>
                                </td>
                                <td>
                                    {% if breach.riskLevel %}
                                        {% set risk_class = {
                                            'low': 'success',
                                            'medium': 'info',
                                            'high': 'warning',
                                            'critical': 'danger'
                                        }[breach.riskLevel] %}
                                        <span class="badge bg-{{ risk_class }}">
                                            {{ breach.riskLevel|upper }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if breach.affectedDataSubjects %}
                                        {{ breach.affectedDataSubjects|number_format }}
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if breach.requiresAuthorityNotification and not breach.supervisoryAuthorityNotifiedAt %}
                                        {% set hours = breach.hoursUntilAuthorityDeadline %}
                                        {% if hours < 0 %}
                                            <span class="badge bg-danger">
                                                OVERDUE {{ (hours * -1)|number_format }}h
                                            </span>
                                        {% elseif hours < 24 %}
                                            <span class="badge bg-warning text-dark">
                                                {{ hours|number_format }}h left
                                            </span>
                                        {% else %}
                                            <span class="badge bg-info">
                                                {{ hours|number_format }}h left
                                            </span>
                                        {% endif %}
                                    {% elseif breach.supervisoryAuthorityNotifiedAt %}
                                        <i class="bi bi-check-circle text-success" aria-hidden="true" title="Notified {{ breach.supervisoryAuthorityNotifiedAt|date('Y-m-d H:i') }}"></i>
                                    {% else %}
                                        <span class="text-muted">Not required</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if breach.supervisoryAuthorityNotifiedAt %}
                                        <i class="bi bi-check-circle text-success" aria-hidden="true"></i>
                                    {% elseif breach.requiresAuthorityNotification %}
                                        <i class="bi bi-x-circle text-warning" aria-hidden="true"></i>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if breach.dataSubjectsNotifiedAt %}
                                        <i class="bi bi-check-circle text-success" aria-hidden="true"></i>
                                    {% elseif breach.requiresSubjectNotification %}
                                        <i class="bi bi-x-circle text-warning" aria-hidden="true"></i>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ path('app_data_breach_show', {id: breach.id}) }}"
                                           class="btn btn-outline-primary"
                                           title="View" aria-label="View">
                                            <i class="bi bi-eye" aria-hidden="true"></i>
                                        </a>
                                        {% if breach.status in ['draft', 'under_assessment'] %}
                                            <a href="{{ path('app_data_breach_edit', {id: breach.id}) }}"
                                               class="btn btn-outline-secondary"
                                               title="Edit" aria-label="Edit">
                                                <i class="bi bi-pencil" aria-hidden="true"></i>
                                            </a>
                                        {% endif %}
                                        <a href="{{ path('app_data_breach_export_pdf', {id: breach.id}) }}"
                                           class="btn btn-outline-success"
                                           title="Export PDF" aria-label="Export PDF">
                                            <i class="bi bi-file-pdf" aria-hidden="true"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endblock %}
                {% endembed %}
            {% else %}
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> No data breaches found for the selected filter.
                    {% if current_filter != 'all' %}
                        <a href="{{ path('app_data_breach_index') }}" class="alert-link">View all breaches</a>.
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
