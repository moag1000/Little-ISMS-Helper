{% extends 'base.html.twig' %}

{% block title %}Data Breach Dashboard{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'Privacy', icon: 'bi-shield-lock' },
            { label: 'Data Breaches', url: path('app_data_breach_index') },
            { label: 'Dashboard' }
        ]
    } %}

    {% include '_components/_page_header.html.twig' with {
        title: 'Data Breach Dashboard',
        subtitle: 'GDPR Art. 33/34 Compliance Overview',
        icon: 'bi-speedometer2',
        actions: [
            { label: 'View All Breaches', url: path('app_data_breach_index'), variant: 'primary', icon: 'bi-list' },
            { label: 'New Data Breach', url: path('app_data_breach_new'), variant: 'danger', icon: 'bi-plus-lg' }
        ]
    } %}

    {# Overall Compliance Score #}
    <div class="card mb-4 text-center">
        <div class="card-body">
            <h6 class="text-muted mb-2">Overall GDPR Art. 33/34 Compliance Score</h6>
            {% set score = compliance_score.overall_score %}
            <h1 class="display-1 mb-0
                {% if score >= 80 %}text-success
                {% elseif score >= 60 %}text-warning
                {% else %}text-danger{% endif %}">
                {{ score }}%
            </h1>
            <div class="row mt-4">
                <div class="col-md-4">
                    <small class="text-muted">Notification Compliance</small>
                    <h4>{{ compliance_score.notification_compliance }}%</h4>
                    <small class="text-muted">{{ statistics.authority_notified }} / {{ statistics.requires_authority_notification }} notified</small>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Timeliness Score (72h Compliance)</small>
                    <h4 class="{% if compliance_score.timeliness_score < 80 %}text-danger{% else %}text-success{% endif %}">
                        {{ compliance_score.timeliness_score }}%
                    </h4>
                    <small class="text-muted">{{ compliance_score.overdue_notifications }} overdue notification{{ compliance_score.overdue_notifications != 1 ? 's' : '' }}</small>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Completeness</small>
                    <h4>{{ compliance_score.completeness_score }}%</h4>
                    <small class="text-muted">Average breach completeness</small>
                </div>
            </div>
            <p class="text-muted mt-3">
                {{ statistics.total }} total breach{{ statistics.total != 1 ? 'es' : '' }} Â·
                {{ compliance_score.total_affected_subjects|number_format }} affected data subjects
            </p>
        </div>
    </div>

    {# CRITICAL: Action Items #}
    {% if action_items|length > 0 %}
        <div class="card mb-4">
            <div class="card-header"><h2 class="mb-0"><i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i> Action Items</h2>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for item in action_items %}
                        <a href="{{ path('app_data_breach_show', {id: item.breach_id}) }}"
                           class="list-group-item list-group-item-action
                           {% if item.priority == 'critical' %}list-group-item-danger
                           {% elseif item.priority == 'high' %}list-group-item-warning
                           {% elseif item.priority == 'medium' %}list-group-item-info
                           {% endif %}">
                            <div class="d-flex w-100 justify-content-between">
                                <div class="fw-bold mb-1">
                                    {% if item.priority == 'critical' %}
                                        <i class="bi bi-exclamation-triangle-fill text-danger" aria-hidden="true"></i>
                                    {% elseif item.priority == 'high' %}
                                        <i class="bi bi-exclamation-triangle text-warning" aria-hidden="true"></i>
                                    {% elseif item.priority == 'medium' %}
                                        <i class="bi bi-info-circle text-info" aria-hidden="true"></i>
                                    {% else %}
                                        <i class="bi bi-circle text-secondary" aria-hidden="true"></i>
                                    {% endif %}
                                    {{ item.title }}
                                </div>
                                <small>{{ item.reference_number }}</small>
                            </div>
                            <p class="mb-1">
                                {% if item.type == 'overdue_authority_notification' %}
                                    <span class="badge bg-danger">OVERDUE</span>
                                    Supervisory authority notification exceeded 72-hour deadline by {{ item.hours_overdue|number_format }} hours.
                                {% elseif item.type == 'pending_authority_notification' %}
                                    <span class="badge bg-warning text-dark">URGENT</span>
                                    {{ item.hours_remaining|number_format }} hours remaining until 72-hour deadline.
                                {% elseif item.type == 'pending_subject_notification' %}
                                    <span class="badge bg-info">PENDING</span>
                                    Data subject notification required (Art. 34).
                                {% elseif item.type == 'incomplete' %}
                                    <span class="badge bg-secondary">{{ item.completeness }}%</span>
                                    Data breach documentation incomplete.
                                {% endif %}
                            </p>
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-success" role="alert">
            <i class="bi bi-check-circle" aria-hidden="true"></i> <strong>All action items completed!</strong> No pending notifications or overdue deadlines.
        </div>
    {% endif %}

    {# Statistics by Status #}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header"><h2 class="mb-0"><i class="bi bi-bar-chart" aria-hidden="true"></i> Breach Statistics by Status</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="text-muted small">Draft</div>
                            <div class="h2">{{ statistics.draft }}</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-muted small">Under Assessment</div>
                            <div class="h3">{{ statistics.under_assessment }}</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-muted small">{{ 'data_breach.stats.authority_notified'|trans({}, 'privacy') }}</div>
                            <div class="h3 text-success">{{ statistics.authority_notified }}</div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-muted small">{{ 'data_breach.stats.subjects_notified'|trans({}, 'privacy') }}</div>
                            <div class="h3 text-success">{{ statistics.subjects_notified }}</div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-muted small">{{ 'data_breach.stats.closed'|trans({}, 'privacy') }}</div>
                            <div class="h3">{{ statistics.closed }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Statistics by Risk Level #}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h2 class="mb-0"><i class="bi bi-shield-exclamation" aria-hidden="true"></i> By Risk Level</h2>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="text-muted small">Low</div>
                            <div class="h3 text-success">{{ statistics.low_risk }}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted small">Medium</div>
                            <div class="h3 text-info">{{ statistics.medium_risk }}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted small">High</div>
                            <div class="h3 text-warning">{{ statistics.high_risk }}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted small">Critical</div>
                            <div class="h3 text-danger">{{ statistics.critical_risk }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h2 class="mb-0"><i class="bi bi-shield-lock" aria-hidden="true"></i> Special Categories</h2>
                </div>
                <div class="card-body">
                    <p><strong>Art. 9 Data (Special Categories):</strong></p>
                    <h2 class="text-info">{{ statistics.special_categories_affected }}</h2>
                    <small class="text-muted">
                        Breaches involving racial/ethnic origin, political opinions, religious beliefs,
                        health data, sexual orientation, biometric/genetic data
                    </small>
                </div>
            </div>
        </div>
    </div>

    {# Recent Breaches #}
    {% if recent_breaches|length > 0 %}
        <div class="card mb-4">
            <div class="card-header"><h2 class="mb-0"><i class="bi bi-clock-history" aria-hidden="true"></i> Recent Breaches (Last 30 Days)</h2>
            </div>
            <div class="card-body p-0">
                {% embed '_components/_table.html.twig' with {
                    'class': 'table-hover mb-0',
                    'noMargin': true,
                    'responsive': true
                } %}
                    {% block table_head %}
                        <tr>
                            <th>Reference</th>
                            <th>Title</th>
                            <th>Detected</th>
                            <th>Status</th>
                            <th>Risk</th>
                            <th>Affected Subjects</th>
                        </tr>
                    {% endblock %}
                    {% block table_body %}
                        {% for breach in recent_breaches|slice(0, 10) %}
                            <tr>
                                <td>
                                    <a href="{{ path('app_data_breach_show', {id: breach.id}) }}">
                                        {{ breach.referenceNumber }}
                                    </a>
                                </td>
                                <td>{{ breach.title }}</td>
                                <td>{{ breach.incident.detectedAt|date('Y-m-d H:i') }}</td>
                                <td>
                                    {% set status_class = {
                                        'draft': 'secondary',
                                        'under_assessment': 'info',
                                        'authority_notified': 'success',
                                        'subjects_notified': 'success',
                                        'closed': 'dark'
                                    }[breach.status] %}
                                    <span class="badge bg-{{ status_class }}">{{ breach.status|replace({'_': ' '})|upper }}</span>
                                </td>
                                <td>
                                    {% if breach.riskLevel %}
                                        {% set risk_class = {'low': 'success', 'medium': 'info', 'high': 'warning', 'critical': 'danger'}[breach.riskLevel] %}
                                        <span class="badge bg-{{ risk_class }}">{{ breach.riskLevel|upper }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ breach.affectedDataSubjects|default('-')|number_format }}</td>
                            </tr>
                        {% endfor %}
                    {% endblock %}
                {% endembed %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
