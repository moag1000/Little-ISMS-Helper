{% extends 'base.html.twig' %}

{% block title %}{{ 'compliance.title.gap_analysis'|trans }} - Small ISMS Helper{% endblock %}

{% block body %}
<div class="d-flex justify-between align-center mb-4">
    <div>
        <h1>{{ 'compliance.title.gap_analysis'|trans }}</h1>
        <p style="color: var(--color-text-light); margin-top: var(--spacing-sm);">
            {{ 'compliance.description.gap_analysis'|trans }}
        </p>
    </div>
    <div>
        <a href="{{ path('app_compliance_export_gaps') }}" class="btn btn-success">
            üìä {{ 'compliance.action.export_gaps'|trans }}
        </a>
    </div>
</div>

{# Statistics Cards #}
<div class="kpi-grid">
    <div class="kpi-card">
        <div class="icon">üìã</div>
        <div class="label">{{ 'compliance.stats.total_requirements'|trans }}</div>
        <div>
            <span class="value">{{ totalRequirements }}</span>
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">‚úÖ</div>
        <div class="label">{{ 'compliance.stats.met_requirements'|trans }}</div>
        <div>
            <span class="value">{{ metRequirements }}</span>
        </div>
    </div>

    <div class="kpi-card" style="border-left: 4px solid var(--color-danger);">
        <div class="icon">‚ö†Ô∏è</div>
        <div class="label">{{ 'compliance.stats.gaps_identified'|trans }}</div>
        <div>
            <span class="value" style="color: var(--color-danger);">{{ gaps|length }}</span>
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">üìà</div>
        <div class="label">{{ 'compliance.stats.compliance_score'|trans }}</div>
        <div>
            {% set score = totalRequirements > 0 ? (metRequirements / totalRequirements * 100)|round : 0 %}
            <span class="value">{{ score }}</span>
            <span class="unit">%</span>
        </div>
    </div>
</div>

{# Framework Selection #}
<div class="card mb-4">
    <h2>{{ 'compliance.section.framework_selection'|trans }}</h2>

    <form method="get" style="margin-top: var(--spacing-md);">
        <div class="form-group">
            <label for="framework">{{ 'compliance.field.select_framework'|trans }}</label>
            <select name="framework" id="framework" class="form-select" onchange="this.form.submit();">
                <option value="">{{ 'compliance.option.all_frameworks'|trans }}</option>
                {% for framework in frameworks %}
                    <option value="{{ framework.id }}" {% if selectedFramework and selectedFramework.id == framework.id %}selected{% endif %}>
                        {{ framework.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

{# Gap Analysis by Severity #}
<div class="module-grid mb-4">
    <div class="card" style="border-left: 4px solid var(--color-danger);">
        <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">üî¥</div>
        <h3>{{ 'compliance.severity.critical'|trans }}</h3>
        <div class="mt-2">
            <strong style="font-size: 1.5rem; color: var(--color-danger);">{{ gaps|filter(g => g.severity == 'critical')|length }}</strong>
        </div>
        <p style="color: var(--color-text-muted); margin-top: var(--spacing-xs);">
            {{ 'compliance.description.critical_gaps'|trans }}
        </p>
    </div>

    <div class="card" style="border-left: 4px solid var(--color-warning);">
        <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">üü°</div>
        <h3>{{ 'compliance.severity.high'|trans }}</h3>
        <div class="mt-2">
            <strong style="font-size: 1.5rem; color: var(--color-warning);">{{ gaps|filter(g => g.severity == 'high')|length }}</strong>
        </div>
        <p style="color: var(--color-text-muted); margin-top: var(--spacing-xs);">
            {{ 'compliance.description.high_gaps'|trans }}
        </p>
    </div>

    <div class="card" style="border-left: 4px solid var(--color-info);">
        <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">üîµ</div>
        <h3>{{ 'compliance.severity.medium'|trans }}</h3>
        <div class="mt-2">
            <strong style="font-size: 1.5rem; color: var(--color-info);">{{ gaps|filter(g => g.severity == 'medium')|length }}</strong>
        </div>
        <p style="color: var(--color-text-muted); margin-top: var(--spacing-xs);">
            {{ 'compliance.description.medium_gaps'|trans }}
        </p>
    </div>

    <div class="card" style="border-left: 4px solid var(--color-secondary);">
        <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">‚ö™</div>
        <h3>{{ 'compliance.severity.low'|trans }}</h3>
        <div class="mt-2">
            <strong style="font-size: 1.5rem;">{{ gaps|filter(g => g.severity == 'low')|length }}</strong>
        </div>
        <p style="color: var(--color-text-muted); margin-top: var(--spacing-xs);">
            {{ 'compliance.description.low_gaps'|trans }}
        </p>
    </div>
</div>

{# Gaps Table #}
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>{{ 'compliance.field.requirement'|trans }}</th>
                <th>{{ 'compliance.field.framework'|trans }}</th>
                <th>{{ 'compliance.field.severity'|trans }}</th>
                <th>{{ 'compliance.field.gap_description'|trans }}</th>
                <th>{{ 'compliance.field.remediation'|trans }}</th>
                <th>{{ 'compliance.field.due_date'|trans }}</th>
                <th style="text-align: center;">{{ 'common.actions'|trans }}</th>
            </tr>
        </thead>
        <tbody>
            {% for gap in gaps %}
            <tr>
                <td>
                    <strong>{{ gap.requirement.identifier }}</strong>
                    <br><small style="color: var(--color-text-muted);">{{ gap.requirement.name }}</small>
                </td>
                <td>
                    <span class="badge badge-info">{{ gap.framework.name }}</span>
                </td>
                <td>
                    {% set severityColors = {
                        'critical': 'danger',
                        'high': 'warning',
                        'medium': 'info',
                        'low': 'secondary'
                    } %}
                    <span class="badge badge-{{ severityColors[gap.severity] ?? 'secondary' }}">
                        {{ ('compliance.severity.' ~ gap.severity)|trans }}
                    </span>
                </td>
                <td>
                    <small>{{ gap.description|default('-') }}</small>
                </td>
                <td>
                    <small>{{ gap.remediationPlan|default('-') }}</small>
                </td>
                <td>
                    {% if gap.targetDate %}
                        {{ gap.targetDate|date('d.m.Y') }}
                        {% if gap.targetDate < date() %}
                            <span class="badge badge-danger" style="margin-left: var(--spacing-xs);">
                                {{ 'compliance.badge.overdue'|trans }}
                            </span>
                        {% endif %}
                    {% else %}
                        <span style="color: var(--color-text-muted);">-</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    <a href="{{ path('app_compliance_gap_show', {id: gap.id}) }}" class="btn btn-sm">
                        üëÅ {{ 'common.view'|trans }}
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                    <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">‚úÖ</div>
                    <p><strong>{{ 'compliance.message.no_gaps'|trans }}</strong></p>
                    <p style="margin-top: var(--spacing-xs);">{{ 'compliance.message.no_gaps_desc'|trans }}</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
