{% extends 'base.html.twig' %}

{% block title %}{{ requirement.requirementId }} - {{ requirement.title }}{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    {# Breadcrumb Navigation #}
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('app_compliance_index') }}">Compliance</a></li>
            <li class="breadcrumb-item"><a href="{{ path('app_compliance_framework', {id: requirement.framework.id}) }}">{{ requirement.framework.code }}</a></li>
            <li class="breadcrumb-item"><a href="{{ path('app_compliance_requirement_index') }}?framework={{ requirement.framework.id }}">Requirements</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ requirement.requirementId }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-list-check" aria-hidden="true"></i> {{ requirement.requirementId }}</h1>
        <div>
            <a href="{{ path('app_compliance_requirement_edit', {id: requirement.id}) }}" class="btn btn-secondary">
                <i class="bi bi-pencil" aria-hidden="true"></i> Edit
            </a>
            <a href="{{ path('app_compliance_requirement_index') }}?framework={{ requirement.framework.id }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to List
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            {# Main Information #}
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="mb-0">Requirement Details</h2>
                </div>
                <div class="card-body">
                    <p class="lead fw-bold">{{ requirement.title }}</p>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <p><strong>Framework:</strong>
                                <a href="{{ path('app_compliance_framework', {id: requirement.framework.id}) }}">
                                    {{ requirement.framework.name }}
                                </a>
                            </p>
                            <p><strong>Requirement ID:</strong> <code>{{ requirement.requirementId }}</code></p>
                            <p><strong>Category:</strong> {{ requirement.category|default('-') }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Priority:</strong>
                                <span class="{{ badge_priority(requirement.priority) }}">{{ requirement.priority }}</span>
                            </p>
                            <p><strong>Type:</strong> <span class="badge bg-info">{{ requirement.requirementType }}</span></p>
                            <p><strong>Applicable:</strong>
                                {% if fulfillment.applicable %}
                                    <span class="badge bg-success">Yes</span>
                                    {% if is_inherited %}<small class="text-muted">(inherited)</small>{% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">No</span>
                                    {% if is_inherited %}<small class="text-muted">(inherited)</small>{% endif %}
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <hr>

                    <p class="fw-bold">Description</p>
                    <p class="text-muted">{{ requirement.description }}</p>

                    {% if fulfillment.applicabilityJustification %}
                        <p class="fw-bold mt-3">Applicability Justification {% if is_inherited %}<small class="text-muted">(from parent tenant)</small>{% endif %}</p>
                        <p class="text-muted">{{ fulfillment.applicabilityJustification }}</p>
                    {% endif %}

                    {% if fulfillment.evidenceDescription %}
                        <p class="fw-bold mt-3">Evidence Description {% if is_inherited %}<small class="text-muted">(from parent tenant)</small>{% endif %}</p>
                        <p class="text-muted">{{ fulfillment.evidenceDescription }}</p>
                    {% endif %}
                </div>
            </div>

            {# Mapped Controls #}
            {% if requirement.mappedControls|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h2 class="mb-0"><i class="bi bi-link-45deg" aria-hidden="true"></i> Mapped Controls ({{ requirement.mappedControls|length }})</h2>
                    </div>
                    <div class="card-body">
                        {% embed '_components/_table.html.twig' with {
                            'class': 'table-sm',
                            'noMargin': true,
                            'responsive': true
                        } %}
                            {% block table_head %}
                                <tr>
                                    <th scope="col">Control ID</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Progress</th>
                                </tr>
                            {% endblock %}
                            {% block table_body %}
                                {% for control in requirement.mappedControls %}
                                    <tr>
                                        <td><code>{{ control.controlId }}</code></td>
                                        <td>{{ control.name }}</td>
                                        <td>
                                            <span class="badge bg-secondary">{{ control.implementationStatus }}</span>
                                        </td>
                                        <td>{{ control.implementationPercentage|default(0) }}%</td>
                                    </tr>
                                {% endfor %}
                            {% endblock %}
                        {% endembed %}
                    </div>
                </div>
            {% endif %}

            {# Detailed Sub-Requirements #}
            {% if requirement.detailedRequirements|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h2 class="mb-0"><i class="bi bi-diagram-3" aria-hidden="true"></i> Detailed Sub-Requirements ({{ requirement.detailedRequirements|length }})</h2>
                    </div>
                    <div class="card-body">
                        <ul class="list-group">
                            {% for subReq in requirement.detailedRequirements %}
                                {% set subFulfillment = sub_requirement_fulfillments[subReq.id] %}
                                {% set subPct = subFulfillment ? subFulfillment.fulfillmentPercentage : 0 %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ subReq.requirementId }}</strong> - {{ subReq.title }}
                                        <br>
                                        <small class="text-muted">{{ subReq.description|u.truncate(100, '...') }}</small>
                                    </div>
                                    <div>
                                        <span class="{{ badge_completion(subPct) }} rounded-pill">
                                            {{ subPct }}%
                                        </span>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="col-md-4">
            {# Fulfillment Status #}
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="mb-0">Fulfillment Status</h2>
                </div>
                <div class="card-body">
                    {% if is_inherited %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle" aria-hidden="true"></i> <strong>Inherited from parent tenant</strong>
                            <br><small>This fulfillment data is inherited from your parent organization. You cannot edit it directly.</small>
                        </div>
                    {% endif %}

                    <div class="text-center mb-3">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar {{ badge_completion(fulfillment.fulfillmentPercentage)|replace({'badge ': ''}) }}"
                                 role="progressbar"
                                 style="width: {{ fulfillment.fulfillmentPercentage }}%"
                                 aria-valuenow="{{ fulfillment.fulfillmentPercentage }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                <strong>{{ fulfillment.fulfillmentPercentage }}%</strong>
                            </div>
                        </div>
                        <small class="text-muted">Status: <span class="{{ badge_completion(fulfillment.fulfillmentPercentage) }}">{{ fulfillment.status }}</span></small>
                    </div>

                    {% if calculated_fulfillment != fulfillment.fulfillmentPercentage %}
                        <div class="alert alert-info">
                            <small><i class="bi bi-calculator" aria-hidden="true"></i> Calculated from controls: <strong>{{ calculated_fulfillment }}%</strong></small>
                        </div>
                    {% endif %}

                    {% if fulfillment.fulfillmentNotes %}
                        <p class="fw-bold mt-3">Notes {% if is_inherited %}<small class="text-muted">(from parent)</small>{% endif %}</p>
                        <p class="text-muted small">{{ fulfillment.fulfillmentNotes }}</p>
                    {% endif %}

                    {# Quick Update Form - Enhanced with Visual Slider #}
                    {% if can_edit %}
                        <form method="post" action="{{ path('app_compliance_requirement_quick_update', {id: requirement.id}) }}" class="mt-3" id="quickUpdateForm"
                              data-controller="fulfillment">
                            <input type="hidden" name="_token" value="{{ csrf_token('quick-update' ~ requirement.id) }}">

                            <div class="mb-3">
                                <label for="fulfillmentPercentage" class="form-label d-flex justify-content-between">
                                    <span>Fulfillment</span>
                                    <span data-fulfillment-target="display" class="badge bg-primary">{{ fulfillment.fulfillmentPercentage }}%</span>
                                </label>

                                {# Visual Slider #}
                                <input type="range" class="form-range" id="fulfillmentSlider"
                                       data-fulfillment-target="slider"
                                       data-action="input->fulfillment#update"
                                       min="0" max="100" step="5" value="{{ fulfillment.fulfillmentPercentage }}"
                                       style="cursor: pointer;"
                                       data-bs-toggle="tooltip" data-bs-placement="top"
                                       title="{{ 'common.tooltip.fulfillment_slider'|trans({}, 'messages') }}">

                                {# Hidden input for form submission #}
                                <input type="hidden" id="fulfillmentPercentage" name="fulfillmentPercentage" value="{{ fulfillment.fulfillmentPercentage }}">

                                {# Visual Progress Bar #}
                                <div class="progress mt-2" style="height: 8px;">
                                    <div data-fulfillment-target="progressBar" class="progress-bar" role="progressbar"
                                         style="width: {{ fulfillment.fulfillmentPercentage }}%; background-color: {{ fulfillment.fulfillmentPercentage >= 75 ? '#28a745' : (fulfillment.fulfillmentPercentage >= 50 ? '#ffc107' : '#dc3545') }};"
                                         aria-valuenow="{{ fulfillment.fulfillmentPercentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>

                            {# Quick Preset Buttons #}
                            <div class="d-flex gap-1 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary flex-fill"
                                        data-action="click->fulfillment#set" data-fulfillment-value-param="0"
                                        data-bs-toggle="tooltip" data-bs-placement="bottom"
                                        title="{{ 'compliance.tooltip.not_started'|trans({}, 'compliance') }}">0%</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary flex-fill"
                                        data-action="click->fulfillment#set" data-fulfillment-value-param="25"
                                        data-bs-toggle="tooltip" data-bs-placement="bottom"
                                        title="{{ 'compliance.tooltip.planning_phase'|trans({}, 'compliance') }}">25%</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary flex-fill"
                                        data-action="click->fulfillment#set" data-fulfillment-value-param="50"
                                        data-bs-toggle="tooltip" data-bs-placement="bottom"
                                        title="{{ 'common.tooltip.status_in_progress'|trans({}, 'messages') }}">50%</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary flex-fill"
                                        data-action="click->fulfillment#set" data-fulfillment-value-param="75"
                                        data-bs-toggle="tooltip" data-bs-placement="bottom"
                                        title="{{ 'compliance.tooltip.nearly_complete'|trans({}, 'compliance') }}">75%</button>
                                <button type="button" class="btn btn-sm btn-outline-success flex-fill"
                                        data-action="click->fulfillment#set" data-fulfillment-value-param="100"
                                        data-bs-toggle="tooltip" data-bs-placement="bottom"
                                        title="{{ 'common.tooltip.status_fully_implemented'|trans({}, 'messages') }}">100%</button>
                            </div>
                        </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="applicable" name="applicable" value="1"
                                       {% if fulfillment.applicable %}checked{% endif %}
                                       data-bs-toggle="tooltip" data-bs-placement="right"
                                       title="{{ 'compliance.requirement.tooltip.applicable'|trans({}, 'compliance') }}">
                                <label class="form-check-label" for="applicable">
                                    <strong>{{ 'compliance.requirement.applicable'|trans({}, 'compliance') }}</strong>
                                    <small class="d-block text-muted">{{ 'compliance.requirement.applicable_description'|trans({}, 'compliance') }}</small>
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary w-100"
                                    data-bs-toggle="tooltip" data-bs-placement="top"
                                    title="{{ 'compliance.requirement.tooltip.save'|trans({}, 'compliance') }}">
                                <i class="bi bi-check-circle" aria-hidden="true"></i> {{ 'compliance.requirement.save_quick_update'|trans({}, 'compliance') }}
                            </button>
                        </form>
                    {% else %}
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-lock" aria-hidden="true"></i> You cannot edit inherited fulfillment data. Only the parent tenant can modify this.
                        </div>
                    {% endif %}

                    <script>
                    // Update slider value and progress bar in real-time
                    const slider = document.getElementById('fulfillmentSlider');
                    const hiddenInput = document.getElementById('fulfillmentPercentage');
                    const sliderValue = document.getElementById('sliderValue');
                    const progressBar = document.getElementById('progressBar');

                    function updateSlider(value) {
                        slider.value = value;
                        hiddenInput.value = value;
                        sliderValue.textContent = value + '%';
                        sliderValue.className = 'badge bg-' + (value >= 75 ? 'success' : (value >= 50 ? 'warning' : 'danger'));
                        progressBar.style.width = value + '%';
                        progressBar.style.backgroundColor = value >= 75 ? '#28a745' : (value >= 50 ? '#ffc107' : '#dc3545');
                        progressBar.setAttribute('aria-valuenow', value);
                    }

                    slider.addEventListener('input', function() {
                        updateSlider(this.value);
                    });

                    // Show success message after update
                    const form = document.getElementById('quickUpdateForm');
                    form.addEventListener('submit', function(e) {
                        // Let form submit naturally, but show loading state
                        const btn = form.querySelector('button[type="submit"]');
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{{ 'common.saving'|trans({}, 'messages') }}';
                        btn.disabled = true;
                    });

                    // Initialize Bootstrap tooltips
                    document.addEventListener('DOMContentLoaded', function() {
                        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                            return new bootstrap.Tooltip(tooltipTriggerEl, {
                                trigger: 'hover',
                                html: false
                            });
                        });
                    });
                    </script>
                </div>
            </div>

            {# Metadata #}
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="mb-0">Metadata</h2>
                </div>
                <div class="card-body">
                    <p><small><strong>Responsible:</strong>
                        {% if fulfillment.responsiblePerson %}
                            {{ fulfillment.responsiblePerson.fullName|default(fulfillment.responsiblePerson.email) }}
                            {% if is_inherited %}<span class="text-muted">(from parent)</span>{% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </small></p>
                    <p><small><strong>Last Review:</strong>
                        {% if fulfillment.lastReviewDate %}
                            {{ fulfillment.lastReviewDate|date('Y-m-d') }}
                            {% if is_inherited %}<span class="text-muted">(from parent)</span>{% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </small></p>
                    <p><small><strong>Next Review:</strong>
                        {% if fulfillment.nextReviewDate %}
                            {{ fulfillment.nextReviewDate|date('Y-m-d') }}
                            {% if fulfillment.isOverdueForReview() %}<span class="badge bg-danger">Overdue</span>{% endif %}
                            {% if is_inherited %}<span class="text-muted">(from parent)</span>{% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </small></p>
                    <p><small><strong>Last Updated By:</strong>
                        {% if fulfillment.lastUpdatedBy %}
                            {{ fulfillment.lastUpdatedBy.fullName|default(fulfillment.lastUpdatedBy.email) }}
                        {% else %}
                            -
                        {% endif %}
                    </small></p>
                    <p><small><strong>Created:</strong> {{ requirement.createdAt|date('Y-m-d H:i') }}</small></p>
                    {% if requirement.updatedAt %}
                        <p><small><strong>Updated:</strong> {{ requirement.updatedAt|date('Y-m-d H:i') }}</small></p>
                    {% endif %}
                </div>
            </div>

            {# Delete Button #}
            <div class="card border-danger">
                <div class="card-header bg-danger text-white"><h2 class="mb-0">Danger Zone</h2>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ path('app_compliance_requirement_delete', {id: requirement.id}) }}"
                          data-controller="ui-actions"
                          data-action="submit->ui-actions#confirm"
                          data-ui-actions-message-param="{{ 'compliance.requirement.confirm.delete'|trans({}, 'compliance') }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ requirement.id) }}">
                        <button type="submit" class="btn btn-danger btn-sm w-100">
                            <i class="bi bi-trash" aria-hidden="true"></i> {{ 'compliance.action.delete_requirement'|trans({}, 'compliance') }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
