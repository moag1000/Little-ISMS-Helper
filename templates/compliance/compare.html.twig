{% extends 'base.html.twig' %}
{% import '_macros/cards.html.twig' as cards %}

{% block title %}{{ 'compliance.title.compare'|trans }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>{{ 'compliance.title.compare'|trans }}</h1>
        <p class="text-muted">{{ 'compliance.description.compare'|trans }}</p>
    </div>
    <div class="button-group">
        {% if selectedFramework1 and selectedFramework2 %}
        <button id="createMappingsBtn" class="btn btn-primary" data-framework1="{{ selectedFramework1.id }}" data-framework2="{{ selectedFramework2.id }}">
            üîó {{ 'compliance.action.create_mappings'|trans({}, 'compliance') }}
        </button>
        {% endif %}
        <a href="{{ path('app_compliance_export_comparison_pdf', {framework1: selectedFramework1 ? selectedFramework1.id : '', framework2: selectedFramework2 ? selectedFramework2.id : ''}) }}" class="btn btn-danger" data-turbo="false" {% if not selectedFramework1 or not selectedFramework2 %}disabled{% endif %}>
            üìÑ {{ 'compliance.action.export_pdf'|trans({}, 'compliance') }}
        </a>
        <a href="{{ path('app_compliance_export_comparison_excel', {framework1: selectedFramework1 ? selectedFramework1.id : '', framework2: selectedFramework2 ? selectedFramework2.id : ''}) }}" class="btn btn-success" data-turbo="false" {% if not selectedFramework1 or not selectedFramework2 %}disabled{% endif %}>
            üìä {{ 'compliance.action.export_excel'|trans({}, 'compliance') }}
        </a>
        <a href="{{ path('app_compliance_export_comparison', {framework1: selectedFramework1 ? selectedFramework1.id : '', framework2: selectedFramework2 ? selectedFramework2.id : ''}) }}" class="btn btn-secondary" data-turbo="false" {% if not selectedFramework1 or not selectedFramework2 %}disabled{% endif %}>
            üìÑ {{ 'compliance.action.export_csv'|trans({}, 'compliance') }}
        </a>
    </div>
</div>

{# Framework Selection #}
<div class="card mb-4">
    <h2>{{ 'compliance.section.select_frameworks'|trans }}</h2>

    <form method="get" action="{{ path('app_compliance_compare') }}" class="mt-md">
        <div class="form-group">
            <label for="framework1">{{ 'compliance.field.framework_1'|trans }}</label>
            <select name="framework1" id="framework1" class="form-select" required>
                <option value="">{{ 'compliance.option.select_framework'|trans }}</option>
                {% for framework in frameworks %}
                    <option value="{{ framework.id }}" {% if selectedFramework1 and selectedFramework1.id == framework.id %}selected{% endif %}>
                        {{ framework.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="framework2">{{ 'compliance.field.framework_2'|trans }}</label>
            <select name="framework2" id="framework2" class="form-select" required>
                <option value="">{{ 'compliance.option.select_framework'|trans }}</option>
                {% for framework in frameworks %}
                    <option value="{{ framework.id }}" {% if selectedFramework2 and selectedFramework2.id == framework.id %}selected{% endif %}>
                        {{ framework.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn btn-primary">
            üîç {{ 'compliance.action.compare'|trans({}, 'compliance') }}
        </button>
    </form>
</div>

{% if selectedFramework1 and selectedFramework2 %}
{# Comparison Overview #}
<div class="kpi-grid">
    <div class="col-auto">
        {{ cards.kpi_card(selectedFramework1.name, framework1Requirements ~ ' ' ~ ('compliance.unit.requirements'|trans), null, null, null, null) }}
    </div>
    <div class="col-auto">
        {{ cards.kpi_card(selectedFramework2.name, framework2Requirements ~ ' ' ~ ('compliance.unit.requirements'|trans), null, null, null, null) }}
    </div>
    <div class="col-auto">
        {{ cards.kpi_card('compliance.stats.common_requirements'|trans, commonRequirements, null, null, null, null) }}
    </div>
    <div class="col-auto">
        {% set overlap = ((commonRequirements / framework1Requirements * 100) + (commonRequirements / framework2Requirements * 100)) / 2 %}
        {{ cards.kpi_card('compliance.stats.overlap_percentage'|trans, overlap|round ~ '%', null, null, null, null) }}
    </div>
</div>

{# Visual Comparison #}
<div class="module-grid mb-4">
    <div class="card">
        <h3>{{ selectedFramework1.name }}{% if selectedFramework1.version %} <span class="text-muted-fs-09">(v{{ selectedFramework1.version }})</span>{% endif %}</h3>
        <p class="text-muted-mt-sm">
            {{ selectedFramework1.description }}
        </p>

        <div class="stats-grid mt-3" style="grid-template-columns: 1fr;">
            <div class="stat-item">
                <strong>{{ framework1Requirements }}</strong>
                <span>{{ 'compliance.field.total_requirements'|trans }}</span>
            </div>
            <div class="stat-item">
                <strong>{{ framework1UniqueRequirements }}</strong>
                <span>{{ 'compliance.field.unique_requirements'|trans }}</span>
            </div>
            <div class="stat-item">
                <strong>{{ framework1Categories|length }}</strong>
                <span>{{ 'compliance.field.categories'|trans }}</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>{{ selectedFramework2.name }}{% if selectedFramework2.version %} <span class="text-muted-fs-09">(v{{ selectedFramework2.version }})</span>{% endif %}</h3>
        <p class="text-muted-mt-sm">
            {{ selectedFramework2.description }}
        </p>

        <div class="stats-grid mt-3" style="grid-template-columns: 1fr;">
            <div class="stat-item">
                <strong>{{ framework2Requirements }}</strong>
                <span>{{ 'compliance.field.total_requirements'|trans }}</span>
            </div>
            <div class="stat-item">
                <strong>{{ framework2UniqueRequirements }}</strong>
                <span>{{ 'compliance.field.unique_requirements'|trans }}</span>
            </div>
            <div class="stat-item">
                <strong>{{ framework2Categories|length }}</strong>
                <span>{{ 'compliance.field.categories'|trans }}</span>
            </div>
        </div>
    </div>
</div>

{# Detailed Comparison Table #}
<h2>{{ 'compliance.section.detailed_comparison'|trans }}</h2>

{% embed '_components/_table.html.twig' with {
    'class': 'table-container',
    'noMargin': true,
    'responsive': true
} %}
    {% block table_head %}
        <tr>
            <th scope="col">{{ selectedFramework1.name }} {{ 'compliance.field.requirement'|trans }}</th>
            <th scope="col">{{ 'compliance.field.category'|trans }}</th>
            <th scope="col" class="text-center">{{ 'compliance.field.mapping'|trans }}</th>
            <th scope="col">{{ selectedFramework2.name }} {{ 'compliance.field.requirement'|trans }}</th>
            <th scope="col">{{ 'compliance.field.category'|trans }}</th>
            <th scope="col" class="text-center">{{ 'compliance.field.match_quality'|trans }}</th>
        </tr>
    {% endblock %}
    {% block table_body %}
        {% for comparison in comparisonDetails %}
        <tr>
            <td>
                <strong>{{ comparison.framework1Requirement.requirementId }}</strong>
                <br><small class="text-muted">{{ comparison.framework1Requirement.title }}</small>
            </td>
            <td>
                <span class="badge bg-info">{{ comparison.framework1Requirement.category }}</span>
            </td>
            <td class="text-center">
                {% if comparison.mapped %}
                    <span class="badge bg-success">‚úì {{ 'compliance.badge.mapped'|trans }}</span>
                {% else %}
                    <span class="badge bg-secondary">- {{ 'compliance.badge.no_mapping'|trans }}</span>
                {% endif %}
            </td>
            <td>
                {% if comparison.framework2Requirement %}
                    <strong>{{ comparison.framework2Requirement.requirementId }}</strong>
                    <br><small class="text-muted">{{ comparison.framework2Requirement.title }}</small>
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                {% if comparison.framework2Requirement %}
                    <span class="badge bg-info">{{ comparison.framework2Requirement.category }}</span>
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td class="text-center">
                {% if comparison.matchQuality %}
                    {% set qualityColor = comparison.matchQuality >= 80 ? 'success' : (comparison.matchQuality >= 60 ? 'warning' : 'danger') %}
                    <span class="badge badge-{{ qualityColor }}">{{ comparison.matchQuality }}%</span>
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="6" class="text-center-p-xl">
                {{ 'compliance.message.no_comparison_data'|trans }}
            </td>
        </tr>
        {% endfor %}
    {% endblock %}
{% endembed %}

{# Unique Requirements #}
<div class="module-grid mt-4">
    <div class="card">
        <h3>{{ 'compliance.section.unique_to'|trans }} {{ selectedFramework1.name }}</h3>
        <p class="text-muted-mt-xs-mb-md">
            {{ 'compliance.description.unique_requirements'|trans }}
        </p>

        {% if framework1Unique|length > 0 %}
        <ul class="list-unstyled">
            {% for req in framework1Unique|slice(0, 10) %}
            <li class="py-xs-border-bottom">
                <code>{{ req.requirementId }}</code> {{ req.title }}
            </li>
            {% endfor %}
            {% if framework1Unique|length > 10 %}
            <li class="py-xs-text-muted">
                {{ 'compliance.message.more_requirements'|trans({'%count%': framework1Unique|length - 10}) }}
            </li>
            {% endif %}
        </ul>
        {% else %}
        <p class="text-muted">{{ 'compliance.message.no_unique'|trans }}</p>
        {% endif %}
    </div>

    <div class="card">
        <h3>{{ 'compliance.section.unique_to'|trans }} {{ selectedFramework2.name }}</h3>
        <p class="text-muted-mt-xs-mb-md">
            {{ 'compliance.description.unique_requirements'|trans }}
        </p>

        {% if framework2Unique|length > 0 %}
        <ul class="list-unstyled">
            {% for req in framework2Unique|slice(0, 10) %}
            <li class="py-xs-border-bottom">
                <code>{{ req.requirementId }}</code> {{ req.title }}
            </li>
            {% endfor %}
            {% if framework2Unique|length > 10 %}
            <li class="py-xs-text-muted">
                {{ 'compliance.message.more_requirements'|trans({'%count%': framework2Unique|length - 10}) }}
            </li>
            {% endif %}
        </ul>
        {% else %}
        <p class="text-muted">{{ 'compliance.message.no_unique'|trans }}</p>
        {% endif %}
    </div>
</div>

{% endif %}

{% if selectedFramework1 and selectedFramework2 %}
<script>
function initializeComparisonMappingButton() {
    const createMappingsBtn = document.getElementById('createMappingsBtn');

    if (!createMappingsBtn) {
        return;
    }

    // Prevent multiple initializations
    if (createMappingsBtn.dataset.initialized === 'true') {
        return;
    }

    createMappingsBtn.dataset.initialized = 'true';

    createMappingsBtn.addEventListener('click', async function() {
        const framework1Id = this.dataset.framework1;
        const framework2Id = this.dataset.framework2;

        // Disable button and show loading state
        createMappingsBtn.disabled = true;
        createMappingsBtn.textContent = '‚è≥ Erstelle Mappings...';

        try {
            const response = await fetch('{{ path('app_compliance_create_comparison_mappings') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ csrf_token('create_mappings') }}'
                },
                body: JSON.stringify({
                    framework1_id: parseInt(framework1Id),
                    framework2_id: parseInt(framework2Id)
                })
            });

            const result = await response.json();

            if (result.success) {
                // Show success message
                alert(result.message);
                // Reload page to show updated mappings
                window.location.reload();
            } else {
                alert('Fehler: ' + result.message);
                createMappingsBtn.disabled = false;
                createMappingsBtn.textContent = 'üîó Mappings erstellen';
            }
        } catch (error) {
            console.error('Error creating mappings:', error);
            alert('Fehler beim Erstellen der Mappings: ' + error.message);
            createMappingsBtn.disabled = false;
            createMappingsBtn.textContent = 'üîó Mappings erstellen';
        }
    });
}

document.addEventListener('DOMContentLoaded', initializeComparisonMappingButton);
document.addEventListener('turbo:load', initializeComparisonMappingButton);
</script>
{% endif %}

{% endblock %}
