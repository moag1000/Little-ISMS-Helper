{% extends 'base.html.twig' %}

{% block title %}{{ 'compliance.manage_frameworks'|trans }}{% endblock %}

{% block body %}
<div class="container">
    <div class="page-header">
        <div>
            <h1>üì¶ {{ 'compliance.manage_frameworks'|trans }}</h1>
            <p class="text-muted">{{ 'compliance.manage_frameworks_subtitle'|trans }}</p>
        </div>
        <div class="button-group">
            <a href="{{ path('app_compliance_index') }}" class="btn btn-secondary">
                <span class="icon">‚Üê</span> {{ 'common.back'|trans }}
            </a>
        </div>
    </div>

    {# Statistics Card #}
    <div class="card" style="margin-bottom: var(--spacing-lg);">
        <div class="card-header">
            <h2>üìä {{ 'compliance.framework_statistics'|trans }}</h2>
        </div>
        <div class="card-body">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-number">{{ statistics.total_available }}</div>
                    <div class="stat-text">{{ 'compliance.total_available'|trans }}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-number">{{ statistics.total_loaded }}</div>
                    <div class="stat-text">{{ 'compliance.loaded'|trans }}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-number">{{ statistics.total_not_loaded }}</div>
                    <div class="stat-text">{{ 'compliance.not_loaded'|trans }}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-number">{{ statistics.mandatory_not_loaded }}</div>
                    <div class="stat-text">{{ 'compliance.mandatory_missing'|trans }}</div>
                </div>
            </div>
        </div>
    </div>

    {# Available Frameworks #}
    <div class="frameworks-container">
        <h2 style="margin-bottom: var(--spacing-lg);">{{ 'compliance.available_frameworks'|trans }}</h2>

        <div class="framework-cards-grid">
            {% for framework in available_frameworks %}
                <div class="framework-card {% if framework.loaded %}loaded{% endif %}">
                    <div class="framework-card-header" style="background: {% if framework.mandatory %}var(--gradient-danger){% else %}var(--gradient-primary){% endif %};">
                        <div class="framework-icon">{{ framework.icon }}</div>
                        <div class="framework-title">
                            <h3>{{ framework.code }}</h3>
                            <p>{{ framework.name }}</p>
                        </div>
                        {% if framework.loaded %}
                            <span class="badge badge-success">{{ 'compliance.loaded'|trans }}</span>
                        {% else %}
                            <span class="badge badge-warning">{{ 'compliance.not_loaded'|trans }}</span>
                        {% endif %}
                    </div>

                    <div class="framework-card-body">
                        <div class="framework-info">
                            <div class="info-item">
                                <span class="label">{{ 'compliance.version'|trans }}:</span>
                                <span class="value">{{ framework.version }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">{{ 'compliance.industry'|trans }}:</span>
                                <span class="value">{{ ('compliance.industry.' ~ framework.industry)|trans }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">{{ 'compliance.regulatory_body'|trans }}:</span>
                                <span class="value">{{ framework.regulatory_body }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">{{ 'compliance.mandatory'|trans }}:</span>
                                <span class="value">
                                    {% if framework.mandatory %}
                                        <span class="badge badge-danger">{{ 'common.yes'|trans }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary">{{ 'common.no'|trans }}</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        <p class="framework-description">{{ framework.description }}</p>

                        <div class="framework-actions">
                            {% if framework.loaded %}
                                <button class="btn btn-success btn-block" disabled>
                                    <span class="icon">‚úÖ</span> {{ 'compliance.already_loaded'|trans }}
                                </button>
                            {% else %}
                                <button class="btn btn-primary btn-block load-framework-btn"
                                        data-framework-code="{{ framework.code }}"
                                        data-framework-name="{{ framework.name }}">
                                    <span class="icon">‚¨áÔ∏è</span> {{ 'compliance.load_framework'|trans }}
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
.framework-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
    gap: var(--spacing-lg);
}

.framework-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}

.framework-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.framework-card.loaded {
    border: 2px solid var(--color-success);
}

.framework-card-header {
    padding: var(--spacing-lg);
    color: white;
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.framework-icon {
    font-size: 3rem;
}

.framework-title {
    flex: 1;
}

.framework-title h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: bold;
}

.framework-title p {
    margin: var(--spacing-xs) 0 0 0;
    opacity: 0.9;
    font-size: 0.9rem;
}

.framework-card-body {
    padding: var(--spacing-lg);
}

.framework-info {
    margin-bottom: var(--spacing-md);
}

.info-item {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-xs) 0;
    border-bottom: 1px solid var(--color-border);
}

.info-item .label {
    font-weight: 600;
    color: var(--color-text-secondary);
}

.info-item .value {
    text-align: right;
}

.framework-description {
    margin: var(--spacing-md) 0;
    color: var(--color-text-secondary);
    font-size: 0.9rem;
    line-height: 1.5;
}

.framework-actions {
    margin-top: var(--spacing-md);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
}

.stat-box {
    text-align: center;
    padding: var(--spacing-lg);
    background: var(--color-background);
    border-radius: var(--border-radius);
}

.stat-icon {
    font-size: 3rem;
    margin-bottom: var(--spacing-sm);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--color-primary);
}

.stat-text {
    color: var(--color-text-secondary);
    margin-top: var(--spacing-xs);
}

.load-framework-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadButtons = document.querySelectorAll('.load-framework-btn');

    loadButtons.forEach(button => {
        button.addEventListener('click', async function() {
            const code = this.dataset.frameworkCode;
            const name = this.dataset.frameworkName;

            if (!confirm('{{ 'compliance.confirm_load'|trans }}' + '\n\n' + name)) {
                return;
            }

            // Disable button and show loading
            this.disabled = true;
            this.innerHTML = '<span class="icon">‚è≥</span> {{ 'compliance.loading'|trans }}...';

            try {
                const response = await fetch(`{{ path('app_compliance_load_framework', {code: '__CODE__'}) }}`.replace('__CODE__', code), {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    this.innerHTML = '<span class="icon">‚úÖ</span> {{ 'compliance.successfully_loaded'|trans }}';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-success');

                    // Mark card as loaded
                    this.closest('.framework-card').classList.add('loaded');

                    // Reload page after 2 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    this.innerHTML = '<span class="icon">‚ùå</span> {{ 'compliance.load_failed'|trans }}';
                    this.classList.add('btn-danger');

                    alert('{{ 'compliance.error'|trans }}: ' + result.message);

                    // Re-enable after 3 seconds
                    setTimeout(() => {
                        this.disabled = false;
                        this.innerHTML = '<span class="icon">‚¨áÔ∏è</span> {{ 'compliance.load_framework'|trans }}';
                        this.classList.remove('btn-danger');
                        this.classList.add('btn-primary');
                    }, 3000);
                }
            } catch (error) {
                console.error('Error loading framework:', error);
                this.innerHTML = '<span class="icon">‚ùå</span> {{ 'compliance.load_failed'|trans }}';
                this.classList.add('btn-danger');

                alert('{{ 'compliance.error'|trans }}: ' + error.message);

                setTimeout(() => {
                    this.disabled = false;
                    this.innerHTML = '<span class="icon">‚¨áÔ∏è</span> {{ 'compliance.load_framework'|trans }}';
                    this.classList.remove('btn-danger');
                    this.classList.add('btn-primary');
                }, 3000);
            }
        });
    });
});
</script>
{% endblock %}
