{% extends 'base.html.twig' %}
{% trans_default_domain 'compliance' %}
{% import '_macros/cards.html.twig' as cards %}

{% block title %}{{ 'compliance.title.data_reuse'|trans({}, 'compliance') }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>{{ 'compliance.title.data_reuse'|trans({}, 'compliance') }}</h1>
        <p class="text-muted">{{ 'compliance.description.data_reuse'|trans({}, 'compliance') }}</p>
    </div>
    <div class="button-group">
        <a href="{{ path('app_compliance_export_reuse_pdf', {id: framework.id}) }}" class="btn btn-danger" data-turbo="false">
            <i class="bi bi-file-pdf" aria-hidden="true"></i> {{ 'compliance.action.export_pdf'|trans({}, 'compliance') }}
        </a>
        <a href="{{ path('app_compliance_export_reuse_excel', {id: framework.id}) }}" class="btn btn-success" data-turbo="false">
            <i class="bi bi-file-excel" aria-hidden="true"></i> {{ 'compliance.action.export_excel'|trans({}, 'compliance') }}
        </a>
        <a href="{{ path('app_compliance_export_reuse', {id: framework.id}) }}" class="btn btn-secondary" data-turbo="false">
            <i class="bi bi-file-text" aria-hidden="true"></i> {{ 'compliance.action.export_csv'|trans({}, 'compliance') }}
        </a>
    </div>
</div>

{# Statistics Cards #}
<div class="kpi-grid">
    <div class="col-auto">
        {{ cards.kpi_card('compliance.stats.total_data_points'|trans({}, 'compliance'), totalDataPoints, null, null, null, null) }}
    </div>
    <div class="col-auto">
        {{ cards.kpi_card('compliance.stats.reused_data'|trans({}, 'compliance'), reusedDataPoints, null, null, null, null) }}
    </div>
    <div class="col-auto">
        {% set reuseRate = totalDataPoints > 0 ? (reusedDataPoints / totalDataPoints * 100)|round : 0 %}
        {{ cards.kpi_card('compliance.stats.reuse_rate'|trans({}, 'compliance'), reuseRate ~ '%', null, null, null, null) }}
    </div>
    <div class="col-auto">
        {{ cards.kpi_card('compliance.stats.effort_saved'|trans({}, 'compliance'), effortSavedHours ~ 'h', null, null, null, null) }}
    </div>
</div>

{# Reuse Opportunities #}
<h2>{{ 'compliance.section.reuse_opportunities'|trans({}, 'compliance') }}</h2>

<div class="module-grid mb-4">
    {% for opportunity in reuseOpportunities %}
    {% embed '_components/_card.html.twig' %}
        {% block card_body %}
            <h2 class="fs-11-mb-sm">{{ opportunity.name }}</h2>
            <p class="text-muted-mb-md">
                {{ opportunity.description }}
            </p>

            <div class="stats-grid grid-col-2">
                <div class="stat-item">
                    <strong>{{ opportunity.applicableFrameworks|length }}</strong>
                    <span>{{ 'compliance.field.frameworks'|trans({}, 'compliance') }}</span>
                </div>
                <div class="stat-item">
                    <strong>{{ opportunity.potentialSavings }}h</strong>
                    <span>{{ 'compliance.field.time_savings'|trans({}, 'compliance') }}</span>
                </div>
            </div>

            <div class="mt-2">
                {% include '_components/_badge.html.twig' with { variant: 'success', content: opportunity.reusePercentage ~ '% ' ~ ('compliance.badge.reusable'|trans({}, 'compliance')) } %}
            </div>
        {% endblock %}
    {% endembed %}
    {% else %}
    {% embed '_components/_card.html.twig' with { 'class': 'grid-full' } %}
        {% block card_body %}
            <p class="text-center-muted">
                {{ 'compliance.message.no_opportunities'|trans({}, 'compliance') }}
            </p>
        {% endblock %}
    {% endembed %}
    {% endfor %}
</div>

{# Data Reuse Matrix #}
<h2>{{ 'compliance.section.reuse_matrix'|trans({}, 'compliance') }}</h2>

{% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
    {% block card_body %}
        <p class="text-muted-mb-md">
            {{ 'compliance.description.reuse_matrix'|trans({}, 'compliance') }}
        </p>

        {% embed '_components/_table.html.twig' with {
            'class': 'table-container',
            'noMargin': true
        } %}
            {% block table_head %}
                <tr>
                    <th scope="col">{{ 'compliance.field.data_element'|trans({}, 'compliance') }}</th>
                    <th scope="col">{{ 'compliance.field.source'|trans({}, 'compliance') }}</th>
                    <th scope="col" class="text-center">{{ 'compliance.field.reuse_count'|trans({}, 'compliance') }}</th>
                    <th scope="col">{{ 'compliance.field.used_in_frameworks'|trans({}, 'compliance') }}</th>
                    <th scope="col" class="text-center">{{ 'compliance.field.quality_score'|trans({}, 'compliance') }}</th>
                </tr>
            {% endblock %}
            {% block table_body %}
                {% for element in dataElements %}
                <tr>
                    <td>
                        <strong>{{ element.name }}</strong>
                        <br><small class="text-muted">{{ element.type }}</small>
                    </td>
                    <td>{{ element.source }}</td>
                    <td class="text-center">
                        {% include '_components/_badge.html.twig' with { variant: 'info', content: element.reuseCount } %}
                    </td>
                    <td>
                        {% for framework in element.frameworks %}
                            {% include '_components/_badge.html.twig' with { variant: 'secondary', content: framework.name, class: 'mr-xs' } %}
                        {% endfor %}
                    </td>
                    <td class="text-center">
                        <span class="{{ badge_score(element.qualityScore, 80, 60) }}">{{ element.qualityScore }}%</span>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center-p-xl-muted">
                        {{ 'compliance.message.no_data_elements'|trans({}, 'compliance') }}
                    </td>
                </tr>
                {% endfor %}
            {% endblock %}
        {% endembed %}
    {% endblock %}
{% endembed %}

{# Framework Coverage Map #}
<h2>{{ 'compliance.section.framework_coverage'|trans({}, 'compliance') }}</h2>

{% embed '_components/_table.html.twig' with {
    'class': 'table-container',
    'noMargin': true
} %}
    {% block table_head %}
        <tr>
            <th scope="col">{{ 'compliance.field.framework'|trans({}, 'compliance') }}</th>
            <th scope="col" class="text-center">{{ 'compliance.field.total_requirements'|trans({}, 'compliance') }}</th>
            <th scope="col" class="text-center">{{ 'compliance.field.reused_data'|trans({}, 'compliance') }}</th>
            <th scope="col" class="text-center">{{ 'compliance.field.new_data_needed'|trans({}, 'compliance') }}</th>
            <th scope="col" class="text-center">{{ 'compliance.field.coverage'|trans({}, 'compliance') }}</th>
        </tr>
    {% endblock %}
    {% block table_body %}
        {% for framework in frameworkCoverage %}
        <tr>
            <td><strong>{{ framework.name }}</strong></td>
            <td class="text-center">{{ framework.totalRequirements }}</td>
            <td class="text-center">
                {% include '_components/_badge.html.twig' with { variant: 'success', content: framework.reusedData } %}
            </td>
            <td class="text-center">
                {% include '_components/_badge.html.twig' with { variant: 'warning', content: framework.newDataNeeded } %}
            </td>
            <td>
                {% set coverage = (framework.reusedData / framework.totalRequirements * 100)|round %}
                <div class="progress progress-compact">
                    <div class="progress-bar" style="width: {{ coverage }}%; font-size: 0.75rem;">
                        {{ coverage }}%
                    </div>
                </div>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="5" class="text-center-p-xl-muted">
                {{ 'compliance.message.no_frameworks'|trans({}, 'compliance') }}
            </td>
        </tr>
        {% endfor %}
    {% endblock %}
{% endembed %}
{% endblock %}
