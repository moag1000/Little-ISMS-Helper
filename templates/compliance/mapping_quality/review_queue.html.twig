{% extends 'base.html.twig' %}

{% block title %}{{ 'compliance.mapping_quality.review_queue.title'|trans({}, 'compliance') }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .badge-tooltip {
            cursor: help;
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background-color: #f8f9fa;
        }
        .sortable::after {
            content: ' ⇅';
            opacity: 0.3;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container">
    <div class="page-header">
        <div>
            <h1><i class="bi bi-list-check" aria-hidden="true"></i> {{ 'compliance.mapping_quality.review_queue.title'|trans({}, 'compliance') }}</h1>
            <p class="text-muted">{{ 'compliance.mapping_quality.review_queue.subtitle'|trans({}, 'compliance') }}</p>
        </div>
        <div class="button-group">
            <a href="{{ path('app_mapping_quality_dashboard') }}" class="btn btn-secondary">
                <span class="icon">←</span> {{ 'compliance.mapping_quality.title'|trans({}, 'compliance') }}
            </a>
        </div>
    </div>

    {# Mappings Requiring Review #}
    {% if mappings_requiring_review is not empty %}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_header %}
            <div class="card-header bg-warning">
                <h2 class="mb-0"><i class="bi bi-exclamation-triangle text-warning" aria-hidden="true"></i> {{ 'compliance.mapping_quality.needs_urgent_review'|trans({}, 'compliance') }} ({{ mappings_requiring_review|length }})</h2>
            </div>
        {% endblock %}
        {% block card_body %}
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover',
                'noMargin': true,
                'responsive': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">{{ 'compliance.mapping_quality.column.source_target'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.old_percent'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.calculated_percent'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.confidence'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.quality'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.gaps'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.mapping_quality.column.action'|trans({}, 'compliance') }}</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for mapping in mappings_requiring_review %}
                    <tr>
                        <td><small>{{ mapping.id }}</small></td>
                        <td>
                            <strong>{{ mapping.sourceRequirement.requirementId }}</strong>
                            <small class="text-muted d-block">{{ mapping.sourceRequirement.framework.code }}</small>
                            →
                            <strong>{{ mapping.targetRequirement.requirementId }}</strong>
                            <small class="text-muted d-block">{{ mapping.targetRequirement.framework.code }}</small>
                        </td>
                        <td class="text-center">
                            {% include '_components/_badge.html.twig' with { variant: 'secondary', content: mapping.mappingPercentage ~ '%' } %}
                        </td>
                        <td class="text-center">
                            {% if mapping.calculatedPercentage is not null %}
                                {% include '_components/_badge.html.twig' with { variant: mapping.calculatedPercentage >= 70 ? 'success' : (mapping.calculatedPercentage >= 50 ? 'warning' : 'danger'), content: mapping.calculatedPercentage ~ '%' } %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if mapping.analysisConfidence is not null %}
                                {% include '_components/_badge.html.twig' with { variant: mapping.analysisConfidence >= 80 ? 'success' : (mapping.analysisConfidence >= 60 ? 'warning' : 'danger'), content: mapping.analysisConfidence } %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if mapping.qualityScore is not null %}
                                {% include '_components/_badge.html.twig' with { variant: mapping.qualityScore >= 75 ? 'success' : (mapping.qualityScore >= 50 ? 'warning' : 'danger'), content: mapping.qualityScore } %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if mapping.unresolvedGapCount > 0 %}
                                {% include '_components/_badge.html.twig' with { variant: 'warning', content: mapping.unresolvedGapCount } %}
                            {% else %}
                                <span class="text-success">✓</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ path('app_mapping_quality_review', {id: mapping.id}) }}" class="btn btn-sm btn-primary">
                                Review
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
        {% endblock %}
    {% endembed %}
    {% endif %}

    {# Low Confidence Mappings #}
    {% if low_confidence_mappings is not empty %}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_header %}
            <div class="card-header">
                <h3 class="mb-0"><i class="bi bi-exclamation-circle text-danger" aria-hidden="true"></i> {{ 'compliance.mapping_quality.low_confidence'|trans({}, 'compliance') }} ({{ low_confidence_mappings|length }})</h3>
            </div>
        {% endblock %}
        {% block card_body %}
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover',
                'noMargin': true,
                'responsive': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">{{ 'compliance.mapping_quality.column.source_target'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.calculated_percent'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.confidence'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.similarity'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.review_status'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.mapping_quality.column.action'|trans({}, 'compliance') }}</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for mapping in low_confidence_mappings|slice(0, 20) %}
                    <tr>
                        <td>
                            <strong>{{ mapping.sourceRequirement.framework.code }}</strong>
                            {{ mapping.sourceRequirement.requirementId }}
                            →
                            <strong>{{ mapping.targetRequirement.framework.code }}</strong>
                            {{ mapping.targetRequirement.requirementId }}
                        </td>
                        <td class="text-center">
                            {% include '_components/_badge.html.twig' with { variant: 'warning', content: mapping.calculatedPercentage ~ '%' } %}
                        </td>
                        <td class="text-center">
                            {% include '_components/_badge.html.twig' with { variant: 'danger', content: mapping.analysisConfidence } %}
                        </td>
                        <td class="text-center">
                            {% if mapping.textualSimilarity is not null %}
                                {{ (mapping.textualSimilarity * 100)|round }}%
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% include '_components/_badge.html.twig' with { variant: mapping.reviewStatusBadgeClass, content: mapping.reviewStatus } %}
                        </td>
                        <td>
                            <a href="{{ path('app_mapping_quality_review', {id: mapping.id}) }}" class="btn btn-sm btn-primary">
                                Review
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
            {% if low_confidence_mappings|length > 20 %}
                <p class="text-muted text-center mb-0">{{ 'compliance.mapping_quality.and_more'|trans({'%count%': low_confidence_mappings|length - 20}, 'compliance') }}</p>
            {% endif %}
        {% endblock %}
    {% endembed %}
    {% endif %}

    {# Discrepancies (Large differences between old and calculated) #}
    {% if discrepancies is not empty %}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_header %}
            <div class="card-header">
                <h3 class="mb-0">{{ 'compliance.mapping_quality.large_discrepancies'|trans({}, 'compliance') }} ({{ discrepancies|length }})</h3>
            </div>
        {% endblock %}
        {% block card_body %}
            <p class="text-muted">{{ 'compliance.mapping_quality.discrepancies_desc'|trans({}, 'compliance') }}</p>
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover',
                'noMargin': true,
                'responsive': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">{{ 'compliance.mapping_quality.column.source_target'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.original_percent'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.calculated_percent'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.difference'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.confidence'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.mapping_quality.column.action'|trans({}, 'compliance') }}</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for mapping in discrepancies|slice(0, 15) %}
                    {% set diff = mapping.calculatedPercentage - mapping.mappingPercentage %}
                    <tr>
                        <td>
                            <strong>{{ mapping.sourceRequirement.framework.code }}</strong>
                            {{ mapping.sourceRequirement.requirementId }}
                            →
                            <strong>{{ mapping.targetRequirement.framework.code }}</strong>
                            {{ mapping.targetRequirement.requirementId }}
                        </td>
                        <td class="text-center">
                            {% include '_components/_badge.html.twig' with { variant: 'secondary', content: mapping.mappingPercentage ~ '%' } %}
                        </td>
                        <td class="text-center">
                            {% include '_components/_badge.html.twig' with { variant: mapping.qualityScore >= 75 ? 'success' : (mapping.calculatedPercentage >= 50 ? 'warning' : 'danger'), content: mapping.calculatedPercentage ~ '%' } %}
                        </td>
                        <td class="text-center">
                            <strong class="{% if diff > 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ diff > 0 ? '+' : '' }}{{ diff }}%
                            </strong>
                        </td>
                        <td class="text-center">
                            {% include '_components/_badge.html.twig' with { variant: mapping.qualityScore >= 75 ? 'success' : (mapping.analysisConfidence >= 60 ? 'warning' : 'danger'), content: mapping.analysisConfidence } %}
                        </td>
                        <td>
                            <a href="{{ path('app_mapping_quality_review', {id: mapping.id}) }}" class="btn btn-sm btn-primary">
                                Review
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
            {% if discrepancies|length > 15 %}
                <p class="text-muted text-center mb-0">{{ 'compliance.mapping_quality.and_more'|trans({'%count%': discrepancies|length - 15}, 'compliance') }}</p>
            {% endif %}
        {% endblock %}
    {% endembed %}
    {% endif %}

    {# Empty State #}
    {% if mappings_requiring_review is empty and low_confidence_mappings is empty and discrepancies is empty %}
    <div class="alert alert-success">
        <h2><i class="bi bi-check-circle text-success" aria-hidden="true"></i> {{ 'compliance.mapping_quality.review_queue.no_review_needed.title'|trans({}, 'compliance') }}</h2>
        <p>{{ 'compliance.mapping_quality.review_queue.no_review_needed.desc'|trans({}, 'compliance') }}</p>
        <hr>
        <h3>{{ 'compliance.mapping_quality.review_queue.no_review_needed.status'|trans({}, 'compliance') }}</h3>
        <ul>
            <li><i class="bi bi-check-circle text-success" aria-hidden="true"></i> {{ 'compliance.mapping_quality.review_queue.no_review_needed.low_confidence_checked'|trans({}, 'compliance') }}</li>
            <li><i class="bi bi-check-circle text-success" aria-hidden="true"></i> {{ 'compliance.mapping_quality.review_queue.no_review_needed.no_discrepancies'|trans({}, 'compliance') }}</li>
            <li><i class="bi bi-check-circle text-success" aria-hidden="true"></i> {{ 'compliance.mapping_quality.review_queue.no_review_needed.queue_empty'|trans({}, 'compliance') }}</li>
        </ul>
        <a href="{{ path('app_mapping_quality_dashboard') }}" class="btn btn-primary mt-2">← {{ 'common.back'|trans({}, 'messages') }}</a>
    </div>
    {% endif %}
</div>

{% block javascripts %}
    {{ parent() }}
    <script>
        // Initialize Bootstrap tooltips
        document.addEventListener('DOMContentLoaded', function() {
            // Enable tooltips on badges
            const badges = document.querySelectorAll('.badge');
            badges.forEach(badge => {
                badge.setAttribute('data-bs-toggle', 'tooltip');
                badge.setAttribute('data-bs-placement', 'top');

                // Add helpful tooltips
                if (badge.textContent.includes('%')) {
                    badge.setAttribute('title', 'Mapping-Prozentsatz: Wie gut deckt das Source-Requirement das Target ab');
                }
                if (badge.classList.contains('badge-danger')) {
                    badge.setAttribute('title', 'Niedriger Wert - Manuelle Review empfohlen');
                }
                if (badge.classList.contains('badge-success')) {
                    badge.setAttribute('title', 'Hoher Wert - Gute Qualität');
                }
            });

            // Initialize all tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Add loading state to review buttons
            const reviewButtons = document.querySelectorAll('a.btn-primary');
            reviewButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {{ 'common.loading'|trans({}, 'messages') }}';
                    this.classList.add('disabled');
                });
            });
        });
    </script>
{% endblock %}
{% endblock %}
