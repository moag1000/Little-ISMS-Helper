{% extends 'base.html.twig' %}

{% block title %}Mapping Quality Dashboard{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
{% endblock %}

{% block body %}
{% import '_macros/cards.html.twig' as cards %}

<div class="container">
    <div class="page-header">
        <div>
            <h1>üîç Mapping Quality Dashboard</h1>
            <p class="text-muted">Automatisierte Qualit√§tsanalyse f√ºr Compliance-Mappings</p>
        </div>
        <div class="button-group">
            <a href="{{ path('app_mapping_quality_review_queue') }}" class="btn btn-primary">
                <span class="icon"><i class="bi bi-list-check" aria-hidden="true"></i></span> Review Queue
            </a>
            <a href="{{ path('app_mapping_quality_gaps') }}" class="btn btn-secondary">
                <span class="icon">üîç</span> Gap-√úbersicht
            </a>
            <a href="{{ path('app_compliance_index') }}" class="btn btn-secondary">
                <span class="icon">‚Üê</span> {{ 'common.back'|trans({}, 'messages') }}
            </a>
        </div>
    </div>

    {# Empty State for No Mappings #}
    {% if quality_stats.total_mappings == 0 %}
    <div class="alert alert-warning">
        <p class="fw-bold fs-5"><i class="bi bi-exclamation-triangle text-warning" aria-hidden="true"></i> Keine Mappings gefunden</p>
        <p>{{ 'compliance.mapping_quality.no_mappings_found'|trans({}, 'compliance') }}</p>
        <hr>
        <p class="fw-bold">N√§chste Schritte:</p>
        <ol>
            <li>Pr√ºfen Sie ob Frameworks importiert sind: <code>php bin/console app:list-frameworks</code></li>
            <li>Erstellen Sie Mappings: <code>php bin/console app:create-cross-framework-mappings</code></li>
            <li>Kehren Sie dann hierher zur√ºck</li>
        </ol>
        <a href="{{ path('app_compliance_index') }}" class="btn btn-primary mt-2">‚Üê {{ 'common.back'|trans({}, 'messages') }}</a>
    </div>
    {% elseif quality_stats.analyzed_mappings == 0 %}
    <div class="alert alert-info">
        <p class="fw-bold fs-5"><i class="bi bi-info-circle text-info" aria-hidden="true"></i> Noch keine Analyse durchgef√ºhrt</p>
        <p>{{ quality_stats.total_mappings }} Mappings gefunden, aber noch nicht analysiert.</p>
        <hr>
        <p class="fw-bold">Analyse starten:</p>
        <ol>
            <li>Sanity Check durchf√ºhren: <code>php bin/console app:mapping-quality:sanity-check</code></li>
            <li>Analyse starten: <code>php bin/console app:analyze-mapping-quality</code></li>
            <li>Seite neu laden</li>
        </ol>
    </div>
    {% endif %}

    {# Quality Statistics Cards #}
    {% if quality_stats.total_mappings > 0 %}
    <div class="row mb-4">
        <div class="col-md-3">
            {{ cards.kpi_card('Total Mappings', quality_stats.total_mappings, null, null, 'primary') }}
        </div>
        <div class="col-md-3">
            {{ cards.kpi_card('Analysiert', quality_stats.analyzed_mappings, quality_stats.analysis_coverage ~ '%', null, 'success') }}
        </div>
        <div class="col-md-3">
            {{ cards.kpi_card('Ben√∂tigt Review', quality_stats.requires_review, null, null, 'warning') }}
        </div>
        <div class="col-md-3">
            {{ cards.kpi_card('Mit Gaps', quality_stats.with_unresolved_gaps, null, null, 'danger') }}
        </div>
    </div>

    {# Average Scores #}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">‚≠ê Durchschnittliche Qualit√§t</h2>
                </div>
                <div class="card-body">
                    <div class="progress mb-2" style="height: 30px;">
                        <div class="progress-bar {% if quality_stats.avg_quality_score >= 75 %}bg-success{% elseif quality_stats.avg_quality_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                             role="progressbar"
                             style="width: {{ quality_stats.avg_quality_score }}%"
                             aria-valuenow="{{ quality_stats.avg_quality_score }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            <strong>{{ quality_stats.avg_quality_score }}%</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-bullseye" aria-hidden="true"></i> Durchschnittliches Confidence</h3>
                </div>
                <div class="card-body">
                    <div class="progress mb-2" style="height: 30px;">
                        <div class="progress-bar {% if quality_stats.avg_confidence >= 80 %}bg-success{% elseif quality_stats.avg_confidence >= 60 %}bg-warning{% else %}bg-danger{% endif %}"
                             role="progressbar"
                             style="width: {{ quality_stats.avg_confidence }}%"
                             aria-valuenow="{{ quality_stats.avg_confidence }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            <strong>{{ quality_stats.avg_confidence }}%</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Batch Analysis UI - Always visible #}
    <div class="card mb-4" id="batchAnalysisCard"
         data-controller="batch-analysis"
         data-batch-analysis-url-value="{{ path('app_mapping_quality_batch_analyze') }}"
         data-total-unanalyzed="{{ quality_stats.unanalyzed_mappings }}">
        <div class="card-header {% if quality_stats.unanalyzed_mappings > 0 %}bg-info{% else %}bg-secondary{% endif %} text-white">
            <h3 class="mb-0">üöÄ Mapping-Analyse</h3>
        </div>
        <div class="card-body">
            {% if quality_stats.unanalyzed_mappings > 0 %}
            <p class="mb-3">
                <strong>{{ quality_stats.unanalyzed_mappings }} Mappings</strong> warten auf Analyse.
                Starten Sie die Analyse in kleineren Batches direkt hier in der UI.
            </p>
            {% else %}
            <p class="mb-3">
                <span class="badge bg-success me-2">‚úì Alle Mappings analysiert</span>
                Sie k√∂nnen eine Re-Analyse starten um die Qualit√§tswerte mit dem neuesten Algorithmus neu zu berechnen.
            </p>
            {% endif %}

            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group me-2" role="group" aria-label="{{ 'compliance.mapping_quality.quick_analysis'|trans({}, 'compliance') }}">
                            <button type="button" class="btn btn-outline-primary"
                                    data-action="click->batch-analysis#start"
                                    data-batch-analysis-count-param="10"
                                    data-batch-analysis-force-param="false">
                                <i class="bi bi-play-circle" aria-hidden="true"></i> 10 analysieren
                            </button>
                            <button type="button" class="btn btn-outline-primary"
                                    data-action="click->batch-analysis#start"
                                    data-batch-analysis-count-param="25"
                                    data-batch-analysis-force-param="false">
                                <i class="bi bi-play-circle" aria-hidden="true"></i> 25 analysieren
                            </button>
                            <button type="button" class="btn btn-outline-primary"
                                    data-action="click->batch-analysis#start"
                                    data-batch-analysis-count-param="50"
                                    data-batch-analysis-force-param="false">
                                <i class="bi bi-play-circle" aria-hidden="true"></i> 50 analysieren
                            </button>
                        </div>
                        <div class="btn-group me-2" role="group" aria-label="{{ 'compliance.mapping_quality.full_analysis'|trans({}, 'compliance') }}">
                            <button type="button" class="btn btn-success"
                                    data-action="click->batch-analysis#start"
                                    data-batch-analysis-count-param="all"
                                    data-batch-analysis-force-param="false">
                                <i class="bi bi-lightning-charge" aria-hidden="true"></i> Alle analysieren
                            </button>
                        </div>
                        {% if quality_stats.analyzed_mappings > 0 %}
                        <div class="btn-group" role="group" aria-label="{{ 'compliance.mapping_quality.re_analysis'|trans({}, 'compliance') }}">
                            <button type="button" class="btn btn-outline-warning"
                                    data-action="click->batch-analysis#start"
                                    data-batch-analysis-count-param="all"
                                    data-batch-analysis-force-param="true"
                                    title="{{ 'compliance.mapping_quality.re_analyze_title'|trans({}, 'compliance') }}">
                                <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> {{ 'compliance.mapping_quality.re_analyze_button'|trans({}, 'compliance') }}
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Progress Section (hidden initially) #}
            <div data-batch-analysis-target="progress" style="display: none;">
                <hr>
                <p class="fw-bold fs-5 mb-3">{{ 'compliance.mapping_quality.analysis_running'|trans({}, 'compliance') }}</p>

                <div class="progress mb-3" style="height: 30px;">
                    <div data-batch-analysis-target="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                         role="progressbar" style="width: 0%">
                        <strong data-batch-analysis-target="progressText">0%</strong>
                    </div>
                </div>

                <div class="row text-center mb-3">
                    <div class="col-md-3">
                        <small class="text-muted">Analysiert</small>
                        <div class="fw-bold h5" data-batch-analysis-target="analyzedCount">0</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Verbleibend</small>
                        <div class="fw-bold h5" data-batch-analysis-target="remainingCount">{{ quality_stats.unanalyzed_mappings }}</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Fehler</small>
                        <div class="fw-bold h5 text-danger" data-batch-analysis-target="errorCount">0</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Status</small>
                        <div class="fw-bold h5 text-info" data-batch-analysis-target="statusText">Bereit</div>
                    </div>
                </div>

                <button type="button" class="btn btn-danger btn-sm"
                        data-action="click->batch-analysis#cancel"
                        data-batch-analysis-target="cancelBtn">
                    <i class="bi bi-pause-circle" aria-hidden="true"></i> {{ 'common.cancel'|trans({}, 'messages') }}
                </button>

                <div data-batch-analysis-target="log" class="mt-3" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #f5f5f5; padding: 10px; border-radius: 4px; display: none;">
                </div>
            </div>

            {# Results Section (shown after completion) #}
            <div data-batch-analysis-target="results" style="display: none;">
                <hr>
                <div class="alert alert-success">
                    <p class="fw-bold"><i class="bi bi-check-circle text-success" aria-hidden="true"></i> Analyse abgeschlossen!</p>
                    <p data-batch-analysis-target="resultsMessage"></p>
                    <button type="button" class="btn btn-primary mt-2" data-controller="ui-actions" data-action="ui-actions#reload">
                        <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> Seite neu laden
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# Charts Row #}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">üìä Confidence-Verteilung</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="confidenceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">üîç Gap-Statistiken nach Priorit√§t</h3>
                </div>
                <div class="card-body">
                    {% if gap_stats is empty %}
                        <p class="text-muted text-center">Keine Gap-Daten verf√ºgbar</p>
                    {% else %}
                        <div class="chart-container">
                            <canvas id="gapStatsChart"></canvas>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Framework Comparison #}
    {% if framework_comparison is not empty %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0">üåç Framework-Qualit√§tsvergleich (Top 10)</h3>
        </div>
        <div class="card-body">
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover',
                'noMargin': true,
                'responsive': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">Source Framework</th>
                        <th scope="col">Target Framework</th>
                        <th scope="col" class="text-center">Mappings</th>
                        <th scope="col" class="text-center">√ò Percentage</th>
                        <th scope="col" class="text-center">√ò Quality</th>
                        <th scope="col" class="text-center">√ò Confidence</th>
                        <th scope="col" class="text-center">Review n√∂tig</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for comparison in framework_comparison|slice(0, 10) %}
                    <tr>
                        <td><strong>{{ comparison.source_framework }}</strong></td>
                        <td>{{ comparison.target_framework }}</td>
                        <td class="text-center">{{ comparison.mapping_count }}</td>
                        <td class="text-center">
                            <span class="badge {% if comparison.avg_percentage >= 70 %}bg-success{% elseif comparison.avg_percentage >= 50 %}badge-warning{% else %}bg-danger{% endif %}">
                                {{ comparison.avg_percentage|round }}%
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="badge {% if comparison.avg_quality >= 70 %}bg-success{% elseif comparison.avg_quality >= 50 %}badge-warning{% else %}bg-danger{% endif %}">
                                {{ comparison.avg_quality|round }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="badge {% if comparison.avg_confidence >= 80 %}bg-success{% elseif comparison.avg_confidence >= 60 %}badge-warning{% else %}bg-danger{% endif %}">
                                {{ comparison.avg_confidence|round }}
                            </span>
                        </td>
                        <td class="text-center">
                            {% if comparison.review_count > 0 %}
                                <span class="badge bg-warning">{{ comparison.review_count }}</span>
                            {% else %}
                                <span class="text-success">‚úì</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
        </div>
    </div>
    {% endif %}

    {# Help Box #}
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h2 class="mb-0"><i class="bi bi-info-circle text-info" aria-hidden="true"></i> Wie funktioniert die Qualit√§tsanalyse?</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <p class="fw-bold fs-5"><i class="bi bi-bullseye" aria-hidden="true"></i> Confidence Score</p>
                    <p class="small">Misst die Zuverl√§ssigkeit der automatischen Analyse:</p>
                    <ul class="small">
                        <li><strong>High (‚â•80):</strong> Sehr zuverl√§ssig, kann auto-approved werden</li>
                        <li><strong>Medium (60-79):</strong> Gute Basis, optionale Review</li>
                        <li><strong>Low (<60):</strong> Unsicher, manuelle Review erforderlich</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <p class="fw-bold fs-5">‚≠ê Quality Score</p>
                    <p class="small">Gesamtqualit√§t des Mappings basierend auf:</p>
                    <ul class="small">
                        <li>Confidence (40%)</li>
                        <li>Mapping Percentage (30%)</li>
                        <li>Verification Status (30%)</li>
                    </ul>
                    <p class="small mb-0"><strong>Ziel:</strong> Alle Mappings ‚â•75 Quality Score</p>
                </div>
                <div class="col-md-4">
                    <p class="fw-bold fs-5">üî¨ Similarity Metriken</p>
                    <p class="small">Automatische Berechnung durch:</p>
                    <ul class="small">
                        <li><strong>Keyword Overlap (40%):</strong> Sicherheitsbegriffe</li>
                        <li><strong>Textual Similarity (35%):</strong> Jaccard & Cosine</li>
                        <li><strong>Structural Similarity (25%):</strong> Kategorie, Priorit√§t</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# Quick Actions - Show only if mappings exist #}
    {% if quality_stats.total_mappings > 0 %}
    <div class="alert alert-info">
        <p class="fw-bold">üöÄ N√§chste Schritte</p>
        <ul class="mb-0">
            <li><a href="{{ path('app_mapping_quality_review_queue') }}">Review Queue ansehen</a> - Pr√ºfen Sie Mappings mit niedrigem Confidence</li>
            <li><a href="{{ path('app_mapping_quality_gaps') }}">Gap-√úbersicht</a> - Identifizierte L√ºcken adressieren</li>
            {% if quality_stats.unanalyzed_mappings > 0 %}
            <li><strong>{{ quality_stats.unanalyzed_mappings }} Mappings noch nicht analysiert</strong> - F√ºhren Sie <code>php bin/console app:analyze-mapping-quality</code> aus</li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Confidence Distribution Donut Chart
        const confidenceCtx = document.getElementById('confidenceChart');
        if (confidenceCtx) {
            new Chart(confidenceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['High (‚â•80)', 'Medium (60-79)', 'Low (<60)'],
                    datasets: [{
                        data: [
                            {{ quality_stats.high_confidence }},
                            {{ quality_stats.medium_confidence }},
                            {{ quality_stats.low_confidence }}
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107',
                            '#dc3545'
                        ],
                        borderColor: [
                            '#28a745',
                            '#ffc107',
                            '#dc3545'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gap Stats Bar Chart
        const gapStatsCtx = document.getElementById('gapStatsChart');
        if (gapStatsCtx) {
            {% if gap_stats is not empty %}
            const gapLabels = [
                {% for stat in gap_stats %}
                    '{{ stat.priority|upper }}'{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            const gapCounts = [
                {% for stat in gap_stats %}
                    {{ stat.count }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            const gapImpacts = [
                {% for stat in gap_stats %}
                    {{ stat.totalImpact|round }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            const gapEfforts = [
                {% for stat in gap_stats %}
                    {{ stat.avgEffort|round(1) }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ];

            const backgroundColors = gapLabels.map(label => {
                if (label === 'CRITICAL') return '#721c24';
                if (label === 'HIGH') return '#dc3545';
                if (label === 'MEDIUM') return '#ffc107';
                return '#6c757d';
            });

            new Chart(gapStatsCtx, {
                type: 'bar',
                data: {
                    labels: gapLabels,
                    datasets: [{
                        label: 'Anzahl Gaps',
                        data: gapCounts,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return [
                                        'Impact: ' + gapImpacts[index] + '%',
                                        '√ò Effort: ' + gapEfforts[index] + 'h'
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            {% endif %}
        }

        // Batch analysis is now handled by batch-analysis Stimulus controller
    </script>
{% endblock %}
