{% extends 'base.html.twig' %}

{% block title %}{{ 'compliance.mapping_quality.title'|trans({}, 'compliance') }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
{% endblock %}

{% block body %}
{% import '_macros/cards.html.twig' as cards %}

<div class="container">
    <div class="page-header">
        <div>
            <h1>üîç {{ 'compliance.mapping_quality.title'|trans({}, 'compliance') }}</h1>
            <p class="text-muted">{{ 'compliance.mapping_quality.subtitle'|trans({}, 'compliance') }}</p>
        </div>
        <div class="button-group">
            <a href="{{ path('app_mapping_quality_review_queue') }}" class="btn btn-primary">
                <span class="icon"><i class="bi bi-list-check" aria-hidden="true"></i></span> {{ 'compliance.mapping_quality.review_queue.title'|trans({}, 'compliance') }}
            </a>
            <a href="{{ path('app_mapping_quality_gaps') }}" class="btn btn-secondary">
                <span class="icon">üîç</span> {{ 'compliance.mapping_quality.gaps.title'|trans({}, 'compliance') }}
            </a>
            <a href="{{ path('app_compliance_index') }}" class="btn btn-secondary">
                <span class="icon">‚Üê</span> {{ 'common.back'|trans({}, 'messages') }}
            </a>
        </div>
    </div>

    {# Empty State for No Mappings #}
    {% if quality_stats.total_mappings == 0 %}
    <div class="alert alert-warning">
        <p class="fw-bold fs-5"><i class="bi bi-exclamation-triangle text-warning" aria-hidden="true"></i> {{ 'compliance.mapping_quality.no_mappings'|trans({}, 'compliance') }}</p>
        <p>{{ 'compliance.mapping_quality.no_mappings_found'|trans({}, 'compliance') }}</p>
        <hr>
        <p class="fw-bold">{{ 'compliance.mapping_quality.next_steps.title'|trans({}, 'compliance') }}:</p>
        <ol>
            <li>{{ 'compliance.mapping_quality.next_steps.check_frameworks'|trans({}, 'compliance')|raw }}</li>
            <li>{{ 'compliance.mapping_quality.next_steps.create_mappings'|trans({}, 'compliance')|raw }}</li>
            <li>{{ 'compliance.mapping_quality.next_steps.return_here'|trans({}, 'compliance') }}</li>
        </ol>
        <a href="{{ path('app_compliance_index') }}" class="btn btn-primary mt-2">‚Üê {{ 'common.back'|trans({}, 'messages') }}</a>
    </div>
    {% elseif quality_stats.analyzed_mappings == 0 %}
    <div class="alert alert-info">
        <p class="fw-bold fs-5"><i class="bi bi-info-circle text-info" aria-hidden="true"></i> {{ 'compliance.mapping_quality.no_analysis_yet.title'|trans({}, 'compliance') }}</p>
        <p>{{ 'compliance.mapping_quality.no_analysis_yet.found_not_analyzed'|trans({'%count%': quality_stats.total_mappings}, 'compliance') }}</p>
        <hr>
        <p class="fw-bold">{{ 'compliance.mapping_quality.no_analysis_yet.start_analysis'|trans({}, 'compliance') }}</p>
        <ol>
            <li>{{ 'compliance.mapping_quality.no_analysis_yet.sanity_check'|trans({}, 'compliance')|raw }}</li>
            <li>{{ 'compliance.mapping_quality.no_analysis_yet.run_analysis'|trans({}, 'compliance')|raw }}</li>
            <li>{{ 'compliance.mapping_quality.no_analysis_yet.reload_page'|trans({}, 'compliance') }}</li>
        </ol>
    </div>
    {% endif %}

    {# Quality Statistics Cards #}
    {% if quality_stats.total_mappings > 0 %}
    <div class="row mb-4">
        <div class="col-md-3">
            {{ cards.kpi_card('compliance.stats.total_mappings'|trans({}, 'compliance'), quality_stats.total_mappings, null, null, 'primary') }}
        </div>
        <div class="col-md-3">
            {{ cards.kpi_card('compliance.mapping_quality.progress.analyzed'|trans({}, 'compliance'), quality_stats.analyzed_mappings, quality_stats.analysis_coverage ~ '%', null, 'success') }}
        </div>
        <div class="col-md-3">
            {{ cards.kpi_card('compliance.mapping_quality.needs_urgent_review'|trans({}, 'compliance'), quality_stats.requires_review, null, null, 'warning') }}
        </div>
        <div class="col-md-3">
            {{ cards.kpi_card('compliance.mapping_quality.column.gaps'|trans({}, 'compliance'), quality_stats.with_unresolved_gaps, null, null, 'danger') }}
        </div>
    </div>

    {# Average Scores #}
    <div class="row mb-4">
        <div class="col-md-6">
            {% embed '_components/_card.html.twig' %}
                {% block card_header %}
                    <div class="card-header">
                        <h2 class="mb-0">{{ 'compliance.mapping_quality.avg_quality'|trans({}, 'compliance') }}</h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <div class="progress mb-2" style="height: 30px;">
                        <div class="progress-bar {% if quality_stats.avg_quality_score >= 75 %}bg-success{% elseif quality_stats.avg_quality_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                             role="progressbar"
                             style="width: {{ quality_stats.avg_quality_score }}%"
                             aria-valuenow="{{ quality_stats.avg_quality_score }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            <strong>{{ quality_stats.avg_quality_score }}%</strong>
                        </div>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>
        <div class="col-md-6">
            {% embed '_components/_card.html.twig' %}
                {% block card_header %}
                    <div class="card-header">
                        <h3 class="mb-0"><i class="bi bi-bullseye" aria-hidden="true"></i> {{ 'compliance.mapping_quality.avg_confidence'|trans({}, 'compliance') }}</h3>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <div class="progress mb-2" style="height: 30px;">
                        <div class="progress-bar {% if quality_stats.avg_confidence >= 80 %}bg-success{% elseif quality_stats.avg_confidence >= 60 %}bg-warning{% else %}bg-danger{% endif %}"
                             role="progressbar"
                             style="width: {{ quality_stats.avg_confidence }}%"
                             aria-valuenow="{{ quality_stats.avg_confidence }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            <strong>{{ quality_stats.avg_confidence }}%</strong>
                        </div>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>
    </div>

    {# Batch Analysis UI - Always visible #}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_attrs %}id="batchAnalysisCard" data-controller="batch-analysis" data-batch-analysis-url-value="{{ path('app_mapping_quality_batch_analyze') }}" data-total-unanalyzed="{{ quality_stats.unanalyzed_mappings }}"{% endblock %}
        {% block card_header %}
            <div class="card-header {% if quality_stats.unanalyzed_mappings > 0 %}bg-info{% else %}bg-secondary{% endif %} text-white">
                <h3 class="mb-0">{{ 'compliance.mapping_quality.batch_analysis.title'|trans({}, 'compliance') }}</h3>
            </div>
        {% endblock %}
        {% block card_body %}
            {% if quality_stats.unanalyzed_mappings > 0 %}
            <p class="mb-3">
                {{ 'compliance.mapping_quality.batch_analysis.waiting'|trans({'%count%': quality_stats.unanalyzed_mappings}, 'compliance')|raw }}
            </p>
            {% else %}
            <p class="mb-3">
                {% include '_components/_badge.html.twig' with { variant: 'success', class: 'me-2', content: '‚úì ' ~ 'compliance.mapping_quality.batch_analysis.all_analyzed'|trans({}, 'compliance') } %}
                {{ 'compliance.mapping_quality.batch_analysis.all_analyzed_desc'|trans({}, 'compliance') }}
            </p>
            {% endif %}

            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group me-2" role="group" aria-label="{{ 'compliance.mapping_quality.quick_analysis'|trans({}, 'compliance') }}">
                            <button type="button" class="btn btn-outline-primary"
                                    data-action="click->batch-analysis#start"
                                    data-batch-analysis-count-param="10"
                                    data-batch-analysis-force-param="false">
                                <i class="bi bi-play-circle" aria-hidden="true"></i> {{ 'compliance.mapping_quality.batch_analysis.analyze_count'|trans({'%count%': 10}, 'compliance') }}
                            </button>
                            <button type="button" class="btn btn-outline-primary"
                                    data-action="click->batch-analysis#start"
                                    data-batch-analysis-count-param="25"
                                    data-batch-analysis-force-param="false">
                                <i class="bi bi-play-circle" aria-hidden="true"></i> {{ 'compliance.mapping_quality.batch_analysis.analyze_count'|trans({'%count%': 25}, 'compliance') }}
                            </button>
                            <button type="button" class="btn btn-outline-primary"
                                    data-action="click->batch-analysis#start"
                                    data-batch-analysis-count-param="50"
                                    data-batch-analysis-force-param="false">
                                <i class="bi bi-play-circle" aria-hidden="true"></i> {{ 'compliance.mapping_quality.batch_analysis.analyze_count'|trans({'%count%': 50}, 'compliance') }}
                            </button>
                        </div>
                        <div class="btn-group me-2" role="group" aria-label="{{ 'compliance.mapping_quality.full_analysis'|trans({}, 'compliance') }}">
                            <button type="button" class="btn btn-success"
                                    data-action="click->batch-analysis#start"
                                    data-batch-analysis-count-param="all"
                                    data-batch-analysis-force-param="false">
                                <i class="bi bi-lightning-charge" aria-hidden="true"></i> {{ 'compliance.mapping_quality.batch_analysis.analyze_all'|trans({}, 'compliance') }}
                            </button>
                        </div>
                        {% if quality_stats.analyzed_mappings > 0 %}
                        <div class="btn-group" role="group" aria-label="{{ 'compliance.mapping_quality.re_analysis'|trans({}, 'compliance') }}">
                            <button type="button" class="btn btn-outline-warning"
                                    data-action="click->batch-analysis#start"
                                    data-batch-analysis-count-param="all"
                                    data-batch-analysis-force-param="true"
                                    title="{{ 'compliance.mapping_quality.re_analyze_title'|trans({}, 'compliance') }}">
                                <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> {{ 'compliance.mapping_quality.re_analyze_button'|trans({}, 'compliance') }}
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Progress Section (hidden initially) #}
            <div data-batch-analysis-target="progress" style="display: none;">
                <hr>
                <p class="fw-bold fs-5 mb-3">{{ 'compliance.mapping_quality.analysis_running'|trans({}, 'compliance') }}</p>

                <div class="progress mb-3" style="height: 30px;">
                    <div data-batch-analysis-target="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                         role="progressbar" style="width: 0%">
                        <strong data-batch-analysis-target="progressText">0%</strong>
                    </div>
                </div>

                <div class="row text-center mb-3">
                    <div class="col-md-3">
                        <small class="text-muted">{{ 'compliance.mapping_quality.progress.analyzed'|trans({}, 'compliance') }}</small>
                        <div class="fw-bold h5" data-batch-analysis-target="analyzedCount">0</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">{{ 'compliance.mapping_quality.progress.remaining'|trans({}, 'compliance') }}</small>
                        <div class="fw-bold h5" data-batch-analysis-target="remainingCount">{{ quality_stats.unanalyzed_mappings }}</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">{{ 'compliance.mapping_quality.progress.errors'|trans({}, 'compliance') }}</small>
                        <div class="fw-bold h5 text-danger" data-batch-analysis-target="errorCount">0</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">{{ 'compliance.mapping_quality.progress.status'|trans({}, 'compliance') }}</small>
                        <div class="fw-bold h5 text-info" data-batch-analysis-target="statusText">{{ 'compliance.mapping_quality.progress.ready'|trans({}, 'compliance') }}</div>
                    </div>
                </div>

                <button type="button" class="btn btn-danger btn-sm"
                        data-action="click->batch-analysis#cancel"
                        data-batch-analysis-target="cancelBtn">
                    <i class="bi bi-pause-circle" aria-hidden="true"></i> {{ 'common.cancel'|trans({}, 'messages') }}
                </button>

                <div data-batch-analysis-target="log" class="mt-3" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #f5f5f5; padding: 10px; border-radius: 4px; display: none;">
                </div>
            </div>

            {# Results Section (shown after completion) #}
            <div data-batch-analysis-target="results" style="display: none;">
                <hr>
                <div class="alert alert-success">
                    <p class="fw-bold"><i class="bi bi-check-circle text-success" aria-hidden="true"></i> {{ 'compliance.mapping_quality.progress.complete'|trans({}, 'compliance') }}</p>
                    <p data-batch-analysis-target="resultsMessage"></p>
                    <button type="button" class="btn btn-primary mt-2" data-controller="ui-actions" data-action="ui-actions#reload">
                        <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> {{ 'compliance.mapping_quality.progress.reload'|trans({}, 'compliance') }}
                    </button>
                </div>
            </div>
        {% endblock %}
    {% endembed %}

    {# Charts Row #}
    <div class="row mb-4">
        <div class="col-md-6">
            {% embed '_components/_card.html.twig' %}
                {% block card_header %}
                    <div class="card-header">
                        <h3 class="mb-0">{{ 'compliance.mapping_quality.charts.confidence_distribution'|trans({}, 'compliance') }}</h3>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <div class="chart-container">
                        <canvas id="confidenceChart"></canvas>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>

        <div class="col-md-6">
            {% embed '_components/_card.html.twig' %}
                {% block card_header %}
                    <div class="card-header">
                        <h3 class="mb-0">{{ 'compliance.mapping_quality.charts.gap_stats_priority'|trans({}, 'compliance') }}</h3>
                    </div>
                {% endblock %}
                {% block card_body %}
                    {% if gap_stats is empty %}
                        <p class="text-muted text-center">{{ 'compliance.mapping_quality.no_gap_data'|trans({}, 'compliance') }}</p>
                    {% else %}
                        <div class="chart-container">
                            <canvas id="gapStatsChart"></canvas>
                        </div>
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>
    </div>

    {# Framework Comparison #}
    {% if framework_comparison is not empty %}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_header %}
            <div class="card-header">
                <h3 class="mb-0">{{ 'compliance.mapping_quality.framework_comparison'|trans({}, 'compliance') }}</h3>
            </div>
        {% endblock %}
        {% block card_body %}
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover',
                'noMargin': true,
                'responsive': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">{{ 'compliance.mapping_quality.column.source_framework'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.mapping_quality.column.target_framework'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.mappings'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.avg_percentage'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.avg_quality'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.avg_confidence'|trans({}, 'compliance') }}</th>
                        <th scope="col" class="text-center">{{ 'compliance.mapping_quality.column.review_needed'|trans({}, 'compliance') }}</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for comparison in framework_comparison|slice(0, 10) %}
                    <tr>
                        <td><strong>{{ comparison.source_framework }}</strong></td>
                        <td>{{ comparison.target_framework }}</td>
                        <td class="text-center">{{ comparison.mapping_count }}</td>
                        <td class="text-center">
                            {% include '_components/_badge.html.twig' with {
                                variant: comparison.avg_percentage >= 70 ? 'success' : (comparison.avg_percentage >= 50 ? 'warning' : 'danger'),
                                content: comparison.avg_percentage|round ~ '%'
                            } %}
                        </td>
                        <td class="text-center">
                            {% include '_components/_badge.html.twig' with {
                                variant: comparison.avg_quality >= 70 ? 'success' : (comparison.avg_quality >= 50 ? 'warning' : 'danger'),
                                content: comparison.avg_quality|round
                            } %}
                        </td>
                        <td class="text-center">
                            {% include '_components/_badge.html.twig' with {
                                variant: comparison.avg_confidence >= 80 ? 'success' : (comparison.avg_confidence >= 60 ? 'warning' : 'danger'),
                                content: comparison.avg_confidence|round
                            } %}
                        </td>
                        <td class="text-center">
                            {% if comparison.review_count > 0 %}
                                {% include '_components/_badge.html.twig' with { variant: 'warning', content: comparison.review_count } %}
                            {% else %}
                                <span class="text-success">‚úì</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
        {% endblock %}
    {% endembed %}
    {% endif %}

    {# Help Box #}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_header %}
            <div class="card-header bg-light">
                <h2 class="mb-0"><i class="bi bi-info-circle text-info" aria-hidden="true"></i> {{ 'compliance.mapping_quality.help.title'|trans({}, 'compliance') }}</h2>
            </div>
        {% endblock %}
        {% block card_body %}
            <div class="row">
                <div class="col-md-4">
                    <p class="fw-bold fs-5"><i class="bi bi-bullseye" aria-hidden="true"></i> {{ 'compliance.mapping_quality.help.confidence_score.title'|trans({}, 'compliance') }}</p>
                    <p class="small">{{ 'compliance.mapping_quality.help.confidence_score.desc'|trans({}, 'compliance') }}</p>
                    <ul class="small">
                        <li>{{ 'compliance.mapping_quality.help.confidence_score.high'|trans({}, 'compliance')|raw }}</li>
                        <li>{{ 'compliance.mapping_quality.help.confidence_score.medium'|trans({}, 'compliance')|raw }}</li>
                        <li>{{ 'compliance.mapping_quality.help.confidence_score.low'|trans({}, 'compliance')|raw }}</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <p class="fw-bold fs-5">{{ 'compliance.mapping_quality.help.quality_score.title'|trans({}, 'compliance') }}</p>
                    <p class="small">{{ 'compliance.mapping_quality.help.quality_score.desc'|trans({}, 'compliance') }}</p>
                    <ul class="small">
                        <li>{{ 'compliance.mapping_quality.help.quality_score.confidence'|trans({}, 'compliance') }}</li>
                        <li>{{ 'compliance.mapping_quality.help.quality_score.percentage'|trans({}, 'compliance') }}</li>
                        <li>{{ 'compliance.mapping_quality.help.quality_score.verification'|trans({}, 'compliance') }}</li>
                    </ul>
                    <p class="small mb-0">{{ 'compliance.mapping_quality.help.quality_score.goal'|trans({}, 'compliance')|raw }}</p>
                </div>
                <div class="col-md-4">
                    <p class="fw-bold fs-5">{{ 'compliance.mapping_quality.help.similarity.title'|trans({}, 'compliance') }}</p>
                    <p class="small">{{ 'compliance.mapping_quality.help.similarity.desc'|trans({}, 'compliance') }}</p>
                    <ul class="small">
                        <li>{{ 'compliance.mapping_quality.help.similarity.keyword'|trans({}, 'compliance')|raw }}</li>
                        <li>{{ 'compliance.mapping_quality.help.similarity.textual'|trans({}, 'compliance')|raw }}</li>
                        <li>{{ 'compliance.mapping_quality.help.similarity.structural'|trans({}, 'compliance')|raw }}</li>
                    </ul>
                </div>
            </div>
        {% endblock %}
    {% endembed %}
    {% endif %}

    {# Quick Actions - Show only if mappings exist #}
    {% if quality_stats.total_mappings > 0 %}
    <div class="alert alert-info">
        <p class="fw-bold">{{ 'compliance.mapping_quality.next_actions.title'|trans({}, 'compliance') }}</p>
        <ul class="mb-0">
            <li><a href="{{ path('app_mapping_quality_review_queue') }}">{{ 'compliance.mapping_quality.next_actions.review_queue'|trans({}, 'compliance') }}</a> - {{ 'compliance.mapping_quality.next_actions.review_queue_desc'|trans({}, 'compliance') }}</li>
            <li><a href="{{ path('app_mapping_quality_gaps') }}">{{ 'compliance.mapping_quality.next_actions.gap_overview'|trans({}, 'compliance') }}</a> - {{ 'compliance.mapping_quality.next_actions.gap_overview_desc'|trans({}, 'compliance') }}</li>
            {% if quality_stats.unanalyzed_mappings > 0 %}
            <li>{{ 'compliance.mapping_quality.next_actions.unanalyzed'|trans({'%count%': quality_stats.unanalyzed_mappings}, 'compliance')|raw }}</li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Confidence Distribution Donut Chart
        const confidenceCtx = document.getElementById('confidenceChart');
        if (confidenceCtx) {
            new Chart(confidenceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['High (‚â•80)', 'Medium (60-79)', 'Low (<60)'],
                    datasets: [{
                        data: [
                            {{ quality_stats.high_confidence }},
                            {{ quality_stats.medium_confidence }},
                            {{ quality_stats.low_confidence }}
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107',
                            '#dc3545'
                        ],
                        borderColor: [
                            '#28a745',
                            '#ffc107',
                            '#dc3545'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gap Stats Bar Chart
        const gapStatsCtx = document.getElementById('gapStatsChart');
        if (gapStatsCtx) {
            {% if gap_stats is not empty %}
            const gapLabels = [
                {% for stat in gap_stats %}
                    '{{ stat.priority|upper }}'{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            const gapCounts = [
                {% for stat in gap_stats %}
                    {{ stat.count }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            const gapImpacts = [
                {% for stat in gap_stats %}
                    {{ stat.totalImpact|round }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            const gapEfforts = [
                {% for stat in gap_stats %}
                    {{ stat.avgEffort|round(1) }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ];

            const backgroundColors = gapLabels.map(label => {
                if (label === 'CRITICAL') return '#721c24';
                if (label === 'HIGH') return '#dc3545';
                if (label === 'MEDIUM') return '#ffc107';
                return '#6c757d';
            });

            new Chart(gapStatsCtx, {
                type: 'bar',
                data: {
                    labels: gapLabels,
                    datasets: [{
                        label: 'Anzahl Gaps',
                        data: gapCounts,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return [
                                        'Impact: ' + gapImpacts[index] + '%',
                                        '√ò Effort: ' + gapEfforts[index] + 'h'
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            {% endif %}
        }

        // Batch analysis is now handled by batch-analysis Stimulus controller
    </script>
{% endblock %}
