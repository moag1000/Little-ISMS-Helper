{% extends 'base.html.twig' %}

{% block title %}Mapping Review #{{ mapping.id }}{% endblock %}

{% block body %}
<div class="container">
    <div class="page-header">
        <div>
            <h1>üîç Mapping Review #{{ mapping.id }}</h1>
            <p class="text-muted">Detaillierte Analyse und Review</p>
        </div>
        <div class="button-group">
            <a href="{{ path('app_mapping_quality_review_queue') }}" class="btn btn-secondary">
                <span class="icon">‚Üê</span> Zur√ºck zur Queue
            </a>
            <button type="button" class="btn btn-info" onclick="reanalyzeMapping()">
                <span class="icon">üîÑ</span> Neu analysieren
            </button>
        </div>
    </div>

    {# Mapping Overview #}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üìä Mapping-√úbersicht</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-5">
                    <h6 class="text-muted">Source Requirement</h6>
                    <h5><span class="badge badge-primary">{{ mapping.sourceRequirement.framework.code }}</span> {{ mapping.sourceRequirement.requirementId }}</h5>
                    <p><strong>{{ mapping.sourceRequirement.title }}</strong></p>
                    <p class="text-muted small">{{ mapping.sourceRequirement.description|slice(0, 200) }}...</p>
                    {% if mapping.sourceRequirement.category %}
                        <span class="badge badge-info">{{ mapping.sourceRequirement.category }}</span>
                    {% endif %}
                    {% if mapping.sourceRequirement.priority %}
                        <span class="badge badge-{{ mapping.sourceRequirement.priority == 'critical' ? 'danger' : (mapping.sourceRequirement.priority == 'high' ? 'warning' : 'secondary') }}">
                            {{ mapping.sourceRequirement.priority|upper }}
                        </span>
                    {% endif %}
                </div>
                <div class="col-md-2 text-center d-flex align-items-center justify-content-center">
                    <h3>‚Üí</h3>
                </div>
                <div class="col-md-5">
                    <h6 class="text-muted">Target Requirement</h6>
                    <h5><span class="badge badge-success">{{ mapping.targetRequirement.framework.code }}</span> {{ mapping.targetRequirement.requirementId }}</h5>
                    <p><strong>{{ mapping.targetRequirement.title }}</strong></p>
                    <p class="text-muted small">{{ mapping.targetRequirement.description|slice(0, 200) }}...</p>
                    {% if mapping.targetRequirement.category %}
                        <span class="badge badge-info">{{ mapping.targetRequirement.category }}</span>
                    {% endif %}
                    {% if mapping.targetRequirement.priority %}
                        <span class="badge badge-{{ mapping.targetRequirement.priority == 'critical' ? 'danger' : (mapping.targetRequirement.priority == 'high' ? 'warning' : 'secondary') }}">
                            {{ mapping.targetRequirement.priority|upper }}
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Quality Metrics #}
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">üìà Prozents√§tze</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Original (Heuristik)</small>
                        <h4><span class="badge badge-secondary">{{ mapping.mappingPercentage }}%</span></h4>
                    </div>
                    {% if mapping.calculatedPercentage is not null %}
                    <div class="mb-3">
                        <small class="text-muted">Berechnet (Automatisch)</small>
                        <h4><span class="badge {% if mapping.calculatedPercentage >= 75 %}badge-success{% elseif mapping.calculatedPercentage >= 50 %}badge-warning{% else %}badge-danger{% endif %}">
                            {{ mapping.calculatedPercentage }}%
                        </span></h4>
                    </div>
                    {% endif %}
                    {% if mapping.manualPercentage is not null %}
                    <div>
                        <small class="text-muted">Manuell √ºberschrieben</small>
                        <h4><span class="badge badge-info">{{ mapping.manualPercentage }}%</span></h4>
                    </div>
                    {% endif %}
                    <hr>
                    <div>
                        <strong>Final:</strong>
                        <h3><span class="badge badge-primary">{{ mapping.finalPercentage }}%</span></h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">‚≠ê Quality & Confidence</h6>
                </div>
                <div class="card-body">
                    {% if mapping.qualityScore is not null %}
                    <div class="mb-3">
                        <small class="text-muted">Quality Score</small>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar {% if mapping.qualityScore >= 75 %}bg-success{% elseif mapping.qualityScore >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                                 style="width: {{ mapping.qualityScore }}%">
                                <strong>{{ mapping.qualityScore }}</strong>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if mapping.analysisConfidence is not null %}
                    <div class="mb-3">
                        <small class="text-muted">Analysis Confidence</small>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar {% if mapping.analysisConfidence >= 80 %}bg-success{% elseif mapping.analysisConfidence >= 60 %}bg-warning{% else %}bg-danger{% endif %}"
                                 style="width: {{ mapping.analysisConfidence }}%">
                                <strong>{{ mapping.analysisConfidence }}</strong>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <hr>
                    <div>
                        <strong>Review Status:</strong>
                        <span class="badge badge-{{ mapping.reviewStatusBadgeClass }}">{{ mapping.reviewStatus }}</span>
                    </div>
                    {% if mapping.requiresReview %}
                        <div class="mt-2">
                            <span class="badge badge-warning">‚ö†Ô∏è Requires Review</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">üî¨ Similarity Scores</h6>
                </div>
                <div class="card-body">
                    {% if mapping.textualSimilarity is not null %}
                    <div class="mb-2">
                        <small>Textual Similarity</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" style="width: {{ (mapping.textualSimilarity * 100)|round }}%">
                                {{ (mapping.textualSimilarity * 100)|round }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if mapping.keywordOverlap is not null %}
                    <div class="mb-2">
                        <small>Keyword Overlap</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" style="width: {{ (mapping.keywordOverlap * 100)|round }}%">
                                {{ (mapping.keywordOverlap * 100)|round }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if mapping.structuralSimilarity is not null %}
                    <div class="mb-2">
                        <small>Structural Similarity</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" style="width: {{ (mapping.structuralSimilarity * 100)|round }}%">
                                {{ (mapping.structuralSimilarity * 100)|round }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if mapping.analysisAlgorithmVersion %}
                        <hr>
                        <small class="text-muted">Algorithm v{{ mapping.analysisAlgorithmVersion }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Gap Items #}
    {% if gap_items is not empty %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üîç Identifizierte Gaps ({{ gap_items|length }})</h5>
        </div>
        <div class="card-body">
            {% if gap_summary %}
                <div class="alert alert-warning">
                    <strong>Total Impact:</strong> {{ gap_summary.total_impact }}% |
                    <strong>Total Effort:</strong> {{ gap_summary.total_effort }}h |
                    <strong>High Confidence:</strong> {{ gap_summary.high_confidence_gaps }}/{{ gap_summary.total_gaps }}
                </div>
            {% endif %}

            {% for gap in gap_items %}
            <div class="card mb-3 {% if gap.priority == 'critical' %}border-danger{% elseif gap.priority == 'high' %}border-warning{% endif %}">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <span class="badge badge-{{ gap.priorityBadgeClass }}">{{ gap.priority|upper }}</span>
                            <strong>{{ gap.gapTypeLabel }}</strong>
                        </span>
                        <span>
                            <span class="badge badge-{{ gap.statusBadgeClass }}">{{ gap.status }}</span>
                            {% if gap.percentageImpact > 0 %}
                                <span class="badge badge-danger">-{{ gap.percentageImpact }}%</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <p>{{ gap.description }}</p>

                    {% if gap.missingKeywords is not empty %}
                        <div class="mb-2">
                            <small class="text-muted">Fehlende Keywords:</small><br>
                            {% for keyword in gap.missingKeywords|slice(0, 10) %}
                                <span class="badge badge-light">{{ keyword }}</span>
                            {% endfor %}
                            {% if gap.missingKeywords|length > 10 %}
                                <span class="text-muted">... +{{ gap.missingKeywords|length - 10 }} mehr</span>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if gap.recommendedAction %}
                        <div class="alert alert-info mb-0">
                            <strong>üí° Empfehlung:</strong><br>
                            {{ gap.recommendedAction|nl2br }}
                        </div>
                    {% endif %}

                    <div class="mt-2">
                        <small class="text-muted">
                            Effort: {{ gap.estimatedEffort }}h |
                            Confidence: {{ gap.confidence }}% |
                            Source: {{ gap.identificationSource }}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
        <div class="alert alert-success">
            <h5>‚úÖ Keine Gaps identifiziert</h5>
            <p class="mb-0">Dieses Mapping hat keine automatisch erkannten L√ºcken.</p>
        </div>
    {% endif %}

    {# Review Form #}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üìù Review durchf√ºhren</h5>
        </div>
        <div class="card-body">
            <form id="reviewForm">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Manueller Prozentsatz (Override)</label>
                            <input type="number" class="form-control" id="manualPercentage" min="0" max="150" value="{{ mapping.manualPercentage }}" placeholder="Optional">
                            <small class="form-text text-muted">Leer lassen = automatischer Wert verwenden</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Review Status</label>
                            <select class="form-control" id="reviewStatus">
                                <option value="unreviewed" {% if mapping.reviewStatus == 'unreviewed' %}selected{% endif %}>Unreviewed</option>
                                <option value="in_review" {% if mapping.reviewStatus == 'in_review' %}selected{% endif %}>In Review</option>
                                <option value="approved" {% if mapping.reviewStatus == 'approved' %}selected{% endif %}>Approved</option>
                                <option value="rejected" {% if mapping.reviewStatus == 'rejected' %}selected{% endif %}>Rejected</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="submit" class="btn btn-success btn-block">
                                üíæ Review speichern
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Review Notes</label>
                    <textarea class="form-control" id="reviewNotes" rows="3" placeholder="Optionale Notizen...">{{ mapping.reviewNotes }}</textarea>
                </div>
            </form>

            <div id="reviewResult" class="mt-3"></div>
        </div>
    </div>

    {# Metadata #}
    {% if mapping.reviewedBy or mapping.verifiedBy %}
    <div class="card">
        <div class="card-header">
            <h6 class="mb-0">‚ÑπÔ∏è Metadata</h6>
        </div>
        <div class="card-body">
            {% if mapping.reviewedBy %}
                <p><strong>Reviewed by:</strong> {{ mapping.reviewedBy }} am {{ mapping.reviewedAt|date('d.m.Y H:i') }}</p>
            {% endif %}
            {% if mapping.verifiedBy %}
                <p><strong>Verified by:</strong> {{ mapping.verifiedBy }} am {{ mapping.verificationDate|date('d.m.Y') }}</p>
            {% endif %}
            <p><strong>Created:</strong> {{ mapping.createdAt|date('d.m.Y H:i') }}</p>
            {% if mapping.updatedAt %}
                <p><strong>Updated:</strong> {{ mapping.updatedAt|date('d.m.Y H:i') }}</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
document.getElementById('reviewForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
        manual_percentage: document.getElementById('manualPercentage').value || null,
        review_status: document.getElementById('reviewStatus').value,
        review_notes: document.getElementById('reviewNotes').value
    };

    try {
        const response = await fetch('{{ path('app_mapping_quality_review_update', {id: mapping.id}) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('reviewResult').innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Review erfolgreich gespeichert!
                    ${data.manual_percentage ? `<br>Neuer Prozentsatz: ${data.manual_percentage}%` : ''}
                </div>
            `;
            setTimeout(() => window.location.reload(), 1500);
        } else {
            document.getElementById('reviewResult').innerHTML = `
                <div class="alert alert-danger">
                    ‚ùå Fehler: ${result.error || 'Unbekannter Fehler'}
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('reviewResult').innerHTML = `
            <div class="alert alert-danger">
                ‚ùå Netzwerkfehler: ${error.message}
            </div>
        `;
    }
});

async function reanalyzeMapping() {
    if (!confirm('Mapping neu analysieren? Dies √ºberschreibt die bisherige Analyse.')) return;

    try {
        const response = await fetch('{{ path('app_mapping_quality_analyze', {id: mapping.id}) }}', {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            alert('‚úÖ Analyse erfolgreich durchgef√ºhrt!');
            window.location.reload();
        } else {
            alert('‚ùå Fehler: ' + (result.error || 'Unbekannter Fehler'));
        }
    } catch (error) {
        alert('‚ùå Netzwerkfehler: ' + error.message);
    }
}
</script>
{% endblock %}
