{% extends 'base.html.twig' %}

{% block title %}{{ 'mapping_review.title'|trans({}, 'compliance') }} #{{ mapping.id }}{% endblock %}

{% block body %}
<div class="container">
    <div class="page-header">
        <div>
            <h1><i class="bi bi-search" aria-hidden="true"></i> {{ 'mapping_review.title'|trans({}, 'compliance') }} #{{ mapping.id }}</h1>
            <p class="text-muted">{{ 'mapping_review.subtitle'|trans({}, 'compliance') }}</p>
        </div>
        <div class="button-group">
            <a href="{{ path('app_mapping_quality_review_queue') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'mapping_review.action.back_to_queue'|trans({}, 'compliance') }}
            </a>
            <button type="button" class="btn btn-info"
                    data-controller="ui-actions"
                    data-action="ui-actions#confirmAndFetch"
                    data-ui-actions-confirm-param="{{ 'mapping_review.action.reanalyze_confirm'|trans({}, 'compliance') }}"
                    data-ui-actions-url-param="{{ path('app_mapping_quality_analyze', {id: mapping.id}) }}"
                    data-ui-actions-method-param="POST"
                    data-ui-actions-reload-param="true">
                <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> {{ 'mapping_review.action.reanalyze'|trans({}, 'compliance') }}
            </button>
        </div>
    </div>

    {# Mapping Overview #}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_header %}
            <div class="card-header">
                <h2 class="mb-0"><i class="bi bi-bar-chart" aria-hidden="true"></i> {{ 'mapping_review.section.overview'|trans({}, 'compliance') }}</h2>
            </div>
        {% endblock %}
        {% block card_body %}
            <div class="row">
                <div class="col-md-5">
                    <p class="fw-bold text-muted">{{ 'mapping_review.field.source_requirement'|trans({}, 'compliance') }}</p>
                    <p class="fw-bold">{% include '_components/_badge.html.twig' with { variant: 'primary', content: mapping.sourceRequirement.framework.code } %} {{ mapping.sourceRequirement.requirementId }}</p>
                    <p><strong>{{ mapping.sourceRequirement.title }}</strong></p>
                    <p class="text-muted small">{{ mapping.sourceRequirement.description|slice(0, 200) }}...</p>
                    {% if mapping.sourceRequirement.category %}
                        {% include '_components/_badge.html.twig' with { variant: 'info', content: mapping.sourceRequirement.category } %}
                    {% endif %}
                    {% if mapping.sourceRequirement.priority %}
                        {% include '_components/_badge.html.twig' with { variant: mapping.sourceRequirement.priority == 'critical' ? 'danger' : (mapping.sourceRequirement.priority == 'high' ? 'warning' : 'secondary'), content: mapping.sourceRequirement.priority|upper } %}
                    {% endif %}
                </div>
                <div class="col-md-2 text-center d-flex align-items-center justify-content-center">
                    <p class="fs-3">â†’</p>
                </div>
                <div class="col-md-5">
                    <p class="fw-bold text-muted">{{ 'mapping_review.field.target_requirement'|trans({}, 'compliance') }}</p>
                    <p class="fw-bold">{% include '_components/_badge.html.twig' with { variant: 'success', content: mapping.targetRequirement.framework.code } %} {{ mapping.targetRequirement.requirementId }}</p>
                    <p><strong>{{ mapping.targetRequirement.title }}</strong></p>
                    <p class="text-muted small">{{ mapping.targetRequirement.description|slice(0, 200) }}...</p>
                    {% if mapping.targetRequirement.category %}
                        {% include '_components/_badge.html.twig' with { variant: 'info', content: mapping.targetRequirement.category } %}
                    {% endif %}
                    {% if mapping.targetRequirement.priority %}
                        {% include '_components/_badge.html.twig' with { variant: mapping.targetRequirement.priority == 'critical' ? 'danger' : (mapping.targetRequirement.priority == 'high' ? 'warning' : 'secondary'), content: mapping.targetRequirement.priority|upper } %}
                    {% endif %}
                </div>
            </div>
        {% endblock %}
    {% endembed %}

    {# Quality Metrics #}
    <div class="row mb-4">
        <div class="col-md-4">
            {% embed '_components/_card.html.twig' %}
                {% block card_header %}
                    <div class="card-header"><h2 class="mb-0"><i class="bi bi-graph-up" aria-hidden="true"></i> {{ 'mapping_review.section.percentages'|trans({}, 'compliance') }}</h2></div>
                {% endblock %}
                {% block card_body %}
                    <div class="mb-3">
                        <small class="text-muted">{{ 'mapping_review.field.original_heuristic'|trans({}, 'compliance') }}</small>
                        <p class="fw-bold fs-4">{% include '_components/_badge.html.twig' with { variant: 'secondary', content: mapping.mappingPercentage ~ '%' } %}</p>
                    </div>
                    {% if mapping.calculatedPercentage is not null %}
                    <div class="mb-3">
                        <small class="text-muted">{{ 'mapping_review.field.calculated_auto'|trans({}, 'compliance') }}</small>
                        <p class="fw-bold fs-4">{% include '_components/_badge.html.twig' with { variant: mapping.calculatedPercentage >= 70 ? 'success' : (mapping.calculatedPercentage >= 50 ? 'warning' : 'danger'), content: mapping.calculatedPercentage ~ '%' } %}</p>
                    </div>
                    {% endif %}
                    {% if mapping.manualPercentage is not null %}
                    <div>
                        <small class="text-muted">{{ 'mapping_review.field.manual_override'|trans({}, 'compliance') }}</small>
                        <p class="fw-bold fs-4">{% include '_components/_badge.html.twig' with { variant: 'info', content: mapping.manualPercentage ~ '%' } %}</p>
                    </div>
                    {% endif %}
                    <hr>
                    <div>
                        <strong>{{ 'mapping_review.field.final'|trans({}, 'compliance') }}:</strong>
                        <p class="fw-bold fs-3">{% include '_components/_badge.html.twig' with { variant: 'primary', content: mapping.finalPercentage ~ '%' } %}</p>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>

        <div class="col-md-4">
            {% embed '_components/_card.html.twig' %}
                {% block card_header %}
                    <div class="card-header"><h3 class="mb-0 h5"><i class="bi bi-star" aria-hidden="true"></i> {{ 'mapping_review.section.quality_confidence'|trans({}, 'compliance') }}</h3></div>
                {% endblock %}
                {% block card_body %}
                    {% if mapping.qualityScore is not null %}
                    <div class="mb-3">
                        <small class="text-muted">{{ 'mapping_review.field.quality_score'|trans({}, 'compliance') }}</small>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar {% if mapping.qualityScore >= 75 %}bg-success{% elseif mapping.qualityScore >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                                 style="width: {{ mapping.qualityScore }}%">
                                <strong>{{ mapping.qualityScore }}</strong>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if mapping.analysisConfidence is not null %}
                    <div class="mb-3">
                        <small class="text-muted">{{ 'mapping_review.field.analysis_confidence'|trans({}, 'compliance') }}</small>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar {% if mapping.analysisConfidence >= 80 %}bg-success{% elseif mapping.analysisConfidence >= 60 %}bg-warning{% else %}bg-danger{% endif %}"
                                 style="width: {{ mapping.analysisConfidence }}%">
                                <strong>{{ mapping.analysisConfidence }}</strong>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <hr>
                    <div>
                        <strong>{{ 'mapping_review.field.review_status'|trans({}, 'compliance') }}:</strong>
                        {% include '_components/_badge.html.twig' with { variant: mapping.reviewStatusBadgeClass, content: mapping.reviewStatus } %}
                    </div>
                    {% if mapping.requiresReview %}
                        <div class="mt-2">
                            {% include '_components/_badge.html.twig' with { variant: 'warning', icon: 'bi-exclamation-triangle', content: 'mapping_review.field.requires_review'|trans({}, 'compliance') } %}
                        </div>
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>

        <div class="col-md-4">
            {% embed '_components/_card.html.twig' %}
                {% block card_header %}
                    <div class="card-header"><h4 class="mb-0 h5"><i class="bi bi-activity" aria-hidden="true"></i> {{ 'mapping_review.section.similarity_scores'|trans({}, 'compliance') }}</h4></div>
                {% endblock %}
                {% block card_body %}
                    {% if mapping.textualSimilarity is not null %}
                    <div class="mb-2">
                        <small>{{ 'mapping_review.field.textual_similarity'|trans({}, 'compliance') }}</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" style="width: {{ (mapping.textualSimilarity * 100)|round }}%">
                                {{ (mapping.textualSimilarity * 100)|round }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if mapping.keywordOverlap is not null %}
                    <div class="mb-2">
                        <small>{{ 'mapping_review.field.keyword_overlap'|trans({}, 'compliance') }}</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" style="width: {{ (mapping.keywordOverlap * 100)|round }}%">
                                {{ (mapping.keywordOverlap * 100)|round }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if mapping.structuralSimilarity is not null %}
                    <div class="mb-2">
                        <small>{{ 'mapping_review.field.structural_similarity'|trans({}, 'compliance') }}</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" style="width: {{ (mapping.structuralSimilarity * 100)|round }}%">
                                {{ (mapping.structuralSimilarity * 100)|round }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if mapping.analysisAlgorithmVersion %}
                        <hr>
                        <small class="text-muted">{{ 'mapping_review.field.algorithm_version'|trans({'%version%': mapping.analysisAlgorithmVersion}, 'compliance') }}</small>
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>
    </div>

    {# Gap Items #}
    {% if gap_items is not empty %}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_header %}
            <div class="card-header">
                <h3 class="mb-0"><i class="bi bi-search" aria-hidden="true"></i> {{ 'mapping_review.gap.count'|trans({'%count%': gap_items|length}, 'compliance') }}</h3>
            </div>
        {% endblock %}
        {% block card_body %}
            {% if gap_summary %}
                <div class="alert alert-warning">
                    <strong>{{ 'mapping_review.gap.total_impact'|trans({}, 'compliance') }}:</strong> {{ gap_summary.total_impact }}% |
                    <strong>{{ 'mapping_review.gap.total_effort'|trans({}, 'compliance') }}:</strong> {{ gap_summary.total_effort }}h |
                    <strong>{{ 'mapping_review.gap.high_confidence'|trans({}, 'compliance') }}:</strong> {{ gap_summary.high_confidence_gaps }}/{{ gap_summary.total_gaps }}
                </div>
            {% endif %}

            {% for gap in gap_items %}
            {% embed '_components/_card.html.twig' with { 'class': 'mb-3' ~ (gap.priority == 'critical' ? ' border-danger' : (gap.priority == 'high' ? ' border-warning' : '')) } %}
                {% block card_header %}
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                {% include '_components/_badge.html.twig' with { variant: gap.priorityBadgeClass, content: gap.priority|upper } %}
                                <strong>{{ gap.gapTypeLabel }}</strong>
                            </span>
                            <span>
                                {% include '_components/_badge.html.twig' with { variant: gap.statusBadgeClass, content: gap.status } %}
                                {% if gap.percentageImpact > 0 %}
                                    {% include '_components/_badge.html.twig' with { variant: 'danger', content: '-' ~ gap.percentageImpact ~ '%' } %}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <p>{{ gap.description }}</p>

                    {% if gap.missingKeywords is not empty %}
                        <div class="mb-2">
                            <small class="text-muted">{{ 'mapping_review.gap.missing_keywords'|trans({}, 'compliance') }}:</small><br>
                            {% for keyword in gap.missingKeywords|slice(0, 10) %}
                                {% include '_components/_badge.html.twig' with { variant: 'light', content: keyword } %}
                            {% endfor %}
                            {% if gap.missingKeywords|length > 10 %}
                                <span class="text-muted">{{ 'mapping_review.gap.more_keywords'|trans({'%count%': gap.missingKeywords|length - 10}, 'compliance') }}</span>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if gap.recommendedAction %}
                        <div class="alert alert-info mb-0">
                            <strong><i class="bi bi-lightbulb text-warning" aria-hidden="true"></i> {{ 'mapping_review.gap.recommendation'|trans({}, 'compliance') }}:</strong><br>
                            {{ gap.recommendedAction|nl2br }}
                        </div>
                    {% endif %}

                    <div class="mt-2">
                        <small class="text-muted">
                            {{ 'mapping_review.gap.effort'|trans({}, 'compliance') }}: {{ gap.estimatedEffort }}h |
                            {{ 'mapping_review.gap.confidence'|trans({}, 'compliance') }}: {{ gap.confidence }}% |
                            {{ 'mapping_review.gap.source'|trans({}, 'compliance') }}: {{ gap.identificationSource }}
                        </small>
                    </div>
                {% endblock %}
            {% endembed %}
            {% endfor %}
        {% endblock %}
    {% endembed %}
    {% else %}
        <div class="alert alert-success">
            <div class="fw-bold"><i class="bi bi-check-circle text-success" aria-hidden="true"></i> {{ 'mapping_review.gap.no_gaps'|trans({}, 'compliance') }}</div>
            <p class="mb-0">{{ 'mapping_review.gap.no_gaps_desc'|trans({}, 'compliance') }}</p>
        </div>
    {% endif %}

    {# Review Form #}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_header %}
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0"><i class="bi bi-pencil-square" aria-hidden="true"></i> {{ 'mapping_review.section.perform_review'|trans({}, 'compliance') }}</h3>
            </div>
        {% endblock %}
        {% block card_body %}
            <form id="reviewForm">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="manualPercentage">{{ 'mapping_review.field.manual_percentage'|trans({}, 'compliance') }}</label>
                            <input type="number" class="form-control" id="manualPercentage" min="0" max="150" value="{{ mapping.manualPercentage }}" placeholder="Optional">
                            <small class="form-text text-muted">{{ 'mapping_review.field.manual_percentage_help'|trans({}, 'compliance') }}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="reviewStatus">{{ 'mapping_review.field.review_status'|trans({}, 'compliance') }}</label>
                            <select class="form-control" id="reviewStatus">
                                <option value="unreviewed" {% if mapping.reviewStatus == 'unreviewed' %}selected{% endif %}>{{ 'mapping_review.status.unreviewed'|trans({}, 'compliance') }}</option>
                                <option value="in_review" {% if mapping.reviewStatus == 'in_review' %}selected{% endif %}>{{ 'mapping_review.status.in_review'|trans({}, 'compliance') }}</option>
                                <option value="approved" {% if mapping.reviewStatus == 'approved' %}selected{% endif %}>{{ 'mapping_review.status.approved'|trans({}, 'compliance') }}</option>
                                <option value="rejected" {% if mapping.reviewStatus == 'rejected' %}selected{% endif %}>{{ 'mapping_review.status.rejected'|trans({}, 'compliance') }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <div class="form-label">&nbsp;</div>
                            <button type="submit" class="btn btn-success btn-block">
                                <i class="bi bi-save" aria-hidden="true"></i> {{ 'mapping_review.action.save_review'|trans({}, 'compliance') }}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="reviewNotes">{{ 'mapping_review.field.review_notes'|trans({}, 'compliance') }}</label>
                    <textarea class="form-control" id="reviewNotes" rows="3" placeholder="{{ 'mapping_review.field.review_notes_placeholder'|trans({}, 'compliance') }}">{{ mapping.reviewNotes }}</textarea>
                </div>
            </form>

            <div id="reviewResult" class="mt-3"></div>
        {% endblock %}
    {% endembed %}

    {# Metadata #}
    {% if mapping.reviewedBy or mapping.verifiedBy %}
    {% embed '_components/_card.html.twig' %}
        {% block card_header %}
            <div class="card-header"><h3 class="mb-0 h5"><i class="bi bi-info-circle text-info" aria-hidden="true"></i> {{ 'mapping_review.section.metadata'|trans({}, 'compliance') }}</h3></div>
        {% endblock %}
        {% block card_body %}
            {% if mapping.reviewedBy %}
                <p><strong>{{ 'mapping_review.metadata.reviewed_by'|trans({}, 'compliance') }}:</strong> {{ mapping.reviewedBy }} {{ 'mapping_review.metadata.at'|trans({}, 'compliance') }} {{ mapping.reviewedAt|date('d.m.Y H:i') }}</p>
            {% endif %}
            {% if mapping.verifiedBy %}
                <p><strong>{{ 'mapping_review.metadata.verified_by'|trans({}, 'compliance') }}:</strong> {{ mapping.verifiedBy }} {{ 'mapping_review.metadata.at'|trans({}, 'compliance') }} {{ mapping.verificationDate|date('d.m.Y') }}</p>
            {% endif %}
            <p><strong>{{ 'mapping_review.metadata.created'|trans({}, 'compliance') }}:</strong> {{ mapping.createdAt|date('d.m.Y H:i') }}</p>
            {% if mapping.updatedAt %}
                <p><strong>{{ 'mapping_review.metadata.updated'|trans({}, 'compliance') }}:</strong> {{ mapping.updatedAt|date('d.m.Y H:i') }}</p>
            {% endif %}
        {% endblock %}
    {% endembed %}
    {% endif %}
</div>

<script>
document.getElementById('reviewForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
        manual_percentage: document.getElementById('manualPercentage').value || null,
        review_status: document.getElementById('reviewStatus').value,
        review_notes: document.getElementById('reviewNotes').value
    };

    try {
        const response = await fetch('{{ path('app_mapping_quality_review_update', {id: mapping.id}) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('reviewResult').innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle" aria-hidden="true"></i> {{ 'mapping_review.message.review_saved'|trans({}, 'compliance') }}
                    ${data.manual_percentage ? `<br>{{ 'mapping_review.message.new_percentage'|trans({}, 'compliance') }}: ${data.manual_percentage}%` : ''}
                </div>
            `;
            setTimeout(() => window.location.reload(), 1500);
        } else {
            document.getElementById('reviewResult').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle" aria-hidden="true"></i> {{ 'mapping_review.message.error'|trans({}, 'compliance') }}: ${result.error || '{{ 'mapping_review.message.unknown_error'|trans({}, 'compliance') }}'}
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('reviewResult').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle" aria-hidden="true"></i> {{ 'mapping_review.message.network_error'|trans({}, 'compliance') }}: ${error.message}
            </div>
        `;
    }
});

// reanalyzeMapping is now handled via ui-actions#confirmAndFetch Stimulus controller
</script>
{% endblock %}
