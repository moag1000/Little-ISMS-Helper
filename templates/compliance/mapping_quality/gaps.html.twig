{% extends 'base.html.twig' %}

{% block title %}{{ 'compliance.mapping_quality.gaps.title'|trans({}, 'compliance') }}{% endblock %}

{% block body %}
<div class="container">
    <div class="page-header">
        <div>
            <h1>{{ 'compliance.mapping_quality.gaps.title'|trans({}, 'compliance') }}</h1>
            <p class="text-muted">{{ 'compliance.gaps.title_description'|trans({}, 'compliance') }}</p>
        </div>
        <div class="button-group">
            <a href="{{ path('app_mapping_quality_dashboard') }}" class="btn btn-secondary">
                <span class="icon">‚Üê</span> {{ 'compliance.mapping_quality.title'|trans({}, 'compliance') }}
            </a>
        </div>
    </div>

    {# Remediation Effort Summary #}
    {% if remediation_effort %}
    <div class="alert alert-info">
        <div class="row">
            <div class="col-md-4">
                <p class="fw-bold fs-5">{{ 'compliance.mapping_quality.gaps.total_gaps'|trans({}, 'compliance') }}</p>
                <p class="fw-bold fs-4">{{ remediation_effort.total_gaps }}</p>
            </div>
            <div class="col-md-4">
                <p class="fw-bold"><i class="bi bi-clock" aria-hidden="true"></i> {{ 'compliance.mapping_quality.gaps.estimated_effort'|trans({}, 'compliance') }}</p>
                <p class="fw-bold fs-4">{{ remediation_effort.total_effort }} {{ 'compliance.mapping_quality.gaps.hours'|trans({}, 'compliance') }}</p>
                <small class="text-muted">‚âà {{ (remediation_effort.total_effort / 8)|round(1) }} {{ 'compliance.mapping_quality.gaps.workdays'|trans({}, 'compliance') }}</small>
            </div>
            <div class="col-md-4">
                <p class="fw-bold">{{ 'compliance.gaps.by_priority'|trans({}, 'compliance') }}</p>
                {% for priority in remediation_effort.by_priority %}
                    <div>
                        <span class="{{ badge_priority(priority.priority) }}">
                            {{ priority.priority|upper }}
                        </span>
                        {{ priority.count }} ({{ priority.effort }}h)
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {# Statistics Cards #}
    <div class="row mb-4">
        <div class="col-md-6">
            {% embed '_components/_card.html.twig' %}
                {% block card_header %}
                    <div class="card-header">
                        <h2 class="mb-0">{{ 'compliance.mapping_quality.gaps.by_type'|trans({}, 'compliance') }}</h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    {% if gap_stats_by_type is empty %}
                        <p class="text-muted">{{ 'compliance.mapping_quality.no_gap_data'|trans({}, 'compliance') }}</p>
                    {% else %}
                        {% for stat in gap_stats_by_type %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>
                                    {% if stat.gapType == 'missing_control' %}<i class="bi bi-exclamation-circle text-danger" aria-hidden="true"></i>
                                    {% elseif stat.gapType == 'partial_coverage' %}üü°
                                    {% elseif stat.gapType == 'scope_difference' %}üîµ
                                    {% elseif stat.gapType == 'additional_requirement' %}üü†
                                    {% else %}‚ö™
                                    {% endif %}
                                    {{ stat.gapType|replace({'_': ' '})|title }}
                                </span>
                                <strong>{{ stat.count }}</strong>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info"
                                     style="width: {% set total = gap_stats_by_type|map(s => s.count)|reduce((carry, v) => carry + v, 0) %}{% if total > 0 %}{{ (stat.count / total * 100)|round }}{% else %}0{% endif %}%">
                                </div>
                            </div>
                            {% if stat.totalImpact %}
                                <small class="text-muted">Total Impact: {{ stat.totalImpact|round }}%</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>

        <div class="col-md-6">
            {% embed '_components/_card.html.twig' %}
                {% block card_header %}
                    <div class="card-header">
                        <h2 class="mb-0">{{ 'compliance.mapping_quality.gaps.by_priority'|trans({}, 'compliance') }}</h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    {% if gap_stats_by_priority is empty %}
                        <p class="text-muted">{{ 'compliance.mapping_quality.no_gap_data'|trans({}, 'compliance') }}</p>
                    {% else %}
                        {% for stat in gap_stats_by_priority %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>
                                    {% if stat.priority == 'critical' %}<i class="bi bi-exclamation-circle text-danger" aria-hidden="true"></i>
                                    {% elseif stat.priority == 'high' %}üü†
                                    {% elseif stat.priority == 'medium' %}üü°
                                    {% else %}‚ö™
                                    {% endif %}
                                    {{ stat.priority|upper }}
                                </span>
                                <strong>{{ stat.count }}</strong>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar {{ badge_priority(stat.priority)|replace({'badge ': ''}) }}"
                                     style="width: {% set total = gap_stats_by_priority|map(s => s.count)|reduce((carry, v) => carry + v, 0) %}{% if total > 0 %}{{ (stat.count / total * 100)|round }}{% else %}0{% endif %}%">
                                </div>
                            </div>
                            <small class="text-muted">
                                Impact: {{ stat.totalImpact|round }}% |
                                √ò Effort: {{ stat.avgEffort|round(1) }}h
                            </small>
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>
    </div>

    {# High Priority Gaps #}
    {% if high_priority_gaps is not empty %}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_header %}
            <div class="card-header bg-danger text-white">
                <h3 class="mb-0">{{ 'compliance.mapping_quality.gaps.critical_high'|trans({}, 'compliance') }} ({{ high_priority_gaps|length }})</h3>
            </div>
        {% endblock %}
        {% block card_body %}
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover',
                'noMargin': true,
                'responsive': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">{{ 'compliance.field.mapping'|trans({}, 'compliance') }}</th>
                        <th scope="col">Gap Type</th>
                        <th scope="col">{{ 'compliance.field.priority'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.mapping_quality.gaps.total_impact'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'mapping_review.gap.effort'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.framework.field.status'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.mapping_quality.column.action'|trans({}, 'compliance') }}</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for gap in high_priority_gaps|slice(0, 20) %}
                    <tr>
                        <td>
                            <small>
                                <strong>{{ gap.mapping.sourceRequirement.framework.code }}</strong>
                                {{ gap.mapping.sourceRequirement.requirementId }}
                                ‚Üí
                                <strong>{{ gap.mapping.targetRequirement.framework.code }}</strong>
                                {{ gap.mapping.targetRequirement.requirementId }}
                            </small>
                        </td>
                        <td>
                            {% include '_components/_badge.html.twig' with { variant: 'light', content: gap.gapTypeLabel } %}
                        </td>
                        <td>
                            {% include '_components/_badge.html.twig' with { variant: gap.priorityBadgeClass, content: gap.priority|upper } %}
                        </td>
                        <td>
                            {% include '_components/_badge.html.twig' with { variant: 'danger', content: '-' ~ gap.percentageImpact ~ '%' } %}
                        </td>
                        <td>
                            {% include '_components/_badge.html.twig' with { variant: 'info', content: gap.estimatedEffort ~ 'h' } %}
                        </td>
                        <td>
                            {% include '_components/_badge.html.twig' with { variant: gap.statusBadgeClass, content: gap.status } %}
                        </td>
                        <td>
                            <a href="{{ path('app_mapping_quality_review', {id: gap.mapping.id}) }}" class="btn btn-sm btn-primary">
                                Details
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
            {% if high_priority_gaps|length > 20 %}
                <p class="text-muted text-center mb-0">{{ 'compliance.mapping_quality.and_more'|trans({'%count%': high_priority_gaps|length - 20}, 'compliance') }}</p>
            {% endif %}
        {% endblock %}
    {% endembed %}
    {% endif %}

    {# Low Confidence Gaps #}
    {% if low_confidence_gaps is not empty %}
    {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
        {% block card_header %}
            <div class="card-header">
                <h3 class="mb-0"><i class="bi bi-exclamation-triangle text-warning" aria-hidden="true"></i> {{ 'compliance.mapping_quality.gaps.low_confidence_gaps'|trans({}, 'compliance') }} ({{ low_confidence_gaps|length }})</h3>
            </div>
        {% endblock %}
        {% block card_body %}
            <p class="text-muted">{{ 'compliance.mapping_quality.gaps.low_confidence_desc'|trans({}, 'compliance') }}</p>
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover',
                'noMargin': true,
                'responsive': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">{{ 'compliance.field.mapping'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.framework.field.description'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.field.priority'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.mapping_quality.column.confidence'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.mapping_quality.gaps.total_impact'|trans({}, 'compliance') }}</th>
                        <th scope="col">{{ 'compliance.mapping_quality.column.action'|trans({}, 'compliance') }}</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for gap in low_confidence_gaps|slice(0, 15) %}
                    <tr>
                        <td>
                            <small>
                                {{ gap.mapping.sourceRequirement.framework.code }}
                                ‚Üí
                                {{ gap.mapping.targetRequirement.framework.code }}
                            </small>
                        </td>
                        <td>
                            {% include '_components/_badge.html.twig' with { variant: 'light', content: gap.gapTypeLabel } %}
                            <small class="d-block text-muted">{{ gap.description|slice(0, 80) }}...</small>
                        </td>
                        <td>
                            {% include '_components/_badge.html.twig' with { variant: gap.priorityBadgeClass, content: gap.priority } %}
                        </td>
                        <td>
                            {% include '_components/_badge.html.twig' with { variant: 'warning', content: gap.confidence ~ '%' } %}
                        </td>
                        <td>
                            {% include '_components/_badge.html.twig' with { variant: 'danger', content: '-' ~ gap.percentageImpact ~ '%' } %}
                        </td>
                        <td>
                            <a href="{{ path('app_mapping_quality_review', {id: gap.mapping.id}) }}" class="btn btn-sm btn-primary">
                                Review
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
            {% if low_confidence_gaps|length > 15 %}
                <p class="text-muted text-center mb-0">{{ 'compliance.mapping_quality.and_more'|trans({'%count%': low_confidence_gaps|length - 15}, 'compliance') }}</p>
            {% endif %}
        {% endblock %}
    {% endembed %}
    {% endif %}

    {# Empty State #}
    {% if high_priority_gaps is empty and low_confidence_gaps is empty %}
        {% if remediation_effort.total_gaps == 0 %}
        <div class="alert alert-info">
            <h4><i class="bi bi-info-circle text-info" aria-hidden="true"></i> {{ 'compliance.mapping_quality.gaps.no_gaps_found.title'|trans({}, 'compliance') }}</h4>
            <p>{{ 'compliance.mapping_quality.gaps.no_gaps_found.desc'|trans({}, 'compliance') }}</p>
            <hr>
            <h4>{{ 'compliance.mapping_quality.gaps.no_gaps_found.next_steps'|trans({}, 'compliance') }}</h4>
            <ol>
                <li>{{ 'compliance.mapping_quality.gaps.no_gaps_found.run_analysis'|trans({}, 'compliance')|raw }}</li>
                <li>{{ 'compliance.mapping_quality.gaps.no_gaps_found.auto_identify'|trans({}, 'compliance') }}</li>
                <li>{{ 'compliance.mapping_quality.gaps.no_gaps_found.return_here'|trans({}, 'compliance') }}</li>
            </ol>
            <a href="{{ path('app_mapping_quality_dashboard') }}" class="btn btn-primary mt-2">‚Üê {{ 'common.back'|trans({}, 'messages') }}</a>
        </div>
        {% else %}
        <div class="alert alert-success">
            <h5><i class="bi bi-check-circle text-success" aria-hidden="true"></i> {{ 'compliance.mapping_quality.gaps.no_critical_gaps.title'|trans({}, 'compliance') }}</h5>
            <p class="mb-0">{{ 'compliance.mapping_quality.gaps.no_critical_gaps.desc'|trans({}, 'compliance') }}</p>
        </div>
        {% endif %}
    {% endif %}

    {# Action Buttons #}
    {% embed '_components/_card.html.twig' %}
        {% block card_header %}
            <div class="card-header">
                <h3 class="mb-0"><i class="bi bi-tools" aria-hidden="true"></i> {{ 'compliance.mapping_quality.gaps.actions.title'|trans({}, 'compliance') }}</h3>
            </div>
        {% endblock %}
        {% block card_body %}
            <div class="row">
                <div class="col-md-4">
                    <h4><i class="bi bi-list-check" aria-hidden="true"></i> {{ 'compliance.mapping_quality.gaps.actions.prioritization'|trans({}, 'compliance') }}</h4>
                    <ol>
                        <li>{{ 'compliance.mapping_quality.gaps.actions.critical_first'|trans({}, 'compliance') }} ({{ gap_stats_by_priority[0].count ?? 0 }})</li>
                        <li>{{ 'compliance.mapping_quality.gaps.actions.high_priority'|trans({}, 'compliance') }} ({{ gap_stats_by_priority[1].count ?? 0 }})</li>
                        <li>{{ 'compliance.mapping_quality.gaps.actions.check_low_confidence'|trans({}, 'compliance') }}</li>
                    </ol>
                </div>
                <div class="col-md-4">
                    <h4><i class="bi bi-clock" aria-hidden="true"></i> {{ 'compliance.mapping_quality.gaps.actions.time_planning'|trans({}, 'compliance') }}</h4>
                    <p>
                        <strong>{{ 'compliance.mapping_quality.gaps.actions.total'|trans({}, 'compliance') }}</strong> {{ remediation_effort.total_effort }} {{ 'compliance.mapping_quality.gaps.hours'|trans({}, 'compliance') }}<br>
                        <strong>‚âà {{ (remediation_effort.total_effort / 8)|round(1) }}</strong> {{ 'compliance.mapping_quality.gaps.actions.days_at_8h'|trans({}, 'compliance') }}
                    </p>
                </div>
                <div class="col-md-4">
                    <h4>{{ 'compliance.mapping_quality.gaps.actions.tracking'|trans({}, 'compliance') }}</h4>
                    <p>{{ 'compliance.gaps.change_status_instruction'|trans({}, 'compliance') }}</p>
                    <ul>
                        <li>identified ‚Üí planned</li>
                        <li>planned ‚Üí in_progress</li>
                        <li>in_progress ‚Üí resolved</li>
                    </ul>
                </div>
            </div>
        {% endblock %}
    {% endembed %}
</div>
{% endblock %}
