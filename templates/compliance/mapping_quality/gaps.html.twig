{% extends 'base.html.twig' %}

{% block title %}Gap Overview{% endblock %}

{% block body %}
<div class="container">
    <div class="page-header">
        <div>
            <h1>üîç Gap-√úbersicht</h1>
            <p class="text-muted">Identifizierte L√ºcken in Compliance-Mappings</p>
        </div>
        <div class="button-group">
            <a href="{{ path('app_mapping_quality_dashboard') }}" class="btn btn-secondary">
                <span class="icon">‚Üê</span> Dashboard
            </a>
        </div>
    </div>

    {# Remediation Effort Summary #}
    {% if remediation_effort %}
    <div class="alert alert-info">
        <div class="row">
            <div class="col-md-4">
                <h2>üìä Total Gaps</h2>
                <h2>{{ remediation_effort.total_gaps }}</h3>
            </div>
            <div class="col-md-4">
                <h5>‚è±Ô∏è Gesch√§tzter Aufwand</h5>
                <h3>{{ remediation_effort.total_effort }} Stunden</h3>
                <small class="text-muted">‚âà {{ (remediation_effort.total_effort / 8)|round(1) }} Arbeitstage</small>
            </div>
            <div class="col-md-4">
                <h5>üìà By Priority</h5>
                {% for priority in remediation_effort.by_priority %}
                    <div>
                        <span class="{{ badge_priority(priority.priority) }}">
                            {{ priority.priority|upper }}
                        </span>
                        {{ priority.count }} ({{ priority.effort }}h)
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {# Statistics Cards #}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">üìä Gaps nach Typ</h3>
                </div>
                <div class="card-body">
                    {% if gap_stats_by_type is empty %}
                        <p class="text-muted">Keine Gap-Daten verf√ºgbar</p>
                    {% else %}
                        {% for stat in gap_stats_by_type %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>
                                    {% if stat.gapType == 'missing_control' %}üî¥
                                    {% elseif stat.gapType == 'partial_coverage' %}üü°
                                    {% elseif stat.gapType == 'scope_difference' %}üîµ
                                    {% elseif stat.gapType == 'additional_requirement' %}üü†
                                    {% else %}‚ö™
                                    {% endif %}
                                    {{ stat.gapType|replace({'_': ' '})|title }}
                                </span>
                                <strong>{{ stat.count }}</strong>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info"
                                     style="width: {% set total = gap_stats_by_type|map(s => s.count)|reduce((carry, v) => carry + v, 0) %}{% if total > 0 %}{{ (stat.count / total * 100)|round }}{% else %}0{% endif %}%">
                                </div>
                            </div>
                            {% if stat.totalImpact %}
                                <small class="text-muted">Total Impact: {{ stat.totalImpact|round }}%</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">‚ö° Gaps nach Priorit√§t</h3>
                </div>
                <div class="card-body">
                    {% if gap_stats_by_priority is empty %}
                        <p class="text-muted">Keine Gap-Daten verf√ºgbar</p>
                    {% else %}
                        {% for stat in gap_stats_by_priority %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>
                                    {% if stat.priority == 'critical' %}üî¥
                                    {% elseif stat.priority == 'high' %}üü†
                                    {% elseif stat.priority == 'medium' %}üü°
                                    {% else %}‚ö™
                                    {% endif %}
                                    {{ stat.priority|upper }}
                                </span>
                                <strong>{{ stat.count }}</strong>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar {{ badge_priority(stat.priority)|replace({'badge ': ''}) }}"
                                     style="width: {% set total = gap_stats_by_priority|map(s => s.count)|reduce((carry, v) => carry + v, 0) %}{% if total > 0 %}{{ (stat.count / total * 100)|round }}{% else %}0{% endif %}%">
                                </div>
                            </div>
                            <small class="text-muted">
                                Impact: {{ stat.totalImpact|round }}% |
                                √ò Effort: {{ stat.avgEffort|round(1) }}h
                            </small>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# High Priority Gaps #}
    {% if high_priority_gaps is not empty %}
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h3 class="mb-0">üî• Critical & High Priority Gaps ({{ high_priority_gaps|length }})</h3>
        </div>
        <div class="card-body">
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover',
                'noMargin': true,
                'responsive': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">Mapping</th>
                        <th scope="col">Gap Type</th>
                        <th scope="col">Priority</th>
                        <th scope="col">Impact</th>
                        <th scope="col">Effort</th>
                        <th scope="col">Status</th>
                        <th scope="col">Aktion</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for gap in high_priority_gaps|slice(0, 20) %}
                    <tr>
                        <td>
                            <small>
                                <strong>{{ gap.mapping.sourceRequirement.framework.code }}</strong>
                                {{ gap.mapping.sourceRequirement.requirementId }}
                                ‚Üí
                                <strong>{{ gap.mapping.targetRequirement.framework.code }}</strong>
                                {{ gap.mapping.targetRequirement.requirementId }}
                            </small>
                        </td>
                        <td>
                            <span class="badge bg-light">{{ gap.gapTypeLabel }}</span>
                        </td>
                        <td>
                            <span class="badge badge-{{ gap.priorityBadgeClass }}">
                                {{ gap.priority|upper }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-danger">-{{ gap.percentageImpact }}%</span>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ gap.estimatedEffort }}h</span>
                        </td>
                        <td>
                            <span class="badge badge-{{ gap.statusBadgeClass }}">
                                {{ gap.status }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ path('app_mapping_quality_review', {id: gap.mapping.id}) }}" class="btn btn-sm btn-primary">
                                Details
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
            {% if high_priority_gaps|length > 20 %}
                <p class="text-muted text-center mb-0">... und {{ high_priority_gaps|length - 20 }} weitere</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {# Low Confidence Gaps #}
    {% if low_confidence_gaps is not empty %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0">‚ö†Ô∏è Low Confidence Gaps ({{ low_confidence_gaps|length }})</h3>
        </div>
        <div class="card-body">
            <p class="text-muted">Diese Gaps haben niedrige Confidence-Scores und sollten manuell √ºberpr√ºft werden.</p>
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover',
                'noMargin': true,
                'responsive': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">Mapping</th>
                        <th scope="col">Description</th>
                        <th scope="col">Priority</th>
                        <th scope="col">Confidence</th>
                        <th scope="col">Impact</th>
                        <th scope="col">Aktion</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for gap in low_confidence_gaps|slice(0, 15) %}
                    <tr>
                        <td>
                            <small>
                                {{ gap.mapping.sourceRequirement.framework.code }}
                                ‚Üí
                                {{ gap.mapping.targetRequirement.framework.code }}
                            </small>
                        </td>
                        <td>
                            <span class="badge bg-light">{{ gap.gapTypeLabel }}</span>
                            <small class="d-block text-muted">{{ gap.description|slice(0, 80) }}...</small>
                        </td>
                        <td>
                            <span class="badge badge-{{ gap.priorityBadgeClass }}">
                                {{ gap.priority }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-warning">{{ gap.confidence }}%</span>
                        </td>
                        <td>
                            <span class="badge bg-danger">-{{ gap.percentageImpact }}%</span>
                        </td>
                        <td>
                            <a href="{{ path('app_mapping_quality_review', {id: gap.mapping.id}) }}" class="btn btn-sm btn-primary">
                                Review
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
            {% if low_confidence_gaps|length > 15 %}
                <p class="text-muted text-center mb-0">... und {{ low_confidence_gaps|length - 15 }} weitere</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {# Empty State #}
    {% if high_priority_gaps is empty and low_confidence_gaps is empty %}
        {% if remediation_effort.total_gaps == 0 %}
        <div class="alert alert-info">
            <h4>‚ÑπÔ∏è Keine Gaps gefunden</h5>
            <p>Es wurden noch keine Gap-Analysen durchgef√ºhrt.</p>
            <hr>
            <h4>N√§chste Schritte:</h5>
            <ol>
                <li>F√ºhren Sie die Qualit√§tsanalyse aus: <code>php bin/console app:analyze-mapping-quality</code></li>
                <li>Gaps werden automatisch w√§hrend der Analyse identifiziert</li>
                <li>Kehren Sie dann zu dieser Seite zur√ºck</li>
            </ol>
            <a href="{{ path('app_mapping_quality_dashboard') }}" class="btn btn-primary mt-2">‚Üê Zur√ºck zum Dashboard</a>
        </div>
        {% else %}
        <div class="alert alert-success">
            <h5>‚úÖ Keine kritischen Gaps!</h5>
            <p class="mb-0">Alle Gaps haben niedrige Priorit√§t oder wurden bereits behoben.</p>
        </div>
        {% endif %}
    {% endif %}

    {# Action Buttons #}
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0">üõ†Ô∏è Aktionen</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h4>üìã Priorisierung</h5>
                    <ol>
                        <li>Critical Gaps zuerst ({{ gap_stats_by_priority[0].count ?? 0 }})</li>
                        <li>High Priority Gaps ({{ gap_stats_by_priority[1].count ?? 0 }})</li>
                        <li>Low Confidence Gaps √ºberpr√ºfen</li>
                    </ol>
                </div>
                <div class="col-md-4">
                    <h4>‚è±Ô∏è Zeitplanung</h5>
                    <p>
                        <strong>Total:</strong> {{ remediation_effort.total_effort }} Stunden<br>
                        <strong>‚âà {{ (remediation_effort.total_effort / 8)|round(1) }} Tage</strong> bei einem 8h-Arbeitstag
                    </p>
                </div>
                <div class="col-md-4">
                    <h4>üìä Tracking</h5>
                    <p>√Ñndern Sie den Gap-Status in den jeweiligen Mapping-Reviews:</p>
                    <ul>
                        <li>identified ‚Üí planned</li>
                        <li>planned ‚Üí in_progress</li>
                        <li>in_progress ‚Üí resolved</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
