{% extends 'base.html.twig' %}

{% block title %}{{ framework.name }}{% if framework.version %} (v{{ framework.version }}){% endif %}{% endblock %}

{% block body %}
<div class="container">
    {# Breadcrumb Navigation #}
    <nav aria-label="breadcrumb" class="compliance-breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('app_compliance_index') }}">{{ 'nav.compliance'|trans({}, 'nav') }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ framework.code }}</li>
        </ol>
    </nav>

    <div class="page-header">
        <div>
            <h1>{{ framework.name }}{% if framework.version %} <span class="version-muted-small">(v{{ framework.version }})</span>{% endif %}</h1>
            <p class="text-muted">{{ framework.description|length > 100 ? framework.description|slice(0, 100) ~ '...' : framework.description }}</p>
        </div>
        <div class="button-group">
            {# Framework Quick Switcher #}
            {% set all_frameworks = get_compliance_frameworks_quick() %}
            {% if all_frameworks|length > 1 %}
            <div class="framework-switcher">
                <select id="framework-switcher" class="form-select form-select-sm" onchange="window.location.href=this.value">
                    <option value="" disabled>{{ 'compliance.switch_framework'|trans({}, 'compliance')|default('Switch Framework') }}</option>
                    {% for fw in all_frameworks %}
                    <option value="{{ path('app_compliance_framework', {id: fw.id}) }}" {% if fw.id == framework.id %}selected{% endif %}>
                        {{ fw.code }} {% if fw.mandatory %}(!){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <a href="{{ path('app_compliance_index') }}" class="btn btn-secondary">
                ‚Üê {{ 'compliance.button.back'|trans({}, 'compliance') }}
            </a>
            <a href="{{ path('app_compliance_assess', {id: framework.id}) }}" class="btn btn-success">
                {{ 'compliance.button.reassess'|trans({}, 'compliance') }}
            </a>
        </div>
    </div>

    {# Quick Stats Bar - Always Visible #}
    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-label">{{ 'compliance.label.compliance'|trans({}, 'compliance') }}</div>
            <div class="stat-value">{{ dashboard.compliance_percentage }}%</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">{{ 'compliance.label.requirements'|trans({}, 'compliance') }}</div>
            <div class="stat-value">{{ dashboard.statistics.applicable }}/{{ dashboard.statistics.total }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">{{ 'compliance.label.fulfilled'|trans({}, 'compliance') }}</div>
            <div class="stat-value stat-value-success">{{ dashboard.statistics.fulfilled }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">{{ 'compliance.label.gaps'|trans({}, 'compliance') }}</div>
            <div class="stat-value stat-value-danger">{{ dashboard.gaps.total }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">{{ 'compliance.label.time_savings'|trans({}, 'compliance') }}</div>
            <div class="stat-value">{{ dashboard.data_reuse.total_days_saved }} {{ 'compliance.label.days'|trans({}, 'compliance') }}</div>
        </div>
    </div>

    {# Workflow Steps Checklist - NEW! #}
    <div class="workflow-steps-card">
        <div class="workflow-header">
            <h2>üéØ Your Compliance Workflow</h2>
            <p class="text-muted">Follow these steps to achieve 100% compliance</p>
        </div>
        <div class="workflow-steps">
            <div class="workflow-step {% if dashboard.statistics.total > 0 %}completed{% endif %}"
                 data-bs-toggle="tooltip" data-bs-placement="top"
                 title="{{ 'common.tooltip.framework_loaded_success'|trans({}, 'messages') }}">
                <div class="step-icon">{% if dashboard.statistics.total > 0 %}‚úÖ{% else %}1Ô∏è‚É£{% endif %}</div>
                <div class="step-content">
                    <h2>Framework Loaded</h2>
                    <p>{{ dashboard.statistics.total }} requirements loaded</p>
                </div>
            </div>

            <div class="workflow-step {% if dashboard.statistics.applicable > 0 %}active{% endif %} {% if dashboard.statistics.applicable == dashboard.statistics.total %}completed{% endif %}"
                 data-bs-toggle="tooltip" data-bs-placement="top"
                 title="Review each requirement and mark whether it applies to your organization. Non-applicable requirements won't count towards your compliance score.">
                <div class="step-icon">{% if dashboard.statistics.applicable == dashboard.statistics.total %}‚úÖ{% else %}{% if dashboard.statistics.applicable > 0 %}üîÑ{% else %}2Ô∏è‚É£{% endif %}{% endif %}</div>
                <div class="step-content">
                    <h3>Review & Mark Applicable</h3>
                    <p>{{ dashboard.statistics.applicable }} of {{ dashboard.statistics.total }} reviewed</p>
                    {% if dashboard.statistics.applicable < dashboard.statistics.total %}
                        <a href="{{ path('app_compliance_requirement_index') }}?framework={{ framework.id }}" class="step-action"
                           data-bs-toggle="tooltip" data-bs-placement="right"
                           title="{{ 'common.tooltip.opens_requirements_list'|trans({}, 'messages') }}">
                            ‚Üí Review Requirements
                        </a>
                    {% endif %}
                </div>
            </div>

            <div class="workflow-step {% if dashboard.statistics.fulfilled > 0 %}active{% endif %} {% if dashboard.statistics.fulfilled == dashboard.statistics.applicable %}completed{% endif %}"
                 data-bs-toggle="tooltip" data-bs-placement="top"
                 title="Link requirements to existing controls or create new controls to implement them. This shows how you're fulfilling each requirement.">
                <div class="step-icon">{% if dashboard.statistics.fulfilled == dashboard.statistics.applicable %}‚úÖ{% else %}{% if dashboard.statistics.fulfilled > 0 %}üîÑ{% else %}3Ô∏è‚É£{% endif %}{% endif %}</div>
                <div class="step-content">
                    <h3>Implement Requirements</h3>
                    <p>{{ dashboard.statistics.fulfilled }} of {{ dashboard.statistics.applicable }} requirements fully implemented</p>
                    {% if dashboard.gaps.total > 0 %}
                        <a href="{{ path('app_compliance_requirement_index') }}?framework={{ framework.id }}&sort=fulfillment" class="step-action"
                           data-bs-toggle="tooltip" data-bs-placement="right"
                           title="{{ 'common.tooltip.requirements_sorted_by_fulfillment'|trans({}, 'messages') }}">
                            ‚Üí Implement Requirements
                        </a>
                    {% endif %}
                </div>
            </div>

            <div class="workflow-step {% if dashboard.compliance_percentage >= 75 %}active{% endif %} {% if dashboard.compliance_percentage == 100 %}completed{% endif %}"
                 data-bs-toggle="tooltip" data-bs-placement="top"
                 title="{{ 'common.tooltip.reach_100_percent'|trans({}, 'messages') }}">
                <div class="step-icon">{% if dashboard.compliance_percentage == 100 %}‚úÖ{% else %}{% if dashboard.compliance_percentage >= 75 %}üîÑ{% else %}4Ô∏è‚É£{% endif %}{% endif %}</div>
                <div class="step-content">
                    <h3>Achieve 100% Compliance</h3>
                    <p>Currently at {{ dashboard.compliance_percentage }}%</p>
                    {% if dashboard.compliance_percentage < 100 %}
                        <a href="{{ path('app_compliance_gaps', {id: framework.id}) }}" class="step-action"
                           data-bs-toggle="tooltip" data-bs-placement="right"
                           title="{{ 'common.tooltip.view_gap_analysis'|trans({}, 'messages') }}">
                            ‚Üí View {{ dashboard.gaps.total }} Gaps
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Module Dependencies - NEW! #}
    {% if framework.requiredModules|length > 0 %}
    <div class="card mb-4">
        <div class="card-header">
            <h2>üîß {{ 'compliance.required_modules'|trans({}, 'compliance') }}</h2>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                This framework requires the following ISMS modules to be activated for full compliance.
            </p>
            <div class="modules-grid">
                {% for moduleKey in framework.requiredModules %}
                    {% set module = all_modules[moduleKey] ?? null %}
                    {% set isActive = moduleKey in active_modules %}

                    {% if module %}
                        <div class="module-card {% if isActive %}active{% else %}inactive{% endif %}">
                            <div class="module-status">
                                {% if isActive %}
                                    <span class="status-icon active">‚úÖ</span>
                                    <span class="status-text active">Active</span>
                                {% else %}
                                    <span class="status-icon inactive">‚ö†Ô∏è</span>
                                    <span class="status-text inactive">Not Active</span>
                                {% endif %}
                            </div>
                            <h3 class="module-title">{{ module.name }}</h3>
                            <p class="module-description">{{ module.description }}</p>
                            {% if not isActive %}
                                <a href="{{ path('admin_modules_index') }}" class="btn btn-primary btn-sm"
                                   data-bs-toggle="tooltip" data-bs-placement="top"
                                   title="{{ 'common.tooltip.activate_module'|trans({}, 'messages') }}">
                                    {{ 'common.activate'|trans({}, 'messages') }} Module ‚Üí
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {# Next Action Recommendation - NEW! #}
    {% set next_action = null %}
    {% if dashboard.gaps.total > 0 and dashboard.gaps.critical > 0 %}
        {% set next_action = {
            'title': 'Address Critical Gaps',
            'description': 'You have ' ~ dashboard.gaps.critical ~ ' critical requirement(s) with low fulfillment',
            'action_url': path('app_compliance_requirement_index') ~ '?framework=' ~ framework.id ~ '&priority=critical&sort=fulfillment',
            'action_text': 'View Critical Requirements',
            'icon': 'üî¥',
            'priority': 'high'
        } %}
    {% elseif dashboard.statistics.applicable < dashboard.statistics.total %}
        {% set next_action = {
            'title': 'Review Remaining Requirements',
            'description': (dashboard.statistics.total - dashboard.statistics.applicable) ~ ' requirements need applicability review',
            'action_url': path('app_compliance_requirement_index') ~ '?framework=' ~ framework.id,
            'action_text': 'Review Requirements',
            'icon': 'üìù',
            'priority': 'medium'
        } %}
    {% elseif dashboard.gaps.total > 0 %}
        {% set next_action = {
            'title': 'Fill Compliance Gaps',
            'description': dashboard.gaps.total ~ ' requirements need controls or improved implementation',
            'action_url': path('app_compliance_gaps', {id: framework.id}),
            'action_text': 'View Gap Analysis',
            'icon': '‚ö†Ô∏è',
            'priority': 'medium'
        } %}
    {% elseif dashboard.compliance_percentage < 100 %}
        {% set next_action = {
            'title': 'Complete Remaining Items',
            'description': 'You\'re at ' ~ dashboard.compliance_percentage ~ '% - almost there!',
            'action_url': path('app_compliance_requirement_index') ~ '?framework=' ~ framework.id ~ '&sort=fulfillment',
            'action_text': 'View All Requirements',
            'icon': 'üéØ',
            'priority': 'low'
        } %}
    {% endif %}

    {% if next_action %}
    <div class="next-action-card priority-{{ next_action.priority }}">
        <div class="next-action-icon">{{ next_action.icon }}</div>
        <div class="next-action-content">
            <h3>{{ next_action.title }}</h3>
            <p>{{ next_action.description }}</p>
            <a href="{{ next_action.action_url }}" class="btn btn-primary">
                {{ next_action.action_text }} ‚Üí
            </a>
        </div>
    </div>
    {% else %}
    <div class="next-action-card success">
        <div class="next-action-icon">üéâ</div>
        <div class="next-action-content">
            <h3>Congratulations!</h3>
            <p>You have achieved 100% compliance with {{ framework.name }}!</p>
            <a href="{{ path('app_compliance_index') }}" class="btn btn-success">
                Back to All Frameworks ‚Üí
            </a>
        </div>
    </div>
    {% endif %}

    {# Tab Navigation - Clean and Simple #}
    <div class="tabs" data-controller="toggle">
        <div class="tab-nav">
            <button class="tab-button active" data-action="click->toggle#switchTab" data-tab="overview">
                {{ 'compliance.tab.overview'|trans({}, 'compliance') }}
            </button>
            <button class="tab-button" data-action="click->toggle#switchTab" data-tab="requirements">
                {{ 'compliance.tab.requirements'|trans({}, 'compliance') }}
            </button>
            <button class="tab-button" data-action="click->toggle#switchTab" data-tab="gaps">
                {{ 'compliance.tab.gaps'|trans({}, 'compliance') }} ({{ dashboard.gaps.total }})
            </button>
            <button class="tab-button" data-action="click->toggle#switchTab" data-tab="data-reuse">
                {{ 'compliance.tab.data_reuse'|trans({}, 'compliance') }}
            </button>
        </div>

        {# Tab: Overview #}
        <div class="tab-content active" data-tab-content="overview">
            <div class="card">
                <div class="card-header">
                    <h2>{{ 'compliance.framework_info'|trans({}, 'compliance') }}</h2>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">{{ 'compliance.label.code'|trans({}, 'compliance') }}:</span>
                            <span class="value">{{ framework.code }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">{{ 'compliance.version'|trans({}, 'compliance') }}:</span>
                            <span class="value">{{ framework.version }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">{{ 'compliance.industry'|trans({}, 'compliance') }}:</span>
                            <span class="value">{{ framework.applicableIndustry|replace({'_': ' '})|title }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">{{ 'compliance.regulatory_body'|trans({}, 'compliance') }}:</span>
                            <span class="value">{{ framework.regulatoryBody }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">{{ 'compliance.mandatory'|trans({}, 'compliance') }}:</span>
                            <span class="value">
                                {% if framework.mandatory %}
                                    <span class="badge bg-danger">{{ 'compliance.label.yes'|trans({}, 'compliance') }}</span>
                                {% else %}
                                    <span class="badge bg-success">{{ 'compliance.label.no'|trans({}, 'compliance') }}</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            {# Recommendations - Only if there are any #}
            {% if dashboard.recommendations is not empty %}
                <div class="card">
                    <div class="card-header">
                        <h2>{{ 'compliance.recommendations'|trans({}, 'compliance') }}</h2>
                    </div>
                    <div class="card-body">
                        {% for recommendation in dashboard.recommendations %}
                            <div class="recommendation-item priority-{{ recommendation.priority }}">
                                <div class="recommendation-header">
                                    <span class="badge badge-{{ recommendation.priority == 'high' ? 'danger' : (recommendation.priority == 'medium' ? 'warning' : 'info') }}">
                                        {{ recommendation.priority|upper }}
                                    </span>
                                    <strong>{{ recommendation.title }}</strong>
                                </div>
                                <p>{{ recommendation.description }}</p>
                                <div class="recommendation-action">
                                    <small>üëâ {{ recommendation.action }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>

        {# Tab: Requirements - Grouped by Type #}
        <div class="tab-content" data-tab-content="requirements">
            <div class="card">
                <div class="card-header">
                    <h2>{{ 'compliance.tab.requirements'|trans({}, 'compliance') }}</h2>
                    <div class="filter-toggle">
                        <button class="btn btn-sm btn-secondary" data-action="click->toggle#toggleFilter">
                            {{ 'compliance.filter'|trans({}, 'compliance') }}
                        </button>
                    </div>
                </div>

                {# Filter Panel - Hidden by Default #}
                <div class="filter-panel d-none" data-toggle-target="filterPanel">
                    <input type="text" class="search-input" placeholder="{{ 'compliance.search'|trans({}, 'compliance') }}" id="reqSearch">
                    <select id="reqPriority">
                        <option value="">{{ 'compliance.priority.all'|trans({}, 'compliance') }}</option>
                        <option value="critical">{{ 'compliance.priority.critical'|trans({}, 'compliance') }}</option>
                        <option value="high">{{ 'compliance.priority.high'|trans({}, 'compliance') }}</option>
                        <option value="medium">{{ 'compliance.priority.medium'|trans({}, 'compliance') }}</option>
                        <option value="low">{{ 'compliance.priority.low'|trans({}, 'compliance') }}</option>
                    </select>
                    <select id="reqStatus">
                        <option value="">{{ 'compliance.status.all'|trans({}, 'compliance') }}</option>
                        <option value="fulfilled">{{ 'compliance.status.fulfilled'|trans({}, 'compliance') }}</option>
                        <option value="partial">{{ 'compliance.status.partial'|trans({}, 'compliance') }}</option>
                        <option value="gap">{{ 'compliance.status.gap'|trans({}, 'compliance') }}</option>
                    </select>
                </div>

                <div class="requirements-list">
                    {% set core_requirements = requirements|filter(r => r.requirementType == 'core') %}
                    {% for requirement in core_requirements %}
                        <div class="requirement-item" data-controller="toggle">
                            <div class="requirement-header" data-action="click->toggle#toggleContent">
                                <div class="requirement-info">
                                    <span class="requirement-id">{{ requirement.requirementId }}</span>
                                    <span class="requirement-title">{{ requirement.title }}</span>
                                    {% if requirement.hasDetailedRequirements() %}
                                        <span class="badge bg-info">
                                            {{ requirement.detailedRequirements|length }} Details
                                        </span>
                                    {% endif %}
                                </div>
                                <div class="requirement-status">
                                    <span class="badge badge-{{ requirement.priority == 'critical' ? 'danger' : (requirement.priority == 'high' ? 'warning' : 'secondary') }}">
                                        {{ requirement.priority|upper }}
                                    </span>
                                    {% set fulfillment = fulfillments[requirement.id] %}
                                    <div class="progress-mini">
                                        <div class="progress-fill" style="width: {{ fulfillment.fulfillmentPercentage }}%; background: {{ fulfillment.fulfillmentPercentage >= 75 ? 'var(--color-success)' : (fulfillment.fulfillmentPercentage >= 50 ? 'var(--color-warning)' : 'var(--color-danger)') }};"></div>
                                    </div>
                                    <span class="percentage">{{ fulfillment.fulfillmentPercentage }}%</span>
                                    {% if requirement.hasDetailedRequirements() %}
                                        <span class="expand-icon" data-toggle-target="expandIcon">‚ñº</span>
                                    {% endif %}
                                </div>
                            </div>

                            {# Detailed Requirements - Hidden by Default #}
                            {% if requirement.hasDetailedRequirements() %}
                                <div class="requirement-details d-none" data-toggle-target="content">
                                    <div class="detailed-requirements">
                                        {% for detailed in requirement.detailedRequirements %}
                                            {% set detailedFulfillment = fulfillments[detailed.id] %}
                                            <div class="detailed-requirement">
                                                <div class="detailed-header">
                                                    <span class="detailed-id">{{ detailed.requirementId }}</span>
                                                    <span class="detailed-title">{{ detailed.title }}</span>
                                                </div>
                                                <div class="detailed-status">
                                                    <div class="progress-mini">
                                                        <div class="progress-fill" style="width: {{ detailedFulfillment.fulfillmentPercentage }}%;"></div>
                                                    </div>
                                                    <span class="percentage-small">{{ detailedFulfillment.fulfillmentPercentage }}%</span>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# Tab: Gaps - Only show critical information #}
        <div class="tab-content" data-tab-content="gaps">
            <div class="card">
                <div class="card-header">
                    <h2>{{ 'compliance.gaps.title'|trans({}, 'compliance') }}</h2>
                </div>
                <div class="card-body">
                    {% if dashboard.gaps.total > 0 %}
                        {% for gap in dashboard.gaps.list %}
                            <div class="gap-item priority-{{ gap.priority }}">
                                <div class="gap-header">
                                    <div>
                                        <span class="requirement-id">{{ gap.requirementId }}</span>
                                        <strong>{{ gap.title }}</strong>
                                    </div>
                                    <span class="badge badge-{{ gap.priority == 'critical' ? 'danger' : 'warning' }}">
                                        {{ gap.priority|upper }}
                                    </span>
                                </div>
                                <div class="gap-progress">
                                    {% set gapFulfillment = fulfillments[gap.id] %}
                                    {% set fulfillmentPct = gapFulfillment ? gapFulfillment.fulfillmentPercentage : 0 %}
                                    <div class="progress-bar">
                                        <div class="progress-fill bg-danger" style="width: {{ fulfillmentPct }}%;"></div>
                                    </div>
                                    <span>{{ fulfillmentPct }}{{ 'compliance.gaps.fulfilled_percentage'|trans({}, 'compliance') }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center p-xl">
                            <div class="icon-3rem-mb-md">‚úÖ</div>
                            <h3>{{ 'compliance.gaps.none'|trans({}, 'compliance') }}</h3>
                            <p class="text-muted">{{ 'compliance.gaps.none_description'|trans({}, 'compliance') }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Tab: Data Reuse #}
        <div class="tab-content" data-tab-content="data-reuse">
            <div class="card">
                <div class="card-header">
                    <h2>{{ 'compliance.tab.data_reuse'|trans({}, 'compliance') }}</h2>
                </div>
                <div class="card-body">
                    <div class="value-highlight">
                        <div class="value-icon">üíé</div>
                        <div class="value-content">
                            <h3>{{ dashboard.data_reuse.total_hours_saved }} {{ 'compliance.data_reuse.hours_saved'|trans({}, 'compliance') }}</h3>
                            <p>{{ 'compliance.data_reuse.work_days'|trans({'%days%': dashboard.data_reuse.total_days_saved}, 'compliance') }}</p>
                        </div>
                    </div>
                    <a href="{{ path('app_compliance_data_reuse', {id: framework.id}) }}" class="btn btn-primary">
                        {{ 'compliance.data_reuse.show_details'|trans({}, 'compliance') }} ‚Üí
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Compliance Breadcrumb */
.compliance-breadcrumb {
    margin-bottom: var(--spacing-md);
}

.compliance-breadcrumb .breadcrumb {
    background: transparent;
    padding: 0;
    margin: 0;
    font-size: 0.9rem;
}

.compliance-breadcrumb .breadcrumb-item a {
    color: var(--color-primary);
    text-decoration: none;
    transition: color 0.2s;
}

.compliance-breadcrumb .breadcrumb-item a:hover {
    color: var(--color-primary-dark);
    text-decoration: underline;
}

.compliance-breadcrumb .breadcrumb-item.active {
    color: var(--color-text-secondary);
    font-weight: 600;
}

.compliance-breadcrumb .breadcrumb-item + .breadcrumb-item::before {
    content: "‚Ä∫";
    color: var(--color-text-secondary);
}

/* Framework Switcher */
.framework-switcher {
    display: inline-block;
}

.framework-switcher select {
    min-width: 150px;
    background: white;
    border: 2px solid var(--color-primary);
    border-radius: var(--border-radius);
    padding: 0.4rem 2rem 0.4rem 0.8rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-primary);
    cursor: pointer;
    transition: all 0.2s;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23667eea' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
    background-size: 12px;
}

.framework-switcher select:hover {
    border-color: var(--color-primary-dark);
    box-shadow: 0 0 0 3px rgba(103, 126, 234, 0.1);
}

.framework-switcher select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(103, 126, 234, 0.2);
}

.stats-bar {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    margin-bottom: var(--spacing-lg);
    flex-wrap: wrap;
}

.stat-item {
    flex: 1;
    min-width: 120px;
    text-align: center;
}

.stat-label {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-xs);
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--color-primary);
}

.tabs {
    margin-top: var(--spacing-lg);
}

.tab-nav {
    display: flex;
    gap: var(--spacing-sm);
    border-bottom: 2px solid var(--color-border);
    margin-bottom: var(--spacing-lg);
}

.tab-button {
    padding: var(--spacing-md) var(--spacing-lg);
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 600;
    color: var(--color-text-secondary);
    transition: all 0.2s;
}

.tab-button:hover {
    color: var(--color-primary);
}

.tab-button.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-md);
}

.info-item {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--color-border);
}

.info-item .label {
    font-weight: 600;
    color: var(--color-text-secondary);
}

.recommendation-item {
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    background: var(--color-background);
    border-radius: var(--border-radius);
    border-left: 4px solid var(--color-primary);
}

.recommendation-item.priority-high {
    border-left-color: var(--color-danger);
}

.recommendation-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
}

.recommendation-action {
    margin-top: var(--spacing-sm);
    padding-top: var(--spacing-sm);
    border-top: 1px solid var(--color-border);
}

.requirements-list {
    max-height: 70vh;
    overflow-y: auto;
}

.requirement-item {
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    margin-bottom: var(--spacing-sm);
    overflow: hidden;
}

.requirement-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    cursor: pointer;
    transition: background 0.2s;
}

.requirement-header:hover {
    background: var(--color-background);
}

.requirement-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex: 1;
}

.requirement-id {
    font-weight: bold;
    color: var(--color-primary);
    min-width: 80px;
}

.requirement-status {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.progress-mini {
    width: 100px;
    height: 8px;
    background: var(--color-background);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    transition: width 0.3s;
}

.percentage {
    min-width: 45px;
    text-align: right;
    font-weight: 600;
}

.expand-icon {
    transition: transform 0.2s;
    font-size: 0.8rem;
}

.requirement-item.expanded .expand-icon {
    transform: rotate(180deg);
}

.requirement-details {
    padding: 0 var(--spacing-md) var(--spacing-md);
    background: var(--color-background);
}

.detailed-requirements {
    border-left: 2px solid var(--color-primary);
    padding-left: var(--spacing-md);
}

.detailed-requirement {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--color-border);
}

.detailed-requirement:last-child {
    border-bottom: none;
}

.detailed-id {
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-right: var(--spacing-sm);
}

.detailed-status {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.percentage-small {
    font-size: 0.85rem;
    min-width: 40px;
    text-align: right;
}

.gap-item {
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    background: white;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--color-warning);
}

.gap-item.priority-critical {
    border-left-color: var(--color-danger);
}

.gap-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
}

.gap-progress {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.value-highlight {
    display: flex;
    align-items: center;
    gap: var(--spacing-lg);
    padding: var(--spacing-xl);
    background: var(--gradient-success);
    color: white;
    border-radius: var(--border-radius);
    margin-bottom: var(--spacing-lg);
}

.value-icon {
    font-size: 4rem;
}

.value-content h3 {
    margin: 0 0 var(--spacing-xs) 0;
}

.value-content p {
    margin: 0;
    opacity: 0.9;
}

/* Workflow Steps Card */
.workflow-steps-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-lg);
}

.workflow-header {
    margin-bottom: var(--spacing-lg);
    text-align: center;
}

.workflow-header h2 {
    margin: 0 0 var(--spacing-xs) 0;
    color: var(--color-primary);
}

.workflow-steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
}

.workflow-step {
    position: relative;
    padding: var(--spacing-lg);
    border-radius: var(--border-radius);
    border: 2px solid var(--color-border);
    background: var(--color-background);
    transition: all 0.3s;
}

.workflow-step.active {
    border-color: var(--color-primary);
    background: rgba(var(--color-primary-rgb), 0.05);
}

.workflow-step.completed {
    border-color: var(--color-success);
    background: rgba(var(--color-success-rgb), 0.05);
}

.workflow-step .step-icon {
    font-size: 2rem;
    margin-bottom: var(--spacing-md);
    text-align: center;
}

.workflow-step .step-content h3 {
    font-size: 1rem;
    margin: 0 0 var(--spacing-xs) 0;
    color: var(--color-text);
}

.workflow-step .step-content p {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    margin: 0 0 var(--spacing-sm) 0;
}

.workflow-step .step-action {
    display: inline-block;
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    transition: color 0.2s;
}

.workflow-step .step-action:hover {
    color: var(--color-primary-dark);
    text-decoration: underline;
}

/* Next Action Card */
.next-action-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-xl);
    padding: var(--spacing-xl);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    margin-bottom: var(--spacing-lg);
}

.next-action-card.priority-high {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.next-action-card.priority-medium {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.next-action-card.priority-low {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.next-action-card.success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.next-action-icon {
    font-size: 4rem;
    flex-shrink: 0;
}

.next-action-content {
    flex: 1;
}

.next-action-content h3 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: 1.5rem;
    color: white;
}

.next-action-content p {
    margin: 0 0 var(--spacing-md) 0;
    opacity: 0.95;
    font-size: 1.1rem;
}

.next-action-content .btn {
    background: white;
    color: var(--color-primary);
    font-weight: 600;
}

.next-action-content .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .workflow-steps {
        grid-template-columns: 1fr;
    }

    .next-action-card {
        flex-direction: column;
        text-align: center;
    }

    .next-action-icon {
        font-size: 3rem;
    }
}

/* Module Cards */
.modules-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--spacing-lg);
}

.module-card {
    padding: var(--spacing-lg);
    border-radius: var(--border-radius);
    transition: all 0.2s;
    border: 2px solid;
}

.module-card.active {
    background: rgba(40, 167, 69, 0.05);
    border-color: rgba(40, 167, 69, 0.3);
}

.module-card.inactive {
    background: rgba(255, 193, 7, 0.05);
    border-color: rgba(255, 193, 7, 0.3);
}

.module-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.module-status {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
}

.status-icon {
    font-size: 1.5rem;
}

.status-text {
    font-weight: 600;
    font-size: 0.9rem;
}

.status-text.active {
    color: #28a745;
}

.status-text.inactive {
    color: #856404;
}

.module-title {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: 1.1rem;
    color: var(--color-text);
}

.module-description {
    margin: 0 0 var(--spacing-md) 0;
    color: var(--color-text-secondary);
    font-size: 0.9rem;
    line-height: 1.5;
}
</style>

<script>
// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            trigger: 'hover',
            html: false
        });
    });
});

// Also initialize on Turbo/AJAX navigation (if used)
document.addEventListener('turbo:load', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            trigger: 'hover',
            html: false
        });
    });
});
</script>
{% endblock %}
