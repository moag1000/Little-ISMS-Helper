{% extends 'base.html.twig' %}

{% block title %}{{ 'compliance.title.transitive'|trans }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="d-flex justify-between align-center mb-4">
    <div>
        <h1>{{ 'compliance.title.transitive'|trans }}</h1>
        <p style="color: var(--color-text-light); margin-top: var(--spacing-sm);">
            {{ 'compliance.description.transitive'|trans }}
        </p>
    </div>
    <div>
        <a href="{{ path('app_compliance_export_transitive') }}" class="btn btn-success">
            üìä {{ 'compliance.action.export_transitive'|trans }}
        </a>
    </div>
</div>

{# Statistics Cards #}
<div class="kpi-grid">
    <div class="kpi-card">
        <div class="icon">üîó</div>
        <div class="label">{{ 'compliance.stats.total_relationships'|trans }}</div>
        <div>
            <span class="value">{{ totalRelationships }}</span>
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">‚úÖ</div>
        <div class="label">{{ 'compliance.stats.transitive_compliance'|trans }}</div>
        <div>
            <span class="value">{{ transitiveCompliance }}</span>
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">üìà</div>
        <div class="label">{{ 'compliance.stats.leverage_rate'|trans }}</div>
        <div>
            {% set leverageRate = totalRelationships > 0 ? (transitiveCompliance / totalRelationships * 100)|round : 0 %}
            <span class="value">{{ leverageRate }}</span>
            <span class="unit">%</span>
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">üéØ</div>
        <div class="label">{{ 'compliance.stats.frameworks_leveraged'|trans }}</div>
        <div>
            <span class="value">{{ frameworksLeveraged }}</span>
        </div>
    </div>
</div>

{# Transitive Compliance Explanation #}
<div class="info-box mb-4" style="background: var(--color-info-light); border-left: 4px solid var(--color-info);">
    <p><strong>‚ÑπÔ∏è {{ 'compliance.info.transitive_title'|trans }}</strong></p>
    <p style="margin-top: var(--spacing-xs);">{{ 'compliance.info.transitive_desc'|trans }}</p>
</div>

{# Framework Relationships #}
<h2>{{ 'compliance.section.framework_relationships'|trans }}</h2>

<div class="module-grid mb-4">
    {% for relationship in frameworkRelationships %}
    <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-md);">
            <div>
                <h3 style="font-size: 1.1rem; margin-bottom: var(--spacing-xs);">
                    {{ relationship.sourceFramework.name }}
                </h3>
                <div style="font-size: 1.5rem; color: var(--color-primary);">‚Üì</div>
                <h3 style="font-size: 1.1rem; margin-top: var(--spacing-xs);">
                    {{ relationship.targetFramework.name }}
                </h3>
            </div>
        </div>

        <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
            <div class="stat-item">
                <strong>{{ relationship.mappedRequirements }}</strong>
                <span>{{ 'compliance.field.mapped'|trans }}</span>
            </div>
            <div class="stat-item">
                <strong>{{ relationship.coveragePercentage }}%</strong>
                <span>{{ 'compliance.field.coverage'|trans }}</span>
            </div>
        </div>

        <div class="progress mt-2" style="height: 8px;">
            <div class="progress-bar" style="width: {{ relationship.coveragePercentage }}%;"></div>
        </div>

        <div class="mt-3">
            <a href="{{ path('app_compliance_relationship_details', {id: relationship.id}) }}" class="btn btn-sm">
                {{ 'common.view_details'|trans }}
            </a>
        </div>
    </div>
    {% else %}
    <div class="card" style="grid-column: 1 / -1;">
        <p style="text-align: center; color: var(--color-text-muted);">
            {{ 'compliance.message.no_relationships'|trans }}
        </p>
    </div>
    {% endfor %}
</div>

{# Transitive Compliance Matrix #}
<h2>{{ 'compliance.section.compliance_matrix'|trans }}</h2>

<div class="card mb-4">
    <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-md);">
        {{ 'compliance.description.matrix'|trans }}
    </p>

    <div class="table-container" style="overflow-x: auto;">
        <table style="min-width: 800px;">
            <thead>
                <tr>
                    <th style="position: sticky; left: 0; background: var(--color-bg); z-index: 10;">
                        {{ 'compliance.field.framework'|trans }}
                    </th>
                    {% for framework in frameworks %}
                    <th style="text-align: center;">{{ framework.shortName ?? framework.name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for sourceFramework in frameworks %}
                <tr>
                    <td style="position: sticky; left: 0; background: var(--color-bg); font-weight: bold;">
                        {{ sourceFramework.shortName ?? sourceFramework.name }}
                    </td>
                    {% for targetFramework in frameworks %}
                    <td style="text-align: center;">
                        {% if sourceFramework.id == targetFramework.id %}
                            <span style="color: var(--color-text-muted);">-</span>
                        {% else %}
                            {% set mapping = mapping_matrix[sourceFramework.id][targetFramework.id] ?? null %}
                            {% if mapping and mapping.coverage > 0 %}
                                <span class="badge badge-success">{{ mapping.coverage|round }}%</span>
                            {% else %}
                                <span class="badge badge-secondary">0%</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# Compliance Leverage Opportunities #}
<h2>{{ 'compliance.section.leverage_opportunities'|trans }}</h2>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>{{ 'compliance.field.source_requirement'|trans }}</th>
                <th>{{ 'compliance.field.source_framework'|trans }}</th>
                <th>{{ 'compliance.field.target_requirements'|trans }}</th>
                <th>{{ 'compliance.field.target_frameworks'|trans }}</th>
                <th style="text-align: center;">{{ 'compliance.field.leverage_impact'|trans }}</th>
                <th style="text-align: center;">{{ 'common.actions'|trans }}</th>
            </tr>
        </thead>
        <tbody>
            {% for opportunity in leverageOpportunities %}
            <tr>
                <td>
                    <strong>{{ opportunity.sourceRequirement.identifier }}</strong>
                    <br><small style="color: var(--color-text-muted);">{{ opportunity.sourceRequirement.name }}</small>
                </td>
                <td>
                    <span class="badge badge-info">{{ opportunity.sourceFramework.name }}</span>
                </td>
                <td>
                    {% for req in opportunity.targetRequirements %}
                        <div style="margin-bottom: var(--spacing-xs);">
                            <code>{{ req.identifier }}</code>
                        </div>
                    {% endfor %}
                </td>
                <td>
                    {% for framework in opportunity.targetFrameworks %}
                        <span class="badge badge-secondary" style="margin-right: var(--spacing-xs); margin-bottom: var(--spacing-xs);">
                            {{ framework.shortName ?? framework.name }}
                        </span>
                    {% endfor %}
                </td>
                <td style="text-align: center;">
                    <span class="badge badge-success">{{ opportunity.impactScore }}</span>
                </td>
                <td style="text-align: center;">
                    <a href="{{ path('app_compliance_leverage_details', {id: opportunity.id}) }}" class="btn btn-sm">
                        üëÅ {{ 'common.view'|trans }}
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                    {{ 'compliance.message.no_leverage_opportunities'|trans }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# Cross-Framework Mappings Details #}
<h2>{{ 'compliance.section.cross_framework_mappings'|trans }}</h2>

{% if cross_mappings is not empty %}
    {# Coverage Matrix #}
    <div class="card mb-4">
        <div style="padding: var(--spacing-lg);">
            <h3 style="margin-bottom: var(--spacing-md);">üìä {{ 'compliance.section.compliance_matrix'|trans }}</h3>
            <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-md);">
                {{ 'compliance.description.matrix'|trans }}
            </p>
            <div style="overflow-x: auto;">
                <table class="matrix-table" style="min-width: 600px; border-collapse: collapse; width: 100%;">
                    <thead>
                        <tr>
                            <th style="padding: var(--spacing-md); border: 1px solid var(--color-border); background: var(--color-bg); font-weight: 600;">
                                {{ 'compliance.label.source_target_matrix'|trans }}
                            </th>
                            {% for framework in frameworks %}
                                <th style="padding: var(--spacing-md); border: 1px solid var(--color-border); text-align: center; background: var(--color-bg); font-weight: 600;">
                                    {{ framework.code }}
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for sourceFramework in frameworks %}
                            <tr>
                                <td style="padding: var(--spacing-md); border: 1px solid var(--color-border); font-weight: bold;">
                                    {{ sourceFramework.code }}
                                </td>
                                {% for targetFramework in frameworks %}
                                    <td style="padding: var(--spacing-md); border: 1px solid var(--color-border); text-align: center;">
                                        {% if sourceFramework.id == targetFramework.id %}
                                            <span style="color: var(--color-text-muted); font-weight: 600;">100%</span>
                                        {% elseif coverage_matrix[sourceFramework.code][targetFramework.code] is defined %}
                                            {% set coverage = coverage_matrix[sourceFramework.code][targetFramework.code] %}
                                            {% set percentage = coverage.coverage_percentage ?? 0 %}
                                            <span style="font-weight: 600; font-size: 1.1rem; color: {{ percentage >= 75 ? 'var(--color-success)' : (percentage >= 50 ? 'var(--color-warning)' : 'var(--color-danger)') }};">
                                                {{ percentage|round }}%
                                            </span>
                                            <br>
                                            <small style="font-size: 0.75rem; color: var(--color-text-muted);">
                                                {{ coverage.covered_requirements }}/{{ coverage.total_target_requirements }}
                                            </small>
                                        {% else %}
                                            <span style="color: var(--color-text-muted);">‚Äî</span>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div style="display: flex; justify-content: center; gap: var(--spacing-lg); margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--color-bg-alt); border-radius: var(--border-radius);">
                <div style="display: flex; align-items: center; gap: var(--spacing-xs);">
                    <span style="width: 20px; height: 20px; background: var(--color-success); border-radius: 4px;"></span>
                    <span>{{ 'compliance.mapping.strength.high'|trans }}</span>
                </div>
                <div style="display: flex; align-items: center; gap: var(--spacing-xs);">
                    <span style="width: 20px; height: 20px; background: var(--color-warning); border-radius: 4px;"></span>
                    <span>{{ 'compliance.mapping.strength.medium'|trans }}</span>
                </div>
                <div style="display: flex; align-items: center; gap: var(--spacing-xs);">
                    <span style="width: 20px; height: 20px; background: var(--color-danger); border-radius: 4px;"></span>
                    <span>{{ 'compliance.mapping.strength.low'|trans }}</span>
                </div>
            </div>
        </div>
    </div>

    {# Detailed Mappings by Framework Pair #}
    {% for mapping_group in cross_mappings %}
        <div class="card mb-4">
            <div style="padding: var(--spacing-lg); border-bottom: 1px solid var(--color-border);">
                <h3 style="margin-bottom: var(--spacing-xs);">
                    {{ mapping_group.source.code }} ‚Üí {{ mapping_group.target.code }}
                </h3>
                <p style="color: var(--color-text-muted);">
                    {{ mapping_group.coverage.covered_requirements }} {{ 'compliance.field.mapped'|trans|lower }}
                    ({{ mapping_group.coverage.coverage_percentage|round }}% {{ 'compliance.field.coverage'|trans|lower }})
                </p>
            </div>

            <div style="display: flex; justify-content: space-around; padding: var(--spacing-lg); background: var(--color-bg-alt); border-bottom: 1px solid var(--color-border);">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--color-success); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">‚úì</div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--color-primary);">{{ mapping_group.coverage.strong_mappings ?? 0 }}</div>
                        <div style="font-size: 0.85rem; color: var(--color-text-muted);">{{ 'compliance.mapping.type.full'|trans }} (‚â•100%)</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--color-warning); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">‚ö†</div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--color-primary);">{{ mapping_group.coverage.partial_mappings ?? 0 }}</div>
                        <div style="font-size: 0.85rem; color: var(--color-text-muted);">{{ 'compliance.mapping.type.partial'|trans }} (50-99%)</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--color-secondary); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">‚óê</div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--color-primary);">{{ mapping_group.coverage.weak_mappings ?? 0 }}</div>
                        <div style="font-size: 0.85rem; color: var(--color-text-muted);">{{ 'compliance.mapping.type.weak'|trans }} (<50%)</div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>{{ 'compliance.field.source_requirement'|trans }}</th>
                            <th>{{ 'compliance.field.target_requirements'|trans }}</th>
                            <th>{{ 'compliance.field.mapping_type'|trans }}</th>
                            <th>{{ 'compliance.field.mapping_strength'|trans }}</th>
                            <th style="text-align: center;">{{ 'compliance.field.bidirectional'|trans }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mapping in mapping_group.mappings|slice(0, 10) %}
                            <tr>
                                <td>
                                    <strong>{{ mapping.sourceRequirement.requirementId }}</strong><br>
                                    <small style="color: var(--color-text-muted);">
                                        {{ mapping.sourceRequirement.title|length > 60 ? mapping.sourceRequirement.title|slice(0, 60) ~ '...' : mapping.sourceRequirement.title }}
                                    </small>
                                </td>
                                <td>
                                    <strong>{{ mapping.targetRequirement.requirementId }}</strong><br>
                                    <small style="color: var(--color-text-muted);">
                                        {{ mapping.targetRequirement.title|length > 60 ? mapping.targetRequirement.title|slice(0, 60) ~ '...' : mapping.targetRequirement.title }}
                                    </small>
                                </td>
                                <td>
                                    <span class="badge badge-{{ mapping.mappingBadgeClass }}">
                                        {{ mapping.mappingType|upper }}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                        <div style="flex: 1; height: 8px; background: var(--color-bg-alt); border-radius: 4px; overflow: hidden;">
                                            <div style="height: 100%; width: {{ mapping.mappingPercentage }}%; background: {{ mapping.mappingPercentage >= 100 ? 'var(--color-success)' : (mapping.mappingPercentage >= 50 ? 'var(--color-warning)' : 'var(--color-secondary)') }};"></div>
                                        </div>
                                        <span style="font-weight: 600; min-width: 50px; text-align: right;">{{ mapping.mappingPercentage }}%</span>
                                    </div>
                                </td>
                                <td style="text-align: center;">
                                    {% if mapping.bidirectional %}
                                        <span class="badge badge-success">üîÑ {{ 'common.yes'|trans }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary">‚Üí</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if mapping_group.mappings|length > 10 %}
                <div style="padding: var(--spacing-md); text-align: center; color: var(--color-text-muted); border-top: 1px solid var(--color-border);">
                    {{ 'compliance.label.showing_of'|trans({'%count%': 10}) }} {{ mapping_group.mappings|length }} {{ 'compliance.label.mappings_count'|trans }}
                </div>
            {% endif %}
        </div>
    {% endfor %}

    {# Explanation Section #}
    <div class="info-box mb-4" style="background: var(--color-info-light); border-left: 4px solid var(--color-info);">
        <h3 style="margin-bottom: var(--spacing-md);">üí° {{ 'compliance.section.mapping_explanation'|trans }}</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg);">
            <div>
                <h4 style="color: var(--color-primary); margin-bottom: var(--spacing-sm);">{{ 'compliance.explanation.what_are_mappings_title'|trans }}</h4>
                <p style="margin: 0;">{{ 'compliance.explanation.what_are_mappings'|trans }}</p>
            </div>
            <div>
                <h4 style="color: var(--color-primary); margin-bottom: var(--spacing-sm);">{{ 'compliance.explanation.mapping_types_title'|trans }}</h4>
                <ul style="margin: 0; padding-left: var(--spacing-lg);">
                    <li style="margin-bottom: var(--spacing-xs);"><strong>{{ 'compliance.explanation.mapping_types_exceeds'|trans }}</strong></li>
                    <li style="margin-bottom: var(--spacing-xs);"><strong>{{ 'compliance.explanation.mapping_types_full'|trans }}</strong></li>
                    <li style="margin-bottom: var(--spacing-xs);"><strong>{{ 'compliance.explanation.mapping_types_partial'|trans }}</strong></li>
                    <li style="margin-bottom: var(--spacing-xs);"><strong>{{ 'compliance.explanation.mapping_types_weak'|trans }}</strong></li>
                </ul>
            </div>
            <div>
                <h4 style="color: var(--color-primary); margin-bottom: var(--spacing-sm);">{{ 'compliance.explanation.bidirectional_title'|trans }}</h4>
                <p style="margin: 0;">{{ 'compliance.explanation.bidirectional'|trans }}</p>
            </div>
            <div>
                <h4 style="color: var(--color-primary); margin-bottom: var(--spacing-sm);">{{ 'compliance.explanation.strategic_value_title'|trans }}</h4>
                <p style="margin: 0;">{{ 'compliance.explanation.strategic_value'|trans }}</p>
            </div>
        </div>
    </div>
{% else %}
    <div class="card">
        <p style="text-align: center; color: var(--color-text-muted); padding: var(--spacing-xl);">
            {{ 'compliance.message.no_mappings'|trans }}
        </p>
    </div>
{% endif %}
{% endblock %}
