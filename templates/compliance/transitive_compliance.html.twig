{% extends 'base.html.twig' %}
{% trans_default_domain 'compliance' %}
{% import '_macros/cards.html.twig' as cards %}

{% block title %}{{ 'compliance.title.transitive'|trans({}, 'compliance') }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>üîó {{ 'compliance.title.transitive'|trans({}, 'compliance') }}</h1>
        <p class="text-muted">{{ 'compliance.description.transitive'|trans({}, 'compliance') }}</p>
    </div>
    <div class="button-group">
        <a href="{{ path('app_compliance_index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> {{ 'common.back'|trans({}, 'messages') }}
        </a>
        <button id="createAllMappingsBtn" class="btn btn-primary">
            üîó {{ 'compliance.action.create_missing_mappings'|trans({}, 'compliance') }}
        </button>
        <a href="{{ path('app_compliance_export_transitive_pdf') }}" class="btn btn-danger" data-turbo="false">
            üìÑ {{ 'compliance.action.export_pdf'|trans({}, 'compliance') }}
        </a>
        <a href="{{ path('app_compliance_export_transitive_excel') }}" class="btn btn-success" data-turbo="false">
            üìä {{ 'compliance.action.export_excel'|trans({}, 'compliance') }}
        </a>
        <a href="{{ path('app_compliance_export_transitive') }}" class="btn btn-secondary" data-turbo="false">
            üìÑ {{ 'compliance.action.export_csv'|trans({}, 'compliance') }}
        </a>
    </div>
</div>

{# Statistics Cards - Prominently displayed #}
<div class="kpi-grid mb-2">
    <div class="col-auto">
        {{ cards.kpi_card('compliance.stats.total_relationships'|trans({}, 'compliance'), total_relationships, null, null, 'primary', null) }}
    </div>
    <div class="col-auto">
        {{ cards.kpi_card('compliance.stats.transitive_compliance'|trans({}, 'compliance'), transitive_compliance, null, null, 'success', null) }}
    </div>
    <div class="col-auto">
        {% set leverageRate = total_relationships > 0 ? (transitive_compliance / total_relationships * 100)|round : 0 %}
        {{ cards.kpi_card('compliance.stats.leverage_rate'|trans({}, 'compliance'), leverageRate ~ '%', null, null, 'info', null) }}
    </div>
    <div class="col-auto">
        {{ cards.kpi_card('compliance.stats.frameworks_leveraged'|trans({}, 'compliance'), frameworks_leveraged, null, null, 'warning', null) }}
    </div>
</div>

{# Tabbed Interface for better organization #}
<div class="card mb-2" data-controller="tabs" data-tabs-active-class="active">
    <div class="tabs">
        <button class="tab-button active" data-tabs-target="button" data-action="click->tabs#switch" data-tab="overview">
            üìä {{ 'compliance.tab.overview'|trans({}, 'compliance') }}
        </button>
        <button class="tab-button" data-tabs-target="button" data-action="click->tabs#switch" data-tab="matrix">
            <i class="bi bi-grid-3x3" aria-hidden="true"></i> {{ 'compliance.tab.matrix'|trans({}, 'compliance') }}
        </button>
        <button class="tab-button" data-tabs-target="button" data-action="click->tabs#switch" data-tab="details">
            <i class="bi bi-list-check" aria-hidden="true"></i> {{ 'compliance.tab.details'|trans({}, 'compliance') }}
        </button>
        <button class="tab-button" data-tabs-target="button" data-action="click->tabs#switch" data-tab="info">
            <i class="bi bi-lightbulb" aria-hidden="true"></i> {{ 'compliance.tab.explanation'|trans({}, 'compliance') }}
        </button>
    </div>

    {# Tab 1: Overview #}
    <div id="tab-overview" class="tab-content active" data-tabs-target="panel" data-tab="overview">
        <h2 class="section-title">{{ 'compliance.section.framework_relationships'|trans({}, 'compliance') }}</h2>

        {% if framework_relationships is empty %}
            <div class="card gradient-purple">
                <div class="icon-xlarge mb-md">üîó</div>
                <h2 class="fs-15-white-mb">Noch keine Framework-Mappings vorhanden</h2>
                <p class="fs-11-lh-mb">
                    Die Cross-Framework Mappings zwischen Ihren Compliance-Frameworks wurden noch nicht erstellt.
                    <br>Diese Mappings zeigen, wie Anforderungen verschiedener Frameworks zusammenh√§ngen.
                </p>
                <div class="info-box-white">
                    <h4 class="h-white-no-mt-mb-sm"><i class="bi bi-lightbulb" aria-hidden="true"></i> So erstellen Sie Mappings:</h4>
                    <p class="fs-095-opacity-09">
                        Mappings m√ºssen manuell erstellt oder √ºber ein Datenimport-Script geladen werden.
                        <br>Kontaktieren Sie Ihren Administrator f√ºr weitere Informationen.
                    </p>
                </div>
                <div class="inline-flex-center-wrap">
                    <button id="createMappingsBtn" class="btn btn-light btn-light-primary-flex">
                        <span id="btnIcon">üîó</span>
                        <span id="btnText">Mappings jetzt erstellen</span>
                    </button>
                    <a href="{{ path('app_compliance_index') }}" class="btn btn-outline-light fw-600">
                        ‚Üê {{ 'common.back_to_overview'|trans({}, 'messages') }}
                    </a>
                </div>
            </div>
        {% else %}
            <div class="grid-responsive-350">
                {% for relationship in framework_relationships %}
                <div class="card card-border-hover">
                    <div class="flex-center-gap-1">
                        <div class="flex-1">
                            <div class="fw-600-fs-095-secondary-mb">
                                {{ relationship.sourceFramework.code }}
                            </div>
                            <div class="fs-2-primary-center-margin">
                                ‚Üì
                            </div>
                            <div class="fw-600-fs-095-secondary-mt">
                                {{ relationship.targetFramework.code }}
                            </div>
                        </div>

                        <div class="text-center">
                            <div class="fs-2-fw-bold-success">
                                {{ relationship.coveragePercentage }}%
                            </div>
                            <div class="fs-075-text-secondary">
                                Coverage
                            </div>
                        </div>
                    </div>

                    <div class="box-bg-alt-p-075-rounded-mb">
                        <div class="flex-space-between-center">
                            <span class="fs-085-text-secondary">
                                {{ 'compliance.field.mapped'|trans({}, 'compliance') }}:
                            </span>
                            <span class="fw-600-fs-11-primary">
                                {{ relationship.mappedRequirements }}
                            </span>
                        </div>
                    </div>

                    <div class="progress progress-bar-bg">
                        <div class="progress-bar" style="width: {{ relationship.coveragePercentage }}%; height: 10px; border-radius: 5px; background: linear-gradient(to right, var(--color-success), var(--color-info)); transition: width 0.3s;"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    {# Tab 2: Matrix #}
    <div id="tab-matrix" class="tab-content" data-tabs-target="panel" data-tab="matrix" style="display: none;">
        <h2 class="section-title">{{ 'compliance.section.compliance_matrix'|trans({}, 'compliance') }}</h2>
        <p class="text-secondary-mb-15">
            {{ 'compliance.description.matrix'|trans({}, 'compliance') }}
        </p>

        <div class="overflow-auto-mb">
            {% embed '_components/_table.html.twig' with {
                'class': 'table-full-collapse',
                'noMargin': true
            } %}
                {% block table_head %}
                    <tr class="bg-alt">
                        <th scope="col" class="th-sticky-left">
                            Von ‚Üí Nach
                        </th>
                        {% for framework in frameworks %}
                            <th scope="col" class="th-center">
                                {{ framework.code }}
                            </th>
                        {% endfor %}
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for sourceFramework in frameworks %}
                        <tr>
                            <td class="td-sticky-left">
                                {{ sourceFramework.code }}
                            </td>
                            {% for targetFramework in frameworks %}
                                <td class="td-center">
                                    {% if sourceFramework.id == targetFramework.id %}
                                        <span class="fs-1-fw-600-muted">100%</span>
                                    {% else %}
                                        {% set mapping = mapping_matrix[sourceFramework.id][targetFramework.id] ?? null %}
                                        {% if mapping and mapping.coverage > 0 %}
                                            {% set percentage = mapping.coverage|round %}
                                            <span class="badge badge-lg bg-{% if percentage >= 75 %}success{% elseif percentage >= 50 %}warning{% else %}danger{% endif %}">
                                                {{ percentage }}%
                                            </span>
                                        {% else %}
                                            <span class="badge-matrix-zero">
                                                0%
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
        </div>

        <div class="legend-container">
            <div class="flex-center-gap">
                <span class="legend-success"></span>
                <span class="small">‚â• 75%</span>
            </div>
            <div class="flex-center-gap">
                <span class="legend-warning"></span>
                <span class="small">50-74%</span>
            </div>
            <div class="flex-center-gap">
                <span class="legend-danger"></span>
                <span class="small">< 50%</span>
            </div>
        </div>
    </div>

    {# Tab 3: Detailed Mappings #}
    <div id="tab-details" class="tab-content" data-tabs-target="panel" data-tab="details" style="display: none;">
        <h2 class="section-title">{{ 'compliance.section.cross_framework_mappings'|trans({}, 'compliance') }}</h2>

        {% if cross_mappings is empty %}
            <div class="card gradient-pink">
                <div class="icon-xlarge mb-md"><i class="bi bi-list-check" aria-hidden="true"></i></div>
                <h2 class="fs-15-white-mb">Keine detaillierten Mappings verf√ºgbar</h2>
                <p class="fs-11-lh-mb-sm">
                    Es wurden noch keine Cross-Framework Mappings zwischen den Requirements erstellt.
                </p>
                <div class="info-box-white-no-mb">
                    <p class="fs-095-opacity-09">
                        <i class="bi bi-lightbulb" aria-hidden="true"></i> Mappings werden ben√∂tigt, um zu zeigen, wie sich Anforderungen verschiedener
                        Compliance-Frameworks gegenseitig abdecken.
                    </p>
                </div>
            </div>
        {% else %}
            {% for mapping_group in cross_mappings %}
                <details class="card mb-border" open>
                    <summary class="summary-interactive">
                        <span class="mr-xs">‚ñ∂</span>
                        {{ mapping_group.source.code }} ‚Üí {{ mapping_group.target.code }}
                        <span class="float-right-fs-1-secondary">
                            {{ mapping_group.coverage.covered_requirements }} mappings ({{ mapping_group.coverage.coverage_percentage|round }}%)
                        </span>
                    </summary>

                    <div class="details-padding">
                        <div class="grid-responsive-200-my">
                            <div class="mapping-card-success">
                                <div class="fs-2-fw-bold-success">
                                    {{ mapping_group.coverage.strong_mappings ?? 0 }}
                                </div>
                                <div class="small-text-secondary">
                                    {{ 'compliance.mapping.type.full'|trans({}, 'compliance') }}
                                </div>
                            </div>
                            <div class="mapping-card-warning">
                                <div class="fs-2-fw-bold-warning">
                                    {{ mapping_group.coverage.partial_mappings ?? 0 }}
                                </div>
                                <div class="small-text-secondary">
                                    {{ 'compliance.mapping.type.partial'|trans({}, 'compliance') }}
                                </div>
                            </div>
                            <div class="mapping-card-alt">
                                <div class="fs-2-fw-bold-secondary">
                                    {{ mapping_group.coverage.weak_mappings ?? 0 }}
                                </div>
                                <div class="small-text-secondary">
                                    {{ 'compliance.mapping.type.weak'|trans({}, 'compliance') }}
                                </div>
                            </div>
                        </div>

                        {% if mapping_group.mappings|length > 5 %}
                            <p class="text-center-italic-margin">
                                Zeige erste 5 von {{ mapping_group.mappings|length }} Mappings
                            </p>
                        {% endif %}

                        <div class="overflow-auto">
                            {% embed '_components/_table.html.twig' with {
                                'class': 'table-collapse',
                                'theadClass': 'bg-alt',
                                'noMargin': true
                            } %}
                                {% block table_head %}
                                    <tr>
                                        <th scope="col" class="th-left-fs-09">{{ 'compliance.field.source_requirement'|trans({}, 'compliance') }}</th>
                                        <th scope="col" class="th-left-fs-09">{{ 'compliance.field.target_requirements'|trans({}, 'compliance') }}</th>
                                        <th scope="col" class="td-center-fs-09">{{ 'compliance.field.mapping_strength'|trans({}, 'compliance') }}</th>
                                    </tr>
                                {% endblock %}
                                {% block table_body %}
                                    {% for mapping in mapping_group.mappings|slice(0, 5) %}
                                        <tr class="border-bottom-light">
                                            <td class="p-md">
                                                <strong class="text-primary">{{ mapping.sourceRequirement.requirementId }}</strong>
                                                <div class="small-text-secondary">
                                                    {{ mapping.sourceRequirement.title|length > 60 ? mapping.sourceRequirement.title|slice(0, 60) ~ '...' : mapping.sourceRequirement.title }}
                                                </div>
                                            </td>
                                            <td class="p-md">
                                                <strong class="text-primary">{{ mapping.targetRequirement.requirementId }}</strong>
                                                <div class="small-text-secondary">
                                                    {{ mapping.targetRequirement.title|length > 60 ? mapping.targetRequirement.title|slice(0, 60) ~ '...' : mapping.targetRequirement.title }}
                                                </div>
                                            </td>
                                            <td class="td-center-p-075">
                                                <div class="flex-center-gap-05">
                                                    <div class="progress-bar-container">
                                                        <div style="height: 100%; width: {{ mapping.mappingPercentage }}%; background: {% if mapping.mappingPercentage >= 100 %}var(--color-success){% elseif mapping.mappingPercentage >= 50 %}var(--color-warning){% else %}var(--color-secondary){% endif %};"></div>
                                                    </div>
                                                    <span class="fw-600-min-w-45">{{ mapping.mappingPercentage }}%</span>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endblock %}
                            {% endembed %}
                        </div>
                    </div>
                </details>
            {% endfor %}
        {% endif %}
    </div>

    {# Tab 4: Explanation #}
    <div id="tab-info" class="tab-content" data-tabs-target="panel" data-tab="info" style="display: none;">
        <h2 class="section-title"><i class="bi bi-lightbulb" aria-hidden="true"></i> {{ 'compliance.section.mapping_explanation'|trans({}, 'compliance') }}</h2>

        <div class="grid-gap-15">
            <div class="card card-card-border-left-info-lg">
                <h3 class="h-info-no-mt">{{ 'compliance.explanation.what_are_mappings_title'|trans({}, 'compliance') }}</h3>
                <p class="lh-16">
                    {{ 'compliance.explanation.what_are_mappings'|trans({}, 'compliance') }}
                </p>
            </div>

            <div class="card card-card-border-left-success-lg">
                <h3 class="h-success-no-mt">{{ 'compliance.explanation.mapping_types_title'|trans({}, 'compliance') }}</h3>
                <ul class="lh-18-pl">
                    <li><strong>{{ 'compliance.explanation.mapping_types_exceeds'|trans({}, 'compliance') }}</strong></li>
                    <li><strong>{{ 'compliance.explanation.mapping_types_full'|trans({}, 'compliance') }}</strong></li>
                    <li><strong>{{ 'compliance.explanation.mapping_types_partial'|trans({}, 'compliance') }}</strong></li>
                    <li><strong>{{ 'compliance.explanation.mapping_types_weak'|trans({}, 'compliance') }}</strong></li>
                </ul>
            </div>

            <div class="card card-card-border-left-warning-lg">
                <h3 class="h-warning-no-mt">{{ 'compliance.explanation.strategic_value_title'|trans({}, 'compliance') }}</h3>
                <p class="lh-16">
                    {{ 'compliance.explanation.strategic_value'|trans({}, 'compliance') }}
                </p>
            </div>
        </div>
    </div>
</div>

<style>
.tabs {
    display: flex;
    border-bottom: 2px solid var(--color-border);
    margin: -1rem -1rem 0 -1rem;
    padding: 0 1rem;
    background: var(--color-bg-alt);
    overflow-x: auto;
}

.tab-button {
    padding: 1rem 1.5rem;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
}

.tab-button:hover {
    color: var(--color-primary);
    background: var(--color-bg);
}

.tab-button.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    font-weight: 600;
}

.tab-content {
    padding: 2rem 1rem;
}

details summary {
    transition: color 0.2s;
}

details[open] summary {
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 1rem;
}

details[open] summary span:first-child {
    transform: rotate(90deg);
    display: inline-block;
}
</style>

<script>
// Create Cross-Framework Mappings
function initializeMappingButton() {
    const createBtn = document.getElementById('createMappingsBtn');

    if (!createBtn) {
        return;
    }

    // Check if already initialized to prevent duplicate listeners
    if (createBtn.dataset.initialized === 'true') {
        return;
    }

    createBtn.dataset.initialized = 'true';

    const btnIcon = document.getElementById('btnIcon');
    const btnText = document.getElementById('btnText');
    const csrfToken = '{{ csrf_token('create_mappings') }}';

    createBtn.addEventListener('click', async function(e) {
        e.preventDefault();

        // Confirm action
        if (!confirm('{{ 'compliance.confirm.create_mappings'|trans({}, 'compliance') }}')) {
            return;
        }

        // Disable button and show loading
        createBtn.disabled = true;
        btnIcon.textContent = '‚è≥';
        btnText.textContent = '{{ 'compliance.mapping_status.creating'|trans({}, 'compliance') }}';
        createBtn.style.opacity = '0.7';
        createBtn.style.cursor = 'not-allowed';

        try {
            const url = '{{ path('app_compliance_create_mappings') }}';

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-Token': csrfToken,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                btnIcon.textContent = '‚úÖ';
                btnText.textContent = data.message;
                createBtn.style.background = '#10b981';
                createBtn.style.color = 'white';

                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                btnIcon.textContent = '‚ùå';
                btnText.textContent = data.message || '{{ 'compliance.mapping_error.creating'|trans({}, 'compliance') }}';
                createBtn.style.background = '#ef4444';
                createBtn.style.color = 'white';

                setTimeout(() => {
                    btnIcon.textContent = 'üîó';
                    btnText.textContent = '{{ 'compliance.action.create_mappings_now'|trans({}, 'compliance') }}';
                    createBtn.style.background = 'white';
                    createBtn.style.color = '#667eea';
                    createBtn.style.opacity = '1';
                    createBtn.style.cursor = 'pointer';
                    createBtn.disabled = false;
                }, 5000);
            }
        } catch (error) {
            btnIcon.textContent = '‚ùå';
            btnText.textContent = '{{ 'common.error'|trans({}, 'messages') }}: ' + error.message;
            createBtn.style.background = '#ef4444';
            createBtn.style.color = 'white';

            setTimeout(() => {
                btnIcon.textContent = 'üîó';
                btnText.textContent = '{{ 'compliance.action.create_mappings_now'|trans({}, 'compliance') }}';
                createBtn.style.background = 'white';
                createBtn.style.color = '#667eea';
                createBtn.style.opacity = '1';
                createBtn.style.cursor = 'pointer';
                createBtn.disabled = false;
            }, 5000);
        }
    });
}

// Cleanup before Turbo caches the page to allow re-initialization on back navigation
document.addEventListener('turbo:before-cache', function() {
    const createBtn = document.getElementById('createMappingsBtn');
    if (createBtn) {
        delete createBtn.dataset.initialized;
    }
});

// Initialize on both DOMContentLoaded (first page load) and turbo:load (Turbo navigation)
document.addEventListener('DOMContentLoaded', initializeMappingButton);
document.addEventListener('turbo:load', initializeMappingButton);

// Handler for the "Fehlende Mappings erg√§nzen" button in the header
function initializeHeaderMappingButton() {
    const createAllMappingsBtn = document.getElementById('createAllMappingsBtn');

    if (!createAllMappingsBtn) {
        return;
    }

    // Prevent multiple initializations
    if (createAllMappingsBtn.dataset.headerInitialized === 'true') {
        return;
    }

    createAllMappingsBtn.dataset.headerInitialized = 'true';

    createAllMappingsBtn.addEventListener('click', async function() {
        const originalText = this.textContent;

        // Confirm action
        if (!confirm('{{ 'compliance.confirm.add_missing_mappings'|trans({}, 'compliance') }}')) {
            return;
        }

        // Disable button and show loading
        createAllMappingsBtn.disabled = true;
        createAllMappingsBtn.style.opacity = '0.7';

        const csrfToken = '{{ csrf_token('create_mappings') }}';
        const url = '{{ path('app_compliance_create_mappings') }}';

        let currentBatch = 0;
        let totalCreated = 0;
        let totalSkipped = 0;

        // Recursive function to process batches
        async function processBatch() {
            try {
                createAllMappingsBtn.textContent = `‚è≥ Batch ${currentBatch + 1}...`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-Token': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        batch: currentBatch,
                        batch_size: 50
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || '{{ 'common.error.unknown'|trans({}, 'messages') }}');
                }

                totalCreated += data.mappings_created || 0;
                totalSkipped += data.mappings_skipped || 0;

                // Show progress
                if (data.progress) {
                    createAllMappingsBtn.textContent = `‚è≥ ${data.progress.percent}% (${data.progress.processed}/${data.progress.total})`;
                }

                // Continue with next batch if there's more
                if (data.has_more) {
                    currentBatch = data.next_batch;
                    // Small delay to prevent overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                    return processBatch();
                } else {
                    // All done!
                    const message = `‚úÖ ${totalCreated} {{ 'compliance.mapping_status.new_created'|trans({}, 'compliance') }}`;
                    createAllMappingsBtn.textContent = message;
                    createAllMappingsBtn.style.background = '#10b981';
                    createAllMappingsBtn.style.color = 'white';

                    // Reload page after 2 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            } catch (error) {
                alert('{{ 'compliance.mapping_error.creating'|trans({}, 'compliance') }}: ' + error.message);
                createAllMappingsBtn.disabled = false;
                createAllMappingsBtn.textContent = originalText;
                createAllMappingsBtn.style.opacity = '1';
            }
        }

        // Start processing
        await processBatch();
    });
}

document.addEventListener('DOMContentLoaded', initializeHeaderMappingButton);
document.addEventListener('turbo:load', initializeHeaderMappingButton);
</script>
{% endblock %}
