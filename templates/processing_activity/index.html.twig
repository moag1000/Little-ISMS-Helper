{% extends 'base.html.twig' %}
{% trans_default_domain 'privacy' %}
{% block title %}{{ 'processing_activity.title'|trans({}, 'privacy')}}{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    {# Breadcrumb #}
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'processing_activity.breadcrumb.privacy'|trans({}, 'privacy'), icon: 'bi-shield-check' },
            { label: 'processing_activity.breadcrumb.vvt'|trans({}, 'privacy')}
        ]
    } %}

    {# Page Header #}
    {% include '_components/_page_header.html.twig' with {
        title: 'processing_activity.title'|trans({}, 'privacy'),
        subtitle: 'processing_activity.subtitle'|trans({}, 'privacy'),
        icon: 'bi-file-earmark-text',
        actions: [
            { label: 'processing_activity.button.dashboard'|trans({}, 'privacy'), url: path('app_processing_activity_dashboard'), variant: 'outline-primary', icon: 'bi-speedometer2' },
            { label: 'processing_activity.button.export_pdf'|trans({}, 'privacy'), url: path('app_processing_activity_export_pdf'), variant: 'outline-secondary', icon: 'bi-file-earmark-pdf', turbo: false },
            { label: 'processing_activity.button.export_csv'|trans({}, 'privacy'), url: path('app_processing_activity_export_csv'), variant: 'outline-secondary', icon: 'bi-filetype-csv', turbo: false },
            { label: 'processing_activity.button.new'|trans({}, 'privacy'), url: path('app_processing_activity_new'), variant: 'primary', icon: 'bi-plus-lg' }
        ]
    } %}

    {# Statistics Cards #}
    <div class="row mb-4">
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="text-center">
                        <div class="text-muted mb-2 fw-bold">{{ 'processing_activity.stat.total'|trans({}, 'privacy')}}</div>
                        <div class="fs-2 fw-bold mb-0">{{ statistics.total }}</div>
                        <small class="text-success">{{ statistics.active }} {{ 'processing_activity.stat.active'|trans({}, 'privacy')}}</small>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="text-center">
                        <div class="text-muted mb-2 fw-bold">{{ 'processing_activity.stat.compliance_score'|trans({}, 'privacy')}}</div>
                        <div class="fs-2 fw-bold mb-0
                            {% if compliance_score.overall_score >= 80 %}text-success
                            {% elseif compliance_score.overall_score >= 60 %}text-warning
                            {% else %}text-danger{% endif %}">
                            {{ compliance_score.overall_score }}%
                        </div>
                        <small class="text-muted">{{ compliance_score.complete_activities }}/{{ compliance_score.total_activities }} {{ 'processing_activity.stat.complete'|trans({}, 'privacy')}}</small>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="text-center">
                        <div class="text-muted mb-2 fw-bold">{{ 'processing_activity.stat.high_risk'|trans({}, 'privacy')}}</div>
                        <div class="fs-2 fw-bold mb-0">{{ statistics.high_risk }}</div>
                        <small class="text-danger">{{ statistics.missing_dpia }} {{ 'processing_activity.stat.missing_dpia'|trans({}, 'privacy')}}</small>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="text-center">
                        <div class="text-muted mb-2 fw-bold">{{ 'processing_activity.stat.special_categories'|trans({}, 'privacy')}}</div>
                        <div class="fs-2 fw-bold mb-0">{{ statistics.special_categories }}</div>
                        <small class="text-muted">{{ 'processing_activity.stat.art9_data'|trans({}, 'privacy')}}</small>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>
    </div>

    {# Filters #}
    {% embed '_components/_card.html.twig' with {class: 'mb-4'} %}
        {% block card_body %}
            <h2 class="h5 mb-3"><i class="bi bi-funnel" aria-hidden="true"></i> {{ 'processing_activity.filter.title'|trans({}, 'privacy')}}</h2>
            <div class="btn-group" role="group">
                <a href="{{ path('app_processing_activity_index') }}"
                   class="btn btn-outline-primary {{ current_filter == 'all' ? 'active' : '' }}">
                    {{ 'processing_activity.filter.all'|trans({}, 'privacy')}} ({{ statistics.total }})
                </a>
                <a href="{{ path('app_processing_activity_index', {filter: 'active'}) }}"
                   class="btn btn-outline-success {{ current_filter == 'active' ? 'active' : '' }}">
                    {{ 'processing_activity.filter.active'|trans({}, 'privacy')}} ({{ statistics.active }})
                </a>
                <a href="{{ path('app_processing_activity_index', {filter: 'incomplete'}) }}"
                   class="btn btn-outline-warning {{ current_filter == 'incomplete' ? 'active' : '' }}">
                    {{ 'processing_activity.filter.incomplete'|trans({}, 'privacy')}}
                </a>
                <a href="{{ path('app_processing_activity_index', {filter: 'requiring_dpia'}) }}"
                   class="btn btn-outline-danger {{ current_filter == 'requiring_dpia' ? 'active' : '' }}">
                    {{ 'processing_activity.filter.requiring_dpia'|trans({}, 'privacy')}} ({{ statistics.missing_dpia }})
                </a>
                <a href="{{ path('app_processing_activity_index', {filter: 'special_categories'}) }}"
                   class="btn btn-outline-info {{ current_filter == 'special_categories' ? 'active' : '' }}">
                    {{ 'processing_activity.filter.special_categories'|trans({}, 'privacy')}} ({{ statistics.special_categories }})
                </a>
                <a href="{{ path('app_processing_activity_index', {filter: 'third_country_transfers'}) }}"
                   class="btn btn-outline-secondary {{ current_filter == 'third_country_transfers' ? 'active' : '' }}">
                    {{ 'processing_activity.filter.third_country'|trans({}, 'privacy')}} ({{ statistics.third_country_transfers }})
                </a>
            </div>
        {% endblock %}
    {% endembed %}

    {# Processing Activities Table #}
    {% embed '_components/_card.html.twig' with {noPadding: true} %}
        {% block card_header %}
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="mb-0 h5"><i class="bi bi-table" aria-hidden="true"></i> {{ 'processing_activity.table.title'|trans({}, 'privacy')}}</h2>
                {% include '_components/_badge.html.twig' with { variant: 'secondary', content: processing_activities|length ~ ' ' ~ 'processing_activity.table.items'|trans({}, 'privacy') } %}
            </div>
        {% endblock %}
        {% block card_body %}
            {% if processing_activities|length > 0 %}
                {% embed '_components/_table.html.twig' with {
                    'noMargin': true
                } %}
                    {% block table_head %}
                        <tr>
                            <th scope="col">{{ 'processing_activity.table.name'|trans({}, 'privacy') }}</th>
                            <th scope="col">{{ 'processing_activity.table.legal_basis'|trans({}, 'privacy') }}</th>
                            <th scope="col">{{ 'processing_activity.table.data_subjects'|trans({}, 'privacy') }}</th>
                            <th scope="col">{{ 'processing_activity.table.risk'|trans({}, 'privacy') }}</th>
                            <th scope="col">{{ 'processing_activity.table.status'|trans({}, 'privacy') }}</th>
                            <th scope="col">{{ 'processing_activity.table.completeness'|trans({}, 'privacy') }}</th>
                            <th scope="col">{{ 'processing_activity.table.actions'|trans({}, 'privacy') }}</th>
                        </tr>
                    {% endblock %}
                    {% block table_body %}
                        {% for pa in processing_activities %}
                            <tr>
                                <td>
                                    <strong>{{ pa.name }}</strong><br>
                                    <small class="text-muted">
                                        {% if pa.processesSpecialCategories %}
                                            {% include '_components/_badge.html.twig' with { variant: 'danger', content: 'processing_activity.badge.special_categories'|trans({}, 'privacy') } %}
                                        {% endif %}
                                        {% if pa.hasThirdCountryTransfer %}
                                            {% include '_components/_badge.html.twig' with { variant: 'warning', content: 'processing_activity.badge.third_country'|trans({}, 'privacy') } %}
                                        {% endif %}
                                        {% if pa.requiresDPIA and not pa.dpiaCompleted %}
                                            {% include '_components/_badge.html.twig' with { variant: 'danger', content: 'processing_activity.badge.dpia_required'|trans({}, 'privacy') } %}
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    {{ ('processing_activity.legal_basis.' ~ pa.legalBasis)|trans({}, 'privacy') }}
                                </td>
                                <td>
                                    {{ pa.dataSubjectCategories|length }} {{ 'processing_activity.table.categories'|trans({}, 'privacy') }}<br>
                                    {% if pa.estimatedDataSubjectsCount %}
                                        <small class="text-muted">~{{ pa.estimatedDataSubjectsCount }} {{ 'processing_activity.table.subjects'|trans({}, 'privacy') }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if pa.riskLevel %}
                                        {% set risk_class = {
                                            'low': 'success',
                                            'medium': 'info',
                                            'high': 'warning',
                                            'critical': 'danger'
                                        }[pa.riskLevel] %}
                                        {% include '_components/_badge.html.twig' with { variant: risk_class, content: ('processing_activity.risk_level.' ~ pa.riskLevel)|trans({}, 'privacy') } %}
                                    {% else %}
                                        <span class="text-muted">â€”</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set status_class = {
                                        'draft': 'secondary',
                                        'active': 'success',
                                        'archived': 'dark'
                                    }[pa.status] %}
                                    {% include '_components/_badge.html.twig' with { variant: status_class, content: ('processing_activity.status.' ~ pa.status)|trans({}, 'privacy') } %}
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        {% set completeness = pa.completenessPercentage %}
                                        {% set progress_class = completeness == 100 ? 'bg-success' : (completeness >= 70 ? 'bg-warning' : 'bg-danger') %}
                                        <div class="progress-bar {{ progress_class }}"
                                             role="progressbar"
                                             style="width: {{ completeness }}%"
                                             aria-valuenow="{{ completeness }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100">
                                            {{ completeness }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ path('app_processing_activity_show', {id: pa.id}) }}"
                                           class="btn btn-outline-primary"
                                           title="{{ 'common.view'|trans({}, 'messages') }}">
                                            <i class="bi bi-eye" aria-hidden="true"></i>
                                        </a>
                                        <a href="{{ path('app_processing_activity_edit', {id: pa.id}) }}"
                                           class="btn btn-outline-secondary"
                                           title="{{ 'common.edit'|trans({}, 'messages') }}">
                                            <i class="bi bi-pencil" aria-hidden="true"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endblock %}
                {% endembed %}
            {% else %}
                <div class="alert alert-info m-4">
                    <i class="bi bi-info-circle" aria-hidden="true"></i>
                    <strong>{{ 'processing_activity.empty.title'|trans({}, 'privacy')}}</strong>
                    {% if current_filter != 'all' %}
                        {{ 'processing_activity.empty.filter_hint'|trans({}, 'privacy')}} <a href="{{ path('app_processing_activity_index') }}">{{ 'processing_activity.view_all_activities'|trans({}, 'privacy')}}</a>.
                    {% else %}
                        {{ 'processing_activity.empty.create_hint'|trans({}, 'privacy')}} <a href="{{ path('app_processing_activity_new') }}">{{ 'processing_activity.empty.create_first'|trans({}, 'privacy')}}</a>.
                    {% endif %}
                </div>
            {% endif %}
        {% endblock %}
    {% endembed %}
</div>
{% endblock %}
