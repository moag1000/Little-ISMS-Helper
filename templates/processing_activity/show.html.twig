{% extends 'base.html.twig' %}
{% trans_default_domain 'privacy'%}
{% block title %}{{ processing_activity.name }} - Processing Activity{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    {# Breadcrumb #}
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'GDPR', url: path('app_processing_activity_index'), icon: 'bi-shield-check' },
            { label: 'VVT', url: path('app_processing_activity_index') },
            { label: processing_activity.name }
        ]
    } %}

    {# Page Header #}
    {% include '_components/_page_header.html.twig' with {
        title: processing_activity.name,
        subtitle: 'Processing Activity Details (Art. 30 GDPR)',
        icon: 'bi-file-earmark-text',
        actions: [
            { label: 'Edit', url: path('app_processing_activity_edit', {id: processing_activity.id}), variant: 'primary', icon: 'bi-pencil' },
            { label: 'Clone', url: '#', variant: 'outline-secondary', icon: 'bi-files', attributes: 'data-action="clone"' },
            { label: 'Back to List', url: path('app_processing_activity_index'), variant: 'outline-secondary', icon: 'bi-arrow-left' }
        ]
    } %}

    {# Compliance Status Banner #}
    {% if not compliance_report.is_compliant %}
        <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle" aria-hidden="true"></i> Compliance Issues</h5>
            <p>This processing activity has {{ compliance_report.validation_errors|length }} validation error(s):</p>
            <ul>
                {% for error in compliance_report.validation_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {# Quick Stats #}
    <div class="row mb-4">
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="text-center">
                        <div class="text-muted mb-2 fw-bold">Completeness</div>
                        {% set completeness = compliance_report.completeness_percentage %}
                        <div class="fs-2 fw-bold mb-0 {{ completeness == 100 ? 'text-success' : 'text-warning' }}">{{ completeness }}%</div>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="text-center">
                        <div class="text-muted mb-2 fw-bold">Status</div>
                        <div class="fs-4 fw-bold mb-0"><span class="{{ badge_status(processing_activity.status) }}">{{ processing_activity.status|upper }}</span></div>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="text-center">
                        <div class="text-muted mb-2 fw-bold">Risk Level</div>
                        {% if processing_activity.riskLevel %}
                            <div class="fs-4 fw-bold mb-0"><span class="{{ badge_risk(processing_activity.riskLevel) }}">{{ processing_activity.riskLevel|upper }}</span></div>
                        {% else %}
                            <div class="fs-4 fw-bold mb-0 text-muted">—</div>
                        {% endif %}
                    </div>
                {% endblock %}
            {% endembed %}
        </div>
        <div class="col-md-3">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="text-center">
                        <div class="text-muted mb-2 fw-bold">DPIA Status</div>
                        {% if processing_activity.requiresDPIA %}
                            {% if processing_activity.dpiaCompleted %}
                                <div class="fs-4 fw-bold mb-0 text-success"><i class="bi bi-check-circle-fill" aria-hidden="true"></i></div>
                                <small class="text-muted">{{ processing_activity.dpiaDate|date('Y-m-d') }}</small>
                            {% else %}
                                <div class="fs-4 fw-bold mb-0 text-danger"><i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i></div>
                                <small class="text-danger">Required</small>
                            {% endif %}
                        {% else %}
                            <div class="fs-4 fw-bold mb-0 text-muted">Not Required</div>
                        {% endif %}
                    </div>
                {% endblock %}
            {% endembed %}
        </div>
    </div>

    {# Main Content Tabs #}
    <ul class="nav nav-tabs" id="processingActivityTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                <i class="bi bi-info-circle" aria-hidden="true"></i> Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">
                <i class="bi bi-database" aria-hidden="true"></i> Data Details
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="compliance-tab" data-bs-toggle="tab" data-bs-target="#compliance" type="button" role="tab">
                <i class="bi bi-shield-check" aria-hidden="true"></i> Compliance
            </button>
        </li>
    </ul>

    <div class="tab-content" id="processingActivityTabsContent">
        {# Overview Tab #}
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <h2 class="h5">Basic Information</h2>
                    <dl class="row">
                        <dt class="col-sm-3">Name:</dt>
                        <dd class="col-sm-9">{{ processing_activity.name }}</dd>

                        <dt class="col-sm-3">Description:</dt>
                        <dd class="col-sm-9">{{ processing_activity.description ?? '—' }}</dd>

                        <dt class="col-sm-3">Purposes (Art. 30(1)(a)):</dt>
                        <dd class="col-sm-9">
                            {% for purpose in processing_activity.purposes %}
                                {% include '_components/_badge.html.twig' with { variant: 'primary', content: purpose } %}
                            {% endfor %}
                        </dd>

                        <dt class="col-sm-3">Legal Basis (Art. 6):</dt>
                        <dd class="col-sm-9">
                            <strong>{{ processing_activity.legalBasis }}</strong>
                            {% if processing_activity.legalBasisDetails %}
                                <br><small class="text-muted">{{ processing_activity.legalBasisDetails }}</small>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Responsible Department:</dt>
                        <dd class="col-sm-9">{{ processing_activity.responsibleDepartment ?? '—' }}</dd>

                        <dt class="col-sm-3">Contact Person:</dt>
                        <dd class="col-sm-9">{{ processing_activity.contactPerson ? processing_activity.contactPerson.userIdentifier : '—' }}</dd>

                        <dt class="col-sm-3">DPO:</dt>
                        <dd class="col-sm-9">{{ processing_activity.dataProtectionOfficer ? processing_activity.dataProtectionOfficer.userIdentifier : '—' }}</dd>
                    </dl>
                {% endblock %}
            {% endembed %}
        </div>

        {# Data Details Tab #}
        <div class="tab-pane fade" id="data" role="tabpanel">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <h2 class="h5">Data Subjects (Art. 30(1)(b))</h2>
                    <dl class="row">
                        <dt class="col-sm-3">Categories:</dt>
                        <dd class="col-sm-9">
                            {% for category in processing_activity.dataSubjectCategories %}
                                {% include '_components/_badge.html.twig' with { variant: 'info', content: category } %}
                            {% endfor %}
                        </dd>
                        <dt class="col-sm-3">Estimated Count:</dt>
                        <dd class="col-sm-9">{{ processing_activity.estimatedDataSubjectsCount ?? '—' }}</dd>
                    </dl>

                    <hr>

                    <h2 class="h5">Personal Data (Art. 30(1)(c))</h2>
                    <dl class="row">
                        <dt class="col-sm-3">Categories:</dt>
                        <dd class="col-sm-9">
                            {% for category in processing_activity.personalDataCategories %}
                                {% include '_components/_badge.html.twig' with { variant: 'secondary', content: category } %}
                            {% endfor %}
                        </dd>

                        {% if processing_activity.processesSpecialCategories %}
                            <dt class="col-sm-3">Special Categories (Art. 9):</dt>
                            <dd class="col-sm-9">
                                {% include '_components/_badge.html.twig' with { variant: 'danger', content: 'YES' } %}
                                {% for detail in processing_activity.specialCategoriesDetails ?? [] %}
                                    {% include '_components/_badge.html.twig' with { variant: 'danger', content: detail } %}
                                {% endfor %}
                                {% if processing_activity.legalBasisSpecialCategories %}
                                    <br><small>Legal basis: {{ processing_activity.legalBasisSpecialCategories }}</small>
                                {% endif %}
                            </dd>
                        {% endif %}

                        {% if processing_activity.processesCriminalData %}
                            <dt class="col-sm-3">Criminal Data (Art. 10):</dt>
                            <dd class="col-sm-9">{% include '_components/_badge.html.twig' with { variant: 'warning', content: 'YES' } %}</dd>
                        {% endif %}
                    </dl>

                    <hr>

                    <h2 class="h5">Retention (Art. 30(1)(f))</h2>
                    <dl class="row">
                        <dt class="col-sm-3">Retention Period:</dt>
                        <dd class="col-sm-9">{{ processing_activity.retentionPeriod ?? '—' }}</dd>
                        {% if processing_activity.retentionPeriodDays %}
                            <dt class="col-sm-3">Days:</dt>
                            <dd class="col-sm-9">{{ processing_activity.retentionPeriodDays }}</dd>
                        {% endif %}
                        {% if processing_activity.retentionLegalBasis %}
                            <dt class="col-sm-3">Legal Basis:</dt>
                            <dd class="col-sm-9">{{ processing_activity.retentionLegalBasis }}</dd>
                        {% endif %}
                    </dl>
                {% endblock %}
            {% endembed %}
        </div>

        {# Compliance Tab #}
        <div class="tab-pane fade" id="compliance" role="tabpanel">
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <h2 class="h5">Compliance Checks (Art. 30)</h2>
                    {% embed '_components/_table.html.twig' with {
                        'noMargin': true
                    } %}
                        {% block table_head %}
                            <tr>
                                <th>Check</th>
                                <th>Status</th>
                            </tr>
                        {% endblock %}
                        {% block table_body %}
                            {% for check, passed in compliance_report.compliance_checks %}
                                <tr>
                                    <td>{{ check|replace({'_': ' '})|title }}</td>
                                    <td>
                                        {% if passed %}
                                            {% include '_components/_badge.html.twig' with { variant: 'success', icon: 'bi-check-circle-fill', content: 'Pass' } %}
                                        {% else %}
                                            {% include '_components/_badge.html.twig' with { variant: 'danger', icon: 'bi-x-circle-fill', content: 'Fail' } %}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endblock %}
                    {% endembed %}</div>

                    <h2 class="h5 mt-4">Technical & Organizational Measures (Art. 30(1)(g))</h2>
                    <p>{{ processing_activity.technicalOrganizationalMeasures ?? 'Not documented' }}</p>

                    {% if processing_activity.implementedControls|length > 0 %}
                        <h3 class="h6">Linked ISO 27001 Controls:</h3>
                        <ul>
                            {% for control in processing_activity.implementedControls %}
                                <li>{{ control.controlId }} - {{ control.name }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>
    </div>

    {# Action Forms (hidden) #}
    <form id="cloneForm" method="post" action="{{ path('app_processing_activity_clone', {id: processing_activity.id}) }}" style="display:none;">
        <input type="hidden" name="_token" value="{{ csrf_token('clone' ~ processing_activity.id) }}">
    </form>

<script>
document.querySelector('[data-action="clone"]')?.addEventListener('click', (e) => {
    e.preventDefault();
    if (confirm('{{ 'processing_activity.confirm.clone'|trans({}, 'privacy') }}')) {
        document.getElementById('cloneForm').submit();
    }
});
</script>
{% endblock %}
