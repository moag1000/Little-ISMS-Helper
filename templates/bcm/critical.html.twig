{% extends 'base.html.twig' %}
{% trans_default_domain 'bcm' %}
{% import '_macros/cards.html.twig' as cards %}

{% block title %}{{ 'bcm.title.critical'|trans({}, 'bcm') }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>{{ 'bcm.title.critical'|trans({}, 'bcm') }}</h1>
        <p class="text-muted">{{ 'bcm.description.critical'|trans({}, 'bcm') }}</p>
    </div>
    <div class="button-group">
        <a href="{{ path('app_bcm_index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'common.back'|trans({}, 'messages') }}
        </a>
    </div>
</div>

{# Statistics Cards #}
<div class="kpi-grid">
    <div class="col-auto">
        {{ cards.kpi_card('bcm.stats.critical_processes'|trans({}, 'bcm'), processes|length, null, null, 'danger', 'border-danger') }}
    </div>
    <div class="col-auto">
        {% set avgRTO = 0 %}
        {% if processes|length > 0 %}
            {% set totalRTO = 0 %}
            {% for process in processes %}
                {% set totalRTO = totalRTO + process.rto|default(0) %}
            {% endfor %}
            {% set avgRTO = (totalRTO / processes|length)|round(1) %}
        {% endif %}
        {{ cards.kpi_card('bcm.stats.avg_rto'|trans({}, 'bcm'), avgRTO ~ 'h', null, null, 'info', null) }}
    </div>
    <div class="col-auto">
        {% set highPriorityCount = 0 %}
        {% for process in processes %}
            {% if process.rto|default(24) <= 4 %}
                {% set highPriorityCount = highPriorityCount + 1 %}
            {% endif %}
        {% endfor %}
        {{ cards.kpi_card('bcm.stats.high_priority'|trans({}, 'bcm'), highPriorityCount, null, null, 'warning', null) }}
    </div>
</div>

{# Critical Processes Table #}
<div class="card">
    <div class="card-header">
        <h2 class="mb-0">{{ 'bcm.section.critical_processes'|trans({}, 'bcm') }}</h2>
    </div>
    <div class="card-body">
        {% if processes|length > 0 %}
        <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>{{ 'bcm.field.process_name'|trans({}, 'bcm') }}</th>
                    <th>{{ 'bcm.field.criticality'|trans({}, 'bcm') }}</th>
                    <th>{{ 'bcm.field.rto'|trans({}, 'bcm') }}</th>
                    <th>{{ 'bcm.field.rpo'|trans({}, 'bcm') }}</th>
                    <th>{{ 'bcm.field.mtpd'|trans({}, 'bcm') }}</th>
                    <th class="text-center">{{ 'bcm.field.supporting_assets'|trans({}, 'bcm') }}</th>
                    <th class="text-center">{{ 'common.actions'|trans({}, 'messages') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for process in processes %}
                <tr>
                    <td>
                        <strong>{{ process.name }}</strong>
                        {% if process.description %}
                        <br><small class="text-muted">{{ process.description|slice(0, 80) }}{% if process.description|length > 80 %}...{% endif %}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% set critColors = {'critical': 'danger', 'high': 'warning', 'medium': 'info', 'low': 'secondary'} %}
                        <span class="badge bg-{{ critColors[process.criticality]|default('secondary') }}">
                            {{ ('bcm.criticality.' ~ process.criticality)|trans({}, 'bcm') }}
                        </span>
                    </td>
                    <td>
                        <strong>{{ process.rto|default('-') }}h</strong>
                        {% if process.rto|default(24) <= 1 %}
                            <span class="badge bg-danger ms-1">{{ 'bcm.badge.immediate'|trans({}, 'bcm') }}</span>
                        {% elseif process.rto|default(24) <= 4 %}
                            <span class="badge bg-warning ms-1">{{ 'bcm.badge.urgent'|trans({}, 'bcm') }}</span>
                        {% endif %}
                    </td>
                    <td>{{ process.rpo|default('-') }}h</td>
                    <td>{{ process.mtpd|default('-') }}h</td>
                    <td class="text-center">
                        <span class="badge bg-info">{{ process.supportingAssets|length }}</span>
                    </td>
                    <td class="text-center">
                        <a href="{{ path('app_business_process_show', {id: process.id}) }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye" aria-hidden="true"></i> {{ 'common.view'|trans({}, 'messages') }}
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
            <i class="bi bi-check-circle text-success fs-1 d-block mb-3"></i>
            <p class="fs-5"><strong>{{ 'bcm.message.no_critical_processes'|trans({}, 'bcm') }}</strong></p>
            <p>{{ 'bcm.message.no_critical_processes_desc'|trans({}, 'bcm') }}</p>
        </div>
        {% endif %}
    </div>
</div>

{# RTO Priority Legend #}
<div class="card mt-4">
    <div class="card-header">
        <h3 class="mb-0">{{ 'bcm.section.rto_legend'|trans({}, 'bcm') }}</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <span class="badge bg-danger me-2">{{ 'bcm.badge.immediate'|trans({}, 'bcm') }}</span>
                    <span>RTO ≤ 1h</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <span class="badge bg-warning me-2">{{ 'bcm.badge.urgent'|trans({}, 'bcm') }}</span>
                    <span>RTO ≤ 4h</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <span class="badge bg-info me-2">{{ 'bcm.rto.standard'|trans({}, 'bcm') }}</span>
                    <span>RTO ≤ 24h</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-2">{{ 'bcm.rto.flexible'|trans({}, 'bcm') }}</span>
                    <span>RTO > 24h</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
