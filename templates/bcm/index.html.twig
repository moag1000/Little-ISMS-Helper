{% extends 'base.html.twig' %}
{% trans_default_domain 'bcm' %}

{% block title %}Business Continuity Management{% endblock %}

{% block body %}
{% import '_macros/cards.html.twig' as cards %}

<div class="container">
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'nav.bcm'|trans({}, 'nav') }
        ]
    } %}

    <div class="page-header">
        <div>
            <h1>Business Continuity Management</h1>
            <p class="text-muted">Business Impact Analysis & Process Management</p>
        </div>
        <div class="button-group">
            <a href="{{ path('app_bcm_data_reuse') }}" class="btn btn-secondary">
                <i class="bi bi-link-45deg" aria-hidden="true"></i> {{ 'bcm.action.data_reuse'|trans({}, 'bcm') }}
            </a>
            <a href="{{ path('app_business_process_new') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg" aria-hidden="true"></i> {{ 'bcm.action.add_process'|trans({}, 'bcm') }}
            </a>
        </div>
    </div>

    {# KPI Overview Cards #}
    <div class="kpi-grid">
        <div class="col-auto">
            {{ cards.kpi_card('Total Processes', stats.total, null, null, 'primary', null) }}
        </div>
        <div class="col-auto">
            {{ cards.kpi_card('Critical Processes', stats.critical, null, null, 'danger', null) }}
        </div>
        <div class="col-auto">
            {{ cards.kpi_card('High Priority', stats.high, null, null, 'warning', null) }}
        </div>
        <div class="col-auto">
            {{ cards.kpi_card('Avg RTO', stats.avg_rto|number_format(1) ~ 'h', null, null, 'success', null) }}
        </div>
        <div class="col-auto">
            {{ cards.kpi_card('Avg MTPD', stats.avg_mtpd|number_format(1) ~ 'h', null, null, 'info', null) }}
        </div>
    </div>

    {# Business Processes Table #}
    <div class="card"
         data-controller="filter"
         data-filter-filterable-columns-value="{{ ['name', 'description', 'criticality']|json_encode }}">

        <div class="card-header">
            <h3>Business Processes</h3>
            <div class="filter-panel">
                <input type="text"
                       class="search-input"
                       placeholder="{{ 'common.search_processes'|trans({}, 'messages') }}"
                       data-filter-target="searchInput"
                       data-action="input->filter#filterRows">

                <select class="filter-select" data-action="change->filter#filterByCategory">
                    <option value="">All Criticality Levels</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
        </div>

        {% embed '_components/_table.html.twig' with {
            'noMargin': true,
            'responsive': true
        } %}
            {% block table_head %}
                <tr>
                    <th scope="col">Process Name</th>
                    <th scope="col">Owner</th>
                    <th scope="col">Criticality</th>
                    <th scope="col">RTO</th>
                    <th scope="col">RPO</th>
                    <th scope="col">MTPD</th>
                    <th scope="col">Impact</th>
                    <th scope="col">Assets</th>
                    <th scope="col" class="actions-column">Actions</th>
                </tr>
            {% endblock %}
            {% block table_body %}
                {% for process in processes %}
                    <tr data-filter-target="filterableRow"
                        data-category="{{ process.criticality }}">
                        <td>
                            <strong>{{ process.name }}</strong>
                            {% if process.description %}
                                <br><small class="text-muted">{{ process.description|length > 60 ? process.description|slice(0, 60) ~ '...' : process.description }}</small>
                            {% endif %}
                        </td>
                        <td>{{ process.processOwner ?? '-' }}</td>
                        <td>
                            {% set criticality_colors = {
                                'critical': 'danger',
                                'high': 'warning',
                                'medium': 'info',
                                'low': 'success'
                            } %}
                            <span class="badge bg-{{ criticality_colors[process.criticality] ?? 'secondary' }}">
                                {{ process.criticality|upper }}
                            </span>
                        </td>
                        <td>
                            <span class="metric-value">{{ process.rto }}h</span>
                        </td>
                        <td>
                            <span class="metric-value">{{ process.rpo }}h</span>
                        </td>
                        <td>
                            <span class="metric-value">{{ process.mtpd }}h</span>
                        </td>
                        <td>
                            <div class="impact-scores">
                                <span class="tooltip-trigger" title="{{ 'bcm.field.reputational_impact'|trans({}, 'bcm') }}">{{ process.reputationalImpact|default(0) }}/5</span>
                                <span class="tooltip-trigger" title="{{ 'bcm.field.regulatory_impact'|trans({}, 'bcm') }}">{{ process.regulatoryImpact|default(0) }}/5</span>
                                <span class="tooltip-trigger" title="{{ 'bcm.field.operational_impact'|trans({}, 'bcm') }}">{{ process.operationalImpact|default(0) }}/5</span>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-info">
                                {{ process.supportingAssets|length }} Assets
                            </span>
                        </td>
                        <td class="actions-column">
                            <a href="{{ path('app_business_process_show', {id: process.id}) }}" class="btn btn-sm btn-outline-primary" title="{{ 'common.view'|trans({}, 'messages') }}">
                                <i class="bi bi-eye" aria-hidden="true"></i>
                            </a>
                            <a href="{{ path('app_business_process_edit', {id: process.id}) }}" class="btn btn-sm btn-outline-secondary" title="{{ 'common.edit'|trans({}, 'messages') }}">
                                <i class="bi bi-pencil" aria-hidden="true"></i>
                            </a>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            No business processes defined yet. Start by adding your first critical process.
                        </td>
                    </tr>
                {% endfor %}
            {% endblock %}
        {% endembed %}

        <div data-filter-target="noResults" class="no-results d-none">
            <p>{{ 'bcm.message.no_matching_processes'|trans({}, 'bcm') }}</p>
        </div>
    </div>

    {# Help Section #}
    <div class="card mt-lg">
        <div class="card-header">
            <h3>Understanding BCM & BIA</h3>
        </div>
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item">
                    <strong>RTO (Recovery Time Objective)</strong>
                    <p>{{ 'bcm.message.rto_tooltip'|trans({}, 'bcm') }}</p>
                </div>
                <div class="info-item">
                    <strong>RPO (Recovery Point Objective)</strong>
                    <p>{{ 'bcm.message.rpo_tooltip'|trans({}, 'bcm') }}</p>
                </div>
                <div class="info-item">
                    <strong>MTPD (Maximum Tolerable Period of Disruption)</strong>
                    <p>{{ 'bcm.message.mtd_tooltip'|trans({}, 'bcm') }}</p>
                </div>
                <div class="info-item">
                    <strong>{{ 'common.data_reuse'|trans({}, 'messages') }}</strong>
                    <p>{{ 'bcm.message.bcm_influences_asset_ratings'|trans({}, 'bcm') }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.impact-scores {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 0.85rem;
}

.metric-value {
    font-weight: 600;
    color: var(--color-primary);
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-md);
}

.info-item {
    padding: var(--spacing-md);
    background: var(--color-background);
    border-radius: var(--border-radius);
    border-left: 3px solid var(--color-primary);
}

.info-item strong {
    display: block;
    margin-bottom: var(--spacing-xs);
    color: var(--color-primary);
}

.info-item p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--color-text-secondary);
}
</style>
{% endblock %}
