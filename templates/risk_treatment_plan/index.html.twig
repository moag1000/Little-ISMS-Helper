{% extends 'base.html.twig' %}

{% block title %}{{ 'risk_treatment_plan.title'|trans }} - {{ 'app.title'|trans }}{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1><i class="bi bi-clipboard-check" aria-hidden="true"></i> {{ 'risk_treatment_plan.title'|trans }}</h1>
        <p class="text-muted">{{ 'risk_treatment_plan.description'|trans }}</p>
    </div>
    <div class="button-group">
        <a href="{{ path('app_risk_treatment_plan_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle" aria-hidden="true"></i> {{ 'risk_treatment_plan.new'|trans }}
        </a>
    </div>
</div>

<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-collection" aria-hidden="true"></i></div>
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">{{ 'risk_treatment_plan.stats.total'|trans }}</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-clock-history" aria-hidden="true"></i></div>
        <div class="stat-value">{{ stats.planned }}</div>
        <div class="stat-label">{{ 'risk_treatment_plan.stats.planned'|trans }}</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-play-circle" aria-hidden="true"></i></div>
        <div class="stat-value">{{ stats.in_progress }}</div>
        <div class="stat-label">{{ 'risk_treatment_plan.stats.in_progress'|trans }}</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-check-circle" aria-hidden="true"></i></div>
        <div class="stat-value">{{ stats.completed }}</div>
        <div class="stat-label">{{ 'risk_treatment_plan.stats.completed'|trans }}</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-exclamation-triangle" aria-hidden="true"></i></div>
        <div class="stat-value">{{ overduePlans|length }}</div>
        <div class="stat-label">{{ 'risk_treatment_plan.stats.overdue'|trans }}</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-percent" aria-hidden="true"></i></div>
        <div class="stat-value">{{ stats.avg_completion|number_format(0) }}%</div>
        <div class="stat-label">{{ 'risk_treatment_plan.stats.avg_completion'|trans }}</div>
    </div>
</div>

{# Skip link for filters section - WCAG 2.4.1 #}
<a href="#filter-section" class="skip-link">{{ 'accessibility.skip_to_filters'|trans }}</a>

{# Filter Section #}
<div class="card mb-4">
    <div class="card-header">
        <h3><i class="bi bi-funnel" aria-hidden="true"></i> {{ 'common.filters'|trans }}</h3>
    </div>
    <div class="card-body" id="filter-section" tabindex="-1">
        <form method="get" action="{{ path('app_risk_treatment_plan_index') }}" class="row g-3" role="search" aria-label="{{ 'common.filters'|trans }}">
            <div class="col-md-3">
                <label for="filter-status" class="form-label">{{ 'risk_treatment_plan.field.status'|trans }}</label>
                <select class="form-select" id="filter-status" name="status" onchange="this.form.submit()">
                    <option value="">{{ 'common.all'|trans }}</option>
                    <option value="planned" {{ app.request.get('status') == 'planned' ? 'selected' : '' }}>{{ 'risk_treatment_plan.status.planned'|trans }}</option>
                    <option value="in_progress" {{ app.request.get('status') == 'in_progress' ? 'selected' : '' }}>{{ 'risk_treatment_plan.status.in_progress'|trans }}</option>
                    <option value="completed" {{ app.request.get('status') == 'completed' ? 'selected' : '' }}>{{ 'risk_treatment_plan.status.completed'|trans }}</option>
                    <option value="on_hold" {{ app.request.get('status') == 'on_hold' ? 'selected' : '' }}>{{ 'risk_treatment_plan.status.on_hold'|trans }}</option>
                    <option value="cancelled" {{ app.request.get('status') == 'cancelled' ? 'selected' : '' }}>{{ 'risk_treatment_plan.status.cancelled'|trans }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter-priority" class="form-label">{{ 'risk_treatment_plan.field.priority'|trans }}</label>
                <select class="form-select" id="filter-priority" name="priority" onchange="this.form.submit()">
                    <option value="">{{ 'common.all'|trans }}</option>
                    <option value="critical" {{ app.request.get('priority') == 'critical' ? 'selected' : '' }}>{{ 'risk_treatment_plan.priority.critical'|trans }}</option>
                    <option value="high" {{ app.request.get('priority') == 'high' ? 'selected' : '' }}>{{ 'risk_treatment_plan.priority.high'|trans }}</option>
                    <option value="medium" {{ app.request.get('priority') == 'medium' ? 'selected' : '' }}>{{ 'risk_treatment_plan.priority.medium'|trans }}</option>
                    <option value="low" {{ app.request.get('priority') == 'low' ? 'selected' : '' }}>{{ 'risk_treatment_plan.priority.low'|trans }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter-responsible" class="form-label">{{ 'risk_treatment_plan.field.responsible_person'|trans }}</label>
                <input type="text" class="form-control" id="filter-responsible" name="responsible_person"
                       value="{{ app.request.get('responsible_person') }}"
                       placeholder="{{ 'common.search'|trans }}...">
            </div>
            <div class="col-md-3">
                <label for="filter-overdue" class="form-label">{{ 'risk_treatment_plan.filter.overdue'|trans }}</label>
                <select class="form-select" id="filter-overdue" name="overdue_only" onchange="this.form.submit()">
                    <option value="">{{ 'common.all'|trans }}</option>
                    <option value="1" {{ app.request.get('overdue_only') == '1' ? 'selected' : '' }}>{{ 'risk_treatment_plan.filter.overdue_only'|trans }}</option>
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search" aria-hidden="true"></i> {{ 'common.filter'|trans }}
                </button>
                <a href="{{ path('app_risk_treatment_plan_index') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle" aria-hidden="true"></i> {{ 'common.reset'|trans }}
                </a>
            </div>
        </form>
    </div>
</div>

{# Treatment Plans Table #}
<div class="card">
    <div class="card-header">
        <h3><i class="bi bi-list" aria-hidden="true"></i> {{ 'risk_treatment_plan.list.title'|trans }} ({{ plans|length }})</h3>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th scope="col">{{ 'risk_treatment_plan.field.title'|trans }}</th>
                    <th scope="col">{{ 'risk_treatment_plan.field.risk'|trans }}</th>
                    <th scope="col" class="text-center">{{ 'risk_treatment_plan.field.status'|trans }}</th>
                    <th scope="col" class="text-center">{{ 'risk_treatment_plan.field.priority'|trans }}</th>
                    <th scope="col">{{ 'risk_treatment_plan.field.responsible_person'|trans }}</th>
                    <th scope="col" class="text-center">{{ 'risk_treatment_plan.field.completion'|trans }}</th>
                    <th scope="col">{{ 'risk_treatment_plan.field.target_date'|trans }}</th>
                    <th scope="col" class="text-center">{{ 'common.actions'|trans }}</th>
                </tr>
            </thead>
            <tbody>
                {% for plan in plans %}
                <tr class="{{ plan.isOverdue() ? 'table-warning' : '' }}">
                    <td>
                        <strong>{{ plan.title }}</strong>
                        {% if plan.isOverdue() %}
                            <span class="badge bg-danger ms-2">
                                <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> {{ 'risk_treatment_plan.overdue'|trans }}
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if plan.risk %}
                            <a href="{{ path('app_risk_show', {id: plan.risk.id}) }}">{{ plan.risk.title }}</a>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <span class="badge bg-{{ plan.status == 'completed' ? 'success' : (plan.status == 'in_progress' ? 'primary' : (plan.status == 'cancelled' ? 'secondary' : (plan.status == 'on_hold' ? 'warning' : 'info'))) }}">
                            {{ ('risk_treatment_plan.status.' ~ plan.status)|trans|upper }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-{{ plan.priority == 'critical' ? 'danger' : (plan.priority == 'high' ? 'warning' : (plan.priority == 'medium' ? 'info' : 'secondary')) }}">
                            {{ ('risk_treatment_plan.priority.' ~ plan.priority)|trans|upper }}
                        </span>
                    </td>
                    <td>
                        {% if plan.responsiblePerson %}
                            {{ plan.responsiblePerson.fullName }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-{{ plan.completionPercentage >= 75 ? 'success' : (plan.completionPercentage >= 50 ? 'info' : (plan.completionPercentage >= 25 ? 'warning' : 'danger')) }}"
                                 role="progressbar"
                                 style="width: {{ plan.completionPercentage }}%"
                                 aria-valuenow="{{ plan.completionPercentage }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                {{ plan.completionPercentage }}%
                            </div>
                        </div>
                    </td>
                    <td>
                        {{ plan.targetCompletionDate|date('Y-m-d') }}
                        <br>
                        <small class="text-muted">
                            {% set daysUntil = plan.daysUntilTarget %}
                            {% if daysUntil < 0 %}
                                <span class="text-danger">{{ daysUntil|abs }} {{ 'risk_treatment_plan.days_overdue'|trans }}</span>
                            {% elseif daysUntil == 0 %}
                                <span class="text-warning">{{ 'risk_treatment_plan.due_today'|trans }}</span>
                            {% else %}
                                {{ daysUntil }} {{ 'risk_treatment_plan.days_remaining'|trans }}
                            {% endif %}
                        </small>
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <a href="{{ path('app_risk_treatment_plan_show', {id: plan.id}) }}"
                               class="btn btn-outline-primary"
                               title="{{ 'common.view'|trans }}" aria-label="{{ 'common.view'|trans }}">
                                <i class="bi bi-eye" aria-hidden="true"></i>
                            </a>
                            <a href="{{ path('app_risk_treatment_plan_edit', {id: plan.id}) }}"
                               class="btn btn-outline-secondary"
                               title="{{ 'common.edit'|trans }}" aria-label="{{ 'common.edit'|trans }}">
                                <i class="bi bi-pencil" aria-hidden="true"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        {{ 'risk_treatment_plan.no_plans'|trans }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-xl);
}

.button-group {
    display: flex;
    gap: var(--spacing-sm);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: var(--spacing-lg);
}

.stat-card {
    background: var(--color-white);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    text-align: center;
    transition: all var(--transition-normal);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    font-size: 2.5rem;
    color: var(--color-secondary);
    margin-bottom: var(--spacing-sm);
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--color-primary);
}

.stat-label {
    color: var(--color-text-light);
    margin-top: var(--spacing-xs);
}

.mb-4 {
    margin-bottom: var(--spacing-xl);
}

.table-warning {
    background-color: rgba(255, 193, 7, 0.1);
}
</style>
{% endblock %}
