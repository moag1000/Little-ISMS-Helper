{% extends 'base.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block body %}
<div class="container-fluid"
     data-controller="dashboard-customizer"
     data-dashboard-customizer-api-url-value="{{ path('app_dashboard_layout_get') }}">
    {# Breadcrumb Navigation #}
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'Dashboard' }
        ]
    } %}

    {# Page Header with Customize Button #}
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            {% include '_components/_page_header.html.twig' with {
                title: 'dashboard.title'|trans({}, 'dashboard'),
                subtitle: 'dashboard.subtitle'|trans({}, 'dashboard'),
                icon: 'bi-speedometer2'
            } %}
        </div>
        <button class="btn btn-outline-secondary"
                data-action="click->dashboard-customizer#openSettings"
                title="{{ 'dashboard.action.customize'|trans({}, 'dashboard') }}">
            <i class="bi bi-sliders" aria-hidden="true"></i> {{ 'dashboard.action.customize'|trans({}, 'dashboard') }}
        </button>
    </div>

    {% import '_macros/cards.html.twig' as cards %}

    {# Prominent Workflow Approval Alert Banner #}
    {% set total_pending = pending_workflows|default([])|length %}
    {% set total_overdue = overdue_workflows|default([])|length %}
    {% if total_pending > 0 or total_overdue > 0 %}
        <div class="alert {% if total_overdue > 0 %}alert-danger{% else %}alert-warning{% endif %} alert-dismissible fade show mb-4" role="alert">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                    <i class="bi {% if total_overdue > 0 %}bi-exclamation-triangle-fill{% else %}bi-clock-fill{% endif %}" style="font-size: 2rem;" aria-hidden="true"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-1">
                        {% if total_overdue > 0 %}
                            {{ 'workflow.dashboard.alert.overdue_title'|trans({'%count%': total_overdue}, 'workflows') }}
                        {% else %}
                            {{ 'workflow.dashboard.alert.pending_title'|trans({'%count%': total_pending}, 'workflows') }}
                        {% endif %}
                    </h5>
                    <p class="mb-2">
                        {% if total_overdue > 0 %}
                            {{ 'workflow.dashboard.alert.overdue_message'|trans({'%overdue%': total_overdue, '%total%': total_pending}, 'workflows') }}
                        {% else %}
                            {{ 'workflow.dashboard.alert.pending_message'|trans({'%count%': total_pending}, 'workflows') }}
                        {% endif %}
                    </p>
                    <a href="{{ path('app_workflow_pending') }}" class="btn btn-sm {% if total_overdue > 0 %}btn-danger{% else %}btn-warning{% endif %}">
                        <i class="bi bi-list-check" aria-hidden="true"></i>
                        {{ 'workflow.dashboard.alert.view_all'|trans({}, 'workflows') }}
                    </a>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ 'common.close'|trans({}, 'messages') }}"></button>
        </div>
    {% endif %}

    {# Stats Cards Row #}
    <div class="row mb-4"
         data-widget-id="stats-cards"
         data-dashboard-customizer-target="widget">
        {# Assets Card #}
        <div class="col-lg-3 col-md-6">
            {{ cards.stat_card(
                'bi bi-server',
                'bg-primary',
                'dashboard.stats.registered_assets'|trans({}, 'dashboard'),
                stats.assets_total|default(0),
                'bi bi-arrow-up',
                stats.assets_critical|default(0) ~ ' ' ~ 'dashboard.stats.critical'|trans({}, 'dashboard'),
                'positive'
            ) }}
        </div>

        {# Risks Card #}
        <div class="col-lg-3 col-md-6">
            {{ cards.stat_card(
                'bi bi-exclamation-triangle',
                'bg-warning',
                'dashboard.stats.identified_risks'|trans({}, 'dashboard'),
                stats.risks_total|default(0),
                'bi bi-arrow-up',
                stats.risks_high|default(0) ~ ' ' ~ 'dashboard.stats.high'|trans({}, 'dashboard'),
                'negative'
            ) }}
        </div>

        {# Controls Card #}
        <div class="col-lg-3 col-md-6">
            {{ cards.stat_card(
                'bi bi-shield-check',
                'bg-success',
                'dashboard.stats.security_controls'|trans({}, 'dashboard'),
                stats.controls_implemented|default(0) ~ '/' ~ stats.controls_total|default(0),
                'bi bi-check-circle',
                stats.compliance_percentage|default(0) ~ '% ' ~ 'dashboard.stats.implemented'|trans({}, 'dashboard'),
                'positive'
            ) }}
        </div>

        {# Incidents Card #}
        <div class="col-lg-3 col-md-6">
            {{ cards.stat_card(
                'bi bi-exclamation-circle',
                'bg-danger',
                'dashboard.stats.open_incidents'|trans({}, 'dashboard'),
                stats.incidents_open|default(0),
                'bi bi-clock-history',
                'dashboard.stats.in_progress'|trans({}, 'dashboard'),
                ''
            ) }}
        </div>
    </div>

    {# Management KPIs Row (if available) #}
    {% if management_kpis is defined and management_kpis|length > 1 %}
    <div class="row mb-4">
        <div class="col-12">
            {% include 'home/_management_kpis_widget.html.twig' with {
                management_kpis: management_kpis
            } %}
        </div>
    </div>
    {% endif %}

    {# Charts and Activity Row #}
    <div class="row">
        {# Charts Column #}
        <div class="col-lg-8">
            {# Risk Distribution Chart #}
            <div class="widget-card mb-4"
                 data-widget-id="risk-chart"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-pie-chart" aria-hidden="true"></i>
                        {{ 'dashboard.chart.risk_distribution'|trans({}, 'dashboard') }}
                    </h3>
                    <div class="widget-actions">
                        <button class="widget-action" title="{{ 'common.refresh'|trans({}, 'messages') }}" aria-label="{{ 'common.refresh'|trans({}, 'messages') }}">
                            <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas data-controller="chart"
                            data-chart-type-value="doughnut"
                            data-chart-data-value='{"labels":["{{ 'risk.level.high'|trans({}, 'messages') }}","{{ 'risk.level.medium'|trans({}, 'messages') }}","{{ 'risk.level.low'|trans({}, 'messages') }}","{{ 'risk.level.very_low'|trans({}, 'messages') }}"],"datasets":[{"data":[{{ stats.risks_high|default(0) }},{{ (stats.risks_total|default(0) - stats.risks_high|default(0)) / 2 }},{{ (stats.risks_total|default(0) - stats.risks_high|default(0)) / 3 }},{{ (stats.risks_total|default(0) - stats.risks_high|default(0)) / 6 }}],"backgroundColor":["#dc3545","#ffc107","#17a2b8","#28a745"]}]}'
                            data-chart-options-value='{"plugins":{"legend":{"position":"bottom"}}}'></canvas>
                </div>
            </div>

            {# Assets by Category Chart #}
            <div class="widget-card"
                 data-widget-id="asset-chart"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-bar-chart" aria-hidden="true"></i>
                        {{ 'dashboard.chart.assets_by_category'|trans({}, 'dashboard') }}
                    </h3>
                </div>
                <div class="chart-container">
                    <canvas data-controller="chart"
                            data-chart-type-value="bar"
                            data-chart-data-value='{"labels":["Hardware","Software","Daten","Personal","Services"],"datasets":[{"label":"Anzahl Assets","data":[{{ (stats.assets_total|default(0) * 0.3)|round }},{{ (stats.assets_total|default(0) * 0.25)|round }},{{ (stats.assets_total|default(0) * 0.2)|round }},{{ (stats.assets_total|default(0) * 0.15)|round }},{{ (stats.assets_total|default(0) * 0.1)|round }}],"backgroundColor":"rgba(102, 126, 234, 0.7)","borderColor":"rgba(102, 126, 234, 1)","borderWidth":1}]}'
                            data-chart-options-value='{"scales":{"y":{"beginAtZero":true}}}'></canvas>
                </div>
            </div>
        </div>

        {# Activity Feed Column #}
        <div class="col-lg-4">
            {# Compliance Status Widget (Overview of all frameworks) #}
            {% include 'home/_compliance_status_widget.html.twig' with {
                compliance_summary: compliance_summary|default({has_frameworks: false})
            } %}

            {# Workflow Approvals Widget (UX High Priority #1) #}
            {% include 'home/_workflow_widget.html.twig' with {
                pending_workflows: pending_workflows|default([]),
                overdue_workflows: overdue_workflows|default([]),
                upcoming_workflow_deadlines: upcoming_workflow_deadlines|default([])
            } %}

            {# Overdue Risk Reviews Widget (ISO 27001:2022 Clause 6.1.3.d) #}
            {% if overdue_reviews|default([])|length > 0 %}
            <div class="widget-card mb-4 border-warning"
                 data-widget-id="overdue-reviews"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header bg-warning-subtle">
                    <h3 class="widget-title text-warning">
                        <i class="bi bi-calendar-x" aria-hidden="true"></i>
                        {{ 'dashboard.overdue_reviews.title'|trans({}, 'dashboard') }}
                    </h3>
                    <span class="badge bg-warning">{{ overdue_reviews|length }}</span>
                </div>
                <div class="widget-body p-3">
                    <p class="text-muted mb-3">
                        {{ 'dashboard.overdue_reviews.description'|trans({ '%count%': overdue_reviews|length }, 'dashboard') }}
                    </p>
                    <ul class="list-unstyled mb-0">
                        {% for risk in overdue_reviews|slice(0, 5) %}
                        <li class="mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <a href="{{ path('app_risk_show', {id: risk.id}) }}" class="text-decoration-none fw-bold">
                                        {{ risk.title }}
                                    </a>
                                    <div class="small text-muted">
                                        {% if risk.reviewDate %}
                                            <i class="bi bi-calendar-event" aria-hidden="true"></i>
                                            {{ 'dashboard.overdue_reviews.last_review'|trans({}, 'dashboard') }}: {{ risk.reviewDate|date('d.m.Y') }}
                                        {% else %}
                                            <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                                            {{ 'dashboard.overdue_reviews.never_reviewed'|trans({}, 'dashboard') }}
                                        {% endif %}
                                    </div>
                                </div>
                                <span class="badge bg-{{ risk.probability * risk.impact >= 20 ? 'danger' : (risk.probability * risk.impact >= 12 ? 'warning' : 'info') }} ms-2">
                                    {{ risk.probability * risk.impact }}
                                </span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% if overdue_reviews|length > 5 %}
                        <div class="text-center mt-3">
                            <a href="{{ path('app_risk_index') }}" class="btn btn-sm btn-outline-warning">
                                <i class="bi bi-arrow-right" aria-hidden="true"></i>
                                {{ 'dashboard.overdue_reviews.view_all'|trans({ '%count%': overdue_reviews|length - 5 }, 'dashboard') }}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Upcoming Risk Reviews Widget (ISO 27001:2022 Clause 6.1.3.d) #}
            {% if upcoming_reviews|default([])|length > 0 %}
            <div class="widget-card mb-4 border-info"
                 data-widget-id="upcoming-reviews"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header bg-info-subtle">
                    <h3 class="widget-title text-info">
                        <i class="bi bi-calendar-check" aria-hidden="true"></i>
                        {{ 'dashboard.upcoming_reviews.title'|trans({}, 'dashboard') }}
                    </h3>
                    <span class="badge bg-info">{{ upcoming_reviews|length }}</span>
                </div>
                <div class="widget-body p-3">
                    <p class="text-muted mb-3 small">
                        {{ 'dashboard.upcoming_reviews.description'|trans({}, 'dashboard') }}
                    </p>
                    <ul class="list-unstyled mb-0">
                        {% for risk in upcoming_reviews|slice(0, 3) %}
                        <li class="mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <a href="{{ path('app_risk_show', {id: risk.id}) }}" class="text-decoration-none">
                                        {{ risk.title|length > 40 ? risk.title|slice(0, 40) ~ '...' : risk.title }}
                                    </a>
                                    <div class="small text-muted">
                                        <i class="bi bi-calendar-event" aria-hidden="true"></i>
                                        {{ risk.reviewDate|date('d.m.Y') }}
                                    </div>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {# Overdue Treatment Plans Widget (ISO 27001:2022 Clause 6.1.3 - Priority 2.4) #}
            {% if overdue_treatment_plans|default([])|length > 0 %}
            <div class="widget-card mb-4 border-danger"
                 data-widget-id="overdue-treatment-plans"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header bg-danger-subtle">
                    <h3 class="widget-title text-danger">
                        <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                        {{ 'dashboard.overdue_treatment_plans.title'|trans({}, 'dashboard') }}
                    </h3>
                    <span class="badge bg-danger">{{ overdue_treatment_plans|length }}</span>
                </div>
                <div class="widget-body p-3">
                    <p class="text-muted mb-3 small">
                        {{ 'dashboard.overdue_treatment_plans.description'|trans({ '%count%': overdue_treatment_plans|length }, 'dashboard') }}
                    </p>
                    <ul class="list-unstyled mb-0">
                        {% for plan in overdue_treatment_plans|slice(0, 5) %}
                        <li class="mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <a href="{{ path('app_risk_treatment_plan_show', {id: plan.id}) }}" class="text-decoration-none fw-bold">
                                        {{ plan.title|length > 35 ? plan.title|slice(0, 35) ~ '...' : plan.title }}
                                    </a>
                                    <div class="small text-muted">
                                        <i class="bi bi-calendar-x" aria-hidden="true"></i>
                                        {{ 'dashboard.overdue_treatment_plans.due_date'|trans({}, 'dashboard') }}: {{ plan.targetCompletionDate|date('d.m.Y') }}
                                        {% set daysOverdue = date().diff(plan.targetCompletionDate).days %}
                                        <span class="text-danger">({{ daysOverdue }} {{ 'dashboard.overdue_treatment_plans.days_overdue'|trans({}, 'dashboard') }})</span>
                                    </div>
                                    <div class="progress mt-1" style="height: 4px;">
                                        <div class="progress-bar bg-danger" role="progressbar"
                                             style="width: {{ plan.completionPercentage }}%"
                                             aria-valuenow="{{ plan.completionPercentage }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                </div>
                                <span class="badge bg-{{ plan.priority == 'critical' ? 'danger' : (plan.priority == 'high' ? 'warning' : 'secondary') }} ms-2">
                                    {{ ('risk_treatment_plan.priority.' ~ plan.priority)|trans({}, 'risk_treatment_plan') }}
                                </span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% if overdue_treatment_plans|length > 5 %}
                        <div class="text-center mt-3">
                            <a href="{{ path('app_risk_treatment_plan_index') }}" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-arrow-right" aria-hidden="true"></i>
                                {{ 'dashboard.overdue_treatment_plans.view_all'|trans({ '%count%': overdue_treatment_plans|length - 5 }, 'dashboard') }}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Approaching Deadline Treatment Plans Widget (ISO 27001:2022 Clause 6.1.3 - Priority 2.4) #}
            {% if approaching_treatment_plans|default([])|length > 0 %}
            <div class="widget-card mb-4 border-warning"
                 data-widget-id="approaching-treatment-plans"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header bg-warning-subtle">
                    <h3 class="widget-title text-warning">
                        <i class="bi bi-clock-history" aria-hidden="true"></i>
                        {{ 'dashboard.approaching_treatment_plans.title'|trans({}, 'dashboard') }}
                    </h3>
                    <span class="badge bg-warning">{{ approaching_treatment_plans|length }}</span>
                </div>
                <div class="widget-body p-3">
                    <p class="text-muted mb-3 small">
                        {{ 'dashboard.approaching_treatment_plans.description'|trans({}, 'dashboard') }}
                    </p>
                    <ul class="list-unstyled mb-0">
                        {% for plan in approaching_treatment_plans|slice(0, 3) %}
                        <li class="mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <a href="{{ path('app_risk_treatment_plan_show', {id: plan.id}) }}" class="text-decoration-none">
                                        {{ plan.title|length > 40 ? plan.title|slice(0, 40) ~ '...' : plan.title }}
                                    </a>
                                    <div class="small text-muted">
                                        <i class="bi bi-calendar-event" aria-hidden="true"></i>
                                        {{ plan.targetCompletionDate|date('d.m.Y') }}
                                        {% set daysRemaining = date().diff(plan.targetCompletionDate).days %}
                                        <span>({{ daysRemaining }} {{ 'dashboard.approaching_treatment_plans.days_remaining'|trans({}, 'dashboard') }})</span>
                                    </div>
                                    <div class="progress mt-1" style="height: 4px;">
                                        <div class="progress-bar" role="progressbar"
                                             style="width: {{ plan.completionPercentage }}%"
                                             aria-valuenow="{{ plan.completionPercentage }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {# Activity Feed Widget #}
            <div class="widget-card mb-4"
                 data-widget-id="activity-feed"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-activity" aria-hidden="true"></i>
                        Letzte Aktivitäten
                    </h3>
                    <div class="widget-actions">
                        <button class="widget-action" title="{{ 'common.view_all'|trans({}, 'messages') }}" aria-label="{{ 'common.view_all'|trans({}, 'messages') }}">
                            <i class="bi bi-arrows-fullscreen" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                {% include '_components/_activity_feed.html.twig' with {
                    activities: activities|default([])
                } %}
            </div>

            {# Quick Actions Widget #}
            <div class="widget-card"
                 data-widget-id="quick-actions"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-lightning" aria-hidden="true"></i>
                        Schnellzugriff
                    </h3>
                </div>
                <div class="quick-actions">
                    <a href="{{ path('app_asset_new') }}" class="quick-action-btn">
                        <div class="quick-action-icon" aria-hidden="true">
                            <i class="bi bi-plus-circle text-primary" aria-hidden="true"></i>
                        </div>
                        <div class="quick-action-label">Neues Asset</div>
                    </a>
                    <a href="{{ path('app_risk_new') }}" class="quick-action-btn">
                        <div class="quick-action-icon" aria-hidden="true">
                            <i class="bi bi-exclamation-triangle text-warning" aria-hidden="true"></i>
                        </div>
                        <div class="quick-action-label">Risiko erfassen</div>
                    </a>
                    <a href="{{ path('app_compliance_index') }}" class="quick-action-btn">
                        <div class="quick-action-icon" aria-hidden="true">
                            <i class="bi bi-shield-check text-success" aria-hidden="true"></i>
                        </div>
                        <div class="quick-action-label">Maßnahmen</div>
                    </a>
                    <a href="{{ path('app_incident_new') }}" class="quick-action-btn">
                        <div class="quick-action-icon" aria-hidden="true">
                            <i class="bi bi-exclamation-circle text-danger" aria-hidden="true"></i>
                        </div>
                        <div class="quick-action-label">Vorfall melden</div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    {# Dashboard Settings Modal #}
    {% include '_components/_dashboard_settings_modal.html.twig' %}
</div>
{% endblock %}
