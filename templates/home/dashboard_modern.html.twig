{% extends 'base.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block body %}
<div class="container-fluid"
     data-controller="dashboard-customizer"
     data-dashboard-customizer-api-url-value="{{ path('app_dashboard_layout_get') }}">
    {# Breadcrumb Navigation #}
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'Dashboard' }
        ]
    } %}

    {# Page Header with Customize Button #}
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            {% include '_components/_page_header.html.twig' with {
                title: 'ISMS Dashboard',
                subtitle: 'Überblick über Ihr Informationssicherheits-Managementsystem',
                icon: 'bi-speedometer2'
            } %}
        </div>
        <button class="btn btn-outline-secondary"
                data-action="click->dashboard-customizer#openSettings"
                title="Dashboard anpassen">
            <i class="bi bi-sliders" aria-hidden="true"></i> Anpassen
        </button>
    </div>

    {# Stats Cards Row #}
    <div class="row mb-4"
         data-widget-id="stats-cards"
         data-dashboard-customizer-target="widget">
        {# Assets Card #}
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-card-icon bg-primary" aria-hidden="true">
                    <i class="bi bi-server" aria-hidden="true"></i>
                </div>
                <div class="stat-card-title">Registrierte Assets</div>
                <div class="stat-card-value">{{ stats.assets_total|default(0) }}</div>
                <div class="stat-card-change positive">
                    <i class="bi bi-arrow-up" aria-hidden="true"></i>
                    <span>{{ stats.assets_critical|default(0) }} kritisch</span>
                </div>
            </div>
        </div>

        {# Risks Card #}
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-card-icon bg-warning" aria-hidden="true">
                    <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                </div>
                <div class="stat-card-title">Identifizierte Risiken</div>
                <div class="stat-card-value">{{ stats.risks_total|default(0) }}</div>
                <div class="stat-card-change negative">
                    <i class="bi bi-arrow-up" aria-hidden="true"></i>
                    <span>{{ stats.risks_high|default(0) }} hoch</span>
                </div>
            </div>
        </div>

        {# Controls Card #}
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-card-icon bg-success" aria-hidden="true">
                    <i class="bi bi-shield-check" aria-hidden="true"></i>
                </div>
                <div class="stat-card-title">Sicherheitsmaßnahmen</div>
                <div class="stat-card-value">{{ stats.controls_implemented|default(0) }}/{{ stats.controls_total|default(0) }}</div>
                <div class="stat-card-change positive">
                    <i class="bi bi-check-circle" aria-hidden="true"></i>
                    <span>{{ stats.compliance_percentage|default(0) }}% implementiert</span>
                </div>
            </div>
        </div>

        {# Incidents Card #}
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-card-icon bg-danger" aria-hidden="true">
                    <i class="bi bi-exclamation-circle" aria-hidden="true"></i>
                </div>
                <div class="stat-card-title">Offene Vorfälle</div>
                <div class="stat-card-value">{{ stats.incidents_open|default(0) }}</div>
                <div class="stat-card-change">
                    <i class="bi bi-clock-history" aria-hidden="true"></i>
                    <span>In Bearbeitung</span>
                </div>
            </div>
        </div>
    </div>

    {# Charts and Activity Row #}
    <div class="row">
        {# Charts Column #}
        <div class="col-lg-8">
            {# Risk Distribution Chart #}
            <div class="widget-card mb-4"
                 data-widget-id="risk-chart"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-pie-chart" aria-hidden="true"></i>
                        Risikoverteilung
                    </h3>
                    <div class="widget-actions">
                        <button class="widget-action" title="Aktualisieren" aria-label="Aktualisieren">
                            <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas data-controller="chart"
                            data-chart-type-value="doughnut"
                            data-chart-data-value='{"labels":["Hoch","Mittel","Niedrig","Sehr Niedrig"],"datasets":[{"data":[{{ stats.risks_high|default(0) }},{{ (stats.risks_total|default(0) - stats.risks_high|default(0)) / 2 }},{{ (stats.risks_total|default(0) - stats.risks_high|default(0)) / 3 }},{{ (stats.risks_total|default(0) - stats.risks_high|default(0)) / 6 }}],"backgroundColor":["#e74c3c","#f39c12","#3498db","#2ecc71"]}]}'
                            data-chart-options-value='{"plugins":{"legend":{"position":"bottom"}}}'></canvas>
                </div>
            </div>

            {# Assets by Category Chart #}
            <div class="widget-card"
                 data-widget-id="asset-chart"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-bar-chart" aria-hidden="true"></i>
                        Assets nach Kategorie
                    </h3>
                </div>
                <div class="chart-container">
                    <canvas data-controller="chart"
                            data-chart-type-value="bar"
                            data-chart-data-value='{"labels":["Hardware","Software","Daten","Personal","Services"],"datasets":[{"label":"Anzahl Assets","data":[{{ (stats.assets_total|default(0) * 0.3)|round }},{{ (stats.assets_total|default(0) * 0.25)|round }},{{ (stats.assets_total|default(0) * 0.2)|round }},{{ (stats.assets_total|default(0) * 0.15)|round }},{{ (stats.assets_total|default(0) * 0.1)|round }}],"backgroundColor":"rgba(102, 126, 234, 0.7)","borderColor":"rgba(102, 126, 234, 1)","borderWidth":1}]}'
                            data-chart-options-value='{"scales":{"y":{"beginAtZero":true}}}'></canvas>
                </div>
            </div>
        </div>

        {# Activity Feed Column #}
        <div class="col-lg-4">
            {# Activity Feed Widget #}
            <div class="widget-card mb-4"
                 data-widget-id="activity-feed"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-activity" aria-hidden="true"></i>
                        Letzte Aktivitäten
                    </h3>
                    <div class="widget-actions">
                        <button class="widget-action" title="Alle anzeigen" aria-label="Alle anzeigen">
                            <i class="bi bi-arrows-fullscreen" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                {% include '_components/_activity_feed.html.twig' with {
                    activities: activities|default([])
                } %}
            </div>

            {# Quick Actions Widget #}
            <div class="widget-card"
                 data-widget-id="quick-actions"
                 data-dashboard-customizer-target="widget">
                <div class="widget-header">
                    <h3 class="widget-title">
                        <i class="bi bi-lightning" aria-hidden="true"></i>
                        Schnellzugriff
                    </h3>
                </div>
                <div class="quick-actions">
                    <a href="{{ path('app_asset_new') }}" class="quick-action-btn">
                        <div class="quick-action-icon" aria-hidden="true">
                            <i class="bi-plus-circle text-primary" aria-hidden="true"></i>
                        </div>
                        <div class="quick-action-label">Neues Asset</div>
                    </a>
                    <a href="{{ path('app_risk_new') }}" class="quick-action-btn">
                        <div class="quick-action-icon" aria-hidden="true">
                            <i class="bi-exclamation-triangle text-warning" aria-hidden="true"></i>
                        </div>
                        <div class="quick-action-label">Risiko erfassen</div>
                    </a>
                    <a href="{{ path('app_compliance_index') }}" class="quick-action-btn">
                        <div class="quick-action-icon" aria-hidden="true">
                            <i class="bi-shield-check text-success" aria-hidden="true"></i>
                        </div>
                        <div class="quick-action-label">Maßnahmen</div>
                    </a>
                    <a href="{{ path('app_incident_new') }}" class="quick-action-btn">
                        <div class="quick-action-icon" aria-hidden="true">
                            <i class="bi-exclamation-circle text-danger" aria-hidden="true"></i>
                        </div>
                        <div class="quick-action-label">Vorfall melden</div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    {# Dashboard Settings Modal #}
    {% include '_components/_dashboard_settings_modal.html.twig' %}
</div>
{% endblock %}
