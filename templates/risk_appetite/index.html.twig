{% extends 'base.html.twig' %}

{% block title %}{{ 'risk_appetite.title'|trans }} - {{ 'app.title'|trans }}{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1><i class="bi bi-speedometer2" aria-hidden="true"></i> {{ 'risk_appetite.title'|trans }}</h1>
        <p class="text-muted">{{ 'risk_appetite.description'|trans }}</p>
    </div>
    <div class="button-group">
        {% if is_granted('ROLE_ADMIN') %}
        <a href="{{ path('app_risk_appetite_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle" aria-hidden="true"></i> {{ 'risk_appetite.new'|trans }}
        </a>
        {% endif %}
    </div>
</div>

<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-collection" aria-hidden="true"></i></div>
        <div class="stat-value">{{ appetites|length }}</div>
        <div class="stat-label">{{ 'risk_appetite.stats.total'|trans }}</div>
    </div>

    {% if globalAppetite %}
    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-globe" aria-hidden="true"></i></div>
        <div class="stat-value">{{ globalAppetite.maxAcceptableRisk }}</div>
        <div class="stat-label">{{ 'risk_appetite.stats.global_threshold'|trans }}</div>
    </div>
    {% endif %}

    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-folder" aria-hidden="true"></i></div>
        <div class="stat-value">{{ categories|length }}</div>
        <div class="stat-label">{{ 'risk_appetite.stats.categories'|trans }}</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon"><i class="bi bi-graph-up-arrow" aria-hidden="true"></i></div>
        <div class="stat-value">{{ totalRisks }}</div>
        <div class="stat-label">{{ 'risk_appetite.stats.total_risks'|trans }}</div>
    </div>

    <div class="stat-card {{ risksExceedingAppetite|length > 0 ? 'bg-danger text-white' : '' }}">
        <div class="stat-icon"><i class="bi bi-exclamation-triangle" aria-hidden="true"></i></div>
        <div class="stat-value">{{ risksExceedingAppetite|length }}</div>
        <div class="stat-label">{{ 'risk_appetite.stats.exceeding'|trans }}</div>
    </div>
</div>

{# Skip link for filters section - WCAG 2.4.1 #}
<a href="#filter-section" class="skip-link">{{ 'accessibility.skip_to_filters'|trans }}</a>

{# Filter Section #}
<div class="card mb-4">
    <div class="card-header">
        <h3><i class="bi bi-funnel" aria-hidden="true"></i> {{ 'common.filters'|trans }}</h3>
    </div>
    <div class="card-body" id="filter-section" tabindex="-1">
        <form method="get" action="{{ path('app_risk_appetite_index') }}" class="row g-3" role="search" aria-label="{{ 'common.filters'|trans }}">
            <div class="col-md-6">
                <label for="filter-category" class="form-label">{{ 'risk_appetite.field.category'|trans }}</label>
                <select class="form-select" id="filter-category" name="category" onchange="this.form.submit()">
                    <option value="">{{ 'common.all'|trans }}</option>
                    <option value="global" {{ app.request.get('category') == 'global' ? 'selected' : '' }}>{{ 'risk_appetite.category.global'|trans }}</option>
                    {% for cat in categories %}
                        <option value="{{ cat }}" {{ app.request.get('category') == cat ? 'selected' : '' }}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="filter-active" class="form-label">{{ 'risk_appetite.field.status'|trans }}</label>
                <select class="form-select" id="filter-active" name="active_only" onchange="this.form.submit()">
                    <option value="">{{ 'common.all'|trans }}</option>
                    <option value="1" {{ app.request.get('active_only') == '1' ? 'selected' : '' }}>{{ 'risk_appetite.filter.active_only'|trans }}</option>
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search" aria-hidden="true"></i> {{ 'common.filter'|trans }}
                </button>
                <a href="{{ path('app_risk_appetite_index') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle" aria-hidden="true"></i> {{ 'common.reset'|trans }}
                </a>
            </div>
        </form>
    </div>
</div>

{# Risk Appetites Table #}
<div class="card">
    <div class="card-header">
        <h3><i class="bi bi-list" aria-hidden="true"></i> {{ 'risk_appetite.list.title'|trans }} ({{ appetites|length }})</h3>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th scope="col">{{ 'risk_appetite.field.category'|trans }}</th>
                    <th scope="col" class="text-center">{{ 'risk_appetite.field.max_acceptable_risk'|trans }}</th>
                    <th scope="col">{{ 'risk_appetite.field.description'|trans }}</th>
                    <th scope="col" class="text-center">{{ 'risk_appetite.field.status'|trans }}</th>
                    <th scope="col">{{ 'risk_appetite.field.approved_by'|trans }}</th>
                    <th scope="col">{{ 'risk_appetite.field.approved_at'|trans }}</th>
                    <th scope="col" class="text-center">{{ 'common.actions'|trans }}</th>
                </tr>
            </thead>
            <tbody>
                {% for appetite in appetites %}
                <tr>
                    <td>
                        <strong>
                            {% if appetite.isGlobal() %}
                                <i class="bi bi-globe" aria-hidden="true"></i> {{ 'risk_appetite.category.global'|trans }}
                            {% else %}
                                <i class="bi bi-folder" aria-hidden="true"></i> {{ appetite.category }}
                            {% endif %}
                        </strong>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-{{ appetite.maxAcceptableRisk <= 6 ? 'success' : (appetite.maxAcceptableRisk <= 12 ? 'warning' : 'danger') }} fs-6">
                            {{ appetite.maxAcceptableRisk }}
                        </span>
                        <br>
                        <small class="text-muted">({{ 'risk_appetite.scale'|trans }}: 1-25)</small>
                    </td>
                    <td>
                        {{ appetite.description|length > 100 ? appetite.description|slice(0, 100) ~ '...' : appetite.description }}
                    </td>
                    <td class="text-center">
                        {% if appetite.isActive() %}
                            <span class="badge bg-success">{{ 'risk_appetite.status.active'|trans }}</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ 'risk_appetite.status.inactive'|trans }}</span>
                        {% endif %}
                        {% if appetite.isApproved() %}
                            <br><span class="badge bg-info mt-1">{{ 'risk_appetite.approved'|trans }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if appetite.approvedBy %}
                            {{ appetite.approvedBy.fullName }}
                        {% else %}
                            <span class="text-muted">{{ 'common.not_approved'|trans }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if appetite.approvedAt %}
                            {{ appetite.approvedAt|date('Y-m-d') }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <a href="{{ path('app_risk_appetite_show', {id: appetite.id}) }}"
                               class="btn btn-outline-primary"
                               title="{{ 'common.view'|trans }}" aria-label="{{ 'common.view'|trans }}">
                                <i class="bi bi-eye" aria-hidden="true"></i>
                            </a>
                            {% if is_granted('ROLE_ADMIN') %}
                            <a href="{{ path('app_risk_appetite_edit', {id: appetite.id}) }}"
                               class="btn btn-outline-secondary"
                               title="{{ 'common.edit'|trans }}" aria-label="{{ 'common.edit'|trans }}">
                                <i class="bi bi-pencil" aria-hidden="true"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        {{ 'risk_appetite.no_appetites'|trans }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# Risks Exceeding Appetite Warning #}
{% if risksExceedingAppetite|length > 0 %}
<div class="card border-danger mt-4">
    <div class="card-header bg-danger text-white">
        <h3><i class="bi bi-exclamation-triangle" aria-hidden="true"></i> {{ 'risk_appetite.exceeding.title'|trans }}</h3>
    </div>
    <div class="card-body">
        <p>{{ 'risk_appetite.exceeding.description'|trans({'%count%': risksExceedingAppetite|length}) }}</p>
        <ul>
            {% for risk in risksExceedingAppetite|slice(0, 5) %}
            <li>
                <a href="{{ path('app_risk_show', {id: risk.id}) }}">{{ risk.title }}</a>
                - Score: {{ risk.riskScore }}
                {% if globalAppetite %}
                    ({{ 'risk_appetite.exceeds_by'|trans }}: {{ risk.riskScore - globalAppetite.maxAcceptableRisk }})
                {% endif %}
            </li>
            {% endfor %}
            {% if risksExceedingAppetite|length > 5 %}
            <li class="text-muted">{{ 'risk_appetite.and_more'|trans({'%count%': risksExceedingAppetite|length - 5}) }}</li>
            {% endif %}
        </ul>
    </div>
</div>
{% endif %}

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-xl);
}

.button-group {
    display: flex;
    gap: var(--spacing-sm);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: var(--spacing-lg);
}

.stat-card {
    background: var(--color-white);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    text-align: center;
    transition: all var(--transition-normal);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    font-size: 2.5rem;
    color: var(--color-secondary);
    margin-bottom: var(--spacing-sm);
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--color-primary);
}

.stat-label {
    color: var(--color-text-light);
    margin-top: var(--spacing-xs);
}

.mb-4 {
    margin-bottom: var(--spacing-xl);
}
</style>
{% endblock %}
