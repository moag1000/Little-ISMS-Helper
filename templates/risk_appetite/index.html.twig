{% extends 'base.html.twig' %}
{% trans_default_domain 'risk_appetite' %}

{% block title %}{{ 'risk_appetite.title'|trans({}, 'risk_appetite') }} - {{ 'app.title'|trans({}, 'messages') }}{% endblock %}

{% block body %}
{% import '_macros/cards.html.twig' as cards %}

<div class="container">
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'nav.risks'|trans({}, 'nav'), url: path('app_risk_index') },
            { label: 'nav.risk_appetite'|trans({}, 'nav') }
        ]
    } %}
</div>

<div class="page-header">
    <div>
        <h1><i class="bi bi-speedometer2" aria-hidden="true"></i> {{ 'risk_appetite.title'|trans({}, 'risk_appetite') }}</h1>
        <p class="text-muted">{{ 'risk_appetite.description'|trans({}, 'risk_appetite') }}</p>
    </div>
    <div class="button-group">
        {% if is_granted('ROLE_ADMIN') %}
        <a href="{{ path('app_risk_appetite_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle" aria-hidden="true"></i> {{ 'risk_appetite.new'|trans({}, 'risk_appetite') }}
        </a>
        {% endif %}
    </div>
</div>

<div class="stats-grid mb-4">
    <div class="col-auto">
        {{ cards.kpi_card('risk_appetite.stats.total'|trans({}, 'risk_appetite'), appetites|length, null, null, null, null) }}
    </div>
    {% if globalAppetite %}
    <div class="col-auto">
        {{ cards.kpi_card('risk_appetite.stats.global_threshold'|trans({}, 'risk_appetite'), globalAppetite.maxAcceptableRisk, null, null, 'primary', null) }}
    </div>
    {% endif %}
    <div class="col-auto">
        {{ cards.kpi_card('risk_appetite.stats.categories'|trans({}, 'risk_appetite'), categories|length, null, null, 'info', null) }}
    </div>
    <div class="col-auto">
        {{ cards.kpi_card('risk_appetite.stats.total_risks'|trans({}, 'risk_appetite'), totalRisks, null, null, 'success', null) }}
    </div>
    <div class="col-auto">
        {{ cards.kpi_card('risk_appetite.stats.exceeding'|trans({}, 'risk_appetite'), risksExceedingAppetite|length, null, null, risksExceedingAppetite|length > 0 ? 'danger' : null, null) }}
    </div>
</div>

{# Skip link for filters section - WCAG 2.4.1 #}
<a href="#filter-section" class="skip-link">{{ 'accessibility.skip_to_filters'|trans({}, 'messages') }}</a>

{# Filter Section #}
<div class="card mb-4">
    <div class="card-header">
        <h3><i class="bi bi-funnel" aria-hidden="true"></i> {{ 'common.filters'|trans({}, 'messages') }}</h3>
    </div>
    <div class="card-body" id="filter-section" tabindex="-1">
        <form method="get" action="{{ path('app_risk_appetite_index') }}" class="row g-3" role="search" aria-label="{{ 'common.filters'|trans({}, 'messages') }}">
            <div class="col-md-6">
                <label for="filter-category" class="form-label">{{ 'risk_appetite.field.category'|trans({}, 'risk_appetite') }}</label>
                <select class="form-select" id="filter-category" name="category" data-controller="ui-actions" data-action="change->ui-actions#autoSubmit">
                    <option value="">{{ 'common.all'|trans({}, 'messages') }}</option>
                    <option value="global" {{ app.request.query.get('category') == 'global' ? 'selected' : '' }}>{{ 'risk_appetite.category.global'|trans({}, 'risk_appetite') }}</option>
                    {% for cat in categories %}
                        <option value="{{ cat }}" {{ app.request.query.get('category') == cat ? 'selected' : '' }}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="filter-active" class="form-label">{{ 'risk_appetite.field.status'|trans({}, 'risk_appetite') }}</label>
                <select class="form-select" id="filter-active" name="active_only" data-controller="ui-actions" data-action="change->ui-actions#autoSubmit">
                    <option value="">{{ 'common.all'|trans({}, 'messages') }}</option>
                    <option value="1" {{ app.request.query.get('active_only') == '1' ? 'selected' : '' }}>{{ 'risk_appetite.filter.active_only'|trans({}, 'risk_appetite') }}</option>
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search" aria-hidden="true"></i> {{ 'common.filter'|trans({}, 'messages') }}
                </button>
                <a href="{{ path('app_risk_appetite_index') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle" aria-hidden="true"></i> {{ 'common.reset'|trans({}, 'messages') }}
                </a>
            </div>
        </form>
    </div>
</div>

{# Risk Appetites Table #}
<div class="card">
    <div class="card-header">
        <h3><i class="bi bi-list" aria-hidden="true"></i> {{ 'risk_appetite.list.title'|trans({}, 'risk_appetite') }} ({{ appetites|length }})</h3>
    </div>
    {% embed '_components/_table.html.twig' with {
        'class': 'table-hover',
        'noMargin': true
    } %}
        {% block table_head %}
            <tr>
                <th scope="col">{{ 'risk_appetite.field.category'|trans({}, 'risk_appetite') }}</th>
                <th scope="col" class="text-center">{{ 'risk_appetite.field.max_acceptable_risk'|trans({}, 'risk_appetite') }}</th>
                <th scope="col">{{ 'risk_appetite.field.description'|trans({}, 'risk_appetite') }}</th>
                <th scope="col" class="text-center">{{ 'risk_appetite.field.status'|trans({}, 'risk_appetite') }}</th>
                <th scope="col">{{ 'risk_appetite.field.approved_by'|trans({}, 'risk_appetite') }}</th>
                <th scope="col">{{ 'risk_appetite.field.approved_at'|trans({}, 'risk_appetite') }}</th>
                <th scope="col" class="text-center">{{ 'common.actions'|trans({}, 'messages') }}</th>
            </tr>
        {% endblock %}
        {% block table_body %}
            {% for appetite in appetites %}
            <tr>
                <td>
                    <strong>
                        {% if appetite.isGlobal() %}
                            <i class="bi bi-globe" aria-hidden="true"></i> {{ 'risk_appetite.category.global'|trans({}, 'risk_appetite') }}
                        {% else %}
                            <i class="bi bi-folder" aria-hidden="true"></i> {{ appetite.category }}
                        {% endif %}
                    </strong>
                </td>
                <td class="text-center">
                    <span class="badge bg-{{ appetite.maxAcceptableRisk <= 6 ? 'success' : (appetite.maxAcceptableRisk <= 12 ? 'warning' : 'danger') }} fs-6">
                        {{ appetite.maxAcceptableRisk }}
                    </span>
                    <br>
                    <small class="text-muted">({{ 'risk_appetite.scale'|trans({}, 'risk_appetite') }}: 1-25)</small>
                </td>
                <td>
                    {{ appetite.description|length > 100 ? appetite.description|slice(0, 100) ~ '...' : appetite.description }}
                </td>
                <td class="text-center">
                    {% if appetite.isActive() %}
                        <span class="badge bg-success">{{ 'risk_appetite.status.active'|trans({}, 'risk_appetite') }}</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ 'risk_appetite.status.inactive'|trans({}, 'risk_appetite') }}</span>
                    {% endif %}
                    {% if appetite.isApproved() %}
                        <br><span class="badge bg-info mt-1">{{ 'risk_appetite.approved'|trans({}, 'risk_appetite') }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if appetite.approvedBy %}
                        {{ appetite.approvedBy.fullName }}
                    {% else %}
                        <span class="text-muted">{{ 'common.not_approved'|trans({}, 'messages') }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if appetite.approvedAt %}
                        {{ appetite.approvedAt|date('Y-m-d') }}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group" aria-label="{{ 'common.actions'|trans({}, 'messages') }}">
                        <a href="{{ path('app_risk_appetite_show', {id: appetite.id}) }}"
                           class="btn btn-outline-primary"
                           title="{{ 'common.view'|trans({}, 'messages') }}" aria-label="{{ 'common.view'|trans({}, 'messages') }}">
                            <i class="bi bi-eye" aria-hidden="true"></i>
                        </a>
                        {% if is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('app_risk_appetite_edit', {id: appetite.id}) }}"
                           class="btn btn-outline-secondary"
                           title="{{ 'common.edit'|trans({}, 'messages') }}" aria-label="{{ 'common.edit'|trans({}, 'messages') }}">
                            <i class="bi bi-pencil" aria-hidden="true"></i>
                        </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center text-muted">
                    {{ 'risk_appetite.no_appetites'|trans({}, 'risk_appetite') }}
                </td>
            </tr>
            {% endfor %}
        {% endblock %}
    {% endembed %}
</div>

{# Risks Exceeding Appetite Warning #}
{% if risksExceedingAppetite|length > 0 %}
<div class="card border-danger mt-4">
    <div class="card-header bg-danger text-white">
        <h3><i class="bi bi-exclamation-triangle" aria-hidden="true"></i> {{ 'risk_appetite.exceeding.title'|trans({}, 'risk_appetite') }}</h3>
    </div>
    <div class="card-body">
        <p>{{ 'risk_appetite.exceeding.description'|trans({'%count%': risksExceedingAppetite|length}, 'risk_appetite') }}</p>
        <ul>
            {% for risk in risksExceedingAppetite|slice(0, 5) %}
            <li>
                <a href="{{ path('app_risk_show', {id: risk.id}) }}">{{ risk.title }}</a>
                - Score: {{ risk.riskScore }}
                {% if globalAppetite %}
                    ({{ 'risk_appetite.exceeds_by'|trans({}, 'risk_appetite') }}: {{ risk.riskScore - globalAppetite.maxAcceptableRisk }})
                {% endif %}
            </li>
            {% endfor %}
            {% if risksExceedingAppetite|length > 5 %}
            <li class="text-muted">{{ 'risk_appetite.and_more'|trans({'%count%': risksExceedingAppetite|length - 5}, 'risk_appetite') }}</li>
            {% endif %}
        </ul>
    </div>
</div>
{% endif %}
{% endblock %}
