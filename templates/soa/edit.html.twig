{% extends 'base.html.twig' %}

{% block title %}Control bearbeiten - {{ control.controlId }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>Control bearbeiten: {{ control.controlId }}</h1>
    </div>
    <div class="button-group">
        <a href="{{ path('app_soa_index') }}" class="btn btn-secondary">‚Üê Zur√ºck zur √úbersicht</a>
    </div>
</div>

<div class="info-box mb-4">
    <h2>{{ control.name }}</h2>
    <p class="mt-sm-text-light">{{ control.description }}</p>
    <div class="mt-2">
        <span class="badge badge-info">{{ control.category }}</span>
    </div>
</div>

<form method="post">
    <div class="form-group">
        <label class="form-label label-checkbox">
            <input type="checkbox" name="applicable" value="1" {% if control.applicable %}checked{% endif %} class="checkbox-lg">
            <span>Control ist anwendbar f√ºr diese Organisation</span>
        </label>
        <small class="small-muted-block">
            Markieren Sie dieses Control als anwendbar, wenn es f√ºr Ihr ISMS relevant ist.
        </small>
    </div>

    <div class="form-group">
        <label class="form-label" for="justification">
            Begr√ºndung f√ºr Anwendbarkeit/Nicht-Anwendbarkeit *
        </label>
        <textarea
            name="justification"
            id="justification"
            rows="4"
            class="form-control"
            placeholder="Erkl√§ren Sie, warum dieses Control anwendbar oder nicht anwendbar ist..."
        >{{ control.justification }}</textarea>
        <small class="small-muted-block">
            Eine klare Begr√ºndung ist f√ºr Audits und Compliance-Nachweise wichtig.
        </small>
    </div>

    <div class="form-group">
        <label class="form-label" for="implementationStatus">
            Implementierungsstatus
        </label>
        <select name="implementationStatus" id="implementationStatus" class="form-control">
            <option value="not_started" {% if control.implementationStatus == 'not_started' %}selected{% endif %}>Nicht begonnen</option>
            <option value="in_progress" {% if control.implementationStatus == 'in_progress' %}selected{% endif %}>In Arbeit</option>
            <option value="implemented" {% if control.implementationStatus == 'implemented' %}selected{% endif %}>Implementiert</option>
            <option value="not_applicable" {% if control.implementationStatus == 'not_applicable' %}selected{% endif %}>Nicht anwendbar</option>
        </select>
    </div>

    <div class="form-group">
        <label class="form-label" for="implementationPercentage">
            Implementierungsgrad (%)
        </label>
        <div class="flex-center-gap-md">
            <input
                type="range"
                name="implementationPercentage"
                id="implementationPercentage"
                min="0"
                max="100"
                value="{{ control.implementationPercentage }}"
                class="flex-1"
                oninput="document.getElementById('percentageValue').textContent = this.value + '%'"
            >
            <span id="percentageValue" class="badge badge-info badge-fs-1-p-sm-md">
                {{ control.implementationPercentage }}%
            </span>
        </div>
        <div class="progress mt-2">
            <div class="progress-bar" style="width: {{ control.implementationPercentage }}%">
                {{ control.implementationPercentage }}%
            </div>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label" for="implementationNotes">
            Implementierungsnotizen
        </label>
        <textarea
            name="implementationNotes"
            id="implementationNotes"
            rows="6"
            class="form-control"
            placeholder="Beschreiben Sie, wie dieses Control implementiert wurde oder wird..."
        >{{ control.implementationNotes }}</textarea>
        <small class="small-muted-block">
            Dokumentieren Sie technische Details, verwendete Tools, Prozesse, etc.
        </small>
    </div>

    <div class="form-group">
        <label class="form-label" for="responsiblePerson">
            Verantwortliche Person
        </label>
        <input
            type="text"
            name="responsiblePerson"
            id="responsiblePerson"
            value="{{ control.responsiblePerson }}"
            class="form-control"
            placeholder="z.B. Max Mustermann (IT-Sicherheitsbeauftragter)"
        >
    </div>

    <div class="form-group">
        <label class="form-label" for="targetDate">
            Zieldatum f√ºr vollst√§ndige Implementierung
        </label>
        <input
            type="date"
            name="targetDate"
            id="targetDate"
            value="{{ control.targetDate ? control.targetDate|date('Y-m-d') : '' }}"
            class="form-control"
        >
    </div>

    <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-success">
            üíæ √Ñnderungen speichern
        </button>
        <a href="{{ path('app_soa_show', {id: control.id}) }}" class="btn btn-secondary">
            ‚ùå Abbrechen
        </a>
    </div>
</form>

<script>
// Update range input value display in real-time
function initializeSOAPercentageSlider() {
    const rangeInput = document.getElementById('implementationPercentage');
    const progressBar = document.querySelector('.progress-bar');

    if (!rangeInput || !progressBar) return; // Elements not present on page

    // Prevent duplicate listeners
    if (rangeInput.dataset.initialized === 'true') return;
    rangeInput.dataset.initialized = 'true';

    rangeInput.addEventListener('input', function() {
        const value = this.value;
        document.getElementById('percentageValue').textContent = value + '%';
        progressBar.style.width = value + '%';
        progressBar.textContent = value + '%';
    });
}

// Cleanup before Turbo caches the page to allow re-initialization on back navigation
document.addEventListener('turbo:before-cache', function() {
    const rangeInput = document.getElementById('implementationPercentage');
    if (rangeInput) delete rangeInput.dataset.initialized;
});

// Initialize on both DOMContentLoaded (first page load) and turbo:load (Turbo navigation)
document.addEventListener('DOMContentLoaded', initializeSOAPercentageSlider);
document.addEventListener('turbo:load', initializeSOAPercentageSlider);
</script>
{% endblock %}
