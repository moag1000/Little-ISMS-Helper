{% extends 'base.html.twig' %}
{% trans_default_domain 'soa' %}

{% block title %}{{ 'soa.action.edit'|trans }} - {{ control.controlId }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>{{ 'soa.action.edit'|trans }}: {{ control.controlId }}</h1>
    </div>
    <div class="button-group">
        <a href="{{ path('app_soa_index') }}" class="btn btn-secondary">‚Üê {{ 'common.back_to_list'|trans({}, 'messages') }}</a>
    </div>

</div>

<div class="info-box mb-4">
    <h2>{{ control.name }}</h2>
    <p class="mt-sm-text-light">{{ control.description }}</p>
    <div class="mt-2">
        <span class="badge bg-info">{{ control.category }}</span>
    </div>
</div>

<form method="post">
    <div class="form-group">
        <label class="form-label label-checkbox">
            <input type="checkbox" name="applicable" value="1" {% if control.applicable %}checked{% endif %} class="checkbox-lg">
            <span>{{ 'soa.field.applicable'|trans }}</span>
        </label>
        <small class="small-muted-block">
            {{ 'soa.help.applicable'|trans }}
        </small>
    </div>

    <div class="form-group">
        <label class="form-label" for="justification">
            {{ 'soa.field.justification'|trans }} *
        </label>
        <textarea
            name="justification"
            id="justification"
            rows="4"
            class="form-control"
            placeholder="{{ 'soa.placeholder.justification'|trans }}"
        >{{ control.justification }}</textarea>
        <small class="small-muted-block">
            {{ 'soa.help.justification'|trans }}
        </small>
    </div>

    <div class="form-group">
        <label class="form-label" for="implementationStatus">
            {{ 'soa.field.status'|trans }}
        </label>
        <select name="implementationStatus" id="implementationStatus" class="form-control">
            <option value="not_started" {% if control.implementationStatus == 'not_started' %}selected{% endif %}>{{ 'soa.status.not_started'|trans }}</option>
            <option value="in_progress" {% if control.implementationStatus == 'in_progress' %}selected{% endif %}>{{ 'soa.status.in_progress'|trans }}</option>
            <option value="implemented" {% if control.implementationStatus == 'implemented' %}selected{% endif %}>{{ 'soa.status.implemented'|trans }}</option>
            <option value="not_applicable" {% if control.implementationStatus == 'not_applicable' %}selected{% endif %}>{{ 'soa.status.not_applicable'|trans }}</option>
        </select>
    </div>

    <div class="form-group">
        <label class="form-label" for="implementationPercentage">
            {{ 'soa.field.implementation_percentage'|trans }}
        </label>
        <div class="flex-center-gap-md">
            <input
                type="range"
                name="implementationPercentage"
                id="implementationPercentage"
                min="0"
                max="100"
                value="{{ control.implementationPercentage }}"
                class="flex-1"
                oninput="document.getElementById('percentageValue').textContent = this.value + '%'"
            >
            <span id="percentageValue" class="badge bg-info badge-fs-1-p-sm-md">
                {{ control.implementationPercentage }}%
            </span>
        </div>
        <div class="progress mt-2">
            <div class="progress-bar" style="width: {{ control.implementationPercentage }}%">
                {{ control.implementationPercentage }}%
            </div>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label" for="implementationNotes">
            {{ 'soa.field.implementation_notes'|trans }}
        </label>
        <textarea
            name="implementationNotes"
            id="implementationNotes"
            rows="6"
            class="form-control"
            placeholder="{{ 'soa.placeholder.implementation_notes'|trans }}"
        >{{ control.implementationNotes }}</textarea>
        <small class="small-muted-block">
            {{ 'soa.help.implementation_notes'|trans }}
        </small>
    </div>

    <div class="form-group">
        <label class="form-label" for="responsiblePerson">
            {{ 'soa.field.responsible_person'|trans }}
        </label>
        <input
            type="text"
            name="responsiblePerson"
            id="responsiblePerson"
            value="{{ control.responsiblePerson }}"
            class="form-control"
            placeholder="{{ 'soa.placeholder.responsible_person'|trans }}"
        >
    </div>

    <div class="form-group">
        <label class="form-label" for="targetDate">
            {{ 'soa.field.target_date'|trans }}
        </label>
        <input
            type="date"
            name="targetDate"
            id="targetDate"
            value="{{ control.targetDate ? control.targetDate|date('Y-m-d') : '' }}"
            class="form-control"
        >
    </div>

    <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-success">
            üíæ {{ 'common.save_changes'|trans({}, 'messages') }}
        </button>
        <a href="{{ path('app_soa_show', {id: control.id}) }}" class="btn btn-secondary">
            ‚ùå {{ 'common.cancel'|trans({}, 'messages') }}
        </a>
    </div>
</form>

<script>
// Update range input value display in real-time
function initializeSOAPercentageSlider() {
    const rangeInput = document.getElementById('implementationPercentage');
    const progressBar = document.querySelector('.progress-bar');

    if (!rangeInput || !progressBar) return; // Elements not present on page

    // Prevent duplicate listeners
    if (rangeInput.dataset.initialized === 'true') return;
    rangeInput.dataset.initialized = 'true';

    rangeInput.addEventListener('input', function() {
        const value = this.value;
        document.getElementById('percentageValue').textContent = value + '%';
        progressBar.style.width = value + '%';
        progressBar.textContent = value + '%';
    });
}

// Cleanup before Turbo caches the page to allow re-initialization on back navigation
document.addEventListener('turbo:before-cache', function() {
    const rangeInput = document.getElementById('implementationPercentage');
    if (rangeInput) delete rangeInput.dataset.initialized;
});

// Initialize on both DOMContentLoaded (first page load) and turbo:load (Turbo navigation)
document.addEventListener('DOMContentLoaded', initializeSOAPercentageSlider);
document.addEventListener('turbo:load', initializeSOAPercentageSlider);
</script>
{% endblock %}
