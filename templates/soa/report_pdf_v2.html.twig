{% extends 'pdf/_base_document.html.twig' %}
{% trans_default_domain 'soa' %}

{# Document Metadata #}
{% block document_id %}DOC-ISMS-SOA-001{% endblock %}
{% block document_title %}{{ 'page.title'|trans({}, 'messages') }}{% endblock %}
{% block document_type %}{{ 'report.document_type'|trans({}, 'messages') }}{% endblock %}
{% block document_version %}{{ version }}{% endblock %}
{% block document_status %}{{ status|default(('status.approved'|trans({}, 'messages'))) }}{% endblock %}
{% block document_status_class %}{{ status|default('approved')|lower }}{% endblock %}
{% block document_classification %}{{ 'label.classification_confidential'|trans({}, 'messages') }}{% endblock %}
{% block classification_class %}confidential{% endblock %}

{# Header/Footer #}
{% block header_center %}{{ 'report.header_center'|trans({}, 'messages') }}{% endblock %}
{% block header_right %}{{ 'label.classification_confidential_upper'|trans({}, 'messages') }}{% endblock %}
{% block footer_version %}{{ version }}{% endblock %}

{# Show Approval Section #}
{% set show_approval = true %}
{% block reviewer_name %}{{ app.user.fullName|default(('report.default_reviewer'|trans({}, 'messages'))) }}{% endblock %}
{% block review_date %}{{ generatedAt|date('d.m.Y') }}{% endblock %}
{% block approver_name %}{{ approver|default(('report.default_approver'|trans({}, 'messages'))) }}{% endblock %}
{% block approval_date %}{{ approval_date|default(generatedAt|date('d.m.Y')) }}{% endblock %}

{# Show Version History - Beispieldaten! Echte Versionsdaten vom Controller übergeben! #}
{% set show_version_history = true %}
{% block version_history %}
{# Beispiel-Versionsverlauf - durch echte Daten vom Controller ersetzen:
   {% for versionEntry in versionHistory %}
   <tr>
       <td>{{ versionEntry.version }}</td>
       <td>{{ versionEntry.date|date('d.m.Y') }}</td>
       <td>{{ versionEntry.author }}</td>
       <td>{{ versionEntry.changes }}</td>
   </tr>
   {% endfor %}
#}
<tr>
    <td>1.0</td>
    <td>{{ generatedAt|date_modify('-6 months')|date('d.m.Y') }}</td>
    <td>ISMS Team</td>
    <td>Initiale Version nach ISO 27001:2022</td>
</tr>
<tr>
    <td>1.5</td>
    <td>{{ generatedAt|date_modify('-3 months')|date('d.m.Y') }}</td>
    <td>{{ app.user.fullName }}</td>
    <td>Aktualisierung Controls A.8 und A.11</td>
</tr>
<tr>
    <td>2.0</td>
    <td>{{ generatedAt|date('d.m.Y') }}</td>
    <td>{{ app.user.fullName }}</td>
    <td>Vollständige Überprüfung aller Controls, Status-Update</td>
</tr>
{% endblock %}

{# Custom Styles for SoA - Cyberpunk InfoSec Theme #}
{% block custom_styles %}
.stats-grid {
    display: table;
    width: 100%;
    margin-bottom: 20pt;
    border: 3px solid transparent;
    border-image: linear-gradient(90deg, #06b6d4 0%, #ec4899 50%, #8b5cf6 100%) 1;
    border-collapse: collapse;
}

.stats-row {
    display: table-row;
}

.stats-cell {
    display: table-cell;
    padding: 12pt;
    text-align: center;
    border: 1px solid #cbd5e1;
    width: 25%;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.stats-cell:first-child {
    border-left: 3px solid #06b6d4;
}

.stats-cell:last-child {
    border-right: 3px solid #8b5cf6;
}

.stats-label {
    font-size: 8pt;
    color: #0f172a;
    text-transform: uppercase;
    font-weight: bold;
    margin-bottom: 6pt;
    letter-spacing: 0.5pt;
}

.stats-value {
    font-size: 20pt;
    color: #06b6d4;
    font-weight: bold;
    text-shadow: 0 0 1pt rgba(6, 182, 212, 0.3);
}

.control-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15pt;
    font-size: 8pt;
    border: 2px solid #cbd5e1;
}

.control-table th {
    background: linear-gradient(90deg, #0f172a 0%, #1e293b 100%);
    color: #06b6d4;
    padding: 6pt;
    text-align: left;
    font-weight: bold;
    border: 1px solid #1e3a8a;
    text-transform: uppercase;
    letter-spacing: 0.3pt;
}

.control-table td {
    padding: 5pt;
    border: 1px solid #cbd5e1;
    vertical-align: top;
}

.control-table tr:nth-child(even) {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.control-id {
    font-weight: bold;
    color: #06b6d4;
    white-space: nowrap;
}

.badge {
    display: inline-block;
    padding: 2pt 6pt;
    border-radius: 3pt;
    font-size: 7pt;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.3pt;
    border: 1.5pt solid transparent;
}

.badge-implemented {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-color: #059669;
    color: white;
}

.badge-partial {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-color: #d97706;
    color: white;
}

.badge-not-implemented {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border-color: #dc2626;
    color: white;
}

.badge-planned {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    border-color: #0891b2;
    color: white;
}

.badge-applicable {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-color: #059669;
    color: white;
}

.badge-not-applicable {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    border-color: #4b5563;
    color: white;
}

.category-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 8pt;
    margin-top: 15pt;
    margin-bottom: 8pt;
    border-left: 4px solid transparent;
    border-image: linear-gradient(180deg, #06b6d4 0%, #ec4899 100%) 1;
    font-weight: bold;
    font-size: 10pt;
    color: #0f172a;
    text-transform: uppercase;
    letter-spacing: 0.5pt;
}

.percentage {
    font-weight: bold;
    color: #06b6d4;
}
{% endblock %}

{# Main Document Content #}
{% block document_content %}

{# Executive Summary #}
<h1>{{ 'soa.title'|trans }}</h1>
<p class="text-center text-muted mb-medium">
    ISO 27001:2022 Annex A - Anwendbarkeitserklärung der Controls
</p>

<div class="mb-large">
    <h2>Zusammenfassung</h2>
    <p>
        Dieses Dokument beschreibt die Anwendbarkeit und den Implementierungsstatus der ISO 27001:2022
        Annex A Controls für das Informationssicherheits-Managementsystem (ISMS) der Organisation
        <strong>{{ tenant_name|default('Organisation') }}</strong>.
    </p>
    <p>
        Die nachfolgenden Controls wurden auf Basis einer Risikoanalyse und unter Berücksichtigung
        rechtlicher, regulatorischer und vertraglicher Anforderungen bewertet.
    </p>
</div>

{# Statistics Overview #}
<h2>Implementierungsübersicht</h2>
<div class="stats-grid">
    <div class="stats-row">
        <div class="stats-cell">
            <div class="stats-label">Gesamt Controls</div>
            <div class="stats-value">{{ stats.total }}</div>
        </div>
        <div class="stats-cell">
            <div class="stats-label">Anwendbar</div>
            <div class="stats-value">{{ stats.total }}</div>
        </div>
        <div class="stats-cell">
            <div class="stats-label">Implementiert</div>
            <div class="stats-value">{{ stats.implemented }}</div>
        </div>
        <div class="stats-cell">
            <div class="stats-label">Compliance-Rate</div>
            <div class="stats-value">
                <span class="percentage">{% if stats.total > 0 %}{{ ((stats.implemented / stats.total) * 100)|round }}%{% else %}0%{% endif %}</span>
            </div>
        </div>
    </div>
</div>

<div class="mb-large">
    <p><strong>Implementierungsstatus:</strong></p>
    <ul>
        <li>Vollständig implementiert: {{ stats.implemented }} Controls</li>
        <li>In Bearbeitung: {{ stats.in_progress }} Controls</li>
        <li>Noch nicht begonnen: {{ stats.not_started }} Controls</li>
        <li>Nicht anwendbar: {{ stats.not_applicable }} Controls (mit Begründung)</li>
    </ul>
</div>

{# Controls by Category #}
<div class="page-break"></div>
<h2>Controls nach Kategorien</h2>

{% for categoryName, categoryControls in controlsByCategory %}
<div class="category-header">{{ categoryName }}</div>

<table class="control-table">
    <thead>
        <tr>
            <th style="width: 10%;">Control ID</th>
            <th style="width: 25%;">Name</th>
            <th style="width: 35%;">Beschreibung</th>
            <th style="width: 10%;" class="text-center">Anwendbar</th>
            <th style="width: 10%;" class="text-center">Status</th>
            <th style="width: 10%;" class="text-center">Progress</th>
        </tr>
    </thead>
    <tbody>
        {% for control in categoryControls %}
        <tr>
            <td class="control-id">{{ control.controlId }}</td>
            <td><strong>{{ control.name }}</strong></td>
            <td class="text-muted">{{ control.description|slice(0, 200) }}{% if control.description|length > 200 %}...{% endif %}</td>
            <td class="text-center">
                {% if control.applicable %}
                    <span class="badge badge-applicable">✓ Ja</span>
                {% else %}
                    <span class="badge badge-not-applicable">✗ Nein</span>
                {% endif %}
            </td>
            <td class="text-center">
                {% if control.applicable %}
                    {% if control.implementationStatus == 'implemented' %}
                        <span class="badge badge-implemented">Implementiert</span>
                    {% elseif control.implementationStatus == 'partial' %}
                        <span class="badge badge-partial">Teilweise</span>
                    {% elseif control.implementationStatus == 'planned' %}
                        <span class="badge badge-planned">Geplant</span>
                    {% else %}
                        <span class="badge badge-not-implemented">Offen</span>
                    {% endif %}
                {% else %}
                    <span class="badge badge-not-applicable">N/A</span>
                {% endif %}
            </td>
            <td class="text-center">
                {% if control.applicable %}
                    <strong>{{ control.implementationPercentage }}%</strong>
                {% else %}
                    —
                {% endif %}
            </td>
        </tr>
        {% if not control.applicable and control.justification %}
        <tr>
            <td colspan="6" style="background-color: #fef3c7; padding: 5pt;">
                <strong>Begründung für Nicht-Anwendbarkeit:</strong> {{ control.justification }}
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table>
{% endfor %}

{# Detailed Justifications #}
<div class="page-break"></div>
<h2>Detaillierte Begründungen</h2>

<h3>Nicht anwendbare Controls</h3>
{% set hasNonApplicable = false %}
{% for control in allControls %}
    {% if not control.applicable %}
        {% set hasNonApplicable = true %}
        <div class="no-break mb-medium">
            <p><strong>{{ control.controlId }} - {{ control.name }}</strong></p>
            <p class="text-muted" style="margin-left: 15pt;">
                <em>Begründung:</em> {{ control.justification|default('Keine Begründung angegeben') }}
            </p>
        </div>
    {% endif %}
{% endfor %}
{% if not hasNonApplicable %}
<p class="text-muted">Alle Controls sind anwendbar.</p>
{% endif %}

<h3>Geplante Implementierungen</h3>
{% set hasPlanned = false %}
{% for control in allControls %}
    {% if control.applicable and control.implementationStatus == 'planned' %}
        {% set hasPlanned = true %}
        <div class="no-break mb-medium">
            <p><strong>{{ control.controlId }} - {{ control.name }}</strong></p>
            <p class="text-muted" style="margin-left: 15pt;">
                <em>Ziel-Implementierungsdatum:</em> {{ control.targetDate|default('TBD')|date('d.m.Y') }}<br>
                <em>Verantwortlich:</em> {{ control.responsiblePerson|default('Nicht zugewiesen') }}
            </p>
        </div>
    {% endif %}
{% endfor %}
{% if not hasPlanned %}
<p class="text-muted">Keine geplanten Implementierungen.</p>
{% endif %}

{% endblock %}

{# References Section #}
{% set show_references = true %}
{% block references_content %}
<table>
    <thead>
        <tr>
            <th style="width: 20%;">Dokument</th>
            <th style="width: 15%;">Typ</th>
            <th>Beschreibung</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>ISO/IEC 27001:2022</td>
            <td>Standard</td>
            <td>{{ 'soa.iso27001_full_title'|trans }}</td>
        </tr>
        <tr>
            <td>ISO/IEC 27002:2022</td>
            <td>Standard</td>
            <td>Information security controls</td>
        </tr>
        <tr>
            <td>ISMS-POL-001</td>
            <td>Policy</td>
            <td>Informationssicherheitspolitik</td>
        </tr>
        <tr>
            <td>ISMS-RISK-001</td>
            <td>Risk Assessment</td>
            <td>Aktuelle Risikoanalyse</td>
        </tr>
    </tbody>
</table>
{% endblock %}
