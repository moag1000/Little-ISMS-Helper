{% extends 'base.html.twig' %}
{% trans_default_domain 'soa' %}

{% block title %}{{ control.controlId }} - {{ control.name }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>{{ control.controlId }}: {{ control.name }}</h1>
        <div class="mt-2">
            <span class="badge bg-info">{{ ('soa.category.' ~ control.category)|trans }}</span>
        </div>
    </div>
    <div class="button-group">
        <a href="{{ path('app_soa_edit', {id: control.id}) }}" class="btn btn-primary">
            âœï¸ {{ 'soa.action.edit'|trans({}, 'messages') }}
        </a>
        <a href="{{ path('app_soa_by_category', {category: control.category}) }}" class="btn btn-secondary">
            â† {{ 'soa.action.back_to_category'|trans({'%category%': ('soa.category.' ~ control.category)|trans }, 'messages') }}
        </a>
    </div>
</div>

{# Control Description #}
<div class="card mb-4">
    <h2>{{ 'soa.section.description'|trans({}, 'messages') }}</h2>
    <p class="text-light-mt-sm-lh">
        {{ control.description }}
    </p>
</div>

{# Applicability Status #}
<div class="card mb-4">
    <h2>{{ 'soa.section.applicability_status'|trans({}, 'messages') }}</h2>
    <div class="stats-grid mt-2 grid-responsive-200">
        <div class="stat-item">
            <strong class="fs-4">
                {% if control.applicable %}
                    <span class="badge bg-success fs-12">âœ“ {{ 'soa.value.yes'|trans({}, 'messages') }}
                        <span class="visually-hidden">{{ 'soa.table.applicable'|trans({}, 'messages') }}</span>
                    </span>
                {% else %}
                    <span class="badge badge-neutral-lg">âœ— {{ 'soa.status.not_applicable'|trans({}, 'messages') }}</span>
                {% endif %}
            </strong>
            <span>{{ 'soa.field.applicable'|trans({}, 'messages') }}</span>
        </div>

        {% if control.applicable %}
        <div class="stat-item">
            <strong class="fs-4">
                {% if control.implementationStatus == 'implemented' %}
                    <span class="badge bg-success fs-12">âœ… {{ 'soa.status.implemented'|trans({}, 'messages') }}</span>
                {% elseif control.implementationStatus == 'in_progress' %}
                    <span class="badge bg-warning fs-12">ğŸ”„ {{ 'soa.status.in_progress'|trans({}, 'messages') }}</span>
                {% elseif control.implementationStatus == 'not_started' %}
                    <span class="badge bg-danger fs-12">â¸ {{ 'soa.status.not_started'|trans({}, 'messages') }}</span>
                {% else %}
                    <span class="badge badge-neutral-lg">{{ 'soa.value.na'|trans({}, 'messages') }}</span>
                {% endif %}
            </strong>
            <span>{{ 'soa.table.implementation_status'|trans({}, 'messages') }}</span>
        </div>

        <div class="stat-item">
            <strong class="fs-4">{{ control.implementationPercentage }}%</strong>
            <span>{{ 'soa.field.implementation_percentage'|trans({}, 'messages') }}</span>
        </div>
        {% endif %}
    </div>

    {% if control.applicable %}
    <div class="progress mt-3 progress-lg">
        <div class="progress-bar" style="width: {{ control.implementationPercentage }}%; font-size: 1rem;">
            {{ control.implementationPercentage }}%
        </div>
    </div>
    {% endif %}
</div>

{# Justification #}
<div class="card mb-4">
    <h2>{{ 'soa.section.justification'|trans({}, 'messages') }}</h2>
    {% if control.justification %}
        <div class="info-box mt-2 bg-light">
            <p class="ws-pre-wrap-lh">{{ control.justification }}</p>
        </div>
    {% else %}
        <p class="text-muted mt-sm">
            {{ 'soa.message.no_justification'|trans({}, 'messages') }}
        </p>
    {% endif %}
</div>

{% if control.applicable %}
{# Implementation Details #}
<div class="card mb-4">
    <h2>{{ 'soa.section.implementation_details'|trans({}, 'messages') }}</h2>

    <div class="form-group mt-3">
        <h2 class="fs-1 mb-sm">{{ 'soa.section.implementation_notes'|trans({}, 'messages') }}</h3>
        {% if control.implementationNotes %}
            <div class="info-box bg-light">
                <p class="ws-pre-wrap-lh">{{ control.implementationNotes }}</p>
            </div>
        {% else %}
            <p class="text-muted">
                {{ 'soa.message.no_implementation_notes'|trans({}, 'messages') }}
            </p>
        {% endif %}
    </div>

    <div class="stats-grid mt-3 grid-responsive-250">
        <div class="stat-item">
            <strong>
                {% if control.responsiblePerson %}
                    {{ control.responsiblePerson }}
                {% else %}
                    <span class="text-muted">{{ 'soa.field.unassigned'|trans({}, 'messages') }}</span>
                {% endif %}
            </strong>
            <span>{{ 'soa.field.responsible_person'|trans({}, 'messages') }}</span>
        </div>

        <div class="stat-item">
            <strong>
                {% if control.targetDate %}
                    {{ control.targetDate|date('d.m.Y') }}
                {% else %}
                    <span class="text-muted">{{ 'soa.field.not_set'|trans({}, 'messages') }}</span>
                {% endif %}
            </strong>
            <span>{{ 'soa.field.target_date'|trans({}, 'messages') }}</span>
        </div>
    </div>
</div>
{% endif %}

{# Data Reuse: Protected Assets #}
{% if control.protectedAssets is defined and control.protectedAssets|length > 0 %}
<div class="card mb-4">
    <h2>ğŸ›¡ï¸ {{ 'soa.section.data_reuse_protected_assets'|trans({'%count%': control.protectedAssets|length}, 'messages') }}</h2>
    <div class="alert alert-info mt-2">
        <strong>{{ 'soa.label.control_coverage'|trans({}, 'messages') }}</strong> {{ 'soa.message.control_coverage'|trans({'%count%': control.protectedAssets|length, '%value%': control.protectedAssetValue}, 'messages') }}
        {% if control.highRiskAssetCount > 0 %}
            <br><strong>âš ï¸ {{ control.highRiskAssetCount }}</strong> {{ 'soa.message.high_risk_assets'|trans({}, 'messages') }}
        {% endif %}
    </div>
    <div class="data-reuse-list">
        {% for asset in control.protectedAssets %}
            <div class="data-reuse-item">
                <strong>{{ asset.name }}</strong>
                <span class="badge bg-info">{{ asset.assetType }}</span>
                <small>{{ 'soa.field.cia'|trans({}, 'messages') }}: {{ asset.confidentialityValue }}/{{ asset.integrityValue }}/{{ asset.availabilityValue }}</small>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Data Reuse: Related Risks #}
{% if control.risks is defined and control.risks|length > 0 %}
<div class="card mb-4">
    <h2>âš ï¸ {{ 'soa.section.data_reuse_related_risks'|trans({'%count%': control.risks|length}, 'messages') }}</h2>
    <p class="text-light">{{ 'soa.message.related_risks_info'|trans({}, 'messages') }}</p>
    <div class="data-reuse-list">
        {% for risk in control.risks %}
            <div class="data-reuse-item">
                <strong>{{ risk.title }}</strong>
                <span class="{{ badge_score(risk.inherentRiskLevel, 16, 9) }}">
                    {{ 'soa.field.risk_level'|trans({}, 'messages') }}: {{ risk.inherentRiskLevel }}
                </span>
                <small>{{ 'soa.field.status'|trans({}, 'messages') }}: {{ risk.status|upper }}</small>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Data Reuse: Related Incidents #}
{% if control.incidents is defined and control.incidents|length > 0 %}
<div class="card mb-4">
    <h2>ğŸ“‹ {{ 'soa.section.data_reuse_related_incidents'|trans({'%count%': control.incidents|length}, 'messages') }}</h2>
    <div class="alert alert-warning">
        <strong>âš ï¸ {{ control.incidents|length }} {{ 'soa.label.incidents'|trans({}, 'messages') }}</strong> {{ 'soa.message.related_incidents_count'|trans({}, 'messages') }}
        {% if control.isReviewNeeded %}
            <br><strong>ğŸ‘‰ {{ 'soa.label.review_required'|trans({}, 'messages') }}</strong> {{ 'soa.message.review_required'|trans({}, 'messages') }}
        {% endif %}
    </div>
    <div class="data-reuse-list">
        {% for incident in control.incidents %}
            <div class="data-reuse-item">
                <strong>{{ incident.title }}</strong>
                <span class="{{ badge_severity(incident.severity) }}">
                    {{ incident.severity|upper }}
                </span>
                <small>{{ incident.detectedAt|date('Y-m-d') }}</small>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Data Reuse: Training Coverage #}
{% if control.trainings is defined and control.trainings|length > 0 %}
<div class="card mb-4">
    <h2>ğŸ“ Training Coverage ({{ control.trainings|length }})</h2>
    <div class="alert {{ control.hasTrainingCoverage ? 'alert-success' : 'alert-warning' }}">
        <strong>Status: {{ control.trainingStatus|upper }}</strong>
        {% if not control.hasTrainingCoverage %}
            <br>âš ï¸ Keine abgeschlossenen Trainings fÃ¼r dieses Control.
        {% endif %}
    </div>
    <div class="data-reuse-list">
        {% for training in control.trainings %}
            <div class="data-reuse-item">
                <strong>{{ training.title }}</strong>
                <span class="{{ badge_status(training.status) }}">{{ training.status|upper }}</span>
                {% if training.completionDate %}
                    <small>Abgeschlossen: {{ training.completionDate|date('Y-m-d') }}</small>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Control Effectiveness Score #}
{% if control.applicable and control.implementationPercentage == 100 %}
<div class="card mb-4">
    <h2>ğŸ“Š Control Effectiveness</h2>
    <div class="stats-grid grid-responsive-200">
        <div class="stat-item">
            <strong style="font-size: 2rem; color: {{ control.effectivenessScore >= 80 ? 'var(--color-success)' : (control.effectivenessScore >= 50 ? 'var(--color-warning)' : 'var(--color-danger)') }}">
                {{ control.effectivenessScore|number_format(1) }}%
            </strong>
            <span>Effectiveness Score</span>
        </div>
    </div>
    <p class="text-light-mt-sm">
        Basierend auf Incident-Analyse nach Control-Implementierung.
    </p>
</div>
{% endif %}

{# Metadata #}
<div class="card">
    <h2>{{ 'soa.section.metadata'|trans({}, 'messages') }}</h2>
    <div class="stats-grid mt-2 grid-responsive-250">
        <div class="stat-item">
            <strong>{{ control.createdAt|date('d.m.Y H:i') }}</strong>
            <span>{{ 'soa.field.created_at'|trans({}, 'messages') }}</span>
        </div>

        <div class="stat-item">
            <strong>{{ control.updatedAt|date('d.m.Y H:i') }}</strong>
            <span>{{ 'soa.field.updated_at'|trans({}, 'messages') }}</span>
        </div>

        {% if control.lastReviewDate %}
        <div class="stat-item">
            <strong>{{ control.lastReviewDate|date('d.m.Y') }}</strong>
            <span>{{ 'soa.field.last_review'|trans({}, 'messages') }}</span>
        </div>
        {% endif %}

        {% if control.nextReviewDate %}
        <div class="stat-item">
            <strong>{{ control.nextReviewDate|date('d.m.Y') }}</strong>
            <span>{{ 'soa.field.next_review'|trans({}, 'messages') }}</span>
        </div>
        {% endif %}
    </div>
</div>

{# Action Buttons #}
<div class="d-flex gap-2 mt-4">
    <a href="{{ path('app_soa_edit', {id: control.id}) }}" class="btn btn-success">
        âœï¸ {{ 'soa.action.edit'|trans({}, 'messages') }}
    </a>
    <a href="{{ path('app_soa_index') }}" class="btn btn-secondary">
        ğŸ“‹ {{ 'common.back_to_list'|trans({}, 'messages') }}
    </a>
</div>

<style>
/* Data Reuse Sections */
.data-reuse-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
}
.data-reuse-item {
    padding: 0.75rem;
    background: var(--color-bg-light, #f9fafb);
    border-left: 3px solid var(--color-primary, #3b82f6);
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}
.alert {
    padding: 1rem;
    border-radius: 4px;
    margin: 1rem 0;
}
.alert-info {
    background: #dbeafe;
    border-left: 4px solid #3b82f6;
    color: #1e40af;
}
.alert-warning {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    color: #92400e;
}
.alert-success {
    background: #d1fae5;
    border-left: 4px solid #10b981;
    color: #065f46;
}
.badge-risk-high {
    background: #ef4444;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-risk-medium {
    background: #f59e0b;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-risk-low {
    background: #10b981;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-severity-critical {
    background: #7f1d1d;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-severity-high {
    background: #ef4444;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-severity-medium {
    background: #f59e0b;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-severity-low {
    background: #10b981;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
</style>
{% endblock %}
