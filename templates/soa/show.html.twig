{% extends 'base.html.twig' %}

{% block title %}{{ control.controlId }} - {{ control.name }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>{{ control.controlId }}: {{ control.name }}</h1>
        <div class="mt-2">
            <span class="badge badge-info">{{ control.category }}</span>
        </div>
    </div>
    <div class="button-group">
        <a href="{{ path('app_soa_edit', {id: control.id}) }}" class="btn btn-primary">
            ‚úèÔ∏è Bearbeiten
        </a>
        <a href="{{ path('app_soa_by_category', {category: control.category}) }}" class="btn btn-secondary">
            ‚Üê Zur√ºck zu {{ control.category }}
        </a>
    </div>
</div>

{# Control Description #}
<div class="card mb-4">
    <h2>Beschreibung</h2>
    <p style="color: var(--color-text-light); margin-top: var(--spacing-sm); line-height: 1.6;">
        {{ control.description }}
    </p>
</div>

{# Applicability Status #}
<div class="card mb-4">
    <h2>Anwendbarkeitsstatus</h2>
    <div class="stats-grid mt-2" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div class="stat-item">
            <strong style="font-size: 1.5rem;">
                {% if control.applicable %}
                    <span class="badge badge-success" style="font-size: 1.2rem;">‚úì Anwendbar</span>
                {% else %}
                    <span class="badge" style="background: #f0f0f0; color: #666; font-size: 1.2rem;">‚úó Nicht anwendbar</span>
                {% endif %}
            </strong>
            <span>Status</span>
        </div>

        {% if control.applicable %}
        <div class="stat-item">
            <strong style="font-size: 1.5rem;">
                {% if control.implementationStatus == 'implemented' %}
                    <span class="badge badge-success" style="font-size: 1.2rem;">‚úÖ Implementiert</span>
                {% elseif control.implementationStatus == 'in_progress' %}
                    <span class="badge badge-warning" style="font-size: 1.2rem;">üîÑ In Arbeit</span>
                {% elseif control.implementationStatus == 'not_started' %}
                    <span class="badge badge-danger" style="font-size: 1.2rem;">‚è∏ Nicht begonnen</span>
                {% else %}
                    <span class="badge" style="background: #f0f0f0; color: #666; font-size: 1.2rem;">N/A</span>
                {% endif %}
            </strong>
            <span>Implementierungsstatus</span>
        </div>

        <div class="stat-item">
            <strong style="font-size: 1.5rem;">{{ control.implementationPercentage }}%</strong>
            <span>Implementierungsgrad</span>
        </div>
        {% endif %}
    </div>

    {% if control.applicable %}
    <div class="progress mt-3" style="height: 30px;">
        <div class="progress-bar" style="width: {{ control.implementationPercentage }}%; font-size: 1rem;">
            {{ control.implementationPercentage }}%
        </div>
    </div>
    {% endif %}
</div>

{# Justification #}
<div class="card mb-4">
    <h2>Begr√ºndung</h2>
    {% if control.justification %}
        <div class="info-box mt-2" style="background: var(--color-bg-light);">
            <p style="white-space: pre-wrap; line-height: 1.6;">{{ control.justification }}</p>
        </div>
    {% else %}
        <p style="color: var(--color-text-muted); margin-top: var(--spacing-sm);">
            Keine Begr√ºndung angegeben.
        </p>
    {% endif %}
</div>

{% if control.applicable %}
{# Implementation Details #}
<div class="card mb-4">
    <h2>Implementierungsdetails</h2>

    <div class="form-group mt-3">
        <h3 style="font-size: 1rem; margin-bottom: var(--spacing-sm);">Implementierungsnotizen</h3>
        {% if control.implementationNotes %}
            <div class="info-box" style="background: var(--color-bg-light);">
                <p style="white-space: pre-wrap; line-height: 1.6;">{{ control.implementationNotes }}</p>
            </div>
        {% else %}
            <p style="color: var(--color-text-muted);">
                Keine Implementierungsnotizen vorhanden.
            </p>
        {% endif %}
    </div>

    <div class="stats-grid mt-3" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
        <div class="stat-item">
            <strong>
                {% if control.responsiblePerson %}
                    {{ control.responsiblePerson }}
                {% else %}
                    <span style="color: var(--color-text-muted);">Nicht zugewiesen</span>
                {% endif %}
            </strong>
            <span>Verantwortliche Person</span>
        </div>

        <div class="stat-item">
            <strong>
                {% if control.targetDate %}
                    {{ control.targetDate|date('d.m.Y') }}
                {% else %}
                    <span style="color: var(--color-text-muted);">Nicht festgelegt</span>
                {% endif %}
            </strong>
            <span>Zieldatum</span>
        </div>
    </div>
</div>
{% endif %}

{# Data Reuse: Protected Assets #}
{% if control.protectedAssets is defined and control.protectedAssets|length > 0 %}
<div class="card mb-4">
    <h2>üõ°Ô∏è Gesch√ºtzte Assets ({{ control.protectedAssets|length }})</h2>
    <div class="alert alert-info mt-2">
        <strong>Control Coverage:</strong> Dieses Control sch√ºtzt {{ control.protectedAssets|length }} Asset(s) mit Gesamtwert {{ control.protectedAssetValue }}.
        {% if control.highRiskAssetCount > 0 %}
            <br><strong>‚ö†Ô∏è {{ control.highRiskAssetCount }}</strong> davon sind High-Risk Assets.
        {% endif %}
    </div>
    <div class="data-reuse-list">
        {% for asset in control.protectedAssets %}
            <div class="data-reuse-item">
                <strong>{{ asset.name }}</strong>
                <span class="badge badge-info">{{ asset.assetType }}</span>
                <small>CIA: {{ asset.confidentialityValue }}/{{ asset.integrityValue }}/{{ asset.availabilityValue }}</small>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Data Reuse: Related Risks #}
{% if control.risks is defined and control.risks|length > 0 %}
<div class="card mb-4">
    <h2>‚ö†Ô∏è Mitigierte Risks ({{ control.risks|length }})</h2>
    <p style="color: var(--color-text-light);">Dieses Control tr√§gt zur Behandlung folgender Risks bei:</p>
    <div class="data-reuse-list">
        {% for risk in control.risks %}
            <div class="data-reuse-item">
                <strong>{{ risk.title }}</strong>
                <span class="badge badge-risk-{{ risk.inherentRiskLevel >= 16 ? 'high' : (risk.inherentRiskLevel >= 9 ? 'medium' : 'low') }}">
                    Risk Level: {{ risk.inherentRiskLevel }}
                </span>
                <small>Status: {{ risk.status|upper }}</small>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Data Reuse: Related Incidents #}
{% if control.incidents is defined and control.incidents|length > 0 %}
<div class="card mb-4">
    <h2>üìã Related Incidents ({{ control.incidents|length }})</h2>
    <div class="alert alert-warning">
        <strong>‚ö†Ô∏è {{ control.incidents|length }} Incident(s)</strong> stehen in Beziehung zu diesem Control.
        {% if control.isReviewNeeded %}
            <br><strong>üëâ Review erforderlich:</strong> Bitte Control-Effektivit√§t √ºberpr√ºfen.
        {% endif %}
    </div>
    <div class="data-reuse-list">
        {% for incident in control.incidents %}
            <div class="data-reuse-item">
                <strong>{{ incident.title }}</strong>
                <span class="badge badge-severity-{{ incident.severity }}">
                    {{ incident.severity|upper }}
                </span>
                <small>{{ incident.detectedAt|date('Y-m-d') }}</small>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Data Reuse: Training Coverage #}
{% if control.trainings is defined and control.trainings|length > 0 %}
<div class="card mb-4">
    <h2>üéì Training Coverage ({{ control.trainings|length }})</h2>
    <div class="alert {{ control.hasTrainingCoverage ? 'alert-success' : 'alert-warning' }}">
        <strong>Status: {{ control.trainingStatus|upper }}</strong>
        {% if not control.hasTrainingCoverage %}
            <br>‚ö†Ô∏è Keine abgeschlossenen Trainings f√ºr dieses Control.
        {% endif %}
    </div>
    <div class="data-reuse-list">
        {% for training in control.trainings %}
            <div class="data-reuse-item">
                <strong>{{ training.title }}</strong>
                <span class="badge badge-{{ training.status }}">{{ training.status|upper }}</span>
                {% if training.completionDate %}
                    <small>Abgeschlossen: {{ training.completionDate|date('Y-m-d') }}</small>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# Control Effectiveness Score #}
{% if control.applicable and control.implementationPercentage == 100 %}
<div class="card mb-4">
    <h2>üìä Control Effectiveness</h2>
    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div class="stat-item">
            <strong style="font-size: 2rem; color: {{ control.effectivenessScore >= 80 ? 'var(--color-success)' : (control.effectivenessScore >= 50 ? 'var(--color-warning)' : 'var(--color-danger)') }}">
                {{ control.effectivenessScore|number_format(1) }}%
            </strong>
            <span>Effectiveness Score</span>
        </div>
    </div>
    <p style="color: var(--color-text-light); margin-top: var(--spacing-sm);">
        Basierend auf Incident-Analyse nach Control-Implementierung.
    </p>
</div>
{% endif %}

{# Metadata #}
<div class="card">
    <h2>Metadaten</h2>
    <div class="stats-grid mt-2" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
        <div class="stat-item">
            <strong>{{ control.createdAt|date('d.m.Y H:i') }}</strong>
            <span>Erstellt am</span>
        </div>

        <div class="stat-item">
            <strong>{{ control.updatedAt|date('d.m.Y H:i') }}</strong>
            <span>Zuletzt aktualisiert</span>
        </div>

        {% if control.lastReviewDate %}
        <div class="stat-item">
            <strong>{{ control.lastReviewDate|date('d.m.Y') }}</strong>
            <span>Letztes Review</span>
        </div>
        {% endif %}

        {% if control.nextReviewDate %}
        <div class="stat-item">
            <strong>{{ control.nextReviewDate|date('d.m.Y') }}</strong>
            <span>N√§chstes Review</span>
        </div>
        {% endif %}
    </div>
</div>

{# Action Buttons #}
<div class="d-flex gap-2 mt-4">
    <a href="{{ path('app_soa_edit', {id: control.id}) }}" class="btn btn-success">
        ‚úèÔ∏è Control bearbeiten
    </a>
    <a href="{{ path('app_soa_index') }}" class="btn btn-secondary">
        üìã Zur √úbersicht
    </a>
</div>

<style>
/* Data Reuse Sections */
.data-reuse-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
}
.data-reuse-item {
    padding: 0.75rem;
    background: var(--color-bg-light, #f9fafb);
    border-left: 3px solid var(--color-primary, #3b82f6);
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}
.alert {
    padding: 1rem;
    border-radius: 4px;
    margin: 1rem 0;
}
.alert-info {
    background: #dbeafe;
    border-left: 4px solid #3b82f6;
    color: #1e40af;
}
.alert-warning {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    color: #92400e;
}
.alert-success {
    background: #d1fae5;
    border-left: 4px solid #10b981;
    color: #065f46;
}
.badge-risk-high {
    background: #ef4444;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-risk-medium {
    background: #f59e0b;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-risk-low {
    background: #10b981;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-severity-critical {
    background: #7f1d1d;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-severity-high {
    background: #ef4444;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-severity-medium {
    background: #f59e0b;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.badge-severity-low {
    background: #10b981;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
</style>
{% endblock %}
