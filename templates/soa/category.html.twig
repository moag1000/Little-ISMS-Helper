{% extends 'base.html.twig' %}
{% trans_default_domain 'soa' %}
{% import '_macros/cards.html.twig' as cards %}

{% block title %}{{ category }} Controls - Statement of Applicability - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>{{ category }} Controls</h1>
        <p class="text-muted">ISO/IEC 27001:2022 Annex A - {{ category }} Kontrollen</p>
    </div>
    <div class="button-group">
        <a href="{{ path('app_soa_index') }}" class="btn btn-secondary">‚Üê Zur√ºck zur √úbersicht</a>
    </div>
</div>

{# Statistics Cards #}
<div class="kpi-grid kpi-grid-responsive">
    <div class="col-auto">
        {{ cards.kpi_card('Gesamt Controls', controls|length, null, null, 'primary', null) }}
    </div>
    <div class="col-auto">
        {{ cards.kpi_card('Anwendbar', controls|filter(c => c.applicable)|length, null, null, 'success', null) }}
    </div>
    <div class="col-auto">
        {% set implemented = controls|filter(c => c.applicable and c.implementationStatus == 'implemented')|length %}
        {% set applicable = controls|filter(c => c.applicable)|length %}
        {{ cards.kpi_card('Implementiert', implemented, 'von ' ~ applicable, null, 'info', null) }}
    </div>
    <div class="col-auto">
        {% set applicable = controls|filter(c => c.applicable)|length %}
        {% set implemented = controls|filter(c => c.applicable and c.implementationStatus == 'implemented')|length %}
        {% set percentage = applicable > 0 ? (implemented / applicable * 100)|round : 0 %}
        {{ cards.kpi_card('Compliance-Rate', percentage ~ '%', null, percentage, 'warning', null) }}
    </div>
</div>

{# Controls Table #}
<h2>Controls</h2>

{% embed '_components/_table.html.twig' with {'class': 'table-container', 'noMargin': true} %}
    {% block table_head %}
        <tr>
            <th scope="col">Control ID</th>
            <th scope="col">Name</th>
            <th scope="col" class="text-center">Anwendbar</th>
            <th scope="col">Implementierungsstatus</th>
            <th scope="col" class="text-center">Fortschritt</th>
            <th scope="col">Verantwortlich</th>
            <th scope="col" class="text-center">Aktionen</th>
        </tr>
    {% endblock %}
    {% block table_body %}
        {% for control in controls %}
        <tr>
            <td><strong>{{ control.controlId }}</strong></td>
            <td>
                {{ control.name }}
                <br>
                <small class="text-muted">{{ control.description|slice(0, 100) }}{% if control.description|length > 100 %}...{% endif %}</small>
            </td>
            <td class="text-center">
                {% if control.applicable %}
                    <span class="badge bg-success">‚úì Ja</span>
                {% else %}
                    <span class="badge badge-neutral">‚úó Nein</span>
                {% endif %}
            </td>
            <td>
                {% if control.applicable %}
                    {% if control.implementationStatus == 'implemented' %}
                        <span class="badge bg-success"<><i class="bi bi-check-circle" aria-hidden="true"></i> Implementiert</span>
                    {% elseif control.implementationStatus == 'in_progress' %}
                        <span class="badge bg-warning">{{ 'soa.in_progress_badge_emoji'|trans({}, 'soa') }}</span>
                    {% elseif control.implementationStatus == 'not_started' %}
                        <span class="badge bg-danger"><i class="bi bi-pause-circle" aria-hidden="true"></i> Nicht begonnen</span>
                    {% else %}
                        <span class="badge badge-neutral">N/A</span>
                    {% endif %}
                {% else %}
                    <span class="badge badge-neutral">Nicht anwendbar</span>
                {% endif %}
            </td>
            <td>
                {% if control.applicable %}
                    <div class="progress progress-compact">
                        <div class="progress-bar" style="width: {{ control.implementationPercentage }}%; font-size: 0.75rem;">
                            {{ control.implementationPercentage }}%
                        </div>
                    </div>
                {% else %}
                    <span class="text-center-block-light">-</span>
                {% endif %}
            </td>
            <td>
                {% if control.responsiblePerson %}
                    {{ control.responsiblePerson }}
                {% else %}
                    <span class="text-muted">Nicht zugewiesen</span>
                {% endif %}
            </td>
            <td class="text-center">
                <a href="{{ path('app_soa_show', {id: control.id}) }}" class="btn btn-sm mr-025">üëÅ Details</a>
                <a href="{{ path('app_soa_edit', {id: control.id}) }}" class="btn btn-sm btn-secondary"<i class="bi bi-pencil" aria-hidden="true"></i> Bearbeiten</a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="7" class="text-center-p-xl-muted">
                Keine Controls in dieser Kategorie gefunden.
            </td>
        </tr>
        {% endfor %}
    {% endblock %}
{% endembed %}
{% endblock %}
