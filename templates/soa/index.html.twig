{% extends 'base.html.twig' %}
{% import '_macros/inheritance_badge.html.twig' as inheritance %}

{% block title %}Statement of Applicability - Little ISMS Helper{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* Sticky table header with better visibility */
        .table thead.sticky-top {
            position: sticky;
            top: 60px; /* Adjust based on your navbar height */
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table thead.sticky-top th {
            background-color: #f8f9fa !important;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            padding: 12px 8px;
            white-space: nowrap;
        }

        /* Better table container */
        .table-container {
            position: relative;
            max-height: 800px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        /* Improve readability */
        .table tbody tr:hover {
            background-color: #f1f3f5;
        }
    </style>
{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>Statement of Applicability (SoA)</h1>
        <p class="text-muted">ISO/IEC 27001:2022 Annex A Controls - √úbersicht und Anwendbarkeitserkl√§rung</p>
    </div>
    <div class="button-group">
        <a href="{{ path('app_soa_export') }}" class="btn btn-outline-success" data-turbo="false" title="{{ 'soa.export.html'|trans }}">
            <i class="bi bi-file-earmark-text"></i> HTML
        </a>
        <a href="{{ path('app_soa_export_pdf') }}" class="btn btn-success" data-turbo="false" title="{{ 'soa.export.pdf'|trans }}">
            <i class="bi bi-file-earmark-pdf"></i> PDF Export
        </a>
        <a href="{{ path('app_soa_preview_pdf') }}" class="btn btn-outline-primary" title="{{ 'soa.preview.pdf'|trans }}" target="_blank">
            <i class="bi bi-eye"></i> Vorschau
        </a>
    </div>
</div>

{# View Filter #}
{% if currentTenant %}
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="get" action="{{ path('app_soa_index') }}" class="d-flex align-items-center gap-2">
            <label for="view-filter" class="mb-0 fw-bold">
                <i class="bi bi-eye"></i> {{ 'common.view'|trans }}:
            </label>
            <select class="form-select form-select-sm" style="width: auto;" id="view-filter" name="view" onchange="this.form.submit()">
                <option value="own" {{ inheritanceInfo.currentView == 'own' ? 'selected' : '' }}>
                    {{ 'corporate.view.own_only'|trans }}
                </option>
                {% if inheritanceInfo.hasParent %}
                <option value="inherited" {{ inheritanceInfo.currentView == 'inherited' ? 'selected' : '' }}>
                    {{ 'corporate.view.including_inherited'|trans }}
                </option>
                {% endif %}
                {% if inheritanceInfo.hasSubsidiaries %}
                <option value="subsidiaries" {{ inheritanceInfo.currentView == 'subsidiaries' ? 'selected' : '' }}>
                    {{ 'corporate.view.including_subsidiaries'|trans }}
                </option>
                {% endif %}
            </select>
            <noscript>
                <button type="submit" class="btn btn-sm btn-secondary">{{ 'common.apply'|trans }}</button>
            </noscript>
        </form>
    </div>
</div>
{% endif %}

{# KPI Cards #}
<div class="kpi-grid">
    <div class="kpi-card">
        <div class="icon">üìã</div>
        <div class="label">Gesamt Controls</div>
        <div>
            <span class="value">{{ detailedStats.total }}</span>
            {% if currentTenant %}
                <div style="font-size: 11px; color: #6c757d; opacity: 0.85; margin-top: 0.5rem;">
                    {{ 'corporate.stats.breakdown'|trans({'%own%': detailedStats.own, '%inherited%': detailedStats.inherited, '%subsidiaries%': detailedStats.subsidiaries}) }}
                </div>
            {% endif %}
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">‚úÖ</div>
        <div class="label">Anwendbare Controls</div>
        <div>
            <span class="value">{{ controls|filter(c => c.applicable)|length }}</span>
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">üöÄ</div>
        <div class="label">Implementierte Controls</div>
        <div>
            {% set implemented = controls|filter(c => c.applicable and c.implementationStatus == 'implemented')|length %}
            {% set applicable = controls|filter(c => c.applicable)|length %}
            <span class="value">{{ implemented }}</span>
            <span class="unit">von {{ applicable }}</span>
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">üìà</div>
        <div class="label">Compliance-Rate</div>
        <div>
            {% set applicable = controls|filter(c => c.applicable)|length %}
            {% set implemented = controls|filter(c => c.applicable and c.implementationStatus == 'implemented')|length %}
            {% set percentage = applicable > 0 ? (implemented / applicable * 100)|round : 0 %}
            <span class="value">{{ percentage }}</span>
            <span class="unit">%</span>
        </div>
    </div>
</div>

{# Category Overview #}
<h2>Nach Kategorie</h2>

<div class="module-grid">
    {% set categories = {
        'Organizational': 'üè¢',
        'People': 'üë•',
        'Physical': 'üè†',
        'Technological': 'üíª'
    } %}

    {% for category, icon in categories %}
        {% set cat_controls = controls|filter(c => c.category == category) %}
        {% set applicable_controls = cat_controls|filter(c => c.applicable) %}
        {% set implemented_controls = applicable_controls|filter(c => c.implementationStatus == 'implemented') %}

        <div class="card">
            <div class="fs-2-mb-sm">{{ icon }}</div>
            <h3>{{ category }} Controls</h3>
            <div class="stats-grid mt-2">
                <div class="stat-item">
                    <strong>{{ cat_controls|length }}</strong>
                    <span>Gesamt</span>
                </div>
                <div class="stat-item">
                    <strong>{{ applicable_controls|length }}</strong>
                    <span>Anwendbar</span>
                </div>
                <div class="stat-item">
                    <strong>{{ implemented_controls|length }}</strong>
                    <span>Implementiert</span>
                </div>
            </div>

            {% set impl_percentage = applicable_controls|length > 0 ? (implemented_controls|length / applicable_controls|length * 100)|round : 0 %}
            <div class="progress mt-2">
                <div class="progress-bar" style="width: {{ impl_percentage }}%">
                    {{ impl_percentage }}%
                </div>
            </div>

            <div class="mt-2">
                <a href="{{ path('app_soa_by_category', {category: category}) }}" class="btn btn-sm">Details anzeigen</a>
            </div>
        </div>
    {% endfor %}
</div>

{# Filter and Table #}
<h2>Alle Controls</h2>

<div class="filter-panel" data-controller="filter">
    <div class="filter-controls">
        <div class="filter-control">
            <label for="search">Suche</label>
            <div class="search-box">
                <input
                    type="text"
                    id="search"
                    placeholder="Control ID, Name oder Beschreibung durchsuchen..."
                    data-filter-target="searchInput"
                    data-action="input->filter#filterRows"
                >
            </div>
        </div>

        <div class="filter-control">
            <label for="category-filter">Kategorie</label>
            <select id="category-filter" class="form-control" data-action="change->filter#filterByCategory">
                <option value="">Alle Kategorien</option>
                <option value="Organizational">Organizational</option>
                <option value="People">People</option>
                <option value="Physical">Physical</option>
                <option value="Technological">Technological</option>
            </select>
        </div>

        <div class="filter-control">
            <label for="status-filter">Status</label>
            <select id="status-filter" class="form-control" data-action="change->filter#filterByStatus">
                <option value="">Alle Status</option>
                <option value="implemented">Implementiert</option>
                <option value="in_progress">In Arbeit</option>
                <option value="not_started">Nicht begonnen</option>
                <option value="not_applicable">Nicht anwendbar</option>
            </select>
        </div>

        <div class="filter-control justify-end">
            <button type="button" class="btn btn-secondary" data-action="click->filter#reset">
                üîÑ Filter zur√ºcksetzen
            </button>
        </div>
    </div>
</div>

<div class="table-container">
    <table class="table table-hover">
        <thead class="table-light sticky-top">
            <tr>
                <th scope="col" style="min-width: 100px;">Control ID</th>
                <th scope="col" style="min-width: 250px;">Name</th>
                <th scope="col" style="min-width: 120px;">Kategorie</th>
                <th scope="col" class="text-center" style="min-width: 100px;">Anwendbar</th>
                <th scope="col" style="min-width: 150px;">Implementierungsstatus</th>
                <th scope="col" class="text-center" style="min-width: 120px;">Fortschritt</th>
                <th scope="col" class="text-center" style="min-width: 180px;">Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for control in controls %}
            <tr data-filter-target="filterableRow" data-category="{{ control.category }}" data-status="{{ control.implementationStatus }}">
                <td><strong>{{ control.controlId }}</strong></td>
                <td>
                    {{ control.name }}
                    {{ inheritance.small_badge(control, currentTenant) }}
                </td>
                <td>
                    <span class="badge badge-info">{{ control.category }}</span>
                </td>
                <td class="text-center">
                    {% if control.applicable %}
                        <span class="badge badge-success">‚úì Ja</span>
                    {% else %}
                        <span class="badge badge-neutral">‚úó Nein</span>
                    {% endif %}
                </td>
                <td>
                    {% if control.applicable %}
                        {% if control.implementationStatus == 'implemented' %}
                            <span class="badge badge-success">‚úÖ Implementiert</span>
                        {% elseif control.implementationStatus == 'in_progress' %}
                            <span class="badge badge-warning">üîÑ In Arbeit</span>
                        {% elseif control.implementationStatus == 'not_started' %}
                            <span class="badge badge-danger">‚è∏ Nicht begonnen</span>
                        {% else %}
                            <span class="badge badge-neutral">N/A</span>
                        {% endif %}
                    {% else %}
                        <span class="badge badge-neutral">Nicht anwendbar</span>
                    {% endif %}
                </td>
                <td>
                    {% if control.applicable %}
                        <div class="progress progress-compact">
                            <div class="progress-bar" style="width: {{ control.implementationPercentage }}%; font-size: 0.75rem;">
                                {{ control.implementationPercentage }}%
                            </div>
                        </div>
                    {% else %}
                        <span class="text-center-block-light">-</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <a href="{{ path('app_soa_show', {id: control.id}) }}" class="btn btn-sm mr-025">üëÅ Details</a>
                    <a href="{{ path('app_soa_edit', {id: control.id}) }}" class="btn btn-sm btn-secondary">‚úèÔ∏è Bearbeiten</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div data-filter-target="noResults" class="hidden text-center-p-xl-muted">
        <p>Keine Controls gefunden, die den Filterkriterien entsprechen.</p>
    </div>
</div>
{% endblock %}
