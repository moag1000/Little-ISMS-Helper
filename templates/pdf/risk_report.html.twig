<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Risk Management Report</title>
    <style>
        @page {
            margin: 2cm 1.5cm;
        }

        body {
            font-family: DejaVu Sans, sans-serif;
            font-size: 9pt;
            line-height: 1.4;
            color: #333;
        }

        h1 {
            font-size: 18pt;
            color: #1a56db;
            text-align: center;
            margin-bottom: 5pt;
            border-bottom: 3px solid #1a56db;
            padding-bottom: 10pt;
        }

        h2 {
            font-size: 14pt;
            color: #1a56db;
            margin-top: 15pt;
            margin-bottom: 8pt;
            border-bottom: 1px solid #cbd5e1;
            padding-bottom: 5pt;
        }

        h3 {
            font-size: 11pt;
            color: #334155;
            margin-top: 12pt;
            margin-bottom: 6pt;
            font-weight: bold;
        }

        .header-info {
            text-align: center;
            font-size: 9pt;
            color: #64748b;
            margin-bottom: 20pt;
        }

        .stats-grid {
            display: table;
            width: 100%;
            margin-bottom: 20pt;
            border: 1px solid #cbd5e1;
            border-collapse: collapse;
        }

        .stats-row {
            display: table-row;
        }

        .stats-cell {
            display: table-cell;
            padding: 10pt;
            text-align: center;
            border: 1px solid #cbd5e1;
            width: 20%;
        }

        .stats-label {
            font-size: 8pt;
            color: #64748b;
            font-weight: bold;
            margin-bottom: 4pt;
        }

        .stats-value {
            font-size: 16pt;
            color: #1a56db;
            font-weight: bold;
        }

        .stats-value-critical {
            color: #ef4444;
        }

        .stats-value-high {
            color: #f59e0b;
        }

        .stats-value-medium {
            color: #fbbf24;
        }

        .stats-value-low {
            color: #10b981;
        }

        .insight-box {
            background: #f8fafc;
            border-left: 4pt solid #1a56db;
            padding: 10pt;
            margin: 10pt 0;
            font-size: 8pt;
            color: #475569;
        }

        .filter-info-box {
            background: #e0f2fe;
            border-left: 4pt solid #0ea5e9;
            padding: 8pt;
            margin: 10pt 0;
            font-size: 8pt;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10pt 0;
            font-size: 8pt;
        }

        table th {
            background-color: #1a56db;
            color: white;
            padding: 6pt;
            text-align: left;
            font-weight: bold;
            border: 1px solid #1e3a8a;
        }

        table td {
            padding: 5pt;
            border: 1px solid #cbd5e1;
            vertical-align: top;
        }

        table tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .badge {
            display: inline-block;
            padding: 2pt 6pt;
            border-radius: 3pt;
            font-size: 7pt;
            font-weight: bold;
        }

        .badge-critical {
            background-color: #ef4444;
            color: white;
        }

        .badge-high {
            background-color: #f59e0b;
            color: white;
        }

        .badge-medium {
            background-color: #fbbf24;
            color: white;
        }

        .badge-low {
            background-color: #10b981;
            color: white;
        }

        .badge-info {
            background-color: #3b82f6;
            color: white;
        }

        .badge-success {
            background-color: #10b981;
            color: white;
        }

        .badge-warning {
            background-color: #f59e0b;
            color: white;
        }

        .badge-secondary {
            background-color: #6b7280;
            color: white;
        }

        .page-break {
            page-break-before: always;
        }

        .text-center {
            text-align: center;
        }

        .no-break {
            page-break-inside: avoid;
        }

        .mt-2 {
            margin-top: 15pt;
        }

        .w-6 { width: 6%; }
        .w-8 { width: 8%; }
        .w-10 { width: 10%; }
        .w-12 { width: 12%; }
        .w-15 { width: 15%; }
        .w-22 { width: 22%; }
        .w-25 { width: 25%; }
        .w-30 { width: 30%; }
        .w-60 { width: 60%; }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30pt;
            text-align: center;
            font-size: 7pt;
            color: #64748b;
            border-top: 1px solid #cbd5e1;
            padding-top: 5pt;
        }
    </style>
</head>
<body>
    <h1>Risk Management Report</h1>
    <div class="header-info">
        Risk Overview and Analysis<br>
        Generated: {{ pdf_generation_date|date('d.m.Y H:i') }}
    </div>

    {# Executive Summary #}
    <h2>Executive Summary</h2>
    <div class="stats-grid">
        <div class="stats-row">
            <div class="stats-cell">
                <div class="stats-label">Total Risks</div>
                <div class="stats-value">{{ total_risks }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Critical Risks</div>
                <div class="stats-value stats-value-critical">{{ critical_risks }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">High Risks</div>
                <div class="stats-value stats-value-high">{{ high_risks }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Medium Risks</div>
                <div class="stats-value stats-value-medium">{{ medium_risks }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Low Risks</div>
                <div class="stats-value stats-value-low">{{ low_risks }}</div>
            </div>
        </div>
    </div>

    {% if filter_info %}
    <div class="filter-info-box">
        <strong>Applied Filters:</strong> {{ filter_info }}
    </div>
    {% endif %}

    {# Risk Assessment Insight #}
    {% set high_priority_count = critical_risks + high_risks %}
    {% if high_priority_count > 0 %}
    <div class="insight-box" style="border-left-color: #ef4444; background: #fef2f2;">
        <strong>Priority Action Required:</strong> {{ high_priority_count }} high-priority risks (critical + high) identified that require immediate attention and treatment planning.
    </div>
    {% else %}
    <div class="insight-box" style="border-left-color: #10b981; background: #f0fdf4;">
        <strong>Status:</strong> No critical or high-priority risks identified. Continue monitoring medium and low risks for changes.
    </div>
    {% endif %}

    {# Critical and High Risks Table #}
    {# ISO 27001 compliant threshold: High >= 12 #}
    {% set critical_and_high = risks|filter(r => r.riskScore >= 12) %}
    {% if critical_and_high|length > 0 %}
    <h2>Critical & High Risks (Top Priority)</h2>
    <div class="insight-box">
        These {{ critical_and_high|length }} risks require immediate attention and treatment. Focus on mitigation strategies and assign clear ownership.
    </div>

    <table>
        <thead>
            <tr>
                <th scope="col" class="w-8">ID</th>
                <th scope="col" class="w-25">Title</th>
                <th scope="col" class="w-15">Asset</th>
                <th scope="col" class="w-10 text-center">Score</th>
                <th scope="col" class="w-12">Level</th>
                <th scope="col" class="w-15">Treatment</th>
                <th scope="col" class="w-15">Owner</th>
            </tr>
        </thead>
        <tbody>
            {% for risk in critical_and_high %}
            <tr class="no-break">
                <td><strong>{{ risk.id }}</strong></td>
                <td><strong>{{ risk.title }}</strong></td>
                <td>{{ risk.asset ? risk.asset.name : '-' }}</td>
                <td class="text-center"><strong style="font-size: 9pt;">{{ risk.riskScore }}</strong></td>
                <td>
                    {% if risk.riskScore >= 20 %}
                        <span class="badge badge-critical">Critical</span>
                    {% elseif risk.riskScore >= 12 %}
                        <span class="badge badge-high">High</span>
                    {% endif %}
                </td>
                <td>
                    {% if risk.treatmentStrategy %}
                        <span class="badge bg-info">
                            {% if risk.treatmentStrategy == 'mitigate' %}Mitigate
                            {% elseif risk.treatmentStrategy == 'accept' %}Accept
                            {% elseif risk.treatmentStrategy == 'transfer' %}Transfer
                            {% elseif risk.treatmentStrategy == 'avoid' %}Avoid
                            {% else %}{{ risk.treatmentStrategy }}
                            {% endif %}
                        </span>
                    {% else %}
                        <span style="color: #94a3b8;">Not defined</span>
                    {% endif %}
                </td>
                <td>{{ risk.owner ? risk.owner.name : '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {# Page break before all risks #}
    {% if critical_and_high|length > 0 and risks|length > critical_and_high|length %}
    <div class="page-break"></div>
    {% endif %}

    {# All Risks Table #}
    <h2>All Risks (Detailed View)</h2>
    <table>
        <thead>
            <tr>
                <th scope="col" class="w-6">ID</th>
                <th scope="col" class="w-22">Title</th>
                <th scope="col" class="w-12">Asset</th>
                <th scope="col" class="w-6 text-center">L</th>
                <th scope="col" class="w-6 text-center">I</th>
                <th scope="col" class="w-8 text-center">Score</th>
                <th scope="col" class="w-10">Level</th>
                <th scope="col" class="w-10">Treatment</th>
                <th scope="col" class="w-10">Status</th>
                <th scope="col" class="w-10">Owner</th>
            </tr>
        </thead>
        <tbody>
            {% for risk in risks %}
            <tr class="no-break">
                <td><strong>{{ risk.id }}</strong></td>
                <td>{{ risk.title }}</td>
                <td>{{ risk.asset ? risk.asset.name : '-' }}</td>
                <td class="text-center">{{ risk.probability ?? '-' }}</td>
                <td class="text-center">{{ risk.impact ?? '-' }}</td>
                <td class="text-center"><strong>{{ risk.riskScore }}</strong></td>
                <td>
                    {% if risk.riskScore >= 20 %}
                        <span class="badge badge-critical">Critical</span>
                    {% elseif risk.riskScore >= 12 %}
                        <span class="badge badge-high">High</span>
                    {% elseif risk.riskScore >= 6 %}
                        <span class="badge badge-medium">Medium</span>
                    {% else %}
                        <span class="badge badge-low">Low</span>
                    {% endif %}
                </td>
                <td>
                    {% if risk.treatmentStrategy %}
                        <span class="badge bg-info">
                            {% if risk.treatmentStrategy == 'mitigate' %}Mitigate
                            {% elseif risk.treatmentStrategy == 'accept' %}Accept
                            {% elseif risk.treatmentStrategy == 'transfer' %}Transfer
                            {% elseif risk.treatmentStrategy == 'avoid' %}Avoid
                            {% else %}{{ risk.treatmentStrategy }}
                            {% endif %}
                        </span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if risk.status %}
                        <span class="badge {% if risk.status == 'identified' %}badge-warning{% elseif risk.status == 'assessed' %}badge-info{% elseif risk.status == 'treated' %}badge-success{% else %}badge-secondary{% endif %}">
                            {% if risk.status == 'identified' %}Identified
                            {% elseif risk.status == 'assessed' %}Assessed
                            {% elseif risk.status == 'treated' %}Treated
                            {% elseif risk.status == 'monitored' %}Monitored
                            {% else %}{{ risk.status }}
                            {% endif %}
                        </span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td style="font-size: 7pt;">{{ risk.owner ? risk.owner.name : '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {# Risk Statistics Summary #}
    <div class="page-break"></div>
    <h2>Risk Statistics</h2>

    <h2>Distribution by Risk Level</h2>
    <table style="width: 60%;">
        <thead>
            <tr>
                <th scope="col" class="w-30">Risk Level</th>
                <th scope="col" class="text-center w-15">Count</th>
                <th scope="col" class="text-center w-15">Percentage</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><span class="badge badge-critical">Critical (â‰¥20)</span></td>
                <td class="text-center"><strong>{{ critical_risks }}</strong></td>
                <td class="text-center">{{ total_risks > 0 ? ((critical_risks / total_risks * 100)|round(1)) : 0 }}%</td>
            </tr>
            <tr>
                <td><span class="badge badge-high">High (12-19)</span></td>
                <td class="text-center"><strong>{{ high_risks }}</strong></td>
                <td class="text-center">{{ total_risks > 0 ? ((high_risks / total_risks * 100)|round(1)) : 0 }}%</td>
            </tr>
            <tr>
                <td><span class="badge badge-medium">Medium (6-11)</span></td>
                <td class="text-center"><strong>{{ medium_risks }}</strong></td>
                <td class="text-center">{{ total_risks > 0 ? ((medium_risks / total_risks * 100)|round(1)) : 0 }}%</td>
            </tr>
            <tr>
                <td><span class="badge badge-low">Low (<6)</span></td>
                <td class="text-center"><strong>{{ low_risks }}</strong></td>
                <td class="text-center">{{ total_risks > 0 ? ((low_risks / total_risks * 100)|round(1)) : 0 }}%</td>
            </tr>
        </tbody>
    </table>

    <div class="insight-box">
        <strong>Risk Profile:</strong>
        {% set critical_high_pct = total_risks > 0 ? (((critical_risks + high_risks) / total_risks * 100)|round(1)) : 0 %}
        {{ critical_high_pct }}% of risks are critical or high priority.
        {% if critical_high_pct >= 30 %}
        This indicates significant risk exposure requiring immediate management attention.
        {% elseif critical_high_pct >= 15 %}
        Moderate risk exposure. Continue focused treatment and monitoring.
        {% else %}
        Risk exposure is within acceptable limits. Maintain regular monitoring.
        {% endif %}
    </div>

    {% if status_breakdown is defined and status_breakdown|length > 0 %}
    <h3 class="mt-2">Distribution by Status</h3>
    <table style="width: 60%;">
        <thead>
            <tr>
                <th scope="col" class="w-30">Status</th>
                <th scope="col" class="text-center w-15">Count</th>
            </tr>
        </thead>
        <tbody>
            {% for status, count in status_breakdown %}
            <tr>
                <td>
                    {% if status == 'identified' %}
                        <span class="badge bg-warning">Identified</span>
                    {% elseif status == 'assessed' %}
                        <span class="badge bg-info">Assessed</span>
                    {% elseif status == 'treated' %}
                        <span class="badge bg-success">Treated</span>
                    {% elseif status == 'monitored' %}
                        <span class="badge bg-secondary">Monitored</span>
                    {% else %}
                        {{ status }}
                    {% endif %}
                </td>
                <td class="text-center"><strong>{{ count }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="insight-box">
        <strong>Recommendation:</strong> Ensure all identified risks are assessed and appropriate treatment strategies are defined and implemented.
    </div>
    {% endif %}

    <div class="footer">
        Risk Management Report - Generated on {{ pdf_generation_date|date('d.m.Y H:i:s') }} - Page <span class="pagenum"></span>
    </div>
</body>
</html>
