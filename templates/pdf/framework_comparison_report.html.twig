<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Framework Comparison Report</title>
    <style>
        @page {
            margin: 2cm 1.5cm;
        }

        body {
            font-family: DejaVu Sans, sans-serif;
            font-size: 9pt;
            line-height: 1.4;
            color: #333;
        }

        h1 {
            font-size: 18pt;
            color: #1a56db;
            text-align: center;
            margin-bottom: 5pt;
            border-bottom: 3px solid #1a56db;
            padding-bottom: 10pt;
        }

        h2 {
            font-size: 14pt;
            color: #1a56db;
            margin-top: 15pt;
            margin-bottom: 8pt;
            border-bottom: 1px solid #cbd5e1;
            padding-bottom: 5pt;
        }

        h3 {
            font-size: 11pt;
            color: #334155;
            margin-top: 12pt;
            margin-bottom: 6pt;
            font-weight: bold;
        }

        .header-info {
            text-align: center;
            font-size: 9pt;
            color: #64748b;
            margin-bottom: 20pt;
        }

        .stats-grid {
            display: table;
            width: 100%;
            margin-bottom: 20pt;
            border: 1px solid #cbd5e1;
            border-collapse: collapse;
        }

        .stats-row {
            display: table-row;
        }

        .stats-cell {
            display: table-cell;
            padding: 10pt;
            text-align: center;
            border: 1px solid #cbd5e1;
            width: 20%;
        }

        .stats-label {
            font-size: 8pt;
            color: #64748b;
            font-weight: bold;
            margin-bottom: 4pt;
        }

        .stats-value {
            font-size: 16pt;
            color: #1a56db;
            font-weight: bold;
        }

        .stats-value-success {
            color: #10b981;
        }

        .stats-value-warning {
            color: #f59e0b;
        }

        .insight-box {
            background: #f8fafc;
            border-left: 4px solid #1a56db;
            padding: 10pt;
            margin: 10pt 0;
            font-size: 8pt;
            color: #475569;
        }

        .insight-box strong {
            color: #1e293b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10pt 0;
            font-size: 8pt;
        }

        table th {
            background-color: #1a56db;
            color: white;
            padding: 6pt;
            text-align: left;
            font-weight: bold;
            border: 1px solid #1e3a8a;
        }

        table td {
            padding: 5pt;
            border: 1px solid #cbd5e1;
            vertical-align: top;
        }

        table tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .highlight-row {
            font-weight: bold;
            background: #e0e7ff !important;
        }

        .badge {
            display: inline-block;
            padding: 2pt 6pt;
            border-radius: 3pt;
            font-size: 7pt;
            font-weight: bold;
        }

        .badge-success {
            background-color: #10b981;
            color: white;
        }

        .badge-info {
            background-color: #3b82f6;
            color: white;
        }

        .badge-warning {
            background-color: #f59e0b;
            color: white;
        }

        .badge-danger {
            background-color: #ef4444;
            color: white;
        }

        .badge-secondary {
            background-color: #6b7280;
            color: white;
        }

        .quality-good {
            color: #10b981;
            font-weight: bold;
        }

        .quality-medium {
            color: #f59e0b;
            font-weight: bold;
        }

        .quality-weak {
            color: #ef4444;
            font-weight: bold;
        }

        .page-break {
            page-break-before: always;
        }

        .text-center {
            text-align: center;
        }

        .w-10 { width: 10%; }
        .w-15 { width: 15%; }
        .w-20 { width: 20%; }
        .w-30 { width: 30%; }
        .w-50 { width: 50%; }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30pt;
            text-align: center;
            font-size: 7pt;
            color: #64748b;
            border-top: 1px solid #cbd5e1;
            padding-top: 5pt;
        }
    </style>
</head>
<body>
    <h1>Framework Comparison Report</h1>
    <div class="header-info">
        {{ framework1.name }} ↔ {{ framework2.name }}<br>
        Generated: {{ pdf_generation_date|date('d.m.Y H:i') }}
    </div>

    {# Executive Summary #}
    <h2>Executive Summary</h2>
    <div class="stats-grid">
        <div class="stats-row">
            <div class="stats-cell">
                <div class="stats-label">{{ framework1.code }}</div>
                <div class="stats-value">{{ framework1_count }}</div>
                <div class="stats-label" style="margin-top: 2pt;">Requirements</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">{{ framework2.code }}</div>
                <div class="stats-value">{{ framework2_count }}</div>
                <div class="stats-label" style="margin-top: 2pt;">Requirements</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Mapped</div>
                <div class="stats-value stats-value-success">{{ mapped_count }}</div>
                <div class="stats-label" style="margin-top: 2pt;">{{ overlap_percentage }}%</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Avg. Quality</div>
                <div class="stats-value {% if avg_mapping_quality >= 80 %}stats-value-success{% elseif avg_mapping_quality >= 60 %}stats-value-warning{% endif %}">{{ avg_mapping_quality }}%</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Symmetric Coverage</div>
                <div class="stats-value {% if symmetric_coverage >= 70 %}stats-value-success{% endif %}">{{ symmetric_coverage }}%</div>
            </div>
        </div>
    </div>

    {# Bidirectional Coverage #}
    <h2>Bidirectional Coverage Analysis</h2>
    <table>
        <thead>
            <tr>
                <th scope="col" class="w-50">Metric</th>
                <th scope="col" class="text-center w-20">{{ framework1.code }} → {{ framework2.code }}</th>
                <th scope="col" class="text-center w-20">{{ framework2.code }} → {{ framework1.code }}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Total Requirements (Source)</td>
                <td class="text-center">{{ framework1_count }}</td>
                <td class="text-center">{{ framework2_count }}</td>
            </tr>
            <tr>
                <td>Mapped Requirements</td>
                <td class="text-center">{{ bidirectional_coverage.framework1_to_framework2.covered_requirements ?? 0 }}</td>
                <td class="text-center">{{ bidirectional_coverage.framework2_to_framework1.covered_requirements ?? 0 }}</td>
            </tr>
            <tr>
                <td>Coverage Percentage</td>
                <td class="text-center">
                    <span class="{% if coverage_f1_to_f2 >= 70 %}quality-good{% elseif coverage_f1_to_f2 >= 50 %}quality-medium{% else %}quality-weak{% endif %}">
                        {{ coverage_f1_to_f2 }}%
                    </span>
                </td>
                <td class="text-center">
                    <span class="{% if coverage_f2_to_f1 >= 70 %}quality-good{% elseif coverage_f2_to_f1 >= 50 %}quality-medium{% else %}quality-weak{% endif %}">
                        {{ coverage_f2_to_f1 }}%
                    </span>
                </td>
            </tr>
            <tr class="highlight-row">
                <td>Bidirectional Overlap (Average)</td>
                <td colspan="2" class="text-center">{{ bidirectional_overlap }}%</td>
            </tr>
            <tr class="highlight-row">
                <td>Symmetric Coverage (Minimum)</td>
                <td colspan="2" class="text-center">{{ symmetric_coverage }}%</td>
            </tr>
        </tbody>
    </table>

    <div class="insight-box">
        <strong>Analysis:</strong>
        {% if symmetric_coverage >= 70 %}
        Excellent bidirectional coverage. Both frameworks are strongly aligned.
        {% elseif symmetric_coverage >= 50 %}
        Good mutual coverage with some gaps in both directions.
        {% else %}
        Asymmetric coverage detected. Review unmapped requirements in both frameworks.
        {% endif %}
    </div>

    {# Mapping Quality Distribution #}
    <div class="page-break"></div>
    <h2>Mapping Quality Distribution</h2>
    <table>
        <thead>
            <tr>
                <th scope="col" class="w-30">Quality Level</th>
                <th scope="col" class="text-center w-15">Range</th>
                <th scope="col" class="text-center w-15">Count</th>
                <th scope="col" class="text-center w-15">Percentage</th>
                <th scope="col" class="w-25">Assessment</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><span class="badge bg-success">Excellent</span></td>
                <td class="text-center">90-100%</td>
                <td class="text-center"><strong>{{ quality_distribution.excellent }}</strong></td>
                <td class="text-center">{{ mapped_count > 0 ? ((quality_distribution.excellent / mapped_count * 100)|round(1)) : 0 }}%</td>
                <td>Precise mappings, high reliability</td>
            </tr>
            <tr>
                <td><span class="badge bg-info">Good</span></td>
                <td class="text-center">70-89%</td>
                <td class="text-center"><strong>{{ quality_distribution.good }}</strong></td>
                <td class="text-center">{{ mapped_count > 0 ? ((quality_distribution.good / mapped_count * 100)|round(1)) : 0 }}%</td>
                <td>{{ 'pdf.framework_comparison.solid_mappings_minor'|trans({}, 'messages')}}</td>
            </tr>
            <tr>
                <td><span class="badge bg-warning">Medium</span></td>
                <td class="text-center">50-69%</td>
                <td class="text-center"><strong>{{ quality_distribution.medium }}</strong></td>
                <td class="text-center">{{ mapped_count > 0 ? ((quality_distribution.medium / mapped_count * 100)|round(1)) : 0 }}%</td>
                <td>Partial alignment, review recommended</td>
            </tr>
            <tr>
                <td><span class="badge bg-danger">Weak</span></td>
                <td class="text-center">&lt;50%</td>
                <td class="text-center"><strong>{{ quality_distribution.weak }}</strong></td>
                <td class="text-center">{{ mapped_count > 0 ? ((quality_distribution.weak / mapped_count * 100)|round(1)) : 0 }}%</td>
                <td>Low alignment, optimization needed</td>
            </tr>
            <tr class="highlight-row">
                <td><strong>Average Mapping Quality</strong></td>
                <td colspan="4" class="text-center"><strong>{{ avg_mapping_quality }}%</strong></td>
            </tr>
        </tbody>
    </table>

    {% set excellent_good_pct = mapped_count > 0 ? (((quality_distribution.excellent + quality_distribution.good) / mapped_count * 100)|round(1)) : 0 %}
    <div class="insight-box">
        <strong>Quality Assessment:</strong>
        {{ excellent_good_pct }}% of mappings are good or better (≥70%).
        {% if quality_distribution.weak > 0 %}
        <br><strong>Recommendation:</strong> Review and improve {{ quality_distribution.weak }} weak mappings (&lt;50% quality) for better framework alignment.
        {% endif %}
    </div>

    {# Category Coverage Analysis #}
    <div class="page-break"></div>
    <h2>Category Coverage Analysis</h2>

    <h2>{{ framework1.code }} → {{ framework2.code }}</h2>
    <table>
        <thead>
            <tr>
                <th scope="col" class="w-30">Category</th>
                <th scope="col" class="text-center w-15">Total</th>
                <th scope="col" class="text-center w-15">Mapped</th>
                <th scope="col" class="text-center w-15">Coverage</th>
                <th scope="col" class="text-center w-15">Avg. Quality</th>
            </tr>
        </thead>
        <tbody>
            {% for category, stats in category_coverage_f1_to_f2 %}
            <tr>
                <td><strong>{{ category }}</strong></td>
                <td class="text-center">{{ stats.total }}</td>
                <td class="text-center">{{ stats.mapped }}</td>
                <td class="text-center">
                    <span class="{% if stats.coverage >= 70 %}quality-good{% elseif stats.coverage >= 50 %}quality-medium{% else %}quality-weak{% endif %}">
                        {{ stats.coverage }}%
                    </span>
                </td>
                <td class="text-center">{{ stats.avg_quality }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3 style="margin-top: 15pt;">{{ framework2.code }} → {{ framework1.code }}</h3>
    <table>
        <thead>
            <tr>
                <th scope="col" class="w-30">Category</th>
                <th scope="col" class="text-center w-15">Total</th>
                <th scope="col" class="text-center w-15">Mapped</th>
                <th scope="col" class="text-center w-15">Coverage</th>
                <th scope="col" class="text-center w-15">Avg. Quality</th>
            </tr>
        </thead>
        <tbody>
            {% for category, stats in category_coverage_f2_to_f1 %}
            <tr>
                <td><strong>{{ category }}</strong></td>
                <td class="text-center">{{ stats.total }}</td>
                <td class="text-center">{{ stats.mapped }}</td>
                <td class="text-center">
                    <span class="{% if stats.coverage >= 70 %}quality-good{% elseif stats.coverage >= 50 %}quality-medium{% else %}quality-weak{% endif %}">
                        {{ stats.coverage }}%
                    </span>
                </td>
                <td class="text-center">{{ stats.avg_quality }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="insight-box">
        <strong>Category Insights:</strong>
        Categories with coverage &lt;50% should be prioritized for improved mapping quality and completeness.
    </div>

    {# Detailed Comparison #}
    <div class="page-break"></div>
    <h2>Detailed Requirement Mapping</h2>
    <table>
        <thead>
            <tr>
                <th scope="col" class="w-15">{{ framework1.code }} ID</th>
                <th scope="col" class="w-30">{{ framework1.code }} Requirement</th>
                <th scope="col" class="w-15">Mapping Status</th>
                <th scope="col" class="w-10">Quality</th>
                <th scope="col" class="w-30">{{ framework2.code }} Requirement</th>
            </tr>
        </thead>
        <tbody>
            {% for detail in comparison_details %}
            <tr>
                <td><strong>{{ detail.framework1Requirement.requirementId }}</strong></td>
                <td>{{ (detail.framework1Requirement.description ?? '')|slice(0, 60) }}{% if (detail.framework1Requirement.description ?? '')|length > 60 %}...{% endif %}</td>
                <td class="text-center">
                    {% if detail.mapped %}
                        <span class="badge bg-success">Mapped</span>
                    {% else %}
                        <span class="badge bg-secondary">Not Mapped</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if detail.matchQuality is not null %}
                        <span class="{% if detail.matchQuality >= 90 %}quality-good{% elseif detail.matchQuality >= 70 %}quality-medium{% else %}quality-weak{% endif %}">
                            {{ detail.matchQuality }}%
                        </span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if detail.framework2Requirement %}
                        {{ detail.framework2Requirement.description|slice(0, 60) }}{% if detail.framework2Requirement.description|length > 60 %}...{% endif %}
                    {% else %}
                        <span style="color: #94a3b8;">No mapping</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="footer">
        Framework Comparison Report - Generated on {{ pdf_generation_date|date('d.m.Y H:i:s') }} - Page <span class="pagenum"></span>
    </div>
</body>
</html>
