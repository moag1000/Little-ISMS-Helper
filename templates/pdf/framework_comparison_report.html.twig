{% extends 'pdf/base.html.twig' %}

{% block pdf_title %}Framework Comparison - {{ framework1.name }} vs {{ framework2.name }}{% endblock %}

{% block header_title %}Framework Comparison Report{% endblock %}
{% block header_subtitle %}{{ framework1.name }} ‚Üî {{ framework2.name }}{% endblock %}

{% block content %}
    {# Summary Section #}
    <div class="summary-box">
        <div class="metric">
            <span class="metric-label">{{ framework1.code }}</span>
            <span class="metric-value">{{ framework1_count }} Anforderungen</span>
        </div>
        <div class="metric">
            <span class="metric-label">{{ framework2.code }}</span>
            <span class="metric-value">{{ framework2_count }} Anforderungen</span>
        </div>
        <div class="metric">
            <span class="metric-label">Gemappte Anforderungen</span>
            <span class="metric-value" style="color: #0A0;">{{ mapped_count }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Overlap</span>
            <span class="metric-value">{{ overlap_percentage }}%</span>
        </div>
        <div class="metric">
            <span class="metric-label">Unique zu {{ framework1.code }}</span>
            <span class="metric-value" style="color: #F90;">{{ unique_framework1|length }}</span>
        </div>
    </div>

    {# Comparison Summary #}
    <h2>Vergleichs-√úbersicht</h2>
    <table style="width: 80%;">
        <thead>
            <tr>
                <th>Metrik</th>
                <th class="text-center">{{ framework1.code }}</th>
                <th class="text-center">{{ framework2.code }}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Gesamt Anforderungen</td>
                <td class="text-center">{{ framework1_count }}</td>
                <td class="text-center">{{ framework2_count }}</td>
            </tr>
            <tr>
                <td>Gemappte Anforderungen</td>
                <td class="text-center">{{ mapped_count }}</td>
                <td class="text-center">{{ mapped_count }}</td>
            </tr>
            <tr>
                <td>Unique Anforderungen</td>
                <td class="text-center">{{ unique_framework1|length }}</td>
                <td class="text-center">{{ framework2_count - mapped_count }}</td>
            </tr>
            <tr>
                <td>Coverage</td>
                <td class="text-center">{{ framework1_count > 0 ? ((mapped_count / framework1_count * 100)|round(1)) : 0 }}%</td>
                <td class="text-center">{{ framework2_count > 0 ? ((mapped_count / framework2_count * 100)|round(1)) : 0 }}%</td>
            </tr>
        </tbody>
    </table>

    {# High-Quality Mappings #}
    {% set high_quality = comparison_details|filter(d => d.mapped and d.matchQuality >= 80) %}
    {% if high_quality|length > 0 %}
    <div class="page-break"></div>
    <h2>High-Quality Mappings (‚â•80% Match)</h2>
    <p style="font-size: 9pt; color: #666; margin-bottom: 10px;">
        Diese Anforderungen sind gut aufeinander abgestimmt und k√∂nnen f√ºr Harmonisierung genutzt werden.
    </p>
    <table>
        <thead>
            <tr>
                <th style="width: 15%;">{{ framework1.code }} ID</th>
                <th style="width: 30%;">{{ framework1.code }} Titel</th>
                <th style="width: 15%;">{{ framework2.code }} ID</th>
                <th style="width: 30%;">{{ framework2.code }} Titel</th>
                <th style="width: 10%;">Match %</th>
            </tr>
        </thead>
        <tbody>
            {% for detail in high_quality|slice(0, 15) %}
            <tr class="no-break">
                <td><strong>{{ detail.framework1Requirement.requirementId }}</strong></td>
                <td style="font-size: 8pt;">{{ detail.framework1Requirement.title|length > 60 ? (detail.framework1Requirement.title|slice(0, 60) ~ '...') : detail.framework1Requirement.title }}</td>
                <td><strong>{{ detail.framework2Requirement.requirementId }}</strong></td>
                <td style="font-size: 8pt;">{{ detail.framework2Requirement.title|length > 60 ? (detail.framework2Requirement.title|slice(0, 60) ~ '...') : detail.framework2Requirement.title }}</td>
                <td class="text-center"><span class="badge badge-success">{{ detail.matchQuality }}%</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {# Unique Requirements (Gaps) #}
    {% if unique_framework1|length > 0 %}
    <div class="page-break"></div>
    <h2>Unique Requirements: {{ framework1.code }}</h2>
    <p style="font-size: 9pt; color: #666; margin-bottom: 10px;">
        Diese Anforderungen existieren nur in {{ framework1.code }} und haben keine Entsprechung in {{ framework2.code }}.
    </p>
    <table>
        <thead>
            <tr>
                <th style="width: 15%;">ID</th>
                <th style="width: 35%;">Titel</th>
                <th style="width: 20%;">Kategorie</th>
                <th style="width: 30%;">Beschreibung</th>
            </tr>
        </thead>
        <tbody>
            {% for req in unique_framework1|slice(0, 20) %}
            <tr class="no-break">
                <td><strong>{{ req.framework1Requirement.requirementId }}</strong></td>
                <td style="font-size: 8pt;">{{ req.framework1Requirement.title|length > 50 ? (req.framework1Requirement.title|slice(0, 50) ~ '...') : req.framework1Requirement.title }}</td>
                <td><span class="badge badge-info">{{ req.framework1Requirement.category ?? '-' }}</span></td>
                <td style="font-size: 7pt;">{{ req.framework1Requirement.description|length > 80 ? (req.framework1Requirement.description|slice(0, 80) ~ '...') : (req.framework1Requirement.description ?? '-') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if unique_framework1|length > 20 %}
    <p style="font-size: 8pt; color: #666; margin-top: 5px;">
        ... und {{ unique_framework1|length - 20 }} weitere unique Anforderungen
    </p>
    {% endif %}
    {% endif %}

    {# Recommendations Section #}
    <div class="page-break"></div>
    <h2>Harmonisierungs-Empfehlungen</h2>

    <h3>Strategie: Framework-Harmonisierung</h3>
    <div style="background: #E8F4F8; padding: 8px; margin: 5px 0; border-left: 3px solid #2196F3; font-size: 9pt;">
        <strong>Status:</strong> {{ mapped_count }}/{{ framework1_count }} gemapped ({{ overlap_percentage }}%),
        {{ high_quality|length }} High-Quality Mappings, {{ unique_framework1|length }} unique {{ framework1.code }}
    </div>

    <h3>Empfehlung 1: Mapping-L√ºcken schlie√üen (Priorit√§t: Hoch)</h3>
    <div style="background: #FFF2CC; padding: 8px; margin: 5px 0; border-left: 3px solid #F4D03F; font-size: 9pt;">
        {% set unmapped = framework1_count - mapped_count %}
        {{ unmapped }} Anforderungen nicht gemapped. Review unique {{ framework1.code }}-Anforderungen,
        Partial-Mappings identifizieren. <strong>Zeitaufwand:</strong> ~{{ (unmapped * 15 / 60)|round(1) }} Stunden
    </div>

    <h3>Empfehlung 2: Compliance-Hebel nutzen (Quick Win)</h3>
    <div style="background: #C6EFCE; padding: 8px; margin: 5px 0; border-left: 3px solid #28A745; font-size: 9pt;">
        {{ high_quality|length }} High-Quality Mappings erm√∂glichen Wiederverwendung von Nachweisen,
        gemeinsame Kontrollen, kombinierte Assessments.
        <strong>Zeitersparnis:</strong> ~{{ (high_quality|length * 2)|round }} Stunden
    </div>

    <h3>Empfehlung 3: Gap-Analyse (Mittelfristig)</h3>
    <div style="background: #FFEB9C; padding: 8px; margin: 5px 0; border-left: 3px solid #FFA500; font-size: 9pt;">
        {{ unique_framework1|length + (framework2_count - mapped_count) }} unmapped Requirements:
        {{ unique_framework1|length }} unique {{ framework1.code }},
        {{ framework2_count - mapped_count }} unmapped {{ framework2.code }}
    </div>

    <h3>Implementierungs-Roadmap</h3>
    <table style="width: 95%; font-size: 8pt;">
        <thead>
            <tr>
                <th style="width: 20%;">Phase</th>
                <th style="width: 55%;">Aktivit√§ten</th>
                <th style="width: 12%;">Dauer</th>
                <th style="width: 13%;">Nutzen</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Phase 1 (Woche 1-2)</strong></td>
                <td>High-Quality Mappings dokumentieren, Kontroll-Implementierungen identifizieren, Quick Wins</td>
                <td class="text-center">2 Wo.</td>
                <td class="text-center"><span class="badge badge-success">Hoch</span></td>
            </tr>
            <tr>
                <td><strong>Phase 2 (Woche 3-6)</strong></td>
                <td>Mappings erstellen, Partial Mappings bewerten, Dokumentation vervollst√§ndigen</td>
                <td class="text-center">4 Wo.</td>
                <td class="text-center"><span class="badge badge-warning">Mittel</span></td>
            </tr>
            <tr>
                <td><strong>Phase 3 (Woche 7-12)</strong></td>
                <td>Gap-Analyse, zus√§tzliche Kontrollen, kombinierte Compliance-Bewertung</td>
                <td class="text-center">6 Wo.</td>
                <td class="text-center"><span class="badge badge-info">Lang</span></td>
            </tr>
        </tbody>
    </table>

    <div style="background: #E8F4F8; padding: 8px; margin-top: 10px; font-size: 9pt;">
        <strong>üìã N√§chste Schritte:</strong>
        Stakeholder-Meeting, Ressourcen-Planung, Kontroll-Dokumentation Template,
        Pilotprojekt mit Top 10 Mappings, monatliches Review etablieren
    </div>
{% endblock %}
