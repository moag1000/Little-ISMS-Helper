{% extends 'pdf/base.html.twig' %}

{% block pdf_title %}Gap Analysis Report - {{ framework.name }}{% endblock %}

{% block header_title %}Gap Analysis Report{% endblock %}
{% block header_subtitle %}{{ framework.name }} ({{ framework.code }}){% endblock %}

{% block extra_styles %}
    .stats-grid {
        display: table;
        width: 100%;
        margin-bottom: 20pt;
        border: 1px solid #cbd5e1;
        border-collapse: collapse;
    }

    .stats-row {
        display: table-row;
    }

    .stats-cell {
        display: table-cell;
        padding: 10pt;
        text-align: center;
        border: 1px solid #cbd5e1;
        width: 20%;
    }

    .stats-label {
        font-size: 8pt;
        color: #64748b;
        font-weight: bold;
        margin-bottom: 4pt;
    }

    .stats-value {
        font-size: 16pt;
        color: #1F4E78;
        font-weight: bold;
    }

    .stats-value-success {
        color: #10b981;
    }

    .stats-value-warning {
        color: #f59e0b;
    }

    .stats-value-danger {
        color: #ef4444;
    }

    .insight-box {
        background: #f8fafc;
        border-left: 4px solid #1F4E78;
        padding: 10pt;
        margin: 10pt 0;
        font-size: 9pt;
        color: #475569;
    }

    .insight-box strong {
        color: #1e293b;
    }

    .risk-box-low {
        background: #f0fdf4;
        border-left: 4px solid #10b981;
    }

    .risk-box-medium {
        background: #fffbeb;
        border-left: 4px solid #f59e0b;
    }

    .risk-box-high {
        background: #fef2f2;
        border-left: 4px solid #ef4444;
    }

    .highlight-row {
        font-weight: bold;
        background: #f1f5f9;
    }

    .w-15 {
        width: 15%;
    }

    .w-20 {
        width: 20%;
    }

    .w-25 {
        width: 25%;
    }

    .w-30 {
        width: 30%;
    }

    .w-40 {
        width: 40%;
    }
{% endblock %}

{% block content %}
    {# Executive Summary #}
    <h2>Executive Summary</h2>
    <div class="stats-grid">
        <div class="stats-row">
            <div class="stats-cell">
                <div class="stats-label">Total Requirements</div>
                <div class="stats-value">{{ total_requirements }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Met Requirements</div>
                <div class="stats-value stats-value-success">{{ met_requirements }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Identified Gaps</div>
                <div class="stats-value stats-value-danger">{{ total_gaps }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Compliance Score</div>
                <div class="stats-value {% if compliance_score >= 80 %}stats-value-success{% elseif compliance_score >= 60 %}stats-value-warning{% else %}stats-value-danger{% endif %}">{{ compliance_score }}%</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Risk Score</div>
                <div class="stats-value {% if risk_score >= 50 %}stats-value-danger{% elseif risk_score >= 20 %}stats-value-warning{% else %}stats-value-success{% endif %}">{{ risk_score }}</div>
            </div>
        </div>
    </div>

    {# Risk Assessment #}
    <h2>Risk Assessment</h2>
    <div class="{% if risk_score >= 50 %}risk-box-high{% elseif risk_score >= 20 %}risk-box-medium{% else %}risk-box-low{% endif %} insight-box">
        <strong>Overall Risk Score: {{ risk_score }}</strong>
        (Calculation: {{ uncovered_critical|length }} critical × 10 + {{ uncovered_high|length }} high × 5)
        <br>
        {% if risk_score >= 50 %}
            <strong>Status: CRITICAL</strong> - Immediate action required
        {% elseif risk_score >= 20 %}
            <strong>Status: HIGH</strong> - Urgent attention needed
        {% elseif risk_score > 0 %}
            <strong>Status: MEDIUM</strong> - Planned gap closure recommended
        {% else %}
            <strong>Status: LOW</strong> - Good compliance status
        {% endif %}
    </div>

    <h3>Compliance Scores Comparison</h3>
    <table>
        <thead>
            <tr>
                <th class="w-40">Metric</th>
                <th class="text-center w-20">Standard Score</th>
                <th class="text-center w-20">Weighted Score</th>
                <th class="text-center w-20">Difference</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Compliance Score</td>
                <td class="text-center">{{ compliance_score }}%</td>
                <td class="text-center">
                    <strong>{{ weighted_compliance_score }}%</strong>
                </td>
                <td class="text-center">
                    {% set diff = weighted_compliance_score - compliance_score %}
                    <span style="color: {% if diff < 0 %}#ef4444{% elseif diff > 0 %}#10b981{% else %}#64748b{% endif %}; font-weight: bold;">
                        {{ diff > 0 ? '+' : '' }}{{ diff }}%
                    </span>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="insight-box">
        <strong>Interpretation:</strong>
        {% if weighted_compliance_score < compliance_score %}
            The weighted score is lower, indicating that critical/high priority requirements are less well met than medium/low requirements. Focus on high-impact gaps required.
        {% elseif weighted_compliance_score > compliance_score %}
            The weighted score is higher - critical requirements are better met. Good prioritization!
        {% else %}
            Balanced compliance across all priority levels.
        {% endif %}
    </div>

    {# Gap Distribution #}
    <div class="page-break"></div>
    <h2>Gap Distribution by Severity</h2>
    <table>
        <thead>
            <tr>
                <th class="w-30">Severity Level</th>
                <th class="text-center w-20">Gap Count</th>
                <th class="text-center w-20">Percentage</th>
                <th class="text-center w-15">Risk Weight</th>
                <th class="text-center w-15">Total Risk</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><span class="badge badge-critical">Critical</span></td>
                <td class="text-center"><strong>{{ uncovered_critical|length }}</strong></td>
                <td class="text-center">{{ total_gaps > 0 ? ((uncovered_critical|length / total_gaps * 100)|round(1)) : 0 }}%</td>
                <td class="text-center">10</td>
                <td class="text-center"><strong style="color: #ef4444;">{{ uncovered_critical|length * 10 }}</strong></td>
            </tr>
            <tr>
                <td><span class="badge badge-high">High</span></td>
                <td class="text-center"><strong>{{ uncovered_high|length }}</strong></td>
                <td class="text-center">{{ total_gaps > 0 ? ((uncovered_high|length / total_gaps * 100)|round(1)) : 0 }}%</td>
                <td class="text-center">5</td>
                <td class="text-center"><strong style="color: #f59e0b;">{{ uncovered_high|length * 5 }}</strong></td>
            </tr>
            <tr>
                <td><span class="badge badge-warning">Medium</span></td>
                <td class="text-center"><strong>{{ uncovered_medium|length }}</strong></td>
                <td class="text-center">{{ total_gaps > 0 ? ((uncovered_medium|length / total_gaps * 100)|round(1)) : 0 }}%</td>
                <td class="text-center">-</td>
                <td class="text-center">-</td>
            </tr>
            <tr>
                <td><span class="badge badge-low">Low</span></td>
                <td class="text-center"><strong>{{ uncovered_low|length }}</strong></td>
                <td class="text-center">{{ total_gaps > 0 ? ((uncovered_low|length / total_gaps * 100)|round(1)) : 0 }}%</td>
                <td class="text-center">-</td>
                <td class="text-center">-</td>
            </tr>
            <tr class="highlight-row">
                <td><strong>Total</strong></td>
                <td class="text-center"><strong>{{ total_gaps }}</strong></td>
                <td class="text-center"><strong>100%</strong></td>
                <td colspan="2" class="text-center"><strong>Risk Score: {{ risk_score }}</strong></td>
            </tr>
        </tbody>
    </table>

    {# Root Cause Analysis #}
    {% if root_cause_analysis is defined %}
    <div class="page-break"></div>
    <h2>Root Cause Analysis</h2>

    <h3>Root Cause Distribution</h3>
    <table>
        <thead>
            <tr>
                <th class="w-30">Root Cause</th>
                <th class="text-center w-15">Count</th>
                <th class="text-center w-15">Percentage</th>
                <th class="w-40">Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><span class="badge badge-critical">Not Started</span></td>
                <td class="text-center"><strong>{{ root_cause_analysis.summary.not_started_count }}</strong></td>
                <td class="text-center">{{ total_gaps > 0 ? ((root_cause_analysis.summary.not_started_count / total_gaps * 100)|round(1)) : 0 }}%</td>
                <td>Requirements with 0% fulfillment - not yet addressed</td>
            </tr>
            <tr>
                <td><span class="badge badge-high">Missing Control</span></td>
                <td class="text-center"><strong>{{ root_cause_analysis.summary.missing_control_count }}</strong></td>
                <td class="text-center">{{ total_gaps > 0 ? ((root_cause_analysis.summary.missing_control_count / total_gaps * 100)|round(1)) : 0 }}%</td>
                <td>Very low fulfillment (&lt;30%) - control missing or insufficient</td>
            </tr>
            <tr>
                <td><span class="badge badge-warning">Incomplete Implementation</span></td>
                <td class="text-center"><strong>{{ root_cause_analysis.summary.incomplete_implementation_count }}</strong></td>
                <td class="text-center">{{ total_gaps > 0 ? ((root_cause_analysis.summary.incomplete_implementation_count / total_gaps * 100)|round(1)) : 0 }}%</td>
                <td>Partial fulfillment (30-80%) - implementation in progress</td>
            </tr>
            <tr>
                <td><span class="badge badge-info">Missing Evidence</span></td>
                <td class="text-center"><strong>{{ root_cause_analysis.summary.missing_evidence_count }}</strong></td>
                <td class="text-center">{{ total_gaps > 0 ? ((root_cause_analysis.summary.missing_evidence_count / total_gaps * 100)|round(1)) : 0 }}%</td>
                <td>High fulfillment (80-99%) - control exists but documentation lacking</td>
            </tr>
        </tbody>
    </table>

    <h3>Category-Specific Patterns (Top 5)</h3>
    <table>
        <thead>
            <tr>
                <th class="w-30">Category</th>
                <th class="text-center w-15">Gap Count</th>
                <th class="text-center w-15">Avg. Fulfillment</th>
                <th class="text-center w-20">Dominant Root Cause</th>
                <th class="text-center w-20">Pattern Severity</th>
            </tr>
        </thead>
        <tbody>
            {% for category, pattern in category_patterns|slice(0, 5) %}
            <tr>
                <td><strong>{{ category }}</strong></td>
                <td class="text-center">{{ pattern.count }}</td>
                <td class="text-center">{{ pattern.avg_fulfillment }}%</td>
                <td class="text-center">
                    {% if pattern.dominant_root_cause == 'not_started' %}
                        <span class="badge badge-critical">Not Started</span>
                    {% elseif pattern.dominant_root_cause == 'missing_control' %}
                        <span class="badge badge-high">Missing Control</span>
                    {% elseif pattern.dominant_root_cause == 'incomplete_implementation' %}
                        <span class="badge badge-warning">Incomplete</span>
                    {% else %}
                        <span class="badge badge-info">Missing Evidence</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if pattern.count >= 5 %}
                        <span style="color: #ef4444; font-weight: bold;">Critical Cluster</span>
                    {% elseif pattern.count >= 3 %}
                        <span style="color: #f59e0b; font-weight: bold;">Significant Pattern</span>
                    {% else %}
                        Moderate
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="insight-box">
        <strong>Quick Wins:</strong>
        {% if root_cause_analysis.summary.missing_evidence_count > 0 %}
            {{ root_cause_analysis.summary.missing_evidence_count }} gaps have missing documentation only.
            A documentation sprint can close these gaps in 30-60 days!
        {% endif %}
    </div>
    {% endif %}

    {# Priority-Weighted Roadmap #}
    {% if recommendations is defined and recommendations|length > 0 %}
    <div class="page-break"></div>
    <h2>Priority-Weighted Gap Closure Roadmap</h2>
    <table>
        <thead>
            <tr>
                <th class="w-15">Priority</th>
                <th class="w-25">Action</th>
                <th class="w-15">Affected Gaps</th>
                <th class="w-15">Timeline</th>
                <th class="w-15">Risk Reduction</th>
                <th class="w-15">Effort</th>
            </tr>
        </thead>
        <tbody>
            {% for rec in recommendations %}
            <tr>
                <td><span class="badge badge-{{ rec.priority|lower }}">{{ rec.priority }}</span></td>
                <td><strong>{{ rec.action }}</strong></td>
                <td class="text-center">{{ rec.count }}</td>
                <td class="text-center">{{ rec.timeline }}</td>
                <td class="text-center"><strong style="color: #10b981;">-{{ rec.risk_reduction }}</strong></td>
                <td class="text-center">{{ rec.effort }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {# Detailed Gap List #}
    <div class="page-break"></div>
    <h2>Detailed Gap List</h2>
    <table>
        <thead>
            <tr>
                <th class="w-15">Requirement ID</th>
                <th class="w-30">Requirement</th>
                <th class="text-center w-15">Priority</th>
                <th class="text-center w-15">Fulfillment</th>
                <th class="w-25">Category</th>
            </tr>
        </thead>
        <tbody>
            {% for gap in gaps %}
            <tr>
                <td><strong>{{ gap.requirementId }}</strong></td>
                <td>{{ gap.description|slice(0, 100) }}{% if gap.description|length > 100 %}...{% endif %}</td>
                <td class="text-center">
                    {% set priority = gap.priority|default('medium') %}
                    <span class="badge badge-{{ priority }}">{{ priority|upper }}</span>
                </td>
                <td class="text-center">
                    {% set fulfillment = gap.fulfillmentPercentage|default(0) %}
                    <strong style="color: {% if fulfillment >= 80 %}#10b981{% elseif fulfillment >= 50 %}#f59e0b{% else %}#ef4444{% endif %};">
                        {{ fulfillment }}%
                    </strong>
                </td>
                <td>{{ gap.category|default('N/A') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
