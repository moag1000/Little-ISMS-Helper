<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Transitive Compliance Analysis</title>
    <style>
        @page {
            margin: 2cm 1.5cm;
        }

        body {
            font-family: DejaVu Sans, sans-serif;
            font-size: 9pt;
            line-height: 1.4;
            color: #333;
        }

        h1 {
            font-size: 18pt;
            color: #1a56db;
            text-align: center;
            margin-bottom: 5pt;
            border-bottom: 3px solid #1a56db;
            padding-bottom: 10pt;
        }

        h2 {
            font-size: 14pt;
            color: #1a56db;
            margin-top: 15pt;
            margin-bottom: 8pt;
            border-bottom: 1px solid #cbd5e1;
            padding-bottom: 5pt;
        }

        h3 {
            font-size: 11pt;
            color: #334155;
            margin-top: 12pt;
            margin-bottom: 6pt;
            font-weight: bold;
        }

        .header-info {
            text-align: center;
            font-size: 9pt;
            color: #64748b;
            margin-bottom: 20pt;
        }

        .stats-grid {
            display: table;
            width: 100%;
            margin-bottom: 20pt;
            border: 1px solid #cbd5e1;
            border-collapse: collapse;
        }

        .stats-row {
            display: table-row;
        }

        .stats-cell {
            display: table-cell;
            padding: 10pt;
            text-align: center;
            border: 1px solid #cbd5e1;
        }

        .stats-label {
            font-size: 8pt;
            color: #64748b;
            font-weight: bold;
            margin-bottom: 4pt;
        }

        .stats-value {
            font-size: 16pt;
            color: #1a56db;
            font-weight: bold;
        }

        .stats-value-success {
            color: #10b981;
        }

        .stats-value-warning {
            color: #f59e0b;
        }

        .insight-box {
            background: #f8fafc;
            border-left: 4pt solid #1a56db;
            padding: 10pt;
            margin: 10pt 0;
            font-size: 8pt;
            color: #475569;
        }

        .insight-box strong {
            color: #1e293b;
        }

        .quick-win-box {
            background: #f0fdf4;
            border-left: 4pt solid #10b981;
            padding: 10pt;
            margin: 10pt 0;
            font-size: 8pt;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10pt 0;
            font-size: 8pt;
        }

        table th {
            background-color: #1a56db;
            color: white;
            padding: 6pt;
            text-align: left;
            font-weight: bold;
            border: 1px solid #1e3a8a;
        }

        table td {
            padding: 5pt;
            border: 1px solid #cbd5e1;
            vertical-align: top;
        }

        table tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .highlight-row {
            font-weight: bold;
            background: #e0e7ff !important;
        }

        .badge {
            display: inline-block;
            padding: 2pt 6pt;
            border-radius: 3pt;
            font-size: 7pt;
            font-weight: bold;
        }

        .badge-success {
            background-color: #10b981;
            color: white;
        }

        .badge-info {
            background-color: #3b82f6;
            color: white;
        }

        .badge-warning {
            background-color: #f59e0b;
            color: white;
        }

        .badge-danger {
            background-color: #ef4444;
            color: white;
        }

        .badge-critical {
            background-color: #ef4444;
            color: white;
        }

        .quality-good {
            color: #10b981;
            font-weight: bold;
        }

        .quality-medium {
            color: #f59e0b;
            font-weight: bold;
        }

        .quality-weak {
            color: #ef4444;
            font-weight: bold;
        }

        .page-break {
            page-break-before: always;
        }

        .text-center {
            text-align: center;
        }

        .w-10 { width: 10%; }
        .w-12 { width: 12%; }
        .w-15 { width: 15%; }
        .w-16 { width: 16%; }
        .w-18 { width: 18%; }
        .w-20 { width: 20%; }
        .w-25 { width: 25%; }
        .w-30 { width: 30%; }
        .w-40 { width: 40%; }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30pt;
            text-align: center;
            font-size: 7pt;
            color: #64748b;
            border-top: 1px solid #cbd5e1;
            padding-top: 5pt;
        }
    </style>
</head>
<body>
    <h1>Transitive Compliance Report</h1>
    <div class="header-info">
        Multi-Framework Compliance Leverage Analysis<br>
        Generated: {{ pdf_generation_date|date('d.m.Y H:i') }}
    </div>

    {# Executive Summary #}
    <h2>Executive Summary</h2>
    <div class="stats-grid">
        <div class="stats-row">
            <div class="stats-cell">
                <div class="stats-label">Active Frameworks</div>
                <div class="stats-value">{{ total_frameworks }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Framework Relationships</div>
                <div class="stats-value">{{ total_relationships }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Quick Wins (High ROI)</div>
                <div class="stats-value stats-value-success">{{ quick_win_count }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Avg. Coverage</div>
                <div class="stats-value">{{ avg_coverage|round(1) }}%</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Avg. Mapping Quality</div>
                <div class="stats-value {% if avg_mapping_quality >= 80 %}stats-value-success{% elseif avg_mapping_quality >= 60 %}stats-value-warning{% endif %}">{{ avg_mapping_quality }}%</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Avg. Impact Score</div>
                <div class="stats-value stats-value-warning">{{ avg_impact_score }}</div>
            </div>
        </div>
    </div>

    {# Mapping Quality Distribution #}
    {% if total_mappings > 0 %}
    <h2>Mapping Quality Distribution</h2>
    <table>
        <thead>
            <tr>
                <th class="w-25">Quality Level</th>
                <th class="text-center w-15">Range</th>
                <th class="text-center w-15">Count</th>
                <th class="text-center w-15">Percentage</th>
                <th class="w-30">Assessment</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><span class="badge badge-success">Excellent</span></td>
                <td class="text-center">90-100%</td>
                <td class="text-center"><strong>{{ quality_distribution.excellent }}</strong></td>
                <td class="text-center">{{ total_mappings > 0 ? ((quality_distribution.excellent / total_mappings * 100)|round(1)) : 0 }}%</td>
                <td>Precise mappings, high reliability</td>
            </tr>
            <tr>
                <td><span class="badge badge-info">Good</span></td>
                <td class="text-center">70-89%</td>
                <td class="text-center"><strong>{{ quality_distribution.good }}</strong></td>
                <td class="text-center">{{ total_mappings > 0 ? ((quality_distribution.good / total_mappings * 100)|round(1)) : 0 }}%</td>
                <td>Solid mappings with minor deviations</td>
            </tr>
            <tr>
                <td><span class="badge badge-warning">Medium</span></td>
                <td class="text-center">50-69%</td>
                <td class="text-center"><strong>{{ quality_distribution.medium }}</strong></td>
                <td class="text-center">{{ total_mappings > 0 ? ((quality_distribution.medium / total_mappings * 100)|round(1)) : 0 }}%</td>
                <td>Partial alignment, review recommended</td>
            </tr>
            <tr>
                <td><span class="badge badge-danger">Weak</span></td>
                <td class="text-center">&lt;50%</td>
                <td class="text-center"><strong>{{ quality_distribution.weak }}</strong></td>
                <td class="text-center">{{ total_mappings > 0 ? ((quality_distribution.weak / total_mappings * 100)|round(1)) : 0 }}%</td>
                <td>Low alignment, optimization needed</td>
            </tr>
            <tr class="highlight-row">
                <td><strong>Average Quality</strong></td>
                <td colspan="4" class="text-center"><strong>{{ avg_mapping_quality }}%</strong> (across {{ total_mappings }} mappings)</td>
            </tr>
        </tbody>
    </table>

    {% set excellent_good_percentage = total_mappings > 0 ? (((quality_distribution.excellent + quality_distribution.good) / total_mappings * 100)|round(1)) : 0 %}
    <div class="insight-box">
        <strong>Quality Assessment:</strong>
        {{ excellent_good_percentage }}% of mappings are good or better (≥70%).
        {% if quality_distribution.weak > 0 %}
        {{ quality_distribution.weak }} weak mappings identified - review recommended for better transitive compliance effectiveness.
        {% endif %}
    </div>
    {% endif %}

    {# Quick Wins #}
    {% if quick_wins is defined and quick_wins|length > 0 %}
    <div class="page-break"></div>
    <h2>Quick Wins - High ROI Opportunities</h2>
    <div class="quick-win-box">
        <strong>{{ quick_wins|length }} Quick Wins Identified!</strong>
        These framework relationships offer maximum compliance benefit with minimal effort (ROI ≥ 3.0, Coverage ≥ 60%).
    </div>

    <table>
        <thead>
            <tr>
                <th class="w-18">From Framework</th>
                <th class="w-18">To Framework</th>
                <th class="text-center w-12">Coverage</th>
                <th class="text-center w-12">Impact Score</th>
                <th class="text-center w-12">ROI</th>
                <th class="text-center w-12">Effort (hrs)</th>
                <th class="w-16">Assessment</th>
            </tr>
        </thead>
        <tbody>
            {% for rel in quick_wins %}
            <tr>
                <td><strong>{{ rel.source.code }}</strong></td>
                <td><strong>{{ rel.target.code }}</strong></td>
                <td class="text-center">
                    <span class="quality-good">{{ rel.coverage }}%</span>
                </td>
                <td class="text-center"><strong style="color: #2196F3;">{{ rel.impact_score }}</strong></td>
                <td class="text-center"><strong class="quality-good">{{ rel.roi }}</strong></td>
                <td class="text-center">{{ rel.effort_estimate }}</td>
                <td>
                    {% if rel.roi >= 5 %}Excellent - Top Priority
                    {% else %}Very Good - Recommended
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="insight-box">
        <strong>Estimated Total Savings:</strong> {{ quick_wins|reduce((carry, rel) => carry + rel.mapped, 0) }} requirements
        can be covered with only {{ quick_wins|reduce((carry, rel) => carry + rel.effort_estimate, 0) }} hours of effort.
    </div>
    {% endif %}

    {# Framework Relationships Matrix #}
    <div class="page-break"></div>
    <h2>Framework Relationships Matrix</h2>
    <table>
        <thead>
            <tr>
                <th class="w-15">From Framework</th>
                <th class="w-15">To Framework</th>
                <th class="text-center w-12">Coverage</th>
                <th class="text-center w-12">Impact Score</th>
                <th class="text-center w-12">ROI</th>
                <th class="text-center w-12">Effort</th>
                <th class="text-center w-12">Priority</th>
                <th class="w-10">Rating</th>
            </tr>
        </thead>
        <tbody>
            {% for rel in framework_relationships %}
            <tr {% if rel.is_quick_win %}style="background: #f0fdf4;"{% endif %}>
                <td><strong>{{ rel.source.code }}</strong></td>
                <td><strong>{{ rel.target.code }}</strong></td>
                <td class="text-center">
                    <span class="{% if rel.coverage >= 80 %}quality-good{% elseif rel.coverage >= 50 %}quality-medium{% else %}quality-weak{% endif %}">
                        {{ rel.coverage }}%
                    </span>
                </td>
                <td class="text-center">
                    <strong {% if rel.impact_score >= 50 %}style="color: #2196F3;"{% endif %}>
                        {{ rel.impact_score }}
                    </strong>
                </td>
                <td class="text-center">
                    <strong {% if rel.roi >= 3 %}class="quality-good"{% endif %}>
                        {{ rel.roi }}
                    </strong>
                </td>
                <td class="text-center">{{ rel.effort_estimate }}h</td>
                <td class="text-center">
                    {% if rel.priority_multiplier >= 2 %}
                        <span class="badge badge-critical">High</span>
                    {% elseif rel.priority_multiplier >= 1.5 %}
                        <span class="badge badge-warning">Medium</span>
                    {% else %}
                        <span class="badge badge-info">Normal</span>
                    {% endif %}
                </td>
                <td>
                    {% if rel.is_quick_win %}Quick Win
                    {% elseif rel.impact_score >= 50 %}High Impact
                    {% elseif rel.roi >= 2 %}Good ROI
                    {% else %}Standard
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="insight-box">
        <strong>Impact Score:</strong> Calculated as (Coverage × Avg. Requirements × Priority) ÷ 100. Higher scores = higher business value.
        <br><strong>ROI:</strong> Impact Score ÷ Effort (hours). ROI ≥ 3.0 = Quick Win!
    </div>

    {# High Coverage Relationships #}
    {% set high_coverage = framework_relationships|filter(rel => rel.coverage >= 70) %}
    {% if high_coverage|length > 0 %}
    <div class="page-break"></div>
    <h2>High Coverage Relationships (≥70%)</h2>
    <div class="insight-box">
        <strong>{{ high_coverage|length }} High-Coverage Relationships Identified!</strong>
        These frameworks have strong overlaps and offer significant compliance leverage.
    </div>

    {% for rel in high_coverage|slice(0, 10) %}
    <div style="background: #f9fafb; border-left: 3px solid #10b981; padding: 8pt; margin: 5pt 0; font-size: 8pt;">
        <strong>{{ rel.source.code }} → {{ rel.target.code }}</strong>:
        Coverage <strong>{{ rel.coverage }}%</strong> ({{ rel.mapped }} of {{ rel.total }} requirements).
        Estimated time savings: ~{{ (rel.mapped * 1.5)|round }} hours.
    </div>
    {% endfor %}
    {% endif %}

    {# Strategic Recommendations #}
    <div class="page-break"></div>
    <h2>Strategic Recommendations</h2>

    <h3>1. Immediate Actions - Quick Wins</h3>
    <div class="quick-win-box insight-box">
        <strong>Priority: CRITICAL</strong>
        {% if quick_win_count > 0 %}
        - Focus on {{ quick_win_count }} Quick Wins with highest ROI (≥3.0).
        Start with top 3 for immediate compliance improvement.
        <br><strong>Expected Benefit:</strong> {{ quick_wins|slice(0, 3)|reduce((carry, rel) => carry + rel.mapped, 0) }} requirements
        with only {{ quick_wins|slice(0, 3)|reduce((carry, rel) => carry + rel.effort_estimate, 0) }} hours effort.
        {% else %}
        - No Quick Wins identified. Focus on High-Impact Relationships (Impact Score ≥ 50).
        {% endif %}
    </div>

    <h3>2. High-Impact Relationships</h3>
    <div class="insight-box">
        <strong>Priority: Very High</strong>
        {% if high_impact_count > 0 %}
        - {{ high_impact_count }} High-Impact Relationships (Impact Score ≥ 50) offer significant business value.
        Allocate resources for top relationships to maximize framework synergies.
        {% else %}
        - Focus on improving existing relationships to increase impact scores.
        {% endif %}
    </div>

    <h3>3. Optimization Opportunities</h3>
    {% set low_roi = framework_relationships|filter(rel => rel.roi < 2 and not rel.is_quick_win) %}
    <div class="insight-box">
        <strong>Priority: Medium</strong>
        - {{ low_roi|length }} framework relationships have low ROI (&lt;2.0).
        Options: (1) Improve mapping quality, (2) Reduce effort through automation, (3) De-prioritize in favor of high-ROI opportunities.
    </div>

    <h3>ROI-Based Implementation Roadmap</h3>
    <table>
        <thead>
            <tr>
                <th class="w-20">Phase</th>
                <th class="w-40">Activities</th>
                <th class="text-center w-15">Duration</th>
                <th class="text-center w-12">Effort</th>
                <th class="text-center w-13">ROI</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Phase 1 (Week 1-4)</strong></td>
                <td>Implement Top {{ (quick_wins ?? [])|slice(0, 5)|length }} Quick Wins, start combined audits</td>
                <td class="text-center">4 weeks</td>
                <td class="text-center">{% if quick_wins is defined and quick_wins|length > 0 %}{{ quick_wins|slice(0, 5)|reduce((carry, rel) => carry + rel.effort_estimate, 0) }}h{% else %}20-30h{% endif %}</td>
                <td class="text-center"><span class="badge badge-success">Very High</span></td>
            </tr>
            <tr>
                <td><strong>Phase 2 (Week 5-12)</strong></td>
                <td>Optimize High-Impact Relationships (Score ≥ 50), improve mapping quality, increase coverage</td>
                <td class="text-center">8 weeks</td>
                <td class="text-center">40-60h</td>
                <td class="text-center"><span class="badge badge-info">High</span></td>
            </tr>
            <tr>
                <td><strong>Phase 3 (Week 13-24)</strong></td>
                <td>Establish Compliance Hub with ROI Dashboard, automated tracking, continuous optimization</td>
                <td class="text-center">12 weeks</td>
                <td class="text-center">80-120h</td>
                <td class="text-center"><span class="badge badge-warning">Very High (long-term)</span></td>
            </tr>
        </tbody>
    </table>

    <div class="insight-box">
        <strong>Total Roadmap Benefit:</strong>
        Phase 1 delivers immediate results with minimal effort.
        Phase 2 maximizes strategic impact.
        Phase 3 establishes sustainable processes for long-term ROI optimization.
        <br><strong>Long-term ROI:</strong> 40-60% reduction in overall compliance effort through optimized prioritization.
    </div>

    <div class="footer">
        Transitive Compliance Report - Generated on {{ pdf_generation_date|date('d.m.Y H:i:s') }} - Page <span class="pagenum"></span>
    </div>
</body>
</html>
