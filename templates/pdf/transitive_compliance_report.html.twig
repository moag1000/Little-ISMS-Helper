{% extends 'pdf/base.html.twig' %}

{% block pdf_title %}Transitive Compliance Analysis{% endblock %}

{% block header_title %}Transitive Compliance Report{% endblock %}
{% block header_subtitle %}Multi-Framework Compliance Leverage Analysis{% endblock %}

{% block content %}
    {# Summary Section #}
    <div class="summary-box">
        <div class="metric">
            <span class="metric-label">Aktive Frameworks</span>
            <span class="metric-value">{{ total_frameworks }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Framework-Beziehungen</span>
            <span class="metric-value">{{ total_relationships }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Transitive Opportunities</span>
            <span class="metric-value" style="color: #0A0;">{{ transitive_count }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Unterstützte Anforderungen</span>
            <span class="metric-value" style="color: #0A0;">{{ total_helped }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Durchschn. Coverage</span>
            <span class="metric-value">{{ avg_coverage|round(1) }}%</span>
        </div>
    </div>

    <h2>Framework-Beziehungen Matrix</h2>
    <p style="font-size: 9pt; color: #666; margin-bottom: 10px;">
        Übersicht über die Mappings und Coverage zwischen allen aktiven Frameworks
    </p>

    <table>
        <thead>
            <tr>
                <th style="width: 25%;">Von Framework</th>
                <th style="width: 25%;">Zu Framework</th>
                <th style="width: 15%;">Gemapped</th>
                <th style="width: 15%;">Total</th>
                <th style="width: 20%;">Coverage</th>
            </tr>
        </thead>
        <tbody>
            {% for rel in framework_relationships|sort((a, b) => b.coverage <=> a.coverage) %}
            <tr class="no-break">
                <td><strong>{{ rel.source.name }}</strong> <small style="font-size: 7pt;">({{ rel.source.code }})</small></td>
                <td><strong>{{ rel.target.name }}</strong> <small style="font-size: 7pt;">({{ rel.target.code }})</small></td>
                <td class="text-center">{{ rel.mapped }}</td>
                <td class="text-center">{{ rel.total }}</td>
                <td class="text-center">
                    {% if rel.coverage >= 80 %}
                        <span class="badge badge-success">{{ rel.coverage }}%</span>
                    {% elseif rel.coverage >= 50 %}
                        <span class="badge badge-warning">{{ rel.coverage }}%</span>
                    {% else %}
                        <span class="badge badge-danger">{{ rel.coverage }}%</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {# High Coverage Relationships #}
    {% set high_coverage = framework_relationships|filter(rel => rel.coverage >= 70) %}
    {% if high_coverage|length > 0 %}
    <div class="page-break"></div>
    <h2>High-Coverage Relationships (≥70%)</h2>
    <p style="font-size: 9pt; color: #666; margin-bottom: 10px;">
        Diese Framework-Beziehungen haben starke Überlappungen und bieten signifikante Compliance-Hebel.
    </p>

    <div style="background: #C6EFCE; padding: 8px; margin: 5px 0; border-left: 3px solid #28A745; font-size: 9pt;">
        <strong>{{ high_coverage|length }} High-Coverage Relationships identifiziert!</strong>
        <p style="margin: 5px 0;">
            Diese Beziehungen ermöglichen es, mit einer Kontrolle mehrere Framework-Anforderungen gleichzeitig zu erfüllen.
        </p>
    </div>

    {% for rel in high_coverage %}
    <div class="no-break" style="background: #F9F9F9; padding: 6px; margin: 5px 0; border-left: 3px solid #28A745; font-size: 9pt;">
        <strong>{{ rel.source.code }} → {{ rel.target.code }}</strong>
        <p style="margin: 5px 0;">
            Coverage: <strong>{{ rel.coverage }}%</strong> ({{ rel.mapped }} von {{ rel.total }} Anforderungen)
        </p>
        <p style="margin: 5px 0; color: #666;">
            <em>Empfehlung:</em> Gemeinsame Kontroll-Implementierungen für diese {{ rel.mapped }} Anforderungen nutzen.
            Geschätzte Zeitersparnis: ~{{ (rel.mapped * 1.5)|round }} Stunden.
        </p>
    </div>
    {% endfor %}
    {% endif %}

    {# Compliance Leverage Opportunities #}
    <div class="page-break"></div>
    <h2>Compliance-Hebel-Analyse</h2>

    <h3>Top Compliance Leverage Opportunities</h3>
    <p style="font-size: 9pt; color: #666; margin-bottom: 10px;">
        Identifikation von Anforderungen, die mehrere Frameworks gleichzeitig bedienen
    </p>

    {% set leverage_potential = total_helped / total_frameworks %}
    <div style="background: #E8F4F8; padding: 8px; margin: 5px 0; border-left: 3px solid #2196F3; font-size: 9pt;">
        <strong>Leverage-Score:</strong> Durchschnittlich unterstützt jede Kontrolle <strong>{{ leverage_potential|round(1) }} Frameworks</strong>.
        {% if leverage_potential >= 2 %}
        <strong>Sehr gut!</strong> Cross-Framework-Synergien werden effektiv genutzt.
        {% elseif leverage_potential >= 1.5 %}
        <strong>Gut,</strong> aber Verbesserungspotential vorhanden.
        {% else %}
        <strong>Niedrig</strong> - Signifikantes Optimierungspotential durch bessere Mappings.
        {% endif %}
    </div>

    {# Recommendations Section #}
    <div class="page-break"></div>
    <h2>Multi-Framework-Strategie-Empfehlungen</h2>

    <h3>Strategie: Maximierung der Framework-Synergien</h3>
    <div style="background: #E8F4F8; padding: 8px; margin: 5px 0; border-left: 3px solid #2196F3; font-size: 9pt;">
        <strong>Status:</strong> {{ total_frameworks }} aktive Frameworks, {{ total_relationships }} Framework-Beziehungen etabliert, {{ high_coverage|length }} High-Coverage Relationships (≥70%), {{ total_helped }} Anforderungen profitieren von transitiver Compliance.
    </div>

    <h3>Empfehlung 1: High-Coverage Relationships nutzen</h3>
    <div style="background: #C6EFCE; padding: 8px; margin: 5px 0; border-left: 3px solid #28A745; font-size: 9pt;">
        <strong>Priorität: Sehr Hoch - Quick Win</strong> - {{ high_coverage|length }} High-Coverage Relationships bieten sofortige Optimierung: Gemeinsame Kontroll-Dokumentation für gemappte Anforderungen, kombinierte Audit-Vorbereitung (1 Audit = 2+ Frameworks), Wiederverwendung von Nachweisen & Evidenzen. <strong>Zeitersparnis: {{ (high_coverage|reduce((carry, rel) => carry + (rel.mapped * 1.5), 0))|round }}h pro Audit-Zyklus</strong>
    </div>

    <h3>Empfehlung 2: Mapping-Lücken schließen</h3>
    {% set low_coverage = framework_relationships|filter(rel => rel.coverage < 50) %}
    <div style="background: #FFEB9C; padding: 8px; margin: 5px 0; border-left: 3px solid #FFA500; font-size: 9pt;">
        <strong>Priorität: Hoch</strong> - {{ low_coverage|length }} Framework-Beziehungen mit <50% Coverage benötigen Aufmerksamkeit{% if low_coverage|length > 0 %}: {% for rel in low_coverage|slice(0, 5) %}<strong>{{ rel.source.code }}→{{ rel.target.code }}</strong> ({{ rel.coverage }}%){% if not loop.last %}, {% endif %}{% endfor %}{% if low_coverage|length > 5 %} + {{ low_coverage|length - 5 }} weitere{% endif %}{% endif %}. <strong>Maßnahme:</strong> Mapping-Review & Vervollständigung. <strong>Nutzen:</strong> 20-30% Reduktion des Compliance-Aufwands
    </div>

    <h3>Empfehlung 3: Compliance-Hub etablieren</h3>
    <div style="background: #BDD7EE; padding: 8px; margin: 5px 0; border-left: 3px solid #2196F3; font-size: 9pt;">
        <strong>Strategische Initiative:</strong> Zentraler "Compliance Hub" für optimale Multi-Framework-Steuerung mit zentraler Kontroll-Bibliothek (eine Kontrolle → mehrere Frameworks), automatisches Mapping-Tracking, kombinierte Audit-Planung (Framework-übergreifend), Unified Reporting (ein Dashboard für alle Frameworks). <strong>Langfristiger ROI: 40-60% Reduktion des Gesamt-Compliance-Aufwands</strong>
    </div>

    <h3>Implementierungs-Roadmap</h3>
    <table style="width: 95%;">
        <thead>
            <tr>
                <th style="width: 20%;">Phase</th>
                <th style="width: 50%;">Aktivitäten</th>
                <th style="width: 15%;">Dauer</th>
                <th style="width: 15%;">Impact</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Phase 1 (Monat 1)</strong></td>
                <td style="font-size: 8pt;">
                    High-Coverage Relationships dokumentieren, gemeinsame Kontroll-Dokumentation erstellen, Pilotprojekt mit Top 3 Relationships starten
                </td>
                <td class="text-center">4 Wochen</td>
                <td class="text-center"><span class="badge badge-success">Hoch</span></td>
            </tr>
            <tr>
                <td><strong>Phase 2 (Monat 2-3)</strong></td>
                <td style="font-size: 8pt;">
                    Low-Coverage Mappings verbessern, Framework-Matrix vervollständigen, kombinierte Audit-Planung implementieren
                </td>
                <td class="text-center">8 Wochen</td>
                <td class="text-center"><span class="badge badge-warning">Mittel</span></td>
            </tr>
            <tr>
                <td><strong>Phase 3 (Monat 4-6)</strong></td>
                <td style="font-size: 8pt;">
                    Compliance Hub aufbauen, Automatisierung & Integration, Unified Reporting Dashboard
                </td>
                <td class="text-center">12 Wochen</td>
                <td class="text-center"><span class="badge badge-info">Sehr Hoch</span></td>
            </tr>
        </tbody>
    </table>

    <h3>Quick Win Scorecard</h3>
    <table style="width: 90%;">
        <thead>
            <tr>
                <th style="width: 40%;">Quick Win</th>
                <th style="width: 20%;">Aufwand</th>
                <th style="width: 20%;">Nutzen</th>
                <th style="width: 20%;">Priority</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Top 3 High-Coverage Relationships ausnutzen</td>
                <td class="text-center"><span class="badge badge-success">Niedrig</span></td>
                <td class="text-center"><span class="badge badge-success">Hoch</span></td>
                <td class="text-center">1</td>
            </tr>
            <tr>
                <td>Gemeinsame Kontroll-Dokumentation erstellen</td>
                <td class="text-center"><span class="badge badge-warning">Mittel</span></td>
                <td class="text-center"><span class="badge badge-success">Hoch</span></td>
                <td class="text-center">2</td>
            </tr>
            <tr>
                <td>Kombinierte Audit-Vorbereitung (2+ Frameworks)</td>
                <td class="text-center"><span class="badge badge-success">Niedrig</span></td>
                <td class="text-center"><span class="badge badge-warning">Mittel</span></td>
                <td class="text-center">3</td>
            </tr>
            <tr>
                <td>Framework-Matrix vervollständigen</td>
                <td class="text-center"><span class="badge badge-danger">Hoch</span></td>
                <td class="text-center"><span class="badge badge-success">Hoch</span></td>
                <td class="text-center">4</td>
            </tr>
        </tbody>
    </table>

    <div style="background: #E8F4F8; padding: 8px; margin-top: 10px; border-radius: 4px; font-size: 9pt;">
        <strong>Nächste Schritte (Start nächste Woche):</strong> (1) Top 3 High-Coverage Relationships identifizieren/priorisieren, (2) Template für gemeinsame Kontroll-Dokumentation erstellen, (3) Pilotprojekt mit erstem High-Coverage Relationship starten, (4) Stakeholder-Meeting für Multi-Framework-Strategie planen, (5) Ressourcen für Mapping-Vervollständigung allokieren, (6) Monatliches Transitive Compliance Review etablieren.
        <strong style="display: block; margin-top: 5px;">Pro-Tipp:</strong> Nächstes Audit als "Multi-Framework-Audit" für 2+ Frameworks gleichzeitig nutzen! Zeitersparnis: {{ (high_coverage|reduce((carry, rel) => carry + (rel.mapped * 1.5), 0))|round }}h.
    </div>
{% endblock %}
