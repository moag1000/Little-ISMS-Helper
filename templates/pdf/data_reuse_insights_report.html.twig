<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Data Reuse Insights - {{ framework.name }}</title>
    <style>
        @page {
            margin: 2cm 1.5cm;
        }

        body {
            font-family: DejaVu Sans, sans-serif;
            font-size: 9pt;
            line-height: 1.4;
            color: #333;
        }

        h1 {
            font-size: 18pt;
            color: #1a56db;
            text-align: center;
            margin-bottom: 5pt;
            border-bottom: 3px solid #1a56db;
            padding-bottom: 10pt;
        }

        h2 {
            font-size: 14pt;
            color: #1a56db;
            margin-top: 15pt;
            margin-bottom: 8pt;
            border-bottom: 1px solid #cbd5e1;
            padding-bottom: 5pt;
        }

        h3 {
            font-size: 11pt;
            color: #334155;
            margin-top: 12pt;
            margin-bottom: 6pt;
            font-weight: bold;
        }

        .header-info {
            text-align: center;
            font-size: 9pt;
            color: #64748b;
            margin-bottom: 20pt;
        }

        .stats-grid {
            display: table;
            width: 100%;
            margin-bottom: 20pt;
            border: 1px solid #cbd5e1;
            border-collapse: collapse;
        }

        .stats-row {
            display: table-row;
        }

        .stats-cell {
            display: table-cell;
            padding: 10pt;
            text-align: center;
            border: 1px solid #cbd5e1;
            width: 20%;
        }

        .stats-label {
            font-size: 8pt;
            color: #64748b;
            font-weight: bold;
            margin-bottom: 4pt;
        }

        .stats-value {
            font-size: 16pt;
            color: #1a56db;
            font-weight: bold;
        }

        .stats-value-success {
            color: #10b981;
        }

        .insight-box {
            background: #f8fafc;
            border-left: 4pt solid #1a56db;
            padding: 10pt;
            margin: 10pt 0;
            font-size: 8pt;
            color: #475569;
        }

        .quick-win-box {
            background: #f0fdf4;
            border-left: 4pt solid #10b981;
            padding: 10pt;
            margin: 10pt 0;
            font-size: 8pt;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10pt 0;
            font-size: 8pt;
        }

        table th {
            background-color: #1a56db;
            color: white;
            padding: 6pt;
            text-align: left;
            font-weight: bold;
            border: 1px solid #1e3a8a;
        }

        table td {
            padding: 5pt;
            border: 1px solid #cbd5e1;
            vertical-align: top;
        }

        table tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .badge {
            display: inline-block;
            padding: 2pt 6pt;
            border-radius: 3pt;
            font-size: 7pt;
            font-weight: bold;
        }

        .badge-success {
            background-color: #10b981;
            color: white;
        }

        .badge-warning {
            background-color: #f59e0b;
            color: white;
        }

        .badge-info {
            background-color: #3b82f6;
            color: white;
        }

        .badge-secondary {
            background-color: #6b7280;
            color: white;
        }

        .page-break {
            page-break-before: always;
        }

        .text-center {
            text-align: center;
        }

        .no-break {
            page-break-inside: avoid;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30pt;
            text-align: center;
            font-size: 7pt;
            color: #64748b;
            border-top: 1px solid #cbd5e1;
            padding-top: 5pt;
        }
    </style>
</head>
<body>
    <h1>Data Reuse Insights Report</h1>
    <div class="header-info">
        {{ framework.name }} ({{ framework.code }})<br>
        Generated: {{ pdf_generation_date|date('d.m.Y H:i') }}
    </div>

    {# Executive Summary #}
    <h2>Executive Summary</h2>
    <div class="stats-grid">
        <div class="stats-row">
            <div class="stats-cell">
                <div class="stats-label">Framework</div>
                <div class="stats-value">{{ framework.code }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Analyzed Requirements</div>
                <div class="stats-value">{{ total_requirements }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Time Savings (Hours)</div>
                <div class="stats-value stats-value-success">{{ total_time_savings|round(1) }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Time Savings (Days)</div>
                <div class="stats-value stats-value-success">{{ total_days_savings|round(1) }}</div>
            </div>
            <div class="stats-cell">
                <div class="stats-label">Avg. Reuse %</div>
                <div class="stats-value">{{ avg_reuse_percentage|round(1) }}%</div>
            </div>
        </div>
    </div>

    {# Top Reuse Potentials #}
    <h2>Top Reuse Potentials</h2>
    <div class="insight-box">
        Requirements with highest data reuse potential (≥50% reuse)
    </div>

    {% set high_reuse = data_reuse_analysis|filter(item => item.value.reuse_percentage >= 50)|sort((a, b) => b.value.reuse_percentage - a.value.reuse_percentage) %}

    <table>
        <thead>
            <tr>
                <th scope="col" style="width: 12%;">ID</th>
                <th scope="col" style="width: 28%;">Requirement</th>
                <th scope="col" style="width: 15%;">Category</th>
                <th scope="col" style="width: 15%;">Reusable Data</th>
                <th scope="col" style="width: 12%;">Reuse %</th>
                <th scope="col" style="width: 10%;">Time (h)</th>
                <th scope="col" style="width: 8%;">Conf.</th>
            </tr>
        </thead>
        <tbody>
            {% for item in high_reuse|slice(0, 20) %}
            {% set req = item.requirement %}
            {% set value = item.value %}
            {% set analysis = item.analysis %}
            <tr class="no-break">
                <td><strong>{{ req.requirementId }}</strong></td>
                <td style="font-size: 8pt;">{{ req.title|length > 50 ? (req.title|slice(0, 50) ~ '...') : req.title }}</td>
                <td><span class="badge badge-info">{{ req.category ?? '-' }}</span></td>
                <td class="text-center">{{ (analysis.reusable_data ?? [])|length }}</td>
                <td class="text-center">
                    {% if value.reuse_percentage >= 80 %}
                        <span class="badge badge-success">{{ value.reuse_percentage|round }}%</span>
                    {% elseif value.reuse_percentage >= 50 %}
                        <span class="badge badge-warning">{{ value.reuse_percentage|round }}%</span>
                    {% else %}
                        <span class="badge badge-secondary">{{ value.reuse_percentage|round }}%</span>
                    {% endif %}
                </td>
                <td class="text-center">{{ value.estimated_hours_saved|round(1) }}</td>
                <td class="text-center" style="font-size: 7pt;">{{ value.confidence ?? 'low' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {# Quick Wins #}
    <div class="page-break"></div>
    <h2>Quick Wins - Immediate Reuse Opportunities</h2>

    {% set quick_wins = data_reuse_analysis|filter(item => item.value.reuse_percentage >= 80 and item.value.confidence == 'high')|sort((a, b) => b.value.estimated_hours_saved - a.value.estimated_hours_saved) %}

    {% if quick_wins|length > 0 %}
    <div class="quick-win-box">
        <strong>{{ quick_wins|length }} Quick Win Opportunities Identified!</strong>
        <br>
        These requirements have ≥80% reuse potential with high confidence.
        Estimated total savings: <strong>{{ quick_wins|reduce((carry, item) => carry + item.value.estimated_hours_saved, 0)|round(1) }} hours</strong>
    </div>

    <table style="width: 90%;">
        <thead>
            <tr>
                <th scope="col" style="width: 15%;">ID</th>
                <th scope="col" style="width: 40%;">Requirement</th>
                <th scope="col" style="width: 25%;">Data Sources</th>
                <th scope="col" style="width: 10%;">Reuse %</th>
                <th scope="col" style="width: 10%;">Time (h)</th>
            </tr>
        </thead>
        <tbody>
            {% for item in quick_wins|slice(0, 10) %}
            {% set req = item.requirement %}
            {% set value = item.value %}
            {% set analysis = item.analysis %}
            {% set sources = [] %}
            {% if analysis.reusable_data is not empty %}
                {% for data in analysis.reusable_data %}
                    {% set sources = sources|merge([data.source ?? 'Unknown']) %}
                {% endfor %}
            {% endif %}
            <tr class="no-break">
                <td><strong>{{ req.requirementId }}</strong></td>
                <td style="font-size: 8pt;">{{ req.title }}</td>
                <td style="font-size: 7pt;">{{ sources|slice(0, 3)|join(', ') }}</td>
                <td class="text-center"><span class="badge badge-success">{{ value.reuse_percentage|round }}%</span></td>
                <td class="text-center"><strong>{{ value.estimated_hours_saved|round(1) }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="insight-box">
        No Quick Wins with ≥80% Reuse + High Confidence found. Focus on mid-term potentials (50-80%).
    </div>
    {% endif %}

    {# Recommendations #}
    <div class="page-break"></div>
    <h2>Recommendations for Data Reuse</h2>

    <h3>Strategy: Maximize Data Reuse</h3>
    <div class="insight-box">
        <strong>Status:</strong> {{ total_requirements }} requirements analyzed, {{ high_reuse|length }} with ≥50% reuse potential, {{ quick_wins|length }} Quick Wins identified. <strong>Total savings: {{ total_time_savings|round(1) }}h ({{ total_days_savings|round(1) }} days)</strong>
    </div>

    <h3>Recommendation 1: Realize Quick Wins Immediately (Week 1-2)</h3>
    <div class="quick-win-box insight-box">
        <strong>Priority: Very High</strong> - {{ quick_wins|length }} Quick Wins immediately actionable: Reuse documentation/evidence, set references to existing controls, leverage cross-framework mappings. <strong>Time savings: {{ quick_wins|reduce((carry, item) => carry + item.value.estimated_hours_saved, 0)|round(1) }}h</strong> | ROI: Very High
    </div>

    <h3>Recommendation 2: Leverage Mid-Term Potentials (Week 3-8)</h3>
    {% set medium_reuse = data_reuse_analysis|filter(item => item.value.reuse_percentage >= 50 and item.value.reuse_percentage < 80) %}
    <div style="background: #fffbeb; border-left: 4pt solid #f59e0b; padding: 10pt; margin: 10pt 0; font-size: 8pt;">
        <strong>Priority: High</strong> - {{ medium_reuse|length }} requirements with 50-80% reuse potential: Adapt/extend data, reuse templates, identify common control implementations. <strong>Time savings: {{ medium_reuse|reduce((carry, item) => carry + item.value.estimated_hours_saved, 0)|round(1) }}h</strong> | Effort: Medium
    </div>

    <h3>Recommendation 3: Build Data Repository (Long-term)</h3>
    <div class="insight-box">
        <strong>Strategic Initiative:</strong> Build central data repository with standardized templates, versioning & change tracking, automatic reuse opportunity identification, best-practice library. <strong>Long-term savings: 30-50% reduction in compliance effort</strong>
    </div>

    <h3>Implementation Plan</h3>
    <table style="width: 95%;">
        <thead>
            <tr>
                <th scope="col" style="width: 15%;">Timeframe</th>
                <th scope="col" style="width: 45%;">Activities</th>
                <th scope="col" style="width: 20%;">Expected Savings</th>
                <th scope="col" style="width: 20%;">Status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Week 1-2</strong></td>
                <td style="font-size: 8pt;">
                    Implement Quick Wins ({{ quick_wins|length }} req.), identify existing data/evidence, create cross-references
                </td>
                <td class="text-center"><strong>{{ quick_wins|reduce((carry, item) => carry + item.value.estimated_hours_saved, 0)|round(1) }}h</strong></td>
                <td class="text-center"><span class="badge badge-success">Start Now</span></td>
            </tr>
            <tr>
                <td><strong>Week 3-8</strong></td>
                <td style="font-size: 8pt;">
                    Leverage mid-term potentials ({{ medium_reuse|length }} req.), adapt/reuse templates, implement common controls
                </td>
                <td class="text-center"><strong>{{ medium_reuse|reduce((carry, item) => carry + item.value.estimated_hours_saved, 0)|round(1) }}h</strong></td>
                <td class="text-center"><span class="badge badge-warning">Planning</span></td>
            </tr>
            <tr>
                <td><strong>Month 3-6</strong></td>
                <td style="font-size: 8pt;">
                    Build data repository, establish standardization & versioning, establish automation
                </td>
                <td class="text-center"><strong>Long-term 30-50%</strong></td>
                <td class="text-center"><span class="badge badge-info">Vision</span></td>
            </tr>
        </tbody>
    </table>

    <div class="insight-box">
        <strong>Next Steps (Start This Week):</strong> (1) Prioritize Top 5 Quick Wins & assign owners, (2) Identify existing documentation/evidence, (3) Enter cross-references in compliance system, (4) Start template library, (5) Establish weekly review meeting.
        <br><strong>Pro Tip:</strong> Implement Top 3 Quick Wins within 2 weeks = {{ quick_wins|slice(0, 3)|reduce((carry, item) => carry + item.value.estimated_hours_saved, 0)|round(1) }}h savings!
    </div>

    <div class="footer">
        Data Reuse Insights Report - Generated on {{ pdf_generation_date|date('d.m.Y H:i:s') }} - Page <span class="pagenum"></span>
    </div>
</body>
</html>
