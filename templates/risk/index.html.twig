{% extends 'base.html.twig' %}
{% trans_default_domain 'risk' %}
{% import '_macros/inheritance_badge.html.twig' as inheritance %}

{% block title %}{{ 'risk.modern.header.title'|trans({}, 'risk')}} - {{ 'app.title'|trans({}, 'messages') }}{% endblock %}

{% block body %}
{# Breadcrumb Navigation #}
{% include '_components/_breadcrumb.html.twig' with {
    breadcrumbs: [
        { label: 'risk.modern.breadcrumb'|trans({}, 'risk')}
    ]
} %}

{# Page Header with Actions #}
{% include '_components/_page_header.html.twig' with {
    title: 'risk.modern.header.title'|trans({}, 'risk'),
    subtitle: 'risk.modern.header.subtitle'|trans({}, 'risk'),
    icon: 'bi-exclamation-triangle',
    actions: [
        { label: 'risk.modern.header.action.new'|trans({}, 'risk'), url: path('app_risk_new'), variant: 'primary', icon: 'bi-plus-circle' },
        { label: 'risk.modern.header.action.matrix'|trans({}, 'risk'), url: path('app_risk_matrix'), variant: 'info', icon: 'bi-grid-3x3' },
        { label: 'risk.modern.header.action.export_pdf'|trans({}, 'risk'), url: path('app_risk_export_pdf'), variant: 'danger', icon: 'bi-file-pdf', turbo: false },
        { label: 'risk.modern.header.action.export_excel'|trans({}, 'risk'), url: path('app_risk_export_excel'), variant: 'success', icon: 'bi-file-earmark-excel', turbo: false },
        { label: 'risk.modern.header.action.export_csv'|trans({}, 'risk'), url: path('app_risk_export'), variant: 'secondary', icon: 'bi-download', turbo: false }
    ]
} %}

{# View Filter #}
{% if currentTenant %}
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="get" action="{{ path('app_risk_index') }}" class="d-flex align-items-center gap-2">
            <label for="view-filter" class="mb-0 fw-bold">
                <i class="bi bi-eye" aria-hidden="true"></i> {{ 'common.view'|trans({}, 'messages') }}:
            </label>
            <select class="form-select form-select-sm" style="width: auto;" id="view-filter" name="view" data-controller="ui-actions" data-action="change->ui-actions#autoSubmit">
                <option value="own" {{ inheritanceInfo.currentView == 'own' ? 'selected' : '' }}>
                    {{ 'corporate.view.own_only'|trans({}, 'messages') }}
                </option>
                {% if inheritanceInfo.hasParent %}
                <option value="inherited" {{ inheritanceInfo.currentView == 'inherited' ? 'selected' : '' }}>
                    {{ 'corporate.view.including_inherited'|trans({}, 'messages') }}
                </option>
                {% endif %}
                {% if inheritanceInfo.hasSubsidiaries %}
                <option value="subsidiaries" {{ inheritanceInfo.currentView == 'subsidiaries' ? 'selected' : '' }}>
                    {{ 'corporate.view.including_subsidiaries'|trans({}, 'messages') }}
                </option>
                {% endif %}
            </select>
            <noscript>
                <button type="submit" class="btn btn-sm btn-secondary">{{ 'common.apply'|trans({}, 'messages') }}</button>
            </noscript>
        </form>
    </div>
</div>
{% endif %}

{# KPI Cards Grid #}
<div class="kpi-grid d-grid grid-responsive-250 gap-4 my-2rem">
    {% include '_components/_kpi_card.html.twig' with {
        icon: 'bi-exclamation-triangle',
        label: 'risk.modern.kpi.total'|trans({}, 'risk'),
        value: detailedStats.total,
        detail: currentTenant ? ('corporate.stats.breakdown'|trans({'%own%': detailedStats.own, '%inherited%': detailedStats.inherited, '%subsidiaries%': detailedStats.subsidiaries}, 'messages')) : null,
        variant: 'primary',
        link: '#all-risks'
    } %}

    {# ISO 27001 compliant thresholds #}
    {% set criticalRisks = risks|filter(r => r.getRiskScore() >= 20)|length %}
    {% include '_components/_kpi_card.html.twig' with {
        icon: 'bi-shield-fill-exclamation',
        label: 'risk.modern.kpi.critical'|trans({}, 'risk'),
        value: criticalRisks,
        variant: 'danger',
        trend: criticalRisks > 0 ? '-' : '+0',
        link: '#filter-critical'
    } %}

    {% set highRisks = risks|filter(r => r.getRiskScore() >= 12 and r.getRiskScore() < 20)|length %}
    {% include '_components/_kpi_card.html.twig' with {
        icon: 'bi-exclamation-circle',
        label: 'risk.modern.kpi.high'|trans({}, 'risk'),
        value: highRisks,
        variant: 'warning',
        link: '#filter-high'
    } %}

    {% set avgResidualRisk = risks|length > 0 ? (risks|reduce((carry, risk) => carry + risk.getResidualRiskLevel(), 0) / risks|length)|round(1) : 0 %}
    {% include '_components/_kpi_card.html.twig' with {
        icon: 'bi-graph-down',
        label: 'risk.modern.kpi.avg_residual'|trans({}, 'risk'),
        value: avgResidualRisk,
        unit: 'risk.modern.kpi.unit.max'|trans({}, 'risk'),
        variant: avgResidualRisk < 8 ? 'success' : 'warning'
    } %}
</div>

{# Risk Matrix Overview #}
{% embed '_components/_card.html.twig' with {
    'title': 'risk.modern.matrix_overview'|trans({}, 'risk'),
    'headerIcon': 'bi-grid-3x3',
    'actions': '<a href="' ~ path('app_risk_matrix') ~ '" class="btn btn-sm btn-outline-primary">' ~ ('risk.modern.view_full_matrix'|trans({}, 'risk')) ~ ' <i class="bi bi-arrow-right" aria-hidden="true"></i></a>',
    'class': 'mb-4'
} %}
    {% block card_body %}
        <div class="risk-matrix-preview">
            {# Risk Distribution by Severity #}
            <div class="row">
                <div class="col-md-3">
                    <div class="risk-level-card risk-critical">
                        <div class="risk-level-icon"><i class="bi bi-exclamation-circle text-danger" aria-hidden="true"></i></div>
                        <div class="risk-level-label">{{ 'risk.index.risk_level.critical'|trans({}, 'risk') }}</div>
                        <div class="risk-level-count">{{ risks|filter(r => r.getRiskScore() >= 20)|length }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="risk-level-card risk-high">
                        <div class="risk-level-icon">ðŸŸ </div>
                        <div class="risk-level-label">{{ 'risk.index.risk_level.high'|trans({}, 'risk') }}</div>
                        <div class="risk-level-count">{{ risks|filter(r => r.getRiskScore() >= 12 and r.getRiskScore() < 20)|length }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="risk-level-card risk-medium">
                        <div class="risk-level-icon">ðŸŸ¡</div>
                        <div class="risk-level-label">{{ 'risk.index.risk_level.medium'|trans({}, 'risk') }}</div>
                        <div class="risk-level-count">{{ risks|filter(r => r.getRiskScore() >= 6 and r.getRiskScore() < 12)|length }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="risk-level-card risk-low">
                        <div class="risk-level-icon">ðŸŸ¢</div>
                        <div class="risk-level-label">{{ 'risk.index.risk_level.low'|trans({}, 'risk') }}</div>
                        <div class="risk-level-count">{{ risks|filter(r => r.getRiskScore() < 6)|length }}</div>
                    </div>
                </div>
            </div>
        </div>
    {% endblock %}
{% endembed %}

{# Treatment Status #}
{% embed '_components/_card.html.twig' with {
    'title': 'risk.index.treatment_status'|trans({}, 'risk'),
    'headerIcon': 'bi-shield-check',
    'class': 'mb-4'
} %}
    {% block card_body %}
        <div class="row">
            {% set treatments = {
                'mitigate': { label: 'risk.index.treatment.mitigate'|trans({}, 'risk'), icon: 'bi-shield-check', color: 'success' },
                'accept': { label: 'risk.index.treatment.accept'|trans({}, 'risk'), icon: 'bi-check-circle', color: 'info' },
                'transfer': { label: 'risk.index.treatment.transfer'|trans({}, 'risk'), icon: 'bi-arrow-right-circle', color: 'warning' },
                'avoid': { label: 'risk.index.treatment.avoid'|trans({}, 'risk'), icon: 'bi-x-circle', color: 'danger' }
            } %}
            {% for strategy, data in treatments %}
                {% set count = risks|filter(r => r.treatmentStrategy == strategy)|length %}
                <div class="col-md-3 mb-3">
                    <div class="treatment-stat">
                        <div class="treatment-icon text-{{ data.color }}" aria-hidden="true">
                            <i class="bi {{ data.icon }}" aria-hidden="true"></i>
                        </div>
                        <div class="treatment-info">
                            <div class="treatment-label">{{ data.label }}</div>
                            <div class="treatment-count">{{ count }}</div>
                            {% if risks|length > 0 %}
                                <div class="treatment-percent">{{ (count / risks|length * 100)|round }}%</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endblock %}
{% endembed %}

{# Risk Filters #}
{% embed '_components/_card.html.twig' with {
    'title': 'risk.index.filter_options'|trans({}, 'risk'),
    'headerIcon': 'bi-funnel',
    'class': 'mb-4'
} %}
    {% block card_body %}
        <form method="get" action="{{ path('app_risk_index') }}" class="row g-3">
            <div class="col-md-3">
                <label for="filter-level" class="form-label">{{ 'risk.filter.level_label'|trans({}, 'risk') }}</label>
                <select class="form-select" id="filter-level" name="level" data-controller="ui-actions" data-action="change->ui-actions#autoSubmit">
                    <option value="">{{ 'risk.filter.all_risks'|trans({}, 'risk') }}</option>
                    <option value="critical" {{ app.request.query.get('level') == 'critical' ? 'selected' : '' }}>{{ 'risk.filter.level_critical'|trans({}, 'risk') }}</option>
                    <option value="high" {{ app.request.query.get('level') == 'high' ? 'selected' : '' }}>{{ 'risk.filter.level_high'|trans({}, 'risk') }}</option>
                    <option value="medium" {{ app.request.query.get('level') == 'medium' ? 'selected' : '' }}>{{ 'risk.filter.level_medium'|trans({}, 'risk') }}</option>
                    <option value="low" {{ app.request.query.get('level') == 'low' ? 'selected' : '' }}>{{ 'risk.filter.level_low'|trans({}, 'risk') }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter-status" class="form-label">{{ 'risk.filter.status_label'|trans({}, 'risk') }}</label>
                <select class="form-select" id="filter-status" name="status" data-controller="ui-actions" data-action="change->ui-actions#autoSubmit">
                    <option value="">{{ 'risk.filter.all_status'|trans({}, 'risk') }}</option>
                    <option value="identified" {{ app.request.query.get('status') == 'identified' ? 'selected' : '' }}>{{ 'risk.filter.status_identified'|trans({}, 'risk') }}</option>
                    <option value="assessed" {{ app.request.query.get('status') == 'assessed' ? 'selected' : '' }}>{{ 'risk.filter.status_assessed'|trans({}, 'risk') }}</option>
                    <option value="treated" {{ app.request.query.get('status') == 'treated' ? 'selected' : '' }}>{{ 'risk.filter.status_treated'|trans({}, 'risk') }}</option>
                    <option value="monitored" {{ app.request.query.get('status') == 'monitored' ? 'selected' : '' }}>{{ 'risk.filter.status_monitored'|trans({}, 'risk') }}</option>
                    <option value="closed" {{ app.request.query.get('status') == 'closed' ? 'selected' : '' }}>{{ 'risk.filter.status_closed'|trans({}, 'risk') }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter-treatment" class="form-label">{{ 'risk.filter.treatment_label'|trans({}, 'risk') }}</label>
                <select class="form-select" id="filter-treatment" name="treatment" data-controller="ui-actions" data-action="change->ui-actions#autoSubmit">
                    <option value="">{{ 'risk.filter.all_strategies'|trans({}, 'risk') }}</option>
                    <option value="mitigate" {{ app.request.query.get('treatment') == 'mitigate' ? 'selected' : '' }}>{{ 'risk.index.treatment.mitigate'|trans({}, 'risk') }}</option>
                    <option value="accept" {{ app.request.query.get('treatment') == 'accept' ? 'selected' : '' }}>{{ 'risk.index.treatment.accept'|trans({}, 'risk') }}</option>
                    <option value="transfer" {{ app.request.query.get('treatment') == 'transfer' ? 'selected' : '' }}>{{ 'risk.index.treatment.transfer'|trans({}, 'risk') }}</option>
                    <option value="avoid" {{ app.request.query.get('treatment') == 'avoid' ? 'selected' : '' }}>{{ 'risk.index.treatment.avoid'|trans({}, 'risk') }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter-owner" class="form-label">{{ 'risk.filter.owner_label'|trans({}, 'risk') }}</label>
                <input type="text" class="form-control" id="filter-owner" name="owner"
                       value="{{ app.request.query.get('owner') }}"
                       placeholder="{{ 'risk.filter.owner_placeholder'|trans({}, 'risk') }}">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search" aria-hidden="true"></i> {{ 'common.filter'|trans({}, 'messages') }}
                </button>
                <a href="{{ path('app_risk_index') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle" aria-hidden="true"></i> {{ 'common.reset'|trans({}, 'messages') }}
                </a>
            </div>
        </form>
    {% endblock %}
{% endembed %}

{# Risks Table or Empty State #}
{% if risks|length == 0 %}
    {% include '_components/_empty_state.html.twig' with {
        icon: 'bi-exclamation-triangle',
        title: 'risk.index.empty.title'|trans({}, 'risk'),
        description: 'risk.index.empty.description'|trans({}, 'risk'),
        action: { label: 'risk.index.empty.action'|trans({}, 'risk'), url: path('app_risk_new'), icon: 'bi-plus-circle' }
    } %}
{% else %}
<div class="card" data-controller="bulk-actions" data-bulk-actions-endpoint-value="/risk">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="mb-0"><i class="bi bi-list" aria-hidden="true"></i> {{ 'risk.index.all_risks'|trans({}, 'risk') }} ({{ risks|length }})</h3>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm w-150px" id="risk-filter" aria-label="{{ 'risk.filter.level_label'|trans({}, 'risk') }}">
                <option value="">{{ 'risk.filter.all_risks'|trans({}, 'risk') }}</option>
                <option value="critical">{{ 'risk.modern.kpi.critical'|trans({}, 'risk') }}</option>
                <option value="high">{{ 'risk.modern.kpi.high'|trans({}, 'risk') }}</option>
                <option value="medium">{{ 'risk.index.risk_level.medium'|trans({}, 'risk') }}</option>
                <option value="low">{{ 'risk.index.risk_level.low'|trans({}, 'risk') }}</option>
            </select>
            <label for="risk-search" class="visually-hidden">{{ 'common.search'|trans({}, 'messages') }}</label>
            <input type="search"
                   class="form-control form-control-sm w-200px"
                   placeholder="{{ 'common.search'|trans({}, 'messages') }}..."
                   id="risk-search"
                   aria-label="{{ 'common.search'|trans({}, 'messages') }}">
        </div>
    </div>
    {% embed '_components/_table.html.twig' with {
        'class': 'table-hover mb-0',
        'noMargin': true,
        'responsive': true
    } %}
        {% block table_head %}
            <tr>
                <th scope="col" class="w-40px">
                    <input type="checkbox"
                           class="form-check-input"
                           data-action="bulk-actions#selectAll"
                           data-bulk-actions-target="selectAllCheckbox"
                           aria-label="{{ 'risk.index.table.select_all'|trans({}, 'risk') }}">
                </th>
                <th scope="col">{{ 'risk.index.table.title'|trans({}, 'risk') }}</th>
                <th scope="col">{{ 'risk.index.table.threat'|trans({}, 'risk') }}</th>
                <th scope="col" class="text-center">{{ 'risk.index.table.probability'|trans({}, 'risk') }}</th>
                <th scope="col" class="text-center">{{ 'risk.index.table.impact'|trans({}, 'risk') }}</th>
                <th scope="col" class="text-center">{{ 'risk.index.table.risk_score'|trans({}, 'risk') }}</th>
                <th scope="col" class="text-center">{{ 'risk.index.table.residual_risk'|trans({}, 'risk') }}</th>
                <th scope="col">{{ 'risk.index.table.treatment'|trans({}, 'risk') }}</th>
                <th scope="col" class="text-center">{{ 'risk.index.table.risk_subject'|trans({}, 'risk') }}</th>
                <th scope="col" class="text-center">{{ 'risk.index.table.actions'|trans({}, 'risk') }}</th>
            </tr>
        {% endblock %}
        {% block table_body %}
            {% import '_macros/inheritance_badge.html.twig' as inheritance %}
            {% for risk in risks %}
            {% set riskScore = risk.getRiskScore() %}
            {% set residual = risk.getResidualRiskLevel() %}
            <tr data-risk-id="{{ risk.id }}"
                data-risk-level="{{ riskScore >= 20 ? 'critical' : (riskScore >= 12 ? 'high' : (riskScore >= 6 ? 'medium' : 'low')) }}">
                <td>
                    <input type="checkbox"
                           class="form-check-input"
                           data-bulk-actions-target="item"
                           data-action="bulk-actions#selectItem"
                           value="{{ risk.id }}">
                </td>
                <td>
                    <strong>{{ risk.title }}</strong>
                    {{ inheritance.small_badge(risk, currentTenant) }}
                    {% if risk.description %}
                    <br><small class="text-muted">{{ risk.description|length > 60 ? risk.description|slice(0, 60) ~ '...' : risk.description }}</small>
                    {% endif %}
                </td>
                <td>
                    <span class="badge bg-secondary">{{ risk.threat }}</span>
                </td>
                <td class="text-center">
                    <span class="{{ badge_score(risk.probability) }}">
                        {{ risk.probability }}/5
                    </span>
                </td>
                <td class="text-center">
                    <span class="{{ badge_score(risk.impact) }}">
                        {{ risk.impact }}/5
                    </span>
                </td>
                <td class="text-center">
                    <span class="risk-score risk-score-{{ riskScore >= 20 ? 'critical' : (riskScore >= 12 ? 'high' : (riskScore >= 6 ? 'medium' : 'low')) }}">
                        {{ riskScore }}
                    </span>
                </td>
                <td class="text-center">
                    {% if residual < riskScore %}
                        <span class="risk-score risk-score-improved">
                            {{ residual }}
                            <i class="bi bi-arrow-down text-success" aria-hidden="true"></i>
                        </span>
                    {% else %}
                        <span class="risk-score">{{ residual }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if risk.treatmentStrategy %}
                        <span class="badge bg-info">{{ ('risk.index.treatment.' ~ risk.treatmentStrategy)|trans({}, 'risk') }}</span>
                    {% else %}
                        <span class="text-muted">{{ 'risk.index.table.not_defined'|trans({}, 'risk') }}</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if risk.asset %}
                        <a href="{{ path('app_asset_show', {id: risk.asset.id}) }}" class="badge bg-primary" title="{{ risk.asset.name }}">
                            <i class="bi bi-cpu" aria-hidden="true"></i> {{ 'risk.index.table.asset'|trans({}, 'risk') }}
                        </a>
                    {% elseif risk.person %}
                        <a href="{{ path('app_person_show', {id: risk.person.id}) }}" class="badge bg-info" title="{{ risk.person.fullName }}">
                            <i class="bi bi-person" aria-hidden="true"></i> {{ 'risk.index.table.person'|trans({}, 'risk') }}
                        </a>
                    {% elseif risk.location %}
                        <a href="{{ path('app_location_show', {id: risk.location.id}) }}" class="badge bg-warning text-dark" title="{{ risk.location.name }}">
                            <i class="bi bi-geo-alt" aria-hidden="true"></i> {{ 'risk.index.table.location'|trans({}, 'risk') }}
                        </a>
                    {% elseif risk.supplier %}
                        <a href="{{ path('app_supplier_show', {id: risk.supplier.id}) }}" class="badge bg-success" title="{{ risk.supplier.name }}">
                            <i class="bi bi-truck" aria-hidden="true"></i> {{ 'risk.index.table.supplier'|trans({}, 'risk') }}
                        </a>
                    {% else %}
                        <span class="badge bg-secondary">{{ 'risk.index.table.none'|trans({}, 'risk') }}</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group" aria-label="{{ 'common.actions'|trans({}, 'messages') }}">
                        <a href="{{ path('app_risk_show', {id: risk.id}) }}"
                           class="btn btn-outline-primary"
                           data-turbo-action="advance"
                           title="{{ 'common.view'|trans({}, 'messages') }}" aria-label="{{ 'common.view'|trans({}, 'messages') }}">
                            <i class="bi bi-eye" aria-hidden="true"></i>
                        </a>
                        {% if is_granted('ROLE_USER') %}
                        <a href="{{ path('app_risk_edit', {id: risk.id}) }}"
                           class="btn btn-outline-secondary"
                           data-turbo-action="advance"
                           title="{{ 'common.edit'|trans({}, 'messages') }}" aria-label="{{ 'common.edit'|trans({}, 'messages') }}">
                            <i class="bi bi-pencil" aria-hidden="true"></i>
                        </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        {% endblock %}
    {% endembed %}

    {# Bulk Action Bar #}
    {% include '_components/_bulk_action_bar.html.twig' with {
        actions: ['export', 'assign', 'delete']
    } %}
</div>
{% endif %}

<style>
/* Risk Level Cards */
.risk-level-card {
    text-align: center;
    padding: var(--spacing-lg);
    background: white;
    border-radius: var(--border-radius);
    border: 2px solid var(--color-border);
    transition: all 0.2s;
}

.risk-level-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
}

.risk-level-card.risk-critical { border-color: var(--color-danger); }
.risk-level-card.risk-high { border-color: #ff9800; }
.risk-level-card.risk-medium { border-color: var(--color-warning); }
.risk-level-card.risk-low { border-color: var(--color-success); }

.risk-level-icon {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-sm);
}

.risk-level-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
}

.risk-level-count {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-primary);
}

/* Treatment Stats */
.treatment-stat {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--color-bg);
    border-radius: var(--border-radius);
}

.treatment-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    background: white;
    border-radius: 50%;
}

.treatment-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.treatment-count {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
}

.treatment-percent {
    font-size: 0.75rem;
    color: var(--color-text-muted);
}

/* Risk Score Badges */
.risk-score {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 36px;
    font-weight: 700;
    font-size: 1rem;
    border-radius: 8px;
    padding: 0 8px;
}

.risk-score-critical {
    background: var(--color-danger);
    color: white;
}

.risk-score-high {
    background: #ff9800;
    color: white;
}

.risk-score-medium {
    background: var(--color-warning);
    color: white;
}

.risk-score-low {
    background: var(--color-success);
    color: white;
}

.risk-score-improved {
    background: #e8f5e9;
    color: var(--color-success);
}
</style>

{# Search & Filter functionality #}
<script>
// Search
document.getElementById('risk-search')?.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr[data-risk-id]');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });
});

// Filter by level
document.getElementById('risk-filter')?.addEventListener('change', function(e) {
    const level = e.target.value;
    const rows = document.querySelectorAll('tbody tr[data-risk-id]');

    rows.forEach(row => {
        if (!level || row.dataset.riskLevel === level) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});
</script>

{% endblock %}
