{#
    Risk Form Partial (Accessible)
    Used by both new.html.twig and edit.html.twig
    WCAG 2.1 AA Compliant
#}

{# Basic Information #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-info-circle" aria-hidden="true"></i>
        {{ 'risk.section.basic_info'|trans({}, 'risk') }}
    </legend>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.title,
                'label': 'risk.field.title'|trans({}, 'risk'),
                'help': 'risk.help.title'|trans({}, 'risk'),
                'required': true
            } %}
        </div>

        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.asset,
                'label': 'risk.field.asset'|trans({}, 'risk'),
                'help': 'risk.help.asset'|trans({}, 'risk')
            } %}
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            {% include '_components/_form_field.html.twig' with {
                'field': form.description,
                'label': 'risk.field.description'|trans({}, 'risk'),
                'help': 'risk.help.description'|trans({}, 'risk')
            } %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.threat,
                'label': 'risk.field.threat'|trans({}, 'risk'),
                'help': 'risk.help.threat'|trans({}, 'risk')
            } %}
        </div>

        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.vulnerability,
                'label': 'risk.field.vulnerability'|trans({}, 'risk'),
                'help': 'risk.help.vulnerability'|trans({}, 'risk')
            } %}
        </div>
    </div>
</fieldset>

{# GDPR/DSGVO Data Protection Fields (Priority 2.2) #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-shield-lock" aria-hidden="true"></i>
        {{ 'risk.section.gdpr_assessment'|trans({}, 'risk') }}
    </legend>

    <div class="alert alert-info" role="status">
        <i class="bi bi-info-circle" aria-hidden="true"></i>
        {{ 'risk.help.gdpr_section'|trans({}, 'risk') }}
    </div>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.involvesPersonalData,
                'label': 'risk.field.involves_personal_data'|trans({}, 'risk'),
                'help': 'risk.help.involves_personal_data'|trans({}, 'risk')
            } %}
        </div>

        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.involvesSpecialCategoryData,
                'label': 'risk.field.involves_special_category_data'|trans({}, 'risk'),
                'help': 'risk.help.involves_special_category_data'|trans({}, 'risk')
            } %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.legalBasis,
                'label': 'risk.field.legal_basis'|trans({}, 'risk'),
                'help': 'risk.help.legal_basis'|trans({}, 'risk')
            } %}
        </div>

        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.processingScale,
                'label': 'risk.field.processing_scale'|trans({}, 'risk'),
                'help': 'risk.help.processing_scale'|trans({}, 'risk')
            } %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.requiresDPIA,
                'label': 'risk.field.requires_dpia'|trans({}, 'risk'),
                'help': 'risk.help.requires_dpia'|trans({}, 'risk')
            } %}
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            {% include '_components/_form_field.html.twig' with {
                'field': form.dataSubjectImpact,
                'label': 'risk.field.data_subject_impact'|trans({}, 'risk'),
                'help': 'risk.help.data_subject_impact'|trans({}, 'risk')
            } %}
        </div>
    </div>
</fieldset>

{# Inherent Risk (Brutto-Risiko) #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-exclamation-diamond" aria-hidden="true"></i>
        {{ 'risk.section.inherent_risk'|trans({}, 'risk') }}
    </legend>

    <div class="alert alert-info" role="status">
        <i class="bi bi-info-circle" aria-hidden="true"></i>
        {{ 'risk.help.inherent'|trans({}, 'risk') }}
    </div>

    {# Risk Assessment Guidance Helper (Priority 2.3) #}
    <div class="card border-primary mb-3">
        <div class="card-header bg-primary-subtle"><h5 class="mb-0">
                <button class="btn btn-link text-decoration-none p-0 w-100 text-start"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#riskAssessmentGuidance"
                        aria-expanded="false"
                        aria-controls="riskAssessmentGuidance">
                    <i class="bi bi-question-circle-fill text-primary" aria-hidden="true"></i>
                    {{ 'risk.guidance.title'|trans({}, 'risk') }}
                    <i class="bi bi-chevron-down float-end" aria-hidden="true"></i>
                </button>
            </h5>
        </div>
        <div class="collapse" id="riskAssessmentGuidance">
            <div class="card-body">
                <p class="text-muted mb-3">
                    {{ 'risk.guidance.intro'|trans({}, 'risk') }}
                </p>

                {# Probability Scale #}
                <h6 class="fw-bold mb-2">
                    <i class="bi bi-graph-up" aria-hidden="true"></i>
                    {{ 'risk.guidance.probability_title'|trans({}, 'risk') }}
                </h5>
                <div class="mb-4">
                    {% embed '_components/_table.html.twig' with {
                        'class': 'table-sm table-bordered',
                        'noMargin': true,
                        'responsive': true
                    } %}
                        {% block table_head %}
                            <tr>
                                <th style="width: 25%;">{{ 'risk.guidance.scale'|trans({}, 'risk') }}</th>
                                <th>{{ 'risk.guidance.description'|trans({}, 'risk') }}</th>
                            </tr>
                        {% endblock %}
                        {% block table_body %}
                            <tr>
                                <td><strong>1 - {{ 'risk.guidance.probability.very_unlikely'|trans({}, 'risk') }}</strong></td>
                                <td>{{ 'risk.guidance.probability.very_unlikely_desc'|trans({}, 'risk') }}</td>
                            </tr>
                            <tr>
                                <td><strong>2 - {{ 'risk.guidance.probability.unlikely'|trans({}, 'risk') }}</strong></td>
                                <td>{{ 'risk.guidance.probability.unlikely_desc'|trans({}, 'risk') }}</td>
                            </tr>
                            <tr>
                                <td><strong>3 - {{ 'risk.guidance.probability.possible'|trans({}, 'risk') }}</strong></td>
                                <td>{{ 'risk.guidance.probability.possible_desc'|trans({}, 'risk') }}</td>
                            </tr>
                            <tr>
                                <td><strong>4 - {{ 'risk.guidance.probability.likely'|trans({}, 'risk') }}</strong></td>
                                <td>{{ 'risk.guidance.probability.likely_desc'|trans({}, 'risk') }}</td>
                            </tr>
                            <tr>
                                <td><strong>5 - {{ 'risk.guidance.probability.very_likely'|trans({}, 'risk') }}</strong></td>
                                <td>{{ 'risk.guidance.probability.very_likely_desc'|trans({}, 'risk') }}</td>
                            </tr>
                        {% endblock %}
                    {% endembed %}
                </div>

                {# Impact Scale #}
                <h6 class="fw-bold mb-2">
                    <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                    {{ 'risk.guidance.impact_title'|trans({}, 'risk') }}
                </h5>
                {% embed '_components/_table.html.twig' with {
                    'class': 'table-sm table-bordered',
                    'noMargin': true,
                    'responsive': true
                } %}
                    {% block table_head %}
                        <tr>
                            <th style="width: 25%;">{{ 'risk.guidance.scale'|trans({}, 'risk') }}</th>
                            <th>{{ 'risk.guidance.description'|trans({}, 'risk') }}</th>
                        </tr>
                    {% endblock %}
                    {% block table_body %}
                        <tr>
                            <td><strong>1 - {{ 'risk.guidance.impact.negligible'|trans({}, 'risk') }}</strong></td>
                            <td>{{ 'risk.guidance.impact.negligible_desc'|trans({}, 'risk') }}</td>
                        </tr>
                        <tr>
                            <td><strong>2 - {{ 'risk.guidance.impact.minor'|trans({}, 'risk') }}</strong></td>
                            <td>{{ 'risk.guidance.impact.minor_desc'|trans({}, 'risk') }}</td>
                        </tr>
                        <tr>
                            <td><strong>3 - {{ 'risk.guidance.impact.moderate'|trans({}, 'risk') }}</strong></td>
                            <td>{{ 'risk.guidance.impact.moderate_desc'|trans({}, 'risk') }}</td>
                        </tr>
                        <tr>
                            <td><strong>4 - {{ 'risk.guidance.impact.major'|trans({}, 'risk') }}</strong></td>
                            <td>{{ 'risk.guidance.impact.major_desc'|trans({}, 'risk') }}</td>
                        </tr>
                        <tr>
                            <td><strong>5 - {{ 'risk.guidance.impact.catastrophic'|trans({}, 'risk') }}</strong></td>
                            <td>{{ 'risk.guidance.impact.catastrophic_desc'|trans({}, 'risk') }}</td>
                        </tr>
                    {% endblock %}
                {% endembed %}

                <div class="alert alert-warning mt-3 mb-0" role="status">
                    <small>
                        <i class="bi bi-lightbulb" aria-hidden="true"></i>
                        {{ 'risk.guidance.tip'|trans({}, 'risk') }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.probability,
                'label': 'risk.field.probability'|trans({}, 'risk'),
                'help': 'risk.help.probability'|trans({}, 'risk'),
                'required': true
            } %}
        </div>

        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.impact,
                'label': 'risk.field.impact'|trans({}, 'risk'),
                'help': 'risk.help.impact'|trans({}, 'risk'),
                'required': true
            } %}
        </div>
    </div>
</fieldset>

{# Residual Risk (Netto-Risiko) #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-shield-check" aria-hidden="true"></i>
        {{ 'risk.section.residual_risk'|trans({}, 'risk') }}
    </legend>

    <div class="alert alert-info" role="status">
        <i class="bi bi-info-circle" aria-hidden="true"></i>
        {{ 'risk.help.residual'|trans({}, 'risk') }}
    </div>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.residualProbability,
                'label': 'risk.field.residual_probability'|trans({}, 'risk'),
                'help': 'risk.help.residual_probability'|trans({}, 'risk')
            } %}
        </div>

        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.residualImpact,
                'label': 'risk.field.residual_impact'|trans({}, 'risk'),
                'help': 'risk.help.residual_impact'|trans({}, 'risk')
            } %}
        </div>
    </div>
</fieldset>

{# Treatment Strategy #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-clipboard-check" aria-hidden="true"></i>
        {{ 'risk.section.treatment'|trans({}, 'risk') }}
    </legend>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.treatmentStrategy,
                'label': 'risk.field.treatment_strategy'|trans({}, 'risk'),
                'help': 'risk.help.treatment_strategy'|trans({}, 'risk')
            } %}
        </div>

        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.riskOwner,
                'label': 'risk.field.risk_owner'|trans({}, 'risk'),
                'help': 'risk.help.risk_owner'|trans({}, 'risk')
            } %}
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            {% include '_components/_form_field.html.twig' with {
                'field': form.treatmentDescription,
                'label': 'risk.field.treatment_description'|trans({}, 'risk'),
                'help': 'risk.help.treatment_description'|trans({}, 'risk')
            } %}
        </div>
    </div>
</fieldset>

{# Risk Acceptance #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-check-circle" aria-hidden="true"></i>
        {{ 'risk.section.acceptance'|trans({}, 'risk') }}
    </legend>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.acceptanceApprovedBy,
                'label': 'risk.field.acceptance_approved_by'|trans({}, 'risk'),
                'help': 'risk.help.acceptance_approved_by'|trans({}, 'risk')
            } %}
        </div>

        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.acceptanceApprovedAt,
                'label': 'risk.field.acceptance_approved_at'|trans({}, 'risk'),
                'help': 'risk.help.acceptance_approved_at'|trans({}, 'risk')
            } %}
        </div>
    </div>
</fieldset>

{# Form Actions #}
<div class="form-actions d-flex gap-2 justify-content-end">
    <a href="{{ path('app_risk_index') }}"
       class="btn btn-secondary">
        <i class="bi bi-x-circle" aria-hidden="true"></i>
        {{ 'common.cancel'|trans({}, 'messages') }}
    </a>

    <button type="submit" class="btn btn-primary">
        <i class="{{ button_icon|default('bi-save') }}" aria-hidden="true"></i>
        {{ button_label|default('common.save'|trans({}, 'messages')) }}
    </button>
</div>
