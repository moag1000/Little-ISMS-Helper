<!DOCTYPE html>
<html lang="{{ app.request.locale }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="turbo-cache-control" content="no-cache">
    <title>{% block title %}{{ 'app.title'|trans }}{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="{{ asset('favicon.svg') }}">

    {% block stylesheets %}
        {# Bootstrap CSS - Required for Bootstrap classes used throughout the app #}
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

        {# Bootstrap Icons - Loaded via CDN due to AssetMapper issue #52620 with fonts/ subfolder #}
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha384-XGjxtQfXaH2tnPFa9x+ruJTuLE3Aa6LhHSWRr1XeTyhezb4abCG4ccI5AkVDxqC+" crossorigin="anonymous">

        {# Custom styles - Loaded via AssetMapper with automatic versioning #}
        {{ importmap('styles') }}
        <style>
            /* Turbo Progress Bar - Cyberpunk Style */
            .turbo-progress-bar {
                position: fixed;
                display: block;
                top: 0;
                left: 0;
                height: 3px;
                background: linear-gradient(90deg, #06b6d4, #ec4899, #8b5cf6);
                z-index: var(--z-turbo-bar);
                transition: width 300ms ease-out, opacity 150ms 150ms ease-in;
                transform: translate3d(0, 0, 0);
                box-shadow: 0 0 10px rgba(6, 182, 212, 0.6),
                            0 0 20px rgba(236, 72, 153, 0.4),
                            0 0 30px rgba(139, 92, 246, 0.3);
            }

            /* Loading state for body */
            body.turbo-loading {
                cursor: wait;
            }

            body.turbo-loading * {
                pointer-events: none;
            }

            /* Alert auto-fade */
            #notifications .alert {
                transition: opacity 0.15s linear;
            }

            #notifications .alert.fade:not(.show) {
                opacity: 0;
            }
        </style>
    {% endblock %}
</head>
<body data-turbo="true" data-controller="modal-manager sidebar-toggle">
    {# Skip Links for Accessibility - WCAG 2.4.1 #}
    <a href="#main-content" class="skip-link">{{ 'accessibility.skip_to_content'|trans }}</a>
    <a href="#main-navigation" class="skip-link">{{ 'accessibility.skip_to_navigation'|trans }}</a>

    <header class="header" role="banner">
        <div class="header-container">
            <div class="header-logo">
                <button class="mobile-menu-btn"
                        data-action="click->sidebar-toggle#toggle"
                        aria-label="Toggle navigation menu"
                        aria-expanded="false"
                        data-sidebar-toggle-target="menuBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <img src="{{ asset('favicon.svg') }}" alt="Little ISMS Helper Logo" width="40" height="40">
                <div>
                    <h1>{{ 'app.title'|trans }}</h1>
                    <p>{{ 'app.subtitle'|trans }}</p>
                </div>
            </div>
            <div class="header-actions">
                {# Global Search Component (Button + Modal) #}
                {% include '_components/_global_search.html.twig' %}

                <div class="language-switcher">
                    <a href="{{ path(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')|merge({'_locale': 'de'})) }}"
                       class="lang-btn {% if app.request.locale == 'de' %}active{% endif %}">DE</a>
                    <a href="{{ path(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')|merge({'_locale': 'en'})) }}"
                       class="lang-btn {% if app.request.locale == 'en' %}active{% endif %}">EN</a>
                </div>
            </div>
        </div>
    </header>

    {% set current_route = app.request.get('_route') %}

    {# Main App Layout with Sidebar #}
    <div class="app-layout">
        {# Mobile Sidebar Backdrop #}
        <div class="sidebar-backdrop" data-sidebar-toggle-target="backdrop" data-action="click->sidebar-toggle#close"></div>

        {# Sidebar Navigation #}
        <aside class="app-sidebar" role="complementary" aria-label="Main navigation" data-sidebar-toggle-target="sidebar">
            <nav id="main-navigation" role="navigation">
                <ul>
                    <li><a href="{{ path('app_home') }}" class="{% if current_route starts with 'app_home' %}active{% endif %}" {% if current_route starts with 'app_home' %}aria-current="page"{% endif %} data-turbo-action="advance">
                        <i class="bi bi-house" aria-hidden="true"></i>
                        <span>{{ 'nav.home'|trans }}</span>
                    </a></li>
                    <li><a href="{{ path('app_dashboard') }}" class="{% if current_route starts with 'app_dashboard' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-speedometer2" aria-hidden="true"></i>
                        <span>{{ 'nav.dashboard'|trans }}</span>
                    </a></li>
                    <li><a href="{{ path('app_analytics_dashboard') }}" class="{% if current_route starts with 'app_analytics_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-graph-up" aria-hidden="true"></i>
                        <span>{{ 'nav.analytics'|trans }}</span>
                    </a></li>

                    {# ISMS Core #}
                    {% if is_module_active('core') or is_module_active('controls') %}
                    <li class="nav-divider">ISMS Core</li>
                    {% endif %}
                    {% if is_module_active('core') %}
                    <li><a href="{{ path('app_context_index') }}" class="{% if current_route starts with 'app_context_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-diagram-3" aria-hidden="true"></i>
                        <span>{{ 'nav.context'|trans }}</span>
                    </a></li>
                    <li><a href="{{ path('app_interested_party_index') }}" class="{% if current_route starts with 'app_interested_party_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-people-fill" aria-hidden="true"></i>
                        <span>{{ 'nav.interested_parties'|trans }}</span>
                    </a></li>
                    {% endif %}
                    {% if is_module_active('controls') %}
                    <li><a href="{{ path('app_soa_index') }}" class="{% if current_route starts with 'app_soa_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-shield-check" aria-hidden="true"></i>
                        <span>{{ 'nav.soa'|trans }}</span>
                    </a></li>
                    {% endif %}

                    {# Assets & Risk #}
                    {% if is_module_active('assets') or is_module_active('risks') %}
                    <li class="nav-divider">Assets & Risk</li>
                    {% endif %}
                    {% if is_module_active('assets') %}
                    <li><a href="{{ path('app_asset_index') }}" class="{% if current_route starts with 'app_asset_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-cpu" aria-hidden="true"></i>
                        <span>{{ 'nav.assets'|trans }}</span>
                    </a></li>
                    <li><a href="{{ path('app_supplier_index') }}" class="{% if current_route starts with 'app_supplier_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-truck" aria-hidden="true"></i>
                        <span>{{ 'nav.suppliers'|trans }}</span>
                    </a></li>
                    {% endif %}
                    {% if is_module_active('risks') %}
                    <li><a href="{{ path('app_risk_index') }}" class="{% if current_route starts with 'app_risk_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                        <span>{{ 'nav.risks'|trans }}</span>
                    </a></li>
                    {% endif %}

                    {# BCM #}
                    {% if is_module_active('bcm') %}
                    <li class="nav-divider">Business Continuity</li>
                    <li><a href="{{ path('app_business_process_index') }}" class="{% if current_route starts with 'app_business_process_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-diagram-2" aria-hidden="true"></i>
                        <span>{{ 'nav.bcm'|trans }}</span>
                    </a></li>
                    <li><a href="{{ path('app_bc_plan_index') }}" class="{% if current_route starts with 'app_bc_plan_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-file-earmark-text" aria-hidden="true"></i>
                        <span>{{ 'nav.bc_plans'|trans }}</span>
                    </a></li>
                    <li><a href="{{ path('app_bc_exercise_index') }}" class="{% if current_route starts with 'app_bc_exercise_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-flag" aria-hidden="true"></i>
                        <span>{{ 'nav.bc_exercises'|trans }}</span>
                    </a></li>
                    {% endif %}

                    {# Operations #}
                    {% if is_module_active('core') or is_module_active('incidents') %}
                    <li class="nav-divider">Operations</li>
                    {% endif %}
                    {% if is_module_active('core') %}
                    <li><a href="{{ path('app_change_request_index') }}" class="{% if current_route starts with 'app_change_request_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-arrow-left-right" aria-hidden="true"></i>
                        <span>{{ 'nav.change_requests'|trans }}</span>
                    </a></li>
                    {% endif %}
                    {% if is_module_active('incidents') %}
                    <li><a href="{{ path('app_incident_index') }}" class="{% if current_route starts with 'app_incident_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-bug" aria-hidden="true"></i>
                        <span>{{ 'nav.incidents'|trans }}</span>
                    </a></li>
                    {% endif %}

                    {# Compliance #}
                    {% if is_module_active('audits') or is_module_active('compliance') or is_module_active('audit_logging') %}
                    <li class="nav-divider">Compliance</li>
                    {% endif %}
                    {% if is_module_active('audits') %}
                    <li><a href="{{ path('app_audit_index') }}" class="{% if current_route starts with 'app_audit_' and not current_route starts with 'app_audit_log_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-clipboard-check" aria-hidden="true"></i>
                        <span>{{ 'nav.audits'|trans }}</span>
                    </a></li>
                    {% endif %}
                    {% if is_module_active('compliance') %}
                    {% set compliance_frameworks = get_compliance_frameworks_quick() %}
                    <li class="has-submenu" data-controller="sidebar-dropdown" data-sidebar-dropdown-key-value="sidebar-compliance-expanded">
                        <a href="{{ path('app_compliance_index') }}"
                           class="submenu-toggle {% if current_route starts with 'app_compliance_' %}active{% endif %}"
                           data-turbo-action="advance"
                           data-action="click->sidebar-dropdown#toggle:prevent"
                           data-sidebar-dropdown-target="toggle"
                           aria-expanded="false">
                            <i class="bi bi-check-circle" aria-hidden="true"></i>
                            <span>{{ 'nav.compliance'|trans }}</span>
                            <i class="bi bi-chevron-down submenu-icon" data-sidebar-dropdown-target="icon" aria-hidden="true"></i>
                        </a>
                        <ul class="submenu" data-sidebar-dropdown-target="submenu">
                            <li><a href="{{ path('app_compliance_index') }}" class="{% if current_route == 'app_compliance_index' %}active{% endif %}" data-turbo-action="advance">
                                <i class="bi bi-grid" aria-hidden="true"></i>
                                <span>{{ 'nav.compliance_overview'|trans|default('Overview') }}</span>
                            </a></li>
                            {% if compliance_frameworks|length > 0 %}
                            <li class="submenu-divider">
                                <span>{{ 'nav.frameworks'|trans|default('Frameworks') }}</span>
                            </li>
                            {% for framework in compliance_frameworks %}
                            <li><a href="{{ path('app_compliance_framework', {id: framework.id}) }}"
                                   class="framework-link {% if current_route == 'app_compliance_framework' and app.request.attributes.get('id')|default(0) == framework.id %}active{% endif %}"
                                   data-turbo-action="advance"
                                   title="{{ framework.name }}">
                                <i class="bi bi-{% if framework.mandatory %}shield-exclamation{% else %}shield{% endif %}" aria-hidden="true"></i>
                                <span>{{ framework.code }}</span>
                                {% if framework.mandatory %}<span class="badge-mini badge-danger">!</span>{% endif %}
                            </a></li>
                            {% endfor %}
                            {% endif %}
                            <li class="submenu-divider">
                                <span>{{ 'nav.tools'|trans|default('Tools') }}</span>
                            </li>
                            <li><a href="{{ path('app_compliance_cross_framework') }}" class="{% if current_route == 'app_compliance_cross_framework' %}active{% endif %}" data-turbo-action="advance">
                                <i class="bi bi-link-45deg" aria-hidden="true"></i>
                                <span>{{ 'nav.cross_framework'|trans|default('Cross-Framework') }}</span>
                            </a></li>
                            <li><a href="{{ path('app_compliance_compare') }}" class="{% if current_route == 'app_compliance_compare' %}active{% endif %}" data-turbo-action="advance">
                                <i class="bi bi-columns" aria-hidden="true"></i>
                                <span>{{ 'nav.compare'|trans|default('Compare') }}</span>
                            </a></li>
                        </ul>
                    </li>
                    {% endif %}
                    {% if is_module_active('audit_logging') %}
                    <li><a href="{{ path('app_audit_log_index') }}" class="{% if current_route starts with 'app_audit_log_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-journal-text" aria-hidden="true"></i>
                        <span>{{ 'nav.audit_log'|trans }}</span>
                    </a></li>
                    {% endif %}

                    {% if is_granted('ROLE_ADMIN') %}
                    {# Admin #}
                    <li class="nav-divider">Admin</li>
                    <li><a href="{{ path('admin_dashboard') }}" class="{% if current_route starts with 'admin_' or current_route starts with 'user_management_' or current_route starts with 'role_management_' or current_route starts with 'tenant_management_' %}active{% endif %}" data-turbo-action="advance">
                        <i class="bi bi-gear-fill" aria-hidden="true"></i>
                        <span>{{ 'nav.admin_portal'|trans }}</span>
                    </a></li>
                    {% endif %}
                </ul>
            </nav>
        </aside>

        {# Main Content Area #}
        <main id="main-content" class="app-main" role="main">
            <div class="container" data-controller="turbo">
                <div class="content">
                    {# Flash Messages Container (will be converted to toasts) #}
                    <div id="flash-messages" class="d-none">
                        {% for label, messages in app.flashes %}
                            {% for message in messages %}
                                <div class="alert alert-{{ label }}" role="alert">
                                    {{ message }}
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>

                    {% block body %}{% endblock %}
                </div>
            </div>
        </main>
    </div>

    <footer class="footer" role="contentinfo">
        <p>{{ 'app.footer'|trans }}</p>
        <p class="footer-text-small">
            {{ 'app.powered_by'|trans({'%version%': constant('Symfony\\Component\\HttpKernel\\Kernel::VERSION')}) }}
            <span class="opacity-50">• Press <kbd>?</kbd> for shortcuts • <kbd>⌘K</kbd> to search</span>
            <span class="opacity-70"> • <a href="{{ path('app_reports_overview') }}" class="text-inherit text-decoration-none"><i class="bi-file-earmark-bar-graph"></i> Reports</a></span>
        </p>
    </footer>

    {# ==================== Modern UI/UX Components ==================== #}

    {# Command Palette (⌘P) #}
    {% include '_components/_command_palette.html.twig' %}

    {# Global Search is now included in the header #}

    {# Quick View Modal (Paket B - Premium) #}
    {% include '_components/_quick_view_modal.html.twig' %}

    {# Theme Toggle (Paket C - Premium) #}
    {% include '_components/_theme_toggle.html.twig' %}

    {# Preferences Modal (Paket C - Premium) #}
    {% include '_components/_preferences_modal.html.twig' %}

    {# Notification Center (Paket C - Premium) #}
    {% include '_components/_notification_center.html.twig' %}

    {# Toast Notifications Container #}
    <div class="toast-container" data-controller="toast" data-toast-target="container"></div>

    {# Keyboard Shortcuts Help #}
    {% include '_components/_keyboard_shortcuts.html.twig' %}

    {# Bulk Delete Confirmation Dialog #}
    {% include '_components/_bulk_delete_confirmation.html.twig' %}

    {# Global translations for JavaScript #}
    <script>
        window.translations = {
            dashboard: {
                settings_imported: "{{ 'dashboard.success.settings_imported'|trans|raw }}",
                import_failed: "{{ 'dashboard.error.import_failed'|trans|raw }}"
            },
            preferences: {
                imported: "{{ 'preferences.success.imported'|trans|raw }}",
                import_failed: "{{ 'preferences.error.import_failed'|trans|raw }}"
            }
        };
    </script>

    {% block javascripts %}
        {% block importmap %}{{ importmap('app') }}{% endblock %}
    {% endblock %}
</body>
</html>
