{% extends 'base.html.twig' %}
{% trans_default_domain 'wizard' %}

{% block title %}{{ 'wizard.results'|trans }} - {{ result.framework_name }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    {# Breadcrumb #}
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ path('app_compliance_wizard_index') }}">{{ 'wizard.title'|trans }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ path('app_compliance_wizard_start', {wizard: wizard}) }}">{{ result.framework_name }}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ 'wizard.results'|trans }}</li>
        </ol>
    </nav>

    {# Header with Score #}
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-1">{{ result.framework_name }}</h1>
                            <p class="text-muted mb-0">
                                {{ 'wizard.assessed_at'|trans }}: {{ result.assessed_at|date('d.m.Y H:i') }}
                            </p>
                        </div>
                        <div class="text-end">
                            <div class="display-4 fw-bold
                                {% if result.overall_score >= 80 %}text-success
                                {% elseif result.overall_score >= 60 %}text-warning
                                {% else %}text-danger{% endif %}">
                                {{ result.overall_score }}%
                            </div>
                            <span class="badge
                                {% if result.status == 'compliant' %}bg-success
                                {% elseif result.status == 'partial' %}bg-warning text-dark
                                {% elseif result.status == 'in_progress' %}bg-info
                                {% else %}bg-danger{% endif %}">
                                {{ ('wizard.status.' ~ result.status)|trans }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="d-grid gap-2">
                        <a href="{{ path('app_compliance_wizard_export_pdf', {wizard: wizard}) }}" class="btn btn-primary">
                            <i class="bi bi-file-pdf me-2"></i>{{ 'wizard.export_pdf'|trans }}
                        </a>
                        <a href="{{ path('app_compliance_wizard_start', {wizard: wizard}) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise me-2"></i>{{ 'wizard.run_again'|trans }}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Critical Gaps Alert #}
    {% if result.critical_gap_count > 0 %}
    <div class="alert alert-danger mb-4">
        <h4 class="alert-heading h6">
            <i class="bi bi-exclamation-octagon me-2"></i>{{ 'wizard.critical_gaps_found'|trans({'%count%': result.critical_gap_count}) }}
        </h4>
        <ul class="mb-0">
            {% for gap in result.critical_gaps|slice(0, 5) %}
            <li>
                <strong>{{ gap.title|trans({}, 'wizard') }}</strong>
                {% if gap.route is defined and gap.route is not null and gap.route is not empty %}
                    - <a href="{{ path(gap.route) }}" class="alert-link">{{ 'wizard.go_to_module'|trans({}, 'wizard') }}</a>
                {% endif %}
            </li>
            {% endfor %}
            {% if result.critical_gap_count > 5 %}
            <li class="text-muted">{{ 'wizard.and_more'|trans({'%count%': result.critical_gap_count - 5}) }}</li>
            {% endif %}
        </ul>
    </div>
    {% endif %}

    {# Categories #}
    <div class="row">
        <div class="col-12">
            <h2 class="h5 mb-3">{{ 'wizard.categories_detail'|trans }}</h2>
        </div>
    </div>

    <div class="row">
        {% for key, category in result.categories %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 {% if category.score >= 80 %}border-success{% elseif category.score >= 60 %}border-warning{% else %}border-danger{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center
                    {% if category.score >= 80 %}bg-success bg-opacity-10
                    {% elseif category.score >= 60 %}bg-warning bg-opacity-10
                    {% else %}bg-danger bg-opacity-10{% endif %}">
                    <div class="d-flex align-items-center">
                        <i class="{{ category.icon|default('bi-check-circle') }} me-2"></i>
                        <span class="fw-semibold">{{ category.name|trans }}</span>
                    </div>
                    <span class="badge
                        {% if category.score >= 80 %}bg-success
                        {% elseif category.score >= 60 %}bg-warning text-dark
                        {% else %}bg-danger{% endif %}">
                        {{ category.score }}%
                    </span>
                </div>
                <div class="card-body">
                    {# Progress Bar #}
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar
                            {% if category.score >= 80 %}bg-success
                            {% elseif category.score >= 60 %}bg-warning
                            {% else %}bg-danger{% endif %}"
                            role="progressbar"
                            style="width: {{ category.score }}%"
                            aria-valuenow="{{ category.score }}"
                            aria-valuemin="0"
                            aria-valuemax="100">
                        </div>
                    </div>

                    {# Items Summary #}
                    <div class="small mb-3">
                        {% set completed = 0 %}
                        {% set partial = 0 %}
                        {% set failed = 0 %}
                        {% for item in category.items %}
                            {% if item.score >= 100 %}
                                {% set completed = completed + 1 %}
                            {% elseif item.score > 0 %}
                                {% set partial = partial + 1 %}
                            {% else %}
                                {% set failed = failed + 1 %}
                            {% endif %}
                        {% endfor %}

                        {% if completed > 0 %}
                            <span class="text-success me-2">
                                <i class="bi bi-check-circle"></i> {{ completed }}
                            </span>
                        {% endif %}
                        {% if partial > 0 %}
                            <span class="text-warning me-2">
                                <i class="bi bi-exclamation-circle"></i> {{ partial }}
                            </span>
                        {% endif %}
                        {% if failed > 0 %}
                            <span class="text-danger">
                                <i class="bi bi-x-circle"></i> {{ failed }}
                            </span>
                        {% endif %}
                    </div>

                    {# Gaps #}
                    {% if category.gaps|length > 0 %}
                    <div class="small">
                        <strong class="text-danger">{{ 'wizard.gaps'|trans }}: {{ category.gap_count }}</strong>
                        <ul class="list-unstyled mt-1 mb-0">
                            {% for gap in category.gaps|slice(0, 2) %}
                            <li class="text-truncate" title="{{ gap.title|trans({}, 'wizard') }}">
                                <i class="bi bi-flag text-danger me-1"></i>
                                {{ gap.title|trans({}, 'wizard') }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent">
                    <a href="{{ path('app_compliance_wizard_category', {wizard: wizard, category: key}) }}" class="btn btn-sm btn-outline-secondary w-100">
                        <i class="bi bi-eye me-1"></i>{{ 'wizard.view_details'|trans }}
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {# Missing Modules Info #}
    {% if result.missing_modules|length > 0 %}
    <div class="alert alert-info mt-4">
        <h4 class="alert-heading h6">
            <i class="bi bi-lightbulb me-2"></i>{{ 'wizard.improve_coverage'|trans }}
        </h4>
        <p class="mb-2">{{ 'wizard.activate_for_better'|trans }}</p>
        <ul class="mb-0">
            {% for mod in result.missing_modules %}
            <li><strong>{{ mod }}</strong></li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {# Navigation #}
    <div class="d-flex justify-content-between mt-4">
        <a href="{{ path('app_compliance_wizard_index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>{{ 'wizard.back_to_wizards'|trans }}
        </a>
        <a href="{{ path('app_compliance_wizard_compare', {wizards: [wizard]}) }}" class="btn btn-outline-primary">
            <i class="bi bi-columns-gap me-1"></i>{{ 'wizard.compare_with_others'|trans }}
        </a>
    </div>
</div>
{% endblock %}
