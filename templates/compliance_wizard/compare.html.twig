{% extends 'base.html.twig' %}
{% trans_default_domain 'wizard' %}

{% block title %}{{ 'wizard.compare_title'|trans }} - {{ 'wizard.title'|trans }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    {# Breadcrumb #}
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ path('app_compliance_wizard_index') }}">{{ 'wizard.title'|trans }}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ 'wizard.compare_title'|trans }}</li>
        </ol>
    </nav>

    {# Header #}
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-1">
                <i class="bi bi-columns-gap me-2" aria-hidden="true"></i>{{ 'wizard.compare_title'|trans }}
            </h1>
            <p class="text-muted">{{ 'wizard.compare_subtitle'|trans }}</p>
        </div>
    </div>

    {# Framework Selection #}
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" action="{{ path('app_compliance_wizard_compare') }}" class="row g-3 align-items-end">
                <div class="col-auto">
                    <label class="form-label">{{ 'wizard.select_frameworks'|trans }}:</label>
                </div>
                {% for key, wizard in available_wizards %}
                <div class="col-auto">
                    <div class="form-check form-check-inline">
                        <input type="checkbox"
                               class="form-check-input"
                               name="wizards[]"
                               value="{{ key }}"
                               id="wizard_{{ key }}"
                               {% if key in selected_wizards %}checked{% endif %}>
                        <label class="form-check-label" for="wizard_{{ key }}">
                            <i class="{{ wizard.icon }} text-{{ wizard.color }} me-1"></i>{{ wizard.code }}
                        </label>
                    </div>
                </div>
                {% endfor %}
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-arrow-repeat me-1" aria-hidden="true"></i>{{ 'wizard.update_comparison'|trans }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if results|length > 0 %}
    {# Comparison Overview #}
    <div class="row mb-4">
        {% for key, result in results %}
        <div class="col-md-{{ 12 // results|length }} mb-3">
            <div class="card h-100 border-{{ available_wizards[key].color|default('secondary') }}">
                <div class="card-header bg-{{ available_wizards[key].color|default('secondary') }} bg-opacity-10 text-center">
                    <h3 class="h5 mb-0">
                        <i class="{{ available_wizards[key].icon|default('bi-check-circle') }} me-2"></i>
                        {{ result.framework_name }}
                    </h3>
                </div>
                <div class="card-body text-center">
                    <div class="display-3 fw-bold
                        {% if result.overall_score >= 80 %}text-success
                        {% elseif result.overall_score >= 60 %}text-warning
                        {% else %}text-danger{% endif %}">
                        {{ result.overall_score }}%
                    </div>
                    <span class="badge
                        {% if result.status == 'compliant' %}bg-success
                        {% elseif result.status == 'partial' %}bg-warning text-dark
                        {% elseif result.status == 'in_progress' %}bg-info
                        {% else %}bg-danger{% endif %}">
                        {{ ('wizard.status.' ~ result.status)|trans }}
                    </span>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-flag text-danger me-1" aria-hidden="true"></i>
                            {{ result.critical_gap_count }} {{ 'wizard.critical_gaps'|trans }}
                        </small>
                    </div>
                </div>
                <div class="card-footer bg-transparent text-center">
                    <a href="{{ path('app_compliance_wizard_assess', {wizard: key}) }}" class="btn btn-sm btn-outline-{{ available_wizards[key].color|default('secondary') }}">
                        {{ 'wizard.view_details'|trans }}
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {# Category Comparison Table #}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title h5 mb-0">{{ 'wizard.category_comparison'|trans }}</h2>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>{{ 'wizard.category'|trans }}</th>
                            {% for key, result in results %}
                            <th class="text-center" style="min-width: 120px;">
                                <span class="badge bg-{{ available_wizards[key].color|default('secondary') }}">
                                    {{ result.framework }}
                                </span>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {# Collect all unique categories #}
                        {% set all_categories = {} %}
                        {% for key, result in results %}
                            {% for cat_key, cat in result.categories %}
                                {% set all_categories = all_categories|merge({(cat_key): cat.name}) %}
                            {% endfor %}
                        {% endfor %}

                        {% for cat_key, cat_name in all_categories %}
                        <tr>
                            <td>
                                <strong>{{ cat_name|trans }}</strong>
                            </td>
                            {% for key, result in results %}
                            <td class="text-center">
                                {% if result.categories[cat_key] is defined %}
                                    {% set score = result.categories[cat_key].score %}
                                    <div class="d-flex align-items-center justify-content-center">
                                        <div class="progress me-2" style="width: 50px; height: 6px;">
                                            <div class="progress-bar
                                                {% if score >= 80 %}bg-success
                                                {% elseif score >= 60 %}bg-warning
                                                {% else %}bg-danger{% endif %}"
                                                style="width: {{ score }}%">
                                            </div>
                                        </div>
                                        <span class="
                                            {% if score >= 80 %}text-success
                                            {% elseif score >= 60 %}text-warning
                                            {% else %}text-danger{% endif %}
                                            fw-semibold">
                                            {{ score }}%
                                        </span>
                                    </div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th>{{ 'wizard.overall'|trans }}</th>
                            {% for key, result in results %}
                            <th class="text-center">
                                <span class="fs-5 fw-bold
                                    {% if result.overall_score >= 80 %}text-success
                                    {% elseif result.overall_score >= 60 %}text-warning
                                    {% else %}text-danger{% endif %}">
                                    {{ result.overall_score }}%
                                </span>
                            </th>
                            {% endfor %}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    {# Cross-Framework Insights #}
    <div class="card mt-4">
        <div class="card-header">
            <h2 class="card-title h5 mb-0">
                <i class="bi bi-lightbulb me-2" aria-hidden="true"></i>{{ 'wizard.insights'|trans }}
            </h2>
        </div>
        <div class="card-body">
            {# Calculate average and best/worst #}
            {% set total_score = 0 %}
            {% set best_score = 0 %}
            {% set worst_score = 100 %}
            {% set best_framework = '' %}
            {% set worst_framework = '' %}

            {% for key, result in results %}
                {% set total_score = total_score + result.overall_score %}
                {% if result.overall_score > best_score %}
                    {% set best_score = result.overall_score %}
                    {% set best_framework = result.framework_name %}
                {% endif %}
                {% if result.overall_score < worst_score %}
                    {% set worst_score = result.overall_score %}
                    {% set worst_framework = result.framework_name %}
                {% endif %}
            {% endfor %}

            {% set avg_score = (total_score / results|length)|round %}

            <div class="row">
                <div class="col-md-4 text-center mb-3">
                    <div class="display-5 fw-bold text-primary">{{ avg_score }}%</div>
                    <p class="text-muted mb-0">{{ 'wizard.average_compliance'|trans }}</p>
                </div>
                <div class="col-md-4 text-center mb-3">
                    <div class="display-5 fw-bold text-success">{{ best_score }}%</div>
                    <p class="text-muted mb-0">{{ 'wizard.best_framework'|trans }}: {{ best_framework }}</p>
                </div>
                <div class="col-md-4 text-center mb-3">
                    <div class="display-5 fw-bold text-danger">{{ worst_score }}%</div>
                    <p class="text-muted mb-0">{{ 'wizard.needs_attention'|trans }}: {{ worst_framework }}</p>
                </div>
            </div>

            <hr>

            <h3 class="h6">{{ 'wizard.recommendations'|trans }}</h3>
            <ul>
                {% if worst_score < 60 %}
                <li>{{ 'wizard.rec_priority_framework'|trans({'%framework%': worst_framework}) }}</li>
                {% endif %}
                {% if avg_score < 80 %}
                <li>{{ 'wizard.rec_improve_controls'|trans }}</li>
                {% endif %}
                <li>{{ 'wizard.rec_regular_assessment'|trans }}</li>
            </ul>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2" aria-hidden="true"></i>{{ 'wizard.select_frameworks_hint'|trans }}
    </div>
    {% endif %}

    {# Navigation #}
    <div class="d-flex justify-content-between mt-4">
        <a href="{{ path('app_compliance_wizard_index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1" aria-hidden="true"></i>{{ 'wizard.back_to_wizards'|trans }}
        </a>
    </div>
</div>
{% endblock %}
