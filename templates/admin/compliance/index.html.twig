{% extends 'admin/layout.html.twig' %}

{% block title %}{{ 'compliance.manage_frameworks'|trans({}, 'compliance') }}{% endblock %}

{% block admin_content %}
<div class="container">
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'nav.admin'|trans({}, 'nav'), url: path('admin_dashboard') },
            { label: 'compliance.manage_frameworks'|trans({}, 'compliance') }
        ]
    } %}

    <div class="page-header">
        <div>
            <h1>üì¶ {{ 'compliance.manage_frameworks'|trans({}, 'compliance') }}</h1>
            <p class="text-muted">{{ 'compliance.manage_frameworks_subtitle'|trans({}, 'compliance') }}</p>
        </div>
        <div class="button-group">
            <a href="{{ path('admin_compliance_index') }}" class="btn btn-secondary">
                <span class="icon">‚Üê</span> {{ 'common.back'|trans({}, 'messages') }}
            </a>
        </div>
    </div>

    {# Statistics Card #}
    <div class="card mb-4">
        <div class="card-header">
            <h2>üìä {{ 'compliance.framework_statistics'|trans({}, 'compliance') }}</h2>
        </div>
        <div class="card-body">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-number">{{ statistics.total_available }}</div>
                    <div class="stat-text">{{ 'compliance.total_available'|trans({}, 'compliance') }}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-number">{{ statistics.total_loaded }}</div>
                    <div class="stat-text">{{ 'compliance.loaded'|trans({}, 'compliance') }}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-number">{{ statistics.total_not_loaded }}</div>
                    <div class="stat-text">{{ 'compliance.not_loaded'|trans({}, 'compliance') }}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-number">{{ statistics.mandatory_not_loaded }}</div>
                    <div class="stat-text">{{ 'compliance.mandatory_missing'|trans({}, 'compliance') }}</div>
                </div>
            </div>
        </div>
    </div>

    {# Available Frameworks #}
    <div class="frameworks-container">
        <h2 class="mb-2">{{ 'compliance.available_frameworks'|trans({}, 'compliance') }}</h2>

        <div class="framework-cards-grid">
            {% for framework in available_frameworks %}
                <div class="framework-card {% if framework.loaded %}loaded{% endif %}">
                    <div class="framework-card-header {% if framework.mandatory %}bg-gradient-danger{% else %}bg-gradient-primary{% endif %}">
                        <div class="framework-icon">{{ framework.icon }}</div>
                        <div class="framework-title">
                            <h2>{{ framework.code }}</h2>
                            <p>{{ framework.name }}</p>
                        </div>
                        {% if framework.loaded %}
                            <span class="badge bg-success">{{ 'compliance.loaded'|trans({}, 'compliance') }}</span>
                        {% else %}
                            <span class="badge bg-warning">{{ 'compliance.not_loaded'|trans({}, 'compliance') }}</span>
                        {% endif %}
                    </div>

                    <div class="framework-card-body">
                        <div class="framework-info">
                            <div class="info-item">
                                <span class="label">{{ 'compliance.version'|trans({}, 'compliance') }}:</span>
                                <span class="value">{{ framework.version }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">{{ 'compliance.industry'|trans({}, 'compliance') }}:</span>
                                <span class="value">{{ ('compliance.industry.' ~ framework.industry)|trans({}, 'compliance') }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">{{ 'compliance.regulatory_body'|trans({}, 'compliance') }}:</span>
                                <span class="value">{{ framework.regulatory_body }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">{{ 'compliance.mandatory'|trans({}, 'compliance') }}:</span>
                                <span class="value">
                                    {% if framework.mandatory %}
                                        <span class="badge bg-danger">{{ 'common.yes'|trans({}, 'messages') }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ 'common.no'|trans({}, 'messages') }}</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        <p class="framework-description">{{ framework.description }}</p>

                        {% if framework.required_modules is defined and framework.required_modules|length > 0 %}
                            <div class="framework-modules">
                                <h2 class="modules-title">{{ 'compliance.required_modules'|trans({}, 'compliance') }}</h2>
                                <div class="modules-list">
                                    {% for moduleKey in framework.required_modules %}
                                        {% set module = all_modules[moduleKey] ?? null %}
                                        {% set isActive = moduleKey in active_modules %}

                                        {% if module %}
                                            <div class="module-badge {% if isActive %}active{% else %}inactive{% endif %}"
                                                 data-bs-toggle="tooltip" data-bs-placement="top"
                                                 title="{{ module.description }}">
                                                <span class="module-icon">{% if isActive %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}</span>
                                                <span class="module-name">{{ module.name }}</span>
                                                {% if not isActive %}
                                                    <a href="{{ path('admin_modules_index') }}" class="module-activate-link"
                                                       data-bs-toggle="tooltip" data-bs-placement="right"
                                                       title="{{ 'common.tooltip.go_to_module_management'|trans({}, 'messages') }}">
                                                        {{ 'common.activate'|trans({}, 'messages') }} ‚Üí
                                                    </a>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <div class="framework-actions">
                            {% if framework.loaded %}
                                <button class="btn btn-success btn-block" disabled>
                                    <span class="icon">‚úÖ</span> {{ 'compliance.already_loaded'|trans({}, 'compliance') }}
                                </button>
                                <button class="btn btn-danger btn-block mt-1 delete-framework-btn"
                                        data-framework-code="{{ framework.code }}"
                                        data-framework-name="{{ framework.name }}">
                                    <span class="icon">üóëÔ∏è</span> {{ 'compliance.delete_framework'|trans({}, 'compliance') }}
                                </button>
                            {% else %}
                                <button class="btn btn-primary btn-block load-framework-btn"
                                        data-framework-code="{{ framework.code }}"
                                        data-framework-name="{{ framework.name }}">
                                    <span class="icon">‚¨áÔ∏è</span> {{ 'compliance.load_framework'|trans({}, 'compliance') }}
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
.framework-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
    gap: var(--spacing-lg);
}

.framework-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}

.framework-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.framework-card.loaded {
    border: 2px solid var(--color-success);
}

.framework-card-header {
    padding: var(--spacing-lg);
    color: white;
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.framework-icon {
    font-size: 3rem;
}

.framework-title {
    flex: 1;
}

.framework-title h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: bold;
}

.framework-title p {
    margin: var(--spacing-xs) 0 0 0;
    opacity: 0.9;
    font-size: 0.9rem;
}

.framework-card-body {
    padding: var(--spacing-lg);
}

.framework-info {
    margin-bottom: var(--spacing-md);
}

.info-item {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-xs) 0;
    border-bottom: 1px solid var(--color-border);
}

.info-item .label {
    font-weight: 600;
    color: var(--color-text-secondary);
}

.info-item .value {
    text-align: right;
}

.framework-description {
    margin: var(--spacing-md) 0;
    color: var(--color-text-secondary);
    font-size: 0.9rem;
    line-height: 1.5;
}

.framework-actions {
    margin-top: var(--spacing-md);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
}

.stat-box {
    text-align: center;
    padding: var(--spacing-lg);
    background: var(--color-background);
    border-radius: var(--border-radius);
}

.stat-icon {
    font-size: 3rem;
    margin-bottom: var(--spacing-sm);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--color-primary);
}

.stat-text {
    color: var(--color-text-secondary);
    margin-top: var(--spacing-xs);
}

.load-framework-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Module Dependencies */
.framework-modules {
    margin: var(--spacing-md) 0;
    padding: var(--spacing-md);
    background: var(--color-background);
    border-radius: var(--border-radius);
}

.modules-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin: 0 0 var(--spacing-sm) 0;
    color: var(--color-text-secondary);
}

.modules-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
}

.module-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--border-radius);
    font-size: 0.85rem;
    transition: all 0.2s;
}

.module-badge.active {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.3);
    color: #28a745;
}

.module-badge.inactive {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    color: #856404;
}

.module-icon {
    font-size: 1rem;
}

.module-name {
    font-weight: 500;
}

.module-activate-link {
    margin-left: var(--spacing-xs);
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.8rem;
    transition: color 0.2s;
}

.module-activate-link:hover {
    color: var(--color-primary-dark);
    text-decoration: underline;
}
</style>

<script>
function initializeFrameworkButtons() {
    const loadButtons = document.querySelectorAll('.load-framework-btn');
    const csrfToken = '{{ csrf_token('load_framework') }}';

    loadButtons.forEach(button => {
        // Prevent duplicate listeners
        if (button.dataset.initialized === 'true') {
            return;
        }
        button.dataset.initialized = 'true';

        button.addEventListener('click', async function() {
            const code = this.dataset.frameworkCode;
            const name = this.dataset.frameworkName;

            if (!confirm('{{ 'compliance.confirm_load'|trans({}, 'compliance') }}' + '\n\n' + name)) {
                return;
            }

            // Disable button and show loading
            this.disabled = true;
            this.innerHTML = '<span class="icon">‚è≥</span> {{ 'compliance.loading'|trans({}, 'compliance') }}...';

            try {
                const response = await fetch(`{{ path('admin_compliance_load_framework', {code: '__CODE__'}) }}`.replace('__CODE__', code), {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-Token': csrfToken
                    }
                });

                const result = await response.json();

                if (result.success) {
                    this.innerHTML = '<span class="icon">‚úÖ</span> {{ 'compliance.successfully_loaded'|trans({}, 'compliance') }}';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-success');

                    // Mark card as loaded
                    this.closest('.framework-card').classList.add('loaded');

                    // Show "Start Working" button instead of reload
                    if (result.framework_id) {
                        const actionContainer = this.closest('.framework-actions');
                        actionContainer.innerHTML = `
                            <button class="btn btn-success btn-block" disabled>
                                <span class="icon">‚úÖ</span> {{ 'compliance.successfully_loaded'|trans({}, 'compliance') }}
                            </button>
                            <a href="/{{ app.request.locale }}/compliance/framework/${result.framework_id}" class="btn btn-primary btn-block mt-1"
                               data-bs-toggle="tooltip" data-bs-placement="right"
                               data-bs-title="{{ 'common.tooltip.framework_dashboard_description'|trans({}, 'messages') }}"
                               title="{{ 'common.tooltip.framework_dashboard_description'|trans({}, 'messages') }}">
                                <span class="icon">üöÄ</span> Start Working ‚Üí
                            </a>
                            <button class="btn btn-secondary btn-block mt-1" onclick="window.location.reload()"
                                    data-bs-toggle="tooltip" data-bs-placement="right"
                                    data-bs-title="{{ 'common.tooltip.reload_to_see_framework'|trans({}, 'messages') }}"
                                    title="{{ 'common.tooltip.reload_to_see_framework'|trans({}, 'messages') }}">
                                <span class="icon">üîÑ</span> {{ 'common.reload'|trans({}, 'messages') }}
                            </button>
                        `;

                        // Re-initialize tooltips for newly created buttons
                        var newTooltips = actionContainer.querySelectorAll('[data-bs-toggle="tooltip"]');
                        newTooltips.forEach(function(el) {
                            new bootstrap.Tooltip(el, { trigger: 'hover', html: false });
                        });
                    } else {
                        // Fallback: Reload page after 2 seconds
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                } else {
                    this.innerHTML = '<span class="icon">‚ùå</span> {{ 'compliance.load_failed'|trans({}, 'compliance') }}';
                    this.classList.add('btn-danger');

                    alert('{{ 'compliance.error'|trans({}, 'compliance') }}: ' + result.message);

                    // Re-enable after 3 seconds
                    setTimeout(() => {
                        this.disabled = false;
                        this.innerHTML = '<span class="icon">‚¨áÔ∏è</span> {{ 'compliance.load_framework'|trans({}, 'compliance') }}';
                        this.classList.remove('btn-danger');
                        this.classList.add('btn-primary');
                    }, 3000);
                }
            } catch (error) {
                console.error('Error loading framework:', error);
                this.innerHTML = '<span class="icon">‚ùå</span> {{ 'compliance.load_failed'|trans({}, 'compliance') }}';
                this.classList.add('btn-danger');

                alert('{{ 'compliance.error'|trans({}, 'compliance') }}: ' + error.message);

                setTimeout(() => {
                    this.disabled = false;
                    this.innerHTML = '<span class="icon">‚¨áÔ∏è</span> {{ 'compliance.load_framework'|trans({}, 'compliance') }}';
                    this.classList.remove('btn-danger');
                    this.classList.add('btn-primary');
                }, 3000);
            }
        });
    });
}

function initializeDeleteButtons() {
    const deleteButtons = document.querySelectorAll('.delete-framework-btn');
    const csrfToken = '{{ csrf_token('delete_framework') }}';

    deleteButtons.forEach(button => {
        // Prevent duplicate listeners
        if (button.dataset.initialized === 'true') {
            return;
        }
        button.dataset.initialized = 'true';

        button.addEventListener('click', async function() {
            const code = this.dataset.frameworkCode;
            const name = this.dataset.frameworkName;

            // Show detailed confirmation dialog
            const confirmMessage = `‚ö†Ô∏è ACHTUNG: Framework l√∂schen\n\n` +
                `Framework: ${name}\n\n` +
                `Diese Aktion wird:\n` +
                `‚Ä¢ Das Framework "${name}" l√∂schen\n` +
                `‚Ä¢ Alle Anforderungen des Frameworks l√∂schen\n` +
                `‚Ä¢ Alle Mappings zu anderen Frameworks l√∂schen\n\n` +
                `Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!\n\n` +
                `M√∂chten Sie wirklich fortfahren?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Second confirmation for safety
            if (!confirm(`Sind Sie sicher? Framework "${name}" wird unwiderruflich gel√∂scht!`)) {
                return;
            }

            // Disable button and show loading
            this.disabled = true;
            const originalHTML = this.innerHTML;
            this.innerHTML = '<span class="icon">‚è≥</span> {{ 'compliance.deleting'|trans({}, 'compliance') }}...';

            try {
                const response = await fetch(`{{ path('admin_compliance_delete_framework', {code: '__CODE__'}) }}`.replace('__CODE__', code), {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-Token': csrfToken
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    this.innerHTML = '<span class="icon">‚úÖ</span> {{ 'compliance.successfully_deleted'|trans({}, 'compliance') }}';

                    // Remove the card from view with animation
                    const card = this.closest('.framework-card');
                    card.style.transition = 'opacity 0.5s, transform 0.5s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';

                    // Reload page after animation
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    this.innerHTML = '<span class="icon">‚ùå</span> {{ 'compliance.delete_failed'|trans({}, 'compliance') }}';

                    alert('{{ 'compliance.error'|trans({}, 'compliance') }}: ' + result.message);

                    // Re-enable after 3 seconds
                    setTimeout(() => {
                        this.disabled = false;
                        this.innerHTML = originalHTML;
                    }, 3000);
                }
            } catch (error) {
                console.error('Error deleting framework:', error);
                this.innerHTML = '<span class="icon">‚ùå</span> {{ 'compliance.delete_failed'|trans({}, 'compliance') }}';

                alert('{{ 'compliance.error'|trans({}, 'compliance') }}: ' + error.message);

                setTimeout(() => {
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                }, 3000);
            }
        });
    });
}

// Cleanup before Turbo caches the page to allow re-initialization on back navigation
document.addEventListener('turbo:before-cache', function() {
    document.querySelectorAll('.load-framework-btn[data-initialized="true"]').forEach(btn => {
        delete btn.dataset.initialized;
    });
    document.querySelectorAll('.delete-framework-btn[data-initialized="true"]').forEach(btn => {
        delete btn.dataset.initialized;
    });
});

// Initialize on turbo:load (for Turbo navigation) OR on DOMContentLoaded (for direct page load/non-Turbo)
// Use window-scoped flag to prevent redeclaration errors during Turbo navigation
if (!window.complianceTurboLoadRegistered) {
    window.complianceTurboLoadRegistered = false;
}
document.addEventListener('turbo:load', function() {
    window.complianceTurboLoadRegistered = true;
    initializeFrameworkButtons();
    initializeDeleteButtons();
});
// Fallback for non-Turbo environments or if turbo:load hasn't fired
setTimeout(function() {
    if (!window.complianceTurboLoadRegistered) {
        initializeFrameworkButtons();
        initializeDeleteButtons();
    }
}, 100);
</script>
{% endblock admin_content %}
