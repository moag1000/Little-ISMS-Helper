{% extends 'admin/layout.html.twig' %}

{% block admin_title %}
    {% if isEdit %}
        {{ 'tenant.title.edit'|trans({}, 'tenant') }}
    {% else %}
        {{ 'tenant.title.create'|trans({}, 'tenant') }}
    {% endif %}
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{{ path('tenant_management_index') }}">{{ 'tenant.title'|trans({}, 'tenant') }}</a></li>
    {% if isEdit %}
        <li class="breadcrumb-item"><a href="{{ path('tenant_management_show', {id: tenant.id}) }}">{{ tenant.code }}</a></li>
        <li class="breadcrumb-item active">{{ 'common.edit'|trans({}, 'messages') }}</li>
    {% else %}
        <li class="breadcrumb-item active">{{ 'common.create'|trans({}, 'messages') }}</li>
    {% endif %}
{% endblock %}

{% block admin_content %}
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-white">
                    <h3 class="card-title mb-0">
                        <i class="bi bi-building text-primary" aria-hidden="true"></i>
                        {% if isEdit %}
                            {{ 'tenant.form.edit_title'|trans({}, 'tenant') }}
                        {% else %}
                            {{ 'tenant.form.create_title'|trans({}, 'tenant') }}
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {{ form_start(form) }}
                        {# Basic Information #}
                        <fieldset class="mb-4">
                            <legend class="h6 border-bottom pb-2 mb-3">{{ 'tenant.section.basic_info'|trans({}, 'tenant') }}</legend>

                            {% include '_components/_form_field.html.twig' with {
                                'field': form.name,
                                'label': 'tenant.field.name'|trans({}, 'tenant')|default('Name'),
                                'help': 'tenant.help.name'|trans({}, 'tenant')|default('Name des Tenants'),
                                'required': true
                            } %}

                            {% include '_components/_form_field.html.twig' with {
                                'field': form.code,
                                'label': 'tenant.field.code'|trans({}, 'tenant')|default('Code'),
                                'help': 'tenant.field.code_auto_generated'|trans({}, 'tenant')|default('Automatisch generiert aus dem Namen')
                            } %}

                            {% include '_components/_form_field.html.twig' with {
                                'field': form.description,
                                'label': 'tenant.field.description'|trans({}, 'tenant')|default('Beschreibung'),
                                'help': 'tenant.help.description'|trans({}, 'tenant')|default('Beschreibung des Tenants')
                            } %}

                            {% include '_components/_form_field.html.twig' with {
                                'field': form.logoFile,
                                'label': 'tenant.field.logo'|trans({}, 'tenant')|default('Logo'),
                                'help': 'tenant.help.logo'|trans({}, 'tenant')|default('Tenant-Logo hochladen')
                            } %}
                        </fieldset>

                        {# Corporate Structure #}
                        <fieldset class="mb-4">
                            <legend class="h6 border-bottom pb-2 mb-3">{{ 'corporate.title'|trans({}, 'tenant') }}</legend>

                            {% include '_components/_form_field.html.twig' with {
                                'field': form.parent,
                                'label': 'tenant.field.parent'|trans({}, 'tenant')|default('Parent Tenant'),
                                'help': 'tenant.help.parent'|trans({}, 'tenant')|default('Übergeordneter Tenant in der Unternehmensstruktur')
                            } %}

                            {# Switch field - special handling #}
                            <div class="form-group mb-3">
                                <div class="form-check form-switch">
                                    {{ form_widget(form.isCorporateParent, {'attr': {'class': 'form-check-input', 'role': 'switch'}}) }}
                                    {{ form_label(form.isCorporateParent, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                </div>
                                {{ form_help(form.isCorporateParent) }}
                                {{ form_errors(form.isCorporateParent) }}
                            </div>

                            {% include '_components/_form_field.html.twig' with {
                                'field': form.corporateNotes,
                                'label': 'tenant.field.corporate_notes'|trans({}, 'tenant')|default('Corporate Notes'),
                                'help': 'tenant.help.corporate_notes'|trans({}, 'tenant')|default('Notizen zur Unternehmensstruktur')
                            } %}
                        </fieldset>

                        {# Azure Integration #}
                        <fieldset class="mb-4">
                            <legend class="h6 border-bottom pb-2 mb-3">{{ 'tenant.section.azure_integration'|trans({}, 'tenant') }}</legend>

                            {% include '_components/_form_field.html.twig' with {
                                'field': form.azureTenantId,
                                'label': 'tenant.field.azure_tenant_id'|trans({}, 'tenant')|default('Azure Tenant ID'),
                                'help': 'tenant.help.azure_tenant_id'|trans({}, 'tenant')|default('Azure AD Tenant ID für SSO Integration')
                            } %}
                        </fieldset>

                        {# Settings #}
                        <fieldset class="mb-4">
                            <legend class="h6 border-bottom pb-2 mb-3">{{ 'tenant.section.settings'|trans({}, 'tenant') }}</legend>

                            {# Switch field - special handling #}
                            <div class="form-group mb-3">
                                <div class="form-check form-switch">
                                    {{ form_widget(form.isActive, {'attr': {'class': 'form-check-input', 'role': 'switch'}}) }}
                                    {{ form_label(form.isActive, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                </div>
                                {{ form_help(form.isActive) }}
                                {{ form_errors(form.isActive) }}
                            </div>

                            {% include '_components/_form_field.html.twig' with {
                                'field': form.settings,
                                'label': 'tenant.field.settings'|trans({}, 'tenant')|default('Settings (JSON)'),
                                'help': 'tenant.help.settings'|trans({}, 'tenant')|default('Tenant-spezifische Einstellungen im JSON-Format')
                            } %}
                            <div class="form-text mt-2">
                                <strong>{{ 'tenant.settings.example_title'|trans({}, 'tenant') }}</strong><br>
                                <pre class="bg-light p-2 rounded small mb-0"><code>{
  "branding": {
    "primaryColor": "#0d6efd",
    "logoUrl": "/uploads/tenant-logo.png"
  },
  "features": {
    "darkMode": true,
    "globalSearch": false
  }
}</code></pre>
                            </div>
                        </fieldset>

                        {# Form Actions #}
                        <div class="d-flex justify-content-between">
                            <a href="{% if isEdit %}{{ path('tenant_management_show', {id: tenant.id}) }}{% else %}{{ path('tenant_management_index') }}{% endif %}"
                               class="btn btn-secondary">
                                <i class="bi bi-x-circle" aria-hidden="true"></i> {{ 'common.cancel'|trans({}, 'messages') }}
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save" aria-hidden="true"></i>
                                {% if isEdit %}
                                    {{ 'common.save'|trans({}, 'messages') }}
                                {% else %}
                                    {{ 'tenant.action.create'|trans({}, 'tenant') }}
                                {% endif %}
                            </button>
                        </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>

        {# Help Sidebar #}
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-white"><h5 class="card-title mb-0">{{ 'tenant.help.title'|trans({}, 'tenant') }}</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-muted small mb-2">{{ 'tenant.help.code_title'|trans({}, 'tenant') }}</h5>
                    <p class="small">{{ 'tenant.help.code_text'|trans({}, 'tenant') }}</p>

                    <hr>

                    <h6 class="text-muted small mb-2">{{ 'tenant.help.azure_title'|trans({}, 'tenant') }}</h5>
                    <p class="small">{{ 'tenant.help.azure_text'|trans({}, 'tenant') }}</p>

                    <hr>

                    <h6 class="text-muted small mb-2">{{ 'tenant.help.settings_title'|trans({}, 'tenant') }}</h5>
                    <p class="small">{{ 'tenant.help.settings_text'|trans({}, 'tenant') }}</p>
                </div>
            </div>

            {% if isEdit %}
                <div class="card mt-3">
                    <div class="card-header bg-white"><h5 class="card-title mb-0">{{ 'tenant.info.metadata'|trans({}, 'tenant') }}</h5>
                    </div>
                    <div class="card-body">
                        {% embed '_components/_table.html.twig' with {
                            'class': 'table-sm',
                            'noMargin': true
                        } %}
                            {% block table_body %}
                                <tr>
                                    <th scope="row" class="text-muted small">{{ 'common.created'|trans({}, 'messages') }}</th>
                                    <td class="small">{{ tenant.createdAt|date('d.m.Y H:i') }}</td>
                                </tr>
                                {% if tenant.updatedAt %}
                                    <tr>
                                        <th scope="row" class="text-muted small">{{ 'common.updated'|trans({}, 'messages') }}</th>
                                        <td class="small">{{ tenant.updatedAt|date('d.m.Y H:i') }}</td>
                                    </tr>
                                {% endif %}
                                <tr>
                                    <th scope="row" class="text-muted small">{{ 'tenant.field.users'|trans({}, 'tenant') }}</th>
                                    <td class="small">
                                        <span class="badge bg-info">{{ tenant.users|length }}</span>
                                    </td>
                                </tr>
                            {% endblock %}
                        {% endembed %}
                    </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        function initTenantForm() {
            if (window.tenantFormInitialized) return;
            window.tenantFormInitialized = true;

            // Find fields by name attribute instead of ID (more reliable)
            const nameField = document.querySelector('input[name="tenant[name]"]');
            const codeField = document.querySelector('input[name="tenant[code]"]');

            console.log('Auto-generation script loaded');
            console.log('Name field:', nameField);
            console.log('Code field:', codeField);

            if (!nameField || !codeField) {
                console.error('Could not find name or code fields');
                return;
            }

            // Only auto-generate for new tenants (when code is empty)
            const isNewTenant = !codeField.value || codeField.value.trim() === '';
            console.log('Is new tenant:', isNewTenant);

            if (isNewTenant) {
                // Don't use readonly - just update the value on input
                nameField.addEventListener('input', function() {
                    const name = this.value;

                    // Convert umlauts and special characters
                    let code = name
                        .replace(/ä/g, 'ae')
                        .replace(/ö/g, 'oe')
                        .replace(/ü/g, 'ue')
                        .replace(/Ä/g, 'Ae')
                        .replace(/Ö/g, 'Oe')
                        .replace(/Ü/g, 'Ue')
                        .replace(/ß/g, 'ss')
                        .replace(/\s+/g, '_')  // Spaces to underscores
                        .toLowerCase()
                        .replace(/[^a-z0-9_-]/g, '');  // Remove invalid characters

                    codeField.value = code;
                    console.log('Generated code:', code);
                });
            }
        }

        // Turbo-compatible initialization
        document.addEventListener('turbo:load', function() {
            window.tenantFormInitialized = false;
            initTenantForm();
        });

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTenantForm);
        } else {
            initTenantForm();
        }
    </script>
{% endblock %}
