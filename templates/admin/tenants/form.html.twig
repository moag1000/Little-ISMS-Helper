{% extends 'admin/layout.html.twig' %}

{% block admin_title %}
    {% if isEdit %}
        {{ 'tenant.title.edit'|trans }}
    {% else %}
        {{ 'tenant.title.create'|trans }}
    {% endif %}
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{{ path('tenant_management_index') }}">{{ 'tenant.title'|trans }}</a></li>
    {% if isEdit %}
        <li class="breadcrumb-item"><a href="{{ path('tenant_management_show', {id: tenant.id}) }}">{{ tenant.code }}</a></li>
        <li class="breadcrumb-item active">{{ 'common.edit'|trans }}</li>
    {% else %}
        <li class="breadcrumb-item active">{{ 'common.create'|trans }}</li>
    {% endif %}
{% endblock %}

{% block admin_content %}
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-building text-primary"></i>
                        {% if isEdit %}
                            {{ 'tenant.form.edit_title'|trans }}
                        {% else %}
                            {{ 'tenant.form.create_title'|trans }}
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {{ form_start(form) }}
                        {# Basic Information #}
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">{{ 'tenant.section.basic_info'|trans }}</h6>

                            <div class="mb-3">
                                {{ form_label(form.name) }}
                                {{ form_widget(form.name, {'attr': {'class': 'form-control'}}) }}
                                {{ form_help(form.name) }}
                                {{ form_errors(form.name) }}
                            </div>

                            <div class="mb-3">
                                {{ form_label(form.code) }}
                                {{ form_widget(form.code, {'attr': {'class': 'form-control bg-light'}}) }}
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> {{ 'tenant.field.code_auto_generated'|trans }}
                                </div>
                                {{ form_help(form.code) }}
                                {{ form_errors(form.code) }}
                            </div>

                            <div class="mb-3">
                                {{ form_label(form.description) }}
                                {{ form_widget(form.description, {'attr': {'class': 'form-control'}}) }}
                                {{ form_help(form.description) }}
                                {{ form_errors(form.description) }}
                            </div>

                            <div class="mb-3">
                                {{ form_label(form.logoFile) }}
                                {{ form_widget(form.logoFile, {'attr': {'class': 'form-control'}}) }}
                                {{ form_help(form.logoFile) }}
                                {{ form_errors(form.logoFile) }}
                            </div>
                        </div>

                        {# Corporate Structure #}
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">{{ 'corporate.title'|trans }}</h6>

                            <div class="mb-3">
                                {{ form_label(form.parent) }}
                                {{ form_widget(form.parent, {'attr': {'class': 'form-select'}}) }}
                                {{ form_help(form.parent) }}
                                {{ form_errors(form.parent) }}
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ form_widget(form.isCorporateParent, {'attr': {'class': 'form-check-input', 'role': 'switch'}}) }}
                                    {{ form_label(form.isCorporateParent, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                </div>
                                {{ form_help(form.isCorporateParent) }}
                                {{ form_errors(form.isCorporateParent) }}
                            </div>

                            <div class="mb-3">
                                {{ form_label(form.corporateNotes) }}
                                {{ form_widget(form.corporateNotes, {'attr': {'class': 'form-control'}}) }}
                                {{ form_help(form.corporateNotes) }}
                                {{ form_errors(form.corporateNotes) }}
                            </div>
                        </div>

                        {# Azure Integration #}
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">{{ 'tenant.section.azure_integration'|trans }}</h6>

                            <div class="mb-3">
                                {{ form_label(form.azureTenantId) }}
                                {{ form_widget(form.azureTenantId, {'attr': {'class': 'form-control'}}) }}
                                {{ form_help(form.azureTenantId) }}
                                {{ form_errors(form.azureTenantId) }}
                            </div>
                        </div>

                        {# Settings #}
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">{{ 'tenant.section.settings'|trans }}</h6>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ form_widget(form.isActive, {'attr': {'class': 'form-check-input', 'role': 'switch'}}) }}
                                    {{ form_label(form.isActive, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                </div>
                                {{ form_help(form.isActive) }}
                                {{ form_errors(form.isActive) }}
                            </div>

                            <div class="mb-3">
                                {{ form_label(form.settings) }}
                                {{ form_widget(form.settings, {'attr': {'class': 'form-control'}}) }}
                                {{ form_help(form.settings) }}
                                {{ form_errors(form.settings) }}
                                <div class="form-text">
                                    <strong>{{ 'tenant.settings.example_title'|trans }}</strong><br>
                                    <pre class="bg-light p-2 rounded small mb-0"><code>{
  "branding": {
    "primaryColor": "#0d6efd",
    "logoUrl": "/uploads/tenant-logo.png"
  },
  "features": {
    "darkMode": true,
    "globalSearch": false
  }
}</code></pre>
                                </div>
                            </div>
                        </div>

                        {# Form Actions #}
                        <div class="d-flex justify-content-between">
                            <a href="{% if isEdit %}{{ path('tenant_management_show', {id: tenant.id}) }}{% else %}{{ path('tenant_management_index') }}{% endif %}"
                               class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> {{ 'common.cancel'|trans }}
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i>
                                {% if isEdit %}
                                    {{ 'common.save'|trans }}
                                {% else %}
                                    {{ 'tenant.action.create'|trans }}
                                {% endif %}
                            </button>
                        </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>

        {# Help Sidebar #}
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h6 class="card-title mb-0">{{ 'tenant.help.title'|trans }}</h6>
                </div>
                <div class="card-body">
                    <h6 class="text-muted small mb-2">{{ 'tenant.help.code_title'|trans }}</h6>
                    <p class="small">{{ 'tenant.help.code_text'|trans }}</p>

                    <hr>

                    <h6 class="text-muted small mb-2">{{ 'tenant.help.azure_title'|trans }}</h6>
                    <p class="small">{{ 'tenant.help.azure_text'|trans }}</p>

                    <hr>

                    <h6 class="text-muted small mb-2">{{ 'tenant.help.settings_title'|trans }}</h6>
                    <p class="small">{{ 'tenant.help.settings_text'|trans }}</p>
                </div>
            </div>

            {% if isEdit %}
                <div class="card mt-3">
                    <div class="card-header bg-white">
                        <h6 class="card-title mb-0">{{ 'tenant.info.metadata'|trans }}</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <tr>
                                <th class="text-muted small">{{ 'common.created'|trans }}</th>
                                <td class="small">{{ tenant.createdAt|date('d.m.Y H:i') }}</td>
                            </tr>
                            {% if tenant.updatedAt %}
                                <tr>
                                    <th class="text-muted small">{{ 'common.updated'|trans }}</th>
                                    <td class="small">{{ tenant.updatedAt|date('d.m.Y H:i') }}</td>
                                </tr>
                            {% endif %}
                            <tr>
                                <th class="text-muted small">{{ 'tenant.field.users'|trans }}</th>
                                <td class="small">
                                    <span class="badge bg-info">{{ tenant.users|length }}</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Find fields by name attribute instead of ID (more reliable)
            const nameField = document.querySelector('input[name="tenant[name]"]');
            const codeField = document.querySelector('input[name="tenant[code]"]');

            console.log('Auto-generation script loaded');
            console.log('Name field:', nameField);
            console.log('Code field:', codeField);

            if (!nameField || !codeField) {
                console.error('Could not find name or code fields');
                return;
            }

            // Only auto-generate for new tenants (when code is empty)
            const isNewTenant = !codeField.value || codeField.value.trim() === '';
            console.log('Is new tenant:', isNewTenant);

            if (isNewTenant) {
                // Set readonly for new tenants to prevent manual editing
                codeField.setAttribute('readonly', 'readonly');
                console.log('Code field set to readonly');

                nameField.addEventListener('input', function() {
                    const name = this.value;

                    // Convert umlauts and special characters
                    let code = name
                        .replace(/ä/g, 'ae')
                        .replace(/ö/g, 'oe')
                        .replace(/ü/g, 'ue')
                        .replace(/Ä/g, 'Ae')
                        .replace(/Ö/g, 'Oe')
                        .replace(/Ü/g, 'Ue')
                        .replace(/ß/g, 'ss')
                        .replace(/\s+/g, '_')  // Spaces to underscores
                        .toLowerCase()
                        .replace(/[^a-z0-9_-]/g, '');  // Remove invalid characters

                    codeField.value = code;
                    console.log('Generated code:', code);
                });

                // Remove readonly before submit so the value is included
                const form = codeField.closest('form');
                if (form) {
                    form.addEventListener('submit', function() {
                        codeField.removeAttribute('readonly');
                        console.log('Readonly removed before submit');
                    });
                }
            }
        });
    </script>
{% endblock %}
