{% extends 'admin/layout.html.twig' %}

{% block title %}Lizenz-Zusammenfassung{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    {# Breadcrumb Navigation #}
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'Reports', url: path('app_reports_overview') },
            { label: 'Lizenzen', url: path('admin_licensing_index') },
            { label: 'Zusammenfassung' }
        ]
    } %}

    {# Page Header #}
    {% include '_components/_page_header.html.twig' with {
        title: 'Lizenz-Compliance Zusammenfassung',
        subtitle: 'Schnellübersicht über die Lizenz-Compliance',
        icon: 'bi-bar-chart'
    } %}

    <div class="row">
        <div class="col-lg-3 mb-4">
            {# Navigation Sidebar #}
            {% embed '_components/_card.html.twig' with { 'noPadding': true } %}
                {% block card_header %}
                    <div class="card-header">
                        <h2 class="card-title mb-0">
                            <i class="bi bi-list-ul me-2" aria-hidden="true"></i>Navigation
                        </h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <div class="list-group list-group-flush">
                        <a href="{{ path('admin_licensing_index') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-file-earmark-text me-2" aria-hidden="true"></i>NOTICE
                        </a>
                        <a href="{{ path('admin_licensing_report') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-file-earmark-bar-graph me-2" aria-hidden="true"></i>Detaillierter Bericht
                        </a>
                        <a href="{{ path('admin_licensing_summary') }}" class="list-group-item list-group-item-action active">
                            <i class="bi bi-bar-chart me-2" aria-hidden="true"></i>Zusammenfassung
                        </a>
                    </div>
                {% endblock %}
            {% endembed %}
        </div>

        <div class="col-lg-9">
            {% if stats.total > 0 %}
                {# Compliance Status #}
                <div class="row mb-4">
                    <div class="col-12">
                        {% set compliance_percentage = (stats.allowed / stats.total * 100)|round(1) %}
                        {% if compliance_percentage >= 95 %}
                            <div class="alert alert-success" role="alert">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="bi bi-check-circle-fill fs-3 me-3" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <h2 class="alert-heading mb-1 h5"><i class="bi bi-check-circle" aria-hidden="true"></i> Hervorragend Lizenzkonform</h2>
                                        <p class="mb-0">
                                            {{ compliance_percentage }}% der Pakete haben permissive Lizenzen.
                                            Das Projekt ist für kommerzielle Nutzung freigegeben.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        {% elseif compliance_percentage >= 80 %}
                            <div class="alert alert-info" role="alert">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="bi bi-info-circle-fill fs-3 me-3" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <h2 class="alert-heading mb-1 h5">✓ Überwiegend Lizenzkonform</h2>
                                        <p class="mb-0">
                                            {{ compliance_percentage }}% der Pakete haben permissive Lizenzen.
                                            Einzelne Pakete erfordern besondere Aufmerksamkeit.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-warning" role="alert">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="bi bi-exclamation-triangle-fill fs-3 me-3" aria-hidden="true"></i>
                                    </div>
                                    <div>
                                        <h2 class="alert-heading mb-1 h5"><i class="bi bi-exclamation-triangle" aria-hidden="true"></i> Prüfung erforderlich</h2>
                                        <p class="mb-0">
                                            {{ compliance_percentage }}% der Pakete haben permissive Lizenzen.
                                            Bitte prüfen Sie problematische Lizenzen im Detail.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                {# Statistics Cards #}
                <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                        {% embed '_components/_card.html.twig' with { 'class': 'h-100' } %}
                            {% block card_body %}
                                <div class="text-center">
                                    <div class="display-4 mb-2 text-primary">{{ stats.total }}</div>
                                    <p class="fw-semibold text-muted mb-0">Pakete Gesamt</p>
                                    <small class="text-muted">
                                        {% if stats.generated_at %}
                                            Stand: {{ stats.generated_at }}
                                        {% endif %}
                                    </small>
                                </div>
                            {% endblock %}
                        {% endembed %}
                    </div>

                    <div class="col-md-4 mb-3">
                        {% embed '_components/_card.html.twig' with { 'class': 'h-100 border-success' } %}
                            {% block card_body %}
                                <div class="text-center">
                                    <div class="display-4 mb-2 text-success">{{ stats.allowed }}</div>
                                    <p class="fw-semibold text-muted mb-0">Erlaubt</p>
                                    <small class="text-muted">{{ (stats.allowed / stats.total * 100)|round(1) }}%</small>
                                </div>
                            {% endblock %}
                        {% endembed %}
                    </div>

                    <div class="col-md-4 mb-3">
                        {% embed '_components/_card.html.twig' with { 'class': 'h-100' ~ ((stats.unknown > 0 or stats.not_allowed > 0) ? ' border-warning' : '') } %}
                            {% block card_body %}
                                <div class="text-center">
                                    <div class="display-4 mb-2 {% if stats.unknown > 0 or stats.not_allowed > 0 %}text-warning{% else %}text-muted{% endif %}">
                                        {{ stats.restricted + stats.copyleft + stats.not_allowed + stats.unknown }}
                                    </div>
                                    <p class="fw-semibold text-muted mb-0">Prüfung erforderlich</p>
                                    <small class="text-muted">
                                        {{ ((stats.restricted + stats.copyleft + stats.not_allowed + stats.unknown) / stats.total * 100)|round(1) }}%
                                    </small>
                                </div>
                            {% endblock %}
                        {% endembed %}
                    </div>
                </div>

                {# Detailed Breakdown #}
                {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
                    {% block card_header %}
                        <div class="card-header">
                            <h2 class="card-title mb-0">
                                <i class="bi bi-pie-chart me-2" aria-hidden="true"></i>Lizenzverteilung
                            </h2>
                        </div>
                    {% endblock %}
                    {% block card_body %}
                        {% embed '_components/_table.html.twig' with {
                            'class': 'table-sm',
                            'noMargin': true,
                            'responsive': true
                        } %}
                            {% block table_head %}
                                <tr>
                                    <th scope="col">Status</th>
                                    <th scope="col">Beschreibung</th>
                                    <th scope="col" class="text-end">Anzahl</th>
                                    <th scope="col" class="text-end">Anteil</th>
                                    <th scope="col" style="width: 200px;">Verteilung</th>
                                </tr>
                            {% endblock %}
                            {% block table_body %}
                                <tr>
                                    <td>{% include '_components/_badge.html.twig' with { variant: 'success', icon: 'bi-check-circle', content: 'Erlaubt' } %}</td>
                                    <td><small>Permissive Lizenzen (MIT, BSD, Apache)</small></td>
                                    <td class="text-end"><strong>{{ stats.allowed }}</strong></td>
                                    <td class="text-end">{{ (stats.allowed / stats.total * 100)|round(1) }}%</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-success" role="progressbar"
                                                 style="width: {{ (stats.allowed / stats.total * 100)|round(1) }}%"
                                                 aria-valuenow="{{ stats.allowed }}" aria-valuemin="0" aria-valuemax="{{ stats.total }}">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>{% include '_components/_badge.html.twig' with { variant: 'warning', icon: 'bi-exclamation-triangle', content: 'Eingeschränkt' } %}</td>
                                    <td><small>Weak copyleft (MPL, EPL, CC-BY)</small></td>
                                    <td class="text-end"><strong>{{ stats.restricted }}</strong></td>
                                    <td class="text-end">{{ (stats.restricted / stats.total * 100)|round(1) }}%</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-warning" role="progressbar"
                                                 style="width: {{ (stats.restricted / stats.total * 100)|round(1) }}%"
                                                 aria-valuenow="{{ stats.restricted }}" aria-valuemin="0" aria-valuemax="{{ stats.total }}">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>{% include '_components/_badge.html.twig' with { variant: 'info', icon: 'bi-arrow-repeat', content: 'Copyleft' } %}</td>
                                    <td><small>Strong copyleft (GPL, LGPL, AGPL)</small></td>
                                    <td class="text-end"><strong>{{ stats.copyleft }}</strong></td>
                                    <td class="text-end">{{ (stats.copyleft / stats.total * 100)|round(1) }}%</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-info" role="progressbar"
                                                 style="width: {{ (stats.copyleft / stats.total * 100)|round(1) }}%"
                                                 aria-valuenow="{{ stats.copyleft }}" aria-valuemin="0" aria-valuemax="{{ stats.total }}">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>{% include '_components/_badge.html.twig' with { variant: 'danger', icon: 'bi-x-circle', content: 'Nicht erlaubt' } %}</td>
                                    <td><small>Non-commercial Lizenzen</small></td>
                                    <td class="text-end"><strong>{{ stats.not_allowed }}</strong></td>
                                    <td class="text-end">{{ (stats.not_allowed / stats.total * 100)|round(1) }}%</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-danger" role="progressbar"
                                                 style="width: {{ (stats.not_allowed / stats.total * 100)|round(1) }}%"
                                                 aria-valuenow="{{ stats.not_allowed }}" aria-valuemin="0" aria-valuemax="{{ stats.total }}">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>{% include '_components/_badge.html.twig' with { variant: 'secondary', content: '❓ Unbekannt' } %}</td>
                                    <td><small>Manuelle Prüfung erforderlich</small></td>
                                    <td class="text-end"><strong>{{ stats.unknown }}</strong></td>
                                    <td class="text-end">{{ (stats.unknown / stats.total * 100)|round(1) }}%</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-secondary" role="progressbar"
                                                 style="width: {{ (stats.unknown / stats.total * 100)|round(1) }}%"
                                                 aria-valuenow="{{ stats.unknown }}" aria-valuemin="0" aria-valuemax="{{ stats.total }}">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endblock %}
                        {% endembed %}
                    {% endblock %}
                {% endembed %}

                {# Actions Required #}
                {% if stats.unknown > 0 or stats.not_allowed > 0 %}
                    {% embed '_components/_card.html.twig' with { 'class': 'border-warning mb-4' } %}
                        {% block card_header %}
                            <div class="card-header bg-warning text-dark">
                                <h2 class="card-title mb-0">
                                    <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>Handlungsbedarf
                                </h2>
                            </div>
                        {% endblock %}
                        {% block card_body %}
                            <ul class="mb-0">
                                {% if stats.unknown > 0 %}
                                    <li><strong>{{ stats.unknown }}</strong> Pakete mit unbekannter Lizenz müssen manuell geprüft werden</li>
                                {% endif %}
                                {% if stats.not_allowed > 0 %}
                                    <li><strong>{{ stats.not_allowed }}</strong> Pakete mit nicht-kommerziellen Lizenzen müssen ersetzt werden</li>
                                {% endif %}
                                {% if stats.copyleft > 0 %}
                                    <li><strong>{{ stats.copyleft }}</strong> Copyleft-Pakete erfordern Quelloffenlegung</li>
                                {% endif %}
                            </ul>
                            <div class="mt-3">
                                <a href="{{ path('admin_licensing_report') }}" class="btn btn-warning">
                                    <i class="bi bi-file-earmark-bar-graph me-1" aria-hidden="true"></i>Detailbericht anzeigen
                                </a>
                            </div>
                        {% endblock %}
                    {% endembed %}
                {% endif %}

                {# Next Steps #}
                {% embed '_components/_card.html.twig' %}
                    {% block card_header %}
                        <div class="card-header">
                            <h2 class="card-title mb-0">
                                <i class="bi bi-list-check me-2" aria-hidden="true"></i>Nächste Schritte
                            </h2>
                        </div>
                    {% endblock %}
                    {% block card_body %}
                        <ol class="mb-0">
                            <li>Vollständigen Bericht prüfen: <a href="{{ path('admin_licensing_report') }}">Detailbericht öffnen</a></li>
                            <li>Problematische Lizenzen identifizieren und dokumentieren</li>
                            <li>NOTICE-Datei prüfen: <a href="{{ path('admin_licensing_index') }}">NOTICE anzeigen</a></li>
                            <li>{{ 'admin.licensing.attributions_provided'|trans({}, 'admin') }}</li>
                            <li>Regelmäßig aktualisieren: <code>./license-report.sh</code> ausführen</li>
                        </ol>
                    {% endblock %}
                {% endembed %}

            {% else %}
                {# No Report Found #}
                <div class="alert alert-warning" role="alert">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="bi bi-exclamation-triangle-fill fs-3 me-3" aria-hidden="true"></i>
                        </div>
                        <div>
                            <h2 class="alert-heading mb-1 h5">Kein Bericht gefunden</h2>
                            <p class="mb-3">
                                Der Lizenzbericht wurde noch nicht generiert. Bitte führen Sie das folgende Kommando aus:
                            </p>
                            <code>./license-report.sh</code>
                            <p class="mt-3 mb-0">
                                <a href="{{ path('admin_licensing_report') }}" class="btn btn-warning">
                                    <i class="bi bi-arrow-clockwise me-1" aria-hidden="true"></i>Bericht generieren
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock admin_content %}
