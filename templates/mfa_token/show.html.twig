{% extends 'admin/layout.html.twig' %}

{% block admin_title %}{{ mfa_token.tokenTypeName }}{% endblock %}
{% block admin_subtitle %}
    <p class="text-muted">{{ 'mfa_token.details.subtitle'|trans({}, 'mfa') }}</p>
{% endblock %}

{% block admin_content %}
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'nav.admin'|trans({}, 'nav'), url: path('admin_dashboard') },
            { label: 'nav.mfa'|trans({}, 'nav'), url: path('admin_mfa_index') },
            { label: mfa_token.tokenTypeName }
        ]
    } %}

    <div class="mb-4">
        <a href="{{ path('admin_mfa_index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'common.back'|trans({}, 'messages') }}
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            {# Token Details #}
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-info-circle" aria-hidden="true"></i> {{ 'mfa_token.details.title'|trans({}, 'mfa') }}</h3>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">{{ 'mfa_token.field.user'|trans({}, 'mfa') }}</dt>
                        <dd class="col-sm-8">
                            <i class="bi bi-person-circle" aria-hidden="true"></i>
                            {{ mfa_token.user.firstName }} {{ mfa_token.user.lastName }}
                            <span class="text-muted">({{ mfa_token.user.email }})</span>
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.token_type'|trans({}, 'mfa') }}</dt>
                        <dd class="col-sm-8">
                            {% include '_components/_badge.html.twig' with { variant: 'primary', icon: mfa_token.tokenType == 'totp' ? 'bi-phone' : 'bi-key', content: ('mfa_token.type.' ~ mfa_token.tokenType)|trans({}, 'mfa') } %}
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.device_name'|trans({}, 'mfa') }}</dt>
                        <dd class="col-sm-8">
                            <i class="bi bi-{{ mfa_token.tokenType == 'totp' ? 'phone' : 'key' }}" aria-hidden="true"></i>
                            {{ mfa_token.deviceName ?? 'N/A' }}
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.status'|trans({}, 'mfa') }}</dt>
                        <dd class="col-sm-8">
                            {% if mfa_token.isActive %}
                                {% include '_components/_badge.html.twig' with { variant: 'success', icon: 'bi-check-circle', content: 'mfa_token.status.active'|trans({}, 'mfa') } %}
                            {% else %}
                                {% include '_components/_badge.html.twig' with { variant: 'secondary', icon: 'bi-dash-circle', content: 'mfa_token.status.inactive'|trans({}, 'mfa') } %}
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.is_primary'|trans({}, 'mfa') }}</dt>
                        <dd class="col-sm-8">
                            {% if mfa_token.isPrimary %}
                                {% include '_components/_badge.html.twig' with { variant: 'warning', icon: 'bi-star-fill', content: 'mfa_token.primary'|trans({}, 'mfa') } %}
                            {% else %}
                                <span class="text-muted">{{ 'common.no'|trans({}, 'messages') }}</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>

            {# Usage Statistics #}
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-graph-up" aria-hidden="true"></i> {{ 'mfa_token.usage.title'|trans({}, 'mfa') }}</h3>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">{{ 'mfa_token.field.enrolled_at'|trans({}, 'mfa') }}</dt>
                        <dd class="col-sm-8">
                            <i class="bi bi-calendar-check" aria-hidden="true"></i>
                            {{ mfa_token.enrolledAt|date('Y-m-d H:i:s') }}
                            <small class="text-muted">({{ mfa_token.enrolledAt|date('r') }})</small>
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.last_used'|trans({}, 'mfa') }}</dt>
                        <dd class="col-sm-8">
                            {% if mfa_token.lastUsedAt %}
                                <i class="bi bi-clock" aria-hidden="true"></i>
                                {{ mfa_token.lastUsedAt|date('Y-m-d H:i:s') }}
                                <small class="text-muted">({{ mfa_token.lastUsedAt|date('r') }})</small>
                            {% else %}
                                <span class="text-muted">{{ 'mfa_token.never_used'|trans({}, 'mfa') }}</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.usage_count'|trans({}, 'mfa') }}</dt>
                        <dd class="col-sm-8">
                            {% include '_components/_badge.html.twig' with { variant: 'info', content: mfa_token.usageCount } %}
                            {{ 'mfa_token.usage.times'|trans({}, 'mfa') }}
                        </dd>

                        {% if mfa_token.expiresAt %}
                            <dt class="col-sm-4">{{ 'mfa_token.field.expires_at'|trans({}, 'mfa') }}</dt>
                            <dd class="col-sm-8">
                                <i class="bi bi-calendar-x" aria-hidden="true"></i>
                                {{ mfa_token.expiresAt|date('Y-m-d H:i:s') }}
                                {% if mfa_token.isExpired %}
                                    {% include '_components/_badge.html.twig' with { variant: 'danger', content: 'mfa_token.status.expired'|trans({}, 'mfa'), class: 'ms-2' } %}
                                {% endif %}
                            </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            {# Backup Codes (if TOTP) #}
            {% if mfa_token.tokenType == 'totp' %}
                <div class="card mb-4 border-warning">
                    <div class="card-header bg-warning">
                        <h3 class="mb-0"><i class="bi bi-key-fill" aria-hidden="true"></i> {{ 'mfa_token.backup_codes.title'|trans({}, 'mfa') }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong>{{ 'mfa_token.backup_codes.remaining'|trans({}, 'mfa') }}:</strong>
                                {% include '_components/_badge.html.twig' with { variant: remaining_backup_codes > 2 ? 'success' : (remaining_backup_codes > 0 ? 'warning' : 'danger'), content: remaining_backup_codes ~ ' / 10' } %}
                            </div>
                            <form method="post" action="{{ path('admin_mfa_regenerate_backup', {id: mfa_token.id}) }}"
                                  data-controller="ui-actions"
                                  data-action="submit->ui-actions#confirm"
                                  data-ui-actions-message-param="{{ 'mfa_token.backup_codes.regenerate_confirm'|trans({}, 'mfa') }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('regenerate_backup_' ~ mfa_token.id) }}">
                                <button type="submit" class="btn btn-warning btn-sm">
                                    <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> {{ 'mfa_token.backup_codes.regenerate'|trans({}, 'mfa') }}
                                </button>
                            </form>
                        </div>

                        {% if remaining_backup_codes <= 2 %}
                            <div class="alert alert-{{ remaining_backup_codes == 0 ? 'danger' : 'warning' }}">
                                <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                                {% if remaining_backup_codes == 0 %}
                                    {{ 'mfa_token.backup_codes.no_codes_left'|trans({}, 'mfa') }}
                                {% else %}
                                    {{ 'mfa_token.backup_codes.low_codes'|trans({}, 'mfa') }}
                                {% endif %}
                            </div>
                        {% endif %}

                        <p class="small text-muted mb-0">
                            {{ 'mfa_token.backup_codes.description'|trans({}, 'mfa') }}
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            {# Actions #}
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-gear" aria-hidden="true"></i> {{ 'common.actions'|trans({}, 'messages') }}</h3>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if mfa_token.isActive %}
                            <form method="post" action="{{ path('admin_mfa_disable', {id: mfa_token.id}) }}"
                                  data-controller="ui-actions"
                                  data-action="submit->ui-actions#confirm"
                                  data-ui-actions-message-param="{{ 'mfa_token.confirm_disable'|trans({}, 'mfa') }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('disable_' ~ mfa_token.id) }}">
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="bi bi-pause-circle" aria-hidden="true"></i> {{ 'mfa_token.action.disable'|trans({}, 'mfa') }}
                                </button>
                            </form>
                        {% endif %}

                        <form method="post" action="{{ path('admin_mfa_delete', {id: mfa_token.id}) }}"
                              data-controller="ui-actions"
                              data-action="submit->ui-actions#confirm"
                              data-ui-actions-message-param="{{ 'mfa_token.confirm_delete'|trans({}, 'mfa') }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete_' ~ mfa_token.id) }}">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-trash" aria-hidden="true"></i> {{ 'common.delete'|trans({}, 'messages') }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            {# System Information #}
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-database" aria-hidden="true"></i> {{ 'common.system_info'|trans({}, 'messages') }}</h3>
                </div>
                <div class="card-body">
                    <dl class="mb-0 small">
                        <dt>{{ 'common.id'|trans({}, 'messages') }}</dt>
                        <dd class="font-monospace">{{ mfa_token.id }}</dd>

                        <dt>{{ 'common.created_at'|trans({}, 'messages') }}</dt>
                        <dd>{{ mfa_token.createdAt|date('Y-m-d H:i:s') }}</dd>

                        {% if mfa_token.updatedAt %}
                            <dt>{{ 'common.updated_at'|trans({}, 'messages') }}</dt>
                            <dd>{{ mfa_token.updatedAt|date('Y-m-d H:i:s') }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
