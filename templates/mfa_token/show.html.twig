{% extends 'base.html.twig' %}
{% block title %}{{ 'mfa_token.title'|trans }} - {{ parent() }}{% endblock %}

{% block body %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-shield-lock"></i>
            {{ mfa_token.tokenTypeName }}
        </h1>
        <div>
            <a href="{{ path('admin_mfa_index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> {{ 'common.back'|trans }}
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            {# Token Details #}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> {{ 'mfa_token.details.title'|trans }}</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">{{ 'mfa_token.field.user'|trans }}</dt>
                        <dd class="col-sm-8">
                            <i class="bi bi-person-circle"></i>
                            {{ mfa_token.user.firstName }} {{ mfa_token.user.lastName }}
                            <span class="text-muted">({{ mfa_token.user.email }})</span>
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.token_type'|trans }}</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-primary">
                                {% if mfa_token.tokenType == 'totp' %}
                                    <i class="bi bi-phone"></i>
                                {% elseif mfa_token.tokenType == 'webauthn' %}
                                    <i class="bi bi-key"></i>
                                {% endif %}
                                {{ ('mfa_token.type.' ~ mfa_token.tokenType)|trans }}
                            </span>
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.device_name'|trans }}</dt>
                        <dd class="col-sm-8">
                            <i class="bi bi-{{ mfa_token.tokenType == 'totp' ? 'phone' : 'key' }}"></i>
                            {{ mfa_token.deviceName ?? 'N/A' }}
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.status'|trans }}</dt>
                        <dd class="col-sm-8">
                            {% if mfa_token.isActive %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> {{ 'mfa_token.status.active'|trans }}
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="bi bi-dash-circle"></i> {{ 'mfa_token.status.inactive'|trans }}
                                </span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.is_primary'|trans }}</dt>
                        <dd class="col-sm-8">
                            {% if mfa_token.isPrimary %}
                                <span class="badge bg-warning">
                                    <i class="bi bi-star-fill"></i> {{ 'mfa_token.primary'|trans }}
                                </span>
                            {% else %}
                                <span class="text-muted">{{ 'common.no'|trans }}</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>

            {# Usage Statistics #}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> {{ 'mfa_token.usage.title'|trans }}</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">{{ 'mfa_token.field.enrolled_at'|trans }}</dt>
                        <dd class="col-sm-8">
                            <i class="bi bi-calendar-check"></i>
                            {{ mfa_token.enrolledAt|date('Y-m-d H:i:s') }}
                            <small class="text-muted">({{ mfa_token.enrolledAt|date('r') }})</small>
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.last_used'|trans }}</dt>
                        <dd class="col-sm-8">
                            {% if mfa_token.lastUsedAt %}
                                <i class="bi bi-clock"></i>
                                {{ mfa_token.lastUsedAt|date('Y-m-d H:i:s') }}
                                <small class="text-muted">({{ mfa_token.lastUsedAt|date('r') }})</small>
                            {% else %}
                                <span class="text-muted">{{ 'mfa_token.never_used'|trans }}</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">{{ 'mfa_token.field.usage_count'|trans }}</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-info">{{ mfa_token.usageCount }}</span>
                            {{ 'mfa_token.usage.times'|trans }}
                        </dd>

                        {% if mfa_token.expiresAt %}
                            <dt class="col-sm-4">{{ 'mfa_token.field.expires_at'|trans }}</dt>
                            <dd class="col-sm-8">
                                <i class="bi bi-calendar-x"></i>
                                {{ mfa_token.expiresAt|date('Y-m-d H:i:s') }}
                                {% if mfa_token.isExpired %}
                                    <span class="badge bg-danger ms-2">{{ 'mfa_token.status.expired'|trans }}</span>
                                {% endif %}
                            </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            {# Backup Codes (if TOTP) #}
            {% if mfa_token.tokenType == 'totp' %}
                <div class="card mb-4 border-warning">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0"><i class="bi bi-key-fill"></i> {{ 'mfa_token.backup_codes.title'|trans }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong>{{ 'mfa_token.backup_codes.remaining'|trans }}:</strong>
                                <span class="badge bg-{{ remaining_backup_codes > 2 ? 'success' : (remaining_backup_codes > 0 ? 'warning' : 'danger') }}">
                                    {{ remaining_backup_codes }} / 10
                                </span>
                            </div>
                            <form method="post" action="{{ path('admin_mfa_regenerate_backup', {id: mfa_token.id}) }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('regenerate_backup_' ~ mfa_token.id) }}">
                                <button type="submit"
                                        class="btn btn-warning btn-sm"
                                        onclick="return confirm('{{ 'mfa_token.backup_codes.regenerate_confirm'|trans }}');">
                                    <i class="bi bi-arrow-clockwise"></i> {{ 'mfa_token.backup_codes.regenerate'|trans }}
                                </button>
                            </form>
                        </div>

                        {% if remaining_backup_codes <= 2 %}
                            <div class="alert alert-{{ remaining_backup_codes == 0 ? 'danger' : 'warning' }}">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                {% if remaining_backup_codes == 0 %}
                                    {{ 'mfa_token.backup_codes.no_codes_left'|trans }}
                                {% else %}
                                    {{ 'mfa_token.backup_codes.low_codes'|trans }}
                                {% endif %}
                            </div>
                        {% endif %}

                        <p class="small text-muted mb-0">
                            {{ 'mfa_token.backup_codes.description'|trans }}
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            {# Actions #}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> {{ 'common.actions'|trans }}</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if mfa_token.isActive %}
                            <form method="post" action="{{ path('admin_mfa_disable', {id: mfa_token.id}) }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('disable_' ~ mfa_token.id) }}">
                                <button type="submit"
                                        class="btn btn-warning w-100"
                                        onclick="return confirm('{{ 'mfa_token.confirm_disable'|trans }}');">
                                    <i class="bi bi-pause-circle"></i> {{ 'mfa_token.action.disable'|trans }}
                                </button>
                            </form>
                        {% endif %}

                        <form method="post" action="{{ path('admin_mfa_delete', {id: mfa_token.id}) }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete_' ~ mfa_token.id) }}">
                            <button type="submit"
                                    class="btn btn-danger w-100"
                                    onclick="return confirm('{{ 'mfa_token.confirm_delete'|trans }}');">
                                <i class="bi bi-trash"></i> {{ 'common.delete'|trans }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            {# System Information #}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-database"></i> {{ 'common.system_info'|trans }}</h5>
                </div>
                <div class="card-body">
                    <dl class="mb-0 small">
                        <dt>{{ 'common.id'|trans }}</dt>
                        <dd class="font-monospace">{{ mfa_token.id }}</dd>

                        <dt>{{ 'common.created_at'|trans }}</dt>
                        <dd>{{ mfa_token.createdAt|date('Y-m-d H:i:s') }}</dd>

                        {% if mfa_token.updatedAt %}
                            <dt>{{ 'common.updated_at'|trans }}</dt>
                            <dd>{{ mfa_token.updatedAt|date('Y-m-d H:i:s') }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
