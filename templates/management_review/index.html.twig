{% extends 'base.html.twig' %}
{% trans_default_domain 'management_review' %}

{% block title %}{{ 'management_review.title'|trans({}, 'messages') }} - {{ parent() }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">
            <i class="bi bi-clipboard2-check" aria-hidden="true"></i> {{ 'management_review.title'|trans({}, 'messages') }}
        </h1>
        {% if is_granted('ROLE_ADMIN') %}
        <a href="{{ path('app_management_review_new') }}" class="btn btn-primary" data-turbo-action="advance">
            <i class="bi bi-plus-circle" aria-hidden="true"></i> {{ 'management_review.new'|trans({}, 'messages') }}
        </a>
        {% endif %}
    </div>

    {# ISO 27001 Clause Information #}
    <div class="alert alert-info mb-4" role="alert">
        <h6 class="alert-heading">
            <i class="bi bi-info-circle-fill" aria-hidden="true"></i> {{ 'management_review.iso_requirement'|trans({}, 'messages') }}
        </h5>
        <p class="mb-0 small">
            {{ 'management_review.iso_clause_info'|trans({}, 'messages') }}
        </p>
    </div>

    {# Statistics Cards #}
    <turbo-frame id="review-stats">
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card border-primary">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-collection text-primary icon-2rem" aria-hidden="true"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted mb-1">{{ 'management_review.statistics.total'|trans({}, 'messages') }}</h6>
                                <h2 class="mb-0">{{ statistics.total }}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-hourglass-split text-warning icon-2rem" aria-hidden="true"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted mb-1">{{ 'management_review.statistics.planned'|trans({}, 'messages') }}</h6>
                                <h3 class="mb-0">{{ statistics.planned }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card border-success">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-check-circle text-success icon-2rem" aria-hidden="true"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted mb-1">{{ 'management_review.statistics.completed'|trans({}, 'messages') }}</h6>
                                <h3 class="mb-0">{{ statistics.completed }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card border-info">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-calendar-event text-info icon-2rem" aria-hidden="true"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted mb-1">{{ 'management_review.statistics.this_year'|trans({}, 'messages') }}</h6>
                                <h3 class="mb-0">{{ statistics.this_year }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </turbo-frame>

    {# Management Reviews List #}
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0"><i class="bi bi-list" aria-hidden="true"></i> {{ 'management_review.all_reviews'|trans({}, 'messages') }}</h3>
        </div>
        <div class="card-body">
            {% if reviews|length == 0 %}
            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle" aria-hidden="true"></i> {{ 'management_review.no_reviews'|trans({}, 'messages') }}
                {% if is_granted('ROLE_ADMIN') %}
                <a href="{{ path('app_management_review_new') }}" class="alert-link" data-turbo-action="advance">
                    {{ 'management_review.create_first'|trans({}, 'messages') }}
                </a>
                {% endif %}
            </div>
            {% else %}
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover table-striped',
                'noMargin': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">{{ 'management_review.title'|trans({}, 'messages') }}</th>
                        <th scope="col">{{ 'management_review.field.review_date'|trans({}, 'messages') }}</th>
                        <th scope="col">{{ 'management_review.field.status'|trans({}, 'messages') }}</th>
                        <th scope="col">{{ 'management_review.field.participants'|trans({}, 'messages') }}</th>
                        <th scope="col">{{ 'common.actions'|trans({}, 'messages') }}</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for review in reviews %}
                    <tr>
                        <td>
                            <strong>{{ review.title }}</strong>
                        </td>
                        <td>{{ review.reviewDate|date('d.m.Y') }}</td>
                        <td>
                            {% set statusClass = {
                                'planned': 'warning',
                                'in_progress': 'info',
                                'completed': 'success',
                                'cancelled': 'danger'
                            } %}
                            <span class="badge bg-{{ statusClass[review.status] ?? 'secondary' }}">
                                {{ ('management_review.status.' ~ review.status)|trans }}
                            </span>
                        </td>
                        <td>
                            {% if review.participants %}
                            <i class="bi bi-people" aria-hidden="true"></i>
                            {{ review.participants|length > 50 ? (review.participants|slice(0, 50) ~ '...') : review.participants }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ path('app_management_review_show', {id: review.id}) }}"
                                   class="btn btn-outline-primary"
                                   data-turbo-action="advance"
                                   title="{{ 'common.view'|trans({}, 'messages') }}" aria-label="{{ 'common.view'|trans({}, 'messages') }}">
                                    <i class="bi bi-eye" aria-hidden="true"></i>
                                </a>
                                {% if is_granted('ROLE_ADMIN') %}
                                <a href="{{ path('app_management_review_edit', {id: review.id}) }}"
                                   class="btn btn-outline-secondary"
                                   data-turbo-action="advance"
                                   title="{{ 'common.edit'|trans({}, 'messages') }}" aria-label="{{ 'common.edit'|trans({}, 'messages') }}">
                                    <i class="bi bi-pencil" aria-hidden="true"></i>
                                </a>
                                <button type="button"
                                        class="btn btn-outline-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModal{{ review.id }}"
                                        title="{{ 'common.delete'|trans({}, 'messages') }}" aria-label="{{ 'common.delete'|trans({}, 'messages') }}">
                                    <i class="bi bi-trash" aria-hidden="true"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
            {% endif %}
        </div>
    </div>
</div>

{# Delete Modals #}
{% for review in reviews %}
<div class="modal fade" id="deleteModal{{ review.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ review.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel{{ review.id }}">
                    <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> {{ 'management_review.confirm_delete'|trans({}, 'messages') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{{ 'management_review.delete_warning'|trans({'%title%': review.title}, 'messages') }}</p>
                <p class="text-muted"><small>{{ 'common.action_irreversible'|trans({}, 'messages') }}</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {{ 'common.cancel'|trans({}, 'messages') }}
                </button>
                <form method="post" action="{{ path('app_management_review_delete', {id: review.id}) }}" class="d-inline">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ review.id) }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash" aria-hidden="true"></i> {{ 'common.delete'|trans({}, 'messages') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}
