{% extends 'base.html.twig' %}
{% trans_default_domain 'management_review' %}

{% block title %}{{ review.title }} - {{ parent() }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ path('app_management_review_index') }}" data-turbo-action="advance">
                    <i class="bi bi-clipboard2-check" aria-hidden="true"></i> {{ 'management_review.title'|trans({}, 'management_review') }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ review.title }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-clipboard2-check" aria-hidden="true"></i> {{ review.title }}
        </h1>
    </div>

    <div class="row">
        <div class="col-lg-8">
            {# Main Review Information #}
            {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
                {% block card_header %}
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h2 class="h5 mb-0">
                            <i class="bi bi-clipboard2-check" aria-hidden="true"></i> {{ 'management_review.field.basic_info'|trans({}, 'management_review') }}
                        </h2>
                        {% set statusClass = {
                            'planned': 'warning',
                            'in_progress': 'info',
                            'completed': 'success',
                            'cancelled': 'danger'
                        } %}
                        {% include '_components/_badge.html.twig' with { variant: statusClass[review.status] ?? 'secondary', class: 'fs-6', content: ('management_review.status.' ~ review.status)|trans({}, 'management_review') } %}
                    </div>
                {% endblock %}
                {% block card_body %}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="text-muted small mb-2">
                                <i class="bi bi-calendar-event" aria-hidden="true"></i> {{ 'management_review.field.review_date'|trans({}, 'management_review') }}
                            </div>
                            <p class="fs-5">{{ review.reviewDate|date('d.m.Y') }}</p>
                        </div>
                        <div class="col-md-6">
                            <div class="text-muted small mb-2">
                                <i class="bi bi-people" aria-hidden="true"></i> {{ 'management_review.field.participants'|trans({}, 'management_review') }}
                                {% include '_components/_badge.html.twig' with { variant: 'primary', content: review.participants|length } %}
                            </div>
                            {% if review.participants|length > 0 %}
                            <ul class="list-unstyled mb-0">
                                {% for participant in review.participants %}
                                <li><i class="bi bi-person" aria-hidden="true"></i> {{ participant.firstName }} {{ participant.lastName }}</li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="text-muted">-</p>
                            {% endif %}
                        </div>
                    </div>
                {% endblock %}
            {% endembed %}

            {# Inputs to the Review #}
            {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
                {% block card_header %}
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">
                            <i class="bi bi-inbox" aria-hidden="true"></i> {{ 'management_review.section.inputs'|trans({}, 'management_review') }}
                        </h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    {% if review.changesRelevantToISMS %}
                    <div class="mb-3">
                        <div class="text-muted small fw-bold">{{ 'management_review.changes_relevant_to_isms'|trans({}, 'management_review') }}</div>
                        <p>{{ review.changesRelevantToISMS|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if review.feedbackFromInterestedParties %}
                    <div class="mb-3">
                        <div class="text-muted small fw-bold">{{ 'management_review.feedback_from_interested_parties'|trans({}, 'management_review') }}</div>
                        <p>{{ review.feedbackFromInterestedParties|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if review.auditResults %}
                    <div class="mb-3">
                        <div class="text-muted small fw-bold">{{ 'management_review.audit_results'|trans({}, 'management_review') }}</div>
                        <p>{{ review.auditResults|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if review.performanceEvaluation %}
                    <div class="mb-0">
                        <div class="text-muted small fw-bold">{{ 'management_review.performance_evaluation'|trans({}, 'management_review') }}</div>
                        <p>{{ review.performanceEvaluation|nl2br }}</p>
                    </div>
                    {% endif %}
                {% endblock %}
            {% endembed %}

            {# Status of Previous Actions #}
            {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
                {% block card_header %}
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">
                            <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> {{ 'management_review.section.followup'|trans({}, 'management_review') }}
                        </h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    {% if review.previousReviewActions %}
                    <div class="mb-3">
                        <div class="text-muted small fw-bold">{{ 'management_review.previous_review_actions'|trans({}, 'management_review') }}</div>
                        <p>{{ review.previousReviewActions|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if review.nonConformitiesStatus %}
                    <div class="mb-3">
                        <div class="text-muted small fw-bold">{{ 'management_review.nonconformities_status'|trans({}, 'management_review') }}</div>
                        <p>{{ review.nonConformitiesStatus|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if review.correctiveActionsStatus %}
                    <div class="mb-0">
                        <div class="text-muted small fw-bold">{{ 'management_review.corrective_actions_status'|trans({}, 'management_review') }}</div>
                        <p>{{ review.correctiveActionsStatus|nl2br }}</p>
                    </div>
                    {% endif %}
                {% endblock %}
            {% endembed %}

            {# Outputs from the Review #}
            {% embed '_components/_card.html.twig' with { 'class': 'mb-4 border-success' } %}
                {% block card_header %}
                    <div class="card-header bg-success text-white">
                        <h2 class="h5 mb-0">
                            <i class="bi bi-send" aria-hidden="true"></i> {{ 'management_review.section.outputs'|trans({}, 'management_review') }}
                        </h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    {% if review.opportunitiesForImprovement %}
                    <div class="mb-3">
                        <div class="text-muted small fw-bold">{{ 'management_review.opportunities_for_improvement'|trans({}, 'management_review') }}</div>
                        <p>{{ review.opportunitiesForImprovement|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if review.resourceNeeds %}
                    <div class="mb-3">
                        <div class="text-muted small fw-bold">{{ 'management_review.resource_needs'|trans({}, 'management_review') }}</div>
                        <p>{{ review.resourceNeeds|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if review.decisions %}
                    <div class="mb-3">
                        <div class="text-muted small fw-bold">{{ 'management_review.decisions'|trans({}, 'management_review') }}</div>
                        <div class="alert alert-warning">
                            <strong><i class="bi bi-gavel" aria-hidden="true"></i> {{ 'management_review.management_decisions'|trans({}, 'management_review') }}</strong>
                            <p class="mb-0 mt-2">{{ review.decisions|nl2br }}</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if review.actionItems %}
                    <div class="mb-0">
                        <div class="text-muted small fw-bold">{{ 'management_review.action_items'|trans({}, 'management_review') }}</div>
                        <div class="alert alert-info">
                            <strong><i class="bi bi-list-check" aria-hidden="true"></i> {{ 'management_review.action_items_label'|trans({}, 'management_review') }}</strong>
                            <p class="mb-0 mt-2">{{ review.actionItems|nl2br }}</p>
                        </div>
                    </div>
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>

        <div class="col-lg-4">
            {# Action Buttons #}
            {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
                {% block card_header %}
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0"><i class="bi bi-tools" aria-hidden="true"></i> {{ 'common.actions'|trans({}, 'messages') }}</h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <div class="d-grid gap-2">
                        {% if is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('app_management_review_edit', {id: review.id}) }}"
                           class="btn btn-primary"
                           data-turbo-action="advance">
                            <i class="bi bi-pencil" aria-hidden="true"></i> {{ 'common.edit'|trans({}, 'messages') }}
                        </a>
                        {% endif %}

                        <a href="{{ path('app_management_review_index') }}"
                           class="btn btn-outline-secondary"
                           data-turbo-action="advance">
                            <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'common.back_to_list'|trans({}, 'messages') }}
                        </a>

                        {% if is_granted('ROLE_ADMIN') %}
                        <hr>
                        <button type="button"
                                class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal">
                            <i class="bi bi-trash" aria-hidden="true"></i> {{ 'common.delete'|trans({}, 'messages') }}
                        </button>
                        {% endif %}
                    </div>
                {% endblock %}
            {% endembed %}

            {# ISO 27001 Clause Reference #}
            {% embed '_components/_card.html.twig' with { 'class': 'mb-4 border-info' } %}
                {% block card_header %}
                    <div class="card-header bg-info text-white">
                        <h2 class="h5 mb-0"><i class="bi bi-shield-check" aria-hidden="true"></i> ISO 27001:2022</h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <h3 class="h6 fw-bold">{{ 'management_review.clause_93'|trans({}, 'management_review') }}</h3>
                    <p class="small mb-2">{{ 'management_review.clause_93_description'|trans({}, 'management_review') }}</p>

                    <hr>

                    <div class="fw-bold small">{{ 'management_review.inputs_label'|trans({}, 'management_review') }}</div>
                    <ul class="small mb-2">
                        <li>{{ 'management_review.input_1'|trans({}, 'management_review') }}</li>
                        <li>{{ 'management_review.input_2'|trans({}, 'management_review') }}</li>
                        <li>{{ 'management_review.input_3'|trans({}, 'management_review') }}</li>
                        <li>{{ 'management_review.input_4'|trans({}, 'management_review') }}</li>
                    </ul>

                    <div class="fw-bold small">{{ 'management_review.outputs_label'|trans({}, 'management_review') }}</div>
                    <ul class="small mb-0">
                        <li>{{ 'management_review.output_1'|trans({}, 'management_review') }}</li>
                        <li>{{ 'management_review.output_2'|trans({}, 'management_review') }}</li>
                        <li>{{ 'management_review.output_3'|trans({}, 'management_review') }}</li>
                    </ul>
                {% endblock %}
            {% endembed %}

            {# Metadata #}
            {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
                {% block card_header %}
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0"><i class="bi bi-info-circle" aria-hidden="true"></i> {{ 'common.metadata'|trans({}, 'messages') }}</h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <dl class="row mb-0 small">
                        <dt class="col-sm-5 text-muted">{{ 'common.created_at'|trans({}, 'messages') }}</dt>
                        <dd class="col-sm-7">{{ review.createdAt|date('d.m.Y H:i') }}</dd>

                        <dt class="col-sm-5 text-muted">{{ 'common.updated_at'|trans({}, 'messages') }}</dt>
                        <dd class="col-sm-7">{{ review.updatedAt ? review.updatedAt|date('d.m.Y H:i') : '-' }}</dd>

                        <dt class="col-sm-5 text-muted">{{ 'common.id'|trans({}, 'messages') }}</dt>
                        <dd class="col-sm-7"><code>{{ review.id }}</code></dd>
                    </dl>
                {% endblock %}
            {% endembed %}
        </div>
    </div>
</div>

{# Delete Confirmation Modal #}
{% if is_granted('ROLE_ADMIN') %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h3 class="modal-title h5" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> {{ 'management_review.confirm_delete'|trans({}, 'management_review') }}
                </h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="{{ 'common.close'|trans({}, 'messages') }}"></button>
            </div>
            <div class="modal-body">
                <p>{{ 'management_review.delete_warning'|trans({'%title%': review.title}, 'management_review') }}</p>
                <p class="text-muted"><small>{{ 'common.action_irreversible'|trans({}, 'messages') }}</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {{ 'common.cancel'|trans({}, 'messages') }}
                </button>
                <form method="post" action="{{ path('app_management_review_delete', {id: review.id}) }}" style="display: inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ review.id) }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash" aria-hidden="true"></i> {{ 'common.delete'|trans({}, 'messages') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
