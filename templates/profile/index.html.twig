{% extends 'base.html.twig' %}

{% block title %}{{ 'user.profile.title'|trans({}, 'user') }}{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="mb-0">
                <i class="bi bi-person-circle" aria-hidden="true"></i>
                {{ 'user.profile.title'|trans({}, 'user') }}
            </h1>
        </div>
        <div class="col-auto">
            <a href="{{ path('app_profile_edit') }}" class="btn btn-primary">
                <i class="bi bi-pencil" aria-hidden="true"></i>
                {{ 'user.profile.action.edit'|trans({}, 'user') }}
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-4">
            {# Profile Picture Card #}
            {% embed '_components/_card.html.twig' %}
                {% block card_body %}
                    <div class="text-center">
                        <h2 class="h5 card-title">{{ 'user.profile.section.avatar'|trans({}, 'user') }}</h2>

                        {% if user.profilePicture %}
                            <img src="{{ asset(user.profilePicture) }}"
                                 alt="{{ user.fullName }}"
                                 class="rounded-circle mb-3"
                                 style="width: 150px; height: 150px; object-fit: cover;">
                        {% else %}
                            <div class="bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                                 style="width: 150px; height: 150px; font-size: 3rem;">
                                {{ user.firstName|first|upper }}{{ user.lastName|first|upper }}
                            </div>
                        {% endif %}

                        <p class="fs-5 fw-semibold mb-0">{{ user.fullName }}</p>
                        <p class="text-muted">{{ user.email }}</p>

                        {% if user.profilePicture %}
                            <form method="post" action="{{ path('app_profile_avatar_delete') }}" class="mt-3"
                                  data-controller="ui-actions"
                                  data-action="submit->ui-actions#confirm"
                                  data-ui-actions-message-param="{{ 'user.profile.confirm.delete_avatar'|trans({}, 'user') }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete_avatar' ~ user.id) }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash" aria-hidden="true"></i>
                                    {{ 'user.profile.action.delete_avatar'|trans({}, 'user') }}
                                </button>
                            </form>
                        {% endif %}
                    </div>
                {% endblock %}
            {% endembed %}
        </div>

        <div class="col-md-8">
            {# Basic Information Card #}
            {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
                {% block card_header %}
                    <div class="card-header bg-primary text-white">
                        <h2 class="h5 mb-0">{{ 'user.section.basic_info'|trans({}, 'user') }}</h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <dl class="row mb-0">
                        <dt class="col-sm-4">{{ 'user.field.first_name'|trans({}, 'user') }}</dt>
                        <dd class="col-sm-8">{{ user.firstName }}</dd>

                        <dt class="col-sm-4">{{ 'user.field.last_name'|trans({}, 'user') }}</dt>
                        <dd class="col-sm-8">{{ user.lastName }}</dd>

                        <dt class="col-sm-4">{{ 'user.field.email'|trans({}, 'user') }}</dt>
                        <dd class="col-sm-8">{{ user.email }}</dd>

                        {% if user.department %}
                            <dt class="col-sm-4">{{ 'user.field.department'|trans({}, 'user') }}</dt>
                            <dd class="col-sm-8">{{ user.department }}</dd>
                        {% endif %}

                        {% if user.jobTitle %}
                            <dt class="col-sm-4">{{ 'user.field.job_title'|trans({}, 'user') }}</dt>
                            <dd class="col-sm-8">{{ user.jobTitle }}</dd>
                        {% endif %}

                        {% if user.phoneNumber %}
                            <dt class="col-sm-4">{{ 'user.field.phone_number'|trans({}, 'user') }}</dt>
                            <dd class="col-sm-8">{{ user.phoneNumber }}</dd>
                        {% endif %}
                    </dl>
                {% endblock %}
            {% endembed %}

            {# Account Information Card #}
            {% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
                {% block card_header %}
                    <div class="card-header bg-info text-white">
                        <h2 class="h5 mb-0">{{ 'user.profile.section.account'|trans({}, 'user') }}</h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <dl class="row mb-0">
                        <dt class="col-sm-4">{{ 'user.field.roles'|trans({}, 'user') }}</dt>
                        <dd class="col-sm-8">
                            {% for role in user.roles %}
                                {% include '_components/_badge.html.twig' with { variant: 'secondary', content: role, class: 'me-1' } %}
                            {% endfor %}
                        </dd>

                        {% if user.tenant %}
                            <dt class="col-sm-4">{{ 'user.field.tenant'|trans({}, 'user') }}</dt>
                            <dd class="col-sm-8">{{ user.tenant.name }}</dd>
                        {% endif %}

                        <dt class="col-sm-4">{{ 'user.profile.field.language'|trans({}, 'user') }}</dt>
                        <dd class="col-sm-8">{{ user.language|default('de') }}</dd>

                        <dt class="col-sm-4">{{ 'user.profile.field.timezone'|trans({}, 'user') }}</dt>
                        <dd class="col-sm-8">{{ user.timezone|default('Europe/Berlin') }}</dd>

                        <dt class="col-sm-4">{{ 'user.field.created_at'|trans({}, 'user') }}</dt>
                        <dd class="col-sm-8">{{ user.createdAt|date('d.m.Y H:i') }}</dd>

                        {% if user.lastLoginAt %}
                            <dt class="col-sm-4">{{ 'user.field.last_login'|trans({}, 'user') }}</dt>
                            <dd class="col-sm-8">{{ user.lastLoginAt|date('d.m.Y H:i') }}</dd>
                        {% endif %}
                    </dl>
                {% endblock %}
            {% endembed %}

            {# MFA Status Card #}
            {% embed '_components/_card.html.twig' with { 'class': 'mt-4' } %}
                {% block card_header %}
                    <div class="card-header {% if user.hasMfaEnabled %}bg-success{% else %}bg-warning{% endif %} text-white">
                        <h2 class="h5 mb-0">
                            <i class="bi bi-shield{% if user.hasMfaEnabled %}-check{% else %}-exclamation{% endif %}" aria-hidden="true"></i>
                            {{ 'user.profile.section.mfa'|trans({}, 'user') }}
                        </h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    {% if user.hasMfaEnabled %}
                        <p class="mb-2">
                            {% include '_components/_badge.html.twig' with { variant: 'success', content: 'user.profile.mfa.enabled'|trans({}, 'user') } %}
                        </p>
                        <p class="text-muted mb-2">
                            {{ 'user.profile.mfa.active_tokens'|trans({'%count%': user.activeMfaTokenCount}, 'user') }}
                        </p>
                        <div class="mt-3">
                            <a href="{{ path('app_profile_mfa_index') }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-gear" aria-hidden="true"></i>
                                {{ 'user.profile.mfa.manage'|trans({}, 'user') }}
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                            {{ 'user.profile.mfa.not_enabled'|trans({}, 'user') }}
                        </div>
                        <div class="mt-3">
                            <a href="{{ path('app_profile_mfa_setup_totp') }}" class="btn btn-sm btn-success">
                                <i class="bi bi-shield-plus" aria-hidden="true"></i>
                                {{ 'user.profile.mfa.setup'|trans({}, 'user') }}
                            </a>
                        </div>
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>
    </div>
</div>
{% endblock %}
