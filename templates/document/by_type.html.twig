{% extends 'base.html.twig' %}

{% block title %}{{ 'document.title.by_type'|trans }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>{{ 'document.title.by_type'|trans }}</h1>
        <p class="text-muted">{{ 'document.description.by_type'|trans }}</p>
    </div>
    <div class="button-group">
        <a href="{{ path('app_document_index') }}" class="btn btn-secondary">
            ‚Üê {{ 'common.back'|trans }}
        </a>
        <a href="{{ path('app_document_new') }}" class="btn btn-primary">
            ‚ûï {{ 'document.action.create'|trans }}
        </a>
    </div>
</div>

{# Statistics Cards #}
<div class="kpi-grid">
    <div class="kpi-card">
        <div class="icon">üìÑ</div>
        <div class="label">{{ 'document.stats.total'|trans }}</div>
        <div>
            <span class="value">{{ totalDocuments }}</span>
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">üìÅ</div>
        <div class="label">{{ 'document.stats.document_types'|trans }}</div>
        <div>
            <span class="value">{{ documentTypes|length }}</span>
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">‚ö†Ô∏è</div>
        <div class="label">{{ 'document.stats.expiring_soon'|trans }}</div>
        <div>
            <span class="value">{{ expiringSoonCount }}</span>
        </div>
    </div>

    <div class="kpi-card">
        <div class="icon">üìä</div>
        <div class="label">{{ 'document.stats.avg_per_type'|trans }}</div>
        <div>
            <span class="value">{{ documentTypes|length > 0 ? (totalDocuments / documentTypes|length)|round : 0 }}</span>
        </div>
    </div>
</div>

{# Document Type Selection #}
<div class="card mb-4">
    <h2>{{ 'document.section.select_type'|trans }}</h2>

    <form method="get" class="mt-md">
        <div class="form-group">
            <label for="type">{{ 'document.field.document_type'|trans }}</label>
            <select name="type" id="type" class="form-select" onchange="this.form.submit();">
                <option value="">{{ 'document.option.all_types'|trans }}</option>
                {% for type in documentTypes %}
                    <option value="{{ type.id }}" {% if selectedType and selectedType.id == type.id %}selected{% endif %}>
                        {{ type.name }} ({{ type.documentCount }})
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

{# Document Types Overview #}
<h2>{{ 'document.section.types_overview'|trans }}</h2>

<div class="module-grid mb-4">
    {% for type in documentTypes|slice(0, 6) %}
    <div class="card">
        <div class="fs-2-mb-sm">{{ type.icon ?? 'üìÑ' }}</div>
        <h2 class="fs-11-mb-sm">{{ type.name }}</h2>
        <p class="text-muted-mb-md">
            {{ type.description|default('-') }}
        </p>

        <div class="stats-grid grid-col-2">
            <div class="stat-item">
                <strong class="fs-15">{{ type.documentCount }}</strong>
                <span>{{ 'document.field.documents'|trans }}</span>
            </div>
            <div class="stat-item">
                <strong>{{ type.activeDocuments }}</strong>
                <span>{{ 'document.field.active'|trans }}</span>
            </div>
        </div>

        <div class="mt-3">
            <a href="{{ path('app_document_by_type', {type: type.id}) }}" class="btn btn-sm">
                {{ 'common.view_all'|trans }}
            </a>
        </div>
    </div>
    {% else %}
    <div class="card grid-full">
        <p class="text-center-muted">
            {{ 'document.message.no_types'|trans }}
        </p>
    </div>
    {% endfor %}
</div>

{# Documents by Selected Type #}
{% if selectedType %}
<h2>{{ selectedType.name }} - {{ 'document.section.documents'|trans }}</h2>

{% embed '_components/_table.html.twig' with {
    'noMargin': true,
    'responsive': true
} %}
    {% block table_head %}
        <tr>
            <th scope="col">{{ 'document.field.title'|trans }}</th>
            <th scope="col">{{ 'document.field.version'|trans }}</th>
            <th scope="col">{{ 'document.field.status'|trans }}</th>
            <th scope="col">{{ 'document.field.owner'|trans }}</th>
            <th scope="col">{{ 'document.field.last_updated'|trans }}</th>
            <th scope="col">{{ 'document.field.review_date'|trans }}</th>
            <th scope="col" class="text-center">{{ 'common.actions'|trans }}</th>
        </tr>
    {% endblock %}
    {% block table_body %}
        {% for document in documentsByType %}
        <tr>
            <td>
                <strong>{{ document.title }}</strong>
                {% if document.isControlledDocument %}
                    <span class="badge bg-info ml-xs">
                        {{ 'document.badge.controlled'|trans }}
                    </span>
                {% endif %}
                {% if document.isConfidential %}
                    <span class="badge bg-danger ml-xs">
                        {{ 'document.badge.confidential'|trans }}
                    </span>
                {% endif %}
            </td>
            <td>
                <code>{{ document.version }}</code>
            </td>
            <td>
                {% set statusColors = {
                    'draft': 'secondary',
                    'review': 'warning',
                    'approved': 'success',
                    'archived': 'info',
                    'obsolete': 'danger'
                } %}
                <span class="badge badge-{{ statusColors[document.status] ?? 'secondary' }}">
                    {{ ('document.status.' ~ document.status)|trans }}
                </span>
            </td>
            <td>{{ document.owner.fullName|default('-') }}</td>
            <td>{{ document.updatedAt|date('d.m.Y') }}</td>
            <td>
                {% if document.reviewDate %}
                    {{ document.reviewDate|date('d.m.Y') }}
                    {% if document.reviewDate < date() %}
                        <span class="badge bg-danger ml-xs">
                            {{ 'document.badge.overdue'|trans }}
                        </span>
                    {% elseif document.reviewDate < date('+30 days') %}
                        <span class="badge bg-warning ml-xs">
                            {{ 'document.badge.due_soon'|trans }}
                        </span>
                    {% endif %}
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td class="text-center">
                <a href="{{ path('app_document_show', {id: document.id}) }}" class="btn btn-sm mr-025">
                    üëÅ {{ 'common.view'|trans }}
                </a>
                <a href="{{ path('app_document_download', {id: document.id}) }}" class="btn btn-sm btn-secondary">
                    üì• {{ 'common.download'|trans }}
                </a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="7" class="text-center-p-xl-muted">
                {{ 'document.message.no_documents_for_type'|trans }}
            </td>
        </tr>
        {% endfor %}
    {% endblock %}
{% endembed %}

{# Type Statistics #}
<div class="module-grid mt-4">
    <div class="card">
        <h3>{{ 'document.section.type_statistics'|trans }}</h3>

        <div class="stats-grid mt-3 grid-col-1">
            <div class="stat-item">
                <strong>{{ selectedType.documentCount }}</strong>
                <span>{{ 'document.stats.total_documents'|trans }}</span>
            </div>
            <div class="stat-item">
                <strong>{{ selectedType.activeDocuments }}</strong>
                <span>{{ 'document.stats.active_documents'|trans }}</span>
            </div>
            <div class="stat-item">
                <strong>{{ selectedType.draftDocuments }}</strong>
                <span>{{ 'document.stats.draft_documents'|trans }}</span>
            </div>
            <div class="stat-item">
                <strong>{{ selectedType.overdueReviews }}</strong>
                <span>{{ 'document.stats.overdue_reviews'|trans }}</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>{{ 'document.section.recent_activity'|trans }}</h3>

        {% if selectedType.recentDocuments|length > 0 %}
        <ul class="list-unstyled-mt-md">
            {% for doc in selectedType.recentDocuments|slice(0, 5) %}
            <li class="li-border-item">
                <strong>{{ doc.title }}</strong>
                <br><small class="text-muted">
                    {{ 'document.field.updated'|trans }}: {{ doc.updatedAt|date('d.m.Y H:i') }}
                </small>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted-mt-md">
            {{ 'document.message.no_recent_activity'|trans }}
        </p>
        {% endif %}
    </div>
</div>

{% else %}

{# All Document Types Table #}
<h2>{{ 'document.section.all_types'|trans }}</h2>

{% embed '_components/_table.html.twig' with {
    'noMargin': true,
    'responsive': true
} %}
    {% block table_head %}
        <tr>
            <th scope="col">{{ 'document.field.type_name'|trans }}</th>
            <th scope="col">{{ 'document.field.description'|trans }}</th>
            <th scope="col" class="text-center">{{ 'document.field.total_documents'|trans }}</th>
            <th scope="col" class="text-center">{{ 'document.field.active'|trans }}</th>
            <th scope="col" class="text-center">{{ 'document.field.draft'|trans }}</th>
            <th scope="col" class="text-center">{{ 'document.field.overdue_reviews'|trans }}</th>
            <th scope="col" class="text-center">{{ 'common.actions'|trans }}</th>
        </tr>
    {% endblock %}
    {% block table_body %}
        {% for type in documentTypes %}
        <tr>
            <td>
                <strong>{{ type.icon ?? 'üìÑ' }} {{ type.name }}</strong>
            </td>
            <td>
                <small class="text-muted">
                    {{ type.description|default('-') }}
                </small>
            </td>
            <td class="text-center">
                <span class="badge bg-info">{{ type.documentCount }}</span>
            </td>
            <td class="text-center">
                <span class="badge bg-success">{{ type.activeDocuments }}</span>
            </td>
            <td class="text-center">
                <span class="badge bg-secondary">{{ type.draftDocuments }}</span>
            </td>
            <td class="text-center">
                {% if type.overdueReviews > 0 %}
                    <span class="badge bg-danger">{{ type.overdueReviews }}</span>
                {% else %}
                    <span class="badge bg-success">0</span>
                {% endif %}
            </td>
            <td class="text-center">
                <a href="{{ path('app_document_by_type', {type: type.id}) }}" class="btn btn-sm">
                    üëÅ {{ 'common.view'|trans }}
                </a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="7" class="text-center-p-xl-muted">
                {{ 'document.message.no_types'|trans }}
            </td>
        </tr>
        {% endfor %}
    {% endblock %}
{% endembed %}

{% endif %}
{% endblock %}
