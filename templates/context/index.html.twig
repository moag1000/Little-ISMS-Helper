{% extends 'base.html.twig' %}

{% block title %}{{ 'context_management.title'|trans }} - {{ 'app.title'|trans }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    {# Page Header #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">{{ 'context_management.title'|trans }}</h1>
            <p class="text-muted mb-0">
                {{ 'context_management.description'|trans }}
                {% if tenant is defined and tenant %}
                    <br>
                    <small>
                        <i class="bi bi-building" aria-hidden="true"></i>
                        <a href="{{ path('tenant_management_show', {id: tenant.id}) }}" class="text-decoration-none">
                            {{ tenant.name }} <i class="bi bi-box-arrow-up-right small" aria-hidden="true"></i>
                        </a>
                    </small>
                {% endif %}
            </p>
        </div>
        <div>
            {% if tenant is defined and tenant %}
                <a href="{{ path('tenant_management_show', {id: tenant.id}) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-building" aria-hidden="true"></i> {{ 'tenant.link.view'|trans|default('Mandant anzeigen') }}
                </a>
            {% endif %}
            {% if is_granted('ROLE_ADMIN') %}
                {% if canEdit is defined and canEdit %}
                    <a href="{{ path('app_context_edit') }}" class="btn btn-primary">
                        <i class="bi bi-pencil" aria-hidden="true"></i> {{ 'context.link.edit'|trans }}
                    </a>
                {% else %}
                    <button class="btn btn-primary" disabled title="{{ 'corporate.inheritance.cannot_edit_inherited'|trans }}">
                        <i class="bi bi-lock" aria-hidden="true"></i> {{ 'context.link.edit'|trans }}
                    </button>
                {% endif %}
                <a href="{{ path('app_objective_new') }}" class="btn btn-success">
                    <i class="bi bi-plus-circle" aria-hidden="true"></i> {{ 'objective.link.new'|trans }}
                </a>
            {% endif %}
        </div>
    </div>

    {# ISO 27001 Info Box #}
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle" aria-hidden="true"></i>
        <strong>{{ 'context.info.iso_clause'|trans }}</strong> {{ 'context.info.iso_description'|trans }}
    </div>

    {# Corporate Inheritance Alert #}
    {% if inheritanceInfo is defined and inheritanceInfo.isInherited %}
    <div class="alert alert-warning mb-4">
        <div class="d-flex align-items-start">
            <i class="bi bi-diagram-3 me-2 mt-1" aria-hidden="true"></i>
            <div>
                <strong>{{ 'corporate.inheritance.isms_context_inherited'|trans }}</strong><br>
                <span class="small">
                    {{ 'corporate.inheritance.from'|trans }}:
                    {% if inheritanceInfo.inheritedFrom %}
                        <a href="{{ path('tenant_management_show', {id: inheritanceInfo.inheritedFrom.id}) }}" class="alert-link">
                            {{ inheritanceInfo.inheritedFrom.name }}
                        </a>
                    {% endif %}
                </span><br>
                <span class="small text-muted">
                    {{ 'corporate.inheritance.edit_at_parent'|trans }}
                </span>
            </div>
        </div>
    </div>
    {% endif %}

    {# KPI Cards #}
    <div class="row mb-4">
        {# Completeness Card #}
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">{{ 'context.kpi.completeness'|trans }}</h6>
                    <h2 class="mb-0">{{ completeness }}%</h2>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar {% if completeness >= 80 %}bg-success{% elseif completeness >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                             role="progressbar"
                             style="width: {{ completeness }}%"
                             aria-valuenow="{{ completeness }}"
                             aria-valuemin="0"
                             aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>

        {# Active Objectives Card #}
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">{{ 'context.kpi.active_goals'|trans }}</h6>
                    <h2 class="mb-0">{{ statistics.active }}</h2>
                    <small class="text-muted">{{ 'context.kpi.of_total'|trans({'%total%': statistics.total}) }}</small>
                </div>
            </div>
        </div>

        {# Achieved Objectives Card #}
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">{{ 'context.kpi.achieved_goals'|trans }}</h6>
                    <h2 class="mb-0 text-success">{{ statistics.achieved }}</h2>
                    {% if statistics.total > 0 %}
                        <small class="text-muted">{{ 'context.kpi.success_rate'|trans({'%rate%': ((statistics.achieved / statistics.total) * 100)|round}) }}</small>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Review Status Card #}
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100 {% if isReviewDue %}border-warning{% endif %}">
                <div class="card-body">
                    <h6 class="text-muted mb-2">{{ 'context.kpi.next_review'|trans }}</h6>
                    {% if daysUntilReview is not null %}
                        {% if daysUntilReview > 0 %}
                            <h2 class="mb-0">{{ daysUntilReview }}</h2>
                            <small class="text-muted">{{ 'context.review_status.days_remaining'|trans }}</small>
                        {% elseif daysUntilReview == 0 %}
                            <h2 class="mb-0 text-warning">{{ 'context.review_status.today'|trans }}</h2>
                            <small class="text-warning">{{ 'context.review_status.due'|trans }}</small>
                        {% else %}
                            <h2 class="mb-0 text-danger">{{ daysUntilReview|abs }}</h2>
                            <small class="text-danger">{{ 'context.review_status.days_overdue'|trans }}</small>
                        {% endif %}
                    {% else %}
                        <h2 class="mb-0 text-muted">â€”</h2>
                        <small class="text-muted">{{ 'context.review_status.not_scheduled'|trans }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Main Content Grid #}
    <div class="row">
        {# ISMS Context Section #}
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ 'context.section.title'|trans }}</h5>
                    {% if is_granted('ROLE_ADMIN') %}
                        {% if canEdit is defined and canEdit %}
                            <a href="{{ path('app_context_edit') }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil" aria-hidden="true"></i> {{ 'common.edit'|trans }}
                            </a>
                        {% else %}
                            <button class="btn btn-sm btn-outline-secondary" disabled title="{{ 'corporate.inheritance.cannot_edit_inherited'|trans }}">
                                <i class="bi bi-lock" aria-hidden="true"></i> {{ 'common.edit'|trans }}
                            </button>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if context and context.organizationName %}
                        <div class="mb-3">
                            <h6 class="text-muted">{{ 'context.section.organization'|trans }}</h6>
                            <p class="mb-0">{{ context.organizationName }}</p>
                        </div>

                        {% if context.ismsScope %}
                            <div class="mb-3">
                                <h6 class="text-muted">{{ 'context_management.isms_scope'|trans }}</h6>
                                <p class="mb-0">{{ context.ismsScope|nl2br }}</p>
                            </div>
                        {% endif %}

                        {% if context.scopeExclusions %}
                            <div class="mb-3">
                                <h6 class="text-muted">{{ 'context.section.exclusions'|trans }}</h6>
                                <p class="mb-0">{{ context.scopeExclusions|nl2br }}</p>
                            </div>
                        {% endif %}

                        {% if context.ismsPolicy %}
                            <div class="mb-3">
                                <h6 class="text-muted">{{ 'context.section.policy'|trans }}</h6>
                                <p class="mb-0">{{ context.ismsPolicy|length > 200 ? context.ismsPolicy|slice(0, 200) ~ '...' : context.ismsPolicy|nl2br }}</p>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                            {{ 'context_management.no_context_defined'|trans }}
                            {% if is_granted('ROLE_ADMIN') and canEdit is defined and canEdit %}
                                <a href="{{ path('app_context_edit') }}" class="alert-link">{{ 'context.link.create_now'|trans }}</a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Objectives Summary Section #}
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ 'context_management.isms_objectives'|trans }}</h5>
                    <a href="{{ path('app_objective_index') }}" class="btn btn-sm btn-outline-secondary">
                        {{ 'common.show_all'|trans }} <i class="bi bi-arrow-right" aria-hidden="true"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">{{ 'objective.status.total'|trans }}</span>
                            <strong>{{ statistics.total }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">{{ 'objective.status.active'|trans }}</span>
                            <span class="badge bg-primary">{{ statistics.active }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">{{ 'objective.status.achieved'|trans }}</span>
                            <span class="badge bg-success">{{ statistics.achieved }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">{{ 'objective.status.delayed'|trans }}</span>
                            <span class="badge bg-danger">{{ statistics.delayed }}</span>
                        </div>
                        {% if statistics.at_risk is defined %}
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">{{ 'objective.status.at_risk'|trans }}</span>
                                <span class="badge bg-warning">{{ statistics.at_risk }}</span>
                            </div>
                        {% endif %}
                    </div>

                    {% if is_granted('ROLE_ADMIN') %}
                        <div class="d-grid mt-3">
                            <a href="{{ path('app_objective_new') }}" class="btn btn-success">
                                <i class="bi bi-plus-circle" aria-hidden="true"></i> {{ 'objective.link.create_new'|trans }}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Additional Context Information #}
    <div class="row">
        {% if context %}
            {# External Issues #}
            {% if context.externalIssues %}
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white">
                            <h6 class="mb-0">{{ 'context.section.external_issues'|trans }}</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ context.externalIssues|nl2br }}</p>
                        </div>
                    </div>
                </div>
            {% endif %}

            {# Internal Issues #}
            {% if context.internalIssues %}
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white">
                            <h6 class="mb-0">{{ 'context.section.internal_issues'|trans }}</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ context.internalIssues|nl2br }}</p>
                        </div>
                    </div>
                </div>
            {% endif %}

            {# Interested Parties #}
            {% if context.interestedParties %}
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white">
                            <h6 class="mb-0">{{ 'context.section.interested_parties'|trans }}</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ context.interestedParties|nl2br }}</p>
                        </div>
                    </div>
                </div>
            {% endif %}

            {# Requirements #}
            {% if context.legalRequirements or context.regulatoryRequirements or context.contractualObligations %}
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white">
                            <h6 class="mb-0">{{ 'context.section.requirements'|trans }}</h6>
                        </div>
                        <div class="card-body">
                            {% if context.legalRequirements %}
                                <h6 class="text-muted small">{{ 'context.section.legal_requirements'|trans }}</h6>
                                <p class="mb-2">{{ context.legalRequirements|nl2br }}</p>
                            {% endif %}
                            {% if context.regulatoryRequirements %}
                                <h6 class="text-muted small">{{ 'context.section.regulatory_requirements'|trans }}</h6>
                                <p class="mb-2">{{ context.regulatoryRequirements|nl2br }}</p>
                            {% endif %}
                            {% if context.contractualObligations %}
                                <h6 class="text-muted small">{{ 'context.section.contractual_obligations'|trans }}</h6>
                                <p class="mb-0">{{ context.contractualObligations|nl2br }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    </div>

    {# Context History: Audit Log #}
    {% if auditLogs is defined and auditLogs|length > 0 %}
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history" aria-hidden="true"></i> {{ 'context.section.history'|trans|default('Context History') }}
                        ({{ totalAuditLogs }} {{ 'audit_log.entries'|trans|default('entries') }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="audit-log-list">
                        {% for log in auditLogs %}
                        <div class="audit-log-entry">
                            <div class="audit-log-header">
                                <span class="badge bg-{{ log.action == 'create' ? 'success' : (log.action == 'update' ? 'info' : 'danger') }}">
                                    {{ log.action|upper }}
                                </span>
                                <span class="text-muted">
                                    {{ log.userName|default('System') }}
                                    &bull; {{ log.createdAt|date('Y-m-d H:i:s') }}
                                </span>
                            </div>
                            {% if log.action == 'update' %}
                                {% set oldValues = log.oldValuesArray %}
                                {% set newValues = log.newValuesArray %}
                                {% if oldValues and newValues %}
                                    <div class="audit-log-changes">
                                        {% for field, newValue in newValues %}
                                            {% if oldValues[field] is defined and oldValues[field] != newValue %}
                                                <div class="change-item">
                                                    <strong>{{ field }}:</strong>
                                                    <span class="text-danger">{{ oldValues[field]|length > 100 ? oldValues[field]|slice(0, 100) ~ '...' : oldValues[field] }}</span>
                                                    &rarr;
                                                    <span class="text-success">{{ newValue|length > 100 ? newValue|slice(0, 100) ~ '...' : newValue }}</span>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% if totalAuditLogs > 10 %}
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            {{ 'audit_log.showing_recent'|trans({'%count%': 10, '%total%': totalAuditLogs})|default('Showing 10 most recent of ' ~ totalAuditLogs ~ ' total entries') }}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
/* Audit Log Styles */
.audit-log-list {
    margin-top: 1rem;
}

.audit-log-entry {
    border-left: 3px solid #e5e7eb;
    padding-left: 1rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #f3f4f6;
}

.audit-log-entry:last-child {
    border-bottom: none;
}

.audit-log-header {
    margin-bottom: 0.5rem;
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.audit-log-changes {
    font-size: 0.875rem;
    margin-top: 0.5rem;
    padding-left: 1rem;
}

.change-item {
    margin-bottom: 0.25rem;
    word-break: break-word;
}

.change-item strong {
    color: #374151;
}

.text-danger {
    color: #dc2626;
}

.text-success {
    color: #10b981;
}
</style>
{% endblock %}
