{% extends 'base.html.twig' %}
{% trans_default_domain 'context' %}

{% block title %}{{ 'context_management.title'|trans({}, 'context') }} - {{ 'app.title'|trans({}, 'messages') }}{% endblock %}

{% block body %}
<div class="container-fluid">
    {# Breadcrumb Navigation #}
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'nav.dashboard'|trans({}, 'nav', 'nav'), url: path('app_dashboard') },
            { label: 'context_management.title'|trans({}, 'context') }
        ]
    } %}

    {# Page Header #}
    {% include '_components/_page_header.html.twig' with {
        title: 'context_management.title'|trans({}, 'context'),
        subtitle: 'context.info.subtitle'|trans({}, 'context'),
        icon: 'bi-building',
        actions: context ? [
            {
                label: 'context.link.edit'|trans({}, 'context'),
                url: path('app_context_edit'),
                variant: 'primary',
                icon: 'bi-pencil'
            }
        ] : [
            {
                label: 'context.link.create'|trans({}, 'context'),
                url: path('app_context_edit'),
                variant: 'primary',
                icon: 'bi-plus-circle'
            }
        ]
    } %}

    {% if context %}
    {# ISO 27001 Clause Information #}
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill icon-15-mr-md" aria-hidden="true"></i>
            <div>
                <div class="mb-1 fw-bold">{{ 'context.info.iso_clause'|trans({}, 'context') }}</div>
                <p class="mb-0 small">{{ 'context.info.iso_description'|trans({}, 'context') }}</p>
            </div>
        </div>
    </div>

    {# Calculate Stats #}
    {% set hasScope = context.ismsScope ? true : false %}
    {% set hasExclusions = context.scopeExclusions ? true : false %}
    {% set hasParties = context.interestedParties ? true : false %}
    {% set hasPolicy = context.ismsPolicy ? true : false %}
    {% set hasRequirements = (context.legalRequirements or context.regulatoryRequirements or context.contractualObligations) ? true : false %}
    {% set completeness = ((hasScope ? 1 : 0) + (hasParties ? 1 : 0) + (hasPolicy ? 1 : 0) + (hasRequirements ? 1 : 0)) %}
    {% set completenessPercentage = (completeness / 4 * 100)|round %}

    {% set daysSinceReview = context.lastReviewDate ? ((date().diff(context.lastReviewDate).days)) : null %}
    {% set daysUntilReview = context.nextReviewDate ? ((date().diff(context.nextReviewDate).days * -1)) : null %}

    {# KPI Cards #}
    <div class="kpi-grid">
        {% include '_components/_kpi_card.html.twig' with {
            icon: 'bi-check-circle',
            label: 'context.kpi.completeness'|trans({}, 'context'),
            value: completenessPercentage,
            unit: '%',
            variant: completenessPercentage >= 75 ? 'success' : (completenessPercentage >= 50 ? 'warning' : 'danger'),
            link: null
        } %}

        {% include '_components/_kpi_card.html.twig' with {
            icon: 'bi-bullseye',
            label: 'context.kpi.active_goals'|trans({}, 'context'),
            value: objectives|length,
            variant: 'info',
            link: path('app_objective_index')
        } %}

        {% include '_components/_kpi_card.html.twig' with {
            icon: 'bi-calendar-check',
            label: daysSinceReview ? 'context.kpi.days_since_review'|trans({}, 'context') : 'context.kpi.last_review'|trans({}, 'context'),
            value: daysSinceReview ?? '-',
            unit: daysSinceReview ? (daysSinceReview == 1 ? 'context.unit.day'|trans({}, 'context') : 'context.unit.days'|trans({}, 'context')) : '',
            variant: daysSinceReview ? (daysSinceReview > 365 ? 'danger' : (daysSinceReview > 180 ? 'warning' : 'success')) : 'secondary',
            link: null
        } %}

        {% include '_components/_kpi_card.html.twig' with {
            icon: 'bi-calendar-event',
            label: daysUntilReview ? 'context.kpi.days_until_review'|trans({}, 'context') : 'context.kpi.next_review'|trans({}, 'context'),
            value: daysUntilReview ?? '-',
            unit: daysUntilReview ? (daysUntilReview == 1 ? 'context.unit.day'|trans({}, 'context') : 'context.unit.days'|trans({}, 'context')) : '',
            variant: daysUntilReview ? (daysUntilReview < 30 ? 'warning' : (daysUntilReview < 0 ? 'danger' : 'info')) : 'secondary',
            link: null
        } %}
    </div>

    {# Overdue Review Warning #}
    {% if daysUntilReview and daysUntilReview < 0 %}
    {%- set overdueDate = context.nextReviewDate|date('d.m.Y') -%}
    {%- set overdueDays = (daysUntilReview * -1) -%}
    <div class="alert alert-danger mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill icon-15-mr-md" aria-hidden="true"></i>
            <div>
                <div class="mb-1 fw-bold">{{ 'context.message.overdue_review_title'|trans({}, 'context') }}</div>
                <p class="mb-0">{{ 'context.message.overdue_review_text'|trans({'%date%': overdueDate, '%days%': overdueDays}, 'context') }}</p>
            </div>
        </div>
    </div>
    {% elseif daysUntilReview and daysUntilReview < 30 %}
    {%- set upcomingDate = context.nextReviewDate|date('d.m.Y') -%}
    <div class="alert alert-warning mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-clock-fill icon-15-mr-md" aria-hidden="true"></i>
            <div>
                <div class="mb-1 fw-bold">{{ 'context.message.upcoming_review_title'|trans({}, 'context') }}</div>
                <p class="mb-0">{{ 'context.message.upcoming_review_text'|trans({'%date%': upcomingDate, '%days%': daysUntilReview}, 'context') }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    {# Organization & Scope Section #}
    <div class="row mb-4">
        <div class="col-md-6">
            {% embed '_components/_card.html.twig' with {class: 'h-100'} %}
                {% block card_header %}
                    <div class="card-header">
                        <h2 class="mb-0">
                            <i class="bi bi-building" aria-hidden="true"></i>
                            {{ 'context.section.organization'|trans({}, 'context') }}
                        </h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    <div class="mb-3">
                        <label class="text-muted small">{{ 'context.field.organization_name'|trans({}, 'context') }}</label>
                        <div class="h4 mb-0">{{ context.organizationName }}</div>
                    </div>

                    {% if context.ismsScope %}
                    <div class="mb-3">
                        <label class="text-muted small">
                            <i class="bi bi-check-circle text-success" aria-hidden="true"></i>
                            {{ 'context.field.isms_scope'|trans({}, 'context') }}
                        </label>
                        <p class="mb-0">{{ context.ismsScope|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if context.scopeExclusions %}
                    <div class="mb-3">
                        <label class="text-muted small">
                            <i class="bi bi-x-circle text-danger" aria-hidden="true"></i>
                            {{ 'context.field.scope_exclusions'|trans({}, 'context') }}
                        </label>
                        <p class="mb-0">{{ context.scopeExclusions|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if context.lastReviewDate or context.nextReviewDate %}
                    <div class="mt-4 pt-3 border-top-light">
                        {% if context.lastReviewDate %}
                        <div class="small text-muted mb-1">
                            <i class="bi bi-calendar-check" aria-hidden="true"></i>
                            {{ 'context.kpi.last_review'|trans({}, 'context') }}: <strong>{{ context.lastReviewDate|date('d.m.Y') }}</strong>
                        </div>
                        {% endif %}
                        {% if context.nextReviewDate %}
                        <div class="small text-muted">
                            <i class="bi bi-calendar-event" aria-hidden="true"></i>
                            {{ 'context.kpi.next_review'|trans({}, 'context') }}: <strong>{{ context.nextReviewDate|date('d.m.Y') }}</strong>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>

        <div class="col-md-6">
            {% embed '_components/_card.html.twig' with {class: 'h-100'} %}
                {% block card_header %}
                    <div class="card-header">
                        <h2 class="mb-0">
                            <i class="bi bi-diagram-3" aria-hidden="true"></i>
                            {{ 'context.section.context_analysis'|trans({}, 'context') }}
                        </h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    {% if context.externalIssues %}
                    <div class="mb-3">
                        <label class="text-muted small">
                            <i class="bi bi-globe" aria-hidden="true"></i>
                            {{ 'context.field.external_issues'|trans({}, 'context') }}
                        </label>
                        <p class="mb-0 small">{{ context.externalIssues|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if context.internalIssues %}
                    <div class="mb-3">
                        <label class="text-muted small">
                            <i class="bi bi-building" aria-hidden="true"></i>
                            {{ 'context.field.internal_issues'|trans({}, 'context') }}
                        </label>
                        <p class="mb-0 small">{{ context.internalIssues|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if not context.externalIssues and not context.internalIssues %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-info-circle icon-2-opacity-3" aria-hidden="true"></i>
                        <p class="small mt-2 mb-0">{{ 'context.message.no_context_topics'|trans({}, 'context') }}</p>
                    </div>
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>
    </div>

    {# Interested Parties Section #}
    {% embed '_components/_card.html.twig' with {class: 'mb-4'} %}
        {% block card_header %}
            <div class="card-header">
                <h2 class="mb-0">
                    <i class="bi bi-people" aria-hidden="true"></i>
                    {{ 'context.section.interested_parties_and_requirements'|trans({}, 'context') }}
                </h2>
            </div>
        {% endblock %}
        {% block card_body %}
            <div class="row">
                <div class="col-md-6">
                    {% if context.interestedParties %}
                    <label class="text-muted small mb-2">
                        <i class="bi bi-people-fill text-primary" aria-hidden="true"></i>
                        {{ 'context.section.interested_parties'|trans({}, 'context') }}
                    </label>
                    <p class="mb-0">{{ context.interestedParties|nl2br }}</p>
                    {% else %}
                    <div class="text-center py-3 text-muted">
                        <i class="bi bi-people icon-2-opacity-3" aria-hidden="true"></i>
                        <p class="small mt-2 mb-0">{{ 'context.message.no_interested_parties'|trans({}, 'context') }}</p>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if context.interestedPartiesRequirements %}
                    <label class="text-muted small mb-2">
                        <i class="bi bi-list-check text-success" aria-hidden="true"></i>
                        {{ 'context.field.interested_parties_requirements'|trans({}, 'context') }}
                    </label>
                    <p class="mb-0">{{ context.interestedPartiesRequirements|nl2br }}</p>
                    {% else %}
                    <div class="text-center py-3 text-muted">
                        <i class="bi bi-list-check icon-2-opacity-3" aria-hidden="true"></i>
                        <p class="small mt-2 mb-0">{{ 'context.message.no_requirements'|trans({}, 'context') }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endblock %}
    {% endembed %}

    {# Requirements Section #}
    {% embed '_components/_card.html.twig' with {class: 'mb-4'} %}
        {% block card_header %}
            <div class="card-header">
                <h2 class="mb-0">
                    <i class="bi bi-shield-check" aria-hidden="true"></i>
                    {{ 'context.section.compliance'|trans({}, 'context') }}
                </h2>
            </div>
        {% endblock %}
        {% block card_body %}
            <div class="row">
                <div class="col-md-4">
                    <div class="requirement-box">
                        <label class="text-muted small mb-2">
                            <i class="bi bi-file-earmark-text text-warning" aria-hidden="true"></i>
                            {{ 'context.section.legal_requirements'|trans({}, 'context') }}
                        </label>
                        {% if context.legalRequirements %}
                        <p class="small mb-0">{{ context.legalRequirements|nl2br }}</p>
                        {% else %}
                        <p class="small text-muted mb-0">{{ 'context.message.no_requirements'|trans({}, 'context') }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="requirement-box">
                        <label class="text-muted small mb-2">
                            <i class="bi bi-file-earmark-ruled text-info" aria-hidden="true"></i>
                            {{ 'context.section.regulatory_requirements'|trans({}, 'context') }}
                        </label>
                        {% if context.regulatoryRequirements %}
                        <p class="small mb-0">{{ context.regulatoryRequirements|nl2br }}</p>
                        {% else %}
                        <p class="small text-muted mb-0">{{ 'context.message.no_requirements'|trans({}, 'context') }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="requirement-box">
                        <label class="text-muted small mb-2">
                            <i class="bi bi-file-earmark-check text-success" aria-hidden="true"></i>
                            {{ 'context.section.contractual_obligations'|trans({}, 'context') }}
                        </label>
                        {% if context.contractualObligations %}
                        <p class="small mb-0">{{ context.contractualObligations|nl2br }}</p>
                        {% else %}
                        <p class="small text-muted mb-0">{{ 'context.message.no_requirements'|trans({}, 'context') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endblock %}
    {% endembed %}

    {# ISMS Policy & Roles Section #}
    <div class="row mb-4">
        <div class="col-md-6">
            {% embed '_components/_card.html.twig' with {class: 'h-100'} %}
                {% block card_header %}
                    <div class="card-header">
                        <h2 class="mb-0">
                            <i class="bi bi-file-earmark-text" aria-hidden="true"></i>
                            {{ 'context.field.isms_policy'|trans({}, 'context') }}
                        </h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    {% if context.ismsPolicy %}
                    <p class="mb-0">{{ context.ismsPolicy|nl2br }}</p>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-file-earmark-text icon-3-opacity-3" aria-hidden="true"></i>
                        <p class="small mt-2 mb-0">{{ 'context.message.no_requirements'|trans({}, 'context') }}</p>
                    </div>
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>

        <div class="col-md-6">
            {% embed '_components/_card.html.twig' with {class: 'h-100'} %}
                {% block card_header %}
                    <div class="card-header">
                        <h2 class="mb-0">
                            <i class="bi bi-person-badge" aria-hidden="true"></i>
                            {{ 'context.field.roles_and_responsibilities'|trans({}, 'context') }}
                        </h2>
                    </div>
                {% endblock %}
                {% block card_body %}
                    {% if context.rolesAndResponsibilities %}
                    <p class="mb-0">{{ context.rolesAndResponsibilities|nl2br }}</p>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-person-badge icon-3-opacity-3" aria-hidden="true"></i>
                        <p class="small mt-2 mb-0">{{ 'context.message.no_requirements'|trans({}, 'context') }}</p>
                    </div>
                    {% endif %}
                {% endblock %}
            {% endembed %}
        </div>
    </div>

    {# ISMS Objectives Section #}
    {% if objectives|length > 0 %}
    {% embed '_components/_card.html.twig' %}
        {% block card_header %}
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="bi bi-target" aria-hidden="true"></i>
                    {{ 'context.section.objectives'|trans({}, 'context') }}
                </h2>
                <a href="{{ path('app_objective_index') }}" class="btn btn-sm btn-outline-primary">
                    {{ 'context.action.manage_objectives'|trans({}, 'context') }}
                    <i class="bi bi-arrow-right" aria-hidden="true"></i>
                </a>
            </div>
        {% endblock %}
        {% block card_body %}
            {% embed '_components/_table.html.twig' with {
                'class': 'table-hover mb-0',
                'responsive': true,
                'noMargin': true
            } %}
                {% block table_head %}
                    <tr>
                        <th scope="col">{{ 'common.title'|trans({}, 'messages') }}</th>
                        <th scope="col">{{ 'common.category'|trans({}, 'messages') }}</th>
                        <th scope="col">{{ 'common.responsible'|trans({}, 'messages') }}</th>
                        <th scope="col">{{ 'common.target_date'|trans({}, 'messages') }}</th>
                        <th scope="col">{{ 'common.status'|trans({}, 'messages') }}</th>
                        <th scope="col">{{ 'common.actions'|trans({}, 'messages') }}</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% for objective in objectives|slice(0, 5) %}
                    <tr>
                        <td>
                            <strong>{{ objective.title }}</strong>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ objective.category }}</span>
                        </td>
                        <td>{{ objective.responsiblePerson }}</td>
                        <td>
                            <i class="bi bi-calendar3" aria-hidden="true"></i>
                            {{ objective.targetDate|date('d.m.Y') }}
                        </td>
                        <td>
                            {% set statusClasses = {
                                'achieved': 'success',
                                'in_progress': 'info',
                                'not_started': 'warning',
                                'delayed': 'danger'
                            } %}
                            <span class="badge bg-{{ statusClasses[objective.status] ?? 'secondary' }}">
                                {{ objective.status|replace({'_': ' '})|title }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ path('app_objective_show', {id: objective.id}) }}"
                               class="btn btn-sm btn-outline-primary" aria-label="{{ 'common.view'|trans({}, 'messages') }}">
                                <i class="bi bi-eye" aria-hidden="true"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
            {% if objectives|length > 5 %}
            <div class="text-center mt-3">
                <a href="{{ path('app_objective_index') }}" class="btn btn-sm btn-outline-secondary">
                    {{ 'context.action.view_all_objectives'|trans({'%count%': objectives|length}, 'context') }}
                </a>
            </div>
            {% endif %}
        {% endblock %}
    {% endembed %}
    {% else %}
    {% embed '_components/_card.html.twig' %}
        {% block card_header %}
            <div class="card-header">
                <h2 class="mb-0">
                    <i class="bi bi-target" aria-hidden="true"></i>
                    {{ 'context.section.objectives'|trans({}, 'context') }}
                </h2>
            </div>
        {% endblock %}
        {% block card_body %}
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle" aria-hidden="true"></i>
                {{ 'context.message.no_objectives'|trans({}, 'context') }}
                <a href="{{ path('app_objective_index') }}" class="alert-link">
                    {{ 'context.action.manage_objectives'|trans({}, 'context') }}
                </a>
            </div>
        {% endblock %}
    {% endembed %}
    {% endif %}

    {% else %}
    {# Empty State - No Context #}
    {% include '_components/_empty_state.html.twig' with {
        icon: 'bi-building',
        title: 'context.empty.title'|trans({}, 'context'),
        description: 'context.empty.description'|trans({}, 'context'),
        action: {
            label: 'context.action.create_context'|trans({}, 'context'),
            url: path('app_context_edit'),
            icon: 'bi-plus-circle'
        }
    } %}

    {# Information Box #}
    {% embed '_components/_card.html.twig' with {class: 'mt-4'} %}
        {% block card_header %}
            <div class="card-header bg-light">
                <h2 class="mb-0">
                    <i class="bi bi-lightbulb" aria-hidden="true"></i>
                    {{ 'context.info.box_title'|trans({}, 'context') }}
                </h2>
            </div>
        {% endblock %}
        {% block card_body %}
            <div class="row">
                <div class="col-md-6">
                    <h3><i class="bi bi-1-circle text-primary" aria-hidden="true"></i> {{ 'context.info.clause41_title'|trans({}, 'context') }}</h3>
                    <ul class="small">
                        <li>{{ 'context.info.clause41_items.external_issues'|trans({}, 'context') }}</li>
                        <li>{{ 'context.info.clause41_items.internal_issues'|trans({}, 'context') }}</li>
                        <li>{{ 'context.info.clause41_items.scope'|trans({}, 'context') }}</li>
                        <li>{{ 'context.info.clause41_items.exclusions'|trans({}, 'context') }}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h3><i class="bi bi-2-circle text-primary" aria-hidden="true"></i> {{ 'context.info.clause42_title'|trans({}, 'context') }}</h3>
                    <ul class="small">
                        <li>{{ 'context.info.clause42_items.identify'|trans({}, 'context') }}</li>
                        <li>{{ 'context.info.clause42_items.requirements'|trans({}, 'context') }}</li>
                        <li>{{ 'context.info.clause42_items.legal_regulatory'|trans({}, 'context') }}</li>
                        <li>{{ 'context.info.clause42_items.contractual'|trans({}, 'context') }}</li>
                    </ul>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <h3><i class="bi bi-3-circle text-primary" aria-hidden="true"></i> {{ 'context.info.clause43_title'|trans({}, 'context') }}</h3>
                    <ul class="small">
                        <li>{{ 'context.info.clause43_items.boundaries'|trans({}, 'context') }}</li>
                        <li>{{ 'context.info.clause43_items.locations_processes'|trans({}, 'context') }}</li>
                        <li>{{ 'context.info.clause43_items.justified_exclusions'|trans({}, 'context') }}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h3><i class="bi bi-4-circle text-primary" aria-hidden="true"></i> {{ 'context.info.clause44_title'|trans({}, 'context') }}</h3>
                    <ul class="small">
                        <li>{{ 'context.info.clause44_items.policy_objectives'|trans({}, 'context') }}</li>
                        <li>{{ 'context.info.clause44_items.roles_responsibilities'|trans({}, 'context') }}</li>
                        <li>{{ 'context.info.clause44_items.processes'|trans({}, 'context') }}</li>
                    </ul>
                </div>
            </div>
        {% endblock %}
    {% endembed %}
    {% endif %}
</div>

<style>
.requirement-box {
    padding: var(--spacing-md);
    background: var(--color-bg);
    border-radius: var(--border-radius);
    height: 100%;
}

.requirement-box:hover {
    background: rgba(52, 152, 219, 0.05);
    transition: background 0.2s;
}

/* Hover effect for cards */
.card:hover {
    box-shadow: var(--shadow-md);
    transition: box-shadow 0.2s;
}

/* Table row hover */
.table tbody tr:hover {
    background-color: rgba(52, 152, 219, 0.05);
    transition: background-color 0.2s;
}
</style>
{% endblock %}
