{% extends 'base.html.twig' %}

{% block title %}ISMS Context{% endblock %}

{% block body %}
<div class="container-fluid">
    {# Breadcrumb Navigation #}
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'Dashboard', url: path('app_dashboard') },
            { label: 'ISMS Context' }
        ]
    } %}

    {# Page Header #}
    {% include '_components/_page_header.html.twig' with {
        title: 'ISMS Context',
        subtitle: 'Organisationskontext, Geltungsbereich und interessierte Parteien gemäß ISO 27001 Clause 4',
        icon: 'bi-building',
        actions: context ? [
            {
                label: 'Context bearbeiten',
                url: path('app_context_edit'),
                variant: 'primary',
                icon: 'bi-pencil'
            }
        ] : [
            {
                label: 'Context erfassen',
                url: path('app_context_edit'),
                variant: 'primary',
                icon: 'bi-plus-circle'
            }
        ]
    } %}

    {% if context %}
    {# ISO 27001 Clause Information #}
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill icon-15-mr-md"></i>
            <div>
                <h6 class="mb-1"><strong>ISO/IEC 27001:2022 - Clause 4</strong></h6>
                <p class="mb-0 small">
                    Der ISMS-Kontext definiert die Organisation, deren Umfeld, interessierte Parteien und den Geltungsbereich des Informationssicherheits-Managementsystems.
                </p>
            </div>
        </div>
    </div>

    {# Calculate Stats #}
    {% set hasScope = context.ismsScope ? true : false %}
    {% set hasExclusions = context.scopeExclusions ? true : false %}
    {% set hasParties = context.interestedParties ? true : false %}
    {% set hasPolicy = context.ismsPolicy ? true : false %}
    {% set hasRequirements = (context.legalRequirements or context.regulatoryRequirements or context.contractualObligations) ? true : false %}
    {% set completeness = ((hasScope ? 1 : 0) + (hasParties ? 1 : 0) + (hasPolicy ? 1 : 0) + (hasRequirements ? 1 : 0)) %}
    {% set completenessPercentage = (completeness / 4 * 100)|round %}

    {% set daysSinceReview = context.lastReviewDate ? ((date().diff(context.lastReviewDate).days)) : null %}
    {% set daysUntilReview = context.nextReviewDate ? ((date().diff(context.nextReviewDate).days * -1)) : null %}

    {# KPI Cards #}
    <div class="kpi-grid">
        {% include '_components/_kpi_card.html.twig' with {
            icon: 'bi-check-circle',
            label: 'Context Vollständigkeit',
            value: completenessPercentage,
            unit: '%',
            variant: completenessPercentage >= 75 ? 'success' : (completenessPercentage >= 50 ? 'warning' : 'danger'),
            link: null
        } %}

        {% include '_components/_kpi_card.html.twig' with {
            icon: 'bi-bullseye',
            label: 'Aktive ISMS-Ziele',
            value: objectives|length,
            variant: 'info',
            link: path('app_objective_index')
        } %}

        {% include '_components/_kpi_card.html.twig' with {
            icon: 'bi-calendar-check',
            label: daysSinceReview ? 'Tage seit Review' : 'Letztes Review',
            value: daysSinceReview ?? '-',
            unit: daysSinceReview ? (daysSinceReview == 1 ? 'Tag' : 'Tage') : '',
            variant: daysSinceReview ? (daysSinceReview > 365 ? 'danger' : (daysSinceReview > 180 ? 'warning' : 'success')) : 'secondary',
            link: null
        } %}

        {% include '_components/_kpi_card.html.twig' with {
            icon: 'bi-calendar-event',
            label: daysUntilReview ? 'Tage bis Review' : 'Nächstes Review',
            value: daysUntilReview ?? '-',
            unit: daysUntilReview ? (daysUntilReview == 1 ? 'Tag' : 'Tage') : '',
            variant: daysUntilReview ? (daysUntilReview < 30 ? 'warning' : (daysUntilReview < 0 ? 'danger' : 'info')) : 'secondary',
            link: null
        } %}
    </div>

    {# Overdue Review Warning #}
    {% if daysUntilReview and daysUntilReview < 0 %}
    <div class="alert alert-danger mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill icon-15-mr-md"></i>
            <div>
                <h6 class="mb-1"><strong>Context Review überfällig!</strong></h6>
                <p class="mb-0">
                    Das nächste Review war geplant für <strong>{{ context.nextReviewDate|date('d.m.Y') }}</strong>
                    (vor {{ (daysUntilReview * -1) }} Tagen). Bitte aktualisieren Sie den ISMS-Kontext.
                </p>
            </div>
        </div>
    </div>
    {% elseif daysUntilReview and daysUntilReview < 30 %}
    <div class="alert alert-warning mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-clock-fill icon-15-mr-md"></i>
            <div>
                <h6 class="mb-1"><strong>Context Review bald fällig</strong></h6>
                <p class="mb-0">
                    Das nächste Review ist geplant für <strong>{{ context.nextReviewDate|date('d.m.Y') }}</strong>
                    (in {{ daysUntilReview }} Tagen).
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    {# Organization & Scope Section #}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h2 class="mb-0">
                        <i class="bi bi-building"></i>
                        Organisation
                    </h2>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Organisationsname</label>
                        <h4 class="mb-0">{{ context.organizationName }}</h4>
                    </div>

                    {% if context.ismsScope %}
                    <div class="mb-3">
                        <label class="text-muted small">
                            <i class="bi bi-check-circle text-success"></i>
                            ISMS Geltungsbereich
                        </label>
                        <p class="mb-0">{{ context.ismsScope|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if context.scopeExclusions %}
                    <div class="mb-3">
                        <label class="text-muted small">
                            <i class="bi bi-x-circle text-danger"></i>
                            Ausschlüsse
                        </label>
                        <p class="mb-0">{{ context.scopeExclusions|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if context.lastReviewDate or context.nextReviewDate %}
                    <div class="mt-4 pt-3 border-top-light">
                        {% if context.lastReviewDate %}
                        <div class="small text-muted mb-1">
                            <i class="bi bi-calendar-check"></i>
                            Letztes Review: <strong>{{ context.lastReviewDate|date('d.m.Y') }}</strong>
                        </div>
                        {% endif %}
                        {% if context.nextReviewDate %}
                        <div class="small text-muted">
                            <i class="bi bi-calendar-event"></i>
                            Nächstes Review: <strong>{{ context.nextReviewDate|date('d.m.Y') }}</strong>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h2 class="mb-0">
                        <i class="bi bi-diagram-3"></i>
                        Kontext & Themen
                    </h2>
                </div>
                <div class="card-body">
                    {% if context.externalIssues %}
                    <div class="mb-3">
                        <label class="text-muted small">
                            <i class="bi bi-globe"></i>
                            Externe Themen
                        </label>
                        <p class="mb-0 small">{{ context.externalIssues|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if context.internalIssues %}
                    <div class="mb-3">
                        <label class="text-muted small">
                            <i class="bi bi-building"></i>
                            Interne Themen
                        </label>
                        <p class="mb-0 small">{{ context.internalIssues|nl2br }}</p>
                    </div>
                    {% endif %}

                    {% if not context.externalIssues and not context.internalIssues %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-info-circle icon-2-opacity-3"></i>
                        <p class="small mt-2 mb-0">Keine Kontext-Themen erfasst</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Interested Parties Section #}
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="mb-0">
                <i class="bi bi-people"></i>
                Interessierte Parteien & deren Anforderungen
            </h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    {% if context.interestedParties %}
                    <label class="text-muted small mb-2">
                        <i class="bi bi-people-fill text-primary"></i>
                        Identifizierte interessierte Parteien
                    </label>
                    <p class="mb-0">{{ context.interestedParties|nl2br }}</p>
                    {% else %}
                    <div class="text-center py-3 text-muted">
                        <i class="bi bi-people icon-2-opacity-3"></i>
                        <p class="small mt-2 mb-0">Keine interessierten Parteien erfasst</p>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if context.interestedPartiesRequirements %}
                    <label class="text-muted small mb-2">
                        <i class="bi bi-list-check text-success"></i>
                        Anforderungen der interessierten Parteien
                    </label>
                    <p class="mb-0">{{ context.interestedPartiesRequirements|nl2br }}</p>
                    {% else %}
                    <div class="text-center py-3 text-muted">
                        <i class="bi bi-list-check icon-2-opacity-3"></i>
                        <p class="small mt-2 mb-0">Keine Anforderungen erfasst</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Requirements Section #}
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="mb-0">
                <i class="bi bi-shield-check"></i>
                Rechtliche & regulatorische Anforderungen
            </h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="requirement-box">
                        <label class="text-muted small mb-2">
                            <i class="bi bi-file-earmark-text text-warning"></i>
                            Gesetzliche Anforderungen
                        </label>
                        {% if context.legalRequirements %}
                        <p class="small mb-0">{{ context.legalRequirements|nl2br }}</p>
                        {% else %}
                        <p class="small text-muted mb-0">Nicht erfasst</p>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="requirement-box">
                        <label class="text-muted small mb-2">
                            <i class="bi bi-file-earmark-ruled text-info"></i>
                            Regulatorische Anforderungen
                        </label>
                        {% if context.regulatoryRequirements %}
                        <p class="small mb-0">{{ context.regulatoryRequirements|nl2br }}</p>
                        {% else %}
                        <p class="small text-muted mb-0">Nicht erfasst</p>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="requirement-box">
                        <label class="text-muted small mb-2">
                            <i class="bi bi-file-earmark-check text-success"></i>
                            Vertragliche Verpflichtungen
                        </label>
                        {% if context.contractualObligations %}
                        <p class="small mb-0">{{ context.contractualObligations|nl2br }}</p>
                        {% else %}
                        <p class="small text-muted mb-0">Nicht erfasst</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ISMS Policy & Roles Section #}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h2 class="mb-0">
                        <i class="bi bi-file-earmark-text"></i>
                        ISMS Policy
                    </h2>
                </div>
                <div class="card-body">
                    {% if context.ismsPolicy %}
                    <p class="mb-0">{{ context.ismsPolicy|nl2br }}</p>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-file-earmark-text icon-3-opacity-3"></i>
                        <p class="small mt-2 mb-0">ISMS Policy noch nicht erfasst</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h2 class="mb-0">
                        <i class="bi bi-person-badge"></i>
                        Rollen & Verantwortlichkeiten
                    </h2>
                </div>
                <div class="card-body">
                    {% if context.rolesAndResponsibilities %}
                    <p class="mb-0">{{ context.rolesAndResponsibilities|nl2br }}</p>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-person-badge icon-3-opacity-3"></i>
                        <p class="small mt-2 mb-0">Rollen & Verantwortlichkeiten noch nicht erfasst</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# ISMS Objectives Section #}
    {% if objectives|length > 0 %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                <i class="bi bi-target"></i>
                Aktive ISMS-Ziele
            </h2>
            <a href="{{ path('app_objective_index') }}" class="btn btn-sm btn-outline-primary">
                Alle Ziele anzeigen
                <i class="bi bi-arrow-right"></i>
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Titel</th>
                            <th>Kategorie</th>
                            <th>Verantwortlich</th>
                            <th>Zieldatum</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for objective in objectives|slice(0, 5) %}
                        <tr>
                            <td>
                                <strong>{{ objective.title }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ objective.category }}</span>
                            </td>
                            <td>{{ objective.responsiblePerson }}</td>
                            <td>
                                <i class="bi bi-calendar3"></i>
                                {{ objective.targetDate|date('d.m.Y') }}
                            </td>
                            <td>
                                {% set statusClasses = {
                                    'achieved': 'success',
                                    'in_progress': 'info',
                                    'not_started': 'warning',
                                    'delayed': 'danger'
                                } %}
                                <span class="badge bg-{{ statusClasses[objective.status] ?? 'secondary' }}">
                                    {{ objective.status|replace({'_': ' '})|title }}
                                </span>
                            </td>
                            <td>
                                <a href="{{ path('app_objective_show', {id: objective.id}) }}"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if objectives|length > 5 %}
            <div class="text-center mt-3">
                <a href="{{ path('app_objective_index') }}" class="btn btn-sm btn-outline-secondary">
                    Alle {{ objectives|length }} Ziele anzeigen
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-header">
            <h2 class="mb-0">
                <i class="bi bi-target"></i>
                ISMS-Ziele
            </h2>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle"></i>
                Noch keine aktiven ISMS-Ziele definiert.
                <a href="{{ path('app_objective_index') }}" class="alert-link">
                    Ziele verwalten
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    {# Empty State - No Context #}
    {% include '_components/_empty_state.html.twig' with {
        icon: 'bi-building',
        title: 'Noch kein ISMS-Kontext definiert',
        description: 'Erfassen Sie zunächst den Organisationskontext gemäß ISO 27001 Clause 4. Dies ist die Grundlage für Ihr Informationssicherheits-Managementsystem.',
        action: {
            label: 'ISMS-Kontext erfassen',
            url: path('app_context_edit'),
            icon: 'bi-plus-circle'
        }
    } %}

    {# Information Box #}
    <div class="card mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-lightbulb"></i>
                Was gehört zum ISMS-Kontext?
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="bi bi-1-circle text-primary"></i> Clause 4.1 - Verstehen der Organisation</h6>
                    <ul class="small">
                        <li>Externe Themen (Markt, Technologie, Compliance)</li>
                        <li>Interne Themen (Strategie, Kultur, Prozesse)</li>
                        <li>ISMS-Geltungsbereich</li>
                        <li>Ausschlüsse und Begründungen</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-2-circle text-primary"></i> Clause 4.2 - Interessierte Parteien</h6>
                    <ul class="small">
                        <li>Identifikation aller relevanten Parteien</li>
                        <li>Deren Anforderungen an Informationssicherheit</li>
                        <li>Gesetzliche und regulatorische Verpflichtungen</li>
                        <li>Vertragliche Anforderungen</li>
                    </ul>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6><i class="bi bi-3-circle text-primary"></i> Clause 4.3 - ISMS-Geltungsbereich</h6>
                    <ul class="small">
                        <li>Physische und organisatorische Grenzen</li>
                        <li>Einbezogene Standorte und Prozesse</li>
                        <li>Begründete Ausschlüsse</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-4-circle text-primary"></i> Clause 4.4 - ISMS</h6>
                    <ul class="small">
                        <li>ISMS Policy und Ziele</li>
                        <li>Rollen und Verantwortlichkeiten</li>
                        <li>Prozesse und deren Wechselwirkungen</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.requirement-box {
    padding: var(--spacing-md);
    background: var(--color-bg);
    border-radius: var(--border-radius);
    height: 100%;
}

.requirement-box:hover {
    background: rgba(52, 152, 219, 0.05);
    transition: background 0.2s;
}

/* Hover effect for cards */
.card:hover {
    box-shadow: var(--shadow-md);
    transition: box-shadow 0.2s;
}

/* Table row hover */
.table tbody tr:hover {
    background-color: rgba(52, 152, 219, 0.05);
    transition: background-color 0.2s;
}
</style>
{% endblock %}
