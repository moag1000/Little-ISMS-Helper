{% extends 'base.html.twig' %}

{% block title %}Edit DPIA - {{ dpia.referenceNumber }}{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'GDPR', icon: 'bi-shield-check' },
            { label: 'DPIA', url: path('app_dpia_index') },
            { label: dpia.referenceNumber, url: path('app_dpia_show', {id: dpia.id}) },
            { label: 'Edit' }
        ]
    } %}

    {% include '_components/_page_header.html.twig' with {
        title: 'Edit DPIA: ' ~ dpia.title,
        subtitle: dpia.referenceNumber ~ ' - Version ' ~ dpia.version,
        icon: 'bi-pencil-square',
        actions: [
            { label: 'Cancel', url: path('app_dpia_show', {id: dpia.id}), variant: 'secondary', icon: 'bi-x-lg' }
        ]
    } %}

    {% if dpia.status == 'requires_revision' and dpia.rejectionReason %}
        <div class="alert alert-warning">
            <h6><i class="bi bi-exclamation-triangle"></i> Revision Required</h5>
            <p class="mb-0">{{ dpia.rejectionReason }}</p>
        </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <h1 class="h5 mb-0"><i class="bi bi-clipboard-check"></i> DPIA Form</h1>
        </div>
        <div class="card-body">
            {{ form_start(form) }}
                {% include '_components/_auto_form.html.twig' with {
                    'form': form,
                    'sections': {
                        'basic_info': {
                            'label': '<i class="bi bi-info-circle" aria-hidden="true"></i> Basic Information'|raw,
                            'fields': ['title', 'referenceNumber', 'processingActivity']
                        },
                        'processing_operations': {
                            'label': '<i class="bi bi-gear" aria-hidden="true"></i> Art. 35(7)(a) - Description of Processing Operations'|raw,
                            'fields': ['processingDescription', 'processingPurposes', 'dataCategories', 'dataSubjectCategories', 'estimatedDataSubjects', 'dataRetentionPeriod', 'dataFlowDescription']
                        },
                        'necessity_proportionality': {
                            'label': '<i class="bi bi-balance-scale" aria-hidden="true"></i> Art. 35(7)(b) - Assessment of Necessity and Proportionality'|raw,
                            'fields': ['necessityAssessment', 'proportionalityAssessment', 'legalBasis', 'legislativeCompliance']
                        },
                        'risk_assessment': {
                            'label': '<i class="bi bi-exclamation-triangle" aria-hidden="true"></i> Art. 35(7)(c) - Risk Assessment'|raw,
                            'fields': ['riskLevel', 'likelihood', 'impact', 'dataSubjectRisks']
                        },
                        'measures': {
                            'label': '<i class="bi bi-shield-check" aria-hidden="true"></i> Art. 35(7)(d) - Measures to Address Risks'|raw,
                            'fields': ['technicalMeasures', 'organizationalMeasures', 'implementedControls', 'complianceMeasures', 'residualRiskAssessment', 'residualRiskLevel']
                        },
                        'consultation': {
                            'label': '<i class="bi bi-people" aria-hidden="true"></i> Stakeholder Consultation (Art. 35(4), 35(9))'|raw,
                            'fields': ['dataProtectionOfficer', 'dpoConsultationDate', 'dpoAdvice', 'dataSubjectsConsulted', 'dataSubjectConsultationDetails']
                        },
                        'supervisory': {
                            'label': '<i class="bi bi-building" aria-hidden="true"></i> Supervisory Authority Consultation (Art. 36)'|raw,
                            'fields': ['requiresSupervisoryConsultation', 'supervisoryConsultationDate', 'supervisoryAuthorityFeedback']
                        },
                        'workflow': {
                            'label': '<i class="bi bi-arrow-repeat" aria-hidden="true"></i> Workflow & Review'|raw,
                            'fields': ['conductor', 'reviewFrequencyMonths', 'nextReviewDate']
                        }
                    },
                    'col_widths': {
                        'title': 8,
                        'referenceNumber': 4,
                        'processingActivity': 12,
                        'processingDescription': 12,
                        'processingPurposes': 12,
                        'dataCategories': 12,
                        'dataSubjectCategories': 12,
                        'estimatedDataSubjects': 6,
                        'dataRetentionPeriod': 6,
                        'dataFlowDescription': 12,
                        'necessityAssessment': 12,
                        'proportionalityAssessment': 12,
                        'legalBasis': 6,
                        'legislativeCompliance': 6,
                        'riskLevel': 4,
                        'likelihood': 4,
                        'impact': 4,
                        'dataSubjectRisks': 12,
                        'technicalMeasures': 12,
                        'organizationalMeasures': 12,
                        'implementedControls': 12,
                        'complianceMeasures': 12,
                        'residualRiskAssessment': 6,
                        'residualRiskLevel': 6,
                        'dataProtectionOfficer': 6,
                        'dpoConsultationDate': 6,
                        'dpoAdvice': 12,
                        'dataSubjectsConsulted': 12,
                        'dataSubjectConsultationDetails': 12,
                        'requiresSupervisoryConsultation': 12,
                        'supervisoryConsultationDate': 6,
                        'supervisoryAuthorityFeedback': 6,
                        'conductor': 12,
                        'reviewFrequencyMonths': 6,
                        'nextReviewDate': 6
                    },
                    'translation_domain': 'privacy'
                } %}

                <div class="mt-4">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-save"></i> Save Changes
                    </button>
                    <a href="{{ path('app_dpia_show', {id: dpia.id}) }}" class="btn btn-secondary">
                        <i class="bi bi-x-lg"></i> Cancel
                    </a>
                </div>
            {{ form_end(form) }}
        </div>
    </div>
</div>
{% endblock %}
