{#
    User Management Form Partial (Accessible)
    Used by both new.html.twig and edit.html.twig
    WCAG 2.1 AA Compliant
#}

{# Basic Information #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-info-circle" aria-hidden="true"></i>
        {{ 'user.section.basic_info'|trans({}, 'user') }}
    </legend>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.firstName,
                'label': 'user.field.first_name'|trans({}, 'user'),
                'help': 'user.help.first_name'|trans({}, 'user'),
                'required': true
            } %}
        </div>

        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.lastName,
                'label': 'user.field.last_name'|trans({}, 'user'),
                'help': 'user.help.last_name'|trans({}, 'user'),
                'required': true
            } %}
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            {% include '_components/_form_field.html.twig' with {
                'field': form.email,
                'label': 'user.field.email'|trans({}, 'user'),
                'help': 'user.help.email'|trans({}, 'user'),
                'required': true
            } %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.department,
                'label': 'user.field.department'|trans({}, 'user'),
                'help': 'user.help.department'|trans({}, 'user')
            } %}
        </div>

        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.jobTitle,
                'label': 'user.field.job_title'|trans({}, 'user'),
                'help': 'user.help.job_title'|trans({}, 'user')
            } %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            {% include '_components/_form_field.html.twig' with {
                'field': form.phoneNumber,
                'label': 'user.field.phone_number'|trans({}, 'user'),
                'help': 'user.help.phone_number'|trans({}, 'user')
            } %}
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            {% include '_components/_form_field.html.twig' with {
                'field': form.avatarFile,
                'label': 'user.field.avatar'|trans({}, 'user'),
                'help': 'user.help.avatar'|trans({}, 'user')')
            } %}
        </div>
    </div>
</fieldset>

{# Tenant Assignment #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-building" aria-hidden="true"></i>
        {{ 'user.section.tenant'|trans({}, 'user') }}
    </legend>

    <div class="row">
        <div class="col-12">
            {% include '_components/_form_field.html.twig' with {
                'field': form.tenant,
                'label': 'user.field.tenant'|trans({}, 'user'),
                'help': 'user.help.tenant'|trans({}, 'user'),
                'required': true
            } %}
        </div>
    </div>
</fieldset>

{# Authentication #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-shield-lock" aria-hidden="true"></i>
        {{ 'user.section.authentication'|trans({}, 'user') }}
    </legend>

    {% if is_edit_mode|default(false) and user is defined %}
        <div class="alert alert-info" role="status">
            <i class="bi bi-info-circle" aria-hidden="true"></i>
            <strong>{{ 'user.field.auth_provider'|trans({}, 'user') }}:</strong>
            {% if user.authProvider == 'azure_oauth' %}
                Azure OAuth
            {% elseif user.authProvider == 'azure_saml' %}
                Azure SAML
            {% else %}
                {{ 'user.auth_provider.local'|trans({}, 'user') }}
            {% endif %}
        </div>
    {% endif %}

    <div class="row">
        <div class="col-12">
            {% include '_components/_form_field.html.twig' with {
                'field': form.plainPassword,
                'label': 'user.field.password'|trans({}, 'user'),
                'help': is_edit_mode|default(false)
                    ? ('user.help.password_edit'|trans({}, 'user'))
                    : ('user.help.password'|trans({}, 'user')),
                'required': not is_edit_mode|default(false)
            } %}
        </div>
    </div>
</fieldset>

{# Roles & Permissions #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-shield" aria-hidden="true"></i>
        {{ 'user.section.roles'|trans({}, 'user') }}
    </legend>

    {# System Roles #}
    <div class="mb-3">
        {{ form_label(form.roles, 'user.field.roles'|trans({}, 'user'), {
            'label_attr': {'class': 'form-label'}
        }) }}
        <div role="group" aria-labelledby="{{ form.roles.vars.id }}_label">
            {% for child in form.roles %}
                <div class="form-check">
                    {{ form_widget(child, {'attr': {'class': 'form-check-input'}}) }}
                    {{ form_label(child, null, {'label_attr': {'class': 'form-check-label'}}) }}
                </div>
            {% endfor %}
        </div>
        {% if form.roles.vars.help is not empty %}
            <small class="form-text text-muted">{{ form.roles.vars.help }}</small>
        {% endif %}
        {{ form_errors(form.roles) }}
    </div>

    {# Custom Roles #}
    <div class="mb-3">
        {{ form_label(form.customRoles, 'user.field.custom_roles'|trans({}, 'user'), {
            'label_attr': {'class': 'form-label'}
        }) }}
        {% if form.customRoles|length > 0 %}
            <div role="group" aria-labelledby="{{ form.customRoles.vars.id }}_label">
                {% for child in form.customRoles %}
                    <div class="form-check">
                        {{ form_widget(child, {'attr': {'class': 'form-check-input'}}) }}
                        {{ form_label(child, null, {'label_attr': {'class': 'form-check-label'}}) }}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted" role="status">
                {{ 'user.message.no_custom_roles'|trans({}, 'user') }}
            </p>
        {% endif %}
        {% if form.customRoles.vars.help is not empty %}
            <small class="form-text text-muted">{{ form.customRoles.vars.help }}</small>
        {% endif %}
        {{ form_errors(form.customRoles) }}
    </div>
</fieldset>

{# Status #}
<fieldset class="mb-4">
    <legend class="h5 mb-3">
        <i class="bi bi-toggle-on" aria-hidden="true"></i>
        {{ 'user.section.status'|trans({}, 'user') }}
    </legend>

    <div class="mb-3">
        <div class="form-check form-switch">
            {{ form_widget(form.isActive, {'attr': {'class': 'form-check-input', 'role': 'switch'}}) }}
            {{ form_label(form.isActive, 'user.field.is_active'|trans({}, 'user'), {
                'label_attr': {'class': 'form-check-label'}
            }) }}
        </div>
        {% if form.isActive.vars.help is not empty %}
            <small class="form-text text-muted">{{ form.isActive.vars.help }}</small>
        {% endif %}
        {{ form_errors(form.isActive) }}
    </div>

    <div class="mb-3">
        <div class="form-check form-switch">
            {{ form_widget(form.isVerified, {'attr': {'class': 'form-check-input', 'role': 'switch'}}) }}
            {{ form_label(form.isVerified, 'user.field.is_verified'|trans({}, 'user'), {
                'label_attr': {'class': 'form-check-label'}
            }) }}
        </div>
        {% if form.isVerified.vars.help is not empty %}
            <small class="form-text text-muted">{{ form.isVerified.vars.help }}</small>
        {% endif %}
        {{ form_errors(form.isVerified) }}
    </div>
</fieldset>

{# Metadata (Edit Mode Only) #}
{% if is_edit_mode|default(false) and user is defined %}
    <div class="alert alert-secondary" role="status">
        <small>
            <strong>{{ 'user.field.created_at'|trans({}, 'user') }}:</strong> {{ user.createdAt|date('d.m.Y H:i') }}<br>
            {% if user.updatedAt %}
                <strong>{{ 'user.field.updated_at'|trans({}, 'user') }}:</strong> {{ user.updatedAt|date('d.m.Y H:i') }}<br>
            {% endif %}
            {% if user.lastLoginAt %}
                <strong>{{ 'user.field.last_login'|trans({}, 'user') }}:</strong> {{ user.lastLoginAt|date('d.m.Y H:i') }}
            {% endif %}
        </small>
    </div>
{% endif %}

{# Form Actions #}
<div class="form-actions d-flex gap-2 justify-content-between mt-4">
    <a href="{{ back_url|default(path('user_management_index')) }}"
       class="btn btn-secondary">
        <i class="bi bi-x-circle" aria-hidden="true"></i>
        {{ 'common.cancel'|trans({}, 'messages') }}
    </a>

    <button type="submit" class="btn btn-primary">
        <i class="{{ button_icon|default('bi-save') }}" aria-hidden="true"></i>
        {{ button_label|default('common.save'|trans({}, 'messages')) }}
    </button>
</div>
