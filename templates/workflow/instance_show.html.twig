{% extends 'base.html.twig' %}
{% trans_default_domain 'workflows' %}

{% block title %}{{ instance.entityType|split('\\')|last }} #{{ instance.entityId }} - {{ 'workflow.title.instance_show'|trans({}, 'workflows') }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>{{ instance.entityType|split('\\')|last }} #{{ instance.entityId }}</h1>
        <div class="mt-2">
            {% set statusColors = {
                'pending': 'warning',
                'in_progress': 'info',
                'approved': 'success',
                'rejected': 'danger',
                'cancelled': 'secondary'
            } %}
            {% include '_components/_badge.html.twig' with { variant: statusColors[instance.status] ?? 'secondary', content: ('workflow.status.' ~ instance.status)|trans({}, 'workflows') } %}
            {% if instance.overdue %}
                {% include '_components/_badge.html.twig' with { variant: 'danger', class: 'ms-1', content: 'workflow.badge.overdue'|trans({}, 'workflows') } %}
            {% endif %}
        </div>
    </div>
    <div class="button-group">
        <a href="{{ path('app_workflow_index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'common.back_to_list'|trans({}, 'messages') }}
        </a>
    </div>
</div>

{# Instance Overview #}
{% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
    {% block card_header %}
        <div class="card-header">
            <h2 class="mb-0">{{ 'workflow.section.overview'|trans({}, 'workflows') }}</h2>
        </div>
    {% endblock %}
    {% block card_body %}
        <div class="row">
            <div class="col-md-3 mb-3">
                <strong class="d-block text-muted">{{ 'workflow.field.workflow'|trans({}, 'workflows') }}</strong>
                {% include '_components/_badge.html.twig' with { variant: 'info', content: instance.workflow ? instance.workflow.name : '-' } %}
            </div>

            <div class="col-md-3 mb-3">
                <strong class="d-block text-muted">{{ 'workflow.field.current_step'|trans({}, 'workflows') }}</strong>
                {{ instance.currentStep ? instance.currentStep.name : '-' }}
            </div>

            <div class="col-md-3 mb-3">
                <strong class="d-block text-muted">{{ 'workflow.field.initiated_by'|trans({}, 'workflows') }}</strong>
                {% if instance.initiatedBy %}
                    {{ instance.initiatedBy.firstName ~ ' ' ~ instance.initiatedBy.lastName }}
                {% else %}
                    <span class="text-muted">{{ 'workflow.message.unassigned'|trans({}, 'workflows') }}</span>
                {% endif %}
            </div>

            {% if instance.dueDate %}
            <div class="col-md-3 mb-3">
                <strong class="d-block text-muted">{{ 'workflow.field.due_date'|trans({}, 'workflows') }}</strong>
                {{ instance.dueDate|date('d.m.Y H:i') }}
            </div>
            {% endif %}

            <div class="col-md-3 mb-3">
                <strong class="d-block text-muted">{{ 'workflow.field.created_at'|trans({}, 'workflows') }}</strong>
                {{ instance.startedAt|date('d.m.Y H:i') }}
            </div>

            {% if instance.completedAt %}
            <div class="col-md-3 mb-3">
                <strong class="d-block text-muted">{{ 'workflow.field.completed_at'|trans({}, 'workflows') }}</strong>
                {{ instance.completedAt|date('d.m.Y H:i') }}
            </div>
            {% endif %}
        </div>

        {# Progress Bar #}
        {% if instance.workflow and instance.workflow.steps|length > 0 %}
        <div class="mt-3">
            <strong class="d-block mb-2">{{ 'workflow.field.progress'|trans({}, 'workflows') }}</strong>
            {% set progress = instance.progressPercentage %}
            <div class="progress" style="height: 25px;">
                <div class="progress-bar bg-{{ progress == 100 ? 'success' : 'primary' }}" role="progressbar" style="width: {{ progress }}%;" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                    {{ progress }}% ({{ instance.completedSteps|length }} / {{ instance.workflow.steps|length }})
                </div>
            </div>
        </div>
        {% endif %}
    {% endblock %}
{% endembed %}

{# Warning: No eligible approvers for current step #}
{% if instance.status == 'in_progress' and not has_eligible_approvers %}
<div class="alert {% if is_granted('ROLE_ADMIN') %}alert-warning{% else %}alert-danger{% endif %} mb-4">
    <div class="d-flex align-items-start">
        <i class="bi bi-exclamation-triangle-fill fs-4 me-3" aria-hidden="true"></i>
        <div class="flex-grow-1">
            <h2 class="alert-heading mb-2">
                <i class="bi bi-person-exclamation" aria-hidden="true"></i>
                {{ 'workflow.warning.no_eligible_approvers_title'|trans({}, 'workflows') }}
            </h2>
            <p class="mb-2">{{ 'workflow.warning.no_eligible_approvers_desc'|trans({}, 'workflows') }}</p>

            {% if is_granted('ROLE_ADMIN') %}
                {# Admin view: can still approve + configure link #}
                <p class="mb-3">{{ 'workflow.warning.no_eligible_approvers_admin'|trans({}, 'workflows') }}</p>
                <div class="d-flex gap-2 flex-wrap">
                    {% if instance.workflow %}
                    <a href="{{ path('app_workflow_definition_show', {id: instance.workflow.id}) }}" class="btn btn-outline-warning">
                        <i class="bi bi-gear" aria-hidden="true"></i> {{ 'workflow.warning.configure_step'|trans({}, 'workflows') }}
                    </a>
                    {% endif %}
                </div>
            {% else %}
                {# Regular user view: contact admin message #}
                <p class="mb-0">
                    <strong>{{ 'workflow.warning.admin_action_required'|trans({}, 'workflows') }}:</strong>
                    {{ 'workflow.warning.no_eligible_approvers_user'|trans({}, 'workflows') }}
                </p>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{# Workflow Steps #}
{% if instance.workflow and instance.workflow.steps|length > 0 %}
{% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
    {% block card_header %}
        <div class="card-header">
            <h2 class="mb-0">{{ 'workflow.section.steps'|trans({}, 'workflows') }}</h2>
        </div>
    {% endblock %}
    {% block card_body %}
        {% for step in instance.workflow.steps %}
        {% set isCurrentStep = instance.currentStep and step.id == instance.currentStep.id %}
        {% set isCompleted = step.id in instance.completedSteps %}
        <div class="card mb-2 {% if isCurrentStep %}border-primary{% elseif isCompleted %}border-success{% endif %}">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ loop.index }}. {{ step.name }}</strong>
                        {% if isCurrentStep %}
                            {% include '_components/_badge.html.twig' with { variant: 'primary', class: 'ms-2', content: 'workflow.badge.current'|trans({}, 'workflows') } %}
                        {% elseif isCompleted %}
                            {% include '_components/_badge.html.twig' with { variant: 'success', class: 'ms-2', icon: 'bi-check', content: 'workflow.badge.completed'|trans({}, 'workflows') } %}
                        {% endif %}
                    </div>
                    {% if isCurrentStep and can_approve %}
                    <div>
                        <form method="post" action="{{ path('app_workflow_instance_approve', {id: instance.id}) }}" class="d-inline">
                            <input type="hidden" name="_token" value="{{ csrf_token('approve' ~ instance.id) }}">
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="bi bi-check-lg" aria-hidden="true"></i> {{ 'workflow.widget.action.approve'|trans({}, 'workflows') }}
                            </button>
                        </form>
                        <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#rejectModal">
                            <i class="bi bi-x-lg" aria-hidden="true"></i> {{ 'workflow.widget.action.reject'|trans({}, 'workflows') }}
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% if step.description %}
                    <p class="text-muted mb-0 mt-1 small">{{ step.description }}</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% endblock %}
{% endembed %}
{% endif %}

{# Approval History #}
{% if instance.approvalHistory|length > 0 %}
{% embed '_components/_card.html.twig' with { 'class': 'mb-4' } %}
    {% block card_header %}
        <div class="card-header">
            <h2 class="mb-0">{{ 'workflow.section.activity_log'|trans({}, 'workflows') }}</h2>
        </div>
    {% endblock %}
    {% block card_body %}
        <div class="table-responsive">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>{{ 'workflow.activity.timestamp'|trans({}, 'workflows') }}</th>
                    <th>{{ 'workflow.activity.user'|trans({}, 'workflows') }}</th>
                    <th>{{ 'workflow.activity.action'|trans({}, 'workflows') }}</th>
                    <th>{{ 'workflow.activity.details'|trans({}, 'workflows') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in instance.approvalHistory|reverse %}
                <tr>
                    <td>{{ entry.timestamp|date('d.m.Y H:i:s') }}</td>
                    <td>
                        {% if entry.approver_name is defined and entry.approver_name %}
                            {{ entry.approver_name }}
                        {% elseif entry.user is defined and entry.user %}
                            {{ entry.user }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% set actionColor = entry.action == 'approved' ? 'success' : (entry.action == 'rejected' ? 'danger' : 'info') %}
                        {% set isAutoApproved = entry.action == 'auto_approved' or (entry.auto_progression is defined and entry.auto_progression) %}
                        {% if isAutoApproved %}
                            {% include '_components/_badge.html.twig' with { variant: 'success', class: 'fairy-workflow-magic', icon: 'bi-stars', content: 'workflow.action.auto_approved'|trans({}, 'workflows') } %}
                        {% else %}
                            {% include '_components/_badge.html.twig' with { variant: actionColor, content: entry.action|capitalize } %}
                        {% endif %}
                        {% if entry.step_name is defined %}
                            <small class="text-muted ms-1">({{ entry.step_name }})</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if entry.comments is defined and entry.comments %}
                            <small class="text-muted">{{ entry.comments }}</small>
                        {% elseif entry.reason is defined and entry.reason %}
                            <small class="text-muted">{{ entry.reason }}</small>
                        {% else %}
                            <small class="text-muted">-</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    {% endblock %}
{% endembed %}
{% endif %}

{# Action Buttons #}
<div class="d-flex gap-2 mt-4">
    {% if instance.status in ['pending', 'in_progress'] %}
    <form method="post" action="{{ path('app_workflow_instance_cancel', {id: instance.id}) }}" class="d-inline"
          data-controller="ui-actions"
          data-action="submit->ui-actions#confirm"
          data-ui-actions-message-param="{{ 'workflow.confirm.cancel'|trans({}, 'workflows') }}">
        <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ instance.id) }}">
        <button type="submit" class="btn btn-danger">
            <i class="bi bi-x-circle" aria-hidden="true"></i> {{ 'workflow.action.cancel'|trans({}, 'workflows') }}
        </button>
    </form>
    {% endif %}

    <a href="{{ path('app_workflow_index') }}" class="btn btn-secondary">
        <i class="bi bi-list" aria-hidden="true"></i> {{ 'common.back_to_list'|trans({}, 'messages') }}
    </a>
</div>

{# Reject Modal #}
{% if can_approve %}
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{{ path('app_workflow_instance_reject', {id: instance.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('reject' ~ instance.id) }}">
                <div class="modal-header">
                    <h2 class="modal-title h5" id="rejectModalLabel">{{ 'workflow.widget.action.reject'|trans({}, 'workflows') }}</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'common.close'|trans({}, 'messages') }}"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="comments" class="form-label">{{ 'workflow.widget.field.reason'|trans({}, 'workflows') }}</label>
                        <textarea class="form-control" id="comments" name="comments" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'common.cancel'|trans({}, 'messages') }}</button>
                    <button type="submit" class="btn btn-danger">{{ 'workflow.widget.action.reject'|trans({}, 'workflows') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
