{% extends 'base.html.twig' %}
{% trans_default_domain 'workflows' %}

{% block title %}{{ instance.name }} - {{ 'workflow.title.instance_show'|trans({}, 'workflows') }} - Little ISMS Helper{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1>{{ instance.name }}</h1>
        <div class="mt-2">
            {% set statusColors = {
                'pending': 'warning',
                'active': 'info',
                'completed': 'success',
                'cancelled': 'secondary'
            } %}
            <span class="badge badge-{{ statusColors[instance.status] ?? 'secondary' }}">
                {{ ('workflow.status.' ~ instance.status)|trans }}
            </span>
            {% if instance.overdue %}
                <span class="badge bg-danger ml-xs">
                    {{ 'workflow.badge.overdue'|trans({}, 'workflows') }}
                </span>
            {% endif %}
        </div>
    </div>
    <div class="button-group">
        <a href="{{ path('app_workflow_instance_edit', {id: instance.id}) }}" class="btn btn-primary">
            ‚úèÔ∏è {{ 'common.edit'|trans({}, 'messages') }}
        </a>
        <a href="{{ path('app_workflow_index') }}" class="btn btn-secondary">
            ‚Üê {{ 'common.back_to_list'|trans({}, 'messages') }}
        </a>
    </div>
</div>

{# Instance Overview #}
<div class="card mb-4">
    <h2>{{ 'workflow.section.overview'|trans({}, 'workflows') }}</h2>

    <div class="stats-grid mt-3 grid-responsive-250">
        <div class="stat-item">
            <strong>{{ instance.definition ? instance.definition.name : '-' }}</strong>
            <span>{{ 'workflow.field.definition'|trans({}, 'workflows') }}</span>
        </div>

        <div class="stat-item">
            <strong>{{ instance.currentStep ? instance.currentStep.name : '-' }}</strong>
            <span>{{ 'workflow.field.current_step'|trans({}, 'workflows') }}</span>
        </div>

        <div class="stat-item">
            <strong>
                {% if instance.assignee %}
                    {{ instance.assignee.fullName }}
                {% else %}
                    <span class="text-muted">{{ 'workflow.message.unassigned'|trans({}, 'workflows') }}</span>
                {% endif %}
            </strong>
            <span>{{ 'workflow.field.assignee'|trans({}, 'workflows') }}</span>
        </div>

        {% if instance.dueDate %}
        <div class="stat-item">
            <strong>{{ instance.dueDate|date('d.m.Y H:i') }}</strong>
            <span>{{ 'workflow.field.due_date'|trans({}, 'workflows') }}</span>
        </div>
        {% endif %}

        <div class="stat-item">
            <strong>{{ instance.createdAt|date('d.m.Y H:i') }}</strong>
            <span>{{ 'workflow.field.created_at'|trans({}, 'workflows') }}</span>
        </div>

        {% if instance.completedAt %}
        <div class="stat-item">
            <strong>{{ instance.completedAt|date('d.m.Y H:i') }}</strong>
            <span>{{ 'workflow.field.completed_at'|trans({}, 'workflows') }}</span>
        </div>
        {% endif %}
    </div>

    {# Progress Bar #}
    <div class="mt-3">
        <h2 class="fs-1-mb-sm">{{ 'workflow.field.progress'|trans({}, 'workflows') }}</h2>
        {% set progress = (instance.completedSteps|length / instance.definition.steps|length * 100)|round %}
        <div class="progress progress-lg">
            <div class="progress-bar" style="width: {{ progress }}%; font-size: 1rem;">
                {{ progress }}% ({{ instance.completedSteps|length }} / {{ instance.definition.steps|length }})
            </div>
        </div>
    </div>
</div>

{# Workflow Steps #}
<div class="card mb-4">
    <h2>{{ 'workflow.section.steps'|trans({}, 'workflows') }}</h2>

    <div class="mt-3">
        {% for step in instance.definition.steps %}
        <div class="card card-step{% if step.id == instance.currentStep.id %} card-border-left-primary{% endif %}">
            <div class="d-flex justify-between align-center">
                <div>
                    <h2 class="fs-11-mb-xs">
                        {{ loop.index }}. {{ step.name }}
                        {% if step.id == instance.currentStep.id %}
                            <span class="badge bg-primary">{{ 'workflow.badge.current'|trans({}, 'workflows') }}</span>
                        {% elseif step in instance.completedSteps %}
                            <span class="badge bg-success">‚úì {{ 'workflow.badge.completed'|trans({}, 'workflows') }}</span>
                        {% endif %}
                    </h3>
                    {% if step.description %}
                        <p class="text-muted-mt-xs">{{ step.description }}</p>
                    {% endif %}
                </div>
                {% if step.id == instance.currentStep.id and instance.status == 'active' %}
                <div>
                    <a href="{{ path('app_workflow_step_complete', {instanceId: instance.id, stepId: step.id}) }}" class="btn btn-success btn-sm">
                        ‚úì {{ 'workflow.action.complete_step'|trans({}, 'workflows') }}
                    </a>
                </div>
                {% endif %}
            </div>

            {% if step.assignee %}
            <div class="mt-2">
                <small><strong>{{ 'workflow.field.assignee'|trans({}, 'workflows') }}:</strong> {{ step.assignee.fullName }}</small>
            </div>
            {% endif %}

            {% if step.dueDate %}
            <div class="mt-1">
                <small><strong>{{ 'workflow.field.due_date'|trans({}, 'workflows') }}:</strong> {{ step.dueDate|date('d.m.Y H:i') }}</small>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

{# Activity Log #}
<div class="card mb-4">
    <h2>{{ 'workflow.section.activity_log'|trans({}, 'workflows') }}</h2>

    {% if instance.activities|length > 0 %}
    <div class="mt-3">
        {% embed '_components/_table.html.twig' with {
            'class': 'table-container',
            'noMargin': true
        } %}
            {% block table_head %}
                <tr>
                    <th scope="col">{{ 'workflow.activity.timestamp'|trans({}, 'workflows') }}</th>
                    <th scope="col">{{ 'workflow.activity.user'|trans({}, 'workflows') }}</th>
                    <th scope="col">{{ 'workflow.activity.action'|trans({}, 'workflows') }}</th>
                    <th scope="col">{{ 'workflow.activity.details'|trans({}, 'workflows') }}</th>
                </tr>
            {% endblock %}
            {% block table_body %}
                {% for activity in instance.activities|reverse %}
                <tr>
                    <td>{{ activity.createdAt|date('d.m.Y H:i:s') }}</td>
                    <td>{{ activity.user.fullName }}</td>
                    <td>
                        <span class="badge bg-info">{{ ('workflow.action.' ~ activity.action)|trans }}</span>
                    </td>
                    <td>
                        <small class="text-muted">{{ activity.details }}</small>
                    </td>
                </tr>
                {% endfor %}
            {% endblock %}
        {% endembed %}
    </div>
    {% else %}
    <p class="text-muted-mt-sm">
        {{ 'workflow.message.no_activities'|trans({}, 'workflows') }}
    </p>
    {% endif %}
</div>

{# Action Buttons #}
<div class="d-flex gap-2 mt-4">
    {% if instance.status == 'pending' %}
    <a href="{{ path('app_workflow_instance_start', {id: instance.id}) }}" class="btn btn-success">
        ‚ñ∂Ô∏è {{ 'workflow.action.start'|trans({}, 'workflows') }}
    </a>
    {% endif %}

    {% if instance.status in ['pending', 'active'] %}
    <form method="post" action="{{ path('app_workflow_instance_cancel', {id: instance.id}) }}" onsubmit="return confirm('{{ 'workflow.confirm.cancel'|trans({}, 'workflows') }}');" class="d-inline">
        <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ instance.id) }}">
        <button type="submit" class="btn btn-danger">‚ùå {{ 'workflow.action.cancel'|trans({}, 'workflows') }}</button>
    </form>
    {% endif %}

    <a href="{{ path('app_workflow_index') }}" class="btn btn-secondary">
        üìã {{ 'common.back_to_list'|trans({}, 'messages') }}
    </a>
</div>
{% endblock %}
