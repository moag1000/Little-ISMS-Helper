{% extends 'base.html.twig' %}
{% import '_macros/inheritance_badge.html.twig' as inheritance %}

{% block title %}{{ 'incident_management.title'|trans({}, 'incidents') }} - {{ 'app.title'|trans({}, 'messages') }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-exclamation-triangle" aria-hidden="true"></i> {{ 'incident_management.title'|trans({}, 'incidents') }}</h1>
        <a href="{{ path('app_incident_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle" aria-hidden="true"></i> {{ 'incident.action.report_new'|trans({}, 'incidents')|default('Report New Incident') }}
        </a>
    </div>

    <p class="text-muted mb-4">
        {{ 'incident_management.description'|trans({}, 'incidents') }}
    </p>

    {# Skip link for filters section - WCAG 2.4.1 #}
    <a href="#filter-section" class="skip-link">{{ 'accessibility.skip_to_filters'|trans({}, 'messages') }}</a>

    {# View Filter #}
    {% if currentTenant %}
    {% embed '_components/_card.html.twig' with {
        'class': 'mb-3'
    } %}
        {% block card_body %}
            <form method="get" action="{{ path('app_incident_index') }}" class="d-flex align-items-center gap-2">
                <label for="view-filter" class="mb-0 fw-bold">
                    <i class="bi bi-eye" aria-hidden="true"></i> {{ 'common.view'|trans({}, 'messages') }}:
                </label>
                <select class="form-select form-select-sm" style="width: auto;" id="view-filter" name="view" onchange="this.form.submit()">
                    <option value="own" {{ inheritanceInfo.currentView == 'own' ? 'selected' : '' }}>
                        {{ 'corporate.view.own_only'|trans({}, 'tenant') }}
                    </option>
                    {% if inheritanceInfo.hasParent %}
                    <option value="inherited" {{ inheritanceInfo.currentView == 'inherited' ? 'selected' : '' }}>
                        {{ 'corporate.view.including_inherited'|trans({}, 'tenant') }}
                    </option>
                    {% endif %}
                    {% if inheritanceInfo.hasSubsidiaries %}
                    <option value="subsidiaries" {{ inheritanceInfo.currentView == 'subsidiaries' ? 'selected' : '' }}>
                        {{ 'corporate.view.including_subsidiaries'|trans({}, 'tenant') }}
                    </option>
                    {% endif %}
                </select>
                <noscript>
                    <button type="submit" class="btn btn-sm btn-secondary">{{ 'common.apply'|trans({}, 'messages') }}</button>
                </noscript>
            </form>
        {% endblock %}
    {% endembed %}
    {% endif %}

    {# KPI Cards #}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h2 class="text-warning">{{ openIncidents|length }}</h3>
                    <p class="mb-0">{{ 'incident_management.open_incidents'|trans({}, 'incidents') }}</p>
                </div>
            </div>
        </div>
        {% if is_nis2_active() %}
        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body text-center">
                    {% set nis2Count = 0 %}
                    {% for incident in allIncidents %}
                        {% if incident.requiresNis2Reporting and incident.nis2ComplianceStatus in ['overdue', 'awaiting_early_warning', 'awaiting_detailed'] %}
                            {% set nis2Count = nis2Count + 1 %}
                        {% endif %}
                    {% endfor %}
                    <h3 class="text-danger">{{ nis2Count }}</h3>
                    <p class="mb-0">{{ 'incident.kpi.nis2_attention'|trans({}, 'incidents')|default('NIS2 Requiring Attention') }}</p>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h3 class="text-info">{{ categoryStats|length }}</h3>
                    <p class="mb-0">{{ 'incident.kpi.categories'|trans({}, 'incidents')|default('Categories') }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3>{{ detailedStats.total }}</h3>
                    {% if currentTenant %}
                        <p class="mb-0 text-muted small" style="font-size: 11px; opacity: 0.85;">
                            {{ 'corporate.stats.breakdown'|trans({'%own%': detailedStats.own, '%inherited%': detailedStats.inherited, '%subsidiaries%': detailedStats.subsidiaries}, 'tenant') }}
                        </p>
                    {% endif %}
                    <p class="mb-0">{{ 'incident_management.total_recorded'|trans({}, 'incidents') }}</p>
                </div>
            </div>
        </div>
    </div>

    {# Filter Section #}
    {% embed '_components/_card.html.twig' with {
        'title': 'common.filters',
        'headerIcon': 'bi-funnel',
        'class': 'mb-4'
    } %}
        {% block card_body %}
            <form method="get" action="{{ path('app_incident_index') }}" class="row g-3" role="search" aria-label="{{ 'common.filters'|trans({}, 'messages') }}">
                <div id="filter-section" tabindex="-1"></div>
                <div class="col-md-2">
                    <label for="filter-severity" class="form-label">{{ 'incident.field.severity'|trans({}, 'incidents') }}</label>
                    <select class="form-select" id="filter-severity" name="severity" onchange="this.form.submit()">
                        <option value="">{{ 'common.all'|trans({}, 'messages') }}</option>
                        <option value="low" {{ app.request.get('severity') == 'low' ? 'selected' : '' }}>{{ 'incident.severity.low'|trans({}, 'incidents') }}</option>
                        <option value="medium" {{ app.request.get('severity') == 'medium' ? 'selected' : '' }}>{{ 'incident.severity.medium'|trans({}, 'incidents') }}</option>
                        <option value="high" {{ app.request.get('severity') == 'high' ? 'selected' : '' }}>{{ 'incident.severity.high'|trans({}, 'incidents') }}</option>
                        <option value="critical" {{ app.request.get('severity') == 'critical' ? 'selected' : '' }}>{{ 'incident.severity.critical'|trans({}, 'incidents') }}</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter-category" class="form-label">{{ 'incident.field.category'|trans({}, 'incidents') }}</label>
                    <select class="form-select" id="filter-category" name="category" onchange="this.form.submit()">
                        <option value="">{{ 'common.all'|trans({}, 'messages') }}</option>
                        {% if categoryStats|length > 0 %}
                            {% for stat in categoryStats %}
                                <option value="{{ stat.category }}" {{ app.request.get('category') == stat.category ? 'selected' : '' }}>
                                    {{ ('incident.category.' ~ stat.category)|trans }} ({{ stat.count }})
                                </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filter-status" class="form-label">{{ 'incident.field.status'|trans({}, 'incidents') }}</label>
                    <select class="form-select" id="filter-status" name="status" onchange="this.form.submit()">
                        <option value="">{{ 'common.all'|trans({}, 'messages') }}</option>
                        <option value="reported" {{ app.request.get('status') == 'reported' ? 'selected' : '' }}>{{ 'incident.status.reported'|trans({}, 'incidents') }}</option>
                        <option value="in_investigation" {{ app.request.get('status') == 'in_investigation' ? 'selected' : '' }}>{{ 'incident.status.in_investigation'|trans({}, 'incidents') }}</option>
                        <option value="in_resolution" {{ app.request.get('status') == 'in_resolution' ? 'selected' : '' }}>{{ 'incident.status.in_resolution'|trans({}, 'incidents') }}</option>
                        <option value="resolved" {{ app.request.get('status') == 'resolved' ? 'selected' : '' }}>{{ 'incident.status.resolved'|trans({}, 'incidents') }}</option>
                        <option value="closed" {{ app.request.get('status') == 'closed' ? 'selected' : '' }}>{{ 'incident.status.closed'|trans({}, 'incidents') }}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filter-data-breach" class="form-label">{{ 'incident.filter.data_breach'|trans({}, 'incidents')|default('Data Breach') }}</label>
                    <select class="form-select" id="filter-data-breach" name="data_breach_only" onchange="this.form.submit()">
                        <option value="">{{ 'common.all'|trans({}, 'messages') }}</option>
                        <option value="1" {{ app.request.get('data_breach_only') == '1' ? 'selected' : '' }}>{{ 'incident.filter.data_breach_only'|trans({}, 'incidents')|default('Data Breach Only') }}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filter-nis2" class="form-label">NIS2</label>
                    <select class="form-select" id="filter-nis2" name="nis2_only" onchange="this.form.submit()">
                        <option value="">{{ 'common.all'|trans({}, 'messages') }}</option>
                        <option value="1" {{ app.request.get('nis2_only') == '1' ? 'selected' : '' }}>{{ 'incident.filter.nis2_only'|trans({}, 'incidents')|default('NIS2 Only') }}</option>
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search" aria-hidden="true"></i> {{ 'common.filter'|trans({}, 'messages') }}
                    </button>
                    <a href="{{ path('app_incident_index') }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle" aria-hidden="true"></i> {{ 'common.reset'|trans({}, 'messages') }}
                    </a>
                </div>
            </form>
        {% endblock %}
    {% endembed %}

    {# Category Statistics #}
    {% if categoryStats|length > 0 %}
        {% embed '_components/_card.html.twig' with {
            'title': 'incident.kpi.by_category',
            'class': 'mb-4'
        } %}
            {% block card_body %}
                <div class="row">
                    {% for stat in categoryStats %}
                        <div class="col-md-2">
                            <div class="category-stat">
                                <strong>{{ stat.count }}</strong>
                                <span>{{ ('incident.category.' ~ stat.category)|trans }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endblock %}
        {% endembed %}
    {% endif %}

    {# Incidents Table #}
    {% if allIncidents|length == 0 %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle" aria-hidden="true"></i> {{ 'incident.empty'|trans({}, 'incidents')|default('No incidents recorded yet.') }}
        </div>
    {% else %}
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">{{ 'incident.list.title'|trans({}, 'incidents')|default('All Incidents') }}</h3>
            </div>
            {% embed '_components/_table.html.twig' with {
                'noMargin': true
            } %}
                {% import '_macros/inheritance_badge.html.twig' as inheritance %}
                {% block table_head %}
                    <tr>
                        <th scope="col">{{ 'incident.field.title'|trans({}, 'incidents') }}</th>
                        <th scope="col">{{ 'incident.field.category'|trans({}, 'incidents') }}</th>
                        <th scope="col">{{ 'incident.field.severity'|trans({}, 'incidents') }}</th>
                        <th scope="col">{{ 'incident.field.status'|trans({}, 'incidents') }}</th>
                        <th scope="col">{{ 'incident.field.detected_at'|trans({}, 'incidents') }}</th>
                        <th scope="col">NIS2</th>
                        <th scope="col">{{ 'common.actions'|trans({}, 'messages') }}</th>
                    </tr>
                {% endblock %}
                {% block table_body %}
                    {% import '_macros/inheritance_badge.html.twig' as inheritance %}
                    {% for incident in allIncidents %}
                        <tr>
                            <td>
                                <strong>{{ incident.title }}</strong>
                                {{ inheritance.small_badge(incident, currentTenant) }}
                                {% if incident.incidentNumber %}
                                    <br><small class="text-muted">#{{ incident.incidentNumber }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">
                                    {{ ('incident.category.' ~ incident.category)|trans }}
                                </span>
                            </td>
                            <td>
                                <span class="{{ badge_severity(incident.severity) }}">
                                    {{ ('incident.severity.' ~ incident.severity)|trans }}
                                </span>
                            </td>
                            <td>
                                <span class="{{ badge_status(incident.status) }}">
                                    {{ ('incident.status.' ~ incident.status)|trans }}
                                </span>
                            </td>
                            <td>{{ incident.detectedAt|date('d.m.Y H:i') }}</td>
                            <td>
                                {% if is_nis2_active() and incident.requiresNis2Reporting %}
                                    {% set nis2Status = incident.nis2ComplianceStatus %}
                                    <span class="{{ badge_nis2(nis2Status) }}" title="{{ ('incident.nis2_compliance.' ~ nis2Status)|trans }}">
                                        {% if nis2Status == 'compliant' %}
                                            <i class="bi bi-check-circle-fill" aria-hidden="true"></i>
                                        {% elseif nis2Status == 'overdue' %}
                                            <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                                        {% else %}
                                            <i class="bi bi-clock-fill" aria-hidden="true"></i>
                                        {% endif %}
                                        {{ ('incident.nis2_compliance.' ~ nis2Status)|trans }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary" title="{{ 'incident.nis2_compliance.not_applicable'|trans({}, 'incidents') }}">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
                                    <a href="{{ path('app_incident_show', {id: incident.id}) }}" class="btn btn-outline-primary" title="{{ 'common.view'|trans({}, 'messages') }}" aria-label="{{ 'common.view'|trans({}, 'messages') }}">
                                        <i class="bi bi-eye" aria-hidden="true"></i>
                                    </a>
                                    <a href="{{ path('app_incident_edit', {id: incident.id}) }}" class="btn btn-outline-secondary" title="{{ 'common.edit'|trans({}, 'messages') }}" aria-label="{{ 'common.edit'|trans({}, 'messages') }}">
                                        <i class="bi bi-pencil" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% endblock %}
            {% endembed %}
        </div>
    {% endif %}
</div>

<style>
/* Severity Badges */
.badge-severity-low { background: #10b981; }
.badge-severity-medium { background: #f59e0b; }
.badge-severity-high { background: #f97316; }
.badge-severity-critical { background: #dc2626; }

/* Status Badges */
.badge-status-reported { background: #3b82f6; }
.badge-status-in_investigation { background: #f59e0b; }
.badge-status-in_resolution { background: #8b5cf6; }
.badge-status-resolved { background: #10b981; }
.badge-status-closed { background: #6b7280; }

/* NIS2 Compliance Badges */
.badge-nis2-not_applicable { background: #6b7280; }
.badge-nis2-compliant { background: #10b981; }
.badge-nis2-overdue {
    background: #dc2626;
    animation: pulse 2s infinite;
}
.badge-nis2-awaiting_early_warning { background: #f59e0b; }
.badge-nis2-awaiting_detailed { background: #3b82f6; }
.badge-nis2-awaiting_final { background: #8b5cf6; }

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Category Stats */
.category-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem;
    background: #f3f4f6;
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.category-stat strong {
    font-size: 1.5rem;
    color: #1f2937;
}

.category-stat span {
    font-size: 0.85rem;
    color: #6b7280;
    text-align: center;
}

/* Cards */
.card {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.card-header {
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
}

/* Table Styling */
.table thead th {
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
}

.table tbody tr:hover {
    background: #f9fafb;
}

/* Responsive */
@media (max-width: 768px) {
    .table {
        font-size: 0.85rem;
    }

    .badge {
        font-size: 0.7rem;
    }
}
</style>
{% endblock %}
