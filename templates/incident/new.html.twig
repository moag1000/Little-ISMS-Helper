{% extends 'base.html.twig' %}

{% block title %}{{ 'incident.new'|trans }} - {{ parent() }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-10 col-xl-9 mx-auto">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ path('app_incident_index') }}" data-turbo-action="advance">
                            <i class="bi bi-bug" aria-hidden="true"></i> {{ 'nav.incidents'|trans }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">{{ 'incident.new'|trans }}</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0"><i class="bi bi-plus-circle" aria-hidden="true"></i> {{ 'incident.new'|trans }}</h1>
                <a href="{{ path('app_incident_index') }}" class="btn btn-outline-secondary" data-turbo-action="advance">
                    <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'common.back'|trans }}
                </a>
            </div>

            {# NIS2 Reporting Alert Banner #}
            <div id="nis2-alert" class="alert alert-warning d-none mb-4" role="alert">
                <h6 class="alert-heading">
                    <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i> {{ 'incident.nis2_alert.title'|trans }}
                </h6>
                <p class="mb-2 small">{{ 'incident.nis2_alert.description'|trans }}</p>
                <ul class="mb-0 small">
                    <li>{{ 'incident.nis2_alert.early_warning'|trans }}</li>
                    <li>{{ 'incident.nis2_alert.detailed_notification'|trans }}</li>
                    <li>{{ 'incident.nis2_alert.final_report'|trans }}</li>
                </ul>
            </div>

            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">{{ 'incident.new'|trans }}</h3>
                </div>
                <div class="card-body">
                    {{ form_start(form, {'attr': {'novalidate': 'novalidate', 'id': 'incident-form'}}) }}

                    {# Basic Information Section #}
                    <fieldset class="mb-4">
                        <legend class="h5 mb-3">
                            <i class="bi bi-info-square" aria-hidden="true"></i>
                            {{ 'incident.section.basic_info'|trans }}
                        </legend>

                        <div class="row">
                            <div class="col-md-8">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.title,
                                    'label': form.title.vars.label|default('incident.field.title'|trans),
                                    'required': true
                                } %}
                            </div>
                            <div class="col-md-4">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.category,
                                    'label': form.category.vars.label|default('incident.field.category'|trans)
                                } %}
                            </div>
                            <div class="col-md-12">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.description,
                                    'label': form.description.vars.label|default('incident.field.description'|trans)
                                } %}
                            </div>
                        </div>
                    </fieldset>

                    {# Severity & Status Section #}
                    <fieldset class="mb-4">
                        <legend class="h5 mb-3">
                            <i class="bi bi-thermometer-half" aria-hidden="true"></i>
                            {{ 'incident.section.severity_status'|trans }}
                        </legend>

                        <div class="row">
                            <div class="col-md-6">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.severity,
                                    'label': form.severity.vars.label|default('incident.field.severity'|trans),
                                    'required': true
                                } %}
                            </div>
                            <div class="col-md-6">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.status,
                                    'label': form.status.vars.label|default('incident.field.status'|trans)
                                } %}
                            </div>
                        </div>
                    </fieldset>

                    {# Detection & Reporting Section #}
                    <fieldset class="mb-4">
                        <legend class="h5 mb-3">
                            <i class="bi bi-calendar-event" aria-hidden="true"></i>
                            {{ 'incident.section.detection_reporting'|trans }}
                        </legend>

                        <div class="row">
                            <div class="col-md-4">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.detectedAt,
                                    'label': form.detectedAt.vars.label|default('incident.field.detected_at'|trans)
                                } %}
                            </div>
                            <div class="col-md-4">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.occurredAt,
                                    'label': form.occurredAt.vars.label|default('incident.field.occurred_at'|trans)
                                } %}
                            </div>
                            <div class="col-md-4">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.reportedBy,
                                    'label': form.reportedBy.vars.label|default('incident.field.reported_by'|trans)
                                } %}
                            </div>
                        </div>
                    </fieldset>

                    {# Affected Systems & Assets Section #}
                    <fieldset class="mb-4">
                        <legend class="h5 mb-3">
                            <i class="bi bi-hdd-network" aria-hidden="true"></i>
                            {{ 'incident.section.affected_systems'|trans }}
                        </legend>

                        <div class="row">
                            <div class="col-md-12">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.affectedSystems,
                                    'label': form.affectedSystems.vars.label|default('incident.field.affected_systems'|trans)
                                } %}
                            </div>
                            <div class="col-md-12">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.affectedAssets,
                                    'label': form.affectedAssets.vars.label|default('incident.field.affected_assets'|trans)
                                } %}
                            </div>
                        </div>
                    </fieldset>

                    {# Analysis Section #}
                    <fieldset class="mb-4">
                        <legend class="h5 mb-3">
                            <i class="bi bi-search" aria-hidden="true"></i>
                            {{ 'incident.section.analysis'|trans }}
                        </legend>

                        <div class="row">
                            <div class="col-md-12">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.rootCause,
                                    'label': form.rootCause.vars.label|default('incident.field.root_cause'|trans)
                                } %}
                            </div>
                            <div class="col-md-12">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.correctiveActions,
                                    'label': form.correctiveActions.vars.label|default('incident.field.corrective_actions'|trans)
                                } %}
                            </div>
                            <div class="col-md-12">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.lessonsLearned,
                                    'label': form.lessonsLearned.vars.label|default('incident.field.lessons_learned'|trans)
                                } %}
                            </div>
                            <div class="col-md-6">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.closedAt,
                                    'label': form.closedAt.vars.label|default('incident.field.closed_at'|trans)
                                } %}
                            </div>
                        </div>
                    </fieldset>

                    {# NIS2 Reporting Section - Conditionally Displayed #}
                    <fieldset id="nis2-section" class="mb-4 d-none nis2-fieldset">
                        <legend class="h5 mb-3 bg-warning text-dark nis2-legend">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="bi bi-shield-exclamation" aria-hidden="true"></i>
                                    {{ 'incident.section.nis2_reporting'|trans }}
                                </span>
                                <button type="button" class="btn btn-sm btn-outline-dark" id="hide-nis2-btn">
                                    <i class="bi bi-eye-slash" aria-hidden="true"></i> {{ 'incident.nis2_toggle.hide'|trans }}
                                </button>
                            </div>
                            <small class="d-block mt-2">{{ 'incident.section.nis2_info'|trans }}</small>
                        </legend>

                        <div class="row">
                            <div class="col-md-6">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.nis2Category,
                                    'label': form.nis2Category.vars.label|default('incident.field.nis2_category'|trans)
                                } %}
                            </div>
                            <div class="col-md-6">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.crossBorderImpact,
                                    'label': form.crossBorderImpact.vars.label|default('incident.field.cross_border_impact'|trans)
                                } %}
                            </div>
                        </div>

                        {# NIS2 Timeline - Article 23 #}
                        <div class="alert alert-info mt-3">
                            <h2 class="alert-heading h6">{{ 'incident.nis2_timeline.title'|trans }}</h2>
                            <p class="mb-0 small">{{ 'incident.nis2_timeline.description'|trans }}</p>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.earlyWarningReportedAt,
                                    'label': form.earlyWarningReportedAt.vars.label|default('incident.field.early_warning_reported_at'|trans)
                                } %}
                            </div>
                            <div class="col-md-4">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.detailedNotificationReportedAt,
                                    'label': form.detailedNotificationReportedAt.vars.label|default('incident.field.detailed_notification_reported_at'|trans)
                                } %}
                            </div>
                            <div class="col-md-4">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.finalReportSubmittedAt,
                                    'label': form.finalReportSubmittedAt.vars.label|default('incident.field.final_report_submitted_at'|trans)
                                } %}
                            </div>
                        </div>

                        {# Impact Assessment #}
                        <div class="row mt-3">
                            <div class="col-md-4">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.affectedUsersCount,
                                    'label': form.affectedUsersCount.vars.label|default('incident.field.affected_users_count'|trans)
                                } %}
                            </div>
                            <div class="col-md-4">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.estimatedFinancialImpact,
                                    'label': form.estimatedFinancialImpact.vars.label|default('incident.field.estimated_financial_impact'|trans)
                                } %}
                            </div>
                        </div>

                        {# Authority Notification #}
                        <div class="row">
                            <div class="col-md-8">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.nationalAuthorityNotified,
                                    'label': form.nationalAuthorityNotified.vars.label|default('incident.field.national_authority_notified'|trans)
                                } %}
                            </div>
                            <div class="col-md-4">
                                {% include '_components/_form_field.html.twig' with {
                                    'field': form.authorityReferenceNumber,
                                    'label': form.authorityReferenceNumber.vars.label|default('incident.field.authority_reference_number'|trans)
                                } %}
                            </div>
                        </div>
                    </fieldset>

                    {# Manual NIS2 Toggle Button #}
                    <div id="show-nis2-container" class="text-center mb-4 d-none">
                        <button type="button" class="btn btn-outline-warning" id="show-nis2-btn">
                            <i class="bi bi-shield-exclamation" aria-hidden="true"></i> {{ 'incident.nis2_toggle.show'|trans }}
                        </button>
                    </div>

                    {# Form Actions #}
                    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                        <a href="{{ path('app_incident_index') }}"
                           class="btn btn-outline-secondary"
                           data-turbo-action="advance">
                            <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'common.back'|trans }}
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save" aria-hidden="true"></i> {{ 'incident.create'|trans }}
                        </button>
                    </div>

                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let manualOverrideNis2 = false;

function initializeIncidentNIS2() {
    const severityField = document.getElementById('incident_severity');
    const affectedUsersField = document.getElementById('incident_affectedUsersCount');
    const crossBorderField = document.querySelectorAll('input[name="incident[crossBorderImpact]"]');
    const nis2Section = document.getElementById('nis2-section');
    const nis2Alert = document.getElementById('nis2-alert');
    const showNis2Container = document.getElementById('show-nis2-container');
    const showNis2Btn = document.getElementById('show-nis2-btn');
    const hideNis2Btn = document.getElementById('hide-nis2-btn');

    if (!severityField) return; // Elements not present on page

    function checkNIS2Criteria() {
        if (manualOverrideNis2) return; // User manually toggled

        const severity = severityField ? severityField.value : '';
        const affectedUsers = affectedUsersField ? parseInt(affectedUsersField.value) || 0 : 0;
        let crossBorder = false;

        crossBorderField.forEach(radio => {
            if (radio.checked && radio.value === '1') {
                crossBorder = true;
            }
        });

        // Criteria for showing NIS2 fields
        const shouldShowNIS2 =
            severity === 'critical' ||
            (severity === 'high' && (affectedUsers > 100 || crossBorder));

        // Criteria for showing alert (more strict)
        const shouldShowAlert =
            severity === 'critical' ||
            (severity === 'high' && (affectedUsers > 100 || crossBorder));

        if (shouldShowNIS2) {
            nis2Section.classList.remove('d-none');
            showNis2Container.classList.add('d-none');
        } else {
            nis2Section.classList.add('d-none');
            showNis2Container.classList.remove('d-none');
        }

        if (shouldShowAlert) {
            nis2Alert.classList.remove('d-none');
        } else {
            nis2Alert.classList.add('d-none');
        }
    }

    // Manual show NIS2 section
    if (showNis2Btn && showNis2Btn.dataset.initialized !== 'true') {
        showNis2Btn.dataset.initialized = 'true';
        showNis2Btn.addEventListener('click', function() {
            manualOverrideNis2 = true;
            nis2Section.classList.remove('d-none');
            showNis2Container.classList.add('d-none');
        });
    }

    // Manual hide NIS2 section
    if (hideNis2Btn && hideNis2Btn.dataset.initialized !== 'true') {
        hideNis2Btn.dataset.initialized = 'true';
        hideNis2Btn.addEventListener('click', function() {
            manualOverrideNis2 = false;
            nis2Section.classList.add('d-none');
            showNis2Container.classList.remove('d-none');
            checkNIS2Criteria();
        });
    }

    // Event listeners (only add if not already initialized)
    if (severityField && severityField.dataset.nis2Initialized !== 'true') {
        severityField.dataset.nis2Initialized = 'true';
        severityField.addEventListener('change', checkNIS2Criteria);
    }
    if (affectedUsersField && affectedUsersField.dataset.nis2Initialized !== 'true') {
        affectedUsersField.dataset.nis2Initialized = 'true';
        affectedUsersField.addEventListener('input', checkNIS2Criteria);
    }
    crossBorderField.forEach(radio => {
        if (radio.dataset.nis2Initialized !== 'true') {
            radio.dataset.nis2Initialized = 'true';
            radio.addEventListener('change', checkNIS2Criteria);
        }
    });

    // Initial check
    checkNIS2Criteria();
}

// Cleanup before Turbo caches the page to allow re-initialization on back navigation
document.addEventListener('turbo:before-cache', function() {
    const showNis2Btn = document.getElementById('show-nis2-btn');
    const hideNis2Btn = document.getElementById('hide-nis2-btn');
    const severityField = document.getElementById('incident_severity');
    const affectedUsersField = document.getElementById('incident_affectedUsersCount');
    const crossBorderField = document.querySelectorAll('input[name="incident[crossBorderImpact]"]');

    if (showNis2Btn) delete showNis2Btn.dataset.initialized;
    if (hideNis2Btn) delete hideNis2Btn.dataset.initialized;
    if (severityField) delete severityField.dataset.nis2Initialized;
    if (affectedUsersField) delete affectedUsersField.dataset.nis2Initialized;
    crossBorderField.forEach(radio => delete radio.dataset.nis2Initialized);
});

// Initialize on both DOMContentLoaded (first page load) and turbo:load (Turbo navigation)
document.addEventListener('DOMContentLoaded', initializeIncidentNIS2);
document.addEventListener('turbo:load', initializeIncidentNIS2);
</script>

<style>
.help-text {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #6c757d;
}
</style>
{% endblock %}
