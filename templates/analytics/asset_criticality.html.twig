{% extends 'base.html.twig' %}
{% trans_default_domain 'analytics' %}

{% block title %}{{ 'analytics.assets.title'|trans({}, 'analytics') }} - {{ 'app.title'|trans({}, 'messages') }}{% endblock %}

{% block body %}
<div class="analytics-dashboard" data-controller="asset-analytics">
    {# Page Header #}
    <div class="page-header">
        <div>
            <h1>
                <i class="bi bi-server" aria-hidden="true"></i>
                {{ 'analytics.assets.title'|trans({}, 'analytics') }}
            </h1>
            <p class="text-muted">{{ 'analytics.assets.subtitle'|trans({}, 'analytics') }}</p>
        </div>
        <div class="page-header-actions">
            <a href="{{ path('app_analytics_advanced') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left" aria-hidden="true"></i> {{ 'analytics.action.back_to_advanced'|trans({}, 'analytics') }}
            </a>
        </div>
    </div>

    {# Calculate counts by risk level #}
    {% set critical_count = 0 %}
    {% set high_count = 0 %}
    {% set medium_count = 0 %}
    {% set low_count = 0 %}
    {% set with_incidents_count = 0 %}
    {% for asset in incident_probability.profiles %}
        {% if asset.criticality_level == 'critical' %}
            {% set critical_count = critical_count + 1 %}
        {% elseif asset.criticality_level == 'high' %}
            {% set high_count = high_count + 1 %}
        {% elseif asset.criticality_level == 'medium' %}
            {% set medium_count = medium_count + 1 %}
        {% else %}
            {% set low_count = low_count + 1 %}
        {% endif %}
        {% if asset.historical_incidents > 0 %}
            {% set with_incidents_count = with_incidents_count + 1 %}
        {% endif %}
    {% endfor %}

    {# KPI Summary #}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary h-100">
                <div class="card-body text-center">
                    <h2 class="text-primary">{{ incident_probability.summary.total_assets }}</h2>
                    <p class="text-muted mb-0">{{ 'analytics.assets.kpi.total_assets'|trans({}, 'analytics') }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger h-100">
                <div class="card-body text-center">
                    <h2 class="text-danger">{{ incident_probability.summary.high_risk_count }}</h2>
                    <p class="text-muted mb-0">{{ 'analytics.assets.kpi.high_risk'|trans({}, 'analytics') }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning h-100">
                <div class="card-body text-center">
                    <h2 class="text-warning">{{ with_incidents_count }}</h2>
                    <p class="text-muted mb-0">{{ 'analytics.assets.kpi.with_incidents'|trans({}, 'analytics') }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info h-100">
                <div class="card-body text-center">
                    <h2 class="text-info">{{ incident_probability.summary.average_probability }}%</h2>
                    <p class="text-muted mb-0">{{ 'analytics.assets.kpi.avg_probability'|trans({}, 'analytics') }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        {# Criticality Distribution Chart #}
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">{{ 'analytics.assets.chart.criticality_distribution'|trans({}, 'analytics') }}</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px; position: relative;">
                        <canvas id="criticalityDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        {# Incident Probability Distribution #}
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">{{ 'analytics.assets.chart.probability_distribution'|trans({}, 'analytics') }}</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px; position: relative;">
                        <canvas id="probabilityDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# High Risk Assets Table #}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                {{ 'analytics.assets.high_risk.title'|trans({}, 'analytics') }}
            </h5>
            <span class="badge bg-danger">{{ incident_probability.high_risk_assets|length }} {{ 'analytics.assets.high_risk.count'|trans({}, 'analytics') }}</span>
        </div>
        <div class="card-body">
            {% if incident_probability.high_risk_assets|length > 0 %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>{{ 'analytics.assets.table.asset'|trans({}, 'analytics') }}</th>
                            <th>{{ 'analytics.assets.table.type'|trans({}, 'analytics') }}</th>
                            <th class="text-center">{{ 'analytics.assets.table.criticality'|trans({}, 'analytics') }}</th>
                            <th class="text-center">{{ 'analytics.assets.table.incidents'|trans({}, 'analytics') }}</th>
                            <th class="text-center">{{ 'analytics.assets.table.probability'|trans({}, 'analytics') }}</th>
                            <th>{{ 'analytics.assets.table.risk_level'|trans({}, 'analytics') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset in incident_probability.high_risk_assets %}
                        <tr>
                            <td>
                                <strong>{{ asset.asset_name }}</strong>
                            </td>
                            <td><span class="badge bg-secondary">{{ asset.asset_type }}</span></td>
                            <td class="text-center">
                                <span class="badge bg-{% if asset.criticality >= 12 %}danger{% elseif asset.criticality >= 9 %}warning{% elseif asset.criticality >= 6 %}info{% else %}success{% endif %}">
                                    {{ asset.criticality }}
                                </span>
                            </td>
                            <td class="text-center">{{ asset.historical_incidents }}</td>
                            <td class="text-center">
                                <div class="progress" style="height: 20px; min-width: 80px;">
                                    <div class="progress-bar bg-{% if asset.incident_probability >= 70 %}danger{% elseif asset.incident_probability >= 40 %}warning{% else %}info{% endif %}"
                                         style="width: {{ asset.incident_probability }}%">
                                        {{ asset.incident_probability }}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-{% if asset.criticality_level == 'critical' %}danger{% elseif asset.criticality_level == 'high' %}warning{% elseif asset.criticality_level == 'medium' %}info{% else %}success{% endif %}">
                                    {{ asset.criticality_level|title }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-check-circle display-4 text-success"></i>
                <p class="mt-2 text-muted">{{ 'analytics.assets.high_risk.none'|trans({}, 'analytics') }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    {# All Assets by Risk Level #}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">{{ 'analytics.assets.all_assets.title'|trans({}, 'analytics') }}</h5>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-danger bg-opacity-10 border-danger h-100">
                        <div class="card-body text-center">
                            <h3 class="text-danger">{{ critical_count }}</h3>
                            <small>{{ 'analytics.assets.risk_level.critical'|trans({}, 'analytics') }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning bg-opacity-10 border-warning h-100">
                        <div class="card-body text-center">
                            <h3 class="text-warning">{{ high_count }}</h3>
                            <small>{{ 'analytics.assets.risk_level.high'|trans({}, 'analytics') }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info bg-opacity-10 border-info h-100">
                        <div class="card-body text-center">
                            <h3 class="text-info">{{ medium_count }}</h3>
                            <small>{{ 'analytics.assets.risk_level.medium'|trans({}, 'analytics') }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success bg-opacity-10 border-success h-100">
                        <div class="card-body text-center">
                            <h3 class="text-success">{{ low_count }}</h3>
                            <small>{{ 'analytics.assets.risk_level.low'|trans({}, 'analytics') }}</small>
                        </div>
                    </div>
                </div>
            </div>

            {% if incident_probability.profiles|length > 0 %}
            <div class="table-responsive">
                <table class="table table-hover table-sm" id="allAssetsTable">
                    <thead>
                        <tr>
                            <th>{{ 'analytics.assets.table.asset'|trans({}, 'analytics') }}</th>
                            <th>{{ 'analytics.assets.table.type'|trans({}, 'analytics') }}</th>
                            <th class="text-center">{{ 'analytics.assets.table.criticality'|trans({}, 'analytics') }}</th>
                            <th class="text-center">{{ 'analytics.assets.table.incidents'|trans({}, 'analytics') }}</th>
                            <th class="text-center">{{ 'analytics.assets.table.probability'|trans({}, 'analytics') }}</th>
                            <th>{{ 'analytics.assets.table.risk_level'|trans({}, 'analytics') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset in incident_probability.profiles %}
                        <tr>
                            <td>
                                <a href="{{ path('app_asset_show', {id: asset.asset_id}) }}">
                                    <strong>{{ asset.asset_name }}</strong>
                                </a>
                            </td>
                            <td><small>{{ asset.asset_type }}</small></td>
                            <td class="text-center">{{ asset.criticality }}</td>
                            <td class="text-center">{{ asset.historical_incidents }}</td>
                            <td class="text-center">{{ asset.incident_probability }}%</td>
                            <td>
                                <span class="badge bg-{% if asset.criticality_level == 'critical' %}danger{% elseif asset.criticality_level == 'high' %}warning{% elseif asset.criticality_level == 'medium' %}info{% else %}success{% endif %}">
                                    {{ asset.criticality_level|title }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-server display-1 text-muted"></i>
                <h4 class="mt-3">{{ 'analytics.assets.no_assets'|trans({}, 'analytics') }}</h4>
                <p class="text-muted">{{ 'analytics.assets.add_assets_hint'|trans({}, 'analytics') }}</p>
                <a href="{{ path('app_asset_index') }}" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-1"></i> {{ 'analytics.action.add_assets'|trans({}, 'analytics') }}
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener('turbo:load', function() {
            const probabilityData = {{ incident_probability|json_encode|raw }};

            // Criticality Distribution Chart
            const criticalityCtx = document.getElementById('criticalityDistributionChart');
            if (criticalityCtx) {
                const criticalityGroups = {
                    '{{ 'analytics.assets.criticality.very_high'|trans({}, 'analytics') }}': 0,
                    '{{ 'analytics.assets.criticality.high'|trans({}, 'analytics') }}': 0,
                    '{{ 'analytics.assets.criticality.medium'|trans({}, 'analytics') }}': 0,
                    '{{ 'analytics.assets.criticality.low'|trans({}, 'analytics') }}': 0
                };

                (probabilityData.profiles || []).forEach(asset => {
                    if (asset.criticality >= 12) criticalityGroups['{{ 'analytics.assets.criticality.very_high'|trans({}, 'analytics') }}']++;
                    else if (asset.criticality >= 8) criticalityGroups['{{ 'analytics.assets.criticality.high'|trans({}, 'analytics') }}']++;
                    else if (asset.criticality >= 4) criticalityGroups['{{ 'analytics.assets.criticality.medium'|trans({}, 'analytics') }}']++;
                    else criticalityGroups['{{ 'analytics.assets.criticality.low'|trans({}, 'analytics') }}']++;
                });

                new Chart(criticalityCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(criticalityGroups),
                        datasets: [{
                            data: Object.values(criticalityGroups),
                            backgroundColor: ['#dc3545', '#ffc107', '#0dcaf0', '#198754']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // Probability Distribution Chart
            const probabilityCtx = document.getElementById('probabilityDistributionChart');
            if (probabilityCtx) {
                const probabilityGroups = {
                    '0-20%': 0,
                    '21-40%': 0,
                    '41-60%': 0,
                    '61-80%': 0,
                    '81-100%': 0
                };

                (probabilityData.profiles || []).forEach(asset => {
                    const prob = asset.incident_probability;
                    if (prob <= 20) probabilityGroups['0-20%']++;
                    else if (prob <= 40) probabilityGroups['21-40%']++;
                    else if (prob <= 60) probabilityGroups['41-60%']++;
                    else if (prob <= 80) probabilityGroups['61-80%']++;
                    else probabilityGroups['81-100%']++;
                });

                new Chart(probabilityCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(probabilityGroups),
                        datasets: [{
                            label: '{{ 'analytics.assets.chart.asset_count'|trans({}, 'analytics') }}',
                            data: Object.values(probabilityGroups),
                            backgroundColor: ['#198754', '#0dcaf0', '#ffc107', '#fd7e14', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        });
    </script>
{% endblock %}
