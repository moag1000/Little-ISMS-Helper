{% extends 'base.html.twig' %}
{% trans_default_domain 'change_requests' %}

{% block title %}{{ change_request.changeNumber }}{% endblock %}

{% block body %}
<div class="container">
    {% include '_components/_breadcrumb.html.twig' with {
        breadcrumbs: [
            { label: 'nav.change_requests'|trans({}, 'nav'), url: path('app_change_request_index') },
            { label: change_request.changeNumber }
        ]
    } %}

    <div class="page-header">
        <h1>{{ change_request.changeNumber }}: {{ change_request.title }}</h1>
        <div class="actions">
            <a href="{{ path('app_change_request_edit', {id: change_request.id}) }}" class="btn btn-primary">{{ 'common.edit'|trans({}, 'messages') }}</a>
            <a href="{{ path('app_change_request_index') }}" class="btn btn-secondary">{{ 'common.back'|trans({}, 'messages') }}</a>
            {% if is_granted('ROLE_ADMIN') %}
                <form method="post" action="{{ path('app_change_request_delete', {id: change_request.id}) }}" style="display:inline;" onsubmit="return confirm('{{ 'change_request.confirm.delete'|trans({}, 'change_requests') }}');">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ change_request.id) }}">
                    <button type="submit" class="btn btn-danger">{{ 'common.delete'|trans({}, 'messages') }}</button>
                </form>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>{{ 'change_request.details.title'|trans({}, 'change_requests') }}</h2>
            <div>
                <span class="badge badge-{{ change_request.changeType }}">{{ change_request.changeType }}</span>
                <span class="badge badge-{{ change_request.priority }}">{{ change_request.priority }}</span>
                <span class="badge badge-{{ change_request.status }}">{{ change_request.status }}</span>
            </div>
        </div>
        <div class="card-content">
            <div class="alert alert-info">
                <strong>{{ 'change_request.field.complexity_score'|trans({}, 'change_requests') }} {{ change_request.getComplexityScore() }}</strong>
            </div>

            <div class="detail-grid">
                <div class="detail-item">
                    <span class="label">{{ 'change_request.field.requested_by'|trans({}, 'change_requests') }}</span>
                    <span class="value">{{ change_request.requestedBy }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">{{ 'change_request.field.requested_date'|trans({}, 'change_requests') }}</span>
                    <span class="value">{{ change_request.requestedDate|date('Y-m-d') }}</span>
                </div>
                <div class="detail-item">
                    <span class="label">{{ 'change_request.field.planned_implementation'|trans({}, 'change_requests') }}</span>
                    <span class="value">{{ change_request.plannedImplementationDate ? change_request.plannedImplementationDate|date('Y-m-d') : ('change_request.status.not_scheduled'|trans({}, 'change_requests')) }}</span>
                </div>
            </div>

            <div class="detail-section">
                <h2>{{ 'change_request.section.description'|trans({}, 'change_requests') }}</h2>
                <p>{{ change_request.description|nl2br }}</p>
            </div>

            <div class="detail-section">
                <h2>{{ 'change_request.section.justification'|trans({}, 'change_requests') }}</h2>
                <p>{{ change_request.justification|nl2br }}</p>
            </div>

            {% if change_request.ismsImpact %}
            <div class="detail-section alert-info">
                <h3>{{ 'change_request.section.impact'|trans({}, 'change_requests') }}</h3>
                <p>{{ change_request.ismsImpact|nl2br }}</p>
            </div>
            {% endif %}

            {% if change_request.riskAssessment %}
            <div class="detail-section">
                <h3>{{ 'change_request.section.risk_assessment'|trans({}, 'change_requests') }}</h3>
                <p>{{ change_request.riskAssessment|nl2br }}</p>
            </div>
            {% endif %}

            {% if change_request.implementationPlan %}
            <div class="detail-section">
                <h3>{{ 'change_request.section.plan'|trans({}, 'change_requests') }}</h3>
                <p>{{ change_request.implementationPlan|nl2br }}</p>
            </div>
            {% endif %}

            {% if change_request.rollbackPlan %}
            <div class="detail-section">
                <h3>{{ 'change_request.section.rollback_plan'|trans({}, 'change_requests') }}</h3>
                <p>{{ change_request.rollbackPlan|nl2br }}</p>
            </div>
            {% endif %}

            {% if change_request.testingRequirements %}
            <div class="detail-section">
                <h3>{{ 'change_request.section.testing_requirements'|trans({}, 'change_requests') }}</h3>
                <p>{{ change_request.testingRequirements|nl2br }}</p>
            </div>
            {% endif %}

            {% if change_request.approvedBy %}
            <div class="detail-section alert-success">
                <h3>{{ 'change_request.section.approval_info'|trans({}, 'change_requests') }}</h3>
                <p><strong>{{ 'change_request.field.approved_by'|trans({}, 'change_requests') }}</strong> {{ change_request.approvedBy }}</p>
                <p><strong>{{ 'change_request.field.approval_date'|trans({}, 'change_requests') }}</strong> {{ change_request.approvedDate|date('Y-m-d H:i') }}</p>
                {% if change_request.approvalComments %}
                <p><strong>{{ 'change_request.field.comments'|trans({}, 'change_requests') }}</strong> {{ change_request.approvalComments }}</p>
                {% endif %}
            </div>
            {% endif %}

            {% if change_request.implementedBy %}
            <div class="detail-section">
                <h3>{{ 'change_request.section.implementation'|trans({}, 'change_requests') }}</h3>
                <p><strong>{{ 'change_request.field.implemented_by'|trans({}, 'change_requests') }}</strong> {{ change_request.implementedBy }}</p>
                <p><strong>{{ 'change_request.field.implementation_date'|trans({}, 'change_requests') }}</strong> {{ change_request.actualImplementationDate|date('Y-m-d') }}</p>
                {% if change_request.implementationNotes %}
                <p><strong>{{ 'change_request.field.notes'|trans({}, 'change_requests') }}</strong> {{ change_request.implementationNotes|nl2br }}</p>
                {% endif %}
            </div>
            {% endif %}

            {% if change_request.verifiedBy %}
            <div class="detail-section alert-success">
                <h3>{{ 'change_request.section.verification'|trans({}, 'change_requests') }}</h3>
                <p><strong>{{ 'change_request.field.verified_by'|trans({}, 'change_requests') }}</strong> {{ change_request.verifiedBy }}</p>
                <p><strong>{{ 'change_request.field.verification_date'|trans({}, 'change_requests') }}</strong> {{ change_request.verifiedDate|date('Y-m-d') }}</p>
                {% if change_request.verificationResults %}
                <p><strong>{{ 'change_request.field.results'|trans({}, 'change_requests') }}</strong> {{ change_request.verificationResults|nl2br }}</p>
                {% endif %}
            </div>
            {% endif %}

            {% if change_request.status == 'closed' %}
            <div class="detail-section">
                <h3>{{ 'change_request.section.closure'|trans({}, 'change_requests') }}</h3>
                <p><strong>{{ 'change_request.field.closed_date'|trans({}, 'change_requests') }}</strong> {{ change_request.closedDate|date('Y-m-d') }}</p>
                {% if change_request.closureNotes %}
                <p><strong>{{ 'change_request.field.notes'|trans({}, 'change_requests') }}</strong> {{ change_request.closureNotes }}</p>
                {% endif %}
            </div>
            {% endif %}

            {% if change_request.affectedAssets|length > 0 %}
            <div class="detail-section">
                <h3>{{ 'change_request.section.affected_assets'|trans({'%count%': change_request.affectedAssets|length}, 'change_requests') }}</h3>
                <ul>
                    {% for asset in change_request.affectedAssets %}
                    <li><a href="{{ path('app_asset_show', {id: asset.id}) }}">{{ asset.name }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if change_request.affectedControls|length > 0 %}
            <div class="detail-section">
                <h3>{{ 'change_request.section.affected_controls'|trans({'%count%': change_request.affectedControls|length}, 'change_requests') }}</h3>
                <ul>
                    {% for control in change_request.affectedControls %}
                    <li><a href="{{ path('app_control_show', {id: control.id}) }}">{{ control.controlId }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if change_request.affectedRisks|length > 0 %}
            <div class="detail-section">
                <h3>{{ 'change_request.section.affected_risks'|trans({'%count%': change_request.affectedRisks|length}, 'change_requests') }}</h3>
                <ul>
                    {% for risk in change_request.affectedRisks %}
                    <li><a href="{{ path('app_risk_show', {id: risk.id}) }}">{{ risk.title }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
