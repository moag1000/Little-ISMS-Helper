<?php

namespace App\Entity;

use App\Entity\Tenant;
use App\Repository\VulnerabilityRepository;
use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\Common\Collections\Collection;
use Doctrine\DBAL\Types\Types;
use Doctrine\ORM\Mapping as ORM;

/**
 * Vulnerability Entity for NIS2 Compliance (Art. 21.2.d)
 * CVE Tracking, CVSS Scoring, and Vulnerability Management
 */
#[ORM\Entity(repositoryClass: VulnerabilityRepository::class)]
#[ORM\Table(name: 'vulnerabilities')]
#[ORM\Index(columns: ['cve_id'], name: 'idx_vuln_cve')]
#[ORM\Index(columns: ['severity'], name: 'idx_vuln_severity')]
#[ORM\Index(columns: ['status'], name: 'idx_vuln_status')]
#[ORM\Index(columns: ['discovered_date'], name: 'idx_vuln_discovered')]
#[ORM\Index(columns: ['remediation_deadline'], name: 'idx_vuln_deadline')]
class Vulnerability
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column]
    private ?int $id = null;

    /**
     * CVE Identifier (e.g., CVE-2024-1234)
     */
    #[ORM\Column(length: 50, unique: true)]
    private ?string $cveId = null;

    /**
     * Vulnerability title/name
     */
    #[ORM\Column(length: 255)]
    private ?string $title = null;

    /**
     * Detailed description
     */
    #[ORM\Column(type: Types::TEXT)]
    private ?string $description = null;

    /**
     * Severity level based on CVSS score
     * - critical: CVSS 9.0-10.0
     * - high: CVSS 7.0-8.9
     * - medium: CVSS 4.0-6.9
     * - low: CVSS 0.1-3.9
     * - none: CVSS 0.0
     */
    #[ORM\Column(length: 20)]
    private ?string $severity = null;

    /**
     * CVSS Base Score (0.0 - 10.0)
     */
    #[ORM\Column(type: Types::DECIMAL, precision: 3, scale: 1)]
    private ?string $cvssScore = null;

    /**
     * CVSS Vector String (e.g., CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)
     */
    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $cvssVector = null;

    /**
     * Vulnerability source
     * - nist: NIST NVD
     * - mitre: MITRE CVE
     * - vendor: Vendor advisory
     * - internal: Internal discovery
     * - pentest: Penetration testing
     * - bugbounty: Bug bounty program
     */
    #[ORM\Column(length: 50)]
    private ?string $source = 'nist';

    /**
     * Affected assets
     *
     * @var Collection<int, Asset>
     */
    #[ORM\ManyToMany(targetEntity: Asset::class)]
    #[ORM\JoinTable(name: 'vulnerability_asset')]
    private Collection $affectedAssets;

    /**
     * Vulnerability status
     * - open: Newly discovered, not addressed
     * - patched: Fixed via patch
     * - mitigated: Mitigated via compensating controls
     * - accepted: Risk accepted
     * - false_positive: Not actually a vulnerability
     * - closed: Resolved and verified
     */
    #[ORM\Column(length: 30)]
    private string $status = 'open';

    /**
     * Date vulnerability was discovered
     */
    #[ORM\Column(type: Types::DATE_IMMUTABLE)]
    private ?\DateTimeImmutable $discoveredDate = null;

    /**
     * Date vulnerability was published (CVE publication date)
     */
    #[ORM\Column(type: Types::DATE_IMMUTABLE, nullable: true)]
    private ?\DateTimeImmutable $publishedDate = null;

    /**
     * Remediation deadline (NIS2 compliance)
     * Critical: 24-72 hours
     * High: 7 days
     * Medium: 30 days
     * Low: 90 days
     */
    #[ORM\Column(type: Types::DATE_IMMUTABLE, nullable: true)]
    private ?\DateTimeImmutable $remediationDeadline = null;

    /**
     * Date vulnerability was remediated
     */
    #[ORM\Column(type: Types::DATE_IMMUTABLE, nullable: true)]
    private ?\DateTimeImmutable $remediatedDate = null;

    /**
     * Responsible person for remediation
     */
    #[ORM\Column(length: 100, nullable: true)]
    private ?string $responsiblePerson = null;

    /**
     * Remediation notes
     */
    #[ORM\Column(type: Types::TEXT, nullable: true)]
    private ?string $remediationNotes = null;

    /**
     * Exploit availability
     * - none: No known exploit
     * - poc: Proof of concept exists
     * - public: Public exploit available
     * - weaponized: Weaponized exploit in use
     */
    #[ORM\Column(length: 20, nullable: true)]
    private ?string $exploitAvailability = 'none';

    /**
     * Is this vulnerability being actively exploited?
     */
    #[ORM\Column(type: Types::BOOLEAN)]
    private bool $activelyExploited = false;

    /**
     * References (URLs to advisories, patches, etc.)
     */
    #[ORM\Column(type: Types::JSON, nullable: true)]
    private ?array $references = [];

    /**
     * Related patches
     *
     * @var Collection<int, Patch>
     */
    #[ORM\OneToMany(targetEntity: Patch::class, mappedBy: 'vulnerability', cascade: ['persist'])]
    private Collection $patches;

    /**
     * CWE (Common Weakness Enumeration) IDs
     */
    #[ORM\Column(type: Types::JSON, nullable: true)]
    private ?array $cweIds = [];

    /**
     * Affected products/versions
     */
    #[ORM\Column(type: Types::JSON, nullable: true)]
    private ?array $affectedProducts = [];

    #[ORM\Column(type: Types::DATETIME_IMMUTABLE)]
    private ?\DateTimeImmutable $createdAt = null;

    #[ORM\Column(type: Types::DATETIME_IMMUTABLE, nullable: true)]
    private ?\DateTimeImmutable $updatedAt = null;

    
    #[ORM\ManyToOne(targetEntity: Tenant::class)]
    #[ORM\JoinColumn(nullable: true)]
    private ?Tenant $tenant = null;

public function __construct()
    {
        $this->affectedAssets = new ArrayCollection();
        $this->patches = new ArrayCollection();
        $this->createdAt = new \DateTimeImmutable();
        $this->discoveredDate = new \DateTimeImmutable();
        $this->references = [];
        $this->cweIds = [];
        $this->affectedProducts = [];
    }

    public function getId(): ?int
    {
        return $this->id;
    }

    public function getCveId(): ?string
    {
        return $this->cveId;
    }

    public function setCveId(string $cveId): static
    {
        $this->cveId = $cveId;
        return $this;
    }

    public function getTitle(): ?string
    {
        return $this->title;
    }

    public function setTitle(string $title): static
    {
        $this->title = $title;
        return $this;
    }

    public function getDescription(): ?string
    {
        return $this->description;
    }

    public function setDescription(string $description): static
    {
        $this->description = $description;
        return $this;
    }

    public function getSeverity(): ?string
    {
        return $this->severity;
    }

    public function setSeverity(string $severity): static
    {
        $this->severity = $severity;
        return $this;
    }

    public function getCvssScore(): ?string
    {
        return $this->cvssScore;
    }

    public function setCvssScore(string $cvssScore): static
    {
        $this->cvssScore = $cvssScore;

        // Auto-calculate severity based on CVSS score
        $score = (float) $cvssScore;
        if ($score >= 9.0) {
            $this->severity = 'critical';
        } elseif ($score >= 7.0) {
            $this->severity = 'high';
        } elseif ($score >= 4.0) {
            $this->severity = 'medium';
        } elseif ($score > 0.0) {
            $this->severity = 'low';
        } else {
            $this->severity = 'none';
        }

        return $this;
    }

    public function getCvssVector(): ?string
    {
        return $this->cvssVector;
    }

    public function setCvssVector(?string $cvssVector): static
    {
        $this->cvssVector = $cvssVector;
        return $this;
    }

    public function getSource(): ?string
    {
        return $this->source;
    }

    public function setSource(string $source): static
    {
        $this->source = $source;
        return $this;
    }

    /**
     * @return Collection<int, Asset>
     */
    public function getAffectedAssets(): Collection
    {
        return $this->affectedAssets;
    }

    public function addAffectedAsset(Asset $asset): static
    {
        if (!$this->affectedAssets->contains($asset)) {
            $this->affectedAssets->add($asset);
        }

        return $this;
    }

    public function removeAffectedAsset(Asset $asset): static
    {
        $this->affectedAssets->removeElement($asset);
        return $this;
    }

    public function getStatus(): string
    {
        return $this->status;
    }

    public function setStatus(string $status): static
    {
        $this->status = $status;
        return $this;
    }

    public function getDiscoveredDate(): ?\DateTimeImmutable
    {
        return $this->discoveredDate;
    }

    public function setDiscoveredDate(\DateTimeImmutable $discoveredDate): static
    {
        $this->discoveredDate = $discoveredDate;
        return $this;
    }

    public function getPublishedDate(): ?\DateTimeImmutable
    {
        return $this->publishedDate;
    }

    public function setPublishedDate(?\DateTimeImmutable $publishedDate): static
    {
        $this->publishedDate = $publishedDate;
        return $this;
    }

    public function getRemediationDeadline(): ?\DateTimeImmutable
    {
        return $this->remediationDeadline;
    }

    public function setRemediationDeadline(?\DateTimeImmutable $remediationDeadline): static
    {
        $this->remediationDeadline = $remediationDeadline;
        return $this;
    }

    public function getRemediatedDate(): ?\DateTimeImmutable
    {
        return $this->remediatedDate;
    }

    public function setRemediatedDate(?\DateTimeImmutable $remediatedDate): static
    {
        $this->remediatedDate = $remediatedDate;
        return $this;
    }

    public function getResponsiblePerson(): ?string
    {
        return $this->responsiblePerson;
    }

    public function setResponsiblePerson(?string $responsiblePerson): static
    {
        $this->responsiblePerson = $responsiblePerson;
        return $this;
    }

    public function getRemediationNotes(): ?string
    {
        return $this->remediationNotes;
    }

    public function setRemediationNotes(?string $remediationNotes): static
    {
        $this->remediationNotes = $remediationNotes;
        return $this;
    }

    public function getExploitAvailability(): ?string
    {
        return $this->exploitAvailability;
    }

    public function setExploitAvailability(?string $exploitAvailability): static
    {
        $this->exploitAvailability = $exploitAvailability;
        return $this;
    }

    public function isActivelyExploited(): bool
    {
        return $this->activelyExploited;
    }

    public function setActivelyExploited(bool $activelyExploited): static
    {
        $this->activelyExploited = $activelyExploited;
        return $this;
    }

    public function getReferences(): ?array
    {
        return $this->references;
    }

    public function setReferences(?array $references): static
    {
        $this->references = $references;
        return $this;
    }

    public function addReference(string $reference): static
    {
        if (!in_array($reference, $this->references)) {
            $this->references[] = $reference;
        }
        return $this;
    }

    /**
     * @return Collection<int, Patch>
     */
    public function getPatches(): Collection
    {
        return $this->patches;
    }

    public function addPatch(Patch $patch): static
    {
        if (!$this->patches->contains($patch)) {
            $this->patches->add($patch);
            $patch->setVulnerability($this);
        }

        return $this;
    }

    public function removePatch(Patch $patch): static
    {
        if ($this->patches->removeElement($patch)) {
            if ($patch->getVulnerability() === $this) {
                $patch->setVulnerability(null);
            }
        }

        return $this;
    }

    public function getCweIds(): ?array
    {
        return $this->cweIds;
    }

    public function setCweIds(?array $cweIds): static
    {
        $this->cweIds = $cweIds;
        return $this;
    }

    public function getAffectedProducts(): ?array
    {
        return $this->affectedProducts;
    }

    public function setAffectedProducts(?array $affectedProducts): static
    {
        $this->affectedProducts = $affectedProducts;
        return $this;
    }

    public function getCreatedAt(): ?\DateTimeImmutable
    {
        return $this->createdAt;
    }

    public function setCreatedAt(\DateTimeImmutable $createdAt): static
    {
        $this->createdAt = $createdAt;
        return $this;
    }

    public function getUpdatedAt(): ?\DateTimeImmutable
    {
        return $this->updatedAt;
    }

    public function setUpdatedAt(?\DateTimeImmutable $updatedAt): static
    {
        $this->updatedAt = $updatedAt;
        return $this;
    }

    /**
     * Check if vulnerability is overdue
     */
    public function isOverdue(): bool
    {
        if ($this->remediationDeadline === null || $this->status === 'closed') {
            return false;
        }

        return $this->remediationDeadline < new \DateTimeImmutable();
    }

    /**
     * Get severity badge class
     */
    public function getSeverityBadgeClass(): string
    {
        return match($this->severity) {
            'critical' => 'danger',
            'high' => 'warning',
            'medium' => 'info',
            'low' => 'secondary',
            default => 'light',
        };
    }

    /**
     * Calculate recommended remediation deadline based on severity
     * NIS2 Art. 21.2.d compliance
     */
    public function calculateRemediationDeadline(): \DateTimeImmutable
    {
        $days = match($this->severity) {
            'critical' => 3, // 72 hours
            'high' => 7,
            'medium' => 30,
            'low' => 90,
            default => 90,
        };

        return $this->discoveredDate->modify("+{$days} days");
    }

    /**
     * Get days until deadline
     */
    public function getDaysUntilDeadline(): ?int
    {
        if ($this->remediationDeadline === null) {
            return null;
        }

        $now = new \DateTimeImmutable();
        $diff = $now->diff($this->remediationDeadline);

        return $diff->invert ? -$diff->days : $diff->days;
    }

    public function getTenant(): ?Tenant
    {
        return $this->tenant;
    }

    public function setTenant(?Tenant $tenant): static
    {
        $this->tenant = $tenant;
        return $this;
    }
}
