<VirtualHost *:80>
    ServerName localhost

    # Document root should point to the public directory
    DocumentRoot /var/www/html/public

    # Directory configuration
    <Directory /var/www/html/public>
        AllowOverride None
        Require all granted

        # Symfony front controller pattern
        FallbackResource /index.php
    </Directory>

    # Increase timeout for long-running requests
    Timeout 300
    ProxyTimeout 300

    # Set the maximum size for file uploads
    LimitRequestBody 104857600

    # Proxy PHP requests to PHP-FPM
    # Use Unix socket if PHP-FPM is configured with socket
    # <FilesMatch \.php$>
    #     SetHandler "proxy:unix:/run/php/php-fpm.sock|fcgi://localhost"
    # </FilesMatch>

    # Use TCP socket if PHP-FPM listens on 127.0.0.1:9000
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://127.0.0.1:9000"
    </FilesMatch>

    # For Apache 2.4.10+, use ProxyPassMatch for better performance
    # This passes PHP requests to PHP-FPM with the correct SCRIPT_FILENAME
    <IfModule mod_proxy_fcgi.c>
        # Pass PHP files to PHP-FPM
        ProxyPassMatch ^/(.*\.php(/.*)?)$ fcgi://127.0.0.1:9000/var/www/html/public/$1
    </IfModule>

    # Security: Deny access to hidden files except .well-known
    <DirectoryMatch "^/\.(?!well-known)">
        Require all denied
    </DirectoryMatch>

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/little-isms-error.log
    CustomLog ${APACHE_LOG_DIR}/little-isms-access.log combined

    # Optional: Enable detailed error logging for debugging
    LogLevel warn
    # For debugging, change to: LogLevel proxy:trace5 proxy_fcgi:trace5
</VirtualHost>
